import{r as C,a as Yr,c as wt,g as Jr,R as Xr}from"./react-vendor-8a332d8f.js";import{s as Kn,G as we,O as ot,P as Qr,N as Pt,F as Lt,g as es,a as gn,b as ts}from"./audio-libs-2901efa1.js";import{S as qn,A as nt,D as ns,R as bn,a as rs,B as ss,V as vn,F as os,b as yn,c as xn}from"./graphics-libs-bbd9a815.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))c(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&c(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function c(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();var Yn={exports:{}},Mt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var as=C,is=Symbol.for("react.element"),cs=Symbol.for("react.fragment"),ls=Object.prototype.hasOwnProperty,us=as.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ds={key:!0,ref:!0,__self:!0,__source:!0};function Jn(t,n,e){var c,r={},s=null,a=null;e!==void 0&&(s=""+e),n.key!==void 0&&(s=""+n.key),n.ref!==void 0&&(a=n.ref);for(c in n)ls.call(n,c)&&!ds.hasOwnProperty(c)&&(r[c]=n[c]);if(t&&t.defaultProps)for(c in n=t.defaultProps,n)r[c]===void 0&&(r[c]=n[c]);return{$$typeof:is,type:t,key:s,ref:a,props:r,_owner:us.current}}Mt.Fragment=cs;Mt.jsx=Jn;Mt.jsxs=Jn;Yn.exports=Mt;var o=Yn.exports,qt={},wn=Yr;qt.createRoot=wn.createRoot,qt.hydrateRoot=wn.hydrateRoot;const kn={"Crash 1":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Crash 2":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Hi-Hat Open":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Hi-Hat Closed":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Ride:{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Tom 1":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Tom 2":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Snare:{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Tom 3":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Kick:{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0}},Ce=0,Re=1,Pe=2,He=3,Me=4,Fe=5,Ue=6,_n=["Crash 1","Crash 2","Hi-Hat Open","Hi-Hat Closed","Ride","Tom 1","Tom 2","Snare","Tom 3","Kick"],ft=120,Yt=[4,4],Rt=1,me=4,Xn=700,fs={"Crash 1":{position:"above",symbol:"x",line:-2.5},"Crash 2":{position:"above",symbol:"o",line:-2},"Hi-Hat Open":{position:"above",symbol:"o",line:-1.5},"Hi-Hat Closed":{position:"above",symbol:"x",line:-1.5},Ride:{position:"above",symbol:"x",line:-1},"Tom 1":{position:"center",symbol:"●",line:-.5},"Tom 2":{position:"center",symbol:"●",line:0},Snare:{position:"center",symbol:"●",line:.5},"Tom 3":{position:"below",symbol:"●",line:1.5},Kick:{position:"below",symbol:"●",line:2.5}},Qn=[9/10,8/9,7/8,6/7,5/6,2],hs=["","x0.9","x0.8","x0.7","x0.6","x0.5"];function it(t,n=Qn){let e=1;for(let c=0;c<t;c++)e*=n[c%n.length];return e}const er="drummer-app-data",tr="drummer-metronome-bpm",Jt="drummer-cross-pattern-loop",ms="vexflow",nr=new Set([Ce,Re,Pe,He,Me,Fe,Ue]);function ps(t){return t.map(n=>n.map(e=>typeof e=="boolean"?e?Re:Ce:typeof e=="number"&&nr.has(e)?e:Ce))}function gs(t){return t.grid.length>0&&t.grid[0].length>0&&typeof t.grid[0][0]=="boolean"?{...t,grid:ps(t.grid)}:t}function bt(){try{const t=localStorage.getItem(er);if(t){const n=JSON.parse(t);return n.patterns=n.patterns.map(gs),n}}catch(t){console.error("Failed to load storage data:",t)}return{patterns:[]}}function on(t){try{localStorage.setItem(er,JSON.stringify(t))}catch(n){console.error("Failed to save storage data:",n)}}function kt(t){const n=bt(),e=n.patterns.findIndex(c=>c.id===t.id);e>=0?n.patterns[e]=t:n.patterns.push(t),on(n)}function Qe(){return bt().patterns}function bs(t){const n=bt();n.patterns=n.patterns.filter(e=>e.id!==t),n.currentPatternId===t&&(n.currentPatternId=void 0),on(n)}function vs(){return bt().currentPatternId}function Oe(t){const n=bt();n.currentPatternId=t,on(n)}function jt(){return`pattern-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ze(t){try{localStorage.setItem(tr,String(t))}catch(n){console.error("Failed to save metronome BPM:",n)}}function Sn(){try{localStorage.removeItem("metronome_bpm");const t=localStorage.getItem(tr);if(t){const n=parseInt(t,10);if(!isNaN(n)&&n>=20&&n<=300)return n}}catch(t){console.error("Failed to load metronome BPM:",t)}return null}function ys(t){try{t===void 0?localStorage.removeItem(Jt):localStorage.setItem(Jt,JSON.stringify(t))}catch(n){console.error("Failed to save cross pattern loop:",n)}}function xs(){try{const t=localStorage.getItem(Jt);if(t){const n=JSON.parse(t);if(typeof n=="object"&&typeof n.startPatternName=="string"&&typeof n.startBar=="number"&&typeof n.endPatternName=="string"&&typeof n.endBar=="number"&&n.startBar>=0&&n.endBar>=0)return n}}catch(t){console.error("Failed to load cross pattern loop:",t)}}function ws(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.id!="string"||n.id.length===0||typeof n.name!="string"||n.name.length===0||typeof n.bpm!="number"||n.bpm<20||n.bpm>300||!Array.isArray(n.timeSignature)||n.timeSignature.length!==2||typeof n.timeSignature[0]!="number"||typeof n.timeSignature[1]!="number"||typeof n.bars!="number"||n.bars<1||n.bars>100||!Array.isArray(n.grid))return!1;for(const e of n.grid){if(!Array.isArray(e))return!1;for(const c of e)if(typeof c!="number"||!nr.has(c))return!1}if(!Array.isArray(n.drums))return!1;for(const e of n.drums)if(typeof e!="string")return!1;if(typeof n.createdAt!="number"||typeof n.updatedAt!="number"||n.loopRange!==void 0&&(!Array.isArray(n.loopRange)||n.loopRange.length!==2||typeof n.loopRange[0]!="number"||typeof n.loopRange[1]!="number"))return!1;if(n.barBpmOverrides!==void 0){if(typeof n.barBpmOverrides!="object"||n.barBpmOverrides===null)return!1;for(const[e,c]of Object.entries(n.barBpmOverrides)){const r=parseInt(e,10);if(isNaN(r)||r<0||typeof c!="number"||c<20||c>300)return!1}}return!0}function Bn(t){try{const n=JSON.parse(t);if(ws(n))return n}catch{}return null}function ks(t){return JSON.stringify(t)}function Ut(t){const n=t.map(c=>c.name).filter(c=>/^[A-Z]$/.test(c));let e="A";if(n.length>0){const c=n.map(s=>s.charCodeAt(0)),r=Math.max(...c);if(r<90)e=String.fromCharCode(r+1);else for(let s=65;s<=90;s++)if(!c.includes(s)){e=String.fromCharCode(s);break}}return e}function Cn(){return ms}function rr(t="New Pattern"){const n=Yt[0],e=Rt*n*me;return{id:jt(),name:t,bpm:ft,timeSignature:Yt,bars:Rt,grid:Array(_n.length).fill(null).map(()=>Array(e).fill(Ce)),drums:_n,createdAt:Date.now(),updatedAt:Date.now()}}const _s=t=>t===Me||t===Fe||t===Ue;function Wt(t,n,e,c){if(!t)return;const r={};for(const[s,a]of Object.entries(t)){const i=parseInt(s,10);i!==c&&(i>=n?r[i+e]=a:r[i]=a)}return Object.keys(r).length>0?r:void 0}function Ss(t){const[n,e]=C.useState(t),c=C.useCallback(u=>{e(m=>({...m,bpm:u,updatedAt:Date.now()}))},[]),r=C.useCallback((u,m)=>{e(p=>{const v={...p.barBpmOverrides};m===null?delete v[u]:v[u]=m;const S=Object.keys(v).length>0;return{...p,barBpmOverrides:S?v:void 0,updatedAt:Date.now()}})},[]),s=C.useCallback((u,m)=>{e(p=>{const v=p.grid.map((S,w)=>{if(w===u){const E=[...S];return E[m]=E[m]===Ce?Re:Ce,E}return S});return{...p,grid:v,updatedAt:Date.now()}})},[]),a=C.useCallback((u,m)=>{e(p=>{var I;const v=(I=p.grid[u])==null?void 0:I[m];if(v===Ce||_s(v))return p;const S=p.drums[u],w=kn[S],E=p.grid.map((R,A)=>{if(A===u){const T=[...R];let z;return v===Re?z=w.allowGhost?Pe:Re:v===Pe?z=w.allowGrace?He:Re:z=Re,T[m]=z,T}return R});return{...p,grid:E,updatedAt:Date.now()}})},[]),i=C.useCallback((u,m)=>{e(p=>{var R;const v=(R=p.grid[u])==null?void 0:R[m],S=p.drums[u];if(!kn[S].allowThirtySecond){if(v===Ce){const A=p.grid.map((T,z)=>{if(z===u){const D=[...T];return D[m]=Re,D}return T});return{...p,grid:A,updatedAt:Date.now()}}return p}let E;v===Re||v===Pe||v===He?E=Me:v===Me?E=Fe:v===Fe?E=Ue:E=Re;const I=p.grid.map((A,T)=>{if(T===u){const z=[...A];return z[m]=E,z}return A});return{...p,grid:I,updatedAt:Date.now()}})},[]),f=C.useCallback(u=>{e(m=>{var z;const[p]=m.timeSignature,v=p*me;let S,w;if(u!==void 0){const D=Math.floor(u/v),_=u%v,L=v/2;_<L?(S=D,w=D):(S=D+1,w=D)}else S=m.bars,w=m.bars-1;const E=w*v,I=E+v,R=m.grid.map(D=>{const _=D.slice(E,I),L=[...D];return L.splice(S*v,0,..._),L});let A=Wt(m.barBpmOverrides,S,1);const T=(z=m.barBpmOverrides)==null?void 0:z[w];return T!==void 0&&(A=A??{},A[S]=T),{...m,bars:m.bars+1,grid:R,barBpmOverrides:A,updatedAt:Date.now()}})},[]),k=C.useCallback(u=>{e(m=>{if(m.bars<=1)return m;const[p]=m.timeSignature,v=p*me;let S;if(u!==void 0){const R=Math.floor(u/v),A=u%v,T=v/2;A<T,S=R}else S=m.bars-1;const w=S*v,E=m.grid.map(R=>{const A=[...R];return A.splice(w,v),A}),I=Wt(m.barBpmOverrides,S+1,-1,S);return{...m,bars:m.bars-1,grid:E,barBpmOverrides:I,loopRange:m.loopRange&&m.loopRange[1]>=m.bars-1?[m.loopRange[0],m.bars-2]:m.loopRange,updatedAt:Date.now()}})},[]),x=C.useCallback(()=>{e(u=>{const m=u.grid.map(p=>p.map(()=>Ce));return{...u,grid:m,updatedAt:Date.now()}})},[]),g=C.useCallback(u=>{e(m=>{const[p]=m.timeSignature,v=p*me,w=Math.floor(u/v)*v,E=w+v,I=m.grid.map(R=>{const A=[...R];for(let T=w;T<E;T++)A[T]=Ce;return A});return{...m,grid:I,updatedAt:Date.now()}})},[]),y=C.useCallback((u,m)=>{e(p=>{var z;if(m.bars<=0||m.grid.length!==p.drums.length||m.timeSignature[0]!==p.timeSignature[0]||m.timeSignature[1]!==p.timeSignature[1])return p;const[v]=p.timeSignature,S=v*me,w=Math.max(0,Math.min(p.bars,u)),E=w*S,I=m.bars*S;if(m.grid.some(D=>D.length!==I))return p;const R=p.grid.map((D,_)=>{const L=m.grid[_],d=[...D];return d.splice(E,0,...L),d}),A=m.bpm!==p.bpm;let T=Wt(p.barBpmOverrides,w,m.bars);for(let D=0;D<m.bars;D++){const _=(z=m.barBpmOverrides)==null?void 0:z[D];_!==void 0?(T=T??{},T[w+D]=_):A&&(T=T??{},T[w+D]=m.bpm)}return{...p,bars:p.bars+m.bars,grid:R,barBpmOverrides:T,updatedAt:Date.now()}})},[]),h=C.useCallback(u=>{e(u)},[]),b=C.useCallback(()=>{e(rr())},[]);return{pattern:n,updateBPM:c,updateBarBpm:r,toggleCell:s,toggleGhost:a,cycleThirtySecond:i,addBar:f,removeBar:k,clearGrid:x,clearBar:g,insertPatternGrid:y,loadPattern:h,resetPattern:b}}function Bs(t,n){const e=C.useRef(t),c=C.useRef(n);C.useEffect(()=>{e.current=t},[t]),C.useEffect(()=>{c.current=n},[n]),C.useEffect(()=>{const r=s=>{if(e.current||c.current)return s.preventDefault(),s.returnValue="",""};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[])}const Cs="drummer-audio-cache",js=1,Ae="audio-buffers",sr="cache-version",Ht="1.0.0";async function vt(){return new Promise((t,n)=>{const e=indexedDB.open(Cs,js);e.onerror=()=>n(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=c=>{const r=c.target.result;r.objectStoreNames.contains(Ae)||r.createObjectStore(Ae,{keyPath:"name"})}})}function Es(t){const n=[];for(let e=0;e<t.numberOfChannels;e++)n.push(t.getChannelData(e));return{numberOfChannels:t.numberOfChannels,length:t.length,sampleRate:t.sampleRate,channelData:n}}function Ts(t,n){const e=t.createBuffer(n.numberOfChannels,n.length,n.sampleRate);for(let c=0;c<n.numberOfChannels;c++)e.getChannelData(c).set(n.channelData[c]);return e}async function Rs(t,n){try{const e=await vt(),r=e.transaction(Ae,"readwrite").objectStore(Ae),s=Es(n);await new Promise((a,i)=>{const f=r.put({name:t,data:s});f.onsuccess=()=>a(),f.onerror=()=>i(f.error)}),e.close()}catch(e){console.warn(`Failed to cache audio buffer "${t}":`,e)}}async function Is(t,n){try{const e=await vt(),r=e.transaction(Ae,"readonly").objectStore(Ae),s=await new Promise((a,i)=>{const f=r.get(n);f.onsuccess=()=>a(f.result),f.onerror=()=>i(f.error)});return e.close(),s?Ts(t,s.data):null}catch(e){return console.warn(`Failed to get cached audio buffer "${n}":`,e),null}}async function As(){try{const t=await vt(),e=t.transaction(Ae,"readwrite").objectStore(Ae);await new Promise((c,r)=>{const s=e.clear();s.onsuccess=()=>c(),s.onerror=()=>r(s.error)}),t.close()}catch(t){console.warn("Failed to clear audio cache:",t)}}async function Ns(){try{const t=await vt(),e=t.transaction(Ae,"readonly").objectStore(Ae),c=await new Promise((r,s)=>{const a=e.get(sr);a.onsuccess=()=>r(a.result),a.onerror=()=>s(a.error)});return t.close(),c?c.version:null}catch(t){return console.warn("Failed to get cache version:",t),null}}async function Ps(t){try{const n=await vt(),c=n.transaction(Ae,"readwrite").objectStore(Ae);await new Promise((r,s)=>{const a=c.put({name:sr,version:t});a.onsuccess=()=>r(),a.onerror=()=>s(a.error)}),n.close()}catch(n){console.warn("Failed to set cache version:",n)}}async function Ls(){try{const t=await Ns();t!==Ht&&(console.log(`Cache version mismatch. Expected: ${Ht}, Found: ${t}. Clearing cache...`),await As(),await Ps(Ht))}catch(t){console.warn("Failed to check cache version:",t)}}const Ms="/drummer/assets/kick-f5f64180.mp3",Ds="/drummer/assets/snare-4eef7cb8.mp3",Os="/drummer/assets/hi-hat-closed-20faf03a.mp3",zs="/drummer/assets/hi-hat-open-c13c6d66.mp3",Fs="/drummer/assets/crash-0688e97a.mp3",Us="/drummer/assets/crash2-2d466720.mp3",Ws="/drummer/assets/ride-3a112803.mp3",Hs="/drummer/assets/tom1-e6733423.mp3",Vs="/drummer/assets/tom2-5814473e.mp3",Gs="/drummer/assets/tom3-3f3fe247.mp3",$s="/drummer/assets/metronome-6b186e46.mp3";let Vt=null,Gt=!1;const or=new Map;let Xt=!1,ht=null,pt=1,ar=100,Qt=null;function Zs(){return Vt||(Vt=es()),Vt}function Ks(){const t=Zs();return t.rawContext??t.context??t}function We(t,n){const c=Math.max(0,n-Be().currentTime)*1e3;setTimeout(()=>{t.forEach(r=>r.dispose())},c)}function Be(){return Ks()}async function ir(){if(Be().state==="suspended"&&!Gt){Gt=!0;try{await Kn()}finally{Gt=!1}}}async function qs(t,n,e=!1){const c=Be();try{let r;const s=await Is(c,n);if(s&&!e)r=s;else{const i=await(await fetch(t)).arrayBuffer();r=await c.decodeAudioData(i),await Rs(n,r)}or.set(n,r)}catch{}}function an(t=!1){if(Xt&&!t)return Promise.resolve();if(ht)return ht;const n=[{url:Ms,name:"kick"},{url:Ds,name:"snare"},{url:Os,name:"hiHatClosed"},{url:zs,name:"hiHatOpen"},{url:Fs,name:"crash1"},{url:Us,name:"crash2"},{url:Ws,name:"ride"},{url:Hs,name:"tom1"},{url:Vs,name:"tom2"},{url:Gs,name:"tom3"},{url:$s,name:"metronome"}];let e=0;return ht=(async()=>{for(const c of n)await qs(c.url,c.name,t),e++,Qt&&Qt(e,n.length,c.name);Xt=!0})(),ht}function Ys(){Be().state==="suspended"&&Kn().catch(()=>{}),an()}async function cr(){await Ls(),await an()}async function Js(){try{Xt=!1,ht=null,await an(!0)}catch(t){console.warn("Failed to update sample cache:",t)}}function $t(t){Qt=t}function lr(t,n=1,e=1){return Ve("metronome",t,n,!1,e,!1)}function ur(t,n=800,e=.01){const c=new we(.3).toDestination(),r=new ot({frequency:n,type:"sine"});r.connect(c),c.gain.setValueAtTime(.3,t),c.gain.exponentialRampToValueAtTime(.01,t+e),r.start(t),r.stop(t+e),We([r,c],t+e+.1)}function Xs(t){lr(t,.8,1.2)||ur(t,1e3,.02)}function Qs(t){lr(t,.6,1)||ur(t,600,.01)}function dr(t){Ve("kick",t,.9)||eo(t)}function eo(t){const n=new we(.85).toDestination(),e=new we,c=new ot({type:"sine"});c.connect(e),e.connect(n),c.frequency.setValueAtTime(150,t),c.frequency.exponentialRampToValueAtTime(40,t+.08),e.gain.setValueAtTime(1,t),e.gain.setValueAtTime(.8,t+.01),e.gain.exponentialRampToValueAtTime(.001,t+.25),c.start(t),c.stop(t+.25),We([c,e,n],t+.35)}function Ve(t,n,e=1,c=!0,r=1,s=!0){const a=or.get(t);if(!a)return!1;const i=s?ar/100:1,f=c?Math.max(0,Math.min(1,e*pt*i)):Math.max(0,Math.min(1,e*i)),k=new we(f).toDestination(),x=new Qr(a);x.connect(k),x.playbackRate=r;const g=Math.max(n,Be().currentTime);x.start(g);const y=Math.max(.01,r),h=a.duration/y;return We([x,k],g+h+.1),!0}function en(t){Ve("snare",t,.5)||to(t)}function to(t){const n=new we(.5).toDestination(),e=new ot({type:"triangle"}),c=new we;e.connect(c),c.connect(n),e.frequency.setValueAtTime(200,t),e.frequency.exponentialRampToValueAtTime(120,t+.05),c.gain.setValueAtTime(.7,t),c.gain.exponentialRampToValueAtTime(.001,t+.12);const r=new ot({type:"sine"}),s=new we;r.connect(s),s.connect(n),r.frequency.setValueAtTime(400,t),r.frequency.exponentialRampToValueAtTime(200,t+.03),s.gain.setValueAtTime(.3,t),s.gain.exponentialRampToValueAtTime(.001,t+.08);const a=new Pt("white"),i=new Lt({type:"bandpass",frequency:5e3,Q:1}),f=new we;a.connect(i),i.connect(f),f.connect(n),f.gain.setValueAtTime(.5,t),f.gain.exponentialRampToValueAtTime(.001,t+.18),e.start(t),e.stop(t+.12),r.start(t),r.stop(t+.08),a.start(t),a.stop(t+.18),We([e,c,r,s,a,i,f,n],t+.28)}function fr(t){Ve("hiHatClosed",t,.3)||no(t)}function no(t){const n=new we(.25).toDestination(),e=new Pt("white"),c=new Lt({type:"highpass",frequency:7e3}),r=new we;e.connect(c),c.connect(r),r.connect(n),r.gain.setValueAtTime(1,t),r.gain.exponentialRampToValueAtTime(.001,t+.05),e.start(t),e.stop(t+.05),We([e,c,r,n],t+.15)}function hr(t){Ve("hiHatOpen",t,.3)||ro(t)}function ro(t){const n=new we(.4).toDestination(),e=new Pt("white"),c=new Lt({type:"highpass",frequency:6e3}),r=new we;e.connect(c),c.connect(r),r.connect(n),r.gain.setValueAtTime(1,t),r.gain.exponentialRampToValueAtTime(.001,t+.35),e.start(t),e.stop(t+.35),We([e,c,r,n],t+.45)}function It(t,n=1){const e=n>1?"crash1":"crash2";Ve(e,t,.6)||so(t,n)}function so(t,n=1){const e=new we(.5).toDestination(),c=new Pt("white"),r=new Lt({type:"highpass",frequency:3e3*n}),s=new we;c.connect(r),r.connect(s),s.connect(e),s.gain.setValueAtTime(1,t),s.gain.exponentialRampToValueAtTime(.001,t+1.2),c.start(t),c.stop(t+1.2),We([c,r,s,e],t+1.3)}function mr(t){Ve("ride",t,.7)||oo(t)}function oo(t){const n=new we(.4).toDestination(),e=new we,c=new ot({type:"sine",frequency:3e3});c.connect(e),e.connect(n),e.gain.setValueAtTime(.4,t),e.gain.exponentialRampToValueAtTime(.001,t+.5),c.start(t),c.stop(t+.5),We([c,e,n],t+.6)}function rt(t,n=200){let e;n>=230?e="tom1":n>=180?e="tom2":e="tom3",!Ve(e,t,1)&&ao(t,n)}function ao(t,n=200){const e=new we(.65).toDestination(),c=new we,r=new ot({type:"sine"});r.connect(c),c.connect(e),r.frequency.setValueAtTime(n*1.5,t),r.frequency.exponentialRampToValueAtTime(n*.6,t+.2),c.gain.setValueAtTime(1,t),c.gain.exponentialRampToValueAtTime(.001,t+.3),r.start(t),r.stop(t+.3),We([r,c,e],t+.4)}async function jn(t,n=1){await ir(),await cr(),pt=n;const c=Be().currentTime;switch(t){case"Kick":dr(c);break;case"Snare":en(c);break;case"Hi-Hat Closed":fr(c);break;case"Hi-Hat Open":hr(c);break;case"Crash 1":It(c,1.2);break;case"Crash 2":It(c,1);break;case"Ride":mr(c);break;case"Tom 1":rt(c,280);break;case"Tom 2":rt(c,220);break;case"Tom 3":rt(c,160);break;default:en(c)}pt=1}function io(t){pt=t}function co(){pt=1}function lo(t){ar=Math.max(0,Math.min(100,t))}function uo({isMetronomePlaying:t,isPatternPlaying:n,setIsMetronomePlaying:e,setIsPatternPlaying:c}){const r=C.useRef(!1),s=C.useRef(!1),a=C.useRef(t),i=C.useRef(n);C.useEffect(()=>{a.current=t},[t]),C.useEffect(()=>{i.current=n},[n]),C.useEffect(()=>{const f=async()=>{if(document.hidden)r.current=a.current,s.current=i.current,e(!1),c(!1);else try{await ir(),r.current&&e(!0),s.current&&c(!0)}catch(k){console.error("Failed to resume audio context:",k)}};return document.addEventListener("visibilitychange",f),()=>{document.removeEventListener("visibilitychange",f)}},[e,c])}function fo(){const[t,n]=C.useState(!0),[e,c]=C.useState({loaded:0,total:11,currentName:""}),[r,s]=C.useState(!1);return C.useEffect(()=>{(async()=>{const i=setTimeout(()=>{s(!0)},200);try{$t((x,g,y)=>{c({loaded:x,total:g,currentName:y})}),Ys();const k=new Promise((x,g)=>{setTimeout(()=>g(new Error("Sample loading timeout")),1e4)});await Promise.race([cr(),k]),$t(null),Js().catch(()=>{})}catch{}finally{clearTimeout(i),$t(null),n(!1)}})()},[]),{isLoading:t,loadingProgress:e,showProgress:r}}const ho=300,mo=5;function po(){C.useEffect(()=>{const t={count:0},n={time:0},e=r=>!!(r.closest("button")||r.closest("input")||r.closest("select")||r.closest("a")||r.closest(".bottom-play-button-container")),c=r=>{const s=r.target;if(e(s))return;const a=Date.now();a-n.time>ho&&(t.count=0),t.count++,n.time=a,t.count>=mo&&(window.dispatchEvent(new CustomEvent("show-version")),t.count=0)};return document.body.addEventListener("pointerdown",c,{passive:!0}),()=>{document.body.removeEventListener("pointerdown",c)}},[])}function go(){const[t,n]=C.useState(!1),[e,c]=C.useState(!1),r=C.useCallback(()=>{n(i=>{const f=!i;return f&&c(!1),f})},[]),s=C.useCallback(()=>{c(i=>{const f=!i;return f&&n(!1),f})},[]),a=C.useCallback(()=>{n(!1),c(!1)},[]);return{isMetronomePlaying:t,isPatternPlaying:e,toggleMetronomePlay:r,togglePatternPlay:s,stopAll:a,setIsMetronomePlaying:n,setIsPatternPlaying:c}}const bo="drummer-bgm-files",vo=1,Ne="bgm-files",pr="drummer-bgm-config",gr="drummer-master-volume",br=100;function yo(){return`bgm-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function yt(){return new Promise((t,n)=>{const e=indexedDB.open(bo,vo);e.onerror=()=>n(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=c=>{const r=c.target.result;r.objectStoreNames.contains(Ne)||r.createObjectStore(Ne,{keyPath:"id"})}})}async function vr(t){const n=await yt(),e=n.transaction(Ne,"readwrite"),c=e.objectStore(Ne),r=yo(),s={id:r,blob:t,name:t.name,size:t.size,type:t.type,createdAt:Date.now()};try{return await new Promise((a,i)=>{e.oncomplete=()=>a(),e.onerror=()=>i(e.error),e.onabort=()=>i(new Error("Transaction aborted"));const f=c.put(s);f.onerror=()=>i(f.error)}),await new Promise(a=>setTimeout(a,50)),n.close(),{id:r,meta:{name:s.name,size:s.size,type:s.type}}}catch(a){throw n.close(),a}}async function yr(t){const n=await yt(),c=n.transaction(Ne,"readonly").objectStore(Ne),r=await new Promise((s,a)=>{const i=c.get(t);i.onsuccess=()=>s(i.result??null),i.onerror=()=>a(i.error)});return n.close(),r}async function Zt(t){const n=await yt(),e=n.transaction(Ne,"readwrite"),c=e.objectStore(Ne);await new Promise((r,s)=>{e.oncomplete=()=>r(),e.onerror=()=>s(e.error);const a=c.delete(t);a.onerror=()=>s(a.error)}),n.close()}async function xo(){const t=await yt(),e=t.transaction(Ne,"readonly").objectStore(Ne),c=await new Promise((r,s)=>{const a=e.getAll();a.onsuccess=()=>r(a.result),a.onerror=()=>s(a.error)});return t.close(),c}async function wo(){const t=await yt(),n=t.transaction(Ne,"readwrite"),e=n.objectStore(Ne);await new Promise((c,r)=>{n.oncomplete=()=>c(),n.onerror=()=>r(n.error);const s=e.clear();s.onerror=()=>r(s.error)}),t.close()}async function xr(t,n,e){const c=atob(t),r=new Uint8Array(c.length);for(let i=0;i<c.length;i++)r[i]=c.charCodeAt(i);const s=new Blob([r],{type:e}),a=new File([s],n,{type:e,lastModified:Date.now()});return vr(a)}function cn(){const t=localStorage.getItem(pr);if(!t)return{};try{const n=JSON.parse(t);if(n&&typeof n=="object")return n}catch{}return{}}function wr(t){localStorage.setItem(pr,JSON.stringify(t))}function ct(t){const e=cn()[t];return{fileId:e==null?void 0:e.fileId,offsetMs:(e==null?void 0:e.offsetMs)??0,volumePct:(e==null?void 0:e.volumePct)??br,meta:e==null?void 0:e.meta}}function et(t,n){const e=cn();e[t]={fileId:n.fileId,offsetMs:n.offsetMs??0,volumePct:n.volumePct??br,meta:n.meta},wr(e)}function En(t){const n=cn();delete n[t],wr(n)}const Tn=0;function ko(){const t=localStorage.getItem(gr);if(!t)return Tn;try{const n=JSON.parse(t);if(typeof n=="number"&&n>=0&&n<=100)return n}catch{}return Tn}function _o(t){const n=Math.max(0,Math.min(100,t));localStorage.setItem(gr,JSON.stringify(n))}function Kt(t,n){var s;const e=n.timeSignature[0],c=n.timeSignature[1];let r=0;for(let a=0;a<t;a++){const k=60/(((s=n.barBpmOverrides)==null?void 0:s[a])??n.bpm)*(4/c)*e;r+=k}return r}function So({isPlaying:t,isFullPracticeMode:n,playbackRate:e,bgmConfig:c,currentSubdivision:r,pattern:s,patternStartToken:a,rangeStartBar:i}){const f=s.timeSignature[0],k=s.timeSignature[1],x=C.useRef(null),g=C.useRef(void 0),[y,h]=C.useState({isLoading:!1,isLoaded:!1,error:null}),b=C.useRef(e);b.current=e;const u=C.useRef(0),m=C.useRef(null),p=C.useRef(0),v=C.useCallback(()=>{var X;const w=x.current;if(!w)return;const I=Be().currentTime,R=(c.offsetMs??0)/1e3,A=Math.max(.1,b.current),T=u.current,z=Kt(i,s),L=T/b.current+z-R,d=L/A,O=L<0?Math.abs(L):0,q=I+O,U=Math.max(0,d);let Q=U;if(((X=w.buffer)==null?void 0:X.duration)!==void 0){const P=Math.max(0,w.buffer.duration-.001);Q=Math.min(P,U)}w.state==="started"&&w.stop();const V=Math.max(q,p.current+.001);p.current=V,w.start(V,Q)},[c.offsetMs,s,i]);C.useEffect(()=>{let w=!1;return(async()=>{if(!c.fileId){g.current=void 0,x.current&&(x.current.stop(),x.current.dispose(),x.current=null),h({isLoading:!1,isLoaded:!1,error:null});return}if(!(c.fileId===g.current&&x.current)){h({isLoading:!0,isLoaded:!1,error:null});try{const I=await yr(c.fileId);if(!I)throw new Error("Background music file not found");const R=Be(),A=await I.blob.arrayBuffer(),T=await R.decodeAudioData(A.slice(0));if(w)return;x.current&&(x.current.stop(),x.current.dispose());const z=new ts(T).toDestination();z.loop=!1,z.playbackRate=Math.max(.1,b.current),z.grainSize=.2,z.overlap=.02;const D=Math.max(0,Math.min(100,c.volumePct??100)),_=Math.max(1e-4,D/100);z.volume.value=gn(_),x.current=z,g.current=c.fileId,h({isLoading:!1,isLoaded:!0,error:null})}catch(I){w||h({isLoading:!1,isLoaded:!1,error:I instanceof Error?I.message:"Failed to load background music"})}}})(),()=>{w=!0}},[c.fileId,c.volumePct]),C.useEffect(()=>{var L;const w=f*me,E=Math.floor(r/w),I=r%w,R=Kt(E,s),D=60/((((L=s.barBpmOverrides)==null?void 0:L[E])??s.bpm)*e)*(4/k)/me,_=Kt(i,s);u.current=R+I*D-_},[r,s,k,e,i,f]),C.useEffect(()=>{const w=x.current;w&&(w.playbackRate=Math.max(.1,e))},[e]),C.useEffect(()=>{const w=x.current;if(!w)return;const E=Math.max(0,Math.min(100,c.volumePct??100)),I=Math.max(1e-4,E/100);w.volume.value=gn(I)},[c.volumePct]);const S=C.useRef(c.offsetMs??0);return C.useEffect(()=>{if(!x.current||!t||!n||!c.fileId||!y.isLoaded){S.current=c.offsetMs??0;return}const E=S.current;S.current=c.offsetMs??0,E!==(c.offsetMs??0)&&v()},[c.offsetMs,t,n,y.isLoaded,c.fileId,v]),C.useEffect(()=>{const w=x.current;if(!w)return;if(!n||!c.fileId){w.state==="started"&&w.stop();return}if(!t){w.state==="started"&&w.stop();return}const E=Be();E.state==="suspended"&&E.resume().catch(()=>{}),v()},[t,n,c.fileId,c.offsetMs,y.isLoaded,a,v]),C.useEffect(()=>{if(!t||!n||!c.fileId||!y.isLoaded){m.current=r;return}const w=m.current;m.current=r,w!==null&&r<w&&v()},[r,t,n,c.fileId,y.isLoaded,v]),C.useEffect(()=>{m.current=r},[r]),C.useEffect(()=>()=>{x.current&&(x.current.stop(),x.current.dispose(),x.current=null)},[]),y}let Et=null;async function kr(){if("wakeLock"in navigator)try{Et=await navigator.wakeLock.request("screen")}catch{}}async function tn(){if(Et!==null)try{await Et.release(),Et=null}catch{}}let Rn=0;const Bo=16;function _r({bpm:t,timeSignature:n,isPlaying:e,onBeatChange:c,resetToken:r}){const[s,a]=C.useState(0),[i,f]=C.useState(0),k=C.useRef(t),x=C.useRef(n),g=C.useRef(c);k.current=t,x.current=n,g.current=c;const y=C.useRef(0),h=C.useRef(0),b=C.useRef(null),u=C.useRef(!1),m=C.useRef(new Set),p=C.useCallback(()=>{const w=Be();if(!u.current)return;const E=k.current,I=x.current,R=I[0],A=I[1],z=60/E*(4/A)/me,D=R*me,_=w.currentTime,L=.1;for(;y.current<_+L;){const d=h.current,O=Math.floor(d/me),q=Math.max(y.current,_),U=(q-_)*1e3;if(d%me===0){O===0?Xs(q):Qs(q);const P=g.current;if(P){const N=window.setTimeout(()=>P(O),U);m.current.add(N)}}const Q=d,V=O,X=window.setTimeout(()=>{m.current.delete(X),Date.now()-Rn>=Bo?requestAnimationFrame(()=>{Rn=Date.now(),u.current&&(f(Q),a(V))}):u.current&&(f(Q),a(V))},Math.max(0,U));m.current.add(X),h.current=(h.current+1)%D,y.current+=z}},[]),v=C.useCallback(async()=>{const w=Be();if(u.current)return;w.state==="suspended"&&await w.resume(),await new Promise(I=>requestAnimationFrame(I)),kr(),u.current=!0;const E=w.currentTime;y.current=E,p(),b.current=window.setInterval(p,25)},[p]),S=C.useCallback(()=>{u.current=!1,b.current!==null&&(clearInterval(b.current),b.current=null),m.current.forEach(w=>{clearTimeout(w)}),m.current.clear(),tn()},[]);return C.useEffect(()=>(e?v():S(),()=>{S()}),[e,v,S]),C.useEffect(()=>{if(e&&u.current){const w=Be();y.current=w.currentTime}},[t,n,e]),C.useEffect(()=>{if(h.current=0,f(0),a(0),m.current.forEach(w=>{clearTimeout(w)}),m.current.clear(),e&&u.current){const w=Be();y.current=w.currentTime}},[r,e]),{currentBeat:s,currentSubdivision:i}}function Co({bpm:t,onChange:n,min:e=40,max:c=200,disabled:r=!1}){const s=C.useRef(null),[a,i]=C.useState(!1),[f,k]=C.useState(null),x=C.useCallback(w=>(w-e)/(c-e)*100,[e,c]),g=C.useCallback(w=>{const E=e+w/100*(c-e);return Math.round(E/5)*5},[e,c]),y=C.useCallback(w=>{if(!s.current)return;const E=s.current.getBoundingClientRect(),I=Math.max(0,Math.min(100,(w-E.left)/E.width*100)),R=g(I),A=Math.max(e,Math.min(c,R));n(A)},[g,e,c,n]),h=C.useCallback(w=>{r||(i(!0),y(w.clientX),w.target.setPointerCapture(w.pointerId))},[r,y]),b=C.useCallback(w=>{a&&y(w.clientX)},[a,y]),u=C.useCallback(()=>{i(!1)},[]);C.useEffect(()=>{if(a)return window.addEventListener("pointermove",b),window.addEventListener("pointerup",u),()=>{window.removeEventListener("pointermove",b),window.removeEventListener("pointerup",u)}},[a,b,u]),C.useEffect(()=>{const w=()=>{if(s.current){const E=s.current.getBoundingClientRect();k(E.width)}};return w(),window.addEventListener("resize",w),()=>window.removeEventListener("resize",w)},[]);const m=x(t),p=Math.max(0,m),v=20,S=f?p*(f-v)/f:p;return o.jsx("div",{className:"bpm-slider-container",children:o.jsxs("div",{ref:s,className:`bpm-slider-track ${r?"bpm-slider-disabled":""}`,onPointerDown:h,children:[o.jsx("div",{className:"bpm-slider-fill",style:{width:`calc(${S}% + ${v/2}px)`}}),o.jsx("div",{className:"bpm-slider-thumb",style:{left:`calc((100% - ${v}px) * ${p/100})`}})]})})}function jo({currentBeat:t,beatsPerBar:n}){return o.jsx("div",{className:"beat-dots",children:Array.from({length:n},(e,c)=>o.jsx("div",{className:`beat-dot ${c===t?"active":""}`},c))})}function Eo({isPlaying:t,onClick:n,loopCount:e=0,onResetCount:c}){const r=C.useRef(null),s=C.useRef(!1),a=C.useRef(0),i=500,f=()=>{c&&(s.current=!1,r.current=window.setTimeout(()=>{c(),s.current=!0,r.current=null},i))},k=()=>{r.current&&(clearTimeout(r.current),r.current=null)},x=()=>{r.current&&(clearTimeout(r.current),r.current=null)},g=()=>{c&&(a.current=Date.now(),s.current=!1,r.current=window.setTimeout(()=>{c(),s.current=!0,r.current=null},i))},y=u=>{r.current&&(clearTimeout(r.current),r.current=null),s.current&&(u.preventDefault(),setTimeout(()=>{s.current=!1},100))},h=u=>{if(s.current){u.preventDefault(),u.stopPropagation(),s.current=!1;return}n()},b=e>0;return o.jsx("button",{className:"play-button"+(t?" playing":" paused"),onClick:h,onMouseDown:f,onMouseUp:k,onMouseLeave:x,onTouchStart:g,onTouchEnd:y,"aria-label":t?"Pause":"Play",children:b?o.jsx("span",{className:"play-button-count",children:e}):t?o.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):o.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})})}function Ie(t,n={}){const{delay:e=500,interval:c=100,shouldStop:r,clickCallback:s}=n,a=C.useRef(null),i=C.useRef(null),f=C.useRef(!1),k=C.useRef(0),x=C.useRef(!1),g=C.useRef(t);g.current=t;const y=C.useCallback(()=>{f.current=!1,a.current&&(clearTimeout(a.current),a.current=null),i.current&&(clearInterval(i.current),i.current=null)},[]),h=C.useCallback(()=>{f.current||(f.current=!0,k.current=Date.now(),x.current=!1,a.current=setTimeout(()=>{if(f.current){if(r!=null&&r()){y();return}x.current=!0,g.current(),i.current=setInterval(()=>{if(f.current){if(r!=null&&r()){y();return}g.current()}},c)}},e))},[e,c,r,y]),b=C.useCallback(()=>{const I=Date.now()-k.current;!x.current&&I<e&&(s?s():g.current())},[e,s]),u=C.useCallback(()=>{h()},[h]),m=C.useCallback(()=>{y()},[y]),p=C.useCallback(()=>{y()},[y]),v=C.useCallback(I=>{h()},[h]),S=C.useCallback(I=>{y()},[y]),w=C.useCallback(I=>{y()},[y]),E=C.useCallback(I=>{I.preventDefault()},[]);return C.useEffect(()=>()=>{y()},[y]),{onClick:b,onMouseDown:u,onMouseUp:m,onMouseLeave:p,onTouchStart:v,onTouchEnd:S,onTouchCancel:w,onContextMenu:E}}function To({bpm:t,timeSignature:n,isPlaying:e,resetToken:c,onBPMChange:r,isPatternPlaying:s=!1,isCountInPlaying:a=!1,countInBeat:i,onPatternPlayToggle:f,onTimeSignatureChange:k,rateIndex:x,onRateIndexChange:g,rates:y,rateLabels:h,patternPlayButton:b}){const u=C.useMemo(()=>[[4,4],[3,4],[2,4],[6,8],[5,4],[7,8]],[]),m=C.useCallback(()=>{const P=u.findIndex(N=>N[0]===n[0]&&N[1]===n[1]);return P>=0?P:0},[n,u]),[p,v]=C.useState(()=>{const P=u.findIndex(N=>N[0]===n[0]&&N[1]===n[1]);return P>=0?P:0});C.useEffect(()=>{const P=m();v(P)},[m]);const S=()=>{if(k){const P=(p+1)%u.length,N=u[P];v(P),k(N)}},{currentBeat:w}=_r({bpm:t,timeSignature:n,isPlaying:s,resetToken:c}),[E,I]=C.useState(0),R=C.useRef(-1);C.useEffect(()=>{const P=n[0];R.current===P-1&&w===0&&I(N=>N+1),R.current=w},[w,n]),C.useEffect(()=>{s||(R.current=-1,I(0))},[s]);const A=()=>{I(0)},T=40,z=200,D=()=>{const P=Math.round(Math.max(T,t-1)*10)/10;r(P)},_=()=>{const P=Math.round(Math.min(z,t+1)*10)/10;r(P)},L=()=>{const P=Math.round(Math.max(T,t-.5)*10)/10;r(P)},d=()=>{const P=Math.round(Math.min(z,t+.5)*10)/10;r(P)},O=Ie(D,{shouldStop:()=>t<=T,clickCallback:L}),q=Ie(_,{shouldStop:()=>t>=z,clickCallback:d}),U=P=>{y.length&&g(P)},Q=()=>{U(x+1)},V=()=>{y.length&&U(x+y.length-1)},X=a&&i!==void 0?i:w;return o.jsxs("div",{className:"metronome-bar",children:[o.jsxs("div",{className:"metronome-row metronome-row-top",children:[o.jsx("div",{className:"beat-indicator-group",onClick:S,children:o.jsx(jo,{currentBeat:X,beatsPerBar:n[0]})}),o.jsxs("div",{className:"bpm-control-group",children:[o.jsx("button",{className:"bpm-control-button",...O,disabled:t<=T||!!h[x%h.length],"aria-label":"Decrease BPM",children:o.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsxs("div",{className:"bpm-display",children:[o.jsxs("span",{className:"bpm-value",children:[o.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-left",onClick:Q,"aria-label":"BPM rate next"}),o.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-right",onClick:V,"aria-label":"BPM rate prev"}),(()=>{const P=Math.round(t*10)/10,N=P!==Math.round(t),Y=Math.floor(P),Z=N?String(P).split(".")[1]:null;return o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"bpm-value-integer",children:Y}),Z&&o.jsxs("span",{className:"bpm-value-decimal",children:[".",Z]})]})})()]}),h[x%h.length]&&o.jsx("span",{className:"bpm-rate-label",children:h[x%h.length]})]}),o.jsx("button",{className:"bpm-control-button",...q,disabled:t>=z||!!h[x%h.length],"aria-label":"Increase BPM",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),o.jsx("div",{className:"loop-count-group",children:b||f&&o.jsx(Eo,{isPlaying:s,onClick:f,loopCount:E,onResetCount:A})})]}),o.jsx("div",{className:"metronome-row metronome-row-bottom",children:o.jsx(Co,{bpm:t,onChange:r,disabled:!!h[x%h.length]})})]})}function Ro(t,n,e,c){return e+2*c+t*c}function Io(t){return fs[t]}const qe=7,Se=qe*.707,In=.8,Le=10,At=18,tt=At,lt=5*At;function Ao({pattern:t,cellSize:n,currentBeat:e,scrollContainerRef:c,onDoubleClick:r}){const s=C.useRef(null),a=C.useRef(null),i=n,f=A=>{if(!r)return;const T=s.current;if(!T)return;const z=T.getBoundingClientRect(),D=A.clientX-z.left,_=Math.floor(D/i);r(_)},k=C.useRef(null),x=300,g=30,y=A=>{if(!r)return;const T=s.current;if(!T)return;const z=A.touches[0],D=Date.now(),_=T.getBoundingClientRect(),L=z.clientX-_.left;if(k.current){const{time:d,x:O}=k.current,q=D-d,U=Math.abs(L-O);if(q<x&&U<g){const Q=Math.floor(L/i);r(Q),k.current=null;return}}k.current={time:D,x:L}},h=A=>getComputedStyle(document.documentElement).getPropertyValue(A).trim(),b=h("--color-text"),u=h("--color-text-tertiary"),m=h("--color-beat-line"),p=h("--color-warning"),[v]=t.timeSignature,w=t.bars*v*me*i,E=lt+tt,I=Array.from({length:t.bars+1},(A,T)=>({x:T*v*me*i,isFirst:T===0,isLast:T===t.bars})),R=Array.from({length:t.bars*v+1},(A,T)=>({x:T*me*i}));return o.jsx("div",{className:"drum-notation-container",ref:a,children:o.jsxs("svg",{ref:s,className:"drum-notation-svg",viewBox:`0 0 ${w} ${E}`,width:w,height:E,preserveAspectRatio:"none",onDoubleClick:f,onTouchStart:y,children:[o.jsx("line",{x1:0,y1:0,x2:w,y2:0,stroke:b,strokeWidth:2,opacity:.8}),Array.from({length:6},(A,T)=>{const z=tt+T*At,D=T===0;return o.jsx("line",{x1:0,y1:z,x2:w,y2:z,stroke:b,strokeWidth:T===5?2:1,opacity:.8,strokeDasharray:D?"4,4":"0"},`staff-line-${T}`)}),I.map((A,T)=>o.jsx("line",{x1:A.x,y1:0,x2:A.x,y2:tt+lt,stroke:A.isFirst||A.isLast?b:u,strokeWidth:A.isFirst||A.isLast?3:2,strokeDasharray:A.isFirst||A.isLast?"0":"4,4",opacity:A.isFirst||A.isLast?1:.6},`bar-line-${T}`)),R.map((A,T)=>T%v===0?null:o.jsx("line",{x1:A.x,y1:0,x2:A.x,y2:tt+lt,stroke:m,strokeWidth:1,opacity:.4},`beat-line-${T}`)),e!==void 0&&e>=0&&o.jsx("rect",{x:e*i,y:0,width:i,height:tt+lt,fill:p,opacity:.4}),t.grid.map((A,T)=>{const z=t.drums[T],D=Io(z),_=Ro(D.line,lt,tt,At);return A.map((L,d)=>{if(!L)return null;const O=d*i+i/2,q=D.symbol,U=`symbol-${T}-${d}`,Q=L===Pe,V=L===He,X=L===Me,P=L===Fe,N=L===Ue,Y=i*.22,Z=X||P||N?[...X||P?[O-Y]:[],...X||N?[O+Y]:[]]:[O],H=K=>{const re=[],le=K-qe-In,ce=K+qe+In,ue=_-Le/2,pe=_+Le/2,be=_-Le/2,l=_+Le/2;return Q?(re.push(o.jsx("path",{d:`M ${le} ${ue}
                        A ${Le} ${Le} 0 0 0 ${le} ${pe}`,fill:"none",stroke:b,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${K}`)),re.push(o.jsx("path",{d:`M ${ce} ${be}
                        A ${Le} ${Le} 0 0 1 ${ce} ${l}`,fill:"none",stroke:b,strokeWidth:1.5,strokeLinecap:"round"},`right-bracket-${K}`))):V&&re.push(o.jsx("path",{d:`M ${le} ${ue}
                        A ${Le} ${Le} 0 0 0 ${le} ${pe}`,fill:"none",stroke:b,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${K}`)),re},se=K=>{if(z==="Crash 1"||z==="Crash 2")return o.jsxs("g",{children:[o.jsx("circle",{cx:K,cy:_,r:qe,fill:"none",stroke:b,strokeWidth:2}),o.jsx("line",{x1:K-Se,y1:_-Se,x2:K+Se,y2:_+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"}),o.jsx("line",{x1:K+Se,y1:_-Se,x2:K-Se,y2:_+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"}),H(K)]},`${U}-${K}`);let re=null;switch(q){case"x":re=o.jsxs("g",{children:[o.jsx("line",{x1:K-Se,y1:_-Se,x2:K+Se,y2:_+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"}),o.jsx("line",{x1:K+Se,y1:_-Se,x2:K-Se,y2:_+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"})]});break;case"o":re=o.jsx("circle",{cx:K,cy:_,r:qe,fill:"none",stroke:b,strokeWidth:2});break;case"●":re=o.jsx("circle",{cx:K,cy:_,r:qe,fill:b});break;case"○":re=o.jsx("circle",{cx:K,cy:_,r:qe,fill:"none",stroke:b,strokeWidth:2});break;default:return null}return o.jsxs("g",{children:[re,H(K)]},`${U}-${K}`)};return Z.map(K=>se(K))})})]})})}const No=[{base:1,dots:0,units32:32},{base:2,dots:1,units32:24},{base:2,dots:0,units32:16},{base:4,dots:1,units32:12},{base:4,dots:0,units32:8},{base:8,dots:1,units32:6},{base:8,dots:0,units32:4},{base:16,dots:1,units32:3},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}],Po=[{base:4,dots:0,units32:8},{base:8,dots:0,units32:4},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}];function Lo(t){if(!Number.isFinite(t)||t<=0)throw new Error(`gapUnits32 must be > 0, got: ${t}`);const n=No.find(e=>e.units32<=t);return n||{base:32,dots:0,units32:1}}function _t(t){if(!Number.isFinite(t)||t<0)throw new Error(`gapUnits32 must be >= 0, got: ${t}`);const n=[];let e=t;for(;e>0;){const c=Po.find(r=>r.units32<=e);if(!c)break;n.push(c),e-=c.units32}return n}const mt={"Crash 1":{keys:["b/5/x"],isLowerVoice:!1},"Crash 2":{keys:["a/5/x"],isLowerVoice:!1},"Hi-Hat Open":{keys:["g/5/x"],isLowerVoice:!1},"Hi-Hat Closed":{keys:["g/5/x"],isLowerVoice:!1},Ride:{keys:["f/5/x"],isLowerVoice:!1},"Tom 1":{keys:["e/5"],isLowerVoice:!1},"Tom 2":{keys:["d/5"],isLowerVoice:!1},Snare:{keys:["c/5"],isLowerVoice:!1},"Tom 3":{keys:["a/4"],isLowerVoice:!1},Kick:{keys:["f/4"],isLowerVoice:!0}};function Mo(t){const n=[],e=[],[c]=t.timeSignature,r=t.bars*c*me;for(let s=0;s<r;s++){const a=()=>({0:{normal:[],ghost:[],grace:[]},1:{normal:[],ghost:[],grace:[]}}),i=a(),f=a();let k=!1,x=!1;t.drums.forEach((y,h)=>{var p;const b=((p=t.grid[h])==null?void 0:p[s])??Ce;if(b===Ce)return;const u=mt[y].isLowerVoice?f:i,m=(v,S)=>{u[S][v].push({drum:y,cellState:b})};b===Me?(m("normal",0),m("normal",1),mt[y].isLowerVoice?x=!0:k=!0):b===Fe?(m("normal",0),mt[y].isLowerVoice?x=!0:k=!0):b===Ue?(m("normal",1),mt[y].isLowerVoice?x=!0:k=!0):b===He?y==="Snare"?(m("normal",0),m("grace",0)):m("normal",0):m(b===Pe?"ghost":"normal",0)});const g=(y,h,b,u)=>{const m=h[b],p=[...m.normal.map(v=>({...v,kind:"normal"})),...m.ghost.map(v=>({...v,kind:"ghost"}))];if(p.length>0){const S=p.every(w=>w.kind==="ghost")?"ghost":"normal";y.push({subdivision:s,subPosition:b,drums:p,is32nd:u,kind:S,graceDrums:m.grace.length>0?[...m.grace]:void 0})}};g(n,i,0,k),g(n,i,1,!0),g(e,f,0,x),g(e,f,1,!0)}return{upperVoice:n,lowerVoice:e}}function Do(t,n,e={}){const c=e.includeFullBarRestWhenEmpty??!1,r=e.omitTailRests??!0,s=e.maxSpanBarFraction??.25,a=n*2,i=s===.25?a/4:a,f=[...t].sort((h,b)=>h.subdivision!==b.subdivision?h.subdivision-b.subdivision:h.subPosition-b.subPosition),k=h=>h.subdivision*2+h.subPosition,x=[];let g=0;const y=h=>{if(i<=0)return 1;const b=h%i;return b===0?i:i-b};if(f.length===0){if(!c)return x;const h=_t(a);for(const b of h)x.push({kind:"rest",startUnits32InBar:g,durationToken:b,durationUnits32:b.units32}),g+=b.units32;return x}for(let h=0;h<f.length;h++){const b=f[h],u=k(b),m=h+1<f.length?k(f[h+1]):a;if(u>g){const I=u-g,R=_t(I);for(const A of R)x.push({kind:"rest",startUnits32InBar:g,durationToken:A,durationUnits32:A.units32}),g+=A.units32}g=Math.max(g,u);const p=Math.max(1,m-u),v=y(u),S=Math.max(1,Math.min(p,v)),w=Lo(S);x.push({kind:"note",event:b,startUnits32InBar:u,durationToken:w,durationUnits32:w.units32}),g=u+w.units32;const E=h+1>=f.length;if(!E&&g<m){const I=m-g,R=_t(I);for(const A of R)x.push({kind:"rest",startUnits32InBar:g,durationToken:A,durationUnits32:A.units32}),g+=A.units32}if(E&&!r&&g<a){const I=a-g,R=_t(I);for(const A of R)x.push({kind:"rest",startUnits32InBar:g,durationToken:A,durationUnits32:A.units32}),g+=A.units32}}return x}function Oo(t){var c;const n=t,e=(c=n.getXShift)==null?void 0:c.call(n);return typeof e=="number"?e:typeof n.x_shift=="number"?n.x_shift:0}function Sr(t){const n=ns;typeof n.buildAndAttach=="function"&&n.buildAndAttach([t],{all:!0})}function zo(t,n,e,c,r,s){const a=t-c;if(s){if(s===4)return(a+1.5)*e+e/2;if(s===8)return(a+.5)*e+e/2}const i=a*e+e/2;if(!r)return i;const f=e*.22;return n===0?i-f:i+f}function Fo(t,n){if(!n.includes("Hi-Hat Open"))return;const e=new nt("○");e.setVerticalJustification(nt.VerticalJustify.TOP),e.setJustification(nt.HorizontalJustify.CENTER_STEM),e.setFont("",5,900),e.setXShift(-11),e.setYShift(36),t.addModifier(e,0)}function Uo(t,n){if(!n||n.length===0)return;const e=new nt("♪");e.setVerticalJustification(nt.VerticalJustify.BOTTOM),e.setJustification(nt.HorizontalJustify.CENTER_STEM),e.setFont("",15,"normal"),e.setXShift(10),e.setYShift(-55),t.addModifier(e,0)}function Wo(t,n,e){const c=[];let r;for(const{drum:f}of t.drums){const k=mt[f];c.push(...k.keys),r=k.keys.some(x=>x.includes("x"))}const s={keys:c,duration:String(e.base),clef:"percussion",stemDirection:n?-1:1},a=new qn(s);e.dots===1&&Sr(a);const i=t.drums.filter(f=>f.kind==="ghost").map(f=>f.drum);if(i.length>0&&(a._ghostDrums=i),r&&!n){const f=a.getStem();f&&f.setOptions({stemUpYOffset:4})}return Fo(a,t.drums.map(f=>f.drum)),Uo(a,t.graceDrums),a}function Ho(t,n){const e=`${t.base}r`,c=n?["f/4"]:["c/5"],r=new qn({keys:c,duration:e,clef:"percussion",stemDirection:n?-1:1});return t.dots===1&&Sr(r),r}function An(t,n,e){const c=Do(t,n,{includeFullBarRestWhenEmpty:!0,omitTailRests:!1,maxSpanBarFraction:.25});return c.some(s=>s.kind==="note")?c.map(s=>{if(s.kind==="note")return{note:Wo(s.event,e,s.durationToken),event:s.event,isRest:!1,startUnits32InBar:s.startUnits32InBar,durationUnits32:s.durationUnits32};const a=s.startUnits32InBar,i={subdivision:Math.floor(a/2),subPosition:a%2,drums:[],is32nd:a%2===1,kind:"normal"};return{note:Ho(s.durationToken,e),event:i,isRest:!0,startUnits32InBar:s.startUnits32InBar,durationUnits32:s.durationUnits32}}):[]}function Vo(t,n){const e=n*2,c=Math.floor(e/2);let r=!1,s=!1;for(const a of t){if(a.isRest)continue;const i=a.note.getDuration();Number.parseInt(i.replace(/[rd]/g,""),10)>=16&&((a.startUnits32InBar??a.event.subdivision*2+a.event.subPosition)<c?r=!0:s=!0)}return[r,s]}function Go(t,n){const e=n*2,c=Math.floor(e/2),r=[],s=[];for(const a of t)(a.startUnits32InBar??a.event.subdivision*2+a.event.subPosition)<c?r.push(a):s.push(a);return[r,s]}function $o(t,n,e){return(t+n/2)/2*e-e/4*1.2}function Zo(t,n,e){const c=n*2,r=Math.floor(c/e),s=Array.from({length:e},()=>[]);for(const a of t){const i=a.startUnits32InBar??a.event.subdivision*2+a.event.subPosition,f=Math.floor(i/r);f>=0&&f<e&&s[f].push(a)}return s.filter(a=>a.length>0)}const Tt=130,Ko=40,qo=35,Yo=(Tt-Ko)/2-qo;function Jo({pattern:t,cellSize:n,currentBeat:e,scrollContainerRef:c,onDoubleClick:r}){const s=C.useRef(null),a=n,i=C.useRef(null),f=300,k=30,[x]=t.timeSignature,g=t.bars*x*me,y=g*a,h=x*me*a,[b,u]=C.useState([]),m=1,p=C.useCallback(()=>{if(!c||!c.current||!s.current)return;const I=c.current,R=s.current,A=I.getBoundingClientRect(),T=R.getBoundingClientRect(),z=A.left-T.left,D=z+A.width,_=Math.max(0,Math.floor(z/h)),L=Math.min(t.bars-1,Math.ceil(D/h)),d=[],O=Math.max(0,_-m),q=Math.min(t.bars-1,L+m);for(let U=O;U<=q;U++)d.push(U);u(d)},[c,h,t.bars]);C.useEffect(()=>{p();const I=c==null?void 0:c.current;if(!I)return;const R=()=>{requestAnimationFrame(p)};return I.addEventListener("scroll",R,{passive:!0}),window.addEventListener("resize",p),()=>{I.removeEventListener("scroll",R),window.removeEventListener("resize",p)}},[c,p]);const v=C.useMemo(()=>new Set(b),[b]),S=C.useCallback(I=>{const R=s.current;if(!R)return 0;const A=R.getBoundingClientRect(),T=I-A.left;return Math.floor(T/a)},[a]),w=C.useCallback(I=>{if(!r)return;const R=S(I.clientX);r(R)},[r,S]),E=C.useCallback(I=>{if(!r)return;const R=I.touches[0],A=Date.now(),T=R.clientX;if(i.current){const{time:z,x:D}=i.current,_=A-z,L=Math.abs(T-D);if(_<f&&L<k){const d=S(T);r(d),i.current=null;return}}i.current={time:A,x:T}},[r,S]);return C.useEffect(()=>{var z,D;const I=s.current;if(!I)return;I.innerHTML="";const R=new bn(I,bn.Backends.SVG);R.resize(y,Tt);const A=R.getContext();for(let _=0;_<t.bars;_++){if(!v.has(_))continue;const L=_*h,d=new rs(L,Yo,h);d.setContext(A),_===t.bars-1&&d.setEndBarType(ss.type.END),d.draw();const{upperVoice:O,lowerVoice:q}=Mo(t),U=_*x*me,Q=(_+1)*x*me,V=O.filter(se=>se.subdivision>=U&&se.subdivision<Q),X=q.filter(se=>se.subdivision>=U&&se.subdivision<Q),P=x*me,N=An(V.map(se=>({...se,subdivision:se.subdivision-U})),P,!1).map(se=>({...se,event:{...se.event,subdivision:se.event.subdivision+U}})),Y=An(X.map(se=>({...se,subdivision:se.subdivision-U})),P,!0).map(se=>({...se,event:{...se.event,subdivision:se.event.subdivision+U}})),Z=N,H=Y;if(Z.length>0||H.length>0){const se=[],K=[...Z,...H];if(Z.length>0){const ce=new vn({numBeats:x,beatValue:4}).setStrict(!1);ce.addTickables(Z.map(ue=>ue.note)),se.push(ce)}if(H.length>0){const ce=new vn({numBeats:x,beatValue:4}).setStrict(!1);ce.addTickables(H.map(ue=>ue.note)),se.push(ce)}se.length>0&&new os().joinVoices(se).format(se,h-20);for(const ce of K){const{note:ue,event:pe,isRest:be,startUnits32InBar:l,durationUnits32:$}=ce;let W;be&&l!==void 0&&$?W=$o(l,$,a):W=zo(pe.subdivision,pe.subPosition,a,U,pe.is32nd)-a/4,ue.setStave(d);const j=d.getX()+W,B=ue.getAbsoluteX(),M=j-B;ue.setXShift(Oo(ue)+M)}const re=[],le=[{notes:Z,stemDirection:1},{notes:H,stemDirection:-1}];for(const{notes:ce,stemDirection:ue}of le){const pe=ce.filter(B=>{const M=B.note.getDuration(),G=Number.parseInt(M.replace(/[rd]/g,""),10);return Number.isFinite(G)&&G>=8});if(pe.length===0)continue;const[be,l]=Vo(pe,P),[$,W]=Go(pe,P),j=[{notes:$,hasSixteenth:be},{notes:W,hasSixteenth:l}];for(const{notes:B,hasSixteenth:M}of j)if(B.length!==0)if(M){const G=Zo(B,P,x);for(const J of G){if(J.length===0)continue;const F=yn.generateBeams(J.map(ee=>ee.note),{stemDirection:ue,flatBeams:!0,groups:[new xn(1,4)]});re.push(...F)}}else{const G=yn.generateBeams(B.map(J=>J.note),{stemDirection:ue,flatBeams:!0,groups:[new xn(1,2)]});re.push(...G)}}se.forEach(ce=>ce.draw(A,d)),re.forEach(ce=>ce.setContext(A).draw());for(const ce of K){const ue=ce.note;if(ue._ghostDrums&&ue._ghostDrums.length>0&&ue.noteHeads){const pe=new Set(ue._ghostDrums),be=ce.event.drums.map(l=>l.drum);for(let l=0;l<ue.noteHeads.length;l++){const $=ue.noteHeads[l];if(!$)continue;const W=be[l];if(!W||!pe.has(W))continue;const j=((z=$.getSVGElement)==null?void 0:z.call($))??$.el;if(j){const B=(D=j.getBBox)==null?void 0:D.call(j);if(B){const M=B.x+B.width/2,G=B.y+B.height/2;j.setAttribute("transform",`translate(${M}, ${G}) scale(0.75) translate(${-M+(W==="Kick"?-2:2)}, ${-G})`)}}}}}}}const T=I.querySelector("svg");if(T&&(T.querySelectorAll(".vf-stave").forEach(d=>{d.setAttribute("stroke","#aaa")}),T.querySelectorAll(".vf-stavebarline").forEach(d=>{d.querySelectorAll("rect").forEach(q=>{q.setAttribute("stroke","transparent"),q.setAttribute("fill","#333")})})),e!==void 0&&e>=0){const _=I.querySelector("svg");if(_){const L=document.createElementNS("http://www.w3.org/2000/svg","rect");L.setAttribute("x",String(e*a)),L.setAttribute("y","0"),L.setAttribute("width",String(a)),L.setAttribute("height",String(Tt)),L.setAttribute("fill","#fbbf24"),L.setAttribute("opacity","0.3"),L.setAttribute("stroke","transparent"),_.insertBefore(L,_.firstChild)}}},[t,e,a,y,x,g,h,v]),o.jsx(o.Fragment,{children:o.jsx("div",{className:"drum-notation-container vexflow-renderer",ref:s,onDoubleClick:w,onTouchStart:E,style:{width:y,height:Tt,backgroundColor:"#ffffff"}})})}const Nn="drummer-renderer-change";function Xo(t){const[n,e]=C.useState(()=>Cn()),[c,r]=C.useState(!1);C.useEffect(()=>{const i=()=>{e(Cn()),r(!1)};return window.addEventListener(Nn,i),()=>{window.removeEventListener(Nn,i)}},[]);const s=C.useCallback(()=>{console.error("VexFlow rendering failed, falling back to Legacy renderer"),r(!0)},[]);return C.useMemo(()=>n==="vexflow"&&!c,[n,c])?o.jsx(Qo,{onError:s,children:o.jsx(Jo,{...t})}):o.jsx(Ao,{...t})}class Qo extends C.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(n,e){console.error("VexFlow rendering error:",n,e),this.props.onError()}render(){return this.state.hasError?null:this.props.children}}const Pn=300,Ln=200,ea=30;function ta({cellState:t,onClick:n,onToggleGhost:e,onDoubleClick:c,isCurrentBeat:r,drumType:s,subdivisionIndex:a=0,style:i}){const f=C.useRef(0),k=100,x=C.useRef(0),g=C.useRef(null),y=C.useRef(null),h=C.useRef(!1),b=C.useRef(0),u=C.useRef(!1),m=C.useRef(null),[p,v]=C.useState(!1),S=t!==Ce,w=t===Pe,E=t===He,I=t===Me,R=t===Fe,A=t===Ue,T=I||R||A,z=Math.floor(a/4)%2===1,D=C.useCallback(()=>{const O=Date.now();O-f.current<k||(f.current=O,s&&!S&&jn(s),n())},[s,S,n]),_=C.useCallback(O=>{O.button!==0&&O.pointerType==="mouse"||(b.current=Date.now(),u.current=!1,h.current=!0,v(!0),m.current=window.setTimeout(()=>{if(u.current=!0,h.current=!1,S&&!T&&(e(),s)){let q;t===Re?q=Pe:t===Pe?q=He:q=Re,jn(s,q===Pe?.3:1)}v(!1)},Pn))},[S,e,s,t,T]),L=C.useCallback(()=>{const O=u.current,q=h.current;if(m.current&&(clearTimeout(m.current),m.current=null),y.current=window.setTimeout(()=>{v(!1)},ea),O){u.current=!1;return}if(Date.now()-b.current<Pn&&q){const Q=Date.now();if(Q-x.current<Ln){x.current=0,g.current&&(clearTimeout(g.current),g.current=null),c&&c();return}x.current=Q,g.current&&clearTimeout(g.current),g.current=window.setTimeout(()=>{D(),g.current=null},Ln)}},[D,c]),d=C.useCallback(()=>{m.current&&(clearTimeout(m.current),m.current=null),y.current&&(clearTimeout(y.current),y.current=null),v(!1),u.current&&(u.current=!1),h.current=!1},[]);return o.jsx("button",{className:`grid-cell ${S?"active":""} ${w?"ghost":""} ${E?"grace":""} ${T?"thirty-second":""} ${I?"double-32":""} ${R?"first-32":""} ${A?"second-32":""} ${r?"current-beat":""} ${z?"alt-beat":""} ${p?"pressing":""}`,style:i,onPointerDown:_,onPointerUp:L,onPointerLeave:d,onPointerCancel:d,type:"button","aria-label":E?"Grace note":w?"Ghost note":S?"Active":"Inactive",children:T&&o.jsxs("div",{className:`cell-32-dots ${I?"double":R?"first":"second"}`,"aria-hidden":"true",children:[(I||R)&&o.jsx("span",{className:"dot left"}),(I||A)&&o.jsx("span",{className:"dot right"})]})})}function na(t,n,e,c,r){const s=t,a=s+n,i=Math.max(0,Math.floor(s/e)-c),f=Math.min(r,Math.ceil(a/e)+c);return{start:i,end:f}}function ra(t,n,e){const{itemSize:c,totalItems:r,bufferItems:s=0}=e,a=C.useRef(!1),[i,f]=C.useState(()=>({start:0,end:Math.min(r,Math.ceil(window.innerWidth/c)+s*2)})),k=C.useCallback(()=>{const y=t==null?void 0:t.current,h=n.current;if(!y||!h)return;a.current||(a.current=!0);const b=y.clientWidth;if(r*c<=b){f({start:0,end:r});return}const u=na(y.scrollLeft,b,c,s,r);f(m=>m.start===u.start&&m.end===u.end?m:u)},[t,n,c,s,r]),x=t==null?void 0:t.current;C.useLayoutEffect(()=>{if(!x)return;k();let y;const h=()=>{y&&cancelAnimationFrame(y),y=requestAnimationFrame(k)};return x.addEventListener("scroll",h,{passive:!0}),window.addEventListener("resize",k),()=>{y&&cancelAnimationFrame(y),x.removeEventListener("scroll",h),window.removeEventListener("resize",k)}},[x,k]);const g=C.useMemo(()=>new Set(Array.from({length:i.end-i.start},(y,h)=>i.start+h)),[i]);return{...i,visibleSet:g}}function sa({pattern:t,cellSize:n,onCellClick:e,onToggleGhost:c,onCellDoubleClick:r,currentBeat:s,scrollContainerRef:a}){var y;const i=C.useRef(null),f=((y=t.grid[0])==null?void 0:y.length)||0,k=f*n,x=me*2,{visibleSet:g}=ra(a,i,{itemSize:n,totalItems:f,bufferItems:x});return o.jsx("div",{className:"grid-container",children:o.jsx("div",{className:"grid-wrapper",children:o.jsx("div",{className:"grid-content",ref:i,style:{width:`${k}px`},children:o.jsx("div",{className:"grid-rows",children:t.grid.map((h,b)=>{const u=t.drums[b];return o.jsx("div",{className:"grid-row",style:{width:`${k}px`},children:h.map((m,p)=>{if(!g.has(p))return null;const v=s!==void 0&&p===s;return o.jsx(ta,{cellState:m,onClick:()=>e(b,p),onDoubleClick:()=>r(b,p),onToggleGhost:()=>c(b,p),isCurrentBeat:v,drumType:u,subdivisionIndex:p,style:{left:`${p*n}px`}},p)})},b)})})})})})}function oa({pattern:t,cellSize:n}){var s;const[e]=t.timeSignature,r=(((s=t.grid[0])==null?void 0:s.length)||0)*n;return o.jsx("div",{className:"grid-container",children:o.jsx("div",{className:"grid-wrapper",children:o.jsx("div",{className:"grid-content",style:{width:`${r}px`},children:o.jsx("div",{className:"grid-beat-labels",children:Array.from({length:t.bars},(a,i)=>{const f=e*me;return o.jsx("div",{className:"grid-beat-label-group",style:{width:`${f*n}px`},children:Array.from({length:e},(k,x)=>{const g=x*me;return o.jsxs("div",{className:"grid-beat-label",style:{width:`${me*n}px`,left:`${g*n}px`},children:[i+1,".",x+1]},x)})},i)})})})})})}function aa({bars:t,onAddBar:n,onRemoveBar:e,canRemove:c,currentBeat:r}){return o.jsx("div",{className:"bar-controls",children:o.jsxs("span",{className:"bar-count",children:[o.jsx("button",{className:"bar-control-button",onClick:()=>e(r),disabled:!c,"aria-label":"Remove bar",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),t,o.jsx("button",{className:"bar-control-button",onClick:()=>n(r),"aria-label":"Add bar",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})}function ia({currentPattern:t,savedPatterns:n,crossPatternLoop:e,onCrossPatternLoopChange:c,isDraftMode:r}){const s=C.useRef(t.bars),a=[...n].sort((D,_)=>D.name.localeCompare(_.name)),i=D=>{if(r&&D===""||!r&&D===t.name)return t.bars;const _=n.find(L=>L.name===D);return(_==null?void 0:_.bars)??t.bars},f=D=>D===""||D===t.name?!0:n.some(_=>_.name===D),k={startPatternName:r?"":t.name,startBar:0,endPatternName:r?"":t.name,endBar:t.bars-1};C.useEffect(()=>{if(!e)return;const D=r?"":t.name,_=(d,O)=>d===O?0:d===""?-1:O===""?1:d.localeCompare(O);(()=>{const{startPatternName:d,endPatternName:O}=e;return d===O?d===D:D===d||D===O?!0:_(d,D)<0&&_(D,O)<0})()||c({startPatternName:D,startBar:0,endPatternName:D,endBar:t.bars-1})},[r,t.name,e,c,t.bars]);const x=(D,_,L,d)=>D===L?_-d:D===""?-1:L===""?1:D.localeCompare(L),g=e??k;C.useEffect(()=>{if(!e||!f(e.startPatternName)||!f(e.endPatternName))return;const D=i(e.startPatternName),_=i(e.endPatternName);let L=!1;const d={...e};e.startBar>=D&&(d.startBar=Math.max(0,D-1),L=!0),e.endBar>=_&&(d.endBar=Math.max(0,_-1),L=!0);const O=r?e.endPatternName==="":e.endPatternName===t.name,q=e.startPatternName!==e.endPatternName;if(O&&!q){const U=t.bars-1,Q=s.current,V=t.bars>Q,X=d.endBar===Q-1;V&&X&&(d.endBar=U,L=!0)}L&&x(d.startPatternName,d.startBar,d.endPatternName,d.endBar)>0&&(d.endBar=d.startBar),L&&c(d),s.current=t.bars},[t.bars,r,t.name,n]);const y=r?[{name:"",label:"○"},...a.map(D=>({name:D.name,label:D.name}))]:a.map(D=>({name:D.name,label:D.name})),h=D=>{const _=i(D),L=Math.min(g.startBar,_-1);x(D,L,g.endPatternName,g.endBar)>0?c({startPatternName:D,startBar:L,endPatternName:D,endBar:L}):c({...g,startPatternName:D,startBar:L})},b=D=>{const _=i(D),L=Math.min(g.endBar,_-1);x(g.startPatternName,g.startBar,D,L)>0?c({startPatternName:D,startBar:L,endPatternName:D,endBar:L}):c({...g,endPatternName:D,endBar:L})},u=()=>{g.startBar>0&&c({...g,startBar:g.startBar-1})},m=()=>{const D=i(g.startPatternName)-1,_=Math.min(D,g.startBar+1);x(g.startPatternName,_,g.endPatternName,g.endBar)<=0&&c({...g,startBar:_})},p=()=>{const D=g.endBar-1;D>=0&&x(g.startPatternName,g.startBar,g.endPatternName,D)<=0&&c({...g,endBar:D})},v=()=>{const D=i(g.endPatternName)-1;g.endBar<D&&c({...g,endBar:g.endBar+1})},S=g.startBar>0,w=g.startBar<i(g.startPatternName)-1&&x(g.startPatternName,g.startBar+1,g.endPatternName,g.endBar)<=0,E=g.endBar>0&&x(g.startPatternName,g.startBar,g.endPatternName,g.endBar-1)<=0,I=g.endBar<i(g.endPatternName)-1,R=Ie(u,{shouldStop:()=>!S}),A=Ie(m,{shouldStop:()=>!w}),T=Ie(p,{shouldStop:()=>!E}),z=Ie(v,{shouldStop:()=>!I});return o.jsx("div",{className:"loop-range-selector",children:o.jsxs("div",{className:"loop-range-controls",children:[o.jsxs("div",{className:"loop-range-item",children:[o.jsx("select",{className:"loop-pattern-select",value:g.startPatternName,onChange:D=>h(D.target.value),children:y.map(D=>o.jsx("option",{value:D.name,children:D.label},D.name))}),o.jsx("button",{className:"loop-range-button",...R,disabled:!S,"aria-label":"Decrease start bar",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("span",{className:"loop-range-value",children:g.startBar+1}),o.jsx("button",{className:"loop-range-button",...A,disabled:!w,"aria-label":"Increase start bar",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),o.jsx("span",{className:"loop-range-separator",children:"-"}),o.jsxs("div",{className:"loop-range-item",children:[o.jsx("select",{className:"loop-pattern-select",value:g.endPatternName,onChange:D=>b(D.target.value),children:y.map(D=>o.jsx("option",{value:D.name,children:D.label},D.name))}),o.jsx("button",{className:"loop-range-button",...T,disabled:!E,"aria-label":"Decrease end bar",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("span",{className:"loop-range-value",children:g.endBar+1}),o.jsx("button",{className:"loop-range-button",...z,disabled:!I,"aria-label":"Increase end bar",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})})}function St(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Br={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,n){(function(e){t.exports=e()})(function(){return function e(c,r,s){function a(k,x){if(!r[k]){if(!c[k]){var g=typeof St=="function"&&St;if(!x&&g)return g(k,!0);if(i)return i(k,!0);var y=new Error("Cannot find module '"+k+"'");throw y.code="MODULE_NOT_FOUND",y}var h=r[k]={exports:{}};c[k][0].call(h.exports,function(b){var u=c[k][1][b];return a(u||b)},h,h.exports,e,c,r,s)}return r[k].exports}for(var i=typeof St=="function"&&St,f=0;f<s.length;f++)a(s[f]);return a}({1:[function(e,c,r){var s=e("./utils"),a=e("./support"),i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(f){for(var k,x,g,y,h,b,u,m=[],p=0,v=f.length,S=v,w=s.getTypeOf(f)!=="string";p<f.length;)S=v-p,g=w?(k=f[p++],x=p<v?f[p++]:0,p<v?f[p++]:0):(k=f.charCodeAt(p++),x=p<v?f.charCodeAt(p++):0,p<v?f.charCodeAt(p++):0),y=k>>2,h=(3&k)<<4|x>>4,b=1<S?(15&x)<<2|g>>6:64,u=2<S?63&g:64,m.push(i.charAt(y)+i.charAt(h)+i.charAt(b)+i.charAt(u));return m.join("")},r.decode=function(f){var k,x,g,y,h,b,u=0,m=0,p="data:";if(f.substr(0,p.length)===p)throw new Error("Invalid base64 input, it looks like a data url.");var v,S=3*(f=f.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(f.charAt(f.length-1)===i.charAt(64)&&S--,f.charAt(f.length-2)===i.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(v=a.uint8array?new Uint8Array(0|S):new Array(0|S);u<f.length;)k=i.indexOf(f.charAt(u++))<<2|(y=i.indexOf(f.charAt(u++)))>>4,x=(15&y)<<4|(h=i.indexOf(f.charAt(u++)))>>2,g=(3&h)<<6|(b=i.indexOf(f.charAt(u++))),v[m++]=k,h!==64&&(v[m++]=x),b!==64&&(v[m++]=g);return v}},{"./support":30,"./utils":32}],2:[function(e,c,r){var s=e("./external"),a=e("./stream/DataWorker"),i=e("./stream/Crc32Probe"),f=e("./stream/DataLengthProbe");function k(x,g,y,h,b){this.compressedSize=x,this.uncompressedSize=g,this.crc32=y,this.compression=h,this.compressedContent=b}k.prototype={getContentWorker:function(){var x=new a(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new f("data_length")),g=this;return x.on("end",function(){if(this.streamInfo.data_length!==g.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),x},getCompressedWorker:function(){return new a(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},k.createWorkerFrom=function(x,g,y){return x.pipe(new i).pipe(new f("uncompressedSize")).pipe(g.compressWorker(y)).pipe(new f("compressedSize")).withStreamInfo("compression",g)},c.exports=k},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,c,r){var s=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,c,r){var s=e("./utils"),a=function(){for(var i,f=[],k=0;k<256;k++){i=k;for(var x=0;x<8;x++)i=1&i?3988292384^i>>>1:i>>>1;f[k]=i}return f}();c.exports=function(i,f){return i!==void 0&&i.length?s.getTypeOf(i)!=="string"?function(k,x,g,y){var h=a,b=y+g;k^=-1;for(var u=y;u<b;u++)k=k>>>8^h[255&(k^x[u])];return-1^k}(0|f,i,i.length,0):function(k,x,g,y){var h=a,b=y+g;k^=-1;for(var u=y;u<b;u++)k=k>>>8^h[255&(k^x.charCodeAt(u))];return-1^k}(0|f,i,i.length,0):0}},{"./utils":32}],5:[function(e,c,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,c,r){var s=null;s=typeof Promise<"u"?Promise:e("lie"),c.exports={Promise:s}},{lie:37}],7:[function(e,c,r){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",a=e("pako"),i=e("./utils"),f=e("./stream/GenericWorker"),k=s?"uint8array":"array";function x(g,y){f.call(this,"FlateWorker/"+g),this._pako=null,this._pakoAction=g,this._pakoOptions=y,this.meta={}}r.magic="\b\0",i.inherits(x,f),x.prototype.processChunk=function(g){this.meta=g.meta,this._pako===null&&this._createPako(),this._pako.push(i.transformTo(k,g.data),!1)},x.prototype.flush=function(){f.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},x.prototype.cleanUp=function(){f.prototype.cleanUp.call(this),this._pako=null},x.prototype._createPako=function(){this._pako=new a[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var g=this;this._pako.onData=function(y){g.push({data:y,meta:g.meta})}},r.compressWorker=function(g){return new x("Deflate",g)},r.uncompressWorker=function(){return new x("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,c,r){function s(h,b){var u,m="";for(u=0;u<b;u++)m+=String.fromCharCode(255&h),h>>>=8;return m}function a(h,b,u,m,p,v){var S,w,E=h.file,I=h.compression,R=v!==k.utf8encode,A=i.transformTo("string",v(E.name)),T=i.transformTo("string",k.utf8encode(E.name)),z=E.comment,D=i.transformTo("string",v(z)),_=i.transformTo("string",k.utf8encode(z)),L=T.length!==E.name.length,d=_.length!==z.length,O="",q="",U="",Q=E.dir,V=E.date,X={crc32:0,compressedSize:0,uncompressedSize:0};b&&!u||(X.crc32=h.crc32,X.compressedSize=h.compressedSize,X.uncompressedSize=h.uncompressedSize);var P=0;b&&(P|=8),R||!L&&!d||(P|=2048);var N=0,Y=0;Q&&(N|=16),p==="UNIX"?(Y=798,N|=function(H,se){var K=H;return H||(K=se?16893:33204),(65535&K)<<16}(E.unixPermissions,Q)):(Y=20,N|=function(H){return 63&(H||0)}(E.dosPermissions)),S=V.getUTCHours(),S<<=6,S|=V.getUTCMinutes(),S<<=5,S|=V.getUTCSeconds()/2,w=V.getUTCFullYear()-1980,w<<=4,w|=V.getUTCMonth()+1,w<<=5,w|=V.getUTCDate(),L&&(q=s(1,1)+s(x(A),4)+T,O+="up"+s(q.length,2)+q),d&&(U=s(1,1)+s(x(D),4)+_,O+="uc"+s(U.length,2)+U);var Z="";return Z+=`
\0`,Z+=s(P,2),Z+=I.magic,Z+=s(S,2),Z+=s(w,2),Z+=s(X.crc32,4),Z+=s(X.compressedSize,4),Z+=s(X.uncompressedSize,4),Z+=s(A.length,2),Z+=s(O.length,2),{fileRecord:g.LOCAL_FILE_HEADER+Z+A+O,dirRecord:g.CENTRAL_FILE_HEADER+s(Y,2)+Z+s(D.length,2)+"\0\0\0\0"+s(N,4)+s(m,4)+A+O+D}}var i=e("../utils"),f=e("../stream/GenericWorker"),k=e("../utf8"),x=e("../crc32"),g=e("../signature");function y(h,b,u,m){f.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=b,this.zipPlatform=u,this.encodeFileName=m,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}i.inherits(y,f),y.prototype.push=function(h){var b=h.meta.percent||0,u=this.entriesCount,m=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,f.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:u?(b+100*(u-m-1))/u:100}}))},y.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var b=this.streamFiles&&!h.file.dir;if(b){var u=a(h,b,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:u.fileRecord,meta:{percent:0}})}else this.accumulate=!0},y.prototype.closedSource=function(h){this.accumulate=!1;var b=this.streamFiles&&!h.file.dir,u=a(h,b,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(u.dirRecord),b)this.push({data:function(m){return g.DATA_DESCRIPTOR+s(m.crc32,4)+s(m.compressedSize,4)+s(m.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:u.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},y.prototype.flush=function(){for(var h=this.bytesWritten,b=0;b<this.dirRecords.length;b++)this.push({data:this.dirRecords[b],meta:{percent:100}});var u=this.bytesWritten-h,m=function(p,v,S,w,E){var I=i.transformTo("string",E(w));return g.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(p,2)+s(p,2)+s(v,4)+s(S,4)+s(I.length,2)+I}(this.dirRecords.length,u,h,this.zipComment,this.encodeFileName);this.push({data:m,meta:{percent:100}})},y.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},y.prototype.registerPrevious=function(h){this._sources.push(h);var b=this;return h.on("data",function(u){b.processChunk(u)}),h.on("end",function(){b.closedSource(b.previous.streamInfo),b._sources.length?b.prepareNextSource():b.end()}),h.on("error",function(u){b.error(u)}),this},y.prototype.resume=function(){return!!f.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},y.prototype.error=function(h){var b=this._sources;if(!f.prototype.error.call(this,h))return!1;for(var u=0;u<b.length;u++)try{b[u].error(h)}catch{}return!0},y.prototype.lock=function(){f.prototype.lock.call(this);for(var h=this._sources,b=0;b<h.length;b++)h[b].lock()},c.exports=y},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,c,r){var s=e("../compressions"),a=e("./ZipFileWorker");r.generateWorker=function(i,f,k){var x=new a(f.streamFiles,k,f.platform,f.encodeFileName),g=0;try{i.forEach(function(y,h){g++;var b=function(v,S){var w=v||S,E=s[w];if(!E)throw new Error(w+" is not a valid compression method !");return E}(h.options.compression,f.compression),u=h.options.compressionOptions||f.compressionOptions||{},m=h.dir,p=h.date;h._compressWorker(b,u).withStreamInfo("file",{name:y,dir:m,date:p,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(x)}),x.entriesCount=g}catch(y){x.error(y)}return x}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,c,r){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var a=new s;for(var i in this)typeof this[i]!="function"&&(a[i]=this[i]);return a}}(s.prototype=e("./object")).loadAsync=e("./load"),s.support=e("./support"),s.defaults=e("./defaults"),s.version="3.10.1",s.loadAsync=function(a,i){return new s().loadAsync(a,i)},s.external=e("./external"),c.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,c,r){var s=e("./utils"),a=e("./external"),i=e("./utf8"),f=e("./zipEntries"),k=e("./stream/Crc32Probe"),x=e("./nodejsUtils");function g(y){return new a.Promise(function(h,b){var u=y.decompressed.getContentWorker().pipe(new k);u.on("error",function(m){b(m)}).on("end",function(){u.streamInfo.crc32!==y.decompressed.crc32?b(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}c.exports=function(y,h){var b=this;return h=s.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:i.utf8decode}),x.isNode&&x.isStream(y)?a.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",y,!0,h.optimizedBinaryString,h.base64).then(function(u){var m=new f(h);return m.load(u),m}).then(function(u){var m=[a.Promise.resolve(u)],p=u.files;if(h.checkCRC32)for(var v=0;v<p.length;v++)m.push(g(p[v]));return a.Promise.all(m)}).then(function(u){for(var m=u.shift(),p=m.files,v=0;v<p.length;v++){var S=p[v],w=S.fileNameStr,E=s.resolve(S.fileNameStr);b.file(E,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:h.createFolders}),S.dir||(b.file(E).unsafeOriginalName=w)}return m.zipComment.length&&(b.comment=m.zipComment),b})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,c,r){var s=e("../utils"),a=e("../stream/GenericWorker");function i(f,k){a.call(this,"Nodejs stream input adapter for "+f),this._upstreamEnded=!1,this._bindStream(k)}s.inherits(i,a),i.prototype._bindStream=function(f){var k=this;(this._stream=f).pause(),f.on("data",function(x){k.push({data:x,meta:{percent:0}})}).on("error",function(x){k.isPaused?this.generatedError=x:k.error(x)}).on("end",function(){k.isPaused?k._upstreamEnded=!0:k.end()})},i.prototype.pause=function(){return!!a.prototype.pause.call(this)&&(this._stream.pause(),!0)},i.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},c.exports=i},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,c,r){var s=e("readable-stream").Readable;function a(i,f,k){s.call(this,f),this._helper=i;var x=this;i.on("data",function(g,y){x.push(g)||x._helper.pause(),k&&k(y)}).on("error",function(g){x.emit("error",g)}).on("end",function(){x.push(null)})}e("../utils").inherits(a,s),a.prototype._read=function(){this._helper.resume()},c.exports=a},{"../utils":32,"readable-stream":16}],14:[function(e,c,r){c.exports={isNode:typeof Buffer<"u",newBufferFrom:function(s,a){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(s,a);if(typeof s=="number")throw new Error('The "data" argument must not be a number');return new Buffer(s,a)},allocBuffer:function(s){if(Buffer.alloc)return Buffer.alloc(s);var a=new Buffer(s);return a.fill(0),a},isBuffer:function(s){return Buffer.isBuffer(s)},isStream:function(s){return s&&typeof s.on=="function"&&typeof s.pause=="function"&&typeof s.resume=="function"}}},{}],15:[function(e,c,r){function s(E,I,R){var A,T=i.getTypeOf(I),z=i.extend(R||{},x);z.date=z.date||new Date,z.compression!==null&&(z.compression=z.compression.toUpperCase()),typeof z.unixPermissions=="string"&&(z.unixPermissions=parseInt(z.unixPermissions,8)),z.unixPermissions&&16384&z.unixPermissions&&(z.dir=!0),z.dosPermissions&&16&z.dosPermissions&&(z.dir=!0),z.dir&&(E=p(E)),z.createFolders&&(A=m(E))&&v.call(this,A,!0);var D=T==="string"&&z.binary===!1&&z.base64===!1;R&&R.binary!==void 0||(z.binary=!D),(I instanceof g&&I.uncompressedSize===0||z.dir||!I||I.length===0)&&(z.base64=!1,z.binary=!0,I="",z.compression="STORE",T="string");var _=null;_=I instanceof g||I instanceof f?I:b.isNode&&b.isStream(I)?new u(E,I):i.prepareContent(E,I,z.binary,z.optimizedBinaryString,z.base64);var L=new y(E,_,z);this.files[E]=L}var a=e("./utf8"),i=e("./utils"),f=e("./stream/GenericWorker"),k=e("./stream/StreamHelper"),x=e("./defaults"),g=e("./compressedObject"),y=e("./zipObject"),h=e("./generate"),b=e("./nodejsUtils"),u=e("./nodejs/NodejsStreamInputAdapter"),m=function(E){E.slice(-1)==="/"&&(E=E.substring(0,E.length-1));var I=E.lastIndexOf("/");return 0<I?E.substring(0,I):""},p=function(E){return E.slice(-1)!=="/"&&(E+="/"),E},v=function(E,I){return I=I!==void 0?I:x.createFolders,E=p(E),this.files[E]||s.call(this,E,null,{dir:!0,createFolders:I}),this.files[E]};function S(E){return Object.prototype.toString.call(E)==="[object RegExp]"}var w={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(E){var I,R,A;for(I in this.files)A=this.files[I],(R=I.slice(this.root.length,I.length))&&I.slice(0,this.root.length)===this.root&&E(R,A)},filter:function(E){var I=[];return this.forEach(function(R,A){E(R,A)&&I.push(A)}),I},file:function(E,I,R){if(arguments.length!==1)return E=this.root+E,s.call(this,E,I,R),this;if(S(E)){var A=E;return this.filter(function(z,D){return!D.dir&&A.test(z)})}var T=this.files[this.root+E];return T&&!T.dir?T:null},folder:function(E){if(!E)return this;if(S(E))return this.filter(function(T,z){return z.dir&&E.test(T)});var I=this.root+E,R=v.call(this,I),A=this.clone();return A.root=R.name,A},remove:function(E){E=this.root+E;var I=this.files[E];if(I||(E.slice(-1)!=="/"&&(E+="/"),I=this.files[E]),I&&!I.dir)delete this.files[E];else for(var R=this.filter(function(T,z){return z.name.slice(0,E.length)===E}),A=0;A<R.length;A++)delete this.files[R[A].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(E){var I,R={};try{if((R=i.extend(E||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:a.utf8encode})).type=R.type.toLowerCase(),R.compression=R.compression.toUpperCase(),R.type==="binarystring"&&(R.type="string"),!R.type)throw new Error("No output type specified.");i.checkSupport(R.type),R.platform!=="darwin"&&R.platform!=="freebsd"&&R.platform!=="linux"&&R.platform!=="sunos"||(R.platform="UNIX"),R.platform==="win32"&&(R.platform="DOS");var A=R.comment||this.comment||"";I=h.generateWorker(this,R,A)}catch(T){(I=new f("error")).error(T)}return new k(I,R.type||"string",R.mimeType)},generateAsync:function(E,I){return this.generateInternalStream(E).accumulate(I)},generateNodeStream:function(E,I){return(E=E||{}).type||(E.type="nodebuffer"),this.generateInternalStream(E).toNodejsStream(I)}};c.exports=w},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,c,r){c.exports=e("stream")},{stream:void 0}],17:[function(e,c,r){var s=e("./DataReader");function a(i){s.call(this,i);for(var f=0;f<this.data.length;f++)i[f]=255&i[f]}e("../utils").inherits(a,s),a.prototype.byteAt=function(i){return this.data[this.zero+i]},a.prototype.lastIndexOfSignature=function(i){for(var f=i.charCodeAt(0),k=i.charCodeAt(1),x=i.charCodeAt(2),g=i.charCodeAt(3),y=this.length-4;0<=y;--y)if(this.data[y]===f&&this.data[y+1]===k&&this.data[y+2]===x&&this.data[y+3]===g)return y-this.zero;return-1},a.prototype.readAndCheckSignature=function(i){var f=i.charCodeAt(0),k=i.charCodeAt(1),x=i.charCodeAt(2),g=i.charCodeAt(3),y=this.readData(4);return f===y[0]&&k===y[1]&&x===y[2]&&g===y[3]},a.prototype.readData=function(i){if(this.checkOffset(i),i===0)return[];var f=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,f},c.exports=a},{"../utils":32,"./DataReader":18}],18:[function(e,c,r){var s=e("../utils");function a(i){this.data=i,this.length=i.length,this.index=0,this.zero=0}a.prototype={checkOffset:function(i){this.checkIndex(this.index+i)},checkIndex:function(i){if(this.length<this.zero+i||i<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+i+"). Corrupted zip ?")},setIndex:function(i){this.checkIndex(i),this.index=i},skip:function(i){this.setIndex(this.index+i)},byteAt:function(){},readInt:function(i){var f,k=0;for(this.checkOffset(i),f=this.index+i-1;f>=this.index;f--)k=(k<<8)+this.byteAt(f);return this.index+=i,k},readString:function(i){return s.transformTo("string",this.readData(i))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var i=this.readInt(4);return new Date(Date.UTC(1980+(i>>25&127),(i>>21&15)-1,i>>16&31,i>>11&31,i>>5&63,(31&i)<<1))}},c.exports=a},{"../utils":32}],19:[function(e,c,r){var s=e("./Uint8ArrayReader");function a(i){s.call(this,i)}e("../utils").inherits(a,s),a.prototype.readData=function(i){this.checkOffset(i);var f=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,f},c.exports=a},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,c,r){var s=e("./DataReader");function a(i){s.call(this,i)}e("../utils").inherits(a,s),a.prototype.byteAt=function(i){return this.data.charCodeAt(this.zero+i)},a.prototype.lastIndexOfSignature=function(i){return this.data.lastIndexOf(i)-this.zero},a.prototype.readAndCheckSignature=function(i){return i===this.readData(4)},a.prototype.readData=function(i){this.checkOffset(i);var f=this.data.slice(this.zero+this.index,this.zero+this.index+i);return this.index+=i,f},c.exports=a},{"../utils":32,"./DataReader":18}],21:[function(e,c,r){var s=e("./ArrayReader");function a(i){s.call(this,i)}e("../utils").inherits(a,s),a.prototype.readData=function(i){if(this.checkOffset(i),i===0)return new Uint8Array(0);var f=this.data.subarray(this.zero+this.index,this.zero+this.index+i);return this.index+=i,f},c.exports=a},{"../utils":32,"./ArrayReader":17}],22:[function(e,c,r){var s=e("../utils"),a=e("../support"),i=e("./ArrayReader"),f=e("./StringReader"),k=e("./NodeBufferReader"),x=e("./Uint8ArrayReader");c.exports=function(g){var y=s.getTypeOf(g);return s.checkSupport(y),y!=="string"||a.uint8array?y==="nodebuffer"?new k(g):a.uint8array?new x(s.transformTo("uint8array",g)):new i(s.transformTo("array",g)):new f(g)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,c,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,c,r){var s=e("./GenericWorker"),a=e("../utils");function i(f){s.call(this,"ConvertWorker to "+f),this.destType=f}a.inherits(i,s),i.prototype.processChunk=function(f){this.push({data:a.transformTo(this.destType,f.data),meta:f.meta})},c.exports=i},{"../utils":32,"./GenericWorker":28}],25:[function(e,c,r){var s=e("./GenericWorker"),a=e("../crc32");function i(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(i,s),i.prototype.processChunk=function(f){this.streamInfo.crc32=a(f.data,this.streamInfo.crc32||0),this.push(f)},c.exports=i},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,c,r){var s=e("../utils"),a=e("./GenericWorker");function i(f){a.call(this,"DataLengthProbe for "+f),this.propName=f,this.withStreamInfo(f,0)}s.inherits(i,a),i.prototype.processChunk=function(f){if(f){var k=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=k+f.data.length}a.prototype.processChunk.call(this,f)},c.exports=i},{"../utils":32,"./GenericWorker":28}],27:[function(e,c,r){var s=e("../utils"),a=e("./GenericWorker");function i(f){a.call(this,"DataWorker");var k=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,f.then(function(x){k.dataIsReady=!0,k.data=x,k.max=x&&x.length||0,k.type=s.getTypeOf(x),k.isPaused||k._tickAndRepeat()},function(x){k.error(x)})}s.inherits(i,a),i.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this.data=null},i.prototype.resume=function(){return!!a.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},i.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},i.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var f=null,k=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":f=this.data.substring(this.index,k);break;case"uint8array":f=this.data.subarray(this.index,k);break;case"array":case"nodebuffer":f=this.data.slice(this.index,k)}return this.index=k,this.push({data:f,meta:{percent:this.max?this.index/this.max*100:0}})},c.exports=i},{"../utils":32,"./GenericWorker":28}],28:[function(e,c,r){function s(a){this.name=a||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(a){this.emit("data",a)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(a){this.emit("error",a)}return!0},error:function(a){return!this.isFinished&&(this.isPaused?this.generatedError=a:(this.isFinished=!0,this.emit("error",a),this.previous&&this.previous.error(a),this.cleanUp()),!0)},on:function(a,i){return this._listeners[a].push(i),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(a,i){if(this._listeners[a])for(var f=0;f<this._listeners[a].length;f++)this._listeners[a][f].call(this,i)},pipe:function(a){return a.registerPrevious(this)},registerPrevious:function(a){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=a.streamInfo,this.mergeStreamInfo(),this.previous=a;var i=this;return a.on("data",function(f){i.processChunk(f)}),a.on("end",function(){i.end()}),a.on("error",function(f){i.error(f)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var a=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),a=!0),this.previous&&this.previous.resume(),!a},flush:function(){},processChunk:function(a){this.push(a)},withStreamInfo:function(a,i){return this.extraStreamInfo[a]=i,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var a in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,a)&&(this.streamInfo[a]=this.extraStreamInfo[a])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var a="Worker "+this.name;return this.previous?this.previous+" -> "+a:a}},c.exports=s},{}],29:[function(e,c,r){var s=e("../utils"),a=e("./ConvertWorker"),i=e("./GenericWorker"),f=e("../base64"),k=e("../support"),x=e("../external"),g=null;if(k.nodestream)try{g=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function y(b,u){return new x.Promise(function(m,p){var v=[],S=b._internalType,w=b._outputType,E=b._mimeType;b.on("data",function(I,R){v.push(I),u&&u(R)}).on("error",function(I){v=[],p(I)}).on("end",function(){try{var I=function(R,A,T){switch(R){case"blob":return s.newBlob(s.transformTo("arraybuffer",A),T);case"base64":return f.encode(A);default:return s.transformTo(R,A)}}(w,function(R,A){var T,z=0,D=null,_=0;for(T=0;T<A.length;T++)_+=A[T].length;switch(R){case"string":return A.join("");case"array":return Array.prototype.concat.apply([],A);case"uint8array":for(D=new Uint8Array(_),T=0;T<A.length;T++)D.set(A[T],z),z+=A[T].length;return D;case"nodebuffer":return Buffer.concat(A);default:throw new Error("concat : unsupported type '"+R+"'")}}(S,v),E);m(I)}catch(R){p(R)}v=[]}).resume()})}function h(b,u,m){var p=u;switch(u){case"blob":case"arraybuffer":p="uint8array";break;case"base64":p="string"}try{this._internalType=p,this._outputType=u,this._mimeType=m,s.checkSupport(p),this._worker=b.pipe(new a(p)),b.lock()}catch(v){this._worker=new i("error"),this._worker.error(v)}}h.prototype={accumulate:function(b){return y(this,b)},on:function(b,u){var m=this;return b==="data"?this._worker.on(b,function(p){u.call(m,p.data,p.meta)}):this._worker.on(b,function(){s.delay(u,arguments,m)}),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(b){if(s.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new g(this,{objectMode:this._outputType!=="nodebuffer"},b)}},c.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,c,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var s=new ArrayBuffer(0);try{r.blob=new Blob([s],{type:"application/zip"}).size===0}catch{try{var a=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);a.append(s),r.blob=a.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,c,r){for(var s=e("./utils"),a=e("./support"),i=e("./nodejsUtils"),f=e("./stream/GenericWorker"),k=new Array(256),x=0;x<256;x++)k[x]=252<=x?6:248<=x?5:240<=x?4:224<=x?3:192<=x?2:1;k[254]=k[254]=1;function g(){f.call(this,"utf-8 decode"),this.leftOver=null}function y(){f.call(this,"utf-8 encode")}r.utf8encode=function(h){return a.nodebuffer?i.newBufferFrom(h,"utf-8"):function(b){var u,m,p,v,S,w=b.length,E=0;for(v=0;v<w;v++)(64512&(m=b.charCodeAt(v)))==55296&&v+1<w&&(64512&(p=b.charCodeAt(v+1)))==56320&&(m=65536+(m-55296<<10)+(p-56320),v++),E+=m<128?1:m<2048?2:m<65536?3:4;for(u=a.uint8array?new Uint8Array(E):new Array(E),v=S=0;S<E;v++)(64512&(m=b.charCodeAt(v)))==55296&&v+1<w&&(64512&(p=b.charCodeAt(v+1)))==56320&&(m=65536+(m-55296<<10)+(p-56320),v++),m<128?u[S++]=m:(m<2048?u[S++]=192|m>>>6:(m<65536?u[S++]=224|m>>>12:(u[S++]=240|m>>>18,u[S++]=128|m>>>12&63),u[S++]=128|m>>>6&63),u[S++]=128|63&m);return u}(h)},r.utf8decode=function(h){return a.nodebuffer?s.transformTo("nodebuffer",h).toString("utf-8"):function(b){var u,m,p,v,S=b.length,w=new Array(2*S);for(u=m=0;u<S;)if((p=b[u++])<128)w[m++]=p;else if(4<(v=k[p]))w[m++]=65533,u+=v-1;else{for(p&=v===2?31:v===3?15:7;1<v&&u<S;)p=p<<6|63&b[u++],v--;1<v?w[m++]=65533:p<65536?w[m++]=p:(p-=65536,w[m++]=55296|p>>10&1023,w[m++]=56320|1023&p)}return w.length!==m&&(w.subarray?w=w.subarray(0,m):w.length=m),s.applyFromCharCode(w)}(h=s.transformTo(a.uint8array?"uint8array":"array",h))},s.inherits(g,f),g.prototype.processChunk=function(h){var b=s.transformTo(a.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(a.uint8array){var u=b;(b=new Uint8Array(u.length+this.leftOver.length)).set(this.leftOver,0),b.set(u,this.leftOver.length)}else b=this.leftOver.concat(b);this.leftOver=null}var m=function(v,S){var w;for((S=S||v.length)>v.length&&(S=v.length),w=S-1;0<=w&&(192&v[w])==128;)w--;return w<0||w===0?S:w+k[v[w]]>S?w:S}(b),p=b;m!==b.length&&(a.uint8array?(p=b.subarray(0,m),this.leftOver=b.subarray(m,b.length)):(p=b.slice(0,m),this.leftOver=b.slice(m,b.length))),this.push({data:r.utf8decode(p),meta:h.meta})},g.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=g,s.inherits(y,f),y.prototype.processChunk=function(h){this.push({data:r.utf8encode(h.data),meta:h.meta})},r.Utf8EncodeWorker=y},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,c,r){var s=e("./support"),a=e("./base64"),i=e("./nodejsUtils"),f=e("./external");function k(u){return u}function x(u,m){for(var p=0;p<u.length;++p)m[p]=255&u.charCodeAt(p);return m}e("setimmediate"),r.newBlob=function(u,m){r.checkSupport("blob");try{return new Blob([u],{type:m})}catch{try{var p=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return p.append(u),p.getBlob(m)}catch{throw new Error("Bug : can't construct the Blob.")}}};var g={stringifyByChunk:function(u,m,p){var v=[],S=0,w=u.length;if(w<=p)return String.fromCharCode.apply(null,u);for(;S<w;)m==="array"||m==="nodebuffer"?v.push(String.fromCharCode.apply(null,u.slice(S,Math.min(S+p,w)))):v.push(String.fromCharCode.apply(null,u.subarray(S,Math.min(S+p,w)))),S+=p;return v.join("")},stringifyByChar:function(u){for(var m="",p=0;p<u.length;p++)m+=String.fromCharCode(u[p]);return m},applyCanBeUsed:{uint8array:function(){try{return s.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return s.nodebuffer&&String.fromCharCode.apply(null,i.allocBuffer(1)).length===1}catch{return!1}}()}};function y(u){var m=65536,p=r.getTypeOf(u),v=!0;if(p==="uint8array"?v=g.applyCanBeUsed.uint8array:p==="nodebuffer"&&(v=g.applyCanBeUsed.nodebuffer),v)for(;1<m;)try{return g.stringifyByChunk(u,p,m)}catch{m=Math.floor(m/2)}return g.stringifyByChar(u)}function h(u,m){for(var p=0;p<u.length;p++)m[p]=u[p];return m}r.applyFromCharCode=y;var b={};b.string={string:k,array:function(u){return x(u,new Array(u.length))},arraybuffer:function(u){return b.string.uint8array(u).buffer},uint8array:function(u){return x(u,new Uint8Array(u.length))},nodebuffer:function(u){return x(u,i.allocBuffer(u.length))}},b.array={string:y,array:k,arraybuffer:function(u){return new Uint8Array(u).buffer},uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return i.newBufferFrom(u)}},b.arraybuffer={string:function(u){return y(new Uint8Array(u))},array:function(u){return h(new Uint8Array(u),new Array(u.byteLength))},arraybuffer:k,uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return i.newBufferFrom(new Uint8Array(u))}},b.uint8array={string:y,array:function(u){return h(u,new Array(u.length))},arraybuffer:function(u){return u.buffer},uint8array:k,nodebuffer:function(u){return i.newBufferFrom(u)}},b.nodebuffer={string:y,array:function(u){return h(u,new Array(u.length))},arraybuffer:function(u){return b.nodebuffer.uint8array(u).buffer},uint8array:function(u){return h(u,new Uint8Array(u.length))},nodebuffer:k},r.transformTo=function(u,m){if(m=m||"",!u)return m;r.checkSupport(u);var p=r.getTypeOf(m);return b[p][u](m)},r.resolve=function(u){for(var m=u.split("/"),p=[],v=0;v<m.length;v++){var S=m[v];S==="."||S===""&&v!==0&&v!==m.length-1||(S===".."?p.pop():p.push(S))}return p.join("/")},r.getTypeOf=function(u){return typeof u=="string"?"string":Object.prototype.toString.call(u)==="[object Array]"?"array":s.nodebuffer&&i.isBuffer(u)?"nodebuffer":s.uint8array&&u instanceof Uint8Array?"uint8array":s.arraybuffer&&u instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(u){if(!s[u.toLowerCase()])throw new Error(u+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(u){var m,p,v="";for(p=0;p<(u||"").length;p++)v+="\\x"+((m=u.charCodeAt(p))<16?"0":"")+m.toString(16).toUpperCase();return v},r.delay=function(u,m,p){setImmediate(function(){u.apply(p||null,m||[])})},r.inherits=function(u,m){function p(){}p.prototype=m.prototype,u.prototype=new p},r.extend=function(){var u,m,p={};for(u=0;u<arguments.length;u++)for(m in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],m)&&p[m]===void 0&&(p[m]=arguments[u][m]);return p},r.prepareContent=function(u,m,p,v,S){return f.Promise.resolve(m).then(function(w){return s.blob&&(w instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(w))!==-1)&&typeof FileReader<"u"?new f.Promise(function(E,I){var R=new FileReader;R.onload=function(A){E(A.target.result)},R.onerror=function(A){I(A.target.error)},R.readAsArrayBuffer(w)}):w}).then(function(w){var E=r.getTypeOf(w);return E?(E==="arraybuffer"?w=r.transformTo("uint8array",w):E==="string"&&(S?w=a.decode(w):p&&v!==!0&&(w=function(I){return x(I,s.uint8array?new Uint8Array(I.length):new Array(I.length))}(w))),w):f.Promise.reject(new Error("Can't read the data of '"+u+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,c,r){var s=e("./reader/readerFor"),a=e("./utils"),i=e("./signature"),f=e("./zipEntry"),k=e("./support");function x(g){this.files=[],this.loadOptions=g}x.prototype={checkSignature:function(g){if(!this.reader.readAndCheckSignature(g)){this.reader.index-=4;var y=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+a.pretty(y)+", expected "+a.pretty(g)+")")}},isSignature:function(g,y){var h=this.reader.index;this.reader.setIndex(g);var b=this.reader.readString(4)===y;return this.reader.setIndex(h),b},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var g=this.reader.readData(this.zipCommentLength),y=k.uint8array?"uint8array":"array",h=a.transformTo(y,g);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var g,y,h,b=this.zip64EndOfCentralSize-44;0<b;)g=this.reader.readInt(2),y=this.reader.readInt(4),h=this.reader.readData(y),this.zip64ExtensibleData[g]={id:g,length:y,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var g,y;for(g=0;g<this.files.length;g++)y=this.files[g],this.reader.setIndex(y.localHeaderOffset),this.checkSignature(i.LOCAL_FILE_HEADER),y.readLocalPart(this.reader),y.handleUTF8(),y.processAttributes()},readCentralDir:function(){var g;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(i.CENTRAL_FILE_HEADER);)(g=new f({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(g);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var g=this.reader.lastIndexOfSignature(i.CENTRAL_DIRECTORY_END);if(g<0)throw this.isSignature(0,i.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(g);var y=g;if(this.checkSignature(i.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===a.MAX_VALUE_16BITS||this.diskWithCentralDirStart===a.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===a.MAX_VALUE_16BITS||this.centralDirRecords===a.MAX_VALUE_16BITS||this.centralDirSize===a.MAX_VALUE_32BITS||this.centralDirOffset===a.MAX_VALUE_32BITS){if(this.zip64=!0,(g=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(g),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,i.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(i.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var b=y-h;if(0<b)this.isSignature(y,i.CENTRAL_FILE_HEADER)||(this.reader.zero=b);else if(b<0)throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")},prepareReader:function(g){this.reader=s(g)},load:function(g){this.prepareReader(g),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},c.exports=x},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,c,r){var s=e("./reader/readerFor"),a=e("./utils"),i=e("./compressedObject"),f=e("./crc32"),k=e("./utf8"),x=e("./compressions"),g=e("./support");function y(h,b){this.options=h,this.loadOptions=b}y.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var b,u;if(h.skip(22),this.fileNameLength=h.readInt(2),u=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(u),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((b=function(m){for(var p in x)if(Object.prototype.hasOwnProperty.call(x,p)&&x[p].magic===m)return x[p];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+a.pretty(this.compressionMethod)+" unknown (inner file : "+a.transformTo("string",this.fileName)+")");this.decompressed=new i(this.compressedSize,this.uncompressedSize,this.crc32,b,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var b=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(b),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=s(this.extraFields[1].value);this.uncompressedSize===a.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===a.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===a.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===a.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var b,u,m,p=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<p;)b=h.readInt(2),u=h.readInt(2),m=h.readData(u),this.extraFields[b]={id:b,length:u,value:m};h.setIndex(p)},handleUTF8:function(){var h=g.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=k.utf8decode(this.fileName),this.fileCommentStr=k.utf8decode(this.fileComment);else{var b=this.findExtraFieldUnicodePath();if(b!==null)this.fileNameStr=b;else{var u=a.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(u)}var m=this.findExtraFieldUnicodeComment();if(m!==null)this.fileCommentStr=m;else{var p=a.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(p)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var b=s(h.value);return b.readInt(1)!==1||f(this.fileName)!==b.readInt(4)?null:k.utf8decode(b.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var b=s(h.value);return b.readInt(1)!==1||f(this.fileComment)!==b.readInt(4)?null:k.utf8decode(b.readData(h.length-5))}return null}},c.exports=y},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,c,r){function s(b,u,m){this.name=b,this.dir=m.dir,this.date=m.date,this.comment=m.comment,this.unixPermissions=m.unixPermissions,this.dosPermissions=m.dosPermissions,this._data=u,this._dataBinary=m.binary,this.options={compression:m.compression,compressionOptions:m.compressionOptions}}var a=e("./stream/StreamHelper"),i=e("./stream/DataWorker"),f=e("./utf8"),k=e("./compressedObject"),x=e("./stream/GenericWorker");s.prototype={internalStream:function(b){var u=null,m="string";try{if(!b)throw new Error("No output type specified.");var p=(m=b.toLowerCase())==="string"||m==="text";m!=="binarystring"&&m!=="text"||(m="string"),u=this._decompressWorker();var v=!this._dataBinary;v&&!p&&(u=u.pipe(new f.Utf8EncodeWorker)),!v&&p&&(u=u.pipe(new f.Utf8DecodeWorker))}catch(S){(u=new x("error")).error(S)}return new a(u,m,"")},async:function(b,u){return this.internalStream(b).accumulate(u)},nodeStream:function(b,u){return this.internalStream(b||"nodebuffer").toNodejsStream(u)},_compressWorker:function(b,u){if(this._data instanceof k&&this._data.compression.magic===b.magic)return this._data.getCompressedWorker();var m=this._decompressWorker();return this._dataBinary||(m=m.pipe(new f.Utf8EncodeWorker)),k.createWorkerFrom(m,b,u)},_decompressWorker:function(){return this._data instanceof k?this._data.getContentWorker():this._data instanceof x?this._data:new i(this._data)}};for(var g=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],y=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<g.length;h++)s.prototype[g[h]]=y;c.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,c,r){(function(s){var a,i,f=s.MutationObserver||s.WebKitMutationObserver;if(f){var k=0,x=new f(b),g=s.document.createTextNode("");x.observe(g,{characterData:!0}),a=function(){g.data=k=++k%2}}else if(s.setImmediate||s.MessageChannel===void 0)a="document"in s&&"onreadystatechange"in s.document.createElement("script")?function(){var u=s.document.createElement("script");u.onreadystatechange=function(){b(),u.onreadystatechange=null,u.parentNode.removeChild(u),u=null},s.document.documentElement.appendChild(u)}:function(){setTimeout(b,0)};else{var y=new s.MessageChannel;y.port1.onmessage=b,a=function(){y.port2.postMessage(0)}}var h=[];function b(){var u,m;i=!0;for(var p=h.length;p;){for(m=h,h=[],u=-1;++u<p;)m[u]();p=h.length}i=!1}c.exports=function(u){h.push(u)!==1||i||a()}}).call(this,typeof wt<"u"?wt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,c,r){var s=e("immediate");function a(){}var i={},f=["REJECTED"],k=["FULFILLED"],x=["PENDING"];function g(p){if(typeof p!="function")throw new TypeError("resolver must be a function");this.state=x,this.queue=[],this.outcome=void 0,p!==a&&u(this,p)}function y(p,v,S){this.promise=p,typeof v=="function"&&(this.onFulfilled=v,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function h(p,v,S){s(function(){var w;try{w=v(S)}catch(E){return i.reject(p,E)}w===p?i.reject(p,new TypeError("Cannot resolve promise with itself")):i.resolve(p,w)})}function b(p){var v=p&&p.then;if(p&&(typeof p=="object"||typeof p=="function")&&typeof v=="function")return function(){v.apply(p,arguments)}}function u(p,v){var S=!1;function w(R){S||(S=!0,i.reject(p,R))}function E(R){S||(S=!0,i.resolve(p,R))}var I=m(function(){v(E,w)});I.status==="error"&&w(I.value)}function m(p,v){var S={};try{S.value=p(v),S.status="success"}catch(w){S.status="error",S.value=w}return S}(c.exports=g).prototype.finally=function(p){if(typeof p!="function")return this;var v=this.constructor;return this.then(function(S){return v.resolve(p()).then(function(){return S})},function(S){return v.resolve(p()).then(function(){throw S})})},g.prototype.catch=function(p){return this.then(null,p)},g.prototype.then=function(p,v){if(typeof p!="function"&&this.state===k||typeof v!="function"&&this.state===f)return this;var S=new this.constructor(a);return this.state!==x?h(S,this.state===k?p:v,this.outcome):this.queue.push(new y(S,p,v)),S},y.prototype.callFulfilled=function(p){i.resolve(this.promise,p)},y.prototype.otherCallFulfilled=function(p){h(this.promise,this.onFulfilled,p)},y.prototype.callRejected=function(p){i.reject(this.promise,p)},y.prototype.otherCallRejected=function(p){h(this.promise,this.onRejected,p)},i.resolve=function(p,v){var S=m(b,v);if(S.status==="error")return i.reject(p,S.value);var w=S.value;if(w)u(p,w);else{p.state=k,p.outcome=v;for(var E=-1,I=p.queue.length;++E<I;)p.queue[E].callFulfilled(v)}return p},i.reject=function(p,v){p.state=f,p.outcome=v;for(var S=-1,w=p.queue.length;++S<w;)p.queue[S].callRejected(v);return p},g.resolve=function(p){return p instanceof this?p:i.resolve(new this(a),p)},g.reject=function(p){var v=new this(a);return i.reject(v,p)},g.all=function(p){var v=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=p.length,w=!1;if(!S)return this.resolve([]);for(var E=new Array(S),I=0,R=-1,A=new this(a);++R<S;)T(p[R],R);return A;function T(z,D){v.resolve(z).then(function(_){E[D]=_,++I!==S||w||(w=!0,i.resolve(A,E))},function(_){w||(w=!0,i.reject(A,_))})}},g.race=function(p){var v=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=p.length,w=!1;if(!S)return this.resolve([]);for(var E=-1,I=new this(a);++E<S;)R=p[E],v.resolve(R).then(function(A){w||(w=!0,i.resolve(I,A))},function(A){w||(w=!0,i.reject(I,A))});var R;return I}},{immediate:36}],38:[function(e,c,r){var s={};(0,e("./lib/utils/common").assign)(s,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),c.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,c,r){var s=e("./zlib/deflate"),a=e("./utils/common"),i=e("./utils/strings"),f=e("./zlib/messages"),k=e("./zlib/zstream"),x=Object.prototype.toString,g=0,y=-1,h=0,b=8;function u(p){if(!(this instanceof u))return new u(p);this.options=a.assign({level:y,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},p||{});var v=this.options;v.raw&&0<v.windowBits?v.windowBits=-v.windowBits:v.gzip&&0<v.windowBits&&v.windowBits<16&&(v.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new k,this.strm.avail_out=0;var S=s.deflateInit2(this.strm,v.level,v.method,v.windowBits,v.memLevel,v.strategy);if(S!==g)throw new Error(f[S]);if(v.header&&s.deflateSetHeader(this.strm,v.header),v.dictionary){var w;if(w=typeof v.dictionary=="string"?i.string2buf(v.dictionary):x.call(v.dictionary)==="[object ArrayBuffer]"?new Uint8Array(v.dictionary):v.dictionary,(S=s.deflateSetDictionary(this.strm,w))!==g)throw new Error(f[S]);this._dict_set=!0}}function m(p,v){var S=new u(v);if(S.push(p,!0),S.err)throw S.msg||f[S.err];return S.result}u.prototype.push=function(p,v){var S,w,E=this.strm,I=this.options.chunkSize;if(this.ended)return!1;w=v===~~v?v:v===!0?4:0,typeof p=="string"?E.input=i.string2buf(p):x.call(p)==="[object ArrayBuffer]"?E.input=new Uint8Array(p):E.input=p,E.next_in=0,E.avail_in=E.input.length;do{if(E.avail_out===0&&(E.output=new a.Buf8(I),E.next_out=0,E.avail_out=I),(S=s.deflate(E,w))!==1&&S!==g)return this.onEnd(S),!(this.ended=!0);E.avail_out!==0&&(E.avail_in!==0||w!==4&&w!==2)||(this.options.to==="string"?this.onData(i.buf2binstring(a.shrinkBuf(E.output,E.next_out))):this.onData(a.shrinkBuf(E.output,E.next_out)))}while((0<E.avail_in||E.avail_out===0)&&S!==1);return w===4?(S=s.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===g):w!==2||(this.onEnd(g),!(E.avail_out=0))},u.prototype.onData=function(p){this.chunks.push(p)},u.prototype.onEnd=function(p){p===g&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg},r.Deflate=u,r.deflate=m,r.deflateRaw=function(p,v){return(v=v||{}).raw=!0,m(p,v)},r.gzip=function(p,v){return(v=v||{}).gzip=!0,m(p,v)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,c,r){var s=e("./zlib/inflate"),a=e("./utils/common"),i=e("./utils/strings"),f=e("./zlib/constants"),k=e("./zlib/messages"),x=e("./zlib/zstream"),g=e("./zlib/gzheader"),y=Object.prototype.toString;function h(u){if(!(this instanceof h))return new h(u);this.options=a.assign({chunkSize:16384,windowBits:0,to:""},u||{});var m=this.options;m.raw&&0<=m.windowBits&&m.windowBits<16&&(m.windowBits=-m.windowBits,m.windowBits===0&&(m.windowBits=-15)),!(0<=m.windowBits&&m.windowBits<16)||u&&u.windowBits||(m.windowBits+=32),15<m.windowBits&&m.windowBits<48&&!(15&m.windowBits)&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new x,this.strm.avail_out=0;var p=s.inflateInit2(this.strm,m.windowBits);if(p!==f.Z_OK)throw new Error(k[p]);this.header=new g,s.inflateGetHeader(this.strm,this.header)}function b(u,m){var p=new h(m);if(p.push(u,!0),p.err)throw p.msg||k[p.err];return p.result}h.prototype.push=function(u,m){var p,v,S,w,E,I,R=this.strm,A=this.options.chunkSize,T=this.options.dictionary,z=!1;if(this.ended)return!1;v=m===~~m?m:m===!0?f.Z_FINISH:f.Z_NO_FLUSH,typeof u=="string"?R.input=i.binstring2buf(u):y.call(u)==="[object ArrayBuffer]"?R.input=new Uint8Array(u):R.input=u,R.next_in=0,R.avail_in=R.input.length;do{if(R.avail_out===0&&(R.output=new a.Buf8(A),R.next_out=0,R.avail_out=A),(p=s.inflate(R,f.Z_NO_FLUSH))===f.Z_NEED_DICT&&T&&(I=typeof T=="string"?i.string2buf(T):y.call(T)==="[object ArrayBuffer]"?new Uint8Array(T):T,p=s.inflateSetDictionary(this.strm,I)),p===f.Z_BUF_ERROR&&z===!0&&(p=f.Z_OK,z=!1),p!==f.Z_STREAM_END&&p!==f.Z_OK)return this.onEnd(p),!(this.ended=!0);R.next_out&&(R.avail_out!==0&&p!==f.Z_STREAM_END&&(R.avail_in!==0||v!==f.Z_FINISH&&v!==f.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=i.utf8border(R.output,R.next_out),w=R.next_out-S,E=i.buf2string(R.output,S),R.next_out=w,R.avail_out=A-w,w&&a.arraySet(R.output,R.output,S,w,0),this.onData(E)):this.onData(a.shrinkBuf(R.output,R.next_out)))),R.avail_in===0&&R.avail_out===0&&(z=!0)}while((0<R.avail_in||R.avail_out===0)&&p!==f.Z_STREAM_END);return p===f.Z_STREAM_END&&(v=f.Z_FINISH),v===f.Z_FINISH?(p=s.inflateEnd(this.strm),this.onEnd(p),this.ended=!0,p===f.Z_OK):v!==f.Z_SYNC_FLUSH||(this.onEnd(f.Z_OK),!(R.avail_out=0))},h.prototype.onData=function(u){this.chunks.push(u)},h.prototype.onEnd=function(u){u===f.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=a.flattenChunks(this.chunks)),this.chunks=[],this.err=u,this.msg=this.strm.msg},r.Inflate=h,r.inflate=b,r.inflateRaw=function(u,m){return(m=m||{}).raw=!0,b(u,m)},r.ungzip=b},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,c,r){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(f){for(var k=Array.prototype.slice.call(arguments,1);k.length;){var x=k.shift();if(x){if(typeof x!="object")throw new TypeError(x+"must be non-object");for(var g in x)x.hasOwnProperty(g)&&(f[g]=x[g])}}return f},r.shrinkBuf=function(f,k){return f.length===k?f:f.subarray?f.subarray(0,k):(f.length=k,f)};var a={arraySet:function(f,k,x,g,y){if(k.subarray&&f.subarray)f.set(k.subarray(x,x+g),y);else for(var h=0;h<g;h++)f[y+h]=k[x+h]},flattenChunks:function(f){var k,x,g,y,h,b;for(k=g=0,x=f.length;k<x;k++)g+=f[k].length;for(b=new Uint8Array(g),k=y=0,x=f.length;k<x;k++)h=f[k],b.set(h,y),y+=h.length;return b}},i={arraySet:function(f,k,x,g,y){for(var h=0;h<g;h++)f[y+h]=k[x+h]},flattenChunks:function(f){return[].concat.apply([],f)}};r.setTyped=function(f){f?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,a)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,i))},r.setTyped(s)},{}],42:[function(e,c,r){var s=e("./common"),a=!0,i=!0;try{String.fromCharCode.apply(null,[0])}catch{a=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{i=!1}for(var f=new s.Buf8(256),k=0;k<256;k++)f[k]=252<=k?6:248<=k?5:240<=k?4:224<=k?3:192<=k?2:1;function x(g,y){if(y<65537&&(g.subarray&&i||!g.subarray&&a))return String.fromCharCode.apply(null,s.shrinkBuf(g,y));for(var h="",b=0;b<y;b++)h+=String.fromCharCode(g[b]);return h}f[254]=f[254]=1,r.string2buf=function(g){var y,h,b,u,m,p=g.length,v=0;for(u=0;u<p;u++)(64512&(h=g.charCodeAt(u)))==55296&&u+1<p&&(64512&(b=g.charCodeAt(u+1)))==56320&&(h=65536+(h-55296<<10)+(b-56320),u++),v+=h<128?1:h<2048?2:h<65536?3:4;for(y=new s.Buf8(v),u=m=0;m<v;u++)(64512&(h=g.charCodeAt(u)))==55296&&u+1<p&&(64512&(b=g.charCodeAt(u+1)))==56320&&(h=65536+(h-55296<<10)+(b-56320),u++),h<128?y[m++]=h:(h<2048?y[m++]=192|h>>>6:(h<65536?y[m++]=224|h>>>12:(y[m++]=240|h>>>18,y[m++]=128|h>>>12&63),y[m++]=128|h>>>6&63),y[m++]=128|63&h);return y},r.buf2binstring=function(g){return x(g,g.length)},r.binstring2buf=function(g){for(var y=new s.Buf8(g.length),h=0,b=y.length;h<b;h++)y[h]=g.charCodeAt(h);return y},r.buf2string=function(g,y){var h,b,u,m,p=y||g.length,v=new Array(2*p);for(h=b=0;h<p;)if((u=g[h++])<128)v[b++]=u;else if(4<(m=f[u]))v[b++]=65533,h+=m-1;else{for(u&=m===2?31:m===3?15:7;1<m&&h<p;)u=u<<6|63&g[h++],m--;1<m?v[b++]=65533:u<65536?v[b++]=u:(u-=65536,v[b++]=55296|u>>10&1023,v[b++]=56320|1023&u)}return x(v,b)},r.utf8border=function(g,y){var h;for((y=y||g.length)>g.length&&(y=g.length),h=y-1;0<=h&&(192&g[h])==128;)h--;return h<0||h===0?y:h+f[g[h]]>y?h:y}},{"./common":41}],43:[function(e,c,r){c.exports=function(s,a,i,f){for(var k=65535&s|0,x=s>>>16&65535|0,g=0;i!==0;){for(i-=g=2e3<i?2e3:i;x=x+(k=k+a[f++]|0)|0,--g;);k%=65521,x%=65521}return k|x<<16|0}},{}],44:[function(e,c,r){c.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,c,r){var s=function(){for(var a,i=[],f=0;f<256;f++){a=f;for(var k=0;k<8;k++)a=1&a?3988292384^a>>>1:a>>>1;i[f]=a}return i}();c.exports=function(a,i,f,k){var x=s,g=k+f;a^=-1;for(var y=k;y<g;y++)a=a>>>8^x[255&(a^i[y])];return-1^a}},{}],46:[function(e,c,r){var s,a=e("../utils/common"),i=e("./trees"),f=e("./adler32"),k=e("./crc32"),x=e("./messages"),g=0,y=4,h=0,b=-2,u=-1,m=4,p=2,v=8,S=9,w=286,E=30,I=19,R=2*w+1,A=15,T=3,z=258,D=z+T+1,_=42,L=113,d=1,O=2,q=3,U=4;function Q(l,$){return l.msg=x[$],$}function V(l){return(l<<1)-(4<l?9:0)}function X(l){for(var $=l.length;0<=--$;)l[$]=0}function P(l){var $=l.state,W=$.pending;W>l.avail_out&&(W=l.avail_out),W!==0&&(a.arraySet(l.output,$.pending_buf,$.pending_out,W,l.next_out),l.next_out+=W,$.pending_out+=W,l.total_out+=W,l.avail_out-=W,$.pending-=W,$.pending===0&&($.pending_out=0))}function N(l,$){i._tr_flush_block(l,0<=l.block_start?l.block_start:-1,l.strstart-l.block_start,$),l.block_start=l.strstart,P(l.strm)}function Y(l,$){l.pending_buf[l.pending++]=$}function Z(l,$){l.pending_buf[l.pending++]=$>>>8&255,l.pending_buf[l.pending++]=255&$}function H(l,$){var W,j,B=l.max_chain_length,M=l.strstart,G=l.prev_length,J=l.nice_match,F=l.strstart>l.w_size-D?l.strstart-(l.w_size-D):0,ee=l.window,oe=l.w_mask,te=l.prev,ie=l.strstart+z,he=ee[M+G-1],fe=ee[M+G];l.prev_length>=l.good_match&&(B>>=2),J>l.lookahead&&(J=l.lookahead);do if(ee[(W=$)+G]===fe&&ee[W+G-1]===he&&ee[W]===ee[M]&&ee[++W]===ee[M+1]){M+=2,W++;do;while(ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&ee[++M]===ee[++W]&&M<ie);if(j=z-(ie-M),M=ie-z,G<j){if(l.match_start=$,J<=(G=j))break;he=ee[M+G-1],fe=ee[M+G]}}while(($=te[$&oe])>F&&--B!=0);return G<=l.lookahead?G:l.lookahead}function se(l){var $,W,j,B,M,G,J,F,ee,oe,te=l.w_size;do{if(B=l.window_size-l.lookahead-l.strstart,l.strstart>=te+(te-D)){for(a.arraySet(l.window,l.window,te,te,0),l.match_start-=te,l.strstart-=te,l.block_start-=te,$=W=l.hash_size;j=l.head[--$],l.head[$]=te<=j?j-te:0,--W;);for($=W=te;j=l.prev[--$],l.prev[$]=te<=j?j-te:0,--W;);B+=te}if(l.strm.avail_in===0)break;if(G=l.strm,J=l.window,F=l.strstart+l.lookahead,ee=B,oe=void 0,oe=G.avail_in,ee<oe&&(oe=ee),W=oe===0?0:(G.avail_in-=oe,a.arraySet(J,G.input,G.next_in,oe,F),G.state.wrap===1?G.adler=f(G.adler,J,oe,F):G.state.wrap===2&&(G.adler=k(G.adler,J,oe,F)),G.next_in+=oe,G.total_in+=oe,oe),l.lookahead+=W,l.lookahead+l.insert>=T)for(M=l.strstart-l.insert,l.ins_h=l.window[M],l.ins_h=(l.ins_h<<l.hash_shift^l.window[M+1])&l.hash_mask;l.insert&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[M+T-1])&l.hash_mask,l.prev[M&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=M,M++,l.insert--,!(l.lookahead+l.insert<T)););}while(l.lookahead<D&&l.strm.avail_in!==0)}function K(l,$){for(var W,j;;){if(l.lookahead<D){if(se(l),l.lookahead<D&&$===g)return d;if(l.lookahead===0)break}if(W=0,l.lookahead>=T&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+T-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),W!==0&&l.strstart-W<=l.w_size-D&&(l.match_length=H(l,W)),l.match_length>=T)if(j=i._tr_tally(l,l.strstart-l.match_start,l.match_length-T),l.lookahead-=l.match_length,l.match_length<=l.max_lazy_match&&l.lookahead>=T){for(l.match_length--;l.strstart++,l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+T-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart,--l.match_length!=0;);l.strstart++}else l.strstart+=l.match_length,l.match_length=0,l.ins_h=l.window[l.strstart],l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+1])&l.hash_mask;else j=i._tr_tally(l,0,l.window[l.strstart]),l.lookahead--,l.strstart++;if(j&&(N(l,!1),l.strm.avail_out===0))return d}return l.insert=l.strstart<T-1?l.strstart:T-1,$===y?(N(l,!0),l.strm.avail_out===0?q:U):l.last_lit&&(N(l,!1),l.strm.avail_out===0)?d:O}function re(l,$){for(var W,j,B;;){if(l.lookahead<D){if(se(l),l.lookahead<D&&$===g)return d;if(l.lookahead===0)break}if(W=0,l.lookahead>=T&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+T-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),l.prev_length=l.match_length,l.prev_match=l.match_start,l.match_length=T-1,W!==0&&l.prev_length<l.max_lazy_match&&l.strstart-W<=l.w_size-D&&(l.match_length=H(l,W),l.match_length<=5&&(l.strategy===1||l.match_length===T&&4096<l.strstart-l.match_start)&&(l.match_length=T-1)),l.prev_length>=T&&l.match_length<=l.prev_length){for(B=l.strstart+l.lookahead-T,j=i._tr_tally(l,l.strstart-1-l.prev_match,l.prev_length-T),l.lookahead-=l.prev_length-1,l.prev_length-=2;++l.strstart<=B&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+T-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),--l.prev_length!=0;);if(l.match_available=0,l.match_length=T-1,l.strstart++,j&&(N(l,!1),l.strm.avail_out===0))return d}else if(l.match_available){if((j=i._tr_tally(l,0,l.window[l.strstart-1]))&&N(l,!1),l.strstart++,l.lookahead--,l.strm.avail_out===0)return d}else l.match_available=1,l.strstart++,l.lookahead--}return l.match_available&&(j=i._tr_tally(l,0,l.window[l.strstart-1]),l.match_available=0),l.insert=l.strstart<T-1?l.strstart:T-1,$===y?(N(l,!0),l.strm.avail_out===0?q:U):l.last_lit&&(N(l,!1),l.strm.avail_out===0)?d:O}function le(l,$,W,j,B){this.good_length=l,this.max_lazy=$,this.nice_length=W,this.max_chain=j,this.func=B}function ce(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=v,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new a.Buf16(2*R),this.dyn_dtree=new a.Buf16(2*(2*E+1)),this.bl_tree=new a.Buf16(2*(2*I+1)),X(this.dyn_ltree),X(this.dyn_dtree),X(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new a.Buf16(A+1),this.heap=new a.Buf16(2*w+1),X(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new a.Buf16(2*w+1),X(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function ue(l){var $;return l&&l.state?(l.total_in=l.total_out=0,l.data_type=p,($=l.state).pending=0,$.pending_out=0,$.wrap<0&&($.wrap=-$.wrap),$.status=$.wrap?_:L,l.adler=$.wrap===2?0:1,$.last_flush=g,i._tr_init($),h):Q(l,b)}function pe(l){var $=ue(l);return $===h&&function(W){W.window_size=2*W.w_size,X(W.head),W.max_lazy_match=s[W.level].max_lazy,W.good_match=s[W.level].good_length,W.nice_match=s[W.level].nice_length,W.max_chain_length=s[W.level].max_chain,W.strstart=0,W.block_start=0,W.lookahead=0,W.insert=0,W.match_length=W.prev_length=T-1,W.match_available=0,W.ins_h=0}(l.state),$}function be(l,$,W,j,B,M){if(!l)return b;var G=1;if($===u&&($=6),j<0?(G=0,j=-j):15<j&&(G=2,j-=16),B<1||S<B||W!==v||j<8||15<j||$<0||9<$||M<0||m<M)return Q(l,b);j===8&&(j=9);var J=new ce;return(l.state=J).strm=l,J.wrap=G,J.gzhead=null,J.w_bits=j,J.w_size=1<<J.w_bits,J.w_mask=J.w_size-1,J.hash_bits=B+7,J.hash_size=1<<J.hash_bits,J.hash_mask=J.hash_size-1,J.hash_shift=~~((J.hash_bits+T-1)/T),J.window=new a.Buf8(2*J.w_size),J.head=new a.Buf16(J.hash_size),J.prev=new a.Buf16(J.w_size),J.lit_bufsize=1<<B+6,J.pending_buf_size=4*J.lit_bufsize,J.pending_buf=new a.Buf8(J.pending_buf_size),J.d_buf=1*J.lit_bufsize,J.l_buf=3*J.lit_bufsize,J.level=$,J.strategy=M,J.method=W,pe(l)}s=[new le(0,0,0,0,function(l,$){var W=65535;for(W>l.pending_buf_size-5&&(W=l.pending_buf_size-5);;){if(l.lookahead<=1){if(se(l),l.lookahead===0&&$===g)return d;if(l.lookahead===0)break}l.strstart+=l.lookahead,l.lookahead=0;var j=l.block_start+W;if((l.strstart===0||l.strstart>=j)&&(l.lookahead=l.strstart-j,l.strstart=j,N(l,!1),l.strm.avail_out===0)||l.strstart-l.block_start>=l.w_size-D&&(N(l,!1),l.strm.avail_out===0))return d}return l.insert=0,$===y?(N(l,!0),l.strm.avail_out===0?q:U):(l.strstart>l.block_start&&(N(l,!1),l.strm.avail_out),d)}),new le(4,4,8,4,K),new le(4,5,16,8,K),new le(4,6,32,32,K),new le(4,4,16,16,re),new le(8,16,32,32,re),new le(8,16,128,128,re),new le(8,32,128,256,re),new le(32,128,258,1024,re),new le(32,258,258,4096,re)],r.deflateInit=function(l,$){return be(l,$,v,15,8,0)},r.deflateInit2=be,r.deflateReset=pe,r.deflateResetKeep=ue,r.deflateSetHeader=function(l,$){return l&&l.state?l.state.wrap!==2?b:(l.state.gzhead=$,h):b},r.deflate=function(l,$){var W,j,B,M;if(!l||!l.state||5<$||$<0)return l?Q(l,b):b;if(j=l.state,!l.output||!l.input&&l.avail_in!==0||j.status===666&&$!==y)return Q(l,l.avail_out===0?-5:b);if(j.strm=l,W=j.last_flush,j.last_flush=$,j.status===_)if(j.wrap===2)l.adler=0,Y(j,31),Y(j,139),Y(j,8),j.gzhead?(Y(j,(j.gzhead.text?1:0)+(j.gzhead.hcrc?2:0)+(j.gzhead.extra?4:0)+(j.gzhead.name?8:0)+(j.gzhead.comment?16:0)),Y(j,255&j.gzhead.time),Y(j,j.gzhead.time>>8&255),Y(j,j.gzhead.time>>16&255),Y(j,j.gzhead.time>>24&255),Y(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),Y(j,255&j.gzhead.os),j.gzhead.extra&&j.gzhead.extra.length&&(Y(j,255&j.gzhead.extra.length),Y(j,j.gzhead.extra.length>>8&255)),j.gzhead.hcrc&&(l.adler=k(l.adler,j.pending_buf,j.pending,0)),j.gzindex=0,j.status=69):(Y(j,0),Y(j,0),Y(j,0),Y(j,0),Y(j,0),Y(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),Y(j,3),j.status=L);else{var G=v+(j.w_bits-8<<4)<<8;G|=(2<=j.strategy||j.level<2?0:j.level<6?1:j.level===6?2:3)<<6,j.strstart!==0&&(G|=32),G+=31-G%31,j.status=L,Z(j,G),j.strstart!==0&&(Z(j,l.adler>>>16),Z(j,65535&l.adler)),l.adler=1}if(j.status===69)if(j.gzhead.extra){for(B=j.pending;j.gzindex<(65535&j.gzhead.extra.length)&&(j.pending!==j.pending_buf_size||(j.gzhead.hcrc&&j.pending>B&&(l.adler=k(l.adler,j.pending_buf,j.pending-B,B)),P(l),B=j.pending,j.pending!==j.pending_buf_size));)Y(j,255&j.gzhead.extra[j.gzindex]),j.gzindex++;j.gzhead.hcrc&&j.pending>B&&(l.adler=k(l.adler,j.pending_buf,j.pending-B,B)),j.gzindex===j.gzhead.extra.length&&(j.gzindex=0,j.status=73)}else j.status=73;if(j.status===73)if(j.gzhead.name){B=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>B&&(l.adler=k(l.adler,j.pending_buf,j.pending-B,B)),P(l),B=j.pending,j.pending===j.pending_buf_size)){M=1;break}M=j.gzindex<j.gzhead.name.length?255&j.gzhead.name.charCodeAt(j.gzindex++):0,Y(j,M)}while(M!==0);j.gzhead.hcrc&&j.pending>B&&(l.adler=k(l.adler,j.pending_buf,j.pending-B,B)),M===0&&(j.gzindex=0,j.status=91)}else j.status=91;if(j.status===91)if(j.gzhead.comment){B=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>B&&(l.adler=k(l.adler,j.pending_buf,j.pending-B,B)),P(l),B=j.pending,j.pending===j.pending_buf_size)){M=1;break}M=j.gzindex<j.gzhead.comment.length?255&j.gzhead.comment.charCodeAt(j.gzindex++):0,Y(j,M)}while(M!==0);j.gzhead.hcrc&&j.pending>B&&(l.adler=k(l.adler,j.pending_buf,j.pending-B,B)),M===0&&(j.status=103)}else j.status=103;if(j.status===103&&(j.gzhead.hcrc?(j.pending+2>j.pending_buf_size&&P(l),j.pending+2<=j.pending_buf_size&&(Y(j,255&l.adler),Y(j,l.adler>>8&255),l.adler=0,j.status=L)):j.status=L),j.pending!==0){if(P(l),l.avail_out===0)return j.last_flush=-1,h}else if(l.avail_in===0&&V($)<=V(W)&&$!==y)return Q(l,-5);if(j.status===666&&l.avail_in!==0)return Q(l,-5);if(l.avail_in!==0||j.lookahead!==0||$!==g&&j.status!==666){var J=j.strategy===2?function(F,ee){for(var oe;;){if(F.lookahead===0&&(se(F),F.lookahead===0)){if(ee===g)return d;break}if(F.match_length=0,oe=i._tr_tally(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++,oe&&(N(F,!1),F.strm.avail_out===0))return d}return F.insert=0,ee===y?(N(F,!0),F.strm.avail_out===0?q:U):F.last_lit&&(N(F,!1),F.strm.avail_out===0)?d:O}(j,$):j.strategy===3?function(F,ee){for(var oe,te,ie,he,fe=F.window;;){if(F.lookahead<=z){if(se(F),F.lookahead<=z&&ee===g)return d;if(F.lookahead===0)break}if(F.match_length=0,F.lookahead>=T&&0<F.strstart&&(te=fe[ie=F.strstart-1])===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]){he=F.strstart+z;do;while(te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&ie<he);F.match_length=z-(he-ie),F.match_length>F.lookahead&&(F.match_length=F.lookahead)}if(F.match_length>=T?(oe=i._tr_tally(F,1,F.match_length-T),F.lookahead-=F.match_length,F.strstart+=F.match_length,F.match_length=0):(oe=i._tr_tally(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++),oe&&(N(F,!1),F.strm.avail_out===0))return d}return F.insert=0,ee===y?(N(F,!0),F.strm.avail_out===0?q:U):F.last_lit&&(N(F,!1),F.strm.avail_out===0)?d:O}(j,$):s[j.level].func(j,$);if(J!==q&&J!==U||(j.status=666),J===d||J===q)return l.avail_out===0&&(j.last_flush=-1),h;if(J===O&&($===1?i._tr_align(j):$!==5&&(i._tr_stored_block(j,0,0,!1),$===3&&(X(j.head),j.lookahead===0&&(j.strstart=0,j.block_start=0,j.insert=0))),P(l),l.avail_out===0))return j.last_flush=-1,h}return $!==y?h:j.wrap<=0?1:(j.wrap===2?(Y(j,255&l.adler),Y(j,l.adler>>8&255),Y(j,l.adler>>16&255),Y(j,l.adler>>24&255),Y(j,255&l.total_in),Y(j,l.total_in>>8&255),Y(j,l.total_in>>16&255),Y(j,l.total_in>>24&255)):(Z(j,l.adler>>>16),Z(j,65535&l.adler)),P(l),0<j.wrap&&(j.wrap=-j.wrap),j.pending!==0?h:1)},r.deflateEnd=function(l){var $;return l&&l.state?($=l.state.status)!==_&&$!==69&&$!==73&&$!==91&&$!==103&&$!==L&&$!==666?Q(l,b):(l.state=null,$===L?Q(l,-3):h):b},r.deflateSetDictionary=function(l,$){var W,j,B,M,G,J,F,ee,oe=$.length;if(!l||!l.state||(M=(W=l.state).wrap)===2||M===1&&W.status!==_||W.lookahead)return b;for(M===1&&(l.adler=f(l.adler,$,oe,0)),W.wrap=0,oe>=W.w_size&&(M===0&&(X(W.head),W.strstart=0,W.block_start=0,W.insert=0),ee=new a.Buf8(W.w_size),a.arraySet(ee,$,oe-W.w_size,W.w_size,0),$=ee,oe=W.w_size),G=l.avail_in,J=l.next_in,F=l.input,l.avail_in=oe,l.next_in=0,l.input=$,se(W);W.lookahead>=T;){for(j=W.strstart,B=W.lookahead-(T-1);W.ins_h=(W.ins_h<<W.hash_shift^W.window[j+T-1])&W.hash_mask,W.prev[j&W.w_mask]=W.head[W.ins_h],W.head[W.ins_h]=j,j++,--B;);W.strstart=j,W.lookahead=T-1,se(W)}return W.strstart+=W.lookahead,W.block_start=W.strstart,W.insert=W.lookahead,W.lookahead=0,W.match_length=W.prev_length=T-1,W.match_available=0,l.next_in=J,l.input=F,l.avail_in=G,W.wrap=M,h},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,c,r){c.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,c,r){c.exports=function(s,a){var i,f,k,x,g,y,h,b,u,m,p,v,S,w,E,I,R,A,T,z,D,_,L,d,O;i=s.state,f=s.next_in,d=s.input,k=f+(s.avail_in-5),x=s.next_out,O=s.output,g=x-(a-s.avail_out),y=x+(s.avail_out-257),h=i.dmax,b=i.wsize,u=i.whave,m=i.wnext,p=i.window,v=i.hold,S=i.bits,w=i.lencode,E=i.distcode,I=(1<<i.lenbits)-1,R=(1<<i.distbits)-1;e:do{S<15&&(v+=d[f++]<<S,S+=8,v+=d[f++]<<S,S+=8),A=w[v&I];t:for(;;){if(v>>>=T=A>>>24,S-=T,(T=A>>>16&255)===0)O[x++]=65535&A;else{if(!(16&T)){if(!(64&T)){A=w[(65535&A)+(v&(1<<T)-1)];continue t}if(32&T){i.mode=12;break e}s.msg="invalid literal/length code",i.mode=30;break e}z=65535&A,(T&=15)&&(S<T&&(v+=d[f++]<<S,S+=8),z+=v&(1<<T)-1,v>>>=T,S-=T),S<15&&(v+=d[f++]<<S,S+=8,v+=d[f++]<<S,S+=8),A=E[v&R];n:for(;;){if(v>>>=T=A>>>24,S-=T,!(16&(T=A>>>16&255))){if(!(64&T)){A=E[(65535&A)+(v&(1<<T)-1)];continue n}s.msg="invalid distance code",i.mode=30;break e}if(D=65535&A,S<(T&=15)&&(v+=d[f++]<<S,(S+=8)<T&&(v+=d[f++]<<S,S+=8)),h<(D+=v&(1<<T)-1)){s.msg="invalid distance too far back",i.mode=30;break e}if(v>>>=T,S-=T,(T=x-g)<D){if(u<(T=D-T)&&i.sane){s.msg="invalid distance too far back",i.mode=30;break e}if(L=p,(_=0)===m){if(_+=b-T,T<z){for(z-=T;O[x++]=p[_++],--T;);_=x-D,L=O}}else if(m<T){if(_+=b+m-T,(T-=m)<z){for(z-=T;O[x++]=p[_++],--T;);if(_=0,m<z){for(z-=T=m;O[x++]=p[_++],--T;);_=x-D,L=O}}}else if(_+=m-T,T<z){for(z-=T;O[x++]=p[_++],--T;);_=x-D,L=O}for(;2<z;)O[x++]=L[_++],O[x++]=L[_++],O[x++]=L[_++],z-=3;z&&(O[x++]=L[_++],1<z&&(O[x++]=L[_++]))}else{for(_=x-D;O[x++]=O[_++],O[x++]=O[_++],O[x++]=O[_++],2<(z-=3););z&&(O[x++]=O[_++],1<z&&(O[x++]=O[_++]))}break}}break}}while(f<k&&x<y);f-=z=S>>3,v&=(1<<(S-=z<<3))-1,s.next_in=f,s.next_out=x,s.avail_in=f<k?k-f+5:5-(f-k),s.avail_out=x<y?y-x+257:257-(x-y),i.hold=v,i.bits=S}},{}],49:[function(e,c,r){var s=e("../utils/common"),a=e("./adler32"),i=e("./crc32"),f=e("./inffast"),k=e("./inftrees"),x=1,g=2,y=0,h=-2,b=1,u=852,m=592;function p(_){return(_>>>24&255)+(_>>>8&65280)+((65280&_)<<8)+((255&_)<<24)}function v(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(_){var L;return _&&_.state?(L=_.state,_.total_in=_.total_out=L.total=0,_.msg="",L.wrap&&(_.adler=1&L.wrap),L.mode=b,L.last=0,L.havedict=0,L.dmax=32768,L.head=null,L.hold=0,L.bits=0,L.lencode=L.lendyn=new s.Buf32(u),L.distcode=L.distdyn=new s.Buf32(m),L.sane=1,L.back=-1,y):h}function w(_){var L;return _&&_.state?((L=_.state).wsize=0,L.whave=0,L.wnext=0,S(_)):h}function E(_,L){var d,O;return _&&_.state?(O=_.state,L<0?(d=0,L=-L):(d=1+(L>>4),L<48&&(L&=15)),L&&(L<8||15<L)?h:(O.window!==null&&O.wbits!==L&&(O.window=null),O.wrap=d,O.wbits=L,w(_))):h}function I(_,L){var d,O;return _?(O=new v,(_.state=O).window=null,(d=E(_,L))!==y&&(_.state=null),d):h}var R,A,T=!0;function z(_){if(T){var L;for(R=new s.Buf32(512),A=new s.Buf32(32),L=0;L<144;)_.lens[L++]=8;for(;L<256;)_.lens[L++]=9;for(;L<280;)_.lens[L++]=7;for(;L<288;)_.lens[L++]=8;for(k(x,_.lens,0,288,R,0,_.work,{bits:9}),L=0;L<32;)_.lens[L++]=5;k(g,_.lens,0,32,A,0,_.work,{bits:5}),T=!1}_.lencode=R,_.lenbits=9,_.distcode=A,_.distbits=5}function D(_,L,d,O){var q,U=_.state;return U.window===null&&(U.wsize=1<<U.wbits,U.wnext=0,U.whave=0,U.window=new s.Buf8(U.wsize)),O>=U.wsize?(s.arraySet(U.window,L,d-U.wsize,U.wsize,0),U.wnext=0,U.whave=U.wsize):(O<(q=U.wsize-U.wnext)&&(q=O),s.arraySet(U.window,L,d-O,q,U.wnext),(O-=q)?(s.arraySet(U.window,L,d-O,O,0),U.wnext=O,U.whave=U.wsize):(U.wnext+=q,U.wnext===U.wsize&&(U.wnext=0),U.whave<U.wsize&&(U.whave+=q))),0}r.inflateReset=w,r.inflateReset2=E,r.inflateResetKeep=S,r.inflateInit=function(_){return I(_,15)},r.inflateInit2=I,r.inflate=function(_,L){var d,O,q,U,Q,V,X,P,N,Y,Z,H,se,K,re,le,ce,ue,pe,be,l,$,W,j,B=0,M=new s.Buf8(4),G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!_||!_.state||!_.output||!_.input&&_.avail_in!==0)return h;(d=_.state).mode===12&&(d.mode=13),Q=_.next_out,q=_.output,X=_.avail_out,U=_.next_in,O=_.input,V=_.avail_in,P=d.hold,N=d.bits,Y=V,Z=X,$=y;e:for(;;)switch(d.mode){case b:if(d.wrap===0){d.mode=13;break}for(;N<16;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(2&d.wrap&&P===35615){M[d.check=0]=255&P,M[1]=P>>>8&255,d.check=i(d.check,M,2,0),N=P=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&P)<<8)+(P>>8))%31){_.msg="incorrect header check",d.mode=30;break}if((15&P)!=8){_.msg="unknown compression method",d.mode=30;break}if(N-=4,l=8+(15&(P>>>=4)),d.wbits===0)d.wbits=l;else if(l>d.wbits){_.msg="invalid window size",d.mode=30;break}d.dmax=1<<l,_.adler=d.check=1,d.mode=512&P?10:12,N=P=0;break;case 2:for(;N<16;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(d.flags=P,(255&d.flags)!=8){_.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){_.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=P>>8&1),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,d.check=i(d.check,M,2,0)),N=P=0,d.mode=3;case 3:for(;N<32;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}d.head&&(d.head.time=P),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,M[2]=P>>>16&255,M[3]=P>>>24&255,d.check=i(d.check,M,4,0)),N=P=0,d.mode=4;case 4:for(;N<16;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}d.head&&(d.head.xflags=255&P,d.head.os=P>>8),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,d.check=i(d.check,M,2,0)),N=P=0,d.mode=5;case 5:if(1024&d.flags){for(;N<16;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}d.length=P,d.head&&(d.head.extra_len=P),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,d.check=i(d.check,M,2,0)),N=P=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&(V<(H=d.length)&&(H=V),H&&(d.head&&(l=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),s.arraySet(d.head.extra,O,U,H,l)),512&d.flags&&(d.check=i(d.check,O,H,U)),V-=H,U+=H,d.length-=H),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if(V===0)break e;for(H=0;l=O[U+H++],d.head&&l&&d.length<65536&&(d.head.name+=String.fromCharCode(l)),l&&H<V;);if(512&d.flags&&(d.check=i(d.check,O,H,U)),V-=H,U+=H,l)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if(V===0)break e;for(H=0;l=O[U+H++],d.head&&l&&d.length<65536&&(d.head.comment+=String.fromCharCode(l)),l&&H<V;);if(512&d.flags&&(d.check=i(d.check,O,H,U)),V-=H,U+=H,l)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;N<16;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(P!==(65535&d.check)){_.msg="header crc mismatch",d.mode=30;break}N=P=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),_.adler=d.check=0,d.mode=12;break;case 10:for(;N<32;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}_.adler=d.check=p(P),N=P=0,d.mode=11;case 11:if(d.havedict===0)return _.next_out=Q,_.avail_out=X,_.next_in=U,_.avail_in=V,d.hold=P,d.bits=N,2;_.adler=d.check=1,d.mode=12;case 12:if(L===5||L===6)break e;case 13:if(d.last){P>>>=7&N,N-=7&N,d.mode=27;break}for(;N<3;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}switch(d.last=1&P,N-=1,3&(P>>>=1)){case 0:d.mode=14;break;case 1:if(z(d),d.mode=20,L!==6)break;P>>>=2,N-=2;break e;case 2:d.mode=17;break;case 3:_.msg="invalid block type",d.mode=30}P>>>=2,N-=2;break;case 14:for(P>>>=7&N,N-=7&N;N<32;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if((65535&P)!=(P>>>16^65535)){_.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&P,N=P=0,d.mode=15,L===6)break e;case 15:d.mode=16;case 16:if(H=d.length){if(V<H&&(H=V),X<H&&(H=X),H===0)break e;s.arraySet(q,O,U,H,Q),V-=H,U+=H,X-=H,Q+=H,d.length-=H;break}d.mode=12;break;case 17:for(;N<14;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(d.nlen=257+(31&P),P>>>=5,N-=5,d.ndist=1+(31&P),P>>>=5,N-=5,d.ncode=4+(15&P),P>>>=4,N-=4,286<d.nlen||30<d.ndist){_.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;N<3;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}d.lens[G[d.have++]]=7&P,P>>>=3,N-=3}for(;d.have<19;)d.lens[G[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,W={bits:d.lenbits},$=k(0,d.lens,0,19,d.lencode,0,d.work,W),d.lenbits=W.bits,$){_.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;le=(B=d.lencode[P&(1<<d.lenbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=N);){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(ce<16)P>>>=re,N-=re,d.lens[d.have++]=ce;else{if(ce===16){for(j=re+2;N<j;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(P>>>=re,N-=re,d.have===0){_.msg="invalid bit length repeat",d.mode=30;break}l=d.lens[d.have-1],H=3+(3&P),P>>>=2,N-=2}else if(ce===17){for(j=re+3;N<j;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}N-=re,l=0,H=3+(7&(P>>>=re)),P>>>=3,N-=3}else{for(j=re+7;N<j;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}N-=re,l=0,H=11+(127&(P>>>=re)),P>>>=7,N-=7}if(d.have+H>d.nlen+d.ndist){_.msg="invalid bit length repeat",d.mode=30;break}for(;H--;)d.lens[d.have++]=l}}if(d.mode===30)break;if(d.lens[256]===0){_.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,W={bits:d.lenbits},$=k(x,d.lens,0,d.nlen,d.lencode,0,d.work,W),d.lenbits=W.bits,$){_.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,W={bits:d.distbits},$=k(g,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,W),d.distbits=W.bits,$){_.msg="invalid distances set",d.mode=30;break}if(d.mode=20,L===6)break e;case 20:d.mode=21;case 21:if(6<=V&&258<=X){_.next_out=Q,_.avail_out=X,_.next_in=U,_.avail_in=V,d.hold=P,d.bits=N,f(_,Z),Q=_.next_out,q=_.output,X=_.avail_out,U=_.next_in,O=_.input,V=_.avail_in,P=d.hold,N=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;le=(B=d.lencode[P&(1<<d.lenbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=N);){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(le&&!(240&le)){for(ue=re,pe=le,be=ce;le=(B=d.lencode[be+((P&(1<<ue+pe)-1)>>ue)])>>>16&255,ce=65535&B,!(ue+(re=B>>>24)<=N);){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}P>>>=ue,N-=ue,d.back+=ue}if(P>>>=re,N-=re,d.back+=re,d.length=ce,le===0){d.mode=26;break}if(32&le){d.back=-1,d.mode=12;break}if(64&le){_.msg="invalid literal/length code",d.mode=30;break}d.extra=15&le,d.mode=22;case 22:if(d.extra){for(j=d.extra;N<j;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}d.length+=P&(1<<d.extra)-1,P>>>=d.extra,N-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;le=(B=d.distcode[P&(1<<d.distbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=N);){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(!(240&le)){for(ue=re,pe=le,be=ce;le=(B=d.distcode[be+((P&(1<<ue+pe)-1)>>ue)])>>>16&255,ce=65535&B,!(ue+(re=B>>>24)<=N);){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}P>>>=ue,N-=ue,d.back+=ue}if(P>>>=re,N-=re,d.back+=re,64&le){_.msg="invalid distance code",d.mode=30;break}d.offset=ce,d.extra=15&le,d.mode=24;case 24:if(d.extra){for(j=d.extra;N<j;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}d.offset+=P&(1<<d.extra)-1,P>>>=d.extra,N-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){_.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(X===0)break e;if(H=Z-X,d.offset>H){if((H=d.offset-H)>d.whave&&d.sane){_.msg="invalid distance too far back",d.mode=30;break}se=H>d.wnext?(H-=d.wnext,d.wsize-H):d.wnext-H,H>d.length&&(H=d.length),K=d.window}else K=q,se=Q-d.offset,H=d.length;for(X<H&&(H=X),X-=H,d.length-=H;q[Q++]=K[se++],--H;);d.length===0&&(d.mode=21);break;case 26:if(X===0)break e;q[Q++]=d.length,X--,d.mode=21;break;case 27:if(d.wrap){for(;N<32;){if(V===0)break e;V--,P|=O[U++]<<N,N+=8}if(Z-=X,_.total_out+=Z,d.total+=Z,Z&&(_.adler=d.check=d.flags?i(d.check,q,Z,Q-Z):a(d.check,q,Z,Q-Z)),Z=X,(d.flags?P:p(P))!==d.check){_.msg="incorrect data check",d.mode=30;break}N=P=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;N<32;){if(V===0)break e;V--,P+=O[U++]<<N,N+=8}if(P!==(4294967295&d.total)){_.msg="incorrect length check",d.mode=30;break}N=P=0}d.mode=29;case 29:$=1;break e;case 30:$=-3;break e;case 31:return-4;case 32:default:return h}return _.next_out=Q,_.avail_out=X,_.next_in=U,_.avail_in=V,d.hold=P,d.bits=N,(d.wsize||Z!==_.avail_out&&d.mode<30&&(d.mode<27||L!==4))&&D(_,_.output,_.next_out,Z-_.avail_out)?(d.mode=31,-4):(Y-=_.avail_in,Z-=_.avail_out,_.total_in+=Y,_.total_out+=Z,d.total+=Z,d.wrap&&Z&&(_.adler=d.check=d.flags?i(d.check,q,Z,_.next_out-Z):a(d.check,q,Z,_.next_out-Z)),_.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(Y==0&&Z===0||L===4)&&$===y&&($=-5),$)},r.inflateEnd=function(_){if(!_||!_.state)return h;var L=_.state;return L.window&&(L.window=null),_.state=null,y},r.inflateGetHeader=function(_,L){var d;return _&&_.state&&2&(d=_.state).wrap?((d.head=L).done=!1,y):h},r.inflateSetDictionary=function(_,L){var d,O=L.length;return _&&_.state?(d=_.state).wrap!==0&&d.mode!==11?h:d.mode===11&&a(1,L,O,0)!==d.check?-3:D(_,L,O,O)?(d.mode=31,-4):(d.havedict=1,y):h},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,c,r){var s=e("../utils/common"),a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],i=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],f=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],k=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];c.exports=function(x,g,y,h,b,u,m,p){var v,S,w,E,I,R,A,T,z,D=p.bits,_=0,L=0,d=0,O=0,q=0,U=0,Q=0,V=0,X=0,P=0,N=null,Y=0,Z=new s.Buf16(16),H=new s.Buf16(16),se=null,K=0;for(_=0;_<=15;_++)Z[_]=0;for(L=0;L<h;L++)Z[g[y+L]]++;for(q=D,O=15;1<=O&&Z[O]===0;O--);if(O<q&&(q=O),O===0)return b[u++]=20971520,b[u++]=20971520,p.bits=1,0;for(d=1;d<O&&Z[d]===0;d++);for(q<d&&(q=d),_=V=1;_<=15;_++)if(V<<=1,(V-=Z[_])<0)return-1;if(0<V&&(x===0||O!==1))return-1;for(H[1]=0,_=1;_<15;_++)H[_+1]=H[_]+Z[_];for(L=0;L<h;L++)g[y+L]!==0&&(m[H[g[y+L]]++]=L);if(R=x===0?(N=se=m,19):x===1?(N=a,Y-=257,se=i,K-=257,256):(N=f,se=k,-1),_=d,I=u,Q=L=P=0,w=-1,E=(X=1<<(U=q))-1,x===1&&852<X||x===2&&592<X)return 1;for(;;){for(A=_-Q,z=m[L]<R?(T=0,m[L]):m[L]>R?(T=se[K+m[L]],N[Y+m[L]]):(T=96,0),v=1<<_-Q,d=S=1<<U;b[I+(P>>Q)+(S-=v)]=A<<24|T<<16|z|0,S!==0;);for(v=1<<_-1;P&v;)v>>=1;if(v!==0?(P&=v-1,P+=v):P=0,L++,--Z[_]==0){if(_===O)break;_=g[y+m[L]]}if(q<_&&(P&E)!==w){for(Q===0&&(Q=q),I+=d,V=1<<(U=_-Q);U+Q<O&&!((V-=Z[U+Q])<=0);)U++,V<<=1;if(X+=1<<U,x===1&&852<X||x===2&&592<X)return 1;b[w=P&E]=q<<24|U<<16|I-u|0}}return P!==0&&(b[I+P]=_-Q<<24|64<<16|0),p.bits=q,0}},{"../utils/common":41}],51:[function(e,c,r){c.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,c,r){var s=e("../utils/common"),a=0,i=1;function f(B){for(var M=B.length;0<=--M;)B[M]=0}var k=0,x=29,g=256,y=g+1+x,h=30,b=19,u=2*y+1,m=15,p=16,v=7,S=256,w=16,E=17,I=18,R=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],A=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],T=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],D=new Array(2*(y+2));f(D);var _=new Array(2*h);f(_);var L=new Array(512);f(L);var d=new Array(256);f(d);var O=new Array(x);f(O);var q,U,Q,V=new Array(h);function X(B,M,G,J,F){this.static_tree=B,this.extra_bits=M,this.extra_base=G,this.elems=J,this.max_length=F,this.has_stree=B&&B.length}function P(B,M){this.dyn_tree=B,this.max_code=0,this.stat_desc=M}function N(B){return B<256?L[B]:L[256+(B>>>7)]}function Y(B,M){B.pending_buf[B.pending++]=255&M,B.pending_buf[B.pending++]=M>>>8&255}function Z(B,M,G){B.bi_valid>p-G?(B.bi_buf|=M<<B.bi_valid&65535,Y(B,B.bi_buf),B.bi_buf=M>>p-B.bi_valid,B.bi_valid+=G-p):(B.bi_buf|=M<<B.bi_valid&65535,B.bi_valid+=G)}function H(B,M,G){Z(B,G[2*M],G[2*M+1])}function se(B,M){for(var G=0;G|=1&B,B>>>=1,G<<=1,0<--M;);return G>>>1}function K(B,M,G){var J,F,ee=new Array(m+1),oe=0;for(J=1;J<=m;J++)ee[J]=oe=oe+G[J-1]<<1;for(F=0;F<=M;F++){var te=B[2*F+1];te!==0&&(B[2*F]=se(ee[te]++,te))}}function re(B){var M;for(M=0;M<y;M++)B.dyn_ltree[2*M]=0;for(M=0;M<h;M++)B.dyn_dtree[2*M]=0;for(M=0;M<b;M++)B.bl_tree[2*M]=0;B.dyn_ltree[2*S]=1,B.opt_len=B.static_len=0,B.last_lit=B.matches=0}function le(B){8<B.bi_valid?Y(B,B.bi_buf):0<B.bi_valid&&(B.pending_buf[B.pending++]=B.bi_buf),B.bi_buf=0,B.bi_valid=0}function ce(B,M,G,J){var F=2*M,ee=2*G;return B[F]<B[ee]||B[F]===B[ee]&&J[M]<=J[G]}function ue(B,M,G){for(var J=B.heap[G],F=G<<1;F<=B.heap_len&&(F<B.heap_len&&ce(M,B.heap[F+1],B.heap[F],B.depth)&&F++,!ce(M,J,B.heap[F],B.depth));)B.heap[G]=B.heap[F],G=F,F<<=1;B.heap[G]=J}function pe(B,M,G){var J,F,ee,oe,te=0;if(B.last_lit!==0)for(;J=B.pending_buf[B.d_buf+2*te]<<8|B.pending_buf[B.d_buf+2*te+1],F=B.pending_buf[B.l_buf+te],te++,J===0?H(B,F,M):(H(B,(ee=d[F])+g+1,M),(oe=R[ee])!==0&&Z(B,F-=O[ee],oe),H(B,ee=N(--J),G),(oe=A[ee])!==0&&Z(B,J-=V[ee],oe)),te<B.last_lit;);H(B,S,M)}function be(B,M){var G,J,F,ee=M.dyn_tree,oe=M.stat_desc.static_tree,te=M.stat_desc.has_stree,ie=M.stat_desc.elems,he=-1;for(B.heap_len=0,B.heap_max=u,G=0;G<ie;G++)ee[2*G]!==0?(B.heap[++B.heap_len]=he=G,B.depth[G]=0):ee[2*G+1]=0;for(;B.heap_len<2;)ee[2*(F=B.heap[++B.heap_len]=he<2?++he:0)]=1,B.depth[F]=0,B.opt_len--,te&&(B.static_len-=oe[2*F+1]);for(M.max_code=he,G=B.heap_len>>1;1<=G;G--)ue(B,ee,G);for(F=ie;G=B.heap[1],B.heap[1]=B.heap[B.heap_len--],ue(B,ee,1),J=B.heap[1],B.heap[--B.heap_max]=G,B.heap[--B.heap_max]=J,ee[2*F]=ee[2*G]+ee[2*J],B.depth[F]=(B.depth[G]>=B.depth[J]?B.depth[G]:B.depth[J])+1,ee[2*G+1]=ee[2*J+1]=F,B.heap[1]=F++,ue(B,ee,1),2<=B.heap_len;);B.heap[--B.heap_max]=B.heap[1],function(fe,_e){var ye,je,De,ge,Te,Ge,Ee=_e.dyn_tree,$e=_e.max_code,Ze=_e.stat_desc.static_tree,at=_e.stat_desc.has_stree,Ot=_e.stat_desc.extra_bits,xt=_e.stat_desc.extra_base,Ke=_e.stat_desc.max_length,Je=0;for(ge=0;ge<=m;ge++)fe.bl_count[ge]=0;for(Ee[2*fe.heap[fe.heap_max]+1]=0,ye=fe.heap_max+1;ye<u;ye++)Ke<(ge=Ee[2*Ee[2*(je=fe.heap[ye])+1]+1]+1)&&(ge=Ke,Je++),Ee[2*je+1]=ge,$e<je||(fe.bl_count[ge]++,Te=0,xt<=je&&(Te=Ot[je-xt]),Ge=Ee[2*je],fe.opt_len+=Ge*(ge+Te),at&&(fe.static_len+=Ge*(Ze[2*je+1]+Te)));if(Je!==0){do{for(ge=Ke-1;fe.bl_count[ge]===0;)ge--;fe.bl_count[ge]--,fe.bl_count[ge+1]+=2,fe.bl_count[Ke]--,Je-=2}while(0<Je);for(ge=Ke;ge!==0;ge--)for(je=fe.bl_count[ge];je!==0;)$e<(De=fe.heap[--ye])||(Ee[2*De+1]!==ge&&(fe.opt_len+=(ge-Ee[2*De+1])*Ee[2*De],Ee[2*De+1]=ge),je--)}}(B,M),K(ee,he,B.bl_count)}function l(B,M,G){var J,F,ee=-1,oe=M[1],te=0,ie=7,he=4;for(oe===0&&(ie=138,he=3),M[2*(G+1)+1]=65535,J=0;J<=G;J++)F=oe,oe=M[2*(J+1)+1],++te<ie&&F===oe||(te<he?B.bl_tree[2*F]+=te:F!==0?(F!==ee&&B.bl_tree[2*F]++,B.bl_tree[2*w]++):te<=10?B.bl_tree[2*E]++:B.bl_tree[2*I]++,ee=F,he=(te=0)===oe?(ie=138,3):F===oe?(ie=6,3):(ie=7,4))}function $(B,M,G){var J,F,ee=-1,oe=M[1],te=0,ie=7,he=4;for(oe===0&&(ie=138,he=3),J=0;J<=G;J++)if(F=oe,oe=M[2*(J+1)+1],!(++te<ie&&F===oe)){if(te<he)for(;H(B,F,B.bl_tree),--te!=0;);else F!==0?(F!==ee&&(H(B,F,B.bl_tree),te--),H(B,w,B.bl_tree),Z(B,te-3,2)):te<=10?(H(B,E,B.bl_tree),Z(B,te-3,3)):(H(B,I,B.bl_tree),Z(B,te-11,7));ee=F,he=(te=0)===oe?(ie=138,3):F===oe?(ie=6,3):(ie=7,4)}}f(V);var W=!1;function j(B,M,G,J){Z(B,(k<<1)+(J?1:0),3),function(F,ee,oe,te){le(F),te&&(Y(F,oe),Y(F,~oe)),s.arraySet(F.pending_buf,F.window,ee,oe,F.pending),F.pending+=oe}(B,M,G,!0)}r._tr_init=function(B){W||(function(){var M,G,J,F,ee,oe=new Array(m+1);for(F=J=0;F<x-1;F++)for(O[F]=J,M=0;M<1<<R[F];M++)d[J++]=F;for(d[J-1]=F,F=ee=0;F<16;F++)for(V[F]=ee,M=0;M<1<<A[F];M++)L[ee++]=F;for(ee>>=7;F<h;F++)for(V[F]=ee<<7,M=0;M<1<<A[F]-7;M++)L[256+ee++]=F;for(G=0;G<=m;G++)oe[G]=0;for(M=0;M<=143;)D[2*M+1]=8,M++,oe[8]++;for(;M<=255;)D[2*M+1]=9,M++,oe[9]++;for(;M<=279;)D[2*M+1]=7,M++,oe[7]++;for(;M<=287;)D[2*M+1]=8,M++,oe[8]++;for(K(D,y+1,oe),M=0;M<h;M++)_[2*M+1]=5,_[2*M]=se(M,5);q=new X(D,R,g+1,y,m),U=new X(_,A,0,h,m),Q=new X(new Array(0),T,0,b,v)}(),W=!0),B.l_desc=new P(B.dyn_ltree,q),B.d_desc=new P(B.dyn_dtree,U),B.bl_desc=new P(B.bl_tree,Q),B.bi_buf=0,B.bi_valid=0,re(B)},r._tr_stored_block=j,r._tr_flush_block=function(B,M,G,J){var F,ee,oe=0;0<B.level?(B.strm.data_type===2&&(B.strm.data_type=function(te){var ie,he=4093624447;for(ie=0;ie<=31;ie++,he>>>=1)if(1&he&&te.dyn_ltree[2*ie]!==0)return a;if(te.dyn_ltree[18]!==0||te.dyn_ltree[20]!==0||te.dyn_ltree[26]!==0)return i;for(ie=32;ie<g;ie++)if(te.dyn_ltree[2*ie]!==0)return i;return a}(B)),be(B,B.l_desc),be(B,B.d_desc),oe=function(te){var ie;for(l(te,te.dyn_ltree,te.l_desc.max_code),l(te,te.dyn_dtree,te.d_desc.max_code),be(te,te.bl_desc),ie=b-1;3<=ie&&te.bl_tree[2*z[ie]+1]===0;ie--);return te.opt_len+=3*(ie+1)+5+5+4,ie}(B),F=B.opt_len+3+7>>>3,(ee=B.static_len+3+7>>>3)<=F&&(F=ee)):F=ee=G+5,G+4<=F&&M!==-1?j(B,M,G,J):B.strategy===4||ee===F?(Z(B,2+(J?1:0),3),pe(B,D,_)):(Z(B,4+(J?1:0),3),function(te,ie,he,fe){var _e;for(Z(te,ie-257,5),Z(te,he-1,5),Z(te,fe-4,4),_e=0;_e<fe;_e++)Z(te,te.bl_tree[2*z[_e]+1],3);$(te,te.dyn_ltree,ie-1),$(te,te.dyn_dtree,he-1)}(B,B.l_desc.max_code+1,B.d_desc.max_code+1,oe+1),pe(B,B.dyn_ltree,B.dyn_dtree)),re(B),J&&le(B)},r._tr_tally=function(B,M,G){return B.pending_buf[B.d_buf+2*B.last_lit]=M>>>8&255,B.pending_buf[B.d_buf+2*B.last_lit+1]=255&M,B.pending_buf[B.l_buf+B.last_lit]=255&G,B.last_lit++,M===0?B.dyn_ltree[2*G]++:(B.matches++,M--,B.dyn_ltree[2*(d[G]+g+1)]++,B.dyn_dtree[2*N(M)]++),B.last_lit===B.lit_bufsize-1},r._tr_align=function(B){Z(B,2,3),H(B,S,D),function(M){M.bi_valid===16?(Y(M,M.bi_buf),M.bi_buf=0,M.bi_valid=0):8<=M.bi_valid&&(M.pending_buf[M.pending++]=255&M.bi_buf,M.bi_buf>>=8,M.bi_valid-=8)}(B)}},{"../utils/common":41}],53:[function(e,c,r){c.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,c,r){(function(s){(function(a,i){if(!a.setImmediate){var f,k,x,g,y=1,h={},b=!1,u=a.document,m=Object.getPrototypeOf&&Object.getPrototypeOf(a);m=m&&m.setTimeout?m:a,f={}.toString.call(a.process)==="[object process]"?function(w){process.nextTick(function(){v(w)})}:function(){if(a.postMessage&&!a.importScripts){var w=!0,E=a.onmessage;return a.onmessage=function(){w=!1},a.postMessage("","*"),a.onmessage=E,w}}()?(g="setImmediate$"+Math.random()+"$",a.addEventListener?a.addEventListener("message",S,!1):a.attachEvent("onmessage",S),function(w){a.postMessage(g+w,"*")}):a.MessageChannel?((x=new MessageChannel).port1.onmessage=function(w){v(w.data)},function(w){x.port2.postMessage(w)}):u&&"onreadystatechange"in u.createElement("script")?(k=u.documentElement,function(w){var E=u.createElement("script");E.onreadystatechange=function(){v(w),E.onreadystatechange=null,k.removeChild(E),E=null},k.appendChild(E)}):function(w){setTimeout(v,0,w)},m.setImmediate=function(w){typeof w!="function"&&(w=new Function(""+w));for(var E=new Array(arguments.length-1),I=0;I<E.length;I++)E[I]=arguments[I+1];var R={callback:w,args:E};return h[y]=R,f(y),y++},m.clearImmediate=p}function p(w){delete h[w]}function v(w){if(b)setTimeout(v,0,w);else{var E=h[w];if(E){b=!0;try{(function(I){var R=I.callback,A=I.args;switch(A.length){case 0:R();break;case 1:R(A[0]);break;case 2:R(A[0],A[1]);break;case 3:R(A[0],A[1],A[2]);break;default:R.apply(i,A)}})(E)}finally{p(w),b=!1}}}}function S(w){w.source===a&&typeof w.data=="string"&&w.data.indexOf(g)===0&&v(+w.data.slice(g.length))}})(typeof self>"u"?s===void 0?this:s:self)}).call(this,typeof wt<"u"?wt:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Br);var ca=Br.exports;const Dt=Jr(ca),la="1.0.0";function ua(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.version!="string"||typeof n.exportedAt!="number"||typeof n.pattern!="object"||n.pattern===null)return!1;const e=n.pattern;if(typeof e.id!="string"||typeof e.name!="string"||typeof e.bpm!="number"||typeof e.bars!="number"||!Array.isArray(e.grid)||!Array.isArray(e.drums))return!1;if(n.bgmConfig!==void 0){const c=n.bgmConfig;if(typeof c!="object"||typeof c.offsetMs!="number"||typeof c.volumePct!="number")return!1}if(n.bgmFile!==void 0){const c=n.bgmFile;if(!c||typeof c.id!="string"||typeof c.name!="string"||typeof c.size!="number"||typeof c.type!="string"||typeof c.data!="string"||typeof c.byteLength!="number"||c.data.length===0)return!1}return!0}async function da(t,n){try{let e,c=n;if(n!=null&&n.fileId){const k=await yr(n.fileId);if(k){const x=await k.blob.arrayBuffer(),y=new Uint8Array(x).reduce((b,u)=>b+String.fromCharCode(u),""),h=btoa(y);e={id:k.id,name:k.name,size:k.size,type:k.type,data:h,byteLength:x.byteLength}}else c={offsetMs:n.offsetMs,volumePct:n.volumePct}}const r={version:la,exportedAt:Date.now(),pattern:t,bgmConfig:c,bgmFile:e},s=new Dt;s.file("pattern.json",JSON.stringify(r,null,2));const a=await s.generateAsync({type:"blob"}),i=URL.createObjectURL(a),f=document.createElement("a");f.href=i,f.download=`${t.name}.zip`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(i)}catch(e){throw console.error("[Pattern Backup] Export failed:",e),e}}async function fa(t){var n,e,c;try{const s=(await Dt.loadAsync(t)).file("pattern.json");if(!s)throw new Error("Invalid pattern file: missing pattern.json");const a=await s.async("string"),i=JSON.parse(a);if(!ua(i))throw new Error("Invalid backup file: data structure validation failed");const f=i;let k;if(f.bgmConfig&&!f.bgmFile)k=void 0;else if(f.bgmFile){const x=atob(f.bgmFile.data),g=new Uint8Array(x.length);for(let u=0;u<x.length;u++)g[u]=x.charCodeAt(u);let y=f.bgmFile.type;if(!y||y===""){const u=(n=f.bgmFile.name.split(".").pop())==null?void 0:n.toLowerCase();u==="mp3"?y="audio/mpeg":u==="wav"?y="audio/wav":u==="ogg"?y="audio/ogg":u==="m4a"||u==="mp4"?y="audio/mp4":y="audio/mpeg"}const{id:h,meta:b}=await xr(f.bgmFile.data,f.bgmFile.name,y);k={fileId:h,offsetMs:((e=f.bgmConfig)==null?void 0:e.offsetMs)??0,volumePct:((c=f.bgmConfig)==null?void 0:c.volumePct)??100,meta:b}}return{pattern:f.pattern,bgmConfig:k}}catch(r){throw console.error("[Pattern Backup] Import failed:",r),r}}function ha({patterns:t,currentPatternId:n,onSelectPattern:e,onSelectDraft:c,onAddPattern:r,onImportPattern:s,onImportPatternWithBgm:a,isDraftMode:i}){const[f,k]=C.useState(!1),[x,g]=C.useState(""),y=C.useRef(null),h=C.useRef(null),b=w=>{e(w)},u=async()=>{var w;(w=h.current)==null||w.click()},m=async w=>{var I;const E=(I=w.target.files)==null?void 0:I[0];if(E){if(!E.name.endsWith(".zip")){alert("Please select a valid pattern file (.zip format)");return}try{const{pattern:R,bgmConfig:A}=await fa(E),T=JSON.stringify(R);a?a(T,A):s&&s(T),console.log("Pattern imported from zip file",{bgmConfig:A})}catch(R){console.error("Failed to import pattern:",R),alert("Failed to import pattern file. Please check the console for details.")}finally{h.current&&(h.current.value="")}}},p=()=>{x.trim()&&s&&s(x.trim()),k(!1),g("")},v=()=>{k(!1),g("")};C.useEffect(()=>{f&&y.current&&y.current.focus()},[f]);const S=[...t].sort((w,E)=>w.name.localeCompare(E.name));return o.jsxs("div",{className:"pattern-tabs",children:[o.jsx("input",{ref:h,type:"file",accept:".zip",style:{display:"none"},onChange:m}),o.jsx("button",{className:`pattern-tab draft-tab ${i?"active":""}`,onClick:c,"aria-label":"Draft Pattern",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 12 12",children:o.jsx("circle",{cx:"6",cy:"6",r:"4.5",fill:"none",stroke:"currentColor",strokeWidth:"1.5"})})}),S.length>0&&o.jsx("div",{className:"pattern-tabs-content",children:S.map(w=>{const E=!i&&w.id===n;return o.jsx("button",{className:`pattern-tab ${E?"active":""}`,onClick:()=>b(w),"aria-label":`Pattern ${w.name}`,children:w.name},w.id)})}),f?o.jsxs("div",{className:"import-input-container",children:[o.jsx("input",{ref:y,type:"text",className:"import-input",value:x,onChange:w=>g(w.target.value),onKeyDown:w=>{w.key==="Enter"?p():w.key==="Escape"&&v()},onBlur:()=>{setTimeout(()=>{x.trim()||v()},150)},placeholder:"Paste..."}),o.jsx("button",{className:"action-button confirm-button",onClick:p,"aria-label":"Confirm Import",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("polyline",{points:"20 6 9 17 4 12"})})})]}):o.jsxs(o.Fragment,{children:[o.jsx("button",{className:"action-button load-button",onClick:u,"aria-label":"Load New Pattern",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),o.jsx("button",{className:"action-button save-button",onClick:r,"aria-label":"Create New Pattern",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})}function ma({config:t,isLoading:n,isLoaded:e,error:c,onUpload:r,onOffsetChange:s,onVolumeChange:a,onDelete:i,masterVolume:f,onMasterVolumeChange:k,isPlaying:x}){var P;const g=C.useRef(null),[y,h]=C.useState(!1),[b,u]=C.useState("0"),m=N=>{const Y=Mn((t.volumePct??100)+N,0,100);a(Y)},p=N=>{const Y=Mn(f+N,0,100);k(Y)},v=N=>{const Y=(t.offsetMs??0)+N;s(Y)},S=Ie(()=>m(-10),{clickCallback:()=>m(-10)}),w=Ie(()=>m(10),{clickCallback:()=>m(10)}),E=Ie(()=>p(-10),{clickCallback:()=>p(-10)}),I=Ie(()=>p(10),{clickCallback:()=>p(10)}),R=Ie(()=>v(-100),{clickCallback:()=>v(-10)}),A=Ie(()=>v(100),{clickCallback:()=>v(10)}),T=N=>{var Z;const Y=(Z=N.target.files)==null?void 0:Z[0];Y&&r(Y),N.target.value=""},z=(((P=t.meta)==null?void 0:P.name)??"").replace(/\.[^/.]+$/,""),D=Math.round(t.volumePct??100),_=Math.round(f),d=-(t.offsetMs??0),O=Math.abs(d)>=1e3?`${(d/1e3).toFixed(3)}s`:`${d}ms`,q=Math.round(d).toString(),U=()=>{x||(u(q),h(!0))},Q=()=>{const N=Number(b);if(!Number.isFinite(N)){h(!1);return}s(-N),h(!1)},V=()=>{const N=t.volumePct??100;a(N===0?100:0)},X=()=>{k(f===0?100:0)};return o.jsxs("div",{className:"bgm-controls-container",children:[o.jsxs("div",{className:"bgm-controls",children:[o.jsxs("div",{className:"bgm-controls-left",children:[t.fileId&&e&&!n?o.jsx("button",{type:"button",className:"bgm-delete-button",onClick:i,"aria-label":"Delete background music",title:"Delete background music",disabled:!t.fileId||n,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}):o.jsxs(o.Fragment,{children:[o.jsx("button",{type:"button",className:"bgm-control-button",onClick:()=>{var N;return(N=g.current)==null?void 0:N.click()},"aria-label":"Upload background music",title:"Upload background music",disabled:n,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),o.jsx("input",{ref:g,className:"bgm-file-input",type:"file",accept:"audio/mpeg",onChange:T})]}),z&&o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"bgm-file-name",children:z||""}),o.jsxs("div",{className:"bgm-control-group",children:[o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music volume",title:"Decrease background music volume",...S,children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("div",{className:"bgm-control-center",children:o.jsx("button",{type:"button",className:"bgm-volume-display",onClick:V,"aria-label":"Toggle BGM volume",title:"Click to toggle 0%/100%",children:o.jsxs("span",{className:"bgm-control-value",children:[D,"%"]})})}),o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music volume",title:"Increase background music volume",...w,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),o.jsxs("div",{className:"bgm-control-group",children:[o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music offset",title:"Decrease background music offset",disabled:x,...A,children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("div",{className:"bgm-control-center",children:y?o.jsx("input",{type:"number",className:"bgm-offset-input",value:b,onChange:N=>u(N.target.value),onBlur:Q,onKeyDown:N=>{N.key==="Enter"?Q():N.key==="Escape"&&h(!1)},disabled:x,autoFocus:!0}):o.jsx("button",{type:"button",className:"bgm-offset-display",onClick:U,disabled:x,children:o.jsx("span",{className:"bgm-control-value",children:O})})}),o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music offset",title:"Increase background music offset",disabled:x,...R,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})]}),o.jsx("div",{className:"bgm-controls-right",children:o.jsxs("div",{className:"bgm-control-group",children:[o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease pattern volume",title:"Decrease pattern volume",...E,children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("div",{className:"bgm-control-center",children:o.jsx("button",{type:"button",className:"bgm-volume-display",onClick:X,"aria-label":"Toggle pattern volume",title:"Click to toggle 0%/100%",children:o.jsxs("span",{className:"bgm-control-value",children:[_,"%"]})})}),o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase pattern volume",title:"Increase pattern volume",...I,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})]}),c&&o.jsx("div",{className:"bgm-error",children:c})]})}function Mn(t,n,e){return Math.min(e,Math.max(n,t))}const pa=393,Dn=23.0625,ga=Xn,On=24,ba=375;function va(){const t=C.useCallback(()=>{const c=window.innerWidth;return c<ba?Dn:(Math.min(c,ga)-On)*Dn/(pa-On)},[]),[n,e]=C.useState(t);return C.useEffect(()=>{const c=()=>{e(t())};return window.addEventListener("resize",c),()=>window.removeEventListener("resize",c)},[t]),n}const ya=24,zn=23.0625;function xa(t,n=2){const e=C.useCallback(()=>{if(typeof window>"u")return zn;const s=window.innerWidth,a=Math.min(s,Xn)-ya,i=t*me;return i<=0||n<=0?zn:a/(i*n)},[t,n]),[c,r]=C.useState(e);return C.useEffect(()=>{const s=()=>{r(e())};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[e]),c}const Cr="drummer-full-practice-mode";let gt=!1;const nn=new Set;let Fn=!1;function wa(){if(typeof window>"u")return!1;const t=localStorage.getItem(Cr);if(!t)return!1;try{const n=JSON.parse(t);return typeof n=="boolean"?n:!1}catch{return!1}}function ka(){nn.forEach(t=>t())}function _a(t){ln(),gt!==t&&(gt=t,typeof window<"u"&&localStorage.setItem(Cr,JSON.stringify(t)),ka())}function ln(){Fn||typeof window>"u"||(gt=wa(),Fn=!0)}function Sa(){return ln(),gt}function Ba(){_a(!gt)}function Ca(t){return ln(),nn.add(t),()=>nn.delete(t)}function jr(){return C.useSyncExternalStore(Ca,Sa,()=>!1)}const rn=960;let Nt=!1;const sn=new Set;let Un=!1;function ja(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(orientation: landscape)").matches:window.innerWidth>window.innerHeight}function Ea(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia(`(max-width: ${rn}px)`).matches:window.innerWidth<=rn}function Ta(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(pointer: coarse)").matches:typeof navigator<"u"?navigator.maxTouchPoints>0:!1}function un(){return ja()&&Ea()&&Ta()}function Ra(){sn.forEach(t=>t())}function Er(t){Nt!==t&&(Nt=t,Ra())}function Bt(){Er(un())}function Tr(){var t;if(!(Un||typeof window>"u")){if(Nt=un(),window.addEventListener("resize",Bt),window.addEventListener("orientationchange",Bt),typeof window.matchMedia=="function"){const n=window.matchMedia(`(max-width: ${rn}px) and (orientation: landscape)`);if(typeof n.addEventListener=="function")n.addEventListener("change",Bt);else{const e=n;(t=e.addListener)==null||t.call(e,Bt)}}Un=!0}}function Ia(){return Tr(),Nt}function Aa(t){return Tr(),sn.add(t),Er(un()),()=>sn.delete(t)}function Rr(){return C.useSyncExternalStore(Aa,Ia,()=>!1)}function Wn(t){const{delay:n=500,onLongPress:e,onClick:c}=t,[r,s]=C.useState(null),a=C.useRef(null),i=C.useRef(!1),f=C.useRef(!1),k=C.useRef(0),x=C.useRef(e),g=C.useRef(c);x.current=e,g.current=c;const y=C.useCallback(()=>{i.current=!1,r&&r.classList.remove("active"),a.current&&(clearTimeout(a.current),a.current=null)},[r]),h=C.useCallback(()=>{i.current||(i.current=!0,k.current=Date.now(),f.current=!1,r&&r.classList.add("active"),a.current=setTimeout(()=>{i.current&&(f.current=!0,x.current())},n))},[n,r]),b=C.useCallback(()=>{const S=i.current,w=Date.now()-k.current,E=f.current;y(),S&&!E&&w<n&&g.current&&g.current()},[n,y]);C.useEffect(()=>{if(!r)return;const S=R=>{R.cancelable&&R.preventDefault(),h()},w=R=>{R.cancelable&&R.preventDefault(),b()},E=()=>{y()},I=R=>{R.preventDefault()};return r.addEventListener("touchstart",S,{passive:!1}),r.addEventListener("touchend",w,{passive:!1}),r.addEventListener("touchcancel",E),r.addEventListener("contextmenu",I),()=>{r.removeEventListener("touchstart",S),r.removeEventListener("touchend",w),r.removeEventListener("touchcancel",E),r.removeEventListener("contextmenu",I)}},[r,h,b,y]),C.useEffect(()=>()=>{y()},[y]);const u=C.useCallback(S=>{s(S)},[]),m=C.useCallback(S=>{S.preventDefault(),h()},[h]),p=C.useCallback(()=>{b()},[b]),v=C.useCallback(()=>{y()},[y]);return{ref:u,onMouseDown:m,onMouseUp:p,onMouseLeave:v}}async function Na(t){if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")try{return await navigator.clipboard.writeText(t),!0}catch{console.log("navigator.clipboard.writeText failed, trying fallback")}try{return Pa(t)}catch(n){return console.error("Failed to copy to clipboard:",n),!1}}function Pa(t){const n=document.createElement("textarea");if(n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="2em",n.style.height="2em",n.style.padding="0",n.style.border="none",n.style.outline="none",n.style.boxShadow="none",n.style.background="transparent",n.style.opacity="0",n.style.zIndex="-1",n.style.fontSize="16px",n.value=t,document.body.appendChild(n),/iPad|iPhone|iPod/.test(navigator.userAgent)){const r=document.createRange();r.selectNodeContents(n);const s=window.getSelection();s&&(s.removeAllRanges(),s.addRange(r)),n.setSelectionRange(0,t.length)}else n.focus(),n.select();let c=!1;try{c=document.execCommand("copy")}catch(r){console.error("execCommand copy failed:",r)}return document.body.removeChild(n),c}function La(){var e;const t=window.isSecureContext!==void 0?window.isSecureContext:location.protocol==="https:"||location.hostname==="localhost",n=!!(navigator.clipboard&&typeof navigator.clipboard.writeText=="function");return t&&n||((e=document.queryCommandSupported)==null?void 0:e.call(document,"copy"))}function Ma(t){const[n,e]=C.useState(!1),[c,r]=C.useState(""),s=C.useRef(null);C.useEffect(()=>{n&&s.current&&(s.current.focus(),s.current.select())},[n]);const a=C.useCallback(()=>{r(t),e(!0)},[t]),i=C.useCallback(()=>{e(!1),r("")},[]),f=C.useCallback(async()=>{if(La())try{if(await Na(t))return!0}catch{}return r(t),e(!0),!1},[t]);return{isExportMode:n,exportValue:c,exportInputRef:s,enterExportMode:a,cancelExport:i,tryExportToClipboard:f}}let st=null;function Da(){st!==null&&(cancelAnimationFrame(st),st=null)}function Oa(t,n,e=150,c){Da();const r=t.scrollLeft,s=n-r,a=performance.now();function i(f){const k=f-a,x=Math.min(k/e,1),g=1-Math.pow(1-x,3);t.scrollLeft=r+s*g,x<1?st=requestAnimationFrame(i):(st=null,c==null||c())}st=requestAnimationFrame(i)}function ut(t,n,e,c,r){const s={rangeStartBar:0,rangeEndBar:t.bars-1,rangeStartSub:0,rangeEndSub:r};if(!n)return s;const a=e?n.startPatternName==="":n.startPatternName===t.name,i=e?n.endPatternName==="":n.endPatternName===t.name;return{rangeStartBar:a?n.startBar:0,rangeEndBar:i?n.endBar:t.bars-1,rangeStartSub:a?n.startBar*c:0,rangeEndSub:i?(n.endBar+1)*c:r}}function za({scrollContainerRef:t,currentBeat:n,cellSize:e,pattern:c,crossPatternLoop:r,isDraftMode:s,isPlaying:a}){const i=C.useRef(!1),f=C.useRef(null),k=C.useRef(null),x=C.useRef(!1),g=C.useRef(null),y=C.useRef(null),h=c.timeSignature[0],b=C.useMemo(()=>h*me,[h]),u=C.useMemo(()=>c.bars*b,[c.bars,b]),m=C.useMemo(()=>e*me/8,[e]),p=C.useCallback((v,S)=>{f.current!==S&&(i.current||(i.current=!0,f.current=S,Oa(v,S,150,()=>{i.current=!1})))},[]);return C.useLayoutEffect(()=>{const v=t.current;if(!v)return;const S=k.current,w=c.id;if(S!==null&&S!==w){const E=ut(c,r,s,b,u),I=E.rangeStartBar*b*e;y.current=(E.rangeStartBar+1)*b,p(v,Math.max(0,I))}S!==w&&(g.current=null),k.current=w},[c.id,c,c.bars,e,b,u,t,r,s,p]),C.useEffect(()=>{if(n===void 0||!t.current)return;if(y.current!==null){if(n>=y.current)return;y.current=null}if(n>=u)return;const v=ut(c,r,s,b,u);if(n<v.rangeStartSub||n>=v.rangeEndSub)return;const S=t.current,w=n*e,E=S.scrollLeft,I=E+S.clientWidth,R=Math.floor(n/b);if(a&&g.current!==null&&R!==g.current){const A=R*b*e;p(S,Math.max(0,A)),g.current=R;return}if(g.current===null&&(g.current=R),w<E){const A=R*b*e;p(S,Math.max(0,A))}else if(w+e>I-m){if(!a){const D=R*b*e;p(S,Math.max(0,D));return}const A=ut(c,r,s,b,u);let T;R>=A.rangeEndBar?T=A.rangeStartBar:T=R+1;const z=T*b*e;p(S,Math.max(0,z))}},[n,e,a,m,p,b,u,c,c.bars,r,s,t]),C.useEffect(()=>{a||(f.current=null,x.current=!1,g.current=null)},[a,c.id]),C.useEffect(()=>{const v=t.current;if(!v)return;const S=!x.current&&a;if(x.current=a,!S||n===void 0||n>=u)return;const w=ut(c,r,s,b,u);if(n<w.rangeStartSub||n>=w.rangeEndSub)return;const E=Math.floor(n/b),I=E*b*e,R=v.scrollLeft,A=e;if(Math.abs(R-I)<=A)return;const T=n*e,z=R+v.clientWidth;if(T+e>z-m){const D=ut(c,r,s,b,u);let _;E>=D.rangeEndBar?_=D.rangeStartBar:_=E+1;const L=_*b*e;p(v,L)}else p(v,I)},[a,n,e,m,b,u,c,c.bars,r,s,t,p]),{scrollContainerRef:t,doScroll:p}}const Fa=500;function Ua({pattern:t,onCellClick:n,onToggleGhost:e,onCycleThirtySecond:c,onAddBar:r,onRemoveBar:s,onClearGrid:a,onClearBar:i,crossPatternLoop:f,onCrossPatternLoopChange:k,onSave:x,onSaveCurrentPattern:g,onImportPattern:y,onImportPatternWithBgm:h,onLoadFromSlot:b,onDeletePattern:u,onStopAllPlaying:m,onSelectDraft:p,savedPatterns:v,currentBeat:S,isPlaying:w=!1,onPlayToggle:E,isDraftMode:I,onNotationDoubleClick:R,canCopyPattern:A,hasCopiedPattern:T,canPastePattern:z,onCopyPattern:D,onPastePatternBefore:_,onPastePatternAfter:L,bgmConfig:d,bgmIsLoading:O,bgmIsLoaded:q,bgmError:U,onBgmUpload:Q,onBgmOffsetChange:V,onBgmVolumeChange:X,onBgmDelete:P,masterVolume:N,onMasterVolumeChange:Y,isCountInEnabled:Z,onCountInToggle:H,onBarBpmModeToggle:se,currentBarHasOverride:K=!1}){const re=C.useRef(null),le=C.useRef(t.bars),ce=C.useRef(!1),ue=C.useRef(void 0),pe=jr(),be=Rr(),l=va(),[$]=t.timeSignature,W=xa($,2),j=be?W:l,{doScroll:B}=za({scrollContainerRef:re,currentBeat:S,cellSize:j,pattern:t,crossPatternLoop:f,isDraftMode:I,isPlaying:w}),M=v.find(ye=>ye.id===t.id),G=M?ks(M):"",{isExportMode:J,exportValue:F,exportInputRef:ee,cancelExport:oe}=Ma(G),te=async()=>{if(M)try{await da(M,d),console.log("Pattern exported to zip file")}catch(ye){console.error("Failed to export pattern:",ye),alert("Failed to export pattern. Please check the console for details.")}},ie=C.useCallback(()=>{ce.current=!0,ue.current=S,r(S)},[r,S]),he=C.useCallback(()=>{Ba()},[]),fe=Wn({delay:500,onLongPress:te,onClick:g}),_e=Wn({delay:Fa,onLongPress:a,onClick:()=>{S!==void 0&&i(S)}});return C.useEffect(()=>{if(!ce.current||t.bars<=le.current){ce.current=!1,le.current=t.bars;return}if(!re.current||!f){ce.current=!1,le.current=t.bars;return}if(w){ce.current=!1,le.current=t.bars;return}if(I?f.endPatternName==="":f.endPatternName===t.name){const je=re.current,[De]=t.timeSignature,ge=De*me;let Te;if(ue.current!==void 0){const $e=Math.floor(ue.current/ge),Ze=ue.current%ge,at=ge/2;Ze<at?Te=$e:Te=$e+1}else Te=t.bars-1;const Ee=Te*ge*j;B(je,Ee)}ce.current=!1,le.current=t.bars},[t.bars,w,I,t.name,t.timeSignature,j,B,f]),o.jsxs("div",{className:`pattern-editor${be?" landscape-mode":""}`,children:[o.jsxs("div",{className:"pattern-editor-controls",children:[o.jsxs("div",{className:"pattern-bar-tools",children:[o.jsx(aa,{bars:t.bars,onAddBar:ie,onRemoveBar:s,canRemove:t.bars>1,currentBeat:S}),A&&o.jsx("div",{className:"pattern-copy-controls",children:T?o.jsxs(o.Fragment,{children:[o.jsx("button",{type:"button",className:"pattern-tab",onClick:_,disabled:!z,"aria-label":"Paste pattern before",title:"Paste pattern before",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 5 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),o.jsx("button",{type:"button",className:"pattern-tab",onClick:L,disabled:!z,"aria-label":"Paste pattern after",title:"Paste pattern after",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 19 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})]}):o.jsx("button",{type:"button",className:"pattern-tab",onClick:D,"aria-label":"Copy pattern grid",title:"Copy pattern grid",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),o.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})}),se&&o.jsx("button",{type:"button",className:`bar-control-button bar-bpm-button${K?" active":""}`,onClick:se,"aria-label":"Toggle bar BPM mode","aria-pressed":K,title:K?"Clear current bar BPM":"Enter bar BPM mode",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),o.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})})]}),o.jsx(ia,{currentPattern:t,savedPatterns:v,crossPatternLoop:f,onCrossPatternLoopChange:k,isDraftMode:I})]}),o.jsxs("div",{className:"pattern-editor-actions",children:[o.jsx("div",{className:"pattern-editor-actions-left",children:o.jsx(ha,{patterns:v,currentPatternId:t.id,onSelectPattern:b,onSelectDraft:p,onAddPattern:x,onImportPattern:y,onImportPatternWithBgm:h,isDraftMode:I})}),o.jsxs("div",{className:"pattern-editor-actions-right",children:[o.jsx("button",{type:"button",className:`action-button count-in-toggle-button${Z?" active":""}`,onClick:H,"aria-label":"Toggle count-in",title:"Toggle count-in","aria-pressed":Z,children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),o.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),o.jsx("button",{type:"button",className:`action-button practice-toggle-button${pe?" active":""}`,onClick:he,"aria-label":"Toggle practice mode",title:"Toggle practice mode","aria-pressed":pe,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M9 18V5l12-2v13"}),o.jsx("circle",{cx:"6",cy:"18",r:"3"}),o.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),!I&&v.some(ye=>ye.id===t.id)&&(J?o.jsx("input",{ref:ee,type:"text",className:"export-input",value:F,onChange:()=>{},onKeyDown:ye=>{ye.key==="Escape"&&oe()},onBlur:()=>{setTimeout(oe,150)},onFocus:ye=>{ye.target.select()},onClick:ye=>{ye.target.select()},onTouchEnd:ye=>{ye.target.select()}}):o.jsx("button",{className:"action-button save-current-button",...fe,"aria-label":"Save Pattern",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),o.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),o.jsx("polyline",{points:"7 3 7 8 15 8"})]})})),v.some(ye=>ye.id===t.id)&&o.jsx("button",{className:"action-button delete-button",onClick:()=>{m&&m(),setTimeout(()=>{window.confirm("Delete this pattern?")&&u(t.id)},0)},"aria-label":"Delete",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),o.jsx("button",{className:"action-button clear-button",..._e,"aria-label":"Clear (short press: clear current bar, long press: clear all)",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[o.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),o.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),pe&&o.jsx(ma,{config:d,isLoading:O,isLoaded:q,error:U,onUpload:Q,onOffsetChange:V,onVolumeChange:X,masterVolume:N,onMasterVolumeChange:Y,onDelete:P,isPlaying:w}),o.jsxs("div",{className:"pattern-editor-scrollable",ref:re,children:[o.jsx(Xo,{pattern:t,cellSize:j,currentBeat:S,scrollContainerRef:re,onDoubleClick:R}),o.jsx(oa,{pattern:t,cellSize:j}),!be&&o.jsx(sa,{pattern:t,cellSize:j,onCellClick:n,onToggleGhost:e,onCellDoubleClick:c,currentBeat:S,scrollContainerRef:re})]})]})}function Hn({isPlaying:t,onClick:n,onLongPress:e,variant:c="floating",fullPracticeMode:r=!1,isCountInEnabled:s=!1}){const a=C.useRef(null),i=C.useRef(!1),f=500,k=()=>{t||e&&(i.current=!1,a.current=window.setTimeout(()=>{e(),i.current=!0,a.current=null},f))},x=()=>{a.current&&(clearTimeout(a.current),a.current=null)},g=()=>{a.current&&(clearTimeout(a.current),a.current=null)},y=()=>{t||e&&(i.current=!1,a.current=window.setTimeout(()=>{e(),i.current=!0,a.current=null},f))},h=u=>{a.current&&(clearTimeout(a.current),a.current=null),i.current&&(u.preventDefault(),setTimeout(()=>{i.current=!1},100))},b=u=>{if(i.current){u.preventDefault(),u.stopPropagation(),i.current=!1;return}if((r||s)&&t&&e){n(),setTimeout(()=>{i.current=!1,e()},300);return}else n()};return o.jsx("div",{className:`bottom-play-button-container${c==="inline"?" inline":""}`,children:o.jsx("button",{className:`bottom-play-button${c==="inline"?" inline":""}${t?" playing":" paused"}`,onClick:b,onMouseDown:k,onMouseUp:x,onMouseLeave:g,onTouchStart:y,onTouchEnd:h,"aria-label":t?"Pause Pattern":"Play Pattern",children:t?o.jsx(o.Fragment,{children:r||s?o.jsx("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):o.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[o.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),o.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]})}):o.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})})})}const Vn="1.11.11",Gn="2601281842",Wa={name:"Dracula",colors:{bgColor:"#282a36",cardBg:"#44475a",bgSecondary:"#21222c",text:"#f8f8f2",textSecondary:"#acb8dd",textDim:"#596483",textTertiary:"#4e5771",border:"#434b62",primary:"#bd93f9",primaryHover:"#ff79c6",secondary:"#50fa7b",active:"#50fa7b",activeBg:"rgba(80, 250, 123, 0.2)",accentGlow:"rgba(189, 147, 249, 0.3)",danger:"#ff5555",dangerHover:"#ff6e6e",warning:"#f2f28c",warningHover:"#ffb86c",glassBg:"rgba(68, 71, 90, 0.5)",glassBgHover:"rgba(68, 71, 90, 0.7)",glassBorder:"rgba(139, 233, 253, 0.3)",overlayBg:"rgba(40, 42, 54, 0.9)",gridBorder:"rgba(139, 233, 253, 0.2)",gridCellBg:"#1a3a2a",gridCellBgAlt:"#1a3a2a94",beatLine:"#8be9fd"}},Ha={name:"One",colors:{bgColor:"#282c34",cardBg:"#21252b",bgSecondary:"#1e2227",text:"#c6cedd",textSecondary:"#8c96a8",textDim:"#6c768e",textTertiary:"#586178",border:"rgba(171, 178, 191, 0.2)",primary:"#61afef",primaryHover:"#7aa6f2",secondary:"#98c379",active:"#98c379",activeBg:"rgba(152, 195, 121, 0.2)",accentGlow:"rgba(97, 175, 239, 0.3)",danger:"#e06c75",dangerHover:"#ff6b7a",warning:"#d19a66",warningHover:"#e5c07b",glassBg:"rgba(33, 37, 43, 0.6)",glassBgHover:"rgba(33, 37, 43, 0.8)",glassBorder:"rgba(171, 178, 191, 0.2)",overlayBg:"rgba(40, 44, 52, 0.9)",gridBorder:"rgba(171, 178, 191, 0.15)",gridCellBg:"#1f252d",gridCellBgAlt:"#1b2027",beatLine:"#61afef"}},Va={name:"Gruvbox",colors:{bgColor:"#282828",cardBg:"#3c3836",bgSecondary:"#1d2021",text:"#ebdbb2",textSecondary:"#928374",textDim:"#7c6f64",textTertiary:"#5a5047",border:"rgba(235, 219, 178, 0.2)",primary:"#fe8019",primaryHover:"#d65e0e",secondary:"#b8bb26",active:"#b8bb26",activeBg:"rgba(184, 187, 38, 0.2)",accentGlow:"rgba(254, 128, 25, 0.3)",danger:"#fb4934",dangerHover:"#cc241d",warning:"#fabd2f",warningHover:"#d79921",glassBg:"rgba(60, 56, 54, 0.6)",glassBgHover:"rgba(60, 56, 54, 0.8)",glassBorder:"rgba(235, 219, 178, 0.2)",overlayBg:"rgba(40, 40, 40, 0.9)",gridBorder:"rgba(235, 219, 178, 0.15)",gridCellBg:"#1d2021",gridCellBgAlt:"#191b1b",beatLine:"#fe8019"}},Ga={name:"Monokai",colors:{bgColor:"#272822",cardBg:"#3e3d32",bgSecondary:"#1e1f1a",text:"#f8f8f2",textSecondary:"#a6a69c",textDim:"#75715e",textTertiary:"#5a594f",border:"rgba(248, 248, 242, 0.2)",primary:"#a6e22e",primaryHover:"#66d9ef",secondary:"#f92672",active:"#a6e22e",activeBg:"rgba(166, 226, 46, 0.2)",accentGlow:"rgba(249, 38, 114, 0.3)",danger:"#f92672",dangerHover:"#fe4e8e",warning:"#e6db74",warningHover:"#f1e8a0",glassBg:"rgba(62, 61, 50, 0.7)",glassBgHover:"rgba(62, 61, 50, 0.85)",glassBorder:"rgba(248, 248, 242, 0.15)",overlayBg:"rgba(39, 40, 34, 0.92)",gridBorder:"rgba(248, 248, 242, 0.12)",gridCellBg:"#2a2b26",gridCellBgAlt:"#21221e",beatLine:"#66d9ef"}},$a={name:"Campbell",colors:{bgColor:"#000",cardBg:"#1f1f1f",bgSecondary:"#080808",text:"#cccccc",textSecondary:"#a0a0a0",textDim:"#767676",textTertiary:"#5c5c5c",border:"rgba(204, 204, 204, 0.25)",primary:"#3a96dd",primaryHover:"#5cb3ff",secondary:"#13a10e",active:"#13a10e",activeBg:"rgba(19, 161, 14, 0.2)",accentGlow:"rgba(58, 150, 221, 0.3)",danger:"#c50f1f",dangerHover:"#e81123",warning:"#c19c00",warningHover:"#d9b812",glassBg:"rgba(31, 31, 31, 0.8)",glassBgHover:"rgba(31, 31, 31, 0.92)",glassBorder:"rgba(204, 204, 204, 0.15)",overlayBg:"rgba(12, 12, 12, 0.95)",gridBorder:"rgba(204, 204, 204, 0.1)",gridCellBg:"#121212",gridCellBgAlt:"#0a0a0a",beatLine:"#3a96dd"}},Za={name:"Solarized",colors:{bgColor:"#002b36",cardBg:"#073642",bgSecondary:"#001e26",text:"#a8bdc1",textSecondary:"#657b83",textDim:"#586e75",textTertiary:"#3d4d51",border:"rgba(131, 148, 150, 0.3)",primary:"#268bd2",primaryHover:"#2aa198",secondary:"#859900",active:"#859900",activeBg:"rgba(133, 153, 0, 0.2)",accentGlow:"rgba(38, 139, 210, 0.25)",danger:"#dc322f",dangerHover:"#cb4b16",warning:"#b58900",warningHover:"#d33682",glassBg:"rgba(7, 54, 66, 0.75)",glassBgHover:"rgba(7, 54, 66, 0.88)",glassBorder:"rgba(147, 161, 161, 0.2)",overlayBg:"rgba(0, 43, 54, 0.93)",gridBorder:"rgba(147, 161, 161, 0.15)",gridCellBg:"#093e48",gridCellBgAlt:"#08343d",beatLine:"#268bd2"}},Ka={name:"Nord",colors:{bgColor:"#2e3440",cardBg:"#3b4252",bgSecondary:"#242933",text:"#d8dee9",textSecondary:"#a3be8c",textDim:"#7b88a1",textTertiary:"#4c566a",border:"rgba(216, 222, 233, 0.2)",primary:"#88c0d0",primaryHover:"#8fbcbb",secondary:"#a3be8c",active:"#a3be8c",activeBg:"rgba(163, 190, 140, 0.2)",accentGlow:"rgba(136, 192, 208, 0.25)",danger:"#bf616a",dangerHover:"#d08770",warning:"#ebcb8b",warningHover:"#eacb8b",glassBg:"rgba(59, 66, 82, 0.7)",glassBgHover:"rgba(59, 66, 82, 0.85)",glassBorder:"rgba(129, 161, 193, 0.2)",overlayBg:"rgba(46, 52, 64, 0.92)",gridBorder:"rgba(129, 161, 193, 0.15)",gridCellBg:"#353b49",gridCellBgAlt:"#313643",beatLine:"#88c0d0"}},qa={name:"Night",colors:{bgColor:"#1a1b26",cardBg:"#24283b",bgSecondary:"#16161e",text:"#c0caf5",textSecondary:"#a9b1d6",textDim:"#737aa2",textTertiary:"#565f89",border:"rgba(192, 202, 245, 0.2)",primary:"#7aa2f7",primaryHover:"#7dcfff",secondary:"#9ece6a",active:"#9ece6a",activeBg:"rgba(158, 206, 106, 0.2)",accentGlow:"rgba(122, 162, 247, 0.25)",danger:"#f7768e",dangerHover:"#db4b4b",warning:"#e0af68",warningHover:"#ff9e64",glassBg:"rgba(36, 40, 59, 0.75)",glassBgHover:"rgba(36, 40, 59, 0.88)",glassBorder:"rgba(187, 154, 247, 0.2)",overlayBg:"rgba(26, 27, 38, 0.93)",gridBorder:"rgba(169, 177, 214, 0.12)",gridCellBg:"#1f2335",gridCellBgAlt:"#1a1e2e",beatLine:"#7aa2f7"}},Ya={name:"Rose",colors:{bgColor:"#191724",cardBg:"#26233a",bgSecondary:"#131118",text:"#e0def4",textSecondary:"#c4a7e7",textDim:"#908caa",textTertiary:"#6e6a7e",border:"rgba(224, 222, 244, 0.2)",primary:"#c4a7e7",primaryHover:"#9ccfd8",secondary:"#3e8fb0",active:"#3e8fb0",activeBg:"rgba(62, 143, 176, 0.2)",accentGlow:"rgba(196, 167, 231, 0.2)",danger:"#eb6f92",dangerHover:"#f08ba3",warning:"#f6c177",warningHover:"#fad5a0",glassBg:"rgba(38, 35, 58, 0.75)",glassBgHover:"rgba(38, 35, 58, 0.88)",glassBorder:"rgba(196, 167, 231, 0.15)",overlayBg:"rgba(25, 23, 36, 0.93)",gridBorder:"rgba(156, 207, 216, 0.12)",gridCellBg:"#1f1d2e",gridCellBgAlt:"#1c1a26",beatLine:"#c4a7e7"}},Ja={name:"Yellow",colors:{bgColor:"#2b2620",cardBg:"#3a332a",bgSecondary:"#1f1b17",text:"#f2e6d4",textSecondary:"#d4c4b0",textDim:"#a89b8a",textTertiary:"#7a6f61",border:"rgba(242, 230, 212, 0.2)",primary:"#7fb3d5",primaryHover:"#5dade2",secondary:"#a5d6a7",active:"#a5d6a7",activeBg:"rgba(165, 214, 167, 0.2)",accentGlow:"rgba(127, 179, 213, 0.25)",danger:"#e67e22",dangerHover:"#f39c12",warning:"#f9d784",warningHover:"#ffe082",glassBg:"rgba(58, 51, 42, 0.75)",glassBgHover:"rgba(58, 51, 42, 0.88)",glassBorder:"rgba(242, 230, 212, 0.15)",overlayBg:"rgba(43, 38, 32, 0.93)",gridBorder:"rgba(242, 230, 212, 0.12)",gridCellBg:"#332b24",gridCellBgAlt:"#2e2720",beatLine:"#7fb3d5"}},Ye=[Wa,Ha,Va,Ga,$a,Za,Ka,qa,Ya,Ja];function $n(t){const n=document.documentElement,e=t.colors;n.style.setProperty("--bg-color",e.bgColor),n.style.setProperty("--card-bg",e.cardBg),n.style.setProperty("--color-bg-secondary",e.bgSecondary),n.style.setProperty("--color-text",e.text),n.style.setProperty("--color-text-secondary",e.textSecondary),n.style.setProperty("--color-text-dim",e.textDim),n.style.setProperty("--color-text-tertiary",e.textTertiary),n.style.setProperty("--color-border",e.border),n.style.setProperty("--color-primary",e.primary),n.style.setProperty("--color-primary-hover",e.primaryHover),n.style.setProperty("--color-secondary",e.secondary),n.style.setProperty("--color-active",e.active),n.style.setProperty("--color-active-bg",e.activeBg),n.style.setProperty("--accent-glow",e.accentGlow),n.style.setProperty("--color-danger",e.danger),n.style.setProperty("--color-danger-hover",e.dangerHover),n.style.setProperty("--color-warning",e.warning),n.style.setProperty("--color-warning-hover",e.warningHover),n.style.setProperty("--glass-bg",e.glassBg),n.style.setProperty("--glass-bg-hover",e.glassBgHover),n.style.setProperty("--glass-border",e.glassBorder),n.style.setProperty("--overlay-bg",e.overlayBg),n.style.setProperty("--grid-border",e.gridBorder),n.style.setProperty("--grid-cell-bg",e.gridCellBg),n.style.setProperty("--grid-cell-bg-alt",e.gridCellBgAlt),n.style.setProperty("--color-beat-line",e.beatLine),n.style.setProperty("--theme-color",e.bgColor)}const Ir="drummer-theme",Xa="Dracula";function Qa(){return Ye.find(n=>n.name===Xa)||Ye[0]}function ei(){try{const t=localStorage.getItem(Ir);if(t){const n=Ye.find(e=>e.name===t);if(n)return n}}catch(t){console.warn("Failed to load theme from localStorage:",t)}return Qa()}function ti(t){try{localStorage.setItem(Ir,t)}catch(n){console.warn("Failed to save theme to localStorage:",n)}}function ni(){const[t,n]=C.useState(()=>{const c=ei();return $n(c),c});return{currentTheme:t,cycleTheme:()=>{const r=(Ye.findIndex(a=>a.name===t.name)+1)%Ye.length,s=Ye[r];n(s),$n(s),ti(s.name)},themes:Ye}}const ri="1.0.0";function si(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.version!="string"||typeof n.exportedAt!="number"||typeof n.localStorage!="object"||n.localStorage===null||!Array.isArray(n.bgmFiles))return!1;for(const e of n.bgmFiles)if(typeof e.id!="string"||typeof e.name!="string"||typeof e.size!="number"||typeof e.type!="string"||typeof e.data!="string"||typeof e.byteLength!="number"||e.data.length===0)return!1;return!0}function oi(){const t={};for(let n=0;n<localStorage.length;n++){const e=localStorage.key(n);if(e){const c=localStorage.getItem(e);c!==null&&(t[e]=c)}}return t}async function ai(){const t=await xo();return await Promise.all(t.map(async e=>{const c=await e.blob.arrayBuffer(),s=new Uint8Array(c).reduce((i,f)=>i+String.fromCharCode(f),""),a=btoa(s);return{id:e.id,name:e.name,size:e.size,type:e.type,data:a,byteLength:c.byteLength}}))}async function ii(){try{const t=oi(),n=await ai(),e={version:ri,exportedAt:Date.now(),localStorage:t,bgmFiles:n},c=new Dt;c.file("config.json",JSON.stringify(e,null,2));const r=await c.generateAsync({type:"blob"}),s=URL.createObjectURL(r),a=document.createElement("a");a.href=s;const i=new Date,f=i.toISOString().slice(0,10).replace(/-/g,""),k=i.toTimeString().slice(0,8).replace(/:/g,"");a.download=`drummer-config-${f}-${k}.zip`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}catch(t){throw console.error("[Config Backup] Export failed:",t),t}}function ci(t){localStorage.clear();for(const[n,e]of Object.entries(t))localStorage.setItem(n,e)}async function li(t){var e;await wo();const n=new Map;for(const c of t){let r=c.type;if(!r||r===""){const a=(e=c.name.split(".").pop())==null?void 0:e.toLowerCase();a==="mp3"?r="audio/mpeg":a==="wav"?r="audio/wav":a==="ogg"?r="audio/ogg":a==="m4a"||a==="mp4"?r="audio/mp4":r="audio/mpeg"}const{id:s}=await xr(c.data,c.name,r);n.set(c.id,s)}return n}function ui(t){const n="drummer-bgm-config",e=localStorage.getItem(n);if(e)try{const c=JSON.parse(e);let r=!1;for(const s of Object.values(c))s.fileId&&t.has(s.fileId)&&(s.fileId=t.get(s.fileId),r=!0);r&&localStorage.setItem(n,JSON.stringify(c))}catch{}}async function di(t){try{const e=(await Dt.loadAsync(t)).file("config.json");if(!e)throw new Error("Invalid configuration file: missing config.json");const c=await e.async("string"),r=JSON.parse(c);if(!si(r))throw new Error("Invalid backup file: data structure validation failed");const s=r;ci(s.localStorage);const a=await li(s.bgmFiles);ui(a),window.location.reload()}catch(n){throw console.error("[Config Backup] Import failed:",n),n}}function fi(){const[t,n]=C.useState(!1),[e,c]=C.useState(!1),[r,s]=C.useState("idle"),[a,i]=C.useState(!1),[f,k]=C.useState(!1),x=C.useRef(null),g=C.useRef(null),y=C.useRef(null),{currentTheme:h,cycleTheme:b}=ni(),u=C.useCallback(()=>{f||(g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{n(!1),localStorage.getItem("drummer-first-shown")||(c(!0),localStorage.setItem("drummer-first-shown","true"),y.current=setTimeout(()=>{c(!1)},1e4))},1e4))},[f]);C.useEffect(()=>()=>{g.current&&clearTimeout(g.current),y.current&&clearTimeout(y.current)},[]),C.useEffect(()=>{localStorage.getItem("drummer-visited")||(n(!0),localStorage.setItem("drummer-visited","true"))},[]),C.useEffect(()=>{const I=()=>{n(!0),c(!1)};return window.addEventListener("show-version",I),()=>{window.removeEventListener("show-version",I)}},[]),C.useEffect(()=>{if(!t){g.current&&(clearTimeout(g.current),g.current=null);return}u();const I=["mousemove","mousedown","touchstart","touchmove","keydown","click"],R=()=>{u()};return I.forEach(A=>{window.addEventListener(A,R)}),()=>{I.forEach(A=>{window.removeEventListener(A,R)}),g.current&&clearTimeout(g.current)}},[t,u]);const m=async()=>{var I,R,A;console.log("[Refresh] === handleRefresh started ==="),console.log("[Refresh] Current version:",Vn,"Build time:",Gn),console.log("[Refresh] Set status: checking"),s("checking");try{if(!("serviceWorker"in navigator)){console.log("[Refresh] ❌ Browser doesn't support ServiceWorker, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Browser supports ServiceWorker"),console.log("[Refresh] Getting ServiceWorker registration...");const T=await navigator.serviceWorker.getRegistration();if(!T){console.log("[Refresh] ❌ No registration found, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Got registration:",{scope:T.scope,active:(I=T.active)==null?void 0:I.state,waiting:(R=T.waiting)==null?void 0:R.state,installing:(A=T.installing)==null?void 0:A.state});const z=()=>{console.log("[Refresh] 🔄 controllerchange event triggered! Reloading page..."),window.location.reload()};if(navigator.serviceWorker.addEventListener("controllerchange",z,{once:!0}),console.log("[Refresh] ✓ Added controllerchange listener"),T.waiting){console.log("[Refresh] ⚡ Found waiting worker, activating directly"),console.log("[Refresh] waiting worker state:",T.waiting.state),s("activating"),console.log("[Refresh] Sending SKIP_WAITING message to waiting worker"),T.waiting.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] No waiting worker currently"),console.log("[Refresh] Set 10 second timeout");const D=setTimeout(()=>{console.log("[Refresh] ⏰ 10s timeout! Removing listener and reloading page"),navigator.serviceWorker.removeEventListener("controllerchange",z),window.location.reload()},1e4),_=()=>{console.log("[Refresh] 🎉 updatefound event triggered! New SW started installing"),s("downloading");const O=T.installing;if(!O){console.log("[Refresh] ❌ updatefound triggered but installing is null");return}console.log("[Refresh] New worker initial state:",O.state),O.addEventListener("statechange",()=>{console.log("[Refresh] New worker state changed:",O.state),O.state==="installing"&&(console.log("[Refresh] Set status: installing"),s("installing")),O.state==="installed"&&(console.log("[Refresh] New worker installation complete, set status: activating"),s("activating"),clearTimeout(D),console.log("[Refresh] Cleared timeout timer"),console.log("[Refresh] Sending SKIP_WAITING message to new worker"),O.postMessage({type:"SKIP_WAITING"}))})};T.addEventListener("updatefound",_,{once:!0}),console.log("[Refresh] ✓ Added updatefound listener"),console.log("[Refresh] Calling registration.update() to check for updates...");try{await T.update(),console.log("[Refresh] ✓ registration.update() completed")}catch(O){console.warn("[Refresh] ⚠️ Update check failed:",O)}const L=T.waiting;if(console.log("[Refresh] After update(), checking waiting:",(L==null?void 0:L.state)||"null"),L){console.log("[Refresh] ⚡ Found waiting worker after update(), activating directly"),s("activating"),clearTimeout(D),console.log("[Refresh] Sending SKIP_WAITING message"),L.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] Set 5 second no-update detection timer");const d=setTimeout(()=>{var O,q;console.log("[Refresh] ⏰ 5s check: checking for updates..."),console.log("[Refresh] installing:",((O=T.installing)==null?void 0:O.state)||"null"),console.log("[Refresh] waiting:",((q=T.waiting)==null?void 0:q.state)||"null"),!T.installing&&!T.waiting?(console.log("[Refresh] 📌 Confirmed no update, set status: no-update"),s("no-update"),clearTimeout(D),navigator.serviceWorker.removeEventListener("controllerchange",z),console.log("[Refresh] Reloading page in 1 second..."),setTimeout(()=>{console.log("[Refresh] 🔄 Executing page reload"),window.location.reload()},1e3)):console.log("[Refresh] Found installing or waiting, continuing to wait")},5e3);T.addEventListener("updatefound",()=>{console.log("[Refresh] updatefound triggered, clearing no-update detection timer"),clearTimeout(d)},{once:!0}),console.log("[Refresh] === handleRefresh initialization complete, waiting for events ===")}catch(T){console.error("[Refresh] ❌ Exception:",T),console.log("[Refresh] Reloading page due to exception"),window.location.reload()}},p=()=>{switch(r){case"checking":return"Checking...";case"downloading":return"Downloading...";case"installing":return"Installing...";case"activating":return"Activating...";case"no-update":return"Latest version";default:return`v${Vn} - ${Gn}`}},v=async()=>{if(!a)try{i(!0),await ii()}catch(I){console.error("[Settings] Export failed:",I),alert("Failed to export configuration. Please check the console for details.")}finally{i(!1)}},S=()=>{var I;(I=x.current)==null||I.click()},w=async I=>{var A;const R=(A=I.target.files)==null?void 0:A[0];if(R){if(!R.name.endsWith(".zip")){alert("Please select a valid configuration file (.zip format)");return}try{await di(R)}catch(T){console.error("[Settings] Import failed:",T),alert("Failed to import configuration. Please check the console for details.")}finally{x.current&&(x.current.value="")}}},E=r!=="idle";return o.jsxs(o.Fragment,{children:[e&&o.jsx("div",{className:"settings-first-hint visible",children:"Tap 5 times quickly to show settings"}),o.jsxs("div",{className:`settings ${t?"visible":"hidden"}`,children:[o.jsxs("div",{className:"settings-theme",onClick:b,children:[o.jsx("button",{type:"button",className:"settings-theme-button",title:`Current theme: ${h.name}. Click to cycle theme.`,children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),o.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),o.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),o.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),o.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),h.name]}),o.jsxs("div",{className:"settings-config",children:[o.jsx("input",{ref:x,type:"file",accept:".zip",style:{display:"none"},onChange:w}),o.jsx("button",{type:"button",className:"settings-config-button",onClick:S,title:"Load settings from a zip file",children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"17 8 12 3 7 8"}),o.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})}),o.jsx("button",{type:"button",className:`settings-config-button ${a?"exporting":""}`,onClick:v,title:"Export all settings to a zip file",disabled:a,children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"7 10 12 15 17 10"}),o.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),o.jsx("button",{type:"button",className:"settings-config-button",onClick:()=>k(!0),title:"About",children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),o.jsx("circle",{cx:"12",cy:"12",r:"3"})]})})]})]}),f&&o.jsx("div",{className:"settings-modal-mask",onClick:()=>k(!1),children:o.jsxs("div",{className:"settings-modal",onClick:I=>I.stopPropagation(),children:[o.jsxs("div",{className:"settings-modal-header",children:[o.jsx("h2",{children:"Drummer - Beat Maker"}),o.jsx("button",{type:"button",className:"settings-modal-close",onClick:()=>k(!1),children:o.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),o.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),o.jsxs("div",{className:"settings-modal-content",children:[o.jsx("h3",{className:"settings-modal-subtitle",children:"Features & Usage"}),o.jsx("p",{className:"settings-modal-description",children:"A step-by-step guide for first-time users. Read top to bottom to learn the full workflow and discover hidden gestures."}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Top Bar: Metronome and Tempo"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Beat dots"}),": click to cycle time signatures (4/4, 3/4, 2/4, 6/8, 5/4, 7/8)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Tempo"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click for 0.5 BPM steps, press and hold to keep changing."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"BPM number"}),": tap the left/right side of the digits to cycle speed rates (a rate label appears)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Play"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": start or stop playback. Long-press to reset the loop counter to 0."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Patterns, Bars, and Loop Range"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Tabs"}),": the circle is Draft; letter tabs are saved patterns. Click a tab to load it."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"New pattern"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": save the current draft as a new pattern tab."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Import pattern"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),": load a pattern zip file."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Bars"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": remove or add a bar (uses your cursor position when possible)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Loop range"}),": choose start/end pattern and bar; press and hold the +/- buttons to move faster."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Per-bar BPM"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),o.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})}),": click to set or clear BPM for the current bar."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Copy/Paste"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),o.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})," ","then"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 5 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 19 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),": duplicate a whole pattern grid before or after."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Grid Editor and Notation"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Single click/tap"}),": toggle a cell on or off."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Double-click/tap"}),": cycle 32nd-note states (double, first, second, back to normal)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Long-press on an active cell"}),": cycle note type (normal to ghost to grace) when supported."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Notation view"}),": double-click/tap to jump the playhead (disabled when a rate label is active)."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Action Buttons (Right Side)"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Count-in"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),o.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),": toggle a one-bar count-in before playback."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Practice mode"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M9 18V5l12-2v13"}),o.jsx("circle",{cx:"6",cy:"18",r:"3"}),o.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),": show background music and volume controls."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Play (bottom)"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": tap to play/pause. Long-press to stop and jump to the loop start."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Save current"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),o.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),o.jsx("polyline",{points:"7 3 7 8 15 8"})]})}),": save edits to the current pattern. Long-press to export a pattern zip (includes BGM)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Delete"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),": remove the current pattern."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Clear"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[o.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),o.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),": short press clears the current bar, long-press clears all bars."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Background Music (Practice Mode)"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Upload"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),": add an MP3 file, or"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})})," ","to delete it."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Volume"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click or press-and-hold to adjust. Click the % number to mute/unmute."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Offset"}),": click the ms/s value to type an exact offset (disabled while playing)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Pattern volume"}),": the right-side controls adjust drum volume (same +/- and mute behavior)."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Settings and About"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Theme"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),o.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),o.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),o.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),o.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),": click to cycle themes."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Backup and Restore"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"17 8 12 3 7 8"}),o.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"7 10 12 15 17 10"}),o.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),": import or export all settings as a zip file."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Settings"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),o.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}),": open this."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Other Settings"}),o.jsx("p",{className:"settings-modal-placeholder",children:"More feature toggles will appear here."})]})]}),o.jsx("div",{className:`settings-modal-version ${E?"updating":""}`,onClick:m,children:p()},`version-${r}`)]})})]})}let Zn=0;const hi=16;function dt(t,n,e){const c=Math.max(0,e);setTimeout(()=>{Date.now()-Zn>=hi?requestAnimationFrame(()=>{Zn=Date.now(),n(t)}):n(t)},c)}function mi({currentPattern:t,savedPatterns:n,crossPatternLoop:e,isPlaying:c,isDraftMode:r,playbackRate:s=1,onSubdivisionChange:a,onPatternChange:i,onPlayStart:f}){const k=C.useRef(0),x=C.useRef(.2),g=C.useRef(50),y=C.useRef(null),h=C.useRef(!1),b=C.useRef(0),u=C.useRef(0),m=C.useRef([]),p=C.useRef(a),v=C.useRef(i),S=C.useRef(f),w=C.useRef(t),E=C.useRef(r);p.current=a,v.current=i,S.current=f,w.current=t,E.current=r;const I=C.useRef(s);I.current=s;const R=C.useCallback((q,U)=>{let Q=q.bpm;if(U!==void 0&&q.barBpmOverrides){const[P]=q.timeSignature,N=P*me,Y=Math.floor(U/N);Q=q.barBpmOverrides[Y]??q.bpm}return 60/(Q*I.current)*(4/q.timeSignature[1])/me},[]),A=C.useCallback(q=>{const[U]=q.timeSignature;return U*me},[]),T=C.useCallback(q=>{const U=m.current;if(U.length===0)return;let Q=-1,V=q;for(let N=0;N<U.length;N++){const Y=U[N],Z=A(Y.pattern),H=Y.startBar*Z,se=(Y.endBar+1)*Z;if(q>=H&&q<se){Q=N,V=q;break}}if(Q===-1){Q=0;const N=U[0],Y=A(N.pattern);V=N.startBar*Y}if(b.current=Q,u.current=V,h.current){const N=Be();k.current=N.currentTime}const X=p.current;X&&dt(V,X,0);const P=v.current;if(P){const N=U[Q];P(N.patternName)}},[A]),z=C.useCallback(()=>{const q=[];if(!e)return q.push({patternName:r?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),q;const{startPatternName:U,startBar:Q,endPatternName:V,endBar:X}=e,P=[...n].sort((H,se)=>H.name.localeCompare(se.name)),N=r?[{name:"",pattern:t},...P.map(H=>({name:H.name,pattern:H}))]:P.map(H=>H.id===t.id?{name:H.name,pattern:t}:{name:H.name,pattern:H}),Y=N.findIndex(H=>H.name===U),Z=N.findIndex(H=>H.name===V);if(Y===-1||Z===-1)return q.push({patternName:r?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),q;for(let H=Y;H<=Z;H++){const{name:se,pattern:K}=N[H],re=H===Y?Q:0,le=H===Z?X:K.bars-1;q.push({patternName:se,pattern:K,startBar:re,endBar:le})}return q},[t,n,e,r]);C.useEffect(()=>{m.current=z()},[z]);const D=C.useCallback((q,U,Q)=>{const V=R(q,U),X=V/2,P=(N,Y,Z)=>{switch(io(Z),N){case"Kick":dr(Y);break;case"Snare":en(Y);break;case"Hi-Hat Closed":fr(Y);break;case"Hi-Hat Open":hr(Y);break;case"Crash 1":It(Y,1.2);break;case"Crash 2":It(Y,1);break;case"Ride":mr(Y);break;case"Tom 1":rt(Y,250);break;case"Tom 2":rt(Y,200);break;case"Tom 3":rt(Y,150);break}co()};q.grid.forEach((N,Y)=>{const Z=N[U];if(Z===Ce)return;const H=q.drums[Y],se=Q;if(Z===He){const re=se-V*.125;P(H,re,.5),P(H,se,1);return}if(Z===Me||Z===Fe||Z===Ue){(Z===Me||Z===Fe)&&P(H,se,1),(Z===Me||Z===Ue)&&P(H,se+X,1);return}P(H,se,Z===Pe?.3:1)})},[R]),_=C.useCallback(()=>{const q=Be();if(!h.current)return;const U=q.currentTime,Q=m.current;if(Q.length!==0)for(;k.current<U+x.current;){let V=b.current,X=u.current;if(V<0||V>=Q.length){V=0;const re=Q[0],le=A(re.pattern);X=re.startBar*le,b.current=0,u.current=X;const ce=v.current;ce&&ce(re.patternName),k.current<U&&(k.current=U);continue}const P=Q[V],N=A(P.pattern),Y=P.startBar*N,Z=(P.endBar+1)*N;if(X>=Z){if(b.current=V+1,V+1<Q.length){const re=Q[V+1],le=A(re.pattern);u.current=re.startBar*le;const ce=v.current;ce&&ce(re.patternName)}continue}X<Y&&(X=Y,u.current=Y);const H=Math.max(k.current,U),se=(H-U)*1e3;if(D(P.pattern,X,H),h.current){const re=p.current;re&&dt(X,re,se)}u.current=X+1;const K=R(P.pattern,X);k.current+=K}},[D,R,A]),L=C.useCallback(async()=>{const q=Be();if(h.current)return;q.state==="suspended"&&await q.resume(),await new Promise(Y=>requestAnimationFrame(Y)),kr(),h.current=!0;const U=q.currentTime,Q=m.current;if(Q.length===0)return;const V=S.current;V&&V(U);let X=!0;const P=b.current,N=u.current;if(P>=0&&P<Q.length){const Y=Q[P],Z=A(Y.pattern),H=Y.startBar*Z,se=(Y.endBar+1)*Z,K=N>=H&&N<se,re=Y.pattern.id===w.current.id;K&&re&&(X=!1)}if(X){const Y=w.current.id;let Z=Q.findIndex(ce=>ce.pattern.id===Y);if(Z===-1){const ce=E.current?"":w.current.name;Z=Q.findIndex(ue=>ue.patternName===ce)}Z===-1&&(Z=0);const H=Q[Z],se=A(H.pattern),K=H.startBar*se;b.current=Z,u.current=K;const re=v.current;re&&re(H.patternName);const le=p.current;le&&dt(K,le,0)}else{const Y=p.current;Y&&dt(N,Y,0)}k.current=U,_(),y.current=window.setInterval(_,g.current)},[_,A]),d=C.useCallback(()=>{h.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),tn()},[]);C.useEffect(()=>(c?L():d(),()=>{d()}),[c,L,d]);const O=C.useCallback(()=>{const q=m.current;if(q.length===0)return;h.current&&(h.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),tn());const U=q[0],Q=A(U.pattern),V=U.startBar*Q;b.current=0,u.current=V;const X=p.current;X&&dt(V,X,0);const P=v.current;P&&P(U.patternName)},[A]);return{seekTo:T,resetToRangeStart:O}}function pi(t,n,e){if(!n)return!1;const{startPatternName:c,endPatternName:r}=n;if(c===r)return!1;const a=["",...e.map(x=>x.name).sort((x,g)=>x.localeCompare(g))],i=a.indexOf(c),f=a.indexOf(r),k=a.indexOf(t);return k>=i&&k<=f}function Ct(t,n,e,c,r){t&&n(!1),e&&c(!1),r()}function gi(){const{isLoading:t,loadingProgress:n,showProgress:e}=fo(),{isMetronomePlaying:c,isPatternPlaying:r,toggleMetronomePlay:s,togglePatternPlay:a,stopAll:i,setIsMetronomePlaying:f,setIsPatternPlaying:k}=go(),x=jr(),g=Rr(),[y,h]=C.useState(0),[b,u]=C.useState([]),[m,p]=C.useState(!0),v=C.useRef(null),S=C.useRef(null),[w,E]=C.useState(0),[I,R]=C.useState(()=>Sn()??ft),[A,T]=C.useState(Yt),[z,D]=C.useState(0),[_,L]=C.useState(!1),[d,O]=C.useState(!1),[q,U]=C.useState(0),[Q,V]=C.useState(0),X=C.useRef(null),[P,N]=C.useState(null),[Y,Z]=C.useState(!1),[H,se]=C.useState(()=>xs()??{startPatternName:"",startBar:0,endPatternName:"",endBar:Rt-1}),{pattern:K,updateBPM:re,updateBarBpm:le,toggleCell:ce,toggleGhost:ue,cycleThirtySecond:pe,addBar:be,removeBar:l,clearGrid:$,clearBar:W,insertPatternGrid:j,loadPattern:B,resetPattern:M}=Ss(rr()),[G,J]=C.useState(()=>ct(K.id)),[F,ee]=C.useState({isLoading:!1,error:null}),[oe,te]=C.useState(()=>ko()),ie=it(z),he=()=>{X.current&&(clearTimeout(X.current),X.current=null),d&&O(!1)};C.useEffect(()=>()=>{X.current&&clearTimeout(X.current)},[]);const fe=(ne,ae=!0)=>{var de;if(y!==void 0){const[ve]=K.timeSignature,xe=ve*me,ke=Math.floor(y/xe),Xe=((de=K.barBpmOverrides)==null?void 0:de[ke])!==void 0;if(Y||Xe){ae&&le(ke,ne),R(ne);return}}R(ne),ae&&(ze(ne),re(ne))},_e=ne=>{T(ne)},ye=()=>{var xe;if(y===void 0)return;const[ne]=K.timeSignature,ae=ne*me,de=Math.floor(y/ae);((xe=K.barBpmOverrides)==null?void 0:xe[de])!==void 0?(le(de,null),R(K.bpm),Z(!1)):(le(de,K.bpm),Z(!0))},je=()=>{Ct(r,k,c,f,he),D(0),Z(!1),p(!0),Oe(void 0),M(),R(ft),ze(ft),re(ft),se({startPatternName:"",startBar:0,endPatternName:"",endBar:Rt-1})};C.useEffect(()=>{const ne=Qe();u(ne);const ae=vs();if(ae){const de=ne.find(ve=>ve.id===ae);if(de){p(!1),B(de);const ve=Sn();ve!==null?R(ve):(R(de.bpm),ze(de.bpm))}else Oe(void 0)}},[]),C.useEffect(()=>{J(ct(K.id))},[K.id]),C.useEffect(()=>{lo(x?oe:100)},[x,oe]),C.useEffect(()=>{ys(H)},[H]);const De=(()=>{if(y===void 0||!K.barBpmOverrides)return!1;const[ne]=K.timeSignature,ae=ne*me,de=Math.floor(y/ae);return K.barBpmOverrides[de]!==void 0})();C.useEffect(()=>{var ke,Xe;if(y===void 0)return;const[ne]=K.timeSignature,ae=ne*me,de=Math.floor(y/ae),ve=((ke=K.barBpmOverrides)==null?void 0:ke[de])!==void 0,xe=it(z);if(Y||ve){const qr=(((Xe=K.barBpmOverrides)==null?void 0:Xe[de])??K.bpm)*xe;R(qr)}else{const pn=K.bpm*xe;R(pn)}},[Y,y,K.timeSignature,K.barBpmOverrides,K.bpm,z]),uo({isMetronomePlaying:c,isPatternPlaying:r,setIsMetronomePlaying:f,setIsPatternPlaying:k}),Bs(c,r),po(),C.useEffect(()=>{const ne=ae=>(ae.preventDefault(),!1);return document.body.addEventListener("contextmenu",ne),()=>{document.body.removeEventListener("contextmenu",ne)}},[]),C.useEffect(()=>{const ne=de=>{de.touches.length>1&&de.preventDefault()},ae=de=>{de.preventDefault()};return document.body.addEventListener("touchmove",ne,{passive:!1}),document.body.addEventListener("gesturestart",ae,{passive:!1}),()=>{document.body.removeEventListener("touchmove",ne),document.body.removeEventListener("gesturestart",ae)}},[]);const ge=ne=>{if(ne===""){p(!0),Oe(void 0);const ae=it(z),de=K.bpm*ae;R(de),ze(K.bpm)}else{const ae=b.find(de=>de.name===ne);if(ae&&ae.id!==K.id){p(!1),B(ae),Oe(ae.id);const de=it(z),ve=ae.bpm*de;R(ve),ze(ae.bpm)}}},{seekTo:Te,resetToRangeStart:Ge}=mi({currentPattern:K,savedPatterns:b,crossPatternLoop:H,isPlaying:r,isDraftMode:m,playbackRate:ie,onSubdivisionChange:h,onPatternChange:ge,onPlayStart:()=>{E(ne=>ne+1)}}),Ee=()=>{Ge(),Ct(r,k,c,f,he)},$e=C.useMemo(()=>{if(!H)return 0;const ne=m?"":K.name;return H.startPatternName===ne?H.startBar:0},[H,m,K.name]),Ze=So({isPlaying:r,isFullPracticeMode:x,playbackRate:ie,bgmConfig:G,currentSubdivision:y,pattern:K,patternStartToken:w,rangeStartBar:$e});C.useEffect(()=>{if(!H)return;const ne=m?"":K.name;if(H.startPatternName!==ne||v.current===H.startBar&&S.current===H.startPatternName)return;const[ae]=K.timeSignature,de=ae*me;Te(H.startBar*de),v.current=H.startBar,S.current=H.startPatternName},[H,m,K.name,K.timeSignature,Te]);const at=F.isLoading||Ze.isLoading,Ot=Ze.isLoaded,xt=F.error??Ze.error,Ke=ne=>{z===0&&Te(ne)},Je=()=>{m||N({grid:K.grid.map(ne=>ne.slice()),bars:K.bars,timeSignature:K.timeSignature,drums:K.drums,bpm:K.bpm,barBpmOverrides:K.barBpmOverrides?{...K.barBpmOverrides}:void 0})},dn=(()=>P?P.timeSignature[0]===K.timeSignature[0]&&P.timeSignature[1]===K.timeSignature[1]&&P.drums.length===K.drums.length:!1)(),fn=ne=>{if(m||!P||!dn)return;Ct(r,k,c,f,he);const ae=ne==="before"?0:K.bars;j(ae,P),N(null)},Ar=ne=>ne===""&&m||ne===K.name?K:b.find(de=>de.name===ne)??K,Nr=H?H.startPatternName:m?"":K.name,hn=Ar(Nr),mn=Math.max(1,hn.bpm*ie),zt=hn.timeSignature,Pr=Math.round(60/mn*(4/zt[1])*zt[0]*1e3),{currentBeat:Lr}=_r({bpm:mn,timeSignature:zt,isPlaying:d,resetToken:q}),Mr=()=>{L(ne=>{const ae=!ne;return ae||he(),ae})},Ft=()=>{if(d){he();return}if(r){k(!1);return}if(!_){a();return}c&&f(!1),Ge(),U(ne=>ne+1),O(!0),X.current=window.setTimeout(()=>{O(!1),V(ne=>ne+1),k(!0)},Pr-50)},Dr=()=>{he(),i()},Or=()=>{if(m)return;const ne={...K,updatedAt:Date.now()};kt(ne),u(Qe())},zr=()=>{const ne=Ut(b),ae=K.id,de=ct(ae),ve={...K,id:jt(),name:ne,updatedAt:Date.now()};kt(ve),(de.fileId||de.offsetMs!==0||de.volumePct!==100)&&(et(ve.id,de),En(ae)),p(!1),Oe(ve.id),B(ve),u(Qe())},Fr=ne=>{Ct(r,k,c,f,he);const ae=pi(ne.name,H,b);if(ae||D(0),Z(!1),p(!1),B(ne),Oe(ne.id),ae&&z>0){const de=it(z),ve=ne.bpm*de;R(ve),ze(ne.bpm)}else R(ne.bpm),ze(ne.bpm);ae||se({startPatternName:ne.name,startBar:0,endPatternName:ne.name,endBar:ne.bars-1})},Ur=ne=>{he(),(async()=>{const de=ct(ne);de.fileId&&await Zt(de.fileId),En(ne)})(),bs(ne),K.id===ne&&(p(!0),M(),Oe(void 0)),u(Qe())},Wr=async ne=>{if(!(ne.type==="audio/mpeg"||ne.name.toLowerCase().endsWith(".mp3"))){ee({isLoading:!1,error:"Please upload an MP3 file."});return}ee({isLoading:!0,error:null});try{G.fileId&&await Zt(G.fileId);const{id:de,meta:ve}=await vr(ne),xe={fileId:de,offsetMs:G.offsetMs??0,volumePct:G.volumePct??100,meta:ve};et(K.id,xe),J(xe),ee({isLoading:!1,error:null})}catch(de){ee({isLoading:!1,error:de instanceof Error?de.message:"Failed to upload background music."})}},Hr=C.useCallback(ne=>{const ae={...G,offsetMs:ne};et(K.id,ae),J(ae)},[G,K.id]),Vr=C.useCallback(ne=>{const ae={...G,volumePct:ne};et(K.id,ae),J(ae)},[G,K.id]),Gr=ne=>{te(ne),_o(ne)},$r=()=>{(async()=>{G.fileId&&await Zt(G.fileId);const ae={offsetMs:0,volumePct:100};et(K.id,ae),J(ae)})()},Zr=ne=>{const ae=Bn(ne);if(!ae){console.log("Invalid pattern data");return}const de=Ut(b),ve=Date.now(),xe={...ae,id:jt(),name:de,createdAt:ve,updatedAt:ve};kt(xe),p(!1),B(xe),Oe(xe.id),R(xe.bpm),ze(xe.bpm),re(xe.bpm),u(Qe()),se({startPatternName:xe.name,startBar:0,endPatternName:xe.name,endBar:xe.bars-1})},Kr=(ne,ae)=>{const de=Bn(ne);if(!de){console.log("Invalid pattern data");return}const ve=Ut(b),xe=Date.now(),ke={...de,id:jt(),name:ve,createdAt:xe,updatedAt:xe};if(kt(ke),p(!1),B(ke),Oe(ke.id),R(ke.bpm),ze(ke.bpm),re(ke.bpm),u(Qe()),ae&&ae.fileId){et(ke.id,{fileId:ae.fileId,offsetMs:ae.offsetMs,volumePct:ae.volumePct,meta:ae.meta});const Xe=ct(ke.id);J(Xe)}se({startPatternName:ke.name,startBar:0,endPatternName:ke.name,endBar:ke.bars-1})};if(t){const ne=Math.round(n.loaded/n.total*100);return o.jsx("div",{className:"app loading",children:o.jsx("div",{className:"loading-container",children:e&&o.jsx("div",{className:"loading-progress",children:o.jsx("div",{className:"loading-progress-bar",children:o.jsx("div",{className:"loading-progress-fill",style:{width:`${ne}%`}})})})})})}return o.jsxs("div",{className:"app",children:[o.jsx(To,{bpm:I,timeSignature:A,isPlaying:r,resetToken:Q,onBPMChange:fe,isPatternPlaying:c,isCountInPlaying:d,countInBeat:Lr,onPatternPlayToggle:s,onTimeSignatureChange:_e,rateIndex:z,onRateIndexChange:D,rates:Qn,rateLabels:hs,patternPlayButton:g?o.jsx(Hn,{variant:"inline",isPlaying:r,onClick:Ft,onLongPress:Ee,fullPracticeMode:x,isCountInEnabled:_}):void 0}),o.jsx("main",{className:"app-main",children:o.jsx(Ua,{pattern:K,onCellClick:ce,onToggleGhost:ue,onCycleThirtySecond:pe,onAddBar:be,onRemoveBar:l,onClearGrid:$,onClearBar:W,crossPatternLoop:H,onCrossPatternLoopChange:se,onSave:zr,onSaveCurrentPattern:Or,onImportPattern:Zr,onImportPatternWithBgm:Kr,onLoadFromSlot:Fr,onDeletePattern:Ur,onStopAllPlaying:Dr,onSelectDraft:je,savedPatterns:b,currentBeat:y,isPlaying:r,onPlayToggle:Ft,isDraftMode:m,onNotationDoubleClick:Ke,canCopyPattern:!m,hasCopiedPattern:!!P,canPastePattern:dn,onCopyPattern:Je,onPastePatternBefore:()=>fn("before"),onPastePatternAfter:()=>fn("after"),bgmConfig:G,bgmIsLoading:at,bgmIsLoaded:Ot,bgmError:xt,onBgmUpload:Wr,onBgmOffsetChange:Hr,onBgmVolumeChange:Vr,onBgmDelete:$r,masterVolume:oe,onMasterVolumeChange:Gr,isCountInEnabled:_,onCountInToggle:Mr,onBarBpmModeToggle:ye,currentBarHasOverride:De})}),!g&&o.jsx(Hn,{isPlaying:r,onClick:Ft,onLongPress:Ee,fullPracticeMode:x,isCountInEnabled:_}),o.jsx(fi,{})]})}qt.createRoot(document.getElementById("root")).render(o.jsx(Xr.StrictMode,{children:o.jsx(gi,{})}));

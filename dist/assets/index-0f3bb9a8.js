import{r as B,a as ns,c as _t,g as rs,R as ss}from"./react-vendor-8a332d8f.js";import{s as Xn,G as we,O as it,P as os,N as Ot,F as Dt,g as as,a as wn,b as is}from"./audio-libs-2901efa1.js";import{S as Qn,A as st,D as cs,R as kn,a as ls,B as us,V as _n,F as ds,b as Sn,c as Bn}from"./graphics-libs-bbd9a815.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();var er={exports:{}},zt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var fs=B,hs=Symbol.for("react.element"),ms=Symbol.for("react.fragment"),ps=Object.prototype.hasOwnProperty,gs=fs.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,bs={key:!0,ref:!0,__self:!0,__source:!0};function tr(t,n,e){var o,s={},r=null,i=null;e!==void 0&&(r=""+e),n.key!==void 0&&(r=""+n.key),n.ref!==void 0&&(i=n.ref);for(o in n)ps.call(n,o)&&!bs.hasOwnProperty(o)&&(s[o]=n[o]);if(t&&t.defaultProps)for(o in n=t.defaultProps,n)s[o]===void 0&&(s[o]=n[o]);return{$$typeof:hs,type:t,key:r,ref:i,props:s,_owner:gs.current}}zt.Fragment=ms;zt.jsx=tr;zt.jsxs=tr;er.exports=zt;var a=er.exports,Xt={},Cn=ns;Xt.createRoot=Cn.createRoot,Xt.hydrateRoot=Cn.hydrateRoot;const jn={"Crash 1":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Crash 2":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Hi-Hat Open":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Hi-Hat Closed":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},Ride:{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Tom 1":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Tom 2":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},Snare:{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Tom 3":{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},Kick:{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0}},je=0,Te=1,Pe=2,Ge=3,Me=4,Fe=5,Ue=6,En=["Crash 1","Crash 2","Hi-Hat Open","Hi-Hat Closed","Ride","Tom 1","Tom 2","Snare","Tom 3","Kick"],mt=120,Qt=[4,4],It=1,he=4,nr=700,vs={"Crash 1":{position:"above",symbol:"x",line:-2.5},"Crash 2":{position:"above",symbol:"o",line:-2},"Hi-Hat Open":{position:"above",symbol:"o",line:-1.5},"Hi-Hat Closed":{position:"above",symbol:"x",line:-1.5},Ride:{position:"above",symbol:"x",line:-1},"Tom 1":{position:"center",symbol:"●",line:-.5},"Tom 2":{position:"center",symbol:"●",line:0},Snare:{position:"center",symbol:"●",line:.5},"Tom 3":{position:"below",symbol:"●",line:1.5},Kick:{position:"below",symbol:"●",line:2.5}},rr=[9/10,8/9,7/8,6/7,5/6,2],ys=["","x0.9","x0.8","x0.7","x0.6","x0.5"];function lt(t,n=rr){let e=1;for(let o=0;o<t;o++)e*=n[o%n.length];return e}const sr="drummer-app-data",or="drummer-metronome-bpm",en="drummer-cross-pattern-loop",ar="drummer-sample-selection",xs="vexflow",ir=new Set([je,Te,Pe,Ge,Me,Fe,Ue]);function ws(t){return t.map(n=>n.map(e=>typeof e=="boolean"?e?Te:je:typeof e=="number"&&ir.has(e)?e:je))}function ks(t){return t.grid.length>0&&t.grid[0].length>0&&typeof t.grid[0][0]=="boolean"?{...t,grid:ws(t.grid)}:t}function yt(){try{const t=localStorage.getItem(sr);if(t){const n=JSON.parse(t);return n.patterns=n.patterns.map(ks),n}}catch(t){console.error("Failed to load storage data:",t)}return{patterns:[]}}function un(t){try{localStorage.setItem(sr,JSON.stringify(t))}catch(n){console.error("Failed to save storage data:",n)}}function St(t){const n=yt(),e=n.patterns.findIndex(o=>o.id===t.id);e>=0?n.patterns[e]=t:n.patterns.push(t),un(n)}function tt(){return yt().patterns}function _s(t){const n=yt();n.patterns=n.patterns.filter(e=>e.id!==t),n.currentPatternId===t&&(n.currentPatternId=void 0),un(n)}function Ss(){return yt().currentPatternId}function De(t){const n=yt();n.currentPatternId=t,un(n)}function Tt(){return`pattern-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ze(t){try{localStorage.setItem(or,String(t))}catch(n){console.error("Failed to save metronome BPM:",n)}}function Tn(){try{localStorage.removeItem("metronome_bpm");const t=localStorage.getItem(or);if(t){const n=parseInt(t,10);if(!isNaN(n)&&n>=20&&n<=300)return n}}catch(t){console.error("Failed to load metronome BPM:",t)}return null}function Bs(t){try{t===void 0?localStorage.removeItem(en):localStorage.setItem(en,JSON.stringify(t))}catch(n){console.error("Failed to save cross pattern loop:",n)}}function Cs(){try{const t=localStorage.getItem(en);if(t){const n=JSON.parse(t);if(typeof n=="object"&&typeof n.startPatternName=="string"&&typeof n.startBar=="number"&&typeof n.endPatternName=="string"&&typeof n.endBar=="number"&&n.startBar>=0&&n.endBar>=0)return n}}catch(t){console.error("Failed to load cross pattern loop:",t)}}function js(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.id!="string"||n.id.length===0||typeof n.name!="string"||n.name.length===0||typeof n.bpm!="number"||n.bpm<20||n.bpm>300||!Array.isArray(n.timeSignature)||n.timeSignature.length!==2||typeof n.timeSignature[0]!="number"||typeof n.timeSignature[1]!="number"||typeof n.bars!="number"||n.bars<1||n.bars>100||!Array.isArray(n.grid))return!1;for(const e of n.grid){if(!Array.isArray(e))return!1;for(const o of e)if(typeof o!="number"||!ir.has(o))return!1}if(!Array.isArray(n.drums))return!1;for(const e of n.drums)if(typeof e!="string")return!1;if(typeof n.createdAt!="number"||typeof n.updatedAt!="number"||n.loopRange!==void 0&&(!Array.isArray(n.loopRange)||n.loopRange.length!==2||typeof n.loopRange[0]!="number"||typeof n.loopRange[1]!="number"))return!1;if(n.barBpmOverrides!==void 0){if(typeof n.barBpmOverrides!="object"||n.barBpmOverrides===null)return!1;for(const[e,o]of Object.entries(n.barBpmOverrides)){const s=parseInt(e,10);if(isNaN(s)||s<0||typeof o!="number"||o<20||o>300)return!1}}return!0}function Rn(t){try{const n=JSON.parse(t);if(js(n))return n}catch{}return null}function Es(t){return JSON.stringify(t)}function Vt(t){const n=t.map(o=>o.name).filter(o=>/^[A-Z]$/.test(o));let e="A";if(n.length>0){const o=n.map(r=>r.charCodeAt(0)),s=Math.max(...o);if(s<90)e=String.fromCharCode(s+1);else for(let r=65;r<=90;r++)if(!o.includes(r)){e=String.fromCharCode(r);break}}return e}function An(){return xs}function Ts(t){try{localStorage.setItem(ar,JSON.stringify(t))}catch(n){console.error("Failed to save sample selection:",n)}}function dn(){try{const t=localStorage.getItem(ar);if(t){const n=JSON.parse(t),e=new Set(["A","B","C"]),o={};for(const[s,r]of Object.entries(n))e.has(r)&&(o[s]=r);return o}}catch(t){console.error("Failed to load sample selection:",t)}return{}}function Je(t){return dn()[t]||"A"}function Rs(t,n){const e=dn();e[t]=n,Ts(e)}function cr(t="New Pattern"){const n=Qt[0],e=It*n*he;return{id:Tt(),name:t,bpm:mt,timeSignature:Qt,bars:It,grid:Array(En.length).fill(null).map(()=>Array(e).fill(je)),drums:En,createdAt:Date.now(),updatedAt:Date.now()}}const As=t=>t===Me||t===Fe||t===Ue;function Gt(t,n,e,o){if(!t)return;const s={};for(const[r,i]of Object.entries(t)){const c=parseInt(r,10);c!==o&&(c>=n?s[c+e]=i:s[c]=i)}return Object.keys(s).length>0?s:void 0}function Ns(t){const[n,e]=B.useState(t),o=B.useCallback(l=>{e(p=>({...p,bpm:l,updatedAt:Date.now()}))},[]),s=B.useCallback((l,p)=>{e(m=>{const b={...m.barBpmOverrides};p===null?delete b[l]:b[l]=p;const S=Object.keys(b).length>0;return{...m,barBpmOverrides:S?b:void 0,updatedAt:Date.now()}})},[]),r=B.useCallback((l,p)=>{e(m=>{const b=m.grid.map((S,k)=>{if(k===l){const E=[...S];return E[p]=E[p]===je?Te:je,E}return S});return{...m,grid:b,updatedAt:Date.now()}})},[]),i=B.useCallback((l,p)=>{e(m=>{var L;const b=(L=m.grid[l])==null?void 0:L[p];if(b===je||As(b))return m;const S=m.drums[l],k=jn[S],E=m.grid.map((P,T)=>{if(T===l){const N=[...P];let D;return b===Te?D=k.allowGhost?Pe:Te:b===Pe?D=k.allowGrace?Ge:Te:D=Te,N[p]=D,N}return P});return{...m,grid:E,updatedAt:Date.now()}})},[]),c=B.useCallback((l,p)=>{e(m=>{var P;const b=(P=m.grid[l])==null?void 0:P[p],S=m.drums[l];if(!jn[S].allowThirtySecond){if(b===je){const T=m.grid.map((N,D)=>{if(D===l){const M=[...N];return M[p]=Te,M}return N});return{...m,grid:T,updatedAt:Date.now()}}return m}let E;b===Te||b===Pe||b===Ge?E=Me:b===Me?E=Fe:b===Fe?E=Ue:E=Te;const L=m.grid.map((T,N)=>{if(N===l){const D=[...T];return D[p]=E,D}return T});return{...m,grid:L,updatedAt:Date.now()}})},[]),h=B.useCallback(l=>{e(p=>{var D;const[m]=p.timeSignature,b=m*he;let S,k;if(l!==void 0){const M=Math.floor(l/b),w=l%b,A=b/2;w<A?(S=M,k=M):(S=M+1,k=M)}else S=p.bars,k=p.bars-1;const E=k*b,L=E+b,P=p.grid.map(M=>{const w=M.slice(E,L),A=[...M];return A.splice(S*b,0,...w),A});let T=Gt(p.barBpmOverrides,S,1);const N=(D=p.barBpmOverrides)==null?void 0:D[k];return N!==void 0&&(T=T??{},T[S]=N),{...p,bars:p.bars+1,grid:P,barBpmOverrides:T,updatedAt:Date.now()}})},[]),_=B.useCallback(l=>{e(p=>{if(p.bars<=1)return p;const[m]=p.timeSignature,b=m*he;let S;if(l!==void 0){const P=Math.floor(l/b),T=l%b,N=b/2;T<N,S=P}else S=p.bars-1;const k=S*b,E=p.grid.map(P=>{const T=[...P];return T.splice(k,b),T}),L=Gt(p.barBpmOverrides,S+1,-1,S);return{...p,bars:p.bars-1,grid:E,barBpmOverrides:L,loopRange:p.loopRange&&p.loopRange[1]>=p.bars-1?[p.loopRange[0],p.bars-2]:p.loopRange,updatedAt:Date.now()}})},[]),x=B.useCallback(()=>{e(l=>{const p=l.grid.map(m=>m.map(()=>je));return{...l,grid:p,updatedAt:Date.now()}})},[]),v=B.useCallback(l=>{e(p=>{const[m]=p.timeSignature,b=m*he,k=Math.floor(l/b)*b,E=k+b,L=p.grid.map(P=>{const T=[...P];for(let N=k;N<E;N++)T[N]=je;return T});return{...p,grid:L,updatedAt:Date.now()}})},[]),y=B.useCallback((l,p)=>{e(m=>{var D;if(p.bars<=0||p.grid.length!==m.drums.length||p.timeSignature[0]!==m.timeSignature[0]||p.timeSignature[1]!==m.timeSignature[1])return m;const[b]=m.timeSignature,S=b*he,k=Math.max(0,Math.min(m.bars,l)),E=k*S,L=p.bars*S;if(p.grid.some(M=>M.length!==L))return m;const P=m.grid.map((M,w)=>{const A=p.grid[w],d=[...M];return d.splice(E,0,...A),d}),T=p.bpm!==m.bpm;let N=Gt(m.barBpmOverrides,k,p.bars);for(let M=0;M<p.bars;M++){const w=(D=p.barBpmOverrides)==null?void 0:D[M];w!==void 0?(N=N??{},N[k+M]=w):T&&(N=N??{},N[k+M]=p.bpm)}return{...m,bars:m.bars+p.bars,grid:P,barBpmOverrides:N,updatedAt:Date.now()}})},[]),f=B.useCallback(l=>{e(l)},[]),g=B.useCallback(()=>{e(cr())},[]);return{pattern:n,updateBPM:o,updateBarBpm:s,toggleCell:r,toggleGhost:i,cycleThirtySecond:c,addBar:h,removeBar:_,clearGrid:x,clearBar:v,insertPatternGrid:y,loadPattern:f,resetPattern:g}}function Is(t,n){const e=B.useRef(t),o=B.useRef(n);B.useEffect(()=>{e.current=t},[t]),B.useEffect(()=>{o.current=n},[n]),B.useEffect(()=>{const s=r=>{if(e.current||o.current)return r.preventDefault(),r.returnValue="",""};return window.addEventListener("beforeunload",s),()=>{window.removeEventListener("beforeunload",s)}},[])}const Ps="drummer-audio-cache",Ls=1,Ae="audio-buffers",lr="cache-version",$t="1.0.0";async function xt(){return new Promise((t,n)=>{const e=indexedDB.open(Ps,Ls);e.onerror=()=>n(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=o=>{const s=o.target.result;s.objectStoreNames.contains(Ae)||s.createObjectStore(Ae,{keyPath:"name"})}})}function Ms(t){const n=[];for(let e=0;e<t.numberOfChannels;e++)n.push(t.getChannelData(e));return{numberOfChannels:t.numberOfChannels,length:t.length,sampleRate:t.sampleRate,channelData:n}}function Os(t,n){const e=t.createBuffer(n.numberOfChannels,n.length,n.sampleRate);for(let o=0;o<n.numberOfChannels;o++)e.getChannelData(o).set(n.channelData[o]);return e}async function Ds(t,n){try{const e=await xt(),s=e.transaction(Ae,"readwrite").objectStore(Ae),r=Ms(n);await new Promise((i,c)=>{const h=s.put({name:t,data:r});h.onsuccess=()=>i(),h.onerror=()=>c(h.error)}),e.close()}catch(e){console.warn(`Failed to cache audio buffer "${t}":`,e)}}async function zs(t,n){try{const e=await xt(),s=e.transaction(Ae,"readonly").objectStore(Ae),r=await new Promise((i,c)=>{const h=s.get(n);h.onsuccess=()=>i(h.result),h.onerror=()=>c(h.error)});return e.close(),r?Os(t,r.data):null}catch(e){return console.warn(`Failed to get cached audio buffer "${n}":`,e),null}}async function Fs(){try{const t=await xt(),e=t.transaction(Ae,"readwrite").objectStore(Ae);await new Promise((o,s)=>{const r=e.clear();r.onsuccess=()=>o(),r.onerror=()=>s(r.error)}),t.close()}catch(t){console.warn("Failed to clear audio cache:",t)}}async function Us(){try{const t=await xt(),e=t.transaction(Ae,"readonly").objectStore(Ae),o=await new Promise((s,r)=>{const i=e.get(lr);i.onsuccess=()=>s(i.result),i.onerror=()=>r(i.error)});return t.close(),o?o.version:null}catch(t){return console.warn("Failed to get cache version:",t),null}}async function Hs(t){try{const n=await xt(),o=n.transaction(Ae,"readwrite").objectStore(Ae);await new Promise((s,r)=>{const i=o.put({name:lr,version:t});i.onsuccess=()=>s(),i.onerror=()=>r(i.error)}),n.close()}catch(n){console.warn("Failed to set cache version:",n)}}async function Ws(){try{const t=await Us();t!==$t&&(console.log(`Cache version mismatch. Expected: ${$t}, Found: ${t}. Clearing cache...`),await Fs(),await Hs($t))}catch(t){console.warn("Failed to check cache version:",t)}}const Vs="/drummer/assets/kick-f5f64180.mp3",Gs="/drummer/assets/snare-8dad42f7.mp3",$s="/drummer/assets/hi-hat-closed-20faf03a.mp3",Zs="/drummer/assets/hi-hat-open-c13c6d66.mp3",Ks="/drummer/assets/crash-0688e97a.mp3",qs="/drummer/assets/crash2-2d466720.mp3",Ys="/drummer/assets/ride-3a112803.mp3",Js="/drummer/assets/tom1-e6733423.mp3",Xs="/drummer/assets/tom2-5814473e.mp3",Qs="/drummer/assets/tom3-3f3fe247.mp3",Rt="/drummer/assets/metronome-6b186e46.mp3",eo="/drummer/assets/kick-alt-b2958473.mp3",to="/drummer/assets/snare-alt-0de57387.mp3",no="/drummer/assets/hi-hat-closed-alt-579c1ecc.mp3",ro="/drummer/assets/hi-hat-open-alt-2a309767.mp3",so="/drummer/assets/crash-alt-94e611ad.mp3",oo="/drummer/assets/crash2-alt-eb28fd80.mp3",ao="/drummer/assets/ride-alt-cd8ec646.mp3",io="/drummer/assets/tom1-alt-05e11fd7.mp3",co="/drummer/assets/tom2-alt-70f42d0f.mp3",lo="/drummer/assets/tom3-alt-18be2bb3.mp3",uo="/drummer/assets/kick-another-d2d88941.mp3",fo="/drummer/assets/snare-another-0f53eb38.mp3",ho="/drummer/assets/hi-hat-closed-another-23056c2a.mp3",mo="/drummer/assets/hi-hat-open-another-531f2b31.mp3",po="/drummer/assets/crash-another-89c6e467.mp3",go="/drummer/assets/crash2-another-79bd375c.mp3",bo="/drummer/assets/ride-another-1da28a50.mp3",vo="/drummer/assets/tom1-another-ca934ab0.mp3",yo="/drummer/assets/tom2-another-e79d7d82.mp3",xo="/drummer/assets/tom3-another-73bd83e0.mp3",wo={kick:{A:Vs,B:eo,C:uo},snare:{A:Gs,B:to,C:fo},hiHatClosed:{A:$s,B:no,C:ho},hiHatOpen:{A:Zs,B:ro,C:mo},crash1:{A:Ks,B:so,C:po},crash2:{A:qs,B:oo,C:go},ride:{A:Ys,B:ao,C:bo},tom1:{A:Js,B:io,C:vo},tom2:{A:Xs,B:co,C:yo},tom3:{A:Qs,B:lo,C:xo},metronome:{A:Rt,B:Rt,C:Rt}},Xe={Kick:"kick",Snare:"snare","Hi-Hat Closed":"hiHatClosed","Hi-Hat Open":"hiHatOpen","Crash 1":"crash1","Crash 2":"crash2",Ride:"ride","Tom 1":"tom1","Tom 2":"tom2","Tom 3":"tom3"};let Zt=null,Kt=!1;const ur=new Map;let tn=!1,pt=null,bt=1,dr=100,nn=null;function ko(){return Zt||(Zt=as()),Zt}function _o(){const t=ko();return t.rawContext??t.context??t}function He(t,n){const o=Math.max(0,n-Be().currentTime)*1e3;setTimeout(()=>{t.forEach(s=>s.dispose())},o)}function Be(){return _o()}async function fr(){if(Be().state==="suspended"&&!Kt){Kt=!0;try{await Xn()}finally{Kt=!1}}}async function So(t,n,e=!1){const o=Be();try{let s;const r=await zs(o,n);if(r&&!e)s=r;else{const c=await(await fetch(t)).arrayBuffer();s=await o.decodeAudioData(c),await Ds(n,s)}ur.set(n,s)}catch{}}function fn(t=!1){if(tn&&!t)return Promise.resolve();if(pt)return pt;const n=["A","B","C"],e=["kick","snare","hiHatClosed","hiHatOpen","crash1","crash2","ride","tom1","tom2","tom3"],o=[];for(const r of e)for(const i of n){const c=wo[r][i],h=`${r}-${i}`;o.push({name:r,url:c,cacheKey:h})}o.push({name:"metronome",url:Rt,cacheKey:"metronome"});let s=0;return pt=(async()=>{for(const r of o)await So(r.url,r.cacheKey,t),s++,nn&&nn(s,o.length,r.cacheKey);tn=!0})(),pt}function Bo(){Be().state==="suspended"&&Xn().catch(()=>{}),fn()}async function hr(){await Ws(),await fn()}async function Co(){try{tn=!1,pt=null,await fn(!0)}catch(t){console.warn("Failed to update sample cache:",t)}}function qt(t){nn=t}async function jo(){return Promise.resolve()}function mr(t,n=1,e=1){return $e("metronome",t,n,!1,e,!1)}function pr(t,n=800,e=.01){const o=new we(.3).toDestination(),s=new it({frequency:n,type:"sine"});s.connect(o),o.gain.setValueAtTime(.3,t),o.gain.exponentialRampToValueAtTime(.01,t+e),s.start(t),s.stop(t+e),He([s,o],t+e+.1)}function Eo(t){mr(t,.8,1.2)||pr(t,1e3,.02)}function To(t){mr(t,.6,1)||pr(t,600,.01)}function gr(t){const n=Xe.Kick,e=Je("Kick"),o=`${n}-${e}`;$e(o,t,.9)||Ro(t)}function Ro(t){const n=new we(.85).toDestination(),e=new we,o=new it({type:"sine"});o.connect(e),e.connect(n),o.frequency.setValueAtTime(150,t),o.frequency.exponentialRampToValueAtTime(40,t+.08),e.gain.setValueAtTime(1,t),e.gain.setValueAtTime(.8,t+.01),e.gain.exponentialRampToValueAtTime(.001,t+.25),o.start(t),o.stop(t+.25),He([o,e,n],t+.35)}function $e(t,n,e=1,o=!0,s=1,r=!0){const i=ur.get(t);if(!i)return!1;const c=r?dr/100:1,h=o?Math.max(0,Math.min(1,e*bt*c)):Math.max(0,Math.min(1,e*c)),_=new we(h).toDestination(),x=new os(i);x.connect(_),x.playbackRate=s;const v=Math.max(n,Be().currentTime);x.start(v);const y=Math.max(.01,s),f=i.duration/y;return He([x,_],v+f+.1),!0}function rn(t){const n=Xe.Snare,e=Je("Snare"),o=`${n}-${e}`;$e(o,t,.9)||Ao(t)}function Ao(t){const n=new we(.5).toDestination(),e=new it({type:"triangle"}),o=new we;e.connect(o),o.connect(n),e.frequency.setValueAtTime(200,t),e.frequency.exponentialRampToValueAtTime(120,t+.05),o.gain.setValueAtTime(.7,t),o.gain.exponentialRampToValueAtTime(.001,t+.12);const s=new it({type:"sine"}),r=new we;s.connect(r),r.connect(n),s.frequency.setValueAtTime(400,t),s.frequency.exponentialRampToValueAtTime(200,t+.03),r.gain.setValueAtTime(.3,t),r.gain.exponentialRampToValueAtTime(.001,t+.08);const i=new Ot("white"),c=new Dt({type:"bandpass",frequency:5e3,Q:1}),h=new we;i.connect(c),c.connect(h),h.connect(n),h.gain.setValueAtTime(.5,t),h.gain.exponentialRampToValueAtTime(.001,t+.18),e.start(t),e.stop(t+.12),s.start(t),s.stop(t+.08),i.start(t),i.stop(t+.18),He([e,o,s,r,i,c,h,n],t+.28)}function br(t){const n=Xe["Hi-Hat Closed"],e=Je("Hi-Hat Closed"),o=`${n}-${e}`;$e(o,t,.7)||No(t)}function No(t){const n=new we(.25).toDestination(),e=new Ot("white"),o=new Dt({type:"highpass",frequency:7e3}),s=new we;e.connect(o),o.connect(s),s.connect(n),s.gain.setValueAtTime(1,t),s.gain.exponentialRampToValueAtTime(.001,t+.05),e.start(t),e.stop(t+.05),He([e,o,s,n],t+.15)}function vr(t){const n=Xe["Hi-Hat Open"],e=Je("Hi-Hat Open"),o=`${n}-${e}`;$e(o,t,.5)||Io(t)}function Io(t){const n=new we(.4).toDestination(),e=new Ot("white"),o=new Dt({type:"highpass",frequency:6e3}),s=new we;e.connect(o),o.connect(s),s.connect(n),s.gain.setValueAtTime(1,t),s.gain.exponentialRampToValueAtTime(.001,t+.35),e.start(t),e.stop(t+.35),He([e,o,s,n],t+.45)}function Pt(t,n=1){const e=n>1?"Crash 1":"Crash 2",o=Xe[e],s=Je(e),r=`${o}-${s}`;$e(r,t,.6)||Po(t,n)}function Po(t,n=1){const e=new we(.5).toDestination(),o=new Ot("white"),s=new Dt({type:"highpass",frequency:3e3*n}),r=new we;o.connect(s),s.connect(r),r.connect(e),r.gain.setValueAtTime(1,t),r.gain.exponentialRampToValueAtTime(.001,t+1.2),o.start(t),o.stop(t+1.2),He([o,s,r,e],t+1.3)}function yr(t){const n=Xe.Ride,e=Je("Ride"),o=`${n}-${e}`;$e(o,t,.7)||Lo(t)}function Lo(t){const n=new we(.4).toDestination(),e=new we,o=new it({type:"sine",frequency:3e3});o.connect(e),e.connect(n),e.gain.setValueAtTime(.4,t),e.gain.exponentialRampToValueAtTime(.001,t+.5),o.start(t),o.stop(t+.5),He([o,e,n],t+.6)}function ot(t,n=200){let e;n>=230?e="Tom 1":n>=180?e="Tom 2":e="Tom 3";const o=Xe[e],s=Je(e),r=`${o}-${s}`;$e(r,t,1)||Mo(t,n)}function Mo(t,n=200){const e=new we(.65).toDestination(),o=new we,s=new it({type:"sine"});s.connect(o),o.connect(e),s.frequency.setValueAtTime(n*1.5,t),s.frequency.exponentialRampToValueAtTime(n*.6,t+.2),o.gain.setValueAtTime(1,t),o.gain.exponentialRampToValueAtTime(.001,t+.3),s.start(t),s.stop(t+.3),He([s,o,e],t+.4)}async function sn(t,n=1){await fr(),await hr(),bt=n;const o=Be().currentTime;switch(t){case"Kick":gr(o);break;case"Snare":rn(o);break;case"Hi-Hat Closed":br(o);break;case"Hi-Hat Open":vr(o);break;case"Crash 1":Pt(o,1.2);break;case"Crash 2":Pt(o,1);break;case"Ride":yr(o);break;case"Tom 1":ot(o,280);break;case"Tom 2":ot(o,220);break;case"Tom 3":ot(o,160);break;default:rn(o)}bt=1}function Oo(t){bt=t}function Do(){bt=1}function zo(t){dr=Math.max(0,Math.min(100,t))}function Fo({isMetronomePlaying:t,isPatternPlaying:n,setIsMetronomePlaying:e,setIsPatternPlaying:o}){const s=B.useRef(!1),r=B.useRef(!1),i=B.useRef(t),c=B.useRef(n);B.useEffect(()=>{i.current=t},[t]),B.useEffect(()=>{c.current=n},[n]),B.useEffect(()=>{const h=async()=>{if(document.hidden)s.current=i.current,r.current=c.current,e(!1),o(!1);else try{await fr(),s.current&&e(!0),r.current&&o(!0)}catch(_){console.error("Failed to resume audio context:",_)}};return document.addEventListener("visibilitychange",h),()=>{document.removeEventListener("visibilitychange",h)}},[e,o])}function Uo(){const[t,n]=B.useState(!0),[e,o]=B.useState({loaded:0,total:11,currentName:""}),[s,r]=B.useState(!1),[i,c]=B.useState(!1),h=B.useRef(!1),_=B.useRef(!1),x=B.useRef({loaded:0,total:11});return B.useEffect(()=>{(async()=>{const y=setTimeout(()=>{r(!0),h.current=!0},200);let f=null;const g=()=>{qt(null),setTimeout(()=>{c(!0),setTimeout(()=>{n(!1)},300)},300)};try{qt((m,b,S)=>{o({loaded:m,total:b,currentName:S}),x.current={loaded:m,total:b},m===b&&h.current&&!f&&(f=setTimeout(g,0))}),Bo();const p=new Promise((m,b)=>{setTimeout(()=>b(new Error("Sample loading timeout")),1e4)});await Promise.race([hr(),p]),Co().catch(()=>{})}catch{}finally{if(clearTimeout(y),_.current=!0,!h.current)qt(null),c(!0),setTimeout(()=>{n(!1)},300);else if(!f){const{loaded:l,total:p}=x.current;l===p?g():(o(m=>({...m,loaded:m.total})),setTimeout(g,300))}}})()},[]),{isLoading:t,loadingProgress:e,showProgress:s,isFadingOut:i}}const Ho=300,Wo=5;function Vo(){B.useEffect(()=>{const t={count:0},n={time:0},e=s=>!!(s.closest("button")||s.closest("input")||s.closest("select")||s.closest("a")||s.closest(".bottom-play-button-container")),o=s=>{const r=s.target;if(e(r))return;const i=Date.now();i-n.time>Ho&&(t.count=0),t.count++,n.time=i,t.count>=Wo&&(window.dispatchEvent(new CustomEvent("show-version")),t.count=0)};return document.body.addEventListener("pointerdown",o,{passive:!0}),()=>{document.body.removeEventListener("pointerdown",o)}},[])}function Go(){const[t,n]=B.useState(!1),[e,o]=B.useState(!1),s=B.useCallback(()=>{n(c=>{const h=!c;return h&&o(!1),h})},[]),r=B.useCallback(()=>{o(c=>{const h=!c;return h&&n(!1),h})},[]),i=B.useCallback(()=>{n(!1),o(!1)},[]);return{isMetronomePlaying:t,isPatternPlaying:e,toggleMetronomePlay:s,togglePatternPlay:r,stopAll:i,setIsMetronomePlaying:n,setIsPatternPlaying:o}}const $o="drummer-bgm-files",Zo=1,Ne="bgm-files",xr="drummer-bgm-config",wr="drummer-master-volume",kr=100;function Ko(){return`bgm-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function wt(){return new Promise((t,n)=>{const e=indexedDB.open($o,Zo);e.onerror=()=>n(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=o=>{const s=o.target.result;s.objectStoreNames.contains(Ne)||s.createObjectStore(Ne,{keyPath:"id"})}})}async function _r(t){const n=await wt(),e=n.transaction(Ne,"readwrite"),o=e.objectStore(Ne),s=Ko(),r={id:s,blob:t,name:t.name,size:t.size,type:t.type,createdAt:Date.now()};try{return await new Promise((i,c)=>{e.oncomplete=()=>i(),e.onerror=()=>c(e.error),e.onabort=()=>c(new Error("Transaction aborted"));const h=o.put(r);h.onerror=()=>c(h.error)}),await new Promise(i=>setTimeout(i,50)),n.close(),{id:s,meta:{name:r.name,size:r.size,type:r.type}}}catch(i){throw n.close(),i}}async function Sr(t){const n=await wt(),o=n.transaction(Ne,"readonly").objectStore(Ne),s=await new Promise((r,i)=>{const c=o.get(t);c.onsuccess=()=>r(c.result??null),c.onerror=()=>i(c.error)});return n.close(),s}async function Yt(t){const n=await wt(),e=n.transaction(Ne,"readwrite"),o=e.objectStore(Ne);await new Promise((s,r)=>{e.oncomplete=()=>s(),e.onerror=()=>r(e.error);const i=o.delete(t);i.onerror=()=>r(i.error)}),n.close()}async function qo(){const t=await wt(),e=t.transaction(Ne,"readonly").objectStore(Ne),o=await new Promise((s,r)=>{const i=e.getAll();i.onsuccess=()=>s(i.result),i.onerror=()=>r(i.error)});return t.close(),o}async function Yo(){const t=await wt(),n=t.transaction(Ne,"readwrite"),e=n.objectStore(Ne);await new Promise((o,s)=>{n.oncomplete=()=>o(),n.onerror=()=>s(n.error);const r=e.clear();r.onerror=()=>s(r.error)}),t.close()}async function Br(t,n,e){const o=atob(t),s=new Uint8Array(o.length);for(let c=0;c<o.length;c++)s[c]=o.charCodeAt(c);const r=new Blob([s],{type:e}),i=new File([r],n,{type:e,lastModified:Date.now()});return _r(i)}function hn(){const t=localStorage.getItem(xr);if(!t)return{};try{const n=JSON.parse(t);if(n&&typeof n=="object")return n}catch{}return{}}function Cr(t){localStorage.setItem(xr,JSON.stringify(t))}function ut(t){const e=hn()[t];return{fileId:e==null?void 0:e.fileId,offsetMs:(e==null?void 0:e.offsetMs)??0,volumePct:(e==null?void 0:e.volumePct)??kr,meta:e==null?void 0:e.meta}}function nt(t,n){const e=hn();e[t]={fileId:n.fileId,offsetMs:n.offsetMs??0,volumePct:n.volumePct??kr,meta:n.meta},Cr(e)}function Nn(t){const n=hn();delete n[t],Cr(n)}const In=0;function Jo(){const t=localStorage.getItem(wr);if(!t)return In;try{const n=JSON.parse(t);if(typeof n=="number"&&n>=0&&n<=100)return n}catch{}return In}function Xo(t){const n=Math.max(0,Math.min(100,t));localStorage.setItem(wr,JSON.stringify(n))}function Jt(t,n){var r;const e=n.timeSignature[0],o=n.timeSignature[1];let s=0;for(let i=0;i<t;i++){const _=60/(((r=n.barBpmOverrides)==null?void 0:r[i])??n.bpm)*(4/o)*e;s+=_}return s}function Qo({isPlaying:t,isFullPracticeMode:n,playbackRate:e,bgmConfig:o,currentSubdivision:s,pattern:r,patternStartToken:i,rangeStartBar:c}){const h=r.timeSignature[0],_=r.timeSignature[1],x=B.useRef(null),v=B.useRef(void 0),[y,f]=B.useState({isLoading:!1,isLoaded:!1,error:null}),g=B.useRef(e);g.current=e;const l=B.useRef(0),p=B.useRef(null),m=B.useRef(0),b=B.useCallback(()=>{var Q;const k=x.current;if(!k)return;const L=Be().currentTime,P=(o.offsetMs??0)/1e3,T=Math.max(.1,g.current),N=l.current,D=Jt(c,r),A=N/g.current+D-P,d=A/T,U=A<0?Math.abs(A):0,Y=L+U,z=Math.max(0,d);let X=z;if(((Q=k.buffer)==null?void 0:Q.duration)!==void 0){const I=Math.max(0,k.buffer.duration-.001);X=Math.min(I,z)}k.state==="started"&&k.stop();const H=Math.max(Y,m.current+.001);m.current=H,k.start(H,X)},[o.offsetMs,r,c]);B.useEffect(()=>{let k=!1;return(async()=>{if(!o.fileId){v.current=void 0,x.current&&(x.current.stop(),x.current.dispose(),x.current=null),f({isLoading:!1,isLoaded:!1,error:null});return}if(!(o.fileId===v.current&&x.current)){f({isLoading:!0,isLoaded:!1,error:null});try{const L=await Sr(o.fileId);if(!L)throw new Error("Background music file not found");const P=Be(),T=await L.blob.arrayBuffer(),N=await P.decodeAudioData(T.slice(0));if(k)return;x.current&&(x.current.stop(),x.current.dispose());const D=new is(N).toDestination();D.loop=!1,D.playbackRate=Math.max(.1,g.current),D.grainSize=.2,D.overlap=.02;const M=Math.max(0,Math.min(100,o.volumePct??100)),w=Math.max(1e-4,M/100);D.volume.value=wn(w),x.current=D,v.current=o.fileId,f({isLoading:!1,isLoaded:!0,error:null})}catch(L){k||f({isLoading:!1,isLoaded:!1,error:L instanceof Error?L.message:"Failed to load background music"})}}})(),()=>{k=!0}},[o.fileId,o.volumePct]),B.useEffect(()=>{var A;const k=h*he,E=Math.floor(s/k),L=s%k,P=Jt(E,r),M=60/((((A=r.barBpmOverrides)==null?void 0:A[E])??r.bpm)*e)*(4/_)/he,w=Jt(c,r);l.current=P+L*M-w},[s,r,_,e,c,h]),B.useEffect(()=>{const k=x.current;k&&(k.playbackRate=Math.max(.1,e))},[e]),B.useEffect(()=>{const k=x.current;if(!k)return;const E=Math.max(0,Math.min(100,o.volumePct??100)),L=Math.max(1e-4,E/100);k.volume.value=wn(L)},[o.volumePct]);const S=B.useRef(o.offsetMs??0);return B.useEffect(()=>{if(!x.current||!t||!n||!o.fileId||!y.isLoaded){S.current=o.offsetMs??0;return}const E=S.current;S.current=o.offsetMs??0,E!==(o.offsetMs??0)&&b()},[o.offsetMs,t,n,y.isLoaded,o.fileId,b]),B.useEffect(()=>{const k=x.current;if(!k)return;if(!n||!o.fileId){k.state==="started"&&k.stop();return}if(!t){k.state==="started"&&k.stop();return}const E=Be();E.state==="suspended"&&E.resume().catch(()=>{}),b()},[t,n,o.fileId,o.offsetMs,y.isLoaded,i,b]),B.useEffect(()=>{if(!t||!n||!o.fileId||!y.isLoaded){p.current=s;return}const k=p.current;p.current=s,k!==null&&s<k&&b()},[s,t,n,o.fileId,y.isLoaded,b]),B.useEffect(()=>{p.current=s},[s]),B.useEffect(()=>()=>{x.current&&(x.current.stop(),x.current.dispose(),x.current=null)},[]),y}let At=null;async function jr(){if("wakeLock"in navigator)try{At=await navigator.wakeLock.request("screen")}catch{}}async function on(){if(At!==null)try{await At.release(),At=null}catch{}}let Pn=0;const ea=16;function Er({bpm:t,timeSignature:n,isPlaying:e,onBeatChange:o,resetToken:s}){const[r,i]=B.useState(0),[c,h]=B.useState(0),_=B.useRef(t),x=B.useRef(n),v=B.useRef(o);_.current=t,x.current=n,v.current=o;const y=B.useRef(0),f=B.useRef(0),g=B.useRef(null),l=B.useRef(!1),p=B.useRef(new Set),m=B.useCallback(()=>{const k=Be();if(!l.current)return;const E=_.current,L=x.current,P=L[0],T=L[1],D=60/E*(4/T)/he,M=P*he,w=k.currentTime,A=.1;for(;y.current<w+A;){const d=f.current,U=Math.floor(d/he),Y=Math.max(y.current,w),z=(Y-w)*1e3;if(d%he===0){U===0?Eo(Y):To(Y);const I=v.current;if(I){const R=window.setTimeout(()=>I(U),z);p.current.add(R)}}const X=d,H=U,Q=window.setTimeout(()=>{p.current.delete(Q),Date.now()-Pn>=ea?requestAnimationFrame(()=>{Pn=Date.now(),l.current&&(h(X),i(H))}):l.current&&(h(X),i(H))},Math.max(0,z));p.current.add(Q),f.current=(f.current+1)%M,y.current+=D}},[]),b=B.useCallback(async()=>{const k=Be();if(l.current)return;k.state==="suspended"&&await k.resume(),await new Promise(L=>requestAnimationFrame(L)),jr(),l.current=!0;const E=k.currentTime;y.current=E,m(),g.current=window.setInterval(m,25)},[m]),S=B.useCallback(()=>{l.current=!1,g.current!==null&&(clearInterval(g.current),g.current=null),p.current.forEach(k=>{clearTimeout(k)}),p.current.clear(),on()},[]);return B.useEffect(()=>(e?b():S(),()=>{S()}),[e,b,S]),B.useEffect(()=>{if(e&&l.current){const k=Be();y.current=k.currentTime}},[t,n,e]),B.useEffect(()=>{if(f.current=0,h(0),i(0),p.current.forEach(k=>{clearTimeout(k)}),p.current.clear(),e&&l.current){const k=Be();y.current=k.currentTime}},[s,e]),{currentBeat:r,currentSubdivision:c}}function ta({bpm:t,onChange:n,min:e=40,max:o=200,disabled:s=!1}){const r=B.useRef(null),[i,c]=B.useState(!1),[h,_]=B.useState(null),x=B.useCallback(k=>(k-e)/(o-e)*100,[e,o]),v=B.useCallback(k=>{const E=e+k/100*(o-e);return Math.round(E/5)*5},[e,o]),y=B.useCallback(k=>{if(!r.current)return;const E=r.current.getBoundingClientRect(),L=Math.max(0,Math.min(100,(k-E.left)/E.width*100)),P=v(L),T=Math.max(e,Math.min(o,P));n(T)},[v,e,o,n]),f=B.useCallback(k=>{s||(c(!0),y(k.clientX),k.target.setPointerCapture(k.pointerId))},[s,y]),g=B.useCallback(k=>{i&&y(k.clientX)},[i,y]),l=B.useCallback(()=>{c(!1)},[]);B.useEffect(()=>{if(i)return window.addEventListener("pointermove",g),window.addEventListener("pointerup",l),()=>{window.removeEventListener("pointermove",g),window.removeEventListener("pointerup",l)}},[i,g,l]),B.useEffect(()=>{const k=()=>{if(r.current){const E=r.current.getBoundingClientRect();_(E.width)}};return k(),window.addEventListener("resize",k),()=>window.removeEventListener("resize",k)},[]);const p=x(t),m=Math.max(0,p),b=20,S=h?m*(h-b)/h:m;return a.jsx("div",{className:"bpm-slider-container",children:a.jsxs("div",{ref:r,className:`bpm-slider-track ${s?"bpm-slider-disabled":""}`,onPointerDown:f,children:[a.jsx("div",{className:"bpm-slider-fill",style:{width:`calc(${S}% + ${b/2}px)`}}),a.jsx("div",{className:"bpm-slider-thumb",style:{left:`calc((100% - ${b}px) * ${m/100})`}})]})})}function na({currentBeat:t,beatsPerBar:n}){return a.jsx("div",{className:"beat-dots",children:Array.from({length:n},(e,o)=>a.jsx("div",{className:`beat-dot ${o===t?"active":""}`},o))})}function ra({isPlaying:t,onClick:n,loopCount:e=0,onResetCount:o}){const s=B.useRef(null),r=B.useRef(!1),i=B.useRef(0),c=500,h=()=>{o&&(r.current=!1,s.current=window.setTimeout(()=>{o(),r.current=!0,s.current=null},c))},_=()=>{s.current&&(clearTimeout(s.current),s.current=null)},x=()=>{s.current&&(clearTimeout(s.current),s.current=null)},v=()=>{o&&(i.current=Date.now(),r.current=!1,s.current=window.setTimeout(()=>{o(),r.current=!0,s.current=null},c))},y=l=>{s.current&&(clearTimeout(s.current),s.current=null),r.current&&(l.preventDefault(),setTimeout(()=>{r.current=!1},100))},f=l=>{if(r.current){l.preventDefault(),l.stopPropagation(),r.current=!1;return}n()},g=e>0;return a.jsx("button",{className:"play-button"+(t?" playing":" paused"),onClick:f,onMouseDown:h,onMouseUp:_,onMouseLeave:x,onTouchStart:v,onTouchEnd:y,"aria-label":t?"Pause":"Play",children:g?a.jsx("span",{className:"play-button-count",children:e}):t?a.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):a.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})})}function Re(t,n={}){const{delay:e=500,interval:o=100,shouldStop:s,clickCallback:r}=n,i=B.useRef(null),c=B.useRef(null),h=B.useRef(!1),_=B.useRef(0),x=B.useRef(!1),v=B.useRef(t);v.current=t;const y=B.useCallback(()=>{h.current=!1,i.current&&(clearTimeout(i.current),i.current=null),c.current&&(clearInterval(c.current),c.current=null)},[]),f=B.useCallback(()=>{h.current||(h.current=!0,_.current=Date.now(),x.current=!1,i.current=setTimeout(()=>{if(h.current){if(s!=null&&s()){y();return}x.current=!0,v.current(),c.current=setInterval(()=>{if(h.current){if(s!=null&&s()){y();return}v.current()}},o)}},e))},[e,o,s,y]),g=B.useCallback(()=>{const L=Date.now()-_.current;!x.current&&L<e&&(r?r():v.current())},[e,r]),l=B.useCallback(()=>{f()},[f]),p=B.useCallback(()=>{y()},[y]),m=B.useCallback(()=>{y()},[y]),b=B.useCallback(L=>{f()},[f]),S=B.useCallback(L=>{y()},[y]),k=B.useCallback(L=>{y()},[y]),E=B.useCallback(L=>{L.preventDefault()},[]);return B.useEffect(()=>()=>{y()},[y]),{onClick:g,onMouseDown:l,onMouseUp:p,onMouseLeave:m,onTouchStart:b,onTouchEnd:S,onTouchCancel:k,onContextMenu:E}}function sa({bpm:t,timeSignature:n,isPlaying:e,resetToken:o,onBPMChange:s,isPatternPlaying:r=!1,isCountInPlaying:i=!1,countInBeat:c,onPatternPlayToggle:h,onTimeSignatureChange:_,rateIndex:x,onRateIndexChange:v,rates:y,rateLabels:f,patternPlayButton:g}){const l=B.useMemo(()=>[[4,4],[3,4],[2,4],[6,8],[5,4],[7,8]],[]),p=B.useCallback(()=>{const I=l.findIndex(R=>R[0]===n[0]&&R[1]===n[1]);return I>=0?I:0},[n,l]),[m,b]=B.useState(()=>{const I=l.findIndex(R=>R[0]===n[0]&&R[1]===n[1]);return I>=0?I:0});B.useEffect(()=>{const I=p();b(I)},[p]);const S=()=>{if(_){const I=(m+1)%l.length,R=l[I];b(I),_(R)}},{currentBeat:k}=Er({bpm:t,timeSignature:n,isPlaying:r,resetToken:o}),[E,L]=B.useState(0),P=B.useRef(-1);B.useEffect(()=>{const I=n[0];P.current===I-1&&k===0&&L(R=>R+1),P.current=k},[k,n]),B.useEffect(()=>{r||(P.current=-1,L(0))},[r]);const T=()=>{L(0)},N=40,D=200,M=()=>{const I=Math.round(Math.max(N,t-1)*10)/10;s(I)},w=()=>{const I=Math.round(Math.min(D,t+1)*10)/10;s(I)},A=()=>{const I=Math.round(Math.max(N,t-.5)*10)/10;s(I)},d=()=>{const I=Math.round(Math.min(D,t+.5)*10)/10;s(I)},U=Re(M,{shouldStop:()=>t<=N,clickCallback:A}),Y=Re(w,{shouldStop:()=>t>=D,clickCallback:d}),z=I=>{y.length&&v(I)},X=()=>{z(x+1)},H=()=>{y.length&&z(x+y.length-1)},Q=i&&c!==void 0?c:k;return a.jsxs("div",{className:"metronome-bar",children:[a.jsxs("div",{className:"metronome-row metronome-row-top",children:[a.jsx("div",{className:"beat-indicator-group",onClick:S,children:a.jsx(na,{currentBeat:Q,beatsPerBar:n[0]})}),a.jsxs("div",{className:"bpm-control-group",children:[a.jsx("button",{className:"bpm-control-button",...U,disabled:t<=N||!!f[x%f.length],"aria-label":"Decrease BPM",children:a.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsxs("div",{className:"bpm-display",children:[a.jsxs("span",{className:"bpm-value",children:[a.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-left",onClick:X,"aria-label":"BPM rate next"}),a.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-right",onClick:H,"aria-label":"BPM rate prev"}),(()=>{const I=Math.round(t*10)/10,R=I!==Math.round(t),J=Math.floor(I),Z=R?String(I).split(".")[1]:null;return a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"bpm-value-integer",children:J}),Z&&a.jsxs("span",{className:"bpm-value-decimal",children:[".",Z]})]})})()]}),f[x%f.length]&&a.jsx("span",{className:"bpm-rate-label",children:f[x%f.length]})]}),a.jsx("button",{className:"bpm-control-button",...Y,disabled:t>=D||!!f[x%f.length],"aria-label":"Increase BPM",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),a.jsx("div",{className:"loop-count-group",children:g||h&&a.jsx(ra,{isPlaying:r,onClick:h,loopCount:E,onResetCount:T})})]}),a.jsx("div",{className:"metronome-row metronome-row-bottom",children:a.jsx(ta,{bpm:t,onChange:s,disabled:!!f[x%f.length]})})]})}function oa(t,n,e,o){return e+2*o+t*o}function aa(t){return vs[t]}const qe=7,Se=qe*.707,Ln=.8,Le=10,Lt=18,rt=Lt,dt=5*Lt;function ia({pattern:t,cellSize:n,currentBeat:e,scrollContainerRef:o,onDoubleClick:s}){const r=B.useRef(null),i=B.useRef(null),c=n,h=T=>{if(!s)return;const N=r.current;if(!N)return;const D=N.getBoundingClientRect(),M=T.clientX-D.left,w=Math.floor(M/c);s(w)},_=B.useRef(null),x=300,v=30,y=T=>{if(!s)return;const N=r.current;if(!N)return;const D=T.touches[0],M=Date.now(),w=N.getBoundingClientRect(),A=D.clientX-w.left;if(_.current){const{time:d,x:U}=_.current,Y=M-d,z=Math.abs(A-U);if(Y<x&&z<v){const X=Math.floor(A/c);s(X),_.current=null;return}}_.current={time:M,x:A}},f=T=>getComputedStyle(document.documentElement).getPropertyValue(T).trim(),g=f("--color-text"),l=f("--color-text-tertiary"),p=f("--color-beat-line"),m=f("--color-warning"),[b]=t.timeSignature,k=t.bars*b*he*c,E=dt+rt,L=Array.from({length:t.bars+1},(T,N)=>({x:N*b*he*c,isFirst:N===0,isLast:N===t.bars})),P=Array.from({length:t.bars*b+1},(T,N)=>({x:N*he*c}));return a.jsx("div",{className:"drum-notation-container",ref:i,children:a.jsxs("svg",{ref:r,className:"drum-notation-svg",viewBox:`0 0 ${k} ${E}`,width:k,height:E,preserveAspectRatio:"none",onDoubleClick:h,onTouchStart:y,children:[a.jsx("line",{x1:0,y1:0,x2:k,y2:0,stroke:g,strokeWidth:2,opacity:.8}),Array.from({length:6},(T,N)=>{const D=rt+N*Lt,M=N===0;return a.jsx("line",{x1:0,y1:D,x2:k,y2:D,stroke:g,strokeWidth:N===5?2:1,opacity:.8,strokeDasharray:M?"4,4":"0"},`staff-line-${N}`)}),L.map((T,N)=>a.jsx("line",{x1:T.x,y1:0,x2:T.x,y2:rt+dt,stroke:T.isFirst||T.isLast?g:l,strokeWidth:T.isFirst||T.isLast?3:2,strokeDasharray:T.isFirst||T.isLast?"0":"4,4",opacity:T.isFirst||T.isLast?1:.6},`bar-line-${N}`)),P.map((T,N)=>N%b===0?null:a.jsx("line",{x1:T.x,y1:0,x2:T.x,y2:rt+dt,stroke:p,strokeWidth:1,opacity:.4},`beat-line-${N}`)),e!==void 0&&e>=0&&a.jsx("rect",{x:e*c,y:0,width:c,height:rt+dt,fill:m,opacity:.4}),t.grid.map((T,N)=>{const D=t.drums[N],M=aa(D),w=oa(M.line,dt,rt,Lt);return T.map((A,d)=>{if(!A)return null;const U=d*c+c/2,Y=M.symbol,z=`symbol-${N}-${d}`,X=A===Pe,H=A===Ge,Q=A===Me,I=A===Fe,R=A===Ue,J=c*.22,Z=Q||I||R?[...Q||I?[U-J]:[],...Q||R?[U+J]:[]]:[U],G=oe=>{const V=[],ce=oe-qe-Ln,ie=oe+qe+Ln,ue=w-Le/2,pe=w+Le/2,be=w-Le/2,u=w+Le/2;return X?(V.push(a.jsx("path",{d:`M ${ce} ${ue}
                        A ${Le} ${Le} 0 0 0 ${ce} ${pe}`,fill:"none",stroke:g,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${oe}`)),V.push(a.jsx("path",{d:`M ${ie} ${be}
                        A ${Le} ${Le} 0 0 1 ${ie} ${u}`,fill:"none",stroke:g,strokeWidth:1.5,strokeLinecap:"round"},`right-bracket-${oe}`))):H&&V.push(a.jsx("path",{d:`M ${ce} ${ue}
                        A ${Le} ${Le} 0 0 0 ${ce} ${pe}`,fill:"none",stroke:g,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${oe}`)),V},te=oe=>{if(D==="Crash 1"||D==="Crash 2")return a.jsxs("g",{children:[a.jsx("circle",{cx:oe,cy:w,r:qe,fill:"none",stroke:g,strokeWidth:2}),a.jsx("line",{x1:oe-Se,y1:w-Se,x2:oe+Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"}),a.jsx("line",{x1:oe+Se,y1:w-Se,x2:oe-Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"}),G(oe)]},`${z}-${oe}`);let V=null;switch(Y){case"x":V=a.jsxs("g",{children:[a.jsx("line",{x1:oe-Se,y1:w-Se,x2:oe+Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"}),a.jsx("line",{x1:oe+Se,y1:w-Se,x2:oe-Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"})]});break;case"o":V=a.jsx("circle",{cx:oe,cy:w,r:qe,fill:"none",stroke:g,strokeWidth:2});break;case"●":V=a.jsx("circle",{cx:oe,cy:w,r:qe,fill:g});break;case"○":V=a.jsx("circle",{cx:oe,cy:w,r:qe,fill:"none",stroke:g,strokeWidth:2});break;default:return null}return a.jsxs("g",{children:[V,G(oe)]},`${z}-${oe}`)};return Z.map(oe=>te(oe))})})]})})}const ca=[{base:1,dots:0,units32:32},{base:2,dots:1,units32:24},{base:2,dots:0,units32:16},{base:4,dots:1,units32:12},{base:4,dots:0,units32:8},{base:8,dots:1,units32:6},{base:8,dots:0,units32:4},{base:16,dots:1,units32:3},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}],la=[{base:4,dots:0,units32:8},{base:8,dots:0,units32:4},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}];function ua(t){if(!Number.isFinite(t)||t<=0)throw new Error(`gapUnits32 must be > 0, got: ${t}`);const n=ca.find(e=>e.units32<=t);return n||{base:32,dots:0,units32:1}}function Bt(t){if(!Number.isFinite(t)||t<0)throw new Error(`gapUnits32 must be >= 0, got: ${t}`);const n=[];let e=t;for(;e>0;){const o=la.find(s=>s.units32<=e);if(!o)break;n.push(o),e-=o.units32}return n}const gt={"Crash 1":{keys:["b/5/x"],isLowerVoice:!1},"Crash 2":{keys:["a/5/x"],isLowerVoice:!1},"Hi-Hat Open":{keys:["g/5/x"],isLowerVoice:!1},"Hi-Hat Closed":{keys:["g/5/x"],isLowerVoice:!1},Ride:{keys:["f/5/x"],isLowerVoice:!1},"Tom 1":{keys:["e/5"],isLowerVoice:!1},"Tom 2":{keys:["d/5"],isLowerVoice:!1},Snare:{keys:["c/5"],isLowerVoice:!1},"Tom 3":{keys:["a/4"],isLowerVoice:!1},Kick:{keys:["f/4"],isLowerVoice:!0}};function da(t){const n=[],e=[],[o]=t.timeSignature,s=t.bars*o*he;for(let r=0;r<s;r++){const i=()=>({0:{normal:[],ghost:[],grace:[]},1:{normal:[],ghost:[],grace:[]}}),c=i(),h=i();let _=!1,x=!1;t.drums.forEach((y,f)=>{var m;const g=((m=t.grid[f])==null?void 0:m[r])??je;if(g===je)return;const l=gt[y].isLowerVoice?h:c,p=(b,S)=>{l[S][b].push({drum:y,cellState:g})};g===Me?(p("normal",0),p("normal",1),gt[y].isLowerVoice?x=!0:_=!0):g===Fe?(p("normal",0),gt[y].isLowerVoice?x=!0:_=!0):g===Ue?(p("normal",1),gt[y].isLowerVoice?x=!0:_=!0):g===Ge?(p("normal",0),p("grace",0)):p(g===Pe?"ghost":"normal",0)});const v=(y,f,g,l)=>{const p=f[g],m=[...p.normal.map(b=>({...b,kind:"normal"})),...p.ghost.map(b=>({...b,kind:"ghost"}))];if(m.length>0){const S=m.every(k=>k.kind==="ghost")?"ghost":"normal";y.push({subdivision:r,subPosition:g,drums:m,is32nd:l,kind:S,graceDrums:p.grace.length>0?[...p.grace]:void 0})}};v(n,c,0,_),v(n,c,1,!0),v(e,h,0,x),v(e,h,1,!0)}return{upperVoice:n,lowerVoice:e}}function fa(t,n,e={}){const o=e.includeFullBarRestWhenEmpty??!1,s=e.omitTailRests??!0,r=e.maxSpanBarFraction??.25,i=n*2,c=r===.25?i/4:i,h=[...t].sort((f,g)=>f.subdivision!==g.subdivision?f.subdivision-g.subdivision:f.subPosition-g.subPosition),_=f=>f.subdivision*2+f.subPosition,x=[];let v=0;const y=f=>{if(c<=0)return 1;const g=f%c;return g===0?c:c-g};if(h.length===0){if(!o)return x;const f=Bt(i);for(const g of f)x.push({kind:"rest",startUnits32InBar:v,durationToken:g,durationUnits32:g.units32}),v+=g.units32;return x}for(let f=0;f<h.length;f++){const g=h[f],l=_(g),p=f+1<h.length?_(h[f+1]):i;if(l>v){const L=l-v,P=Bt(L);for(const T of P)x.push({kind:"rest",startUnits32InBar:v,durationToken:T,durationUnits32:T.units32}),v+=T.units32}v=Math.max(v,l);const m=Math.max(1,p-l),b=y(l),S=Math.max(1,Math.min(m,b)),k=ua(S);x.push({kind:"note",event:g,startUnits32InBar:l,durationToken:k,durationUnits32:k.units32}),v=l+k.units32;const E=f+1>=h.length;if(!E&&v<p){const L=p-v,P=Bt(L);for(const T of P)x.push({kind:"rest",startUnits32InBar:v,durationToken:T,durationUnits32:T.units32}),v+=T.units32}if(E&&!s&&v<i){const L=i-v,P=Bt(L);for(const T of P)x.push({kind:"rest",startUnits32InBar:v,durationToken:T,durationUnits32:T.units32}),v+=T.units32}}return x}function ha(t){var o;const n=t,e=(o=n.getXShift)==null?void 0:o.call(n);return typeof e=="number"?e:typeof n.x_shift=="number"?n.x_shift:0}function Tr(t){const n=cs;typeof n.buildAndAttach=="function"&&n.buildAndAttach([t],{all:!0})}function ma(t,n,e,o,s,r){const i=t-o;if(r){if(r===4)return(i+1.5)*e+e/2;if(r===8)return(i+.5)*e+e/2}const c=i*e+e/2;if(!s)return c;const h=e*.22;return n===0?c-h:c+h}function pa(t,n){if(!n.includes("Hi-Hat Open"))return;const e=new st("○");e.setVerticalJustification(st.VerticalJustify.TOP),e.setJustification(st.HorizontalJustify.CENTER_STEM),e.setFont("",5,900),e.setXShift(-11),e.setYShift(36),t.addModifier(e,0)}function ga(t){return{"Crash 1":-85,"Crash 2":-80,"Hi-Hat Open":-75,"Hi-Hat Closed":-75,Ride:-70,"Tom 1":-65,"Tom 2":-60,Snare:-55,"Tom 3":-45,Kick:-55}[t]??-55}function ba(t,n){if(!n||n.length===0)return;const e=n[0].drum,o=ga(e),s=new st("♪");s.setVerticalJustification(st.VerticalJustify.BOTTOM),s.setJustification(st.HorizontalJustify.CENTER_STEM),s.setFont("",15,"normal"),s.setXShift(e==="Kick"?0:10),s.setYShift(o),t.addModifier(s,0)}function va(t,n,e){const o=[];let s;for(const{drum:h}of t.drums){const _=gt[h];o.push(..._.keys),s=_.keys.some(x=>x.includes("x"))}const r={keys:o,duration:String(e.base),clef:"percussion",stemDirection:n?-1:1},i=new Qn(r);e.dots===1&&Tr(i);const c=t.drums.filter(h=>h.kind==="ghost").map(h=>h.drum);if(c.length>0&&(i._ghostDrums=c),s&&!n){const h=i.getStem();h&&h.setOptions({stemUpYOffset:4})}return pa(i,t.drums.map(h=>h.drum)),ba(i,t.graceDrums),i}function ya(t,n){const e=`${t.base}r`,o=n?["f/4"]:["c/5"],s=new Qn({keys:o,duration:e,clef:"percussion",stemDirection:n?-1:1});return t.dots===1&&Tr(s),s}function Mn(t,n,e){const o=fa(t,n,{includeFullBarRestWhenEmpty:!0,omitTailRests:!1,maxSpanBarFraction:.25});return o.some(r=>r.kind==="note")?o.map(r=>{if(r.kind==="note")return{note:va(r.event,e,r.durationToken),event:r.event,isRest:!1,startUnits32InBar:r.startUnits32InBar,durationUnits32:r.durationUnits32};const i=r.startUnits32InBar,c={subdivision:Math.floor(i/2),subPosition:i%2,drums:[],is32nd:i%2===1,kind:"normal"};return{note:ya(r.durationToken,e),event:c,isRest:!0,startUnits32InBar:r.startUnits32InBar,durationUnits32:r.durationUnits32}}):[]}function xa(t,n){const e=n*2,o=Math.floor(e/2);let s=!1,r=!1;for(const i of t){if(i.isRest)continue;const c=i.note.getDuration();Number.parseInt(c.replace(/[rd]/g,""),10)>=16&&((i.startUnits32InBar??i.event.subdivision*2+i.event.subPosition)<o?s=!0:r=!0)}return[s,r]}function wa(t,n){const e=n*2,o=Math.floor(e/2),s=[],r=[];for(const i of t)(i.startUnits32InBar??i.event.subdivision*2+i.event.subPosition)<o?s.push(i):r.push(i);return[s,r]}function ka(t,n,e){return(t+n/2)/2*e-e/4*1.2}function _a(t,n,e){const o=n*2,s=Math.floor(o/e),r=Array.from({length:e},()=>[]);for(const i of t){const c=i.startUnits32InBar??i.event.subdivision*2+i.event.subPosition,h=Math.floor(c/s);h>=0&&h<e&&r[h].push(i)}return r.filter(i=>i.length>0)}const Nt=130,Sa=40,Ba=35,Ca=(Nt-Sa)/2-Ba;function ja({pattern:t,cellSize:n,currentBeat:e,scrollContainerRef:o,onDoubleClick:s}){const r=B.useRef(null),i=n,c=B.useRef(null),h=300,_=30,[x]=t.timeSignature,v=t.bars*x*he,y=v*i,f=x*he*i,[g,l]=B.useState([]),p=1,m=B.useCallback(()=>{if(!o||!o.current||!r.current)return;const L=o.current,P=r.current,T=L.getBoundingClientRect(),N=P.getBoundingClientRect(),D=T.left-N.left,M=D+T.width,w=Math.max(0,Math.floor(D/f)),A=Math.min(t.bars-1,Math.ceil(M/f)),d=[],U=Math.max(0,w-p),Y=Math.min(t.bars-1,A+p);for(let z=U;z<=Y;z++)d.push(z);l(d)},[o,f,t.bars]);B.useEffect(()=>{m();const L=o==null?void 0:o.current;if(!L)return;const P=()=>{requestAnimationFrame(m)};return L.addEventListener("scroll",P,{passive:!0}),window.addEventListener("resize",m),()=>{L.removeEventListener("scroll",P),window.removeEventListener("resize",m)}},[o,m]);const b=B.useMemo(()=>new Set(g),[g]),S=B.useCallback(L=>{const P=r.current;if(!P)return 0;const T=P.getBoundingClientRect(),N=L-T.left;return Math.floor(N/i)},[i]),k=B.useCallback(L=>{if(!s)return;const P=S(L.clientX);s(P)},[s,S]),E=B.useCallback(L=>{if(!s)return;const P=L.touches[0],T=Date.now(),N=P.clientX;if(c.current){const{time:D,x:M}=c.current,w=T-D,A=Math.abs(N-M);if(w<h&&A<_){const d=S(N);s(d),c.current=null;return}}c.current={time:T,x:N}},[s,S]);return B.useEffect(()=>{var D,M;const L=r.current;if(!L)return;L.innerHTML="";const P=new kn(L,kn.Backends.SVG);P.resize(y,Nt);const T=P.getContext();for(let w=0;w<t.bars;w++){if(!b.has(w))continue;const A=w*f,d=new ls(A,Ca,f);d.setContext(T),w===t.bars-1&&d.setEndBarType(us.type.END),d.draw();const{upperVoice:U,lowerVoice:Y}=da(t),z=w*x*he,X=(w+1)*x*he,H=U.filter(te=>te.subdivision>=z&&te.subdivision<X),Q=Y.filter(te=>te.subdivision>=z&&te.subdivision<X),I=x*he,R=Mn(H.map(te=>({...te,subdivision:te.subdivision-z})),I,!1).map(te=>({...te,event:{...te.event,subdivision:te.event.subdivision+z}})),J=Mn(Q.map(te=>({...te,subdivision:te.subdivision-z})),I,!0).map(te=>({...te,event:{...te.event,subdivision:te.event.subdivision+z}})),Z=R,G=J;if(Z.length>0||G.length>0){const te=[],oe=[...Z,...G];if(Z.length>0){const ie=new _n({numBeats:x,beatValue:4}).setStrict(!1);ie.addTickables(Z.map(ue=>ue.note)),te.push(ie)}if(G.length>0){const ie=new _n({numBeats:x,beatValue:4}).setStrict(!1);ie.addTickables(G.map(ue=>ue.note)),te.push(ie)}te.length>0&&new ds().joinVoices(te).format(te,f-20);for(const ie of oe){const{note:ue,event:pe,isRest:be,startUnits32InBar:u,durationUnits32:$}=ie;let W;be&&u!==void 0&&$?W=ka(u,$,i):W=ma(pe.subdivision,pe.subPosition,i,z,pe.is32nd)-i/4,ue.setStave(d);const j=d.getX()+W,C=ue.getAbsoluteX(),O=j-C;ue.setXShift(ha(ue)+O)}const V=[],ce=[{notes:Z,stemDirection:1},{notes:G,stemDirection:-1}];for(const{notes:ie,stemDirection:ue}of ce){const pe=ie.filter(C=>{const O=C.note.getDuration(),K=Number.parseInt(O.replace(/[rd]/g,""),10);return Number.isFinite(K)&&K>=8});if(pe.length===0)continue;const[be,u]=xa(pe,I),[$,W]=wa(pe,I),j=[{notes:$,hasSixteenth:be},{notes:W,hasSixteenth:u}];for(const{notes:C,hasSixteenth:O}of j)if(C.length!==0)if(O){const K=_a(C,I,x);for(const q of K){if(q.length===0)continue;const F=Sn.generateBeams(q.map(ee=>ee.note),{stemDirection:ue,flatBeams:!0,groups:[new Bn(1,4)]});V.push(...F)}}else{const K=Sn.generateBeams(C.map(q=>q.note),{stemDirection:ue,flatBeams:!0,groups:[new Bn(1,2)]});V.push(...K)}}te.forEach(ie=>ie.draw(T,d)),V.forEach(ie=>ie.setContext(T).draw());for(const ie of oe){const ue=ie.note;if(ue._ghostDrums&&ue._ghostDrums.length>0&&ue.noteHeads){const pe=new Set(ue._ghostDrums),be=ie.event.drums.map(u=>u.drum);for(let u=0;u<ue.noteHeads.length;u++){const $=ue.noteHeads[u];if(!$)continue;const W=be[u];if(!W||!pe.has(W))continue;const j=((D=$.getSVGElement)==null?void 0:D.call($))??$.el;if(j){const C=(M=j.getBBox)==null?void 0:M.call(j);if(C){const O=C.x+C.width/2,K=C.y+C.height/2;j.setAttribute("transform",`translate(${O}, ${K}) scale(0.75) translate(${-O+(W==="Kick"?-2:2)}, ${-K})`)}}}}}}}const N=L.querySelector("svg");if(N&&(N.querySelectorAll(".vf-stave").forEach(d=>{d.setAttribute("stroke","#aaa")}),N.querySelectorAll(".vf-stavebarline").forEach(d=>{d.querySelectorAll("rect").forEach(Y=>{Y.setAttribute("stroke","transparent"),Y.setAttribute("fill","#333")})})),e!==void 0&&e>=0){const w=L.querySelector("svg");if(w){const A=document.createElementNS("http://www.w3.org/2000/svg","rect");A.setAttribute("x",String(e*i)),A.setAttribute("y","0"),A.setAttribute("width",String(i)),A.setAttribute("height",String(Nt)),A.setAttribute("fill","#fbbf24"),A.setAttribute("opacity","0.3"),A.setAttribute("stroke","transparent"),w.insertBefore(A,w.firstChild)}}},[t,e,i,y,x,v,f,b]),a.jsx(a.Fragment,{children:a.jsx("div",{className:"drum-notation-container vexflow-renderer",ref:r,onDoubleClick:k,onTouchStart:E,style:{width:y,height:Nt,backgroundColor:"#ffffff"}})})}const On="drummer-renderer-change";function Ea(t){const[n,e]=B.useState(()=>An()),[o,s]=B.useState(!1);B.useEffect(()=>{const c=()=>{e(An()),s(!1)};return window.addEventListener(On,c),()=>{window.removeEventListener(On,c)}},[]);const r=B.useCallback(()=>{console.error("VexFlow rendering failed, falling back to Legacy renderer"),s(!0)},[]);return B.useMemo(()=>n==="vexflow"&&!o,[n,o])?a.jsx(Ta,{onError:r,children:a.jsx(ja,{...t})}):a.jsx(ia,{...t})}class Ta extends B.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(n,e){console.error("VexFlow rendering error:",n,e),this.props.onError()}render(){return this.state.hasError?null:this.props.children}}const Dn=300,zn=200,Ra=30;function Aa({cellState:t,onClick:n,onToggleGhost:e,onDoubleClick:o,isCurrentBeat:s,drumType:r,subdivisionIndex:i=0,style:c}){const h=B.useRef(0),_=100,x=B.useRef(0),v=B.useRef(null),y=B.useRef(null),f=B.useRef(!1),g=B.useRef(0),l=B.useRef(!1),p=B.useRef(null),[m,b]=B.useState(!1),S=t!==je,k=t===Pe,E=t===Ge,L=t===Me,P=t===Fe,T=t===Ue,N=L||P||T,D=Math.floor(i/4)%2===1,M=B.useCallback(()=>{const U=Date.now();U-h.current<_||(h.current=U,r&&!S&&sn(r),n())},[r,S,n]),w=B.useCallback(U=>{U.button!==0&&U.pointerType==="mouse"||(g.current=Date.now(),l.current=!1,f.current=!0,b(!0),p.current=window.setTimeout(()=>{if(l.current=!0,f.current=!1,S&&!N&&(e(),r)){let Y;t===Te?Y=Pe:t===Pe?Y=Ge:Y=Te,sn(r,Y===Pe?.3:1)}b(!1)},Dn))},[S,e,r,t,N]),A=B.useCallback(()=>{const U=l.current,Y=f.current;if(p.current&&(clearTimeout(p.current),p.current=null),y.current=window.setTimeout(()=>{b(!1)},Ra),U){l.current=!1;return}if(Date.now()-g.current<Dn&&Y){const X=Date.now();if(X-x.current<zn){x.current=0,v.current&&(clearTimeout(v.current),v.current=null),o&&o();return}x.current=X,v.current&&clearTimeout(v.current),v.current=window.setTimeout(()=>{M(),v.current=null},zn)}},[M,o]),d=B.useCallback(()=>{p.current&&(clearTimeout(p.current),p.current=null),y.current&&(clearTimeout(y.current),y.current=null),b(!1),l.current&&(l.current=!1),f.current=!1},[]);return a.jsx("button",{className:`grid-cell ${S?"active":""} ${k?"ghost":""} ${E?"grace":""} ${N?"thirty-second":""} ${L?"double-32":""} ${P?"first-32":""} ${T?"second-32":""} ${s?"current-beat":""} ${D?"alt-beat":""} ${m?"pressing":""}`,style:c,onPointerDown:w,onPointerUp:A,onPointerLeave:d,onPointerCancel:d,type:"button","aria-label":E?"Grace note":k?"Ghost note":S?"Active":"Inactive",children:N&&a.jsxs("div",{className:`cell-32-dots ${L?"double":P?"first":"second"}`,"aria-hidden":"true",children:[(L||P)&&a.jsx("span",{className:"dot left"}),(L||T)&&a.jsx("span",{className:"dot right"})]})})}function Na(t,n,e,o,s){const r=t,i=r+n,c=Math.max(0,Math.floor(r/e)-o),h=Math.min(s,Math.ceil(i/e)+o);return{start:c,end:h}}function Ia(t,n,e){const{itemSize:o,totalItems:s,bufferItems:r=0}=e,i=B.useRef(!1),[c,h]=B.useState(()=>({start:0,end:Math.min(s,Math.ceil(window.innerWidth/o)+r*2)})),_=B.useCallback(()=>{const y=t==null?void 0:t.current,f=n.current;if(!y||!f)return;i.current||(i.current=!0);const g=y.clientWidth;if(s*o<=g){h({start:0,end:s});return}const l=Na(y.scrollLeft,g,o,r,s);h(p=>p.start===l.start&&p.end===l.end?p:l)},[t,n,o,r,s]),x=t==null?void 0:t.current;B.useLayoutEffect(()=>{if(!x)return;_();let y;const f=()=>{y&&cancelAnimationFrame(y),y=requestAnimationFrame(_)};return x.addEventListener("scroll",f,{passive:!0}),window.addEventListener("resize",_),()=>{y&&cancelAnimationFrame(y),x.removeEventListener("scroll",f),window.removeEventListener("resize",_)}},[x,_]);const v=B.useMemo(()=>new Set(Array.from({length:c.end-c.start},(y,f)=>c.start+f)),[c]);return{...c,visibleSet:v}}function Pa({pattern:t,cellSize:n,onCellClick:e,onToggleGhost:o,onCellDoubleClick:s,currentBeat:r,scrollContainerRef:i}){var y;const c=B.useRef(null),h=((y=t.grid[0])==null?void 0:y.length)||0,_=h*n,x=he*2,{visibleSet:v}=Ia(i,c,{itemSize:n,totalItems:h,bufferItems:x});return a.jsx("div",{className:"grid-container",children:a.jsx("div",{className:"grid-wrapper",children:a.jsx("div",{className:"grid-content",ref:c,style:{width:`${_}px`},children:a.jsx("div",{className:"grid-rows",children:t.grid.map((f,g)=>{const l=t.drums[g];return a.jsx("div",{className:"grid-row",style:{width:`${_}px`},children:f.map((p,m)=>{if(!v.has(m))return null;const b=r!==void 0&&m===r;return a.jsx(Aa,{cellState:p,onClick:()=>e(g,m),onDoubleClick:()=>s(g,m),onToggleGhost:()=>o(g,m),isCurrentBeat:b,drumType:l,subdivisionIndex:m,style:{left:`${m*n}px`}},m)})},g)})})})})})}function La({pattern:t,cellSize:n}){var r;const[e]=t.timeSignature,s=(((r=t.grid[0])==null?void 0:r.length)||0)*n;return a.jsx("div",{className:"grid-container",children:a.jsx("div",{className:"grid-wrapper",children:a.jsx("div",{className:"grid-content",style:{width:`${s}px`},children:a.jsx("div",{className:"grid-beat-labels",children:Array.from({length:t.bars},(i,c)=>{const h=e*he;return a.jsx("div",{className:"grid-beat-label-group",style:{width:`${h*n}px`},children:Array.from({length:e},(_,x)=>{const v=x*he;return a.jsxs("div",{className:"grid-beat-label",style:{width:`${he*n}px`,left:`${v*n}px`},children:[c+1,".",x+1]},x)})},c)})})})})})}function Ma({bars:t,onAddBar:n,onRemoveBar:e,canRemove:o,currentBeat:s}){return a.jsx("div",{className:"bar-controls",children:a.jsxs("span",{className:"bar-count",children:[a.jsx("button",{className:"bar-control-button",onClick:()=>e(s),disabled:!o,"aria-label":"Remove bar",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),t,a.jsx("button",{className:"bar-control-button",onClick:()=>n(s),"aria-label":"Add bar",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})}function Oa({currentPattern:t,savedPatterns:n,crossPatternLoop:e,onCrossPatternLoopChange:o,isDraftMode:s}){const r=B.useRef(t.bars),i=[...n].sort((M,w)=>M.name.localeCompare(w.name)),c=M=>{if(s&&M===""||!s&&M===t.name)return t.bars;const w=n.find(A=>A.name===M);return(w==null?void 0:w.bars)??t.bars},h=M=>M===""||M===t.name?!0:n.some(w=>w.name===M),_={startPatternName:s?"":t.name,startBar:0,endPatternName:s?"":t.name,endBar:t.bars-1};B.useEffect(()=>{if(!e)return;const M=s?"":t.name,w=(d,U)=>d===U?0:d===""?-1:U===""?1:d.localeCompare(U);(()=>{const{startPatternName:d,endPatternName:U}=e;return d===U?d===M:M===d||M===U?!0:w(d,M)<0&&w(M,U)<0})()||o({startPatternName:M,startBar:0,endPatternName:M,endBar:t.bars-1})},[s,t.name,e,o,t.bars]);const x=(M,w,A,d)=>M===A?w-d:M===""?-1:A===""?1:M.localeCompare(A),v=e??_;B.useEffect(()=>{if(!e||!h(e.startPatternName)||!h(e.endPatternName))return;const M=c(e.startPatternName),w=c(e.endPatternName);let A=!1;const d={...e};e.startBar>=M&&(d.startBar=Math.max(0,M-1),A=!0),e.endBar>=w&&(d.endBar=Math.max(0,w-1),A=!0);const U=s?e.endPatternName==="":e.endPatternName===t.name,Y=e.startPatternName!==e.endPatternName;if(U&&!Y){const z=t.bars-1,X=r.current,H=t.bars>X,Q=d.endBar===X-1;H&&Q&&(d.endBar=z,A=!0)}A&&x(d.startPatternName,d.startBar,d.endPatternName,d.endBar)>0&&(d.endBar=d.startBar),A&&o(d),r.current=t.bars},[t.bars,s,t.name,n]);const y=s?[{name:"",label:"○"},...i.map(M=>({name:M.name,label:M.name}))]:i.map(M=>({name:M.name,label:M.name})),f=M=>{const w=c(M),A=Math.min(v.startBar,w-1);x(M,A,v.endPatternName,v.endBar)>0?o({startPatternName:M,startBar:A,endPatternName:M,endBar:A}):o({...v,startPatternName:M,startBar:A})},g=M=>{const w=c(M),A=Math.min(v.endBar,w-1);x(v.startPatternName,v.startBar,M,A)>0?o({startPatternName:M,startBar:A,endPatternName:M,endBar:A}):o({...v,endPatternName:M,endBar:A})},l=()=>{v.startBar>0&&o({...v,startBar:v.startBar-1})},p=()=>{const M=c(v.startPatternName)-1,w=Math.min(M,v.startBar+1);x(v.startPatternName,w,v.endPatternName,v.endBar)<=0&&o({...v,startBar:w})},m=()=>{const M=v.endBar-1;M>=0&&x(v.startPatternName,v.startBar,v.endPatternName,M)<=0&&o({...v,endBar:M})},b=()=>{const M=c(v.endPatternName)-1;v.endBar<M&&o({...v,endBar:v.endBar+1})},S=v.startBar>0,k=v.startBar<c(v.startPatternName)-1&&x(v.startPatternName,v.startBar+1,v.endPatternName,v.endBar)<=0,E=v.endBar>0&&x(v.startPatternName,v.startBar,v.endPatternName,v.endBar-1)<=0,L=v.endBar<c(v.endPatternName)-1,P=Re(l,{shouldStop:()=>!S}),T=Re(p,{shouldStop:()=>!k}),N=Re(m,{shouldStop:()=>!E}),D=Re(b,{shouldStop:()=>!L});return a.jsx("div",{className:"loop-range-selector",children:a.jsxs("div",{className:"loop-range-controls",children:[a.jsxs("div",{className:"loop-range-item",children:[a.jsx("select",{className:"loop-pattern-select",value:v.startPatternName,onChange:M=>f(M.target.value),children:y.map(M=>a.jsx("option",{value:M.name,children:M.label},M.name))}),a.jsx("button",{className:"loop-range-button",...P,disabled:!S,"aria-label":"Decrease start bar",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("span",{className:"loop-range-value",children:v.startBar+1}),a.jsx("button",{className:"loop-range-button",...T,disabled:!k,"aria-label":"Increase start bar",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),a.jsx("span",{className:"loop-range-separator",children:"-"}),a.jsxs("div",{className:"loop-range-item",children:[a.jsx("select",{className:"loop-pattern-select",value:v.endPatternName,onChange:M=>g(M.target.value),children:y.map(M=>a.jsx("option",{value:M.name,children:M.label},M.name))}),a.jsx("button",{className:"loop-range-button",...N,disabled:!E,"aria-label":"Decrease end bar",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("span",{className:"loop-range-value",children:v.endBar+1}),a.jsx("button",{className:"loop-range-button",...D,disabled:!L,"aria-label":"Increase end bar",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})})}function Ct(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Rr={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,n){(function(e){t.exports=e()})(function(){return function e(o,s,r){function i(_,x){if(!s[_]){if(!o[_]){var v=typeof Ct=="function"&&Ct;if(!x&&v)return v(_,!0);if(c)return c(_,!0);var y=new Error("Cannot find module '"+_+"'");throw y.code="MODULE_NOT_FOUND",y}var f=s[_]={exports:{}};o[_][0].call(f.exports,function(g){var l=o[_][1][g];return i(l||g)},f,f.exports,e,o,s,r)}return s[_].exports}for(var c=typeof Ct=="function"&&Ct,h=0;h<r.length;h++)i(r[h]);return i}({1:[function(e,o,s){var r=e("./utils"),i=e("./support"),c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";s.encode=function(h){for(var _,x,v,y,f,g,l,p=[],m=0,b=h.length,S=b,k=r.getTypeOf(h)!=="string";m<h.length;)S=b-m,v=k?(_=h[m++],x=m<b?h[m++]:0,m<b?h[m++]:0):(_=h.charCodeAt(m++),x=m<b?h.charCodeAt(m++):0,m<b?h.charCodeAt(m++):0),y=_>>2,f=(3&_)<<4|x>>4,g=1<S?(15&x)<<2|v>>6:64,l=2<S?63&v:64,p.push(c.charAt(y)+c.charAt(f)+c.charAt(g)+c.charAt(l));return p.join("")},s.decode=function(h){var _,x,v,y,f,g,l=0,p=0,m="data:";if(h.substr(0,m.length)===m)throw new Error("Invalid base64 input, it looks like a data url.");var b,S=3*(h=h.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(h.charAt(h.length-1)===c.charAt(64)&&S--,h.charAt(h.length-2)===c.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(b=i.uint8array?new Uint8Array(0|S):new Array(0|S);l<h.length;)_=c.indexOf(h.charAt(l++))<<2|(y=c.indexOf(h.charAt(l++)))>>4,x=(15&y)<<4|(f=c.indexOf(h.charAt(l++)))>>2,v=(3&f)<<6|(g=c.indexOf(h.charAt(l++))),b[p++]=_,f!==64&&(b[p++]=x),g!==64&&(b[p++]=v);return b}},{"./support":30,"./utils":32}],2:[function(e,o,s){var r=e("./external"),i=e("./stream/DataWorker"),c=e("./stream/Crc32Probe"),h=e("./stream/DataLengthProbe");function _(x,v,y,f,g){this.compressedSize=x,this.uncompressedSize=v,this.crc32=y,this.compression=f,this.compressedContent=g}_.prototype={getContentWorker:function(){var x=new i(r.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new h("data_length")),v=this;return x.on("end",function(){if(this.streamInfo.data_length!==v.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),x},getCompressedWorker:function(){return new i(r.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},_.createWorkerFrom=function(x,v,y){return x.pipe(new c).pipe(new h("uncompressedSize")).pipe(v.compressWorker(y)).pipe(new h("compressedSize")).withStreamInfo("compression",v)},o.exports=_},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,o,s){var r=e("./stream/GenericWorker");s.STORE={magic:"\0\0",compressWorker:function(){return new r("STORE compression")},uncompressWorker:function(){return new r("STORE decompression")}},s.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,o,s){var r=e("./utils"),i=function(){for(var c,h=[],_=0;_<256;_++){c=_;for(var x=0;x<8;x++)c=1&c?3988292384^c>>>1:c>>>1;h[_]=c}return h}();o.exports=function(c,h){return c!==void 0&&c.length?r.getTypeOf(c)!=="string"?function(_,x,v,y){var f=i,g=y+v;_^=-1;for(var l=y;l<g;l++)_=_>>>8^f[255&(_^x[l])];return-1^_}(0|h,c,c.length,0):function(_,x,v,y){var f=i,g=y+v;_^=-1;for(var l=y;l<g;l++)_=_>>>8^f[255&(_^x.charCodeAt(l))];return-1^_}(0|h,c,c.length,0):0}},{"./utils":32}],5:[function(e,o,s){s.base64=!1,s.binary=!1,s.dir=!1,s.createFolders=!0,s.date=null,s.compression=null,s.compressionOptions=null,s.comment=null,s.unixPermissions=null,s.dosPermissions=null},{}],6:[function(e,o,s){var r=null;r=typeof Promise<"u"?Promise:e("lie"),o.exports={Promise:r}},{lie:37}],7:[function(e,o,s){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=e("pako"),c=e("./utils"),h=e("./stream/GenericWorker"),_=r?"uint8array":"array";function x(v,y){h.call(this,"FlateWorker/"+v),this._pako=null,this._pakoAction=v,this._pakoOptions=y,this.meta={}}s.magic="\b\0",c.inherits(x,h),x.prototype.processChunk=function(v){this.meta=v.meta,this._pako===null&&this._createPako(),this._pako.push(c.transformTo(_,v.data),!1)},x.prototype.flush=function(){h.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},x.prototype.cleanUp=function(){h.prototype.cleanUp.call(this),this._pako=null},x.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var v=this;this._pako.onData=function(y){v.push({data:y,meta:v.meta})}},s.compressWorker=function(v){return new x("Deflate",v)},s.uncompressWorker=function(){return new x("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,o,s){function r(f,g){var l,p="";for(l=0;l<g;l++)p+=String.fromCharCode(255&f),f>>>=8;return p}function i(f,g,l,p,m,b){var S,k,E=f.file,L=f.compression,P=b!==_.utf8encode,T=c.transformTo("string",b(E.name)),N=c.transformTo("string",_.utf8encode(E.name)),D=E.comment,M=c.transformTo("string",b(D)),w=c.transformTo("string",_.utf8encode(D)),A=N.length!==E.name.length,d=w.length!==D.length,U="",Y="",z="",X=E.dir,H=E.date,Q={crc32:0,compressedSize:0,uncompressedSize:0};g&&!l||(Q.crc32=f.crc32,Q.compressedSize=f.compressedSize,Q.uncompressedSize=f.uncompressedSize);var I=0;g&&(I|=8),P||!A&&!d||(I|=2048);var R=0,J=0;X&&(R|=16),m==="UNIX"?(J=798,R|=function(G,te){var oe=G;return G||(oe=te?16893:33204),(65535&oe)<<16}(E.unixPermissions,X)):(J=20,R|=function(G){return 63&(G||0)}(E.dosPermissions)),S=H.getUTCHours(),S<<=6,S|=H.getUTCMinutes(),S<<=5,S|=H.getUTCSeconds()/2,k=H.getUTCFullYear()-1980,k<<=4,k|=H.getUTCMonth()+1,k<<=5,k|=H.getUTCDate(),A&&(Y=r(1,1)+r(x(T),4)+N,U+="up"+r(Y.length,2)+Y),d&&(z=r(1,1)+r(x(M),4)+w,U+="uc"+r(z.length,2)+z);var Z="";return Z+=`
\0`,Z+=r(I,2),Z+=L.magic,Z+=r(S,2),Z+=r(k,2),Z+=r(Q.crc32,4),Z+=r(Q.compressedSize,4),Z+=r(Q.uncompressedSize,4),Z+=r(T.length,2),Z+=r(U.length,2),{fileRecord:v.LOCAL_FILE_HEADER+Z+T+U,dirRecord:v.CENTRAL_FILE_HEADER+r(J,2)+Z+r(M.length,2)+"\0\0\0\0"+r(R,4)+r(p,4)+T+U+M}}var c=e("../utils"),h=e("../stream/GenericWorker"),_=e("../utf8"),x=e("../crc32"),v=e("../signature");function y(f,g,l,p){h.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=l,this.encodeFileName=p,this.streamFiles=f,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}c.inherits(y,h),y.prototype.push=function(f){var g=f.meta.percent||0,l=this.entriesCount,p=this._sources.length;this.accumulate?this.contentBuffer.push(f):(this.bytesWritten+=f.data.length,h.prototype.push.call(this,{data:f.data,meta:{currentFile:this.currentFile,percent:l?(g+100*(l-p-1))/l:100}}))},y.prototype.openedSource=function(f){this.currentSourceOffset=this.bytesWritten,this.currentFile=f.file.name;var g=this.streamFiles&&!f.file.dir;if(g){var l=i(f,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:l.fileRecord,meta:{percent:0}})}else this.accumulate=!0},y.prototype.closedSource=function(f){this.accumulate=!1;var g=this.streamFiles&&!f.file.dir,l=i(f,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(l.dirRecord),g)this.push({data:function(p){return v.DATA_DESCRIPTOR+r(p.crc32,4)+r(p.compressedSize,4)+r(p.uncompressedSize,4)}(f),meta:{percent:100}});else for(this.push({data:l.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},y.prototype.flush=function(){for(var f=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var l=this.bytesWritten-f,p=function(m,b,S,k,E){var L=c.transformTo("string",E(k));return v.CENTRAL_DIRECTORY_END+"\0\0\0\0"+r(m,2)+r(m,2)+r(b,4)+r(S,4)+r(L.length,2)+L}(this.dirRecords.length,l,f,this.zipComment,this.encodeFileName);this.push({data:p,meta:{percent:100}})},y.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},y.prototype.registerPrevious=function(f){this._sources.push(f);var g=this;return f.on("data",function(l){g.processChunk(l)}),f.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),f.on("error",function(l){g.error(l)}),this},y.prototype.resume=function(){return!!h.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},y.prototype.error=function(f){var g=this._sources;if(!h.prototype.error.call(this,f))return!1;for(var l=0;l<g.length;l++)try{g[l].error(f)}catch{}return!0},y.prototype.lock=function(){h.prototype.lock.call(this);for(var f=this._sources,g=0;g<f.length;g++)f[g].lock()},o.exports=y},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,o,s){var r=e("../compressions"),i=e("./ZipFileWorker");s.generateWorker=function(c,h,_){var x=new i(h.streamFiles,_,h.platform,h.encodeFileName),v=0;try{c.forEach(function(y,f){v++;var g=function(b,S){var k=b||S,E=r[k];if(!E)throw new Error(k+" is not a valid compression method !");return E}(f.options.compression,h.compression),l=f.options.compressionOptions||h.compressionOptions||{},p=f.dir,m=f.date;f._compressWorker(g,l).withStreamInfo("file",{name:y,dir:p,date:m,comment:f.comment||"",unixPermissions:f.unixPermissions,dosPermissions:f.dosPermissions}).pipe(x)}),x.entriesCount=v}catch(y){x.error(y)}return x}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,o,s){function r(){if(!(this instanceof r))return new r;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new r;for(var c in this)typeof this[c]!="function"&&(i[c]=this[c]);return i}}(r.prototype=e("./object")).loadAsync=e("./load"),r.support=e("./support"),r.defaults=e("./defaults"),r.version="3.10.1",r.loadAsync=function(i,c){return new r().loadAsync(i,c)},r.external=e("./external"),o.exports=r},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,o,s){var r=e("./utils"),i=e("./external"),c=e("./utf8"),h=e("./zipEntries"),_=e("./stream/Crc32Probe"),x=e("./nodejsUtils");function v(y){return new i.Promise(function(f,g){var l=y.decompressed.getContentWorker().pipe(new _);l.on("error",function(p){g(p)}).on("end",function(){l.streamInfo.crc32!==y.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):f()}).resume()})}o.exports=function(y,f){var g=this;return f=r.extend(f||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:c.utf8decode}),x.isNode&&x.isStream(y)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):r.prepareContent("the loaded zip file",y,!0,f.optimizedBinaryString,f.base64).then(function(l){var p=new h(f);return p.load(l),p}).then(function(l){var p=[i.Promise.resolve(l)],m=l.files;if(f.checkCRC32)for(var b=0;b<m.length;b++)p.push(v(m[b]));return i.Promise.all(p)}).then(function(l){for(var p=l.shift(),m=p.files,b=0;b<m.length;b++){var S=m[b],k=S.fileNameStr,E=r.resolve(S.fileNameStr);g.file(E,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:f.createFolders}),S.dir||(g.file(E).unsafeOriginalName=k)}return p.zipComment.length&&(g.comment=p.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,o,s){var r=e("../utils"),i=e("../stream/GenericWorker");function c(h,_){i.call(this,"Nodejs stream input adapter for "+h),this._upstreamEnded=!1,this._bindStream(_)}r.inherits(c,i),c.prototype._bindStream=function(h){var _=this;(this._stream=h).pause(),h.on("data",function(x){_.push({data:x,meta:{percent:0}})}).on("error",function(x){_.isPaused?this.generatedError=x:_.error(x)}).on("end",function(){_.isPaused?_._upstreamEnded=!0:_.end()})},c.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},c.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},o.exports=c},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,o,s){var r=e("readable-stream").Readable;function i(c,h,_){r.call(this,h),this._helper=c;var x=this;c.on("data",function(v,y){x.push(v)||x._helper.pause(),_&&_(y)}).on("error",function(v){x.emit("error",v)}).on("end",function(){x.push(null)})}e("../utils").inherits(i,r),i.prototype._read=function(){this._helper.resume()},o.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,o,s){o.exports={isNode:typeof Buffer<"u",newBufferFrom:function(r,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(r,i);if(typeof r=="number")throw new Error('The "data" argument must not be a number');return new Buffer(r,i)},allocBuffer:function(r){if(Buffer.alloc)return Buffer.alloc(r);var i=new Buffer(r);return i.fill(0),i},isBuffer:function(r){return Buffer.isBuffer(r)},isStream:function(r){return r&&typeof r.on=="function"&&typeof r.pause=="function"&&typeof r.resume=="function"}}},{}],15:[function(e,o,s){function r(E,L,P){var T,N=c.getTypeOf(L),D=c.extend(P||{},x);D.date=D.date||new Date,D.compression!==null&&(D.compression=D.compression.toUpperCase()),typeof D.unixPermissions=="string"&&(D.unixPermissions=parseInt(D.unixPermissions,8)),D.unixPermissions&&16384&D.unixPermissions&&(D.dir=!0),D.dosPermissions&&16&D.dosPermissions&&(D.dir=!0),D.dir&&(E=m(E)),D.createFolders&&(T=p(E))&&b.call(this,T,!0);var M=N==="string"&&D.binary===!1&&D.base64===!1;P&&P.binary!==void 0||(D.binary=!M),(L instanceof v&&L.uncompressedSize===0||D.dir||!L||L.length===0)&&(D.base64=!1,D.binary=!0,L="",D.compression="STORE",N="string");var w=null;w=L instanceof v||L instanceof h?L:g.isNode&&g.isStream(L)?new l(E,L):c.prepareContent(E,L,D.binary,D.optimizedBinaryString,D.base64);var A=new y(E,w,D);this.files[E]=A}var i=e("./utf8"),c=e("./utils"),h=e("./stream/GenericWorker"),_=e("./stream/StreamHelper"),x=e("./defaults"),v=e("./compressedObject"),y=e("./zipObject"),f=e("./generate"),g=e("./nodejsUtils"),l=e("./nodejs/NodejsStreamInputAdapter"),p=function(E){E.slice(-1)==="/"&&(E=E.substring(0,E.length-1));var L=E.lastIndexOf("/");return 0<L?E.substring(0,L):""},m=function(E){return E.slice(-1)!=="/"&&(E+="/"),E},b=function(E,L){return L=L!==void 0?L:x.createFolders,E=m(E),this.files[E]||r.call(this,E,null,{dir:!0,createFolders:L}),this.files[E]};function S(E){return Object.prototype.toString.call(E)==="[object RegExp]"}var k={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(E){var L,P,T;for(L in this.files)T=this.files[L],(P=L.slice(this.root.length,L.length))&&L.slice(0,this.root.length)===this.root&&E(P,T)},filter:function(E){var L=[];return this.forEach(function(P,T){E(P,T)&&L.push(T)}),L},file:function(E,L,P){if(arguments.length!==1)return E=this.root+E,r.call(this,E,L,P),this;if(S(E)){var T=E;return this.filter(function(D,M){return!M.dir&&T.test(D)})}var N=this.files[this.root+E];return N&&!N.dir?N:null},folder:function(E){if(!E)return this;if(S(E))return this.filter(function(N,D){return D.dir&&E.test(N)});var L=this.root+E,P=b.call(this,L),T=this.clone();return T.root=P.name,T},remove:function(E){E=this.root+E;var L=this.files[E];if(L||(E.slice(-1)!=="/"&&(E+="/"),L=this.files[E]),L&&!L.dir)delete this.files[E];else for(var P=this.filter(function(N,D){return D.name.slice(0,E.length)===E}),T=0;T<P.length;T++)delete this.files[P[T].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(E){var L,P={};try{if((P=c.extend(E||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=P.type.toLowerCase(),P.compression=P.compression.toUpperCase(),P.type==="binarystring"&&(P.type="string"),!P.type)throw new Error("No output type specified.");c.checkSupport(P.type),P.platform!=="darwin"&&P.platform!=="freebsd"&&P.platform!=="linux"&&P.platform!=="sunos"||(P.platform="UNIX"),P.platform==="win32"&&(P.platform="DOS");var T=P.comment||this.comment||"";L=f.generateWorker(this,P,T)}catch(N){(L=new h("error")).error(N)}return new _(L,P.type||"string",P.mimeType)},generateAsync:function(E,L){return this.generateInternalStream(E).accumulate(L)},generateNodeStream:function(E,L){return(E=E||{}).type||(E.type="nodebuffer"),this.generateInternalStream(E).toNodejsStream(L)}};o.exports=k},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,o,s){o.exports=e("stream")},{stream:void 0}],17:[function(e,o,s){var r=e("./DataReader");function i(c){r.call(this,c);for(var h=0;h<this.data.length;h++)c[h]=255&c[h]}e("../utils").inherits(i,r),i.prototype.byteAt=function(c){return this.data[this.zero+c]},i.prototype.lastIndexOfSignature=function(c){for(var h=c.charCodeAt(0),_=c.charCodeAt(1),x=c.charCodeAt(2),v=c.charCodeAt(3),y=this.length-4;0<=y;--y)if(this.data[y]===h&&this.data[y+1]===_&&this.data[y+2]===x&&this.data[y+3]===v)return y-this.zero;return-1},i.prototype.readAndCheckSignature=function(c){var h=c.charCodeAt(0),_=c.charCodeAt(1),x=c.charCodeAt(2),v=c.charCodeAt(3),y=this.readData(4);return h===y[0]&&_===y[1]&&x===y[2]&&v===y[3]},i.prototype.readData=function(c){if(this.checkOffset(c),c===0)return[];var h=this.data.slice(this.zero+this.index,this.zero+this.index+c);return this.index+=c,h},o.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,o,s){var r=e("../utils");function i(c){this.data=c,this.length=c.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(c){this.checkIndex(this.index+c)},checkIndex:function(c){if(this.length<this.zero+c||c<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+c+"). Corrupted zip ?")},setIndex:function(c){this.checkIndex(c),this.index=c},skip:function(c){this.setIndex(this.index+c)},byteAt:function(){},readInt:function(c){var h,_=0;for(this.checkOffset(c),h=this.index+c-1;h>=this.index;h--)_=(_<<8)+this.byteAt(h);return this.index+=c,_},readString:function(c){return r.transformTo("string",this.readData(c))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var c=this.readInt(4);return new Date(Date.UTC(1980+(c>>25&127),(c>>21&15)-1,c>>16&31,c>>11&31,c>>5&63,(31&c)<<1))}},o.exports=i},{"../utils":32}],19:[function(e,o,s){var r=e("./Uint8ArrayReader");function i(c){r.call(this,c)}e("../utils").inherits(i,r),i.prototype.readData=function(c){this.checkOffset(c);var h=this.data.slice(this.zero+this.index,this.zero+this.index+c);return this.index+=c,h},o.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,o,s){var r=e("./DataReader");function i(c){r.call(this,c)}e("../utils").inherits(i,r),i.prototype.byteAt=function(c){return this.data.charCodeAt(this.zero+c)},i.prototype.lastIndexOfSignature=function(c){return this.data.lastIndexOf(c)-this.zero},i.prototype.readAndCheckSignature=function(c){return c===this.readData(4)},i.prototype.readData=function(c){this.checkOffset(c);var h=this.data.slice(this.zero+this.index,this.zero+this.index+c);return this.index+=c,h},o.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,o,s){var r=e("./ArrayReader");function i(c){r.call(this,c)}e("../utils").inherits(i,r),i.prototype.readData=function(c){if(this.checkOffset(c),c===0)return new Uint8Array(0);var h=this.data.subarray(this.zero+this.index,this.zero+this.index+c);return this.index+=c,h},o.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,o,s){var r=e("../utils"),i=e("../support"),c=e("./ArrayReader"),h=e("./StringReader"),_=e("./NodeBufferReader"),x=e("./Uint8ArrayReader");o.exports=function(v){var y=r.getTypeOf(v);return r.checkSupport(y),y!=="string"||i.uint8array?y==="nodebuffer"?new _(v):i.uint8array?new x(r.transformTo("uint8array",v)):new c(r.transformTo("array",v)):new h(v)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,o,s){s.LOCAL_FILE_HEADER="PK",s.CENTRAL_FILE_HEADER="PK",s.CENTRAL_DIRECTORY_END="PK",s.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",s.ZIP64_CENTRAL_DIRECTORY_END="PK",s.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,o,s){var r=e("./GenericWorker"),i=e("../utils");function c(h){r.call(this,"ConvertWorker to "+h),this.destType=h}i.inherits(c,r),c.prototype.processChunk=function(h){this.push({data:i.transformTo(this.destType,h.data),meta:h.meta})},o.exports=c},{"../utils":32,"./GenericWorker":28}],25:[function(e,o,s){var r=e("./GenericWorker"),i=e("../crc32");function c(){r.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(c,r),c.prototype.processChunk=function(h){this.streamInfo.crc32=i(h.data,this.streamInfo.crc32||0),this.push(h)},o.exports=c},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,o,s){var r=e("../utils"),i=e("./GenericWorker");function c(h){i.call(this,"DataLengthProbe for "+h),this.propName=h,this.withStreamInfo(h,0)}r.inherits(c,i),c.prototype.processChunk=function(h){if(h){var _=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=_+h.data.length}i.prototype.processChunk.call(this,h)},o.exports=c},{"../utils":32,"./GenericWorker":28}],27:[function(e,o,s){var r=e("../utils"),i=e("./GenericWorker");function c(h){i.call(this,"DataWorker");var _=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,h.then(function(x){_.dataIsReady=!0,_.data=x,_.max=x&&x.length||0,_.type=r.getTypeOf(x),_.isPaused||_._tickAndRepeat()},function(x){_.error(x)})}r.inherits(c,i),c.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},c.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,r.delay(this._tickAndRepeat,[],this)),!0)},c.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(r.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},c.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var h=null,_=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":h=this.data.substring(this.index,_);break;case"uint8array":h=this.data.subarray(this.index,_);break;case"array":case"nodebuffer":h=this.data.slice(this.index,_)}return this.index=_,this.push({data:h,meta:{percent:this.max?this.index/this.max*100:0}})},o.exports=c},{"../utils":32,"./GenericWorker":28}],28:[function(e,o,s){function r(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}r.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,c){return this._listeners[i].push(c),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,c){if(this._listeners[i])for(var h=0;h<this._listeners[i].length;h++)this._listeners[i][h].call(this,c)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var c=this;return i.on("data",function(h){c.processChunk(h)}),i.on("end",function(){c.end()}),i.on("error",function(h){c.error(h)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,c){return this.extraStreamInfo[i]=c,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},o.exports=r},{}],29:[function(e,o,s){var r=e("../utils"),i=e("./ConvertWorker"),c=e("./GenericWorker"),h=e("../base64"),_=e("../support"),x=e("../external"),v=null;if(_.nodestream)try{v=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function y(g,l){return new x.Promise(function(p,m){var b=[],S=g._internalType,k=g._outputType,E=g._mimeType;g.on("data",function(L,P){b.push(L),l&&l(P)}).on("error",function(L){b=[],m(L)}).on("end",function(){try{var L=function(P,T,N){switch(P){case"blob":return r.newBlob(r.transformTo("arraybuffer",T),N);case"base64":return h.encode(T);default:return r.transformTo(P,T)}}(k,function(P,T){var N,D=0,M=null,w=0;for(N=0;N<T.length;N++)w+=T[N].length;switch(P){case"string":return T.join("");case"array":return Array.prototype.concat.apply([],T);case"uint8array":for(M=new Uint8Array(w),N=0;N<T.length;N++)M.set(T[N],D),D+=T[N].length;return M;case"nodebuffer":return Buffer.concat(T);default:throw new Error("concat : unsupported type '"+P+"'")}}(S,b),E);p(L)}catch(P){m(P)}b=[]}).resume()})}function f(g,l,p){var m=l;switch(l){case"blob":case"arraybuffer":m="uint8array";break;case"base64":m="string"}try{this._internalType=m,this._outputType=l,this._mimeType=p,r.checkSupport(m),this._worker=g.pipe(new i(m)),g.lock()}catch(b){this._worker=new c("error"),this._worker.error(b)}}f.prototype={accumulate:function(g){return y(this,g)},on:function(g,l){var p=this;return g==="data"?this._worker.on(g,function(m){l.call(p,m.data,m.meta)}):this._worker.on(g,function(){r.delay(l,arguments,p)}),this},resume:function(){return r.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(r.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new v(this,{objectMode:this._outputType!=="nodebuffer"},g)}},o.exports=f},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,o,s){if(s.base64=!0,s.array=!0,s.string=!0,s.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",s.nodebuffer=typeof Buffer<"u",s.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")s.blob=!1;else{var r=new ArrayBuffer(0);try{s.blob=new Blob([r],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(r),s.blob=i.getBlob("application/zip").size===0}catch{s.blob=!1}}}try{s.nodestream=!!e("readable-stream").Readable}catch{s.nodestream=!1}},{"readable-stream":16}],31:[function(e,o,s){for(var r=e("./utils"),i=e("./support"),c=e("./nodejsUtils"),h=e("./stream/GenericWorker"),_=new Array(256),x=0;x<256;x++)_[x]=252<=x?6:248<=x?5:240<=x?4:224<=x?3:192<=x?2:1;_[254]=_[254]=1;function v(){h.call(this,"utf-8 decode"),this.leftOver=null}function y(){h.call(this,"utf-8 encode")}s.utf8encode=function(f){return i.nodebuffer?c.newBufferFrom(f,"utf-8"):function(g){var l,p,m,b,S,k=g.length,E=0;for(b=0;b<k;b++)(64512&(p=g.charCodeAt(b)))==55296&&b+1<k&&(64512&(m=g.charCodeAt(b+1)))==56320&&(p=65536+(p-55296<<10)+(m-56320),b++),E+=p<128?1:p<2048?2:p<65536?3:4;for(l=i.uint8array?new Uint8Array(E):new Array(E),b=S=0;S<E;b++)(64512&(p=g.charCodeAt(b)))==55296&&b+1<k&&(64512&(m=g.charCodeAt(b+1)))==56320&&(p=65536+(p-55296<<10)+(m-56320),b++),p<128?l[S++]=p:(p<2048?l[S++]=192|p>>>6:(p<65536?l[S++]=224|p>>>12:(l[S++]=240|p>>>18,l[S++]=128|p>>>12&63),l[S++]=128|p>>>6&63),l[S++]=128|63&p);return l}(f)},s.utf8decode=function(f){return i.nodebuffer?r.transformTo("nodebuffer",f).toString("utf-8"):function(g){var l,p,m,b,S=g.length,k=new Array(2*S);for(l=p=0;l<S;)if((m=g[l++])<128)k[p++]=m;else if(4<(b=_[m]))k[p++]=65533,l+=b-1;else{for(m&=b===2?31:b===3?15:7;1<b&&l<S;)m=m<<6|63&g[l++],b--;1<b?k[p++]=65533:m<65536?k[p++]=m:(m-=65536,k[p++]=55296|m>>10&1023,k[p++]=56320|1023&m)}return k.length!==p&&(k.subarray?k=k.subarray(0,p):k.length=p),r.applyFromCharCode(k)}(f=r.transformTo(i.uint8array?"uint8array":"array",f))},r.inherits(v,h),v.prototype.processChunk=function(f){var g=r.transformTo(i.uint8array?"uint8array":"array",f.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var l=g;(g=new Uint8Array(l.length+this.leftOver.length)).set(this.leftOver,0),g.set(l,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var p=function(b,S){var k;for((S=S||b.length)>b.length&&(S=b.length),k=S-1;0<=k&&(192&b[k])==128;)k--;return k<0||k===0?S:k+_[b[k]]>S?k:S}(g),m=g;p!==g.length&&(i.uint8array?(m=g.subarray(0,p),this.leftOver=g.subarray(p,g.length)):(m=g.slice(0,p),this.leftOver=g.slice(p,g.length))),this.push({data:s.utf8decode(m),meta:f.meta})},v.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:s.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},s.Utf8DecodeWorker=v,r.inherits(y,h),y.prototype.processChunk=function(f){this.push({data:s.utf8encode(f.data),meta:f.meta})},s.Utf8EncodeWorker=y},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,o,s){var r=e("./support"),i=e("./base64"),c=e("./nodejsUtils"),h=e("./external");function _(l){return l}function x(l,p){for(var m=0;m<l.length;++m)p[m]=255&l.charCodeAt(m);return p}e("setimmediate"),s.newBlob=function(l,p){s.checkSupport("blob");try{return new Blob([l],{type:p})}catch{try{var m=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return m.append(l),m.getBlob(p)}catch{throw new Error("Bug : can't construct the Blob.")}}};var v={stringifyByChunk:function(l,p,m){var b=[],S=0,k=l.length;if(k<=m)return String.fromCharCode.apply(null,l);for(;S<k;)p==="array"||p==="nodebuffer"?b.push(String.fromCharCode.apply(null,l.slice(S,Math.min(S+m,k)))):b.push(String.fromCharCode.apply(null,l.subarray(S,Math.min(S+m,k)))),S+=m;return b.join("")},stringifyByChar:function(l){for(var p="",m=0;m<l.length;m++)p+=String.fromCharCode(l[m]);return p},applyCanBeUsed:{uint8array:function(){try{return r.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return r.nodebuffer&&String.fromCharCode.apply(null,c.allocBuffer(1)).length===1}catch{return!1}}()}};function y(l){var p=65536,m=s.getTypeOf(l),b=!0;if(m==="uint8array"?b=v.applyCanBeUsed.uint8array:m==="nodebuffer"&&(b=v.applyCanBeUsed.nodebuffer),b)for(;1<p;)try{return v.stringifyByChunk(l,m,p)}catch{p=Math.floor(p/2)}return v.stringifyByChar(l)}function f(l,p){for(var m=0;m<l.length;m++)p[m]=l[m];return p}s.applyFromCharCode=y;var g={};g.string={string:_,array:function(l){return x(l,new Array(l.length))},arraybuffer:function(l){return g.string.uint8array(l).buffer},uint8array:function(l){return x(l,new Uint8Array(l.length))},nodebuffer:function(l){return x(l,c.allocBuffer(l.length))}},g.array={string:y,array:_,arraybuffer:function(l){return new Uint8Array(l).buffer},uint8array:function(l){return new Uint8Array(l)},nodebuffer:function(l){return c.newBufferFrom(l)}},g.arraybuffer={string:function(l){return y(new Uint8Array(l))},array:function(l){return f(new Uint8Array(l),new Array(l.byteLength))},arraybuffer:_,uint8array:function(l){return new Uint8Array(l)},nodebuffer:function(l){return c.newBufferFrom(new Uint8Array(l))}},g.uint8array={string:y,array:function(l){return f(l,new Array(l.length))},arraybuffer:function(l){return l.buffer},uint8array:_,nodebuffer:function(l){return c.newBufferFrom(l)}},g.nodebuffer={string:y,array:function(l){return f(l,new Array(l.length))},arraybuffer:function(l){return g.nodebuffer.uint8array(l).buffer},uint8array:function(l){return f(l,new Uint8Array(l.length))},nodebuffer:_},s.transformTo=function(l,p){if(p=p||"",!l)return p;s.checkSupport(l);var m=s.getTypeOf(p);return g[m][l](p)},s.resolve=function(l){for(var p=l.split("/"),m=[],b=0;b<p.length;b++){var S=p[b];S==="."||S===""&&b!==0&&b!==p.length-1||(S===".."?m.pop():m.push(S))}return m.join("/")},s.getTypeOf=function(l){return typeof l=="string"?"string":Object.prototype.toString.call(l)==="[object Array]"?"array":r.nodebuffer&&c.isBuffer(l)?"nodebuffer":r.uint8array&&l instanceof Uint8Array?"uint8array":r.arraybuffer&&l instanceof ArrayBuffer?"arraybuffer":void 0},s.checkSupport=function(l){if(!r[l.toLowerCase()])throw new Error(l+" is not supported by this platform")},s.MAX_VALUE_16BITS=65535,s.MAX_VALUE_32BITS=-1,s.pretty=function(l){var p,m,b="";for(m=0;m<(l||"").length;m++)b+="\\x"+((p=l.charCodeAt(m))<16?"0":"")+p.toString(16).toUpperCase();return b},s.delay=function(l,p,m){setImmediate(function(){l.apply(m||null,p||[])})},s.inherits=function(l,p){function m(){}m.prototype=p.prototype,l.prototype=new m},s.extend=function(){var l,p,m={};for(l=0;l<arguments.length;l++)for(p in arguments[l])Object.prototype.hasOwnProperty.call(arguments[l],p)&&m[p]===void 0&&(m[p]=arguments[l][p]);return m},s.prepareContent=function(l,p,m,b,S){return h.Promise.resolve(p).then(function(k){return r.blob&&(k instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(k))!==-1)&&typeof FileReader<"u"?new h.Promise(function(E,L){var P=new FileReader;P.onload=function(T){E(T.target.result)},P.onerror=function(T){L(T.target.error)},P.readAsArrayBuffer(k)}):k}).then(function(k){var E=s.getTypeOf(k);return E?(E==="arraybuffer"?k=s.transformTo("uint8array",k):E==="string"&&(S?k=i.decode(k):m&&b!==!0&&(k=function(L){return x(L,r.uint8array?new Uint8Array(L.length):new Array(L.length))}(k))),k):h.Promise.reject(new Error("Can't read the data of '"+l+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,o,s){var r=e("./reader/readerFor"),i=e("./utils"),c=e("./signature"),h=e("./zipEntry"),_=e("./support");function x(v){this.files=[],this.loadOptions=v}x.prototype={checkSignature:function(v){if(!this.reader.readAndCheckSignature(v)){this.reader.index-=4;var y=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(y)+", expected "+i.pretty(v)+")")}},isSignature:function(v,y){var f=this.reader.index;this.reader.setIndex(v);var g=this.reader.readString(4)===y;return this.reader.setIndex(f),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var v=this.reader.readData(this.zipCommentLength),y=_.uint8array?"uint8array":"array",f=i.transformTo(y,v);this.zipComment=this.loadOptions.decodeFileName(f)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var v,y,f,g=this.zip64EndOfCentralSize-44;0<g;)v=this.reader.readInt(2),y=this.reader.readInt(4),f=this.reader.readData(y),this.zip64ExtensibleData[v]={id:v,length:y,value:f}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var v,y;for(v=0;v<this.files.length;v++)y=this.files[v],this.reader.setIndex(y.localHeaderOffset),this.checkSignature(c.LOCAL_FILE_HEADER),y.readLocalPart(this.reader),y.handleUTF8(),y.processAttributes()},readCentralDir:function(){var v;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(c.CENTRAL_FILE_HEADER);)(v=new h({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(v);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var v=this.reader.lastIndexOfSignature(c.CENTRAL_DIRECTORY_END);if(v<0)throw this.isSignature(0,c.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(v);var y=v;if(this.checkSignature(c.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(v=this.reader.lastIndexOfSignature(c.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(v),this.checkSignature(c.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,c.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(c.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(c.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var f=this.centralDirOffset+this.centralDirSize;this.zip64&&(f+=20,f+=12+this.zip64EndOfCentralSize);var g=y-f;if(0<g)this.isSignature(y,c.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(v){this.reader=r(v)},load:function(v){this.prepareReader(v),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},o.exports=x},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,o,s){var r=e("./reader/readerFor"),i=e("./utils"),c=e("./compressedObject"),h=e("./crc32"),_=e("./utf8"),x=e("./compressions"),v=e("./support");function y(f,g){this.options=f,this.loadOptions=g}y.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(f){var g,l;if(f.skip(22),this.fileNameLength=f.readInt(2),l=f.readInt(2),this.fileName=f.readData(this.fileNameLength),f.skip(l),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=function(p){for(var m in x)if(Object.prototype.hasOwnProperty.call(x,m)&&x[m].magic===p)return x[m];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new c(this.compressedSize,this.uncompressedSize,this.crc32,g,f.readData(this.compressedSize))},readCentralPart:function(f){this.versionMadeBy=f.readInt(2),f.skip(2),this.bitFlag=f.readInt(2),this.compressionMethod=f.readString(2),this.date=f.readDate(),this.crc32=f.readInt(4),this.compressedSize=f.readInt(4),this.uncompressedSize=f.readInt(4);var g=f.readInt(2);if(this.extraFieldsLength=f.readInt(2),this.fileCommentLength=f.readInt(2),this.diskNumberStart=f.readInt(2),this.internalFileAttributes=f.readInt(2),this.externalFileAttributes=f.readInt(4),this.localHeaderOffset=f.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");f.skip(g),this.readExtraFields(f),this.parseZIP64ExtraField(f),this.fileComment=f.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var f=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),f==0&&(this.dosPermissions=63&this.externalFileAttributes),f==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var f=r(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=f.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=f.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=f.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=f.readInt(4))}},readExtraFields:function(f){var g,l,p,m=f.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});f.index+4<m;)g=f.readInt(2),l=f.readInt(2),p=f.readData(l),this.extraFields[g]={id:g,length:l,value:p};f.setIndex(m)},handleUTF8:function(){var f=v.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=_.utf8decode(this.fileName),this.fileCommentStr=_.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var l=i.transformTo(f,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(l)}var p=this.findExtraFieldUnicodeComment();if(p!==null)this.fileCommentStr=p;else{var m=i.transformTo(f,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(m)}}},findExtraFieldUnicodePath:function(){var f=this.extraFields[28789];if(f){var g=r(f.value);return g.readInt(1)!==1||h(this.fileName)!==g.readInt(4)?null:_.utf8decode(g.readData(f.length-5))}return null},findExtraFieldUnicodeComment:function(){var f=this.extraFields[25461];if(f){var g=r(f.value);return g.readInt(1)!==1||h(this.fileComment)!==g.readInt(4)?null:_.utf8decode(g.readData(f.length-5))}return null}},o.exports=y},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,o,s){function r(g,l,p){this.name=g,this.dir=p.dir,this.date=p.date,this.comment=p.comment,this.unixPermissions=p.unixPermissions,this.dosPermissions=p.dosPermissions,this._data=l,this._dataBinary=p.binary,this.options={compression:p.compression,compressionOptions:p.compressionOptions}}var i=e("./stream/StreamHelper"),c=e("./stream/DataWorker"),h=e("./utf8"),_=e("./compressedObject"),x=e("./stream/GenericWorker");r.prototype={internalStream:function(g){var l=null,p="string";try{if(!g)throw new Error("No output type specified.");var m=(p=g.toLowerCase())==="string"||p==="text";p!=="binarystring"&&p!=="text"||(p="string"),l=this._decompressWorker();var b=!this._dataBinary;b&&!m&&(l=l.pipe(new h.Utf8EncodeWorker)),!b&&m&&(l=l.pipe(new h.Utf8DecodeWorker))}catch(S){(l=new x("error")).error(S)}return new i(l,p,"")},async:function(g,l){return this.internalStream(g).accumulate(l)},nodeStream:function(g,l){return this.internalStream(g||"nodebuffer").toNodejsStream(l)},_compressWorker:function(g,l){if(this._data instanceof _&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var p=this._decompressWorker();return this._dataBinary||(p=p.pipe(new h.Utf8EncodeWorker)),_.createWorkerFrom(p,g,l)},_decompressWorker:function(){return this._data instanceof _?this._data.getContentWorker():this._data instanceof x?this._data:new c(this._data)}};for(var v=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],y=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},f=0;f<v.length;f++)r.prototype[v[f]]=y;o.exports=r},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,o,s){(function(r){var i,c,h=r.MutationObserver||r.WebKitMutationObserver;if(h){var _=0,x=new h(g),v=r.document.createTextNode("");x.observe(v,{characterData:!0}),i=function(){v.data=_=++_%2}}else if(r.setImmediate||r.MessageChannel===void 0)i="document"in r&&"onreadystatechange"in r.document.createElement("script")?function(){var l=r.document.createElement("script");l.onreadystatechange=function(){g(),l.onreadystatechange=null,l.parentNode.removeChild(l),l=null},r.document.documentElement.appendChild(l)}:function(){setTimeout(g,0)};else{var y=new r.MessageChannel;y.port1.onmessage=g,i=function(){y.port2.postMessage(0)}}var f=[];function g(){var l,p;c=!0;for(var m=f.length;m;){for(p=f,f=[],l=-1;++l<m;)p[l]();m=f.length}c=!1}o.exports=function(l){f.push(l)!==1||c||i()}}).call(this,typeof _t<"u"?_t:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,o,s){var r=e("immediate");function i(){}var c={},h=["REJECTED"],_=["FULFILLED"],x=["PENDING"];function v(m){if(typeof m!="function")throw new TypeError("resolver must be a function");this.state=x,this.queue=[],this.outcome=void 0,m!==i&&l(this,m)}function y(m,b,S){this.promise=m,typeof b=="function"&&(this.onFulfilled=b,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function f(m,b,S){r(function(){var k;try{k=b(S)}catch(E){return c.reject(m,E)}k===m?c.reject(m,new TypeError("Cannot resolve promise with itself")):c.resolve(m,k)})}function g(m){var b=m&&m.then;if(m&&(typeof m=="object"||typeof m=="function")&&typeof b=="function")return function(){b.apply(m,arguments)}}function l(m,b){var S=!1;function k(P){S||(S=!0,c.reject(m,P))}function E(P){S||(S=!0,c.resolve(m,P))}var L=p(function(){b(E,k)});L.status==="error"&&k(L.value)}function p(m,b){var S={};try{S.value=m(b),S.status="success"}catch(k){S.status="error",S.value=k}return S}(o.exports=v).prototype.finally=function(m){if(typeof m!="function")return this;var b=this.constructor;return this.then(function(S){return b.resolve(m()).then(function(){return S})},function(S){return b.resolve(m()).then(function(){throw S})})},v.prototype.catch=function(m){return this.then(null,m)},v.prototype.then=function(m,b){if(typeof m!="function"&&this.state===_||typeof b!="function"&&this.state===h)return this;var S=new this.constructor(i);return this.state!==x?f(S,this.state===_?m:b,this.outcome):this.queue.push(new y(S,m,b)),S},y.prototype.callFulfilled=function(m){c.resolve(this.promise,m)},y.prototype.otherCallFulfilled=function(m){f(this.promise,this.onFulfilled,m)},y.prototype.callRejected=function(m){c.reject(this.promise,m)},y.prototype.otherCallRejected=function(m){f(this.promise,this.onRejected,m)},c.resolve=function(m,b){var S=p(g,b);if(S.status==="error")return c.reject(m,S.value);var k=S.value;if(k)l(m,k);else{m.state=_,m.outcome=b;for(var E=-1,L=m.queue.length;++E<L;)m.queue[E].callFulfilled(b)}return m},c.reject=function(m,b){m.state=h,m.outcome=b;for(var S=-1,k=m.queue.length;++S<k;)m.queue[S].callRejected(b);return m},v.resolve=function(m){return m instanceof this?m:c.resolve(new this(i),m)},v.reject=function(m){var b=new this(i);return c.reject(b,m)},v.all=function(m){var b=this;if(Object.prototype.toString.call(m)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=m.length,k=!1;if(!S)return this.resolve([]);for(var E=new Array(S),L=0,P=-1,T=new this(i);++P<S;)N(m[P],P);return T;function N(D,M){b.resolve(D).then(function(w){E[M]=w,++L!==S||k||(k=!0,c.resolve(T,E))},function(w){k||(k=!0,c.reject(T,w))})}},v.race=function(m){var b=this;if(Object.prototype.toString.call(m)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=m.length,k=!1;if(!S)return this.resolve([]);for(var E=-1,L=new this(i);++E<S;)P=m[E],b.resolve(P).then(function(T){k||(k=!0,c.resolve(L,T))},function(T){k||(k=!0,c.reject(L,T))});var P;return L}},{immediate:36}],38:[function(e,o,s){var r={};(0,e("./lib/utils/common").assign)(r,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),o.exports=r},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,o,s){var r=e("./zlib/deflate"),i=e("./utils/common"),c=e("./utils/strings"),h=e("./zlib/messages"),_=e("./zlib/zstream"),x=Object.prototype.toString,v=0,y=-1,f=0,g=8;function l(m){if(!(this instanceof l))return new l(m);this.options=i.assign({level:y,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:f,to:""},m||{});var b=this.options;b.raw&&0<b.windowBits?b.windowBits=-b.windowBits:b.gzip&&0<b.windowBits&&b.windowBits<16&&(b.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _,this.strm.avail_out=0;var S=r.deflateInit2(this.strm,b.level,b.method,b.windowBits,b.memLevel,b.strategy);if(S!==v)throw new Error(h[S]);if(b.header&&r.deflateSetHeader(this.strm,b.header),b.dictionary){var k;if(k=typeof b.dictionary=="string"?c.string2buf(b.dictionary):x.call(b.dictionary)==="[object ArrayBuffer]"?new Uint8Array(b.dictionary):b.dictionary,(S=r.deflateSetDictionary(this.strm,k))!==v)throw new Error(h[S]);this._dict_set=!0}}function p(m,b){var S=new l(b);if(S.push(m,!0),S.err)throw S.msg||h[S.err];return S.result}l.prototype.push=function(m,b){var S,k,E=this.strm,L=this.options.chunkSize;if(this.ended)return!1;k=b===~~b?b:b===!0?4:0,typeof m=="string"?E.input=c.string2buf(m):x.call(m)==="[object ArrayBuffer]"?E.input=new Uint8Array(m):E.input=m,E.next_in=0,E.avail_in=E.input.length;do{if(E.avail_out===0&&(E.output=new i.Buf8(L),E.next_out=0,E.avail_out=L),(S=r.deflate(E,k))!==1&&S!==v)return this.onEnd(S),!(this.ended=!0);E.avail_out!==0&&(E.avail_in!==0||k!==4&&k!==2)||(this.options.to==="string"?this.onData(c.buf2binstring(i.shrinkBuf(E.output,E.next_out))):this.onData(i.shrinkBuf(E.output,E.next_out)))}while((0<E.avail_in||E.avail_out===0)&&S!==1);return k===4?(S=r.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===v):k!==2||(this.onEnd(v),!(E.avail_out=0))},l.prototype.onData=function(m){this.chunks.push(m)},l.prototype.onEnd=function(m){m===v&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},s.Deflate=l,s.deflate=p,s.deflateRaw=function(m,b){return(b=b||{}).raw=!0,p(m,b)},s.gzip=function(m,b){return(b=b||{}).gzip=!0,p(m,b)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,o,s){var r=e("./zlib/inflate"),i=e("./utils/common"),c=e("./utils/strings"),h=e("./zlib/constants"),_=e("./zlib/messages"),x=e("./zlib/zstream"),v=e("./zlib/gzheader"),y=Object.prototype.toString;function f(l){if(!(this instanceof f))return new f(l);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},l||{});var p=this.options;p.raw&&0<=p.windowBits&&p.windowBits<16&&(p.windowBits=-p.windowBits,p.windowBits===0&&(p.windowBits=-15)),!(0<=p.windowBits&&p.windowBits<16)||l&&l.windowBits||(p.windowBits+=32),15<p.windowBits&&p.windowBits<48&&!(15&p.windowBits)&&(p.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new x,this.strm.avail_out=0;var m=r.inflateInit2(this.strm,p.windowBits);if(m!==h.Z_OK)throw new Error(_[m]);this.header=new v,r.inflateGetHeader(this.strm,this.header)}function g(l,p){var m=new f(p);if(m.push(l,!0),m.err)throw m.msg||_[m.err];return m.result}f.prototype.push=function(l,p){var m,b,S,k,E,L,P=this.strm,T=this.options.chunkSize,N=this.options.dictionary,D=!1;if(this.ended)return!1;b=p===~~p?p:p===!0?h.Z_FINISH:h.Z_NO_FLUSH,typeof l=="string"?P.input=c.binstring2buf(l):y.call(l)==="[object ArrayBuffer]"?P.input=new Uint8Array(l):P.input=l,P.next_in=0,P.avail_in=P.input.length;do{if(P.avail_out===0&&(P.output=new i.Buf8(T),P.next_out=0,P.avail_out=T),(m=r.inflate(P,h.Z_NO_FLUSH))===h.Z_NEED_DICT&&N&&(L=typeof N=="string"?c.string2buf(N):y.call(N)==="[object ArrayBuffer]"?new Uint8Array(N):N,m=r.inflateSetDictionary(this.strm,L)),m===h.Z_BUF_ERROR&&D===!0&&(m=h.Z_OK,D=!1),m!==h.Z_STREAM_END&&m!==h.Z_OK)return this.onEnd(m),!(this.ended=!0);P.next_out&&(P.avail_out!==0&&m!==h.Z_STREAM_END&&(P.avail_in!==0||b!==h.Z_FINISH&&b!==h.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=c.utf8border(P.output,P.next_out),k=P.next_out-S,E=c.buf2string(P.output,S),P.next_out=k,P.avail_out=T-k,k&&i.arraySet(P.output,P.output,S,k,0),this.onData(E)):this.onData(i.shrinkBuf(P.output,P.next_out)))),P.avail_in===0&&P.avail_out===0&&(D=!0)}while((0<P.avail_in||P.avail_out===0)&&m!==h.Z_STREAM_END);return m===h.Z_STREAM_END&&(b=h.Z_FINISH),b===h.Z_FINISH?(m=r.inflateEnd(this.strm),this.onEnd(m),this.ended=!0,m===h.Z_OK):b!==h.Z_SYNC_FLUSH||(this.onEnd(h.Z_OK),!(P.avail_out=0))},f.prototype.onData=function(l){this.chunks.push(l)},f.prototype.onEnd=function(l){l===h.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=l,this.msg=this.strm.msg},s.Inflate=f,s.inflate=g,s.inflateRaw=function(l,p){return(p=p||{}).raw=!0,g(l,p)},s.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,o,s){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";s.assign=function(h){for(var _=Array.prototype.slice.call(arguments,1);_.length;){var x=_.shift();if(x){if(typeof x!="object")throw new TypeError(x+"must be non-object");for(var v in x)x.hasOwnProperty(v)&&(h[v]=x[v])}}return h},s.shrinkBuf=function(h,_){return h.length===_?h:h.subarray?h.subarray(0,_):(h.length=_,h)};var i={arraySet:function(h,_,x,v,y){if(_.subarray&&h.subarray)h.set(_.subarray(x,x+v),y);else for(var f=0;f<v;f++)h[y+f]=_[x+f]},flattenChunks:function(h){var _,x,v,y,f,g;for(_=v=0,x=h.length;_<x;_++)v+=h[_].length;for(g=new Uint8Array(v),_=y=0,x=h.length;_<x;_++)f=h[_],g.set(f,y),y+=f.length;return g}},c={arraySet:function(h,_,x,v,y){for(var f=0;f<v;f++)h[y+f]=_[x+f]},flattenChunks:function(h){return[].concat.apply([],h)}};s.setTyped=function(h){h?(s.Buf8=Uint8Array,s.Buf16=Uint16Array,s.Buf32=Int32Array,s.assign(s,i)):(s.Buf8=Array,s.Buf16=Array,s.Buf32=Array,s.assign(s,c))},s.setTyped(r)},{}],42:[function(e,o,s){var r=e("./common"),i=!0,c=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{c=!1}for(var h=new r.Buf8(256),_=0;_<256;_++)h[_]=252<=_?6:248<=_?5:240<=_?4:224<=_?3:192<=_?2:1;function x(v,y){if(y<65537&&(v.subarray&&c||!v.subarray&&i))return String.fromCharCode.apply(null,r.shrinkBuf(v,y));for(var f="",g=0;g<y;g++)f+=String.fromCharCode(v[g]);return f}h[254]=h[254]=1,s.string2buf=function(v){var y,f,g,l,p,m=v.length,b=0;for(l=0;l<m;l++)(64512&(f=v.charCodeAt(l)))==55296&&l+1<m&&(64512&(g=v.charCodeAt(l+1)))==56320&&(f=65536+(f-55296<<10)+(g-56320),l++),b+=f<128?1:f<2048?2:f<65536?3:4;for(y=new r.Buf8(b),l=p=0;p<b;l++)(64512&(f=v.charCodeAt(l)))==55296&&l+1<m&&(64512&(g=v.charCodeAt(l+1)))==56320&&(f=65536+(f-55296<<10)+(g-56320),l++),f<128?y[p++]=f:(f<2048?y[p++]=192|f>>>6:(f<65536?y[p++]=224|f>>>12:(y[p++]=240|f>>>18,y[p++]=128|f>>>12&63),y[p++]=128|f>>>6&63),y[p++]=128|63&f);return y},s.buf2binstring=function(v){return x(v,v.length)},s.binstring2buf=function(v){for(var y=new r.Buf8(v.length),f=0,g=y.length;f<g;f++)y[f]=v.charCodeAt(f);return y},s.buf2string=function(v,y){var f,g,l,p,m=y||v.length,b=new Array(2*m);for(f=g=0;f<m;)if((l=v[f++])<128)b[g++]=l;else if(4<(p=h[l]))b[g++]=65533,f+=p-1;else{for(l&=p===2?31:p===3?15:7;1<p&&f<m;)l=l<<6|63&v[f++],p--;1<p?b[g++]=65533:l<65536?b[g++]=l:(l-=65536,b[g++]=55296|l>>10&1023,b[g++]=56320|1023&l)}return x(b,g)},s.utf8border=function(v,y){var f;for((y=y||v.length)>v.length&&(y=v.length),f=y-1;0<=f&&(192&v[f])==128;)f--;return f<0||f===0?y:f+h[v[f]]>y?f:y}},{"./common":41}],43:[function(e,o,s){o.exports=function(r,i,c,h){for(var _=65535&r|0,x=r>>>16&65535|0,v=0;c!==0;){for(c-=v=2e3<c?2e3:c;x=x+(_=_+i[h++]|0)|0,--v;);_%=65521,x%=65521}return _|x<<16|0}},{}],44:[function(e,o,s){o.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,o,s){var r=function(){for(var i,c=[],h=0;h<256;h++){i=h;for(var _=0;_<8;_++)i=1&i?3988292384^i>>>1:i>>>1;c[h]=i}return c}();o.exports=function(i,c,h,_){var x=r,v=_+h;i^=-1;for(var y=_;y<v;y++)i=i>>>8^x[255&(i^c[y])];return-1^i}},{}],46:[function(e,o,s){var r,i=e("../utils/common"),c=e("./trees"),h=e("./adler32"),_=e("./crc32"),x=e("./messages"),v=0,y=4,f=0,g=-2,l=-1,p=4,m=2,b=8,S=9,k=286,E=30,L=19,P=2*k+1,T=15,N=3,D=258,M=D+N+1,w=42,A=113,d=1,U=2,Y=3,z=4;function X(u,$){return u.msg=x[$],$}function H(u){return(u<<1)-(4<u?9:0)}function Q(u){for(var $=u.length;0<=--$;)u[$]=0}function I(u){var $=u.state,W=$.pending;W>u.avail_out&&(W=u.avail_out),W!==0&&(i.arraySet(u.output,$.pending_buf,$.pending_out,W,u.next_out),u.next_out+=W,$.pending_out+=W,u.total_out+=W,u.avail_out-=W,$.pending-=W,$.pending===0&&($.pending_out=0))}function R(u,$){c._tr_flush_block(u,0<=u.block_start?u.block_start:-1,u.strstart-u.block_start,$),u.block_start=u.strstart,I(u.strm)}function J(u,$){u.pending_buf[u.pending++]=$}function Z(u,$){u.pending_buf[u.pending++]=$>>>8&255,u.pending_buf[u.pending++]=255&$}function G(u,$){var W,j,C=u.max_chain_length,O=u.strstart,K=u.prev_length,q=u.nice_match,F=u.strstart>u.w_size-M?u.strstart-(u.w_size-M):0,ee=u.window,se=u.w_mask,ne=u.prev,le=u.strstart+D,me=ee[O+K-1],fe=ee[O+K];u.prev_length>=u.good_match&&(C>>=2),q>u.lookahead&&(q=u.lookahead);do if(ee[(W=$)+K]===fe&&ee[W+K-1]===me&&ee[W]===ee[O]&&ee[++W]===ee[O+1]){O+=2,W++;do;while(ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&ee[++O]===ee[++W]&&O<le);if(j=D-(le-O),O=le-D,K<j){if(u.match_start=$,q<=(K=j))break;me=ee[O+K-1],fe=ee[O+K]}}while(($=ne[$&se])>F&&--C!=0);return K<=u.lookahead?K:u.lookahead}function te(u){var $,W,j,C,O,K,q,F,ee,se,ne=u.w_size;do{if(C=u.window_size-u.lookahead-u.strstart,u.strstart>=ne+(ne-M)){for(i.arraySet(u.window,u.window,ne,ne,0),u.match_start-=ne,u.strstart-=ne,u.block_start-=ne,$=W=u.hash_size;j=u.head[--$],u.head[$]=ne<=j?j-ne:0,--W;);for($=W=ne;j=u.prev[--$],u.prev[$]=ne<=j?j-ne:0,--W;);C+=ne}if(u.strm.avail_in===0)break;if(K=u.strm,q=u.window,F=u.strstart+u.lookahead,ee=C,se=void 0,se=K.avail_in,ee<se&&(se=ee),W=se===0?0:(K.avail_in-=se,i.arraySet(q,K.input,K.next_in,se,F),K.state.wrap===1?K.adler=h(K.adler,q,se,F):K.state.wrap===2&&(K.adler=_(K.adler,q,se,F)),K.next_in+=se,K.total_in+=se,se),u.lookahead+=W,u.lookahead+u.insert>=N)for(O=u.strstart-u.insert,u.ins_h=u.window[O],u.ins_h=(u.ins_h<<u.hash_shift^u.window[O+1])&u.hash_mask;u.insert&&(u.ins_h=(u.ins_h<<u.hash_shift^u.window[O+N-1])&u.hash_mask,u.prev[O&u.w_mask]=u.head[u.ins_h],u.head[u.ins_h]=O,O++,u.insert--,!(u.lookahead+u.insert<N)););}while(u.lookahead<M&&u.strm.avail_in!==0)}function oe(u,$){for(var W,j;;){if(u.lookahead<M){if(te(u),u.lookahead<M&&$===v)return d;if(u.lookahead===0)break}if(W=0,u.lookahead>=N&&(u.ins_h=(u.ins_h<<u.hash_shift^u.window[u.strstart+N-1])&u.hash_mask,W=u.prev[u.strstart&u.w_mask]=u.head[u.ins_h],u.head[u.ins_h]=u.strstart),W!==0&&u.strstart-W<=u.w_size-M&&(u.match_length=G(u,W)),u.match_length>=N)if(j=c._tr_tally(u,u.strstart-u.match_start,u.match_length-N),u.lookahead-=u.match_length,u.match_length<=u.max_lazy_match&&u.lookahead>=N){for(u.match_length--;u.strstart++,u.ins_h=(u.ins_h<<u.hash_shift^u.window[u.strstart+N-1])&u.hash_mask,W=u.prev[u.strstart&u.w_mask]=u.head[u.ins_h],u.head[u.ins_h]=u.strstart,--u.match_length!=0;);u.strstart++}else u.strstart+=u.match_length,u.match_length=0,u.ins_h=u.window[u.strstart],u.ins_h=(u.ins_h<<u.hash_shift^u.window[u.strstart+1])&u.hash_mask;else j=c._tr_tally(u,0,u.window[u.strstart]),u.lookahead--,u.strstart++;if(j&&(R(u,!1),u.strm.avail_out===0))return d}return u.insert=u.strstart<N-1?u.strstart:N-1,$===y?(R(u,!0),u.strm.avail_out===0?Y:z):u.last_lit&&(R(u,!1),u.strm.avail_out===0)?d:U}function V(u,$){for(var W,j,C;;){if(u.lookahead<M){if(te(u),u.lookahead<M&&$===v)return d;if(u.lookahead===0)break}if(W=0,u.lookahead>=N&&(u.ins_h=(u.ins_h<<u.hash_shift^u.window[u.strstart+N-1])&u.hash_mask,W=u.prev[u.strstart&u.w_mask]=u.head[u.ins_h],u.head[u.ins_h]=u.strstart),u.prev_length=u.match_length,u.prev_match=u.match_start,u.match_length=N-1,W!==0&&u.prev_length<u.max_lazy_match&&u.strstart-W<=u.w_size-M&&(u.match_length=G(u,W),u.match_length<=5&&(u.strategy===1||u.match_length===N&&4096<u.strstart-u.match_start)&&(u.match_length=N-1)),u.prev_length>=N&&u.match_length<=u.prev_length){for(C=u.strstart+u.lookahead-N,j=c._tr_tally(u,u.strstart-1-u.prev_match,u.prev_length-N),u.lookahead-=u.prev_length-1,u.prev_length-=2;++u.strstart<=C&&(u.ins_h=(u.ins_h<<u.hash_shift^u.window[u.strstart+N-1])&u.hash_mask,W=u.prev[u.strstart&u.w_mask]=u.head[u.ins_h],u.head[u.ins_h]=u.strstart),--u.prev_length!=0;);if(u.match_available=0,u.match_length=N-1,u.strstart++,j&&(R(u,!1),u.strm.avail_out===0))return d}else if(u.match_available){if((j=c._tr_tally(u,0,u.window[u.strstart-1]))&&R(u,!1),u.strstart++,u.lookahead--,u.strm.avail_out===0)return d}else u.match_available=1,u.strstart++,u.lookahead--}return u.match_available&&(j=c._tr_tally(u,0,u.window[u.strstart-1]),u.match_available=0),u.insert=u.strstart<N-1?u.strstart:N-1,$===y?(R(u,!0),u.strm.avail_out===0?Y:z):u.last_lit&&(R(u,!1),u.strm.avail_out===0)?d:U}function ce(u,$,W,j,C){this.good_length=u,this.max_lazy=$,this.nice_length=W,this.max_chain=j,this.func=C}function ie(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=b,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*P),this.dyn_dtree=new i.Buf16(2*(2*E+1)),this.bl_tree=new i.Buf16(2*(2*L+1)),Q(this.dyn_ltree),Q(this.dyn_dtree),Q(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(T+1),this.heap=new i.Buf16(2*k+1),Q(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*k+1),Q(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function ue(u){var $;return u&&u.state?(u.total_in=u.total_out=0,u.data_type=m,($=u.state).pending=0,$.pending_out=0,$.wrap<0&&($.wrap=-$.wrap),$.status=$.wrap?w:A,u.adler=$.wrap===2?0:1,$.last_flush=v,c._tr_init($),f):X(u,g)}function pe(u){var $=ue(u);return $===f&&function(W){W.window_size=2*W.w_size,Q(W.head),W.max_lazy_match=r[W.level].max_lazy,W.good_match=r[W.level].good_length,W.nice_match=r[W.level].nice_length,W.max_chain_length=r[W.level].max_chain,W.strstart=0,W.block_start=0,W.lookahead=0,W.insert=0,W.match_length=W.prev_length=N-1,W.match_available=0,W.ins_h=0}(u.state),$}function be(u,$,W,j,C,O){if(!u)return g;var K=1;if($===l&&($=6),j<0?(K=0,j=-j):15<j&&(K=2,j-=16),C<1||S<C||W!==b||j<8||15<j||$<0||9<$||O<0||p<O)return X(u,g);j===8&&(j=9);var q=new ie;return(u.state=q).strm=u,q.wrap=K,q.gzhead=null,q.w_bits=j,q.w_size=1<<q.w_bits,q.w_mask=q.w_size-1,q.hash_bits=C+7,q.hash_size=1<<q.hash_bits,q.hash_mask=q.hash_size-1,q.hash_shift=~~((q.hash_bits+N-1)/N),q.window=new i.Buf8(2*q.w_size),q.head=new i.Buf16(q.hash_size),q.prev=new i.Buf16(q.w_size),q.lit_bufsize=1<<C+6,q.pending_buf_size=4*q.lit_bufsize,q.pending_buf=new i.Buf8(q.pending_buf_size),q.d_buf=1*q.lit_bufsize,q.l_buf=3*q.lit_bufsize,q.level=$,q.strategy=O,q.method=W,pe(u)}r=[new ce(0,0,0,0,function(u,$){var W=65535;for(W>u.pending_buf_size-5&&(W=u.pending_buf_size-5);;){if(u.lookahead<=1){if(te(u),u.lookahead===0&&$===v)return d;if(u.lookahead===0)break}u.strstart+=u.lookahead,u.lookahead=0;var j=u.block_start+W;if((u.strstart===0||u.strstart>=j)&&(u.lookahead=u.strstart-j,u.strstart=j,R(u,!1),u.strm.avail_out===0)||u.strstart-u.block_start>=u.w_size-M&&(R(u,!1),u.strm.avail_out===0))return d}return u.insert=0,$===y?(R(u,!0),u.strm.avail_out===0?Y:z):(u.strstart>u.block_start&&(R(u,!1),u.strm.avail_out),d)}),new ce(4,4,8,4,oe),new ce(4,5,16,8,oe),new ce(4,6,32,32,oe),new ce(4,4,16,16,V),new ce(8,16,32,32,V),new ce(8,16,128,128,V),new ce(8,32,128,256,V),new ce(32,128,258,1024,V),new ce(32,258,258,4096,V)],s.deflateInit=function(u,$){return be(u,$,b,15,8,0)},s.deflateInit2=be,s.deflateReset=pe,s.deflateResetKeep=ue,s.deflateSetHeader=function(u,$){return u&&u.state?u.state.wrap!==2?g:(u.state.gzhead=$,f):g},s.deflate=function(u,$){var W,j,C,O;if(!u||!u.state||5<$||$<0)return u?X(u,g):g;if(j=u.state,!u.output||!u.input&&u.avail_in!==0||j.status===666&&$!==y)return X(u,u.avail_out===0?-5:g);if(j.strm=u,W=j.last_flush,j.last_flush=$,j.status===w)if(j.wrap===2)u.adler=0,J(j,31),J(j,139),J(j,8),j.gzhead?(J(j,(j.gzhead.text?1:0)+(j.gzhead.hcrc?2:0)+(j.gzhead.extra?4:0)+(j.gzhead.name?8:0)+(j.gzhead.comment?16:0)),J(j,255&j.gzhead.time),J(j,j.gzhead.time>>8&255),J(j,j.gzhead.time>>16&255),J(j,j.gzhead.time>>24&255),J(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),J(j,255&j.gzhead.os),j.gzhead.extra&&j.gzhead.extra.length&&(J(j,255&j.gzhead.extra.length),J(j,j.gzhead.extra.length>>8&255)),j.gzhead.hcrc&&(u.adler=_(u.adler,j.pending_buf,j.pending,0)),j.gzindex=0,j.status=69):(J(j,0),J(j,0),J(j,0),J(j,0),J(j,0),J(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),J(j,3),j.status=A);else{var K=b+(j.w_bits-8<<4)<<8;K|=(2<=j.strategy||j.level<2?0:j.level<6?1:j.level===6?2:3)<<6,j.strstart!==0&&(K|=32),K+=31-K%31,j.status=A,Z(j,K),j.strstart!==0&&(Z(j,u.adler>>>16),Z(j,65535&u.adler)),u.adler=1}if(j.status===69)if(j.gzhead.extra){for(C=j.pending;j.gzindex<(65535&j.gzhead.extra.length)&&(j.pending!==j.pending_buf_size||(j.gzhead.hcrc&&j.pending>C&&(u.adler=_(u.adler,j.pending_buf,j.pending-C,C)),I(u),C=j.pending,j.pending!==j.pending_buf_size));)J(j,255&j.gzhead.extra[j.gzindex]),j.gzindex++;j.gzhead.hcrc&&j.pending>C&&(u.adler=_(u.adler,j.pending_buf,j.pending-C,C)),j.gzindex===j.gzhead.extra.length&&(j.gzindex=0,j.status=73)}else j.status=73;if(j.status===73)if(j.gzhead.name){C=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>C&&(u.adler=_(u.adler,j.pending_buf,j.pending-C,C)),I(u),C=j.pending,j.pending===j.pending_buf_size)){O=1;break}O=j.gzindex<j.gzhead.name.length?255&j.gzhead.name.charCodeAt(j.gzindex++):0,J(j,O)}while(O!==0);j.gzhead.hcrc&&j.pending>C&&(u.adler=_(u.adler,j.pending_buf,j.pending-C,C)),O===0&&(j.gzindex=0,j.status=91)}else j.status=91;if(j.status===91)if(j.gzhead.comment){C=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>C&&(u.adler=_(u.adler,j.pending_buf,j.pending-C,C)),I(u),C=j.pending,j.pending===j.pending_buf_size)){O=1;break}O=j.gzindex<j.gzhead.comment.length?255&j.gzhead.comment.charCodeAt(j.gzindex++):0,J(j,O)}while(O!==0);j.gzhead.hcrc&&j.pending>C&&(u.adler=_(u.adler,j.pending_buf,j.pending-C,C)),O===0&&(j.status=103)}else j.status=103;if(j.status===103&&(j.gzhead.hcrc?(j.pending+2>j.pending_buf_size&&I(u),j.pending+2<=j.pending_buf_size&&(J(j,255&u.adler),J(j,u.adler>>8&255),u.adler=0,j.status=A)):j.status=A),j.pending!==0){if(I(u),u.avail_out===0)return j.last_flush=-1,f}else if(u.avail_in===0&&H($)<=H(W)&&$!==y)return X(u,-5);if(j.status===666&&u.avail_in!==0)return X(u,-5);if(u.avail_in!==0||j.lookahead!==0||$!==v&&j.status!==666){var q=j.strategy===2?function(F,ee){for(var se;;){if(F.lookahead===0&&(te(F),F.lookahead===0)){if(ee===v)return d;break}if(F.match_length=0,se=c._tr_tally(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++,se&&(R(F,!1),F.strm.avail_out===0))return d}return F.insert=0,ee===y?(R(F,!0),F.strm.avail_out===0?Y:z):F.last_lit&&(R(F,!1),F.strm.avail_out===0)?d:U}(j,$):j.strategy===3?function(F,ee){for(var se,ne,le,me,fe=F.window;;){if(F.lookahead<=D){if(te(F),F.lookahead<=D&&ee===v)return d;if(F.lookahead===0)break}if(F.match_length=0,F.lookahead>=N&&0<F.strstart&&(ne=fe[le=F.strstart-1])===fe[++le]&&ne===fe[++le]&&ne===fe[++le]){me=F.strstart+D;do;while(ne===fe[++le]&&ne===fe[++le]&&ne===fe[++le]&&ne===fe[++le]&&ne===fe[++le]&&ne===fe[++le]&&ne===fe[++le]&&ne===fe[++le]&&le<me);F.match_length=D-(me-le),F.match_length>F.lookahead&&(F.match_length=F.lookahead)}if(F.match_length>=N?(se=c._tr_tally(F,1,F.match_length-N),F.lookahead-=F.match_length,F.strstart+=F.match_length,F.match_length=0):(se=c._tr_tally(F,0,F.window[F.strstart]),F.lookahead--,F.strstart++),se&&(R(F,!1),F.strm.avail_out===0))return d}return F.insert=0,ee===y?(R(F,!0),F.strm.avail_out===0?Y:z):F.last_lit&&(R(F,!1),F.strm.avail_out===0)?d:U}(j,$):r[j.level].func(j,$);if(q!==Y&&q!==z||(j.status=666),q===d||q===Y)return u.avail_out===0&&(j.last_flush=-1),f;if(q===U&&($===1?c._tr_align(j):$!==5&&(c._tr_stored_block(j,0,0,!1),$===3&&(Q(j.head),j.lookahead===0&&(j.strstart=0,j.block_start=0,j.insert=0))),I(u),u.avail_out===0))return j.last_flush=-1,f}return $!==y?f:j.wrap<=0?1:(j.wrap===2?(J(j,255&u.adler),J(j,u.adler>>8&255),J(j,u.adler>>16&255),J(j,u.adler>>24&255),J(j,255&u.total_in),J(j,u.total_in>>8&255),J(j,u.total_in>>16&255),J(j,u.total_in>>24&255)):(Z(j,u.adler>>>16),Z(j,65535&u.adler)),I(u),0<j.wrap&&(j.wrap=-j.wrap),j.pending!==0?f:1)},s.deflateEnd=function(u){var $;return u&&u.state?($=u.state.status)!==w&&$!==69&&$!==73&&$!==91&&$!==103&&$!==A&&$!==666?X(u,g):(u.state=null,$===A?X(u,-3):f):g},s.deflateSetDictionary=function(u,$){var W,j,C,O,K,q,F,ee,se=$.length;if(!u||!u.state||(O=(W=u.state).wrap)===2||O===1&&W.status!==w||W.lookahead)return g;for(O===1&&(u.adler=h(u.adler,$,se,0)),W.wrap=0,se>=W.w_size&&(O===0&&(Q(W.head),W.strstart=0,W.block_start=0,W.insert=0),ee=new i.Buf8(W.w_size),i.arraySet(ee,$,se-W.w_size,W.w_size,0),$=ee,se=W.w_size),K=u.avail_in,q=u.next_in,F=u.input,u.avail_in=se,u.next_in=0,u.input=$,te(W);W.lookahead>=N;){for(j=W.strstart,C=W.lookahead-(N-1);W.ins_h=(W.ins_h<<W.hash_shift^W.window[j+N-1])&W.hash_mask,W.prev[j&W.w_mask]=W.head[W.ins_h],W.head[W.ins_h]=j,j++,--C;);W.strstart=j,W.lookahead=N-1,te(W)}return W.strstart+=W.lookahead,W.block_start=W.strstart,W.insert=W.lookahead,W.lookahead=0,W.match_length=W.prev_length=N-1,W.match_available=0,u.next_in=q,u.input=F,u.avail_in=K,W.wrap=O,f},s.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,o,s){o.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,o,s){o.exports=function(r,i){var c,h,_,x,v,y,f,g,l,p,m,b,S,k,E,L,P,T,N,D,M,w,A,d,U;c=r.state,h=r.next_in,d=r.input,_=h+(r.avail_in-5),x=r.next_out,U=r.output,v=x-(i-r.avail_out),y=x+(r.avail_out-257),f=c.dmax,g=c.wsize,l=c.whave,p=c.wnext,m=c.window,b=c.hold,S=c.bits,k=c.lencode,E=c.distcode,L=(1<<c.lenbits)-1,P=(1<<c.distbits)-1;e:do{S<15&&(b+=d[h++]<<S,S+=8,b+=d[h++]<<S,S+=8),T=k[b&L];t:for(;;){if(b>>>=N=T>>>24,S-=N,(N=T>>>16&255)===0)U[x++]=65535&T;else{if(!(16&N)){if(!(64&N)){T=k[(65535&T)+(b&(1<<N)-1)];continue t}if(32&N){c.mode=12;break e}r.msg="invalid literal/length code",c.mode=30;break e}D=65535&T,(N&=15)&&(S<N&&(b+=d[h++]<<S,S+=8),D+=b&(1<<N)-1,b>>>=N,S-=N),S<15&&(b+=d[h++]<<S,S+=8,b+=d[h++]<<S,S+=8),T=E[b&P];n:for(;;){if(b>>>=N=T>>>24,S-=N,!(16&(N=T>>>16&255))){if(!(64&N)){T=E[(65535&T)+(b&(1<<N)-1)];continue n}r.msg="invalid distance code",c.mode=30;break e}if(M=65535&T,S<(N&=15)&&(b+=d[h++]<<S,(S+=8)<N&&(b+=d[h++]<<S,S+=8)),f<(M+=b&(1<<N)-1)){r.msg="invalid distance too far back",c.mode=30;break e}if(b>>>=N,S-=N,(N=x-v)<M){if(l<(N=M-N)&&c.sane){r.msg="invalid distance too far back",c.mode=30;break e}if(A=m,(w=0)===p){if(w+=g-N,N<D){for(D-=N;U[x++]=m[w++],--N;);w=x-M,A=U}}else if(p<N){if(w+=g+p-N,(N-=p)<D){for(D-=N;U[x++]=m[w++],--N;);if(w=0,p<D){for(D-=N=p;U[x++]=m[w++],--N;);w=x-M,A=U}}}else if(w+=p-N,N<D){for(D-=N;U[x++]=m[w++],--N;);w=x-M,A=U}for(;2<D;)U[x++]=A[w++],U[x++]=A[w++],U[x++]=A[w++],D-=3;D&&(U[x++]=A[w++],1<D&&(U[x++]=A[w++]))}else{for(w=x-M;U[x++]=U[w++],U[x++]=U[w++],U[x++]=U[w++],2<(D-=3););D&&(U[x++]=U[w++],1<D&&(U[x++]=U[w++]))}break}}break}}while(h<_&&x<y);h-=D=S>>3,b&=(1<<(S-=D<<3))-1,r.next_in=h,r.next_out=x,r.avail_in=h<_?_-h+5:5-(h-_),r.avail_out=x<y?y-x+257:257-(x-y),c.hold=b,c.bits=S}},{}],49:[function(e,o,s){var r=e("../utils/common"),i=e("./adler32"),c=e("./crc32"),h=e("./inffast"),_=e("./inftrees"),x=1,v=2,y=0,f=-2,g=1,l=852,p=592;function m(w){return(w>>>24&255)+(w>>>8&65280)+((65280&w)<<8)+((255&w)<<24)}function b(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(w){var A;return w&&w.state?(A=w.state,w.total_in=w.total_out=A.total=0,w.msg="",A.wrap&&(w.adler=1&A.wrap),A.mode=g,A.last=0,A.havedict=0,A.dmax=32768,A.head=null,A.hold=0,A.bits=0,A.lencode=A.lendyn=new r.Buf32(l),A.distcode=A.distdyn=new r.Buf32(p),A.sane=1,A.back=-1,y):f}function k(w){var A;return w&&w.state?((A=w.state).wsize=0,A.whave=0,A.wnext=0,S(w)):f}function E(w,A){var d,U;return w&&w.state?(U=w.state,A<0?(d=0,A=-A):(d=1+(A>>4),A<48&&(A&=15)),A&&(A<8||15<A)?f:(U.window!==null&&U.wbits!==A&&(U.window=null),U.wrap=d,U.wbits=A,k(w))):f}function L(w,A){var d,U;return w?(U=new b,(w.state=U).window=null,(d=E(w,A))!==y&&(w.state=null),d):f}var P,T,N=!0;function D(w){if(N){var A;for(P=new r.Buf32(512),T=new r.Buf32(32),A=0;A<144;)w.lens[A++]=8;for(;A<256;)w.lens[A++]=9;for(;A<280;)w.lens[A++]=7;for(;A<288;)w.lens[A++]=8;for(_(x,w.lens,0,288,P,0,w.work,{bits:9}),A=0;A<32;)w.lens[A++]=5;_(v,w.lens,0,32,T,0,w.work,{bits:5}),N=!1}w.lencode=P,w.lenbits=9,w.distcode=T,w.distbits=5}function M(w,A,d,U){var Y,z=w.state;return z.window===null&&(z.wsize=1<<z.wbits,z.wnext=0,z.whave=0,z.window=new r.Buf8(z.wsize)),U>=z.wsize?(r.arraySet(z.window,A,d-z.wsize,z.wsize,0),z.wnext=0,z.whave=z.wsize):(U<(Y=z.wsize-z.wnext)&&(Y=U),r.arraySet(z.window,A,d-U,Y,z.wnext),(U-=Y)?(r.arraySet(z.window,A,d-U,U,0),z.wnext=U,z.whave=z.wsize):(z.wnext+=Y,z.wnext===z.wsize&&(z.wnext=0),z.whave<z.wsize&&(z.whave+=Y))),0}s.inflateReset=k,s.inflateReset2=E,s.inflateResetKeep=S,s.inflateInit=function(w){return L(w,15)},s.inflateInit2=L,s.inflate=function(w,A){var d,U,Y,z,X,H,Q,I,R,J,Z,G,te,oe,V,ce,ie,ue,pe,be,u,$,W,j,C=0,O=new r.Buf8(4),K=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!w||!w.state||!w.output||!w.input&&w.avail_in!==0)return f;(d=w.state).mode===12&&(d.mode=13),X=w.next_out,Y=w.output,Q=w.avail_out,z=w.next_in,U=w.input,H=w.avail_in,I=d.hold,R=d.bits,J=H,Z=Q,$=y;e:for(;;)switch(d.mode){case g:if(d.wrap===0){d.mode=13;break}for(;R<16;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(2&d.wrap&&I===35615){O[d.check=0]=255&I,O[1]=I>>>8&255,d.check=c(d.check,O,2,0),R=I=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&I)<<8)+(I>>8))%31){w.msg="incorrect header check",d.mode=30;break}if((15&I)!=8){w.msg="unknown compression method",d.mode=30;break}if(R-=4,u=8+(15&(I>>>=4)),d.wbits===0)d.wbits=u;else if(u>d.wbits){w.msg="invalid window size",d.mode=30;break}d.dmax=1<<u,w.adler=d.check=1,d.mode=512&I?10:12,R=I=0;break;case 2:for(;R<16;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(d.flags=I,(255&d.flags)!=8){w.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){w.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=I>>8&1),512&d.flags&&(O[0]=255&I,O[1]=I>>>8&255,d.check=c(d.check,O,2,0)),R=I=0,d.mode=3;case 3:for(;R<32;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}d.head&&(d.head.time=I),512&d.flags&&(O[0]=255&I,O[1]=I>>>8&255,O[2]=I>>>16&255,O[3]=I>>>24&255,d.check=c(d.check,O,4,0)),R=I=0,d.mode=4;case 4:for(;R<16;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}d.head&&(d.head.xflags=255&I,d.head.os=I>>8),512&d.flags&&(O[0]=255&I,O[1]=I>>>8&255,d.check=c(d.check,O,2,0)),R=I=0,d.mode=5;case 5:if(1024&d.flags){for(;R<16;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}d.length=I,d.head&&(d.head.extra_len=I),512&d.flags&&(O[0]=255&I,O[1]=I>>>8&255,d.check=c(d.check,O,2,0)),R=I=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&(H<(G=d.length)&&(G=H),G&&(d.head&&(u=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),r.arraySet(d.head.extra,U,z,G,u)),512&d.flags&&(d.check=c(d.check,U,G,z)),H-=G,z+=G,d.length-=G),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if(H===0)break e;for(G=0;u=U[z+G++],d.head&&u&&d.length<65536&&(d.head.name+=String.fromCharCode(u)),u&&G<H;);if(512&d.flags&&(d.check=c(d.check,U,G,z)),H-=G,z+=G,u)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if(H===0)break e;for(G=0;u=U[z+G++],d.head&&u&&d.length<65536&&(d.head.comment+=String.fromCharCode(u)),u&&G<H;);if(512&d.flags&&(d.check=c(d.check,U,G,z)),H-=G,z+=G,u)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;R<16;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(I!==(65535&d.check)){w.msg="header crc mismatch",d.mode=30;break}R=I=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),w.adler=d.check=0,d.mode=12;break;case 10:for(;R<32;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}w.adler=d.check=m(I),R=I=0,d.mode=11;case 11:if(d.havedict===0)return w.next_out=X,w.avail_out=Q,w.next_in=z,w.avail_in=H,d.hold=I,d.bits=R,2;w.adler=d.check=1,d.mode=12;case 12:if(A===5||A===6)break e;case 13:if(d.last){I>>>=7&R,R-=7&R,d.mode=27;break}for(;R<3;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}switch(d.last=1&I,R-=1,3&(I>>>=1)){case 0:d.mode=14;break;case 1:if(D(d),d.mode=20,A!==6)break;I>>>=2,R-=2;break e;case 2:d.mode=17;break;case 3:w.msg="invalid block type",d.mode=30}I>>>=2,R-=2;break;case 14:for(I>>>=7&R,R-=7&R;R<32;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if((65535&I)!=(I>>>16^65535)){w.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&I,R=I=0,d.mode=15,A===6)break e;case 15:d.mode=16;case 16:if(G=d.length){if(H<G&&(G=H),Q<G&&(G=Q),G===0)break e;r.arraySet(Y,U,z,G,X),H-=G,z+=G,Q-=G,X+=G,d.length-=G;break}d.mode=12;break;case 17:for(;R<14;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(d.nlen=257+(31&I),I>>>=5,R-=5,d.ndist=1+(31&I),I>>>=5,R-=5,d.ncode=4+(15&I),I>>>=4,R-=4,286<d.nlen||30<d.ndist){w.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;R<3;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}d.lens[K[d.have++]]=7&I,I>>>=3,R-=3}for(;d.have<19;)d.lens[K[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,W={bits:d.lenbits},$=_(0,d.lens,0,19,d.lencode,0,d.work,W),d.lenbits=W.bits,$){w.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;ce=(C=d.lencode[I&(1<<d.lenbits)-1])>>>16&255,ie=65535&C,!((V=C>>>24)<=R);){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(ie<16)I>>>=V,R-=V,d.lens[d.have++]=ie;else{if(ie===16){for(j=V+2;R<j;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(I>>>=V,R-=V,d.have===0){w.msg="invalid bit length repeat",d.mode=30;break}u=d.lens[d.have-1],G=3+(3&I),I>>>=2,R-=2}else if(ie===17){for(j=V+3;R<j;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}R-=V,u=0,G=3+(7&(I>>>=V)),I>>>=3,R-=3}else{for(j=V+7;R<j;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}R-=V,u=0,G=11+(127&(I>>>=V)),I>>>=7,R-=7}if(d.have+G>d.nlen+d.ndist){w.msg="invalid bit length repeat",d.mode=30;break}for(;G--;)d.lens[d.have++]=u}}if(d.mode===30)break;if(d.lens[256]===0){w.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,W={bits:d.lenbits},$=_(x,d.lens,0,d.nlen,d.lencode,0,d.work,W),d.lenbits=W.bits,$){w.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,W={bits:d.distbits},$=_(v,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,W),d.distbits=W.bits,$){w.msg="invalid distances set",d.mode=30;break}if(d.mode=20,A===6)break e;case 20:d.mode=21;case 21:if(6<=H&&258<=Q){w.next_out=X,w.avail_out=Q,w.next_in=z,w.avail_in=H,d.hold=I,d.bits=R,h(w,Z),X=w.next_out,Y=w.output,Q=w.avail_out,z=w.next_in,U=w.input,H=w.avail_in,I=d.hold,R=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;ce=(C=d.lencode[I&(1<<d.lenbits)-1])>>>16&255,ie=65535&C,!((V=C>>>24)<=R);){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(ce&&!(240&ce)){for(ue=V,pe=ce,be=ie;ce=(C=d.lencode[be+((I&(1<<ue+pe)-1)>>ue)])>>>16&255,ie=65535&C,!(ue+(V=C>>>24)<=R);){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}I>>>=ue,R-=ue,d.back+=ue}if(I>>>=V,R-=V,d.back+=V,d.length=ie,ce===0){d.mode=26;break}if(32&ce){d.back=-1,d.mode=12;break}if(64&ce){w.msg="invalid literal/length code",d.mode=30;break}d.extra=15&ce,d.mode=22;case 22:if(d.extra){for(j=d.extra;R<j;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}d.length+=I&(1<<d.extra)-1,I>>>=d.extra,R-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;ce=(C=d.distcode[I&(1<<d.distbits)-1])>>>16&255,ie=65535&C,!((V=C>>>24)<=R);){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(!(240&ce)){for(ue=V,pe=ce,be=ie;ce=(C=d.distcode[be+((I&(1<<ue+pe)-1)>>ue)])>>>16&255,ie=65535&C,!(ue+(V=C>>>24)<=R);){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}I>>>=ue,R-=ue,d.back+=ue}if(I>>>=V,R-=V,d.back+=V,64&ce){w.msg="invalid distance code",d.mode=30;break}d.offset=ie,d.extra=15&ce,d.mode=24;case 24:if(d.extra){for(j=d.extra;R<j;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}d.offset+=I&(1<<d.extra)-1,I>>>=d.extra,R-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){w.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(Q===0)break e;if(G=Z-Q,d.offset>G){if((G=d.offset-G)>d.whave&&d.sane){w.msg="invalid distance too far back",d.mode=30;break}te=G>d.wnext?(G-=d.wnext,d.wsize-G):d.wnext-G,G>d.length&&(G=d.length),oe=d.window}else oe=Y,te=X-d.offset,G=d.length;for(Q<G&&(G=Q),Q-=G,d.length-=G;Y[X++]=oe[te++],--G;);d.length===0&&(d.mode=21);break;case 26:if(Q===0)break e;Y[X++]=d.length,Q--,d.mode=21;break;case 27:if(d.wrap){for(;R<32;){if(H===0)break e;H--,I|=U[z++]<<R,R+=8}if(Z-=Q,w.total_out+=Z,d.total+=Z,Z&&(w.adler=d.check=d.flags?c(d.check,Y,Z,X-Z):i(d.check,Y,Z,X-Z)),Z=Q,(d.flags?I:m(I))!==d.check){w.msg="incorrect data check",d.mode=30;break}R=I=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;R<32;){if(H===0)break e;H--,I+=U[z++]<<R,R+=8}if(I!==(4294967295&d.total)){w.msg="incorrect length check",d.mode=30;break}R=I=0}d.mode=29;case 29:$=1;break e;case 30:$=-3;break e;case 31:return-4;case 32:default:return f}return w.next_out=X,w.avail_out=Q,w.next_in=z,w.avail_in=H,d.hold=I,d.bits=R,(d.wsize||Z!==w.avail_out&&d.mode<30&&(d.mode<27||A!==4))&&M(w,w.output,w.next_out,Z-w.avail_out)?(d.mode=31,-4):(J-=w.avail_in,Z-=w.avail_out,w.total_in+=J,w.total_out+=Z,d.total+=Z,d.wrap&&Z&&(w.adler=d.check=d.flags?c(d.check,Y,Z,w.next_out-Z):i(d.check,Y,Z,w.next_out-Z)),w.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(J==0&&Z===0||A===4)&&$===y&&($=-5),$)},s.inflateEnd=function(w){if(!w||!w.state)return f;var A=w.state;return A.window&&(A.window=null),w.state=null,y},s.inflateGetHeader=function(w,A){var d;return w&&w.state&&2&(d=w.state).wrap?((d.head=A).done=!1,y):f},s.inflateSetDictionary=function(w,A){var d,U=A.length;return w&&w.state?(d=w.state).wrap!==0&&d.mode!==11?f:d.mode===11&&i(1,A,U,0)!==d.check?-3:M(w,A,U,U)?(d.mode=31,-4):(d.havedict=1,y):f},s.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,o,s){var r=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],c=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],h=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],_=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];o.exports=function(x,v,y,f,g,l,p,m){var b,S,k,E,L,P,T,N,D,M=m.bits,w=0,A=0,d=0,U=0,Y=0,z=0,X=0,H=0,Q=0,I=0,R=null,J=0,Z=new r.Buf16(16),G=new r.Buf16(16),te=null,oe=0;for(w=0;w<=15;w++)Z[w]=0;for(A=0;A<f;A++)Z[v[y+A]]++;for(Y=M,U=15;1<=U&&Z[U]===0;U--);if(U<Y&&(Y=U),U===0)return g[l++]=20971520,g[l++]=20971520,m.bits=1,0;for(d=1;d<U&&Z[d]===0;d++);for(Y<d&&(Y=d),w=H=1;w<=15;w++)if(H<<=1,(H-=Z[w])<0)return-1;if(0<H&&(x===0||U!==1))return-1;for(G[1]=0,w=1;w<15;w++)G[w+1]=G[w]+Z[w];for(A=0;A<f;A++)v[y+A]!==0&&(p[G[v[y+A]]++]=A);if(P=x===0?(R=te=p,19):x===1?(R=i,J-=257,te=c,oe-=257,256):(R=h,te=_,-1),w=d,L=l,X=A=I=0,k=-1,E=(Q=1<<(z=Y))-1,x===1&&852<Q||x===2&&592<Q)return 1;for(;;){for(T=w-X,D=p[A]<P?(N=0,p[A]):p[A]>P?(N=te[oe+p[A]],R[J+p[A]]):(N=96,0),b=1<<w-X,d=S=1<<z;g[L+(I>>X)+(S-=b)]=T<<24|N<<16|D|0,S!==0;);for(b=1<<w-1;I&b;)b>>=1;if(b!==0?(I&=b-1,I+=b):I=0,A++,--Z[w]==0){if(w===U)break;w=v[y+p[A]]}if(Y<w&&(I&E)!==k){for(X===0&&(X=Y),L+=d,H=1<<(z=w-X);z+X<U&&!((H-=Z[z+X])<=0);)z++,H<<=1;if(Q+=1<<z,x===1&&852<Q||x===2&&592<Q)return 1;g[k=I&E]=Y<<24|z<<16|L-l|0}}return I!==0&&(g[L+I]=w-X<<24|64<<16|0),m.bits=Y,0}},{"../utils/common":41}],51:[function(e,o,s){o.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,o,s){var r=e("../utils/common"),i=0,c=1;function h(C){for(var O=C.length;0<=--O;)C[O]=0}var _=0,x=29,v=256,y=v+1+x,f=30,g=19,l=2*y+1,p=15,m=16,b=7,S=256,k=16,E=17,L=18,P=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],T=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],N=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],M=new Array(2*(y+2));h(M);var w=new Array(2*f);h(w);var A=new Array(512);h(A);var d=new Array(256);h(d);var U=new Array(x);h(U);var Y,z,X,H=new Array(f);function Q(C,O,K,q,F){this.static_tree=C,this.extra_bits=O,this.extra_base=K,this.elems=q,this.max_length=F,this.has_stree=C&&C.length}function I(C,O){this.dyn_tree=C,this.max_code=0,this.stat_desc=O}function R(C){return C<256?A[C]:A[256+(C>>>7)]}function J(C,O){C.pending_buf[C.pending++]=255&O,C.pending_buf[C.pending++]=O>>>8&255}function Z(C,O,K){C.bi_valid>m-K?(C.bi_buf|=O<<C.bi_valid&65535,J(C,C.bi_buf),C.bi_buf=O>>m-C.bi_valid,C.bi_valid+=K-m):(C.bi_buf|=O<<C.bi_valid&65535,C.bi_valid+=K)}function G(C,O,K){Z(C,K[2*O],K[2*O+1])}function te(C,O){for(var K=0;K|=1&C,C>>>=1,K<<=1,0<--O;);return K>>>1}function oe(C,O,K){var q,F,ee=new Array(p+1),se=0;for(q=1;q<=p;q++)ee[q]=se=se+K[q-1]<<1;for(F=0;F<=O;F++){var ne=C[2*F+1];ne!==0&&(C[2*F]=te(ee[ne]++,ne))}}function V(C){var O;for(O=0;O<y;O++)C.dyn_ltree[2*O]=0;for(O=0;O<f;O++)C.dyn_dtree[2*O]=0;for(O=0;O<g;O++)C.bl_tree[2*O]=0;C.dyn_ltree[2*S]=1,C.opt_len=C.static_len=0,C.last_lit=C.matches=0}function ce(C){8<C.bi_valid?J(C,C.bi_buf):0<C.bi_valid&&(C.pending_buf[C.pending++]=C.bi_buf),C.bi_buf=0,C.bi_valid=0}function ie(C,O,K,q){var F=2*O,ee=2*K;return C[F]<C[ee]||C[F]===C[ee]&&q[O]<=q[K]}function ue(C,O,K){for(var q=C.heap[K],F=K<<1;F<=C.heap_len&&(F<C.heap_len&&ie(O,C.heap[F+1],C.heap[F],C.depth)&&F++,!ie(O,q,C.heap[F],C.depth));)C.heap[K]=C.heap[F],K=F,F<<=1;C.heap[K]=q}function pe(C,O,K){var q,F,ee,se,ne=0;if(C.last_lit!==0)for(;q=C.pending_buf[C.d_buf+2*ne]<<8|C.pending_buf[C.d_buf+2*ne+1],F=C.pending_buf[C.l_buf+ne],ne++,q===0?G(C,F,O):(G(C,(ee=d[F])+v+1,O),(se=P[ee])!==0&&Z(C,F-=U[ee],se),G(C,ee=R(--q),K),(se=T[ee])!==0&&Z(C,q-=H[ee],se)),ne<C.last_lit;);G(C,S,O)}function be(C,O){var K,q,F,ee=O.dyn_tree,se=O.stat_desc.static_tree,ne=O.stat_desc.has_stree,le=O.stat_desc.elems,me=-1;for(C.heap_len=0,C.heap_max=l,K=0;K<le;K++)ee[2*K]!==0?(C.heap[++C.heap_len]=me=K,C.depth[K]=0):ee[2*K+1]=0;for(;C.heap_len<2;)ee[2*(F=C.heap[++C.heap_len]=me<2?++me:0)]=1,C.depth[F]=0,C.opt_len--,ne&&(C.static_len-=se[2*F+1]);for(O.max_code=me,K=C.heap_len>>1;1<=K;K--)ue(C,ee,K);for(F=le;K=C.heap[1],C.heap[1]=C.heap[C.heap_len--],ue(C,ee,1),q=C.heap[1],C.heap[--C.heap_max]=K,C.heap[--C.heap_max]=q,ee[2*F]=ee[2*K]+ee[2*q],C.depth[F]=(C.depth[K]>=C.depth[q]?C.depth[K]:C.depth[q])+1,ee[2*K+1]=ee[2*q+1]=F,C.heap[1]=F++,ue(C,ee,1),2<=C.heap_len;);C.heap[--C.heap_max]=C.heap[1],function(fe,_e){var ye,Ee,Oe,ge,Ie,We,Ce=_e.dyn_tree,Ve=_e.max_code,ct=_e.stat_desc.static_tree,Ze=_e.stat_desc.has_stree,Ut=_e.stat_desc.extra_bits,kt=_e.stat_desc.extra_base,Ke=_e.stat_desc.max_length,Qe=0;for(ge=0;ge<=p;ge++)fe.bl_count[ge]=0;for(Ce[2*fe.heap[fe.heap_max]+1]=0,ye=fe.heap_max+1;ye<l;ye++)Ke<(ge=Ce[2*Ce[2*(Ee=fe.heap[ye])+1]+1]+1)&&(ge=Ke,Qe++),Ce[2*Ee+1]=ge,Ve<Ee||(fe.bl_count[ge]++,Ie=0,kt<=Ee&&(Ie=Ut[Ee-kt]),We=Ce[2*Ee],fe.opt_len+=We*(ge+Ie),Ze&&(fe.static_len+=We*(ct[2*Ee+1]+Ie)));if(Qe!==0){do{for(ge=Ke-1;fe.bl_count[ge]===0;)ge--;fe.bl_count[ge]--,fe.bl_count[ge+1]+=2,fe.bl_count[Ke]--,Qe-=2}while(0<Qe);for(ge=Ke;ge!==0;ge--)for(Ee=fe.bl_count[ge];Ee!==0;)Ve<(Oe=fe.heap[--ye])||(Ce[2*Oe+1]!==ge&&(fe.opt_len+=(ge-Ce[2*Oe+1])*Ce[2*Oe],Ce[2*Oe+1]=ge),Ee--)}}(C,O),oe(ee,me,C.bl_count)}function u(C,O,K){var q,F,ee=-1,se=O[1],ne=0,le=7,me=4;for(se===0&&(le=138,me=3),O[2*(K+1)+1]=65535,q=0;q<=K;q++)F=se,se=O[2*(q+1)+1],++ne<le&&F===se||(ne<me?C.bl_tree[2*F]+=ne:F!==0?(F!==ee&&C.bl_tree[2*F]++,C.bl_tree[2*k]++):ne<=10?C.bl_tree[2*E]++:C.bl_tree[2*L]++,ee=F,me=(ne=0)===se?(le=138,3):F===se?(le=6,3):(le=7,4))}function $(C,O,K){var q,F,ee=-1,se=O[1],ne=0,le=7,me=4;for(se===0&&(le=138,me=3),q=0;q<=K;q++)if(F=se,se=O[2*(q+1)+1],!(++ne<le&&F===se)){if(ne<me)for(;G(C,F,C.bl_tree),--ne!=0;);else F!==0?(F!==ee&&(G(C,F,C.bl_tree),ne--),G(C,k,C.bl_tree),Z(C,ne-3,2)):ne<=10?(G(C,E,C.bl_tree),Z(C,ne-3,3)):(G(C,L,C.bl_tree),Z(C,ne-11,7));ee=F,me=(ne=0)===se?(le=138,3):F===se?(le=6,3):(le=7,4)}}h(H);var W=!1;function j(C,O,K,q){Z(C,(_<<1)+(q?1:0),3),function(F,ee,se,ne){ce(F),ne&&(J(F,se),J(F,~se)),r.arraySet(F.pending_buf,F.window,ee,se,F.pending),F.pending+=se}(C,O,K,!0)}s._tr_init=function(C){W||(function(){var O,K,q,F,ee,se=new Array(p+1);for(F=q=0;F<x-1;F++)for(U[F]=q,O=0;O<1<<P[F];O++)d[q++]=F;for(d[q-1]=F,F=ee=0;F<16;F++)for(H[F]=ee,O=0;O<1<<T[F];O++)A[ee++]=F;for(ee>>=7;F<f;F++)for(H[F]=ee<<7,O=0;O<1<<T[F]-7;O++)A[256+ee++]=F;for(K=0;K<=p;K++)se[K]=0;for(O=0;O<=143;)M[2*O+1]=8,O++,se[8]++;for(;O<=255;)M[2*O+1]=9,O++,se[9]++;for(;O<=279;)M[2*O+1]=7,O++,se[7]++;for(;O<=287;)M[2*O+1]=8,O++,se[8]++;for(oe(M,y+1,se),O=0;O<f;O++)w[2*O+1]=5,w[2*O]=te(O,5);Y=new Q(M,P,v+1,y,p),z=new Q(w,T,0,f,p),X=new Q(new Array(0),N,0,g,b)}(),W=!0),C.l_desc=new I(C.dyn_ltree,Y),C.d_desc=new I(C.dyn_dtree,z),C.bl_desc=new I(C.bl_tree,X),C.bi_buf=0,C.bi_valid=0,V(C)},s._tr_stored_block=j,s._tr_flush_block=function(C,O,K,q){var F,ee,se=0;0<C.level?(C.strm.data_type===2&&(C.strm.data_type=function(ne){var le,me=4093624447;for(le=0;le<=31;le++,me>>>=1)if(1&me&&ne.dyn_ltree[2*le]!==0)return i;if(ne.dyn_ltree[18]!==0||ne.dyn_ltree[20]!==0||ne.dyn_ltree[26]!==0)return c;for(le=32;le<v;le++)if(ne.dyn_ltree[2*le]!==0)return c;return i}(C)),be(C,C.l_desc),be(C,C.d_desc),se=function(ne){var le;for(u(ne,ne.dyn_ltree,ne.l_desc.max_code),u(ne,ne.dyn_dtree,ne.d_desc.max_code),be(ne,ne.bl_desc),le=g-1;3<=le&&ne.bl_tree[2*D[le]+1]===0;le--);return ne.opt_len+=3*(le+1)+5+5+4,le}(C),F=C.opt_len+3+7>>>3,(ee=C.static_len+3+7>>>3)<=F&&(F=ee)):F=ee=K+5,K+4<=F&&O!==-1?j(C,O,K,q):C.strategy===4||ee===F?(Z(C,2+(q?1:0),3),pe(C,M,w)):(Z(C,4+(q?1:0),3),function(ne,le,me,fe){var _e;for(Z(ne,le-257,5),Z(ne,me-1,5),Z(ne,fe-4,4),_e=0;_e<fe;_e++)Z(ne,ne.bl_tree[2*D[_e]+1],3);$(ne,ne.dyn_ltree,le-1),$(ne,ne.dyn_dtree,me-1)}(C,C.l_desc.max_code+1,C.d_desc.max_code+1,se+1),pe(C,C.dyn_ltree,C.dyn_dtree)),V(C),q&&ce(C)},s._tr_tally=function(C,O,K){return C.pending_buf[C.d_buf+2*C.last_lit]=O>>>8&255,C.pending_buf[C.d_buf+2*C.last_lit+1]=255&O,C.pending_buf[C.l_buf+C.last_lit]=255&K,C.last_lit++,O===0?C.dyn_ltree[2*K]++:(C.matches++,O--,C.dyn_ltree[2*(d[K]+v+1)]++,C.dyn_dtree[2*R(O)]++),C.last_lit===C.lit_bufsize-1},s._tr_align=function(C){Z(C,2,3),G(C,S,M),function(O){O.bi_valid===16?(J(O,O.bi_buf),O.bi_buf=0,O.bi_valid=0):8<=O.bi_valid&&(O.pending_buf[O.pending++]=255&O.bi_buf,O.bi_buf>>=8,O.bi_valid-=8)}(C)}},{"../utils/common":41}],53:[function(e,o,s){o.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,o,s){(function(r){(function(i,c){if(!i.setImmediate){var h,_,x,v,y=1,f={},g=!1,l=i.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(i);p=p&&p.setTimeout?p:i,h={}.toString.call(i.process)==="[object process]"?function(k){process.nextTick(function(){b(k)})}:function(){if(i.postMessage&&!i.importScripts){var k=!0,E=i.onmessage;return i.onmessage=function(){k=!1},i.postMessage("","*"),i.onmessage=E,k}}()?(v="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",S,!1):i.attachEvent("onmessage",S),function(k){i.postMessage(v+k,"*")}):i.MessageChannel?((x=new MessageChannel).port1.onmessage=function(k){b(k.data)},function(k){x.port2.postMessage(k)}):l&&"onreadystatechange"in l.createElement("script")?(_=l.documentElement,function(k){var E=l.createElement("script");E.onreadystatechange=function(){b(k),E.onreadystatechange=null,_.removeChild(E),E=null},_.appendChild(E)}):function(k){setTimeout(b,0,k)},p.setImmediate=function(k){typeof k!="function"&&(k=new Function(""+k));for(var E=new Array(arguments.length-1),L=0;L<E.length;L++)E[L]=arguments[L+1];var P={callback:k,args:E};return f[y]=P,h(y),y++},p.clearImmediate=m}function m(k){delete f[k]}function b(k){if(g)setTimeout(b,0,k);else{var E=f[k];if(E){g=!0;try{(function(L){var P=L.callback,T=L.args;switch(T.length){case 0:P();break;case 1:P(T[0]);break;case 2:P(T[0],T[1]);break;case 3:P(T[0],T[1],T[2]);break;default:P.apply(c,T)}})(E)}finally{m(k),g=!1}}}}function S(k){k.source===i&&typeof k.data=="string"&&k.data.indexOf(v)===0&&b(+k.data.slice(v.length))}})(typeof self>"u"?r===void 0?this:r:self)}).call(this,typeof _t<"u"?_t:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Rr);var Da=Rr.exports;const Ft=rs(Da),za="1.0.0";function Fa(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.version!="string"||typeof n.exportedAt!="number"||typeof n.pattern!="object"||n.pattern===null)return!1;const e=n.pattern;if(typeof e.id!="string"||typeof e.name!="string"||typeof e.bpm!="number"||typeof e.bars!="number"||!Array.isArray(e.grid)||!Array.isArray(e.drums))return!1;if(n.bgmConfig!==void 0){const o=n.bgmConfig;if(typeof o!="object"||typeof o.offsetMs!="number"||typeof o.volumePct!="number")return!1}if(n.bgmFile!==void 0){const o=n.bgmFile;if(!o||typeof o.id!="string"||typeof o.name!="string"||typeof o.size!="number"||typeof o.type!="string"||typeof o.data!="string"||typeof o.byteLength!="number"||o.data.length===0)return!1}return!0}async function Ua(t,n){try{let e,o=n;if(n!=null&&n.fileId){const _=await Sr(n.fileId);if(_){const x=await _.blob.arrayBuffer(),y=new Uint8Array(x).reduce((g,l)=>g+String.fromCharCode(l),""),f=btoa(y);e={id:_.id,name:_.name,size:_.size,type:_.type,data:f,byteLength:x.byteLength}}else o={offsetMs:n.offsetMs,volumePct:n.volumePct}}const s={version:za,exportedAt:Date.now(),pattern:t,bgmConfig:o,bgmFile:e},r=new Ft;r.file("pattern.json",JSON.stringify(s,null,2));const i=await r.generateAsync({type:"blob"}),c=URL.createObjectURL(i),h=document.createElement("a");h.href=c,h.download=`${t.name}.zip`,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(c)}catch(e){throw console.error("[Pattern Backup] Export failed:",e),e}}async function Ha(t){var n,e,o;try{const r=(await Ft.loadAsync(t)).file("pattern.json");if(!r)throw new Error("Invalid pattern file: missing pattern.json");const i=await r.async("string"),c=JSON.parse(i);if(!Fa(c))throw new Error("Invalid backup file: data structure validation failed");const h=c;let _;if(h.bgmConfig&&!h.bgmFile)_=void 0;else if(h.bgmFile){const x=atob(h.bgmFile.data),v=new Uint8Array(x.length);for(let l=0;l<x.length;l++)v[l]=x.charCodeAt(l);let y=h.bgmFile.type;if(!y||y===""){const l=(n=h.bgmFile.name.split(".").pop())==null?void 0:n.toLowerCase();l==="mp3"?y="audio/mpeg":l==="wav"?y="audio/wav":l==="ogg"?y="audio/ogg":l==="m4a"||l==="mp4"?y="audio/mp4":y="audio/mpeg"}const{id:f,meta:g}=await Br(h.bgmFile.data,h.bgmFile.name,y);_={fileId:f,offsetMs:((e=h.bgmConfig)==null?void 0:e.offsetMs)??0,volumePct:((o=h.bgmConfig)==null?void 0:o.volumePct)??100,meta:g}}return{pattern:h.pattern,bgmConfig:_}}catch(s){throw console.error("[Pattern Backup] Import failed:",s),s}}function Wa({patterns:t,currentPatternId:n,onSelectPattern:e,onSelectDraft:o,onAddPattern:s,onImportPattern:r,onImportPatternWithBgm:i,isDraftMode:c}){const[h,_]=B.useState(!1),[x,v]=B.useState(""),y=B.useRef(null),f=B.useRef(null),g=k=>{e(k)},l=async()=>{var k;(k=f.current)==null||k.click()},p=async k=>{var L;const E=(L=k.target.files)==null?void 0:L[0];if(E){if(!E.name.endsWith(".zip")){alert("Please select a valid pattern file (.zip format)");return}try{const{pattern:P,bgmConfig:T}=await Ha(E),N=JSON.stringify(P);i?i(N,T):r&&r(N),console.log("Pattern imported from zip file",{bgmConfig:T})}catch(P){console.error("Failed to import pattern:",P),alert("Failed to import pattern file. Please check the console for details.")}finally{f.current&&(f.current.value="")}}},m=()=>{x.trim()&&r&&r(x.trim()),_(!1),v("")},b=()=>{_(!1),v("")};B.useEffect(()=>{h&&y.current&&y.current.focus()},[h]);const S=[...t].sort((k,E)=>k.name.localeCompare(E.name));return a.jsxs("div",{className:"pattern-tabs",children:[a.jsx("input",{ref:f,type:"file",accept:".zip",style:{display:"none"},onChange:p}),a.jsx("button",{className:`pattern-tab draft-tab ${c?"active":""}`,onClick:o,"aria-label":"Draft Pattern",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 12 12",children:a.jsx("circle",{cx:"6",cy:"6",r:"4.5",fill:"none",stroke:"currentColor",strokeWidth:"1.5"})})}),S.length>0&&a.jsx("div",{className:"pattern-tabs-content",children:S.map(k=>{const E=!c&&k.id===n;return a.jsx("button",{className:`pattern-tab ${E?"active":""}`,onClick:()=>g(k),"aria-label":`Pattern ${k.name}`,children:k.name},k.id)})}),h?a.jsxs("div",{className:"import-input-container",children:[a.jsx("input",{ref:y,type:"text",className:"import-input",value:x,onChange:k=>v(k.target.value),onKeyDown:k=>{k.key==="Enter"?m():k.key==="Escape"&&b()},onBlur:()=>{setTimeout(()=>{x.trim()||b()},150)},placeholder:"Paste..."}),a.jsx("button",{className:"action-button confirm-button",onClick:m,"aria-label":"Confirm Import",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("polyline",{points:"20 6 9 17 4 12"})})})]}):a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"action-button load-button",onClick:l,"aria-label":"Load New Pattern",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),a.jsx("button",{className:"action-button save-button",onClick:s,"aria-label":"Create New Pattern",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})}function Va({config:t,isLoading:n,isLoaded:e,error:o,onUpload:s,onOffsetChange:r,onVolumeChange:i,onDelete:c,masterVolume:h,onMasterVolumeChange:_,isPlaying:x}){var I;const v=B.useRef(null),[y,f]=B.useState(!1),[g,l]=B.useState("0"),p=R=>{const J=Fn((t.volumePct??100)+R,0,100);i(J)},m=R=>{const J=Fn(h+R,0,100);_(J)},b=R=>{const J=(t.offsetMs??0)+R;r(J)},S=Re(()=>p(-10),{clickCallback:()=>p(-10)}),k=Re(()=>p(10),{clickCallback:()=>p(10)}),E=Re(()=>m(-10),{clickCallback:()=>m(-10)}),L=Re(()=>m(10),{clickCallback:()=>m(10)}),P=Re(()=>b(-100),{clickCallback:()=>b(-10)}),T=Re(()=>b(100),{clickCallback:()=>b(10)}),N=R=>{var Z;const J=(Z=R.target.files)==null?void 0:Z[0];J&&s(J),R.target.value=""},D=(((I=t.meta)==null?void 0:I.name)??"").replace(/\.[^/.]+$/,""),M=Math.round(t.volumePct??100),w=Math.round(h),d=-(t.offsetMs??0),U=Math.abs(d)>=1e3?`${(d/1e3).toFixed(3)}s`:`${d}ms`,Y=Math.round(d).toString(),z=()=>{x||(l(Y),f(!0))},X=()=>{const R=Number(g);if(!Number.isFinite(R)){f(!1);return}r(-R),f(!1)},H=()=>{const R=t.volumePct??100;i(R===0?100:0)},Q=()=>{_(h===0?100:0)};return a.jsxs("div",{className:"bgm-controls-container",children:[a.jsxs("div",{className:"bgm-controls",children:[a.jsxs("div",{className:"bgm-controls-left",children:[t.fileId&&e&&!n?a.jsx("button",{type:"button",className:"bgm-delete-button",onClick:c,"aria-label":"Delete background music",title:"Delete background music",disabled:!t.fileId||n,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}):a.jsxs(a.Fragment,{children:[a.jsx("button",{type:"button",className:"bgm-control-button",onClick:()=>{var R;return(R=v.current)==null?void 0:R.click()},"aria-label":"Upload background music",title:"Upload background music",disabled:n,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),a.jsx("input",{ref:v,className:"bgm-file-input",type:"file",accept:"audio/mpeg",onChange:N})]}),D&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"bgm-file-name",children:D||""}),a.jsxs("div",{className:"bgm-control-group",children:[a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music volume",title:"Decrease background music volume",...S,children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("div",{className:"bgm-control-center",children:a.jsx("button",{type:"button",className:"bgm-volume-display",onClick:H,"aria-label":"Toggle BGM volume",title:"Click to toggle 0%/100%",children:a.jsxs("span",{className:"bgm-control-value",children:[M,"%"]})})}),a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music volume",title:"Increase background music volume",...k,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),a.jsxs("div",{className:"bgm-control-group",children:[a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music offset",title:"Decrease background music offset",disabled:x,...T,children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("div",{className:"bgm-control-center",children:y?a.jsx("input",{type:"number",className:"bgm-offset-input",value:g,onChange:R=>l(R.target.value),onBlur:X,onKeyDown:R=>{R.key==="Enter"?X():R.key==="Escape"&&f(!1)},disabled:x,autoFocus:!0}):a.jsx("button",{type:"button",className:"bgm-offset-display",onClick:z,disabled:x,children:a.jsx("span",{className:"bgm-control-value",children:U})})}),a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music offset",title:"Increase background music offset",disabled:x,...P,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})]}),a.jsx("div",{className:"bgm-controls-right",children:a.jsxs("div",{className:"bgm-control-group",children:[a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease pattern volume",title:"Decrease pattern volume",...E,children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("div",{className:"bgm-control-center",children:a.jsx("button",{type:"button",className:"bgm-volume-display",onClick:Q,"aria-label":"Toggle pattern volume",title:"Click to toggle 0%/100%",children:a.jsxs("span",{className:"bgm-control-value",children:[w,"%"]})})}),a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase pattern volume",title:"Increase pattern volume",...L,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})]}),o&&a.jsx("div",{className:"bgm-error",children:o})]})}function Fn(t,n,e){return Math.min(e,Math.max(n,t))}const Ga=393,Un=23.0625,$a=nr,Hn=24,Za=375;function Ka(){const t=B.useCallback(()=>{const o=window.innerWidth;return o<Za?Un:(Math.min(o,$a)-Hn)*Un/(Ga-Hn)},[]),[n,e]=B.useState(t);return B.useEffect(()=>{const o=()=>{e(t())};return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[t]),n}const qa=24,Wn=23.0625;function Ya(t,n=2){const e=B.useCallback(()=>{if(typeof window>"u")return Wn;const r=window.innerWidth,i=Math.min(r,nr)-qa,c=t*he;return c<=0||n<=0?Wn:i/(c*n)},[t,n]),[o,s]=B.useState(e);return B.useEffect(()=>{const r=()=>{s(e())};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[e]),o}const Ar="drummer-full-practice-mode";let vt=!1;const an=new Set;let Vn=!1;function Ja(){if(typeof window>"u")return!1;const t=localStorage.getItem(Ar);if(!t)return!1;try{const n=JSON.parse(t);return typeof n=="boolean"?n:!1}catch{return!1}}function Xa(){an.forEach(t=>t())}function Qa(t){mn(),vt!==t&&(vt=t,typeof window<"u"&&localStorage.setItem(Ar,JSON.stringify(t)),Xa())}function mn(){Vn||typeof window>"u"||(vt=Ja(),Vn=!0)}function ei(){return mn(),vt}function ti(){Qa(!vt)}function ni(t){return mn(),an.add(t),()=>an.delete(t)}function Nr(){return B.useSyncExternalStore(ni,ei,()=>!1)}const cn=960;let Mt=!1;const ln=new Set;let Gn=!1;function ri(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(orientation: landscape)").matches:window.innerWidth>window.innerHeight}function si(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia(`(max-width: ${cn}px)`).matches:window.innerWidth<=cn}function oi(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(pointer: coarse)").matches:typeof navigator<"u"?navigator.maxTouchPoints>0:!1}function pn(){return ri()&&si()&&oi()}function ai(){ln.forEach(t=>t())}function Ir(t){Mt!==t&&(Mt=t,ai())}function jt(){Ir(pn())}function Pr(){var t;if(!(Gn||typeof window>"u")){if(Mt=pn(),window.addEventListener("resize",jt),window.addEventListener("orientationchange",jt),typeof window.matchMedia=="function"){const n=window.matchMedia(`(max-width: ${cn}px) and (orientation: landscape)`);if(typeof n.addEventListener=="function")n.addEventListener("change",jt);else{const e=n;(t=e.addListener)==null||t.call(e,jt)}}Gn=!0}}function ii(){return Pr(),Mt}function ci(t){return Pr(),ln.add(t),Ir(pn()),()=>ln.delete(t)}function Lr(){return B.useSyncExternalStore(ci,ii,()=>!1)}function $n(t){const{delay:n=500,onLongPress:e,onClick:o}=t,[s,r]=B.useState(null),i=B.useRef(null),c=B.useRef(!1),h=B.useRef(!1),_=B.useRef(0),x=B.useRef(e),v=B.useRef(o);x.current=e,v.current=o;const y=B.useCallback(()=>{c.current=!1,s&&s.classList.remove("active"),i.current&&(clearTimeout(i.current),i.current=null)},[s]),f=B.useCallback(()=>{c.current||(c.current=!0,_.current=Date.now(),h.current=!1,s&&s.classList.add("active"),i.current=setTimeout(()=>{c.current&&(h.current=!0,x.current())},n))},[n,s]),g=B.useCallback(()=>{const S=c.current,k=Date.now()-_.current,E=h.current;y(),S&&!E&&k<n&&v.current&&v.current()},[n,y]);B.useEffect(()=>{if(!s)return;const S=P=>{P.cancelable&&P.preventDefault(),f()},k=P=>{P.cancelable&&P.preventDefault(),g()},E=()=>{y()},L=P=>{P.preventDefault()};return s.addEventListener("touchstart",S,{passive:!1}),s.addEventListener("touchend",k,{passive:!1}),s.addEventListener("touchcancel",E),s.addEventListener("contextmenu",L),()=>{s.removeEventListener("touchstart",S),s.removeEventListener("touchend",k),s.removeEventListener("touchcancel",E),s.removeEventListener("contextmenu",L)}},[s,f,g,y]),B.useEffect(()=>()=>{y()},[y]);const l=B.useCallback(S=>{r(S)},[]),p=B.useCallback(S=>{S.preventDefault(),f()},[f]),m=B.useCallback(()=>{g()},[g]),b=B.useCallback(()=>{y()},[y]);return{ref:l,onMouseDown:p,onMouseUp:m,onMouseLeave:b}}async function li(t){if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")try{return await navigator.clipboard.writeText(t),!0}catch{console.log("navigator.clipboard.writeText failed, trying fallback")}try{return ui(t)}catch(n){return console.error("Failed to copy to clipboard:",n),!1}}function ui(t){const n=document.createElement("textarea");if(n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="2em",n.style.height="2em",n.style.padding="0",n.style.border="none",n.style.outline="none",n.style.boxShadow="none",n.style.background="transparent",n.style.opacity="0",n.style.zIndex="-1",n.style.fontSize="16px",n.value=t,document.body.appendChild(n),/iPad|iPhone|iPod/.test(navigator.userAgent)){const s=document.createRange();s.selectNodeContents(n);const r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(s)),n.setSelectionRange(0,t.length)}else n.focus(),n.select();let o=!1;try{o=document.execCommand("copy")}catch(s){console.error("execCommand copy failed:",s)}return document.body.removeChild(n),o}function di(){var e;const t=window.isSecureContext!==void 0?window.isSecureContext:location.protocol==="https:"||location.hostname==="localhost",n=!!(navigator.clipboard&&typeof navigator.clipboard.writeText=="function");return t&&n||((e=document.queryCommandSupported)==null?void 0:e.call(document,"copy"))}function fi(t){const[n,e]=B.useState(!1),[o,s]=B.useState(""),r=B.useRef(null);B.useEffect(()=>{n&&r.current&&(r.current.focus(),r.current.select())},[n]);const i=B.useCallback(()=>{s(t),e(!0)},[t]),c=B.useCallback(()=>{e(!1),s("")},[]),h=B.useCallback(async()=>{if(di())try{if(await li(t))return!0}catch{}return s(t),e(!0),!1},[t]);return{isExportMode:n,exportValue:o,exportInputRef:r,enterExportMode:i,cancelExport:c,tryExportToClipboard:h}}let at=null;function hi(){at!==null&&(cancelAnimationFrame(at),at=null)}function mi(t,n,e=150,o){hi();const s=t.scrollLeft,r=n-s,i=performance.now();function c(h){const _=h-i,x=Math.min(_/e,1),v=1-Math.pow(1-x,3);t.scrollLeft=s+r*v,x<1?at=requestAnimationFrame(c):(at=null,o==null||o())}at=requestAnimationFrame(c)}function ft(t,n,e,o,s){const r={rangeStartBar:0,rangeEndBar:t.bars-1,rangeStartSub:0,rangeEndSub:s};if(!n)return r;const i=e?n.startPatternName==="":n.startPatternName===t.name,c=e?n.endPatternName==="":n.endPatternName===t.name;return{rangeStartBar:i?n.startBar:0,rangeEndBar:c?n.endBar:t.bars-1,rangeStartSub:i?n.startBar*o:0,rangeEndSub:c?(n.endBar+1)*o:s}}function pi({scrollContainerRef:t,currentBeat:n,cellSize:e,pattern:o,crossPatternLoop:s,isDraftMode:r,isPlaying:i}){const c=B.useRef(!1),h=B.useRef(null),_=B.useRef(null),x=B.useRef(!1),v=B.useRef(null),y=B.useRef(null),f=o.timeSignature[0],g=B.useMemo(()=>f*he,[f]),l=B.useMemo(()=>o.bars*g,[o.bars,g]),p=B.useMemo(()=>e*he/8,[e]),m=B.useCallback((b,S)=>{h.current!==S&&(c.current||(c.current=!0,h.current=S,mi(b,S,150,()=>{c.current=!1})))},[]);return B.useLayoutEffect(()=>{const b=t.current;if(!b)return;const S=_.current,k=o.id;if(S!==null&&S!==k){const E=ft(o,s,r,g,l),L=E.rangeStartBar*g*e;y.current=(E.rangeStartBar+1)*g,m(b,Math.max(0,L))}S!==k&&(v.current=null),_.current=k},[o.id,o,o.bars,e,g,l,t,s,r,m]),B.useEffect(()=>{if(n===void 0||!t.current)return;if(y.current!==null){if(n>=y.current)return;y.current=null}if(n>=l)return;const b=ft(o,s,r,g,l);if(n<b.rangeStartSub||n>=b.rangeEndSub)return;const S=t.current,k=n*e,E=S.scrollLeft,L=E+S.clientWidth,P=Math.floor(n/g);if(i&&v.current!==null&&P!==v.current){const T=P*g*e;m(S,Math.max(0,T)),v.current=P;return}if(v.current===null&&(v.current=P),k<E){const T=P*g*e;m(S,Math.max(0,T))}else if(k+e>L-p){if(!i){const M=P*g*e;m(S,Math.max(0,M));return}const T=ft(o,s,r,g,l);let N;P>=T.rangeEndBar?N=T.rangeStartBar:N=P+1;const D=N*g*e;m(S,Math.max(0,D))}},[n,e,i,p,m,g,l,o,o.bars,s,r,t]),B.useEffect(()=>{i||(h.current=null,x.current=!1,v.current=null)},[i,o.id]),B.useEffect(()=>{const b=t.current;if(!b)return;const S=!x.current&&i;if(x.current=i,!S||n===void 0||n>=l)return;const k=ft(o,s,r,g,l);if(n<k.rangeStartSub||n>=k.rangeEndSub)return;const E=Math.floor(n/g),L=E*g*e,P=b.scrollLeft,T=e;if(Math.abs(P-L)<=T)return;const N=n*e,D=P+b.clientWidth;if(N+e>D-p){const M=ft(o,s,r,g,l);let w;E>=M.rangeEndBar?w=M.rangeStartBar:w=E+1;const A=w*g*e;m(b,A)}else m(b,L)},[i,n,e,p,g,l,o,o.bars,s,r,t,m]),{scrollContainerRef:t,doScroll:m}}const gi=500;function bi({pattern:t,onCellClick:n,onToggleGhost:e,onCycleThirtySecond:o,onAddBar:s,onRemoveBar:r,onClearGrid:i,onClearBar:c,crossPatternLoop:h,onCrossPatternLoopChange:_,onSave:x,onSaveCurrentPattern:v,onImportPattern:y,onImportPatternWithBgm:f,onLoadFromSlot:g,onDeletePattern:l,onStopAllPlaying:p,onSelectDraft:m,savedPatterns:b,currentBeat:S,isPlaying:k=!1,onPlayToggle:E,isDraftMode:L,onNotationDoubleClick:P,canCopyPattern:T,hasCopiedPattern:N,canPastePattern:D,onCopyPattern:M,onPastePatternBefore:w,onPastePatternAfter:A,bgmConfig:d,bgmIsLoading:U,bgmIsLoaded:Y,bgmError:z,onBgmUpload:X,onBgmOffsetChange:H,onBgmVolumeChange:Q,onBgmDelete:I,masterVolume:R,onMasterVolumeChange:J,isCountInEnabled:Z,onCountInToggle:G,onBarBpmModeToggle:te,currentBarHasOverride:oe=!1}){const V=B.useRef(null),ce=B.useRef(t.bars),ie=B.useRef(!1),ue=B.useRef(void 0),pe=Nr(),be=Lr(),u=Ka(),[$]=t.timeSignature,W=Ya($,2),j=be?W:u,{doScroll:C}=pi({scrollContainerRef:V,currentBeat:S,cellSize:j,pattern:t,crossPatternLoop:h,isDraftMode:L,isPlaying:k}),O=b.find(ye=>ye.id===t.id),K=O?Es(O):"",{isExportMode:q,exportValue:F,exportInputRef:ee,cancelExport:se}=fi(K),ne=async()=>{if(O)try{await Ua(O,d),console.log("Pattern exported to zip file")}catch(ye){console.error("Failed to export pattern:",ye),alert("Failed to export pattern. Please check the console for details.")}},le=B.useCallback(()=>{ie.current=!0,ue.current=S,s(S)},[s,S]),me=B.useCallback(()=>{ti()},[]),fe=$n({delay:500,onLongPress:ne,onClick:v}),_e=$n({delay:gi,onLongPress:i,onClick:()=>{S!==void 0&&c(S)}});return B.useEffect(()=>{if(!ie.current||t.bars<=ce.current){ie.current=!1,ce.current=t.bars;return}if(!V.current||!h){ie.current=!1,ce.current=t.bars;return}if(k){ie.current=!1,ce.current=t.bars;return}if(L?h.endPatternName==="":h.endPatternName===t.name){const Ee=V.current,[Oe]=t.timeSignature,ge=Oe*he;let Ie;if(ue.current!==void 0){const Ve=Math.floor(ue.current/ge),ct=ue.current%ge,Ze=ge/2;ct<Ze?Ie=Ve:Ie=Ve+1}else Ie=t.bars-1;const Ce=Ie*ge*j;C(Ee,Ce)}ie.current=!1,ce.current=t.bars},[t.bars,k,L,t.name,t.timeSignature,j,C,h]),a.jsxs("div",{className:`pattern-editor${be?" landscape-mode":""}`,children:[a.jsxs("div",{className:"pattern-editor-controls",children:[a.jsxs("div",{className:"pattern-bar-tools",children:[a.jsx(Ma,{bars:t.bars,onAddBar:le,onRemoveBar:r,canRemove:t.bars>1,currentBeat:S}),T&&a.jsx("div",{className:"pattern-copy-controls",children:N?a.jsxs(a.Fragment,{children:[a.jsx("button",{type:"button",className:"pattern-tab",onClick:w,disabled:!D,"aria-label":"Paste pattern before",title:"Paste pattern before",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 5 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),a.jsx("button",{type:"button",className:"pattern-tab",onClick:A,disabled:!D,"aria-label":"Paste pattern after",title:"Paste pattern after",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 19 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})]}):a.jsx("button",{type:"button",className:"pattern-tab",onClick:M,"aria-label":"Copy pattern grid",title:"Copy pattern grid",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),a.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})}),te&&a.jsx("button",{type:"button",className:`bar-control-button bar-bpm-button${oe?" active":""}`,onClick:te,"aria-label":"Toggle bar BPM mode","aria-pressed":oe,title:oe?"Clear current bar BPM":"Enter bar BPM mode",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"12",cy:"12",r:"9"}),a.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),a.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})})]}),a.jsx(Oa,{currentPattern:t,savedPatterns:b,crossPatternLoop:h,onCrossPatternLoopChange:_,isDraftMode:L})]}),a.jsxs("div",{className:"pattern-editor-actions",children:[a.jsx("div",{className:"pattern-editor-actions-left",children:a.jsx(Wa,{patterns:b,currentPatternId:t.id,onSelectPattern:g,onSelectDraft:m,onAddPattern:x,onImportPattern:y,onImportPatternWithBgm:f,isDraftMode:L})}),a.jsxs("div",{className:"pattern-editor-actions-right",children:[a.jsx("button",{type:"button",className:`action-button count-in-toggle-button${Z?" active":""}`,onClick:G,"aria-label":"Toggle count-in",title:"Toggle count-in","aria-pressed":Z,children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),a.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),a.jsx("button",{type:"button",className:`action-button practice-toggle-button${pe?" active":""}`,onClick:me,"aria-label":"Toggle practice mode",title:"Toggle practice mode","aria-pressed":pe,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M9 18V5l12-2v13"}),a.jsx("circle",{cx:"6",cy:"18",r:"3"}),a.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),!L&&b.some(ye=>ye.id===t.id)&&(q?a.jsx("input",{ref:ee,type:"text",className:"export-input",value:F,onChange:()=>{},onKeyDown:ye=>{ye.key==="Escape"&&se()},onBlur:()=>{setTimeout(se,150)},onFocus:ye=>{ye.target.select()},onClick:ye=>{ye.target.select()},onTouchEnd:ye=>{ye.target.select()}}):a.jsx("button",{className:"action-button save-current-button",...fe,"aria-label":"Save Pattern",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),a.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),a.jsx("polyline",{points:"7 3 7 8 15 8"})]})})),b.some(ye=>ye.id===t.id)&&a.jsx("button",{className:"action-button delete-button",onClick:()=>{p&&p(),setTimeout(()=>{window.confirm("Delete this pattern?")&&l(t.id)},0)},"aria-label":"Delete",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),a.jsx("button",{className:"action-button clear-button",..._e,"aria-label":"Clear (short press: clear current bar, long press: clear all)",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[a.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),pe&&a.jsx(Va,{config:d,isLoading:U,isLoaded:Y,error:z,onUpload:X,onOffsetChange:H,onVolumeChange:Q,masterVolume:R,onMasterVolumeChange:J,onDelete:I,isPlaying:k}),a.jsxs("div",{className:"pattern-editor-scrollable",ref:V,children:[a.jsx(Ea,{pattern:t,cellSize:j,currentBeat:S,scrollContainerRef:V,onDoubleClick:P}),a.jsx(La,{pattern:t,cellSize:j}),!be&&a.jsx(Pa,{pattern:t,cellSize:j,onCellClick:n,onToggleGhost:e,onCellDoubleClick:o,currentBeat:S,scrollContainerRef:V})]})]})}function Zn({isPlaying:t,onClick:n,onLongPress:e,variant:o="floating",fullPracticeMode:s=!1,isCountInEnabled:r=!1}){const i=B.useRef(null),c=B.useRef(!1),h=500,_=()=>{t||e&&(c.current=!1,i.current=window.setTimeout(()=>{e(),c.current=!0,i.current=null},h))},x=()=>{i.current&&(clearTimeout(i.current),i.current=null)},v=()=>{i.current&&(clearTimeout(i.current),i.current=null)},y=()=>{t||e&&(c.current=!1,i.current=window.setTimeout(()=>{e(),c.current=!0,i.current=null},h))},f=l=>{i.current&&(clearTimeout(i.current),i.current=null),c.current&&(l.preventDefault(),setTimeout(()=>{c.current=!1},100))},g=l=>{if(c.current){l.preventDefault(),l.stopPropagation(),c.current=!1;return}if((s||r)&&!t&&e){e(),setTimeout(()=>{c.current=!1,n()},300);return}else n()};return a.jsx("div",{className:`bottom-play-button-container${o==="inline"?" inline":""}`,children:a.jsx("button",{className:`bottom-play-button${o==="inline"?" inline":""}${t?" playing":" paused"}`,onClick:g,onMouseDown:_,onMouseUp:x,onMouseLeave:v,onTouchStart:y,onTouchEnd:f,"aria-label":t?"Pause Pattern":"Play Pattern",children:t?a.jsx(a.Fragment,{children:s||r?a.jsx("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):a.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[a.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),a.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]})}):a.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})})})}const Kn="1.12.5",qn="2601292348",vi={name:"Dracula",colors:{bgColor:"#282a36",cardBg:"#44475a",bgSecondary:"#21222c",text:"#f8f8f2",textSecondary:"#acb8dd",textDim:"#596483",textTertiary:"#4e5771",border:"#434b62",primary:"#bd93f9",primaryHover:"#ff79c6",secondary:"#50fa7b",active:"#50fa7b",activeBg:"rgba(80, 250, 123, 0.2)",accentGlow:"rgba(189, 147, 249, 0.3)",danger:"#ff5555",dangerHover:"#ff6e6e",warning:"#f2f28c",warningHover:"#ffb86c",glassBg:"rgba(68, 71, 90, 0.5)",glassBgHover:"rgba(68, 71, 90, 0.7)",glassBorder:"rgba(139, 233, 253, 0.3)",overlayBg:"rgba(40, 42, 54, 0.9)",gridBorder:"rgba(139, 233, 253, 0.2)",gridCellBg:"#1a3a2a",gridCellBgAlt:"#1a3a2a94",beatLine:"#8be9fd"}},yi={name:"One",colors:{bgColor:"#282c34",cardBg:"#21252b",bgSecondary:"#1e2227",text:"#c6cedd",textSecondary:"#8c96a8",textDim:"#6c768e",textTertiary:"#586178",border:"rgba(171, 178, 191, 0.2)",primary:"#61afef",primaryHover:"#7aa6f2",secondary:"#98c379",active:"#98c379",activeBg:"rgba(152, 195, 121, 0.2)",accentGlow:"rgba(97, 175, 239, 0.3)",danger:"#e06c75",dangerHover:"#ff6b7a",warning:"#d19a66",warningHover:"#e5c07b",glassBg:"rgba(33, 37, 43, 0.6)",glassBgHover:"rgba(33, 37, 43, 0.8)",glassBorder:"rgba(171, 178, 191, 0.2)",overlayBg:"rgba(40, 44, 52, 0.9)",gridBorder:"rgba(171, 178, 191, 0.15)",gridCellBg:"#1f252d",gridCellBgAlt:"#1b2027",beatLine:"#61afef"}},xi={name:"Gruvbox",colors:{bgColor:"#282828",cardBg:"#3c3836",bgSecondary:"#1d2021",text:"#ebdbb2",textSecondary:"#928374",textDim:"#7c6f64",textTertiary:"#5a5047",border:"rgba(235, 219, 178, 0.2)",primary:"#fe8019",primaryHover:"#d65e0e",secondary:"#b8bb26",active:"#b8bb26",activeBg:"rgba(184, 187, 38, 0.2)",accentGlow:"rgba(254, 128, 25, 0.3)",danger:"#fb4934",dangerHover:"#cc241d",warning:"#fabd2f",warningHover:"#d79921",glassBg:"rgba(60, 56, 54, 0.6)",glassBgHover:"rgba(60, 56, 54, 0.8)",glassBorder:"rgba(235, 219, 178, 0.2)",overlayBg:"rgba(40, 40, 40, 0.9)",gridBorder:"rgba(235, 219, 178, 0.15)",gridCellBg:"#1d2021",gridCellBgAlt:"#191b1b",beatLine:"#fe8019"}},wi={name:"Monokai",colors:{bgColor:"#272822",cardBg:"#3e3d32",bgSecondary:"#1e1f1a",text:"#f8f8f2",textSecondary:"#a6a69c",textDim:"#75715e",textTertiary:"#5a594f",border:"rgba(248, 248, 242, 0.2)",primary:"#a6e22e",primaryHover:"#66d9ef",secondary:"#f92672",active:"#a6e22e",activeBg:"rgba(166, 226, 46, 0.2)",accentGlow:"rgba(249, 38, 114, 0.3)",danger:"#f92672",dangerHover:"#fe4e8e",warning:"#e6db74",warningHover:"#f1e8a0",glassBg:"rgba(62, 61, 50, 0.7)",glassBgHover:"rgba(62, 61, 50, 0.85)",glassBorder:"rgba(248, 248, 242, 0.15)",overlayBg:"rgba(39, 40, 34, 0.92)",gridBorder:"rgba(248, 248, 242, 0.12)",gridCellBg:"#2a2b26",gridCellBgAlt:"#21221e",beatLine:"#66d9ef"}},ki={name:"Campbell",colors:{bgColor:"#000",cardBg:"#1f1f1f",bgSecondary:"#080808",text:"#cccccc",textSecondary:"#a0a0a0",textDim:"#767676",textTertiary:"#5c5c5c",border:"rgba(204, 204, 204, 0.25)",primary:"#3a96dd",primaryHover:"#5cb3ff",secondary:"#13a10e",active:"#13a10e",activeBg:"rgba(19, 161, 14, 0.2)",accentGlow:"rgba(58, 150, 221, 0.3)",danger:"#c50f1f",dangerHover:"#e81123",warning:"#c19c00",warningHover:"#d9b812",glassBg:"rgba(31, 31, 31, 0.8)",glassBgHover:"rgba(31, 31, 31, 0.92)",glassBorder:"rgba(204, 204, 204, 0.15)",overlayBg:"rgba(12, 12, 12, 0.95)",gridBorder:"rgba(204, 204, 204, 0.1)",gridCellBg:"#121212",gridCellBgAlt:"#0a0a0a",beatLine:"#3a96dd"}},_i={name:"Solarized",colors:{bgColor:"#002b36",cardBg:"#073642",bgSecondary:"#001e26",text:"#a8bdc1",textSecondary:"#657b83",textDim:"#586e75",textTertiary:"#3d4d51",border:"rgba(131, 148, 150, 0.3)",primary:"#268bd2",primaryHover:"#2aa198",secondary:"#859900",active:"#859900",activeBg:"rgba(133, 153, 0, 0.2)",accentGlow:"rgba(38, 139, 210, 0.25)",danger:"#dc322f",dangerHover:"#cb4b16",warning:"#b58900",warningHover:"#d33682",glassBg:"rgba(7, 54, 66, 0.75)",glassBgHover:"rgba(7, 54, 66, 0.88)",glassBorder:"rgba(147, 161, 161, 0.2)",overlayBg:"rgba(0, 43, 54, 0.93)",gridBorder:"rgba(147, 161, 161, 0.15)",gridCellBg:"#093e48",gridCellBgAlt:"#08343d",beatLine:"#268bd2"}},Si={name:"Nord",colors:{bgColor:"#2e3440",cardBg:"#3b4252",bgSecondary:"#242933",text:"#d8dee9",textSecondary:"#a3be8c",textDim:"#7b88a1",textTertiary:"#4c566a",border:"rgba(216, 222, 233, 0.2)",primary:"#88c0d0",primaryHover:"#8fbcbb",secondary:"#a3be8c",active:"#a3be8c",activeBg:"rgba(163, 190, 140, 0.2)",accentGlow:"rgba(136, 192, 208, 0.25)",danger:"#bf616a",dangerHover:"#d08770",warning:"#ebcb8b",warningHover:"#eacb8b",glassBg:"rgba(59, 66, 82, 0.7)",glassBgHover:"rgba(59, 66, 82, 0.85)",glassBorder:"rgba(129, 161, 193, 0.2)",overlayBg:"rgba(46, 52, 64, 0.92)",gridBorder:"rgba(129, 161, 193, 0.15)",gridCellBg:"#353b49",gridCellBgAlt:"#313643",beatLine:"#88c0d0"}},Bi={name:"Night",colors:{bgColor:"#1a1b26",cardBg:"#24283b",bgSecondary:"#16161e",text:"#c0caf5",textSecondary:"#a9b1d6",textDim:"#737aa2",textTertiary:"#565f89",border:"rgba(192, 202, 245, 0.2)",primary:"#7aa2f7",primaryHover:"#7dcfff",secondary:"#9ece6a",active:"#9ece6a",activeBg:"rgba(158, 206, 106, 0.2)",accentGlow:"rgba(122, 162, 247, 0.25)",danger:"#f7768e",dangerHover:"#db4b4b",warning:"#e0af68",warningHover:"#ff9e64",glassBg:"rgba(36, 40, 59, 0.75)",glassBgHover:"rgba(36, 40, 59, 0.88)",glassBorder:"rgba(187, 154, 247, 0.2)",overlayBg:"rgba(26, 27, 38, 0.93)",gridBorder:"rgba(169, 177, 214, 0.12)",gridCellBg:"#1f2335",gridCellBgAlt:"#1a1e2e",beatLine:"#7aa2f7"}},Ci={name:"Rose",colors:{bgColor:"#191724",cardBg:"#26233a",bgSecondary:"#131118",text:"#e0def4",textSecondary:"#c4a7e7",textDim:"#908caa",textTertiary:"#6e6a7e",border:"rgba(224, 222, 244, 0.2)",primary:"#c4a7e7",primaryHover:"#9ccfd8",secondary:"#3e8fb0",active:"#3e8fb0",activeBg:"rgba(62, 143, 176, 0.2)",accentGlow:"rgba(196, 167, 231, 0.2)",danger:"#eb6f92",dangerHover:"#f08ba3",warning:"#f6c177",warningHover:"#fad5a0",glassBg:"rgba(38, 35, 58, 0.75)",glassBgHover:"rgba(38, 35, 58, 0.88)",glassBorder:"rgba(196, 167, 231, 0.15)",overlayBg:"rgba(25, 23, 36, 0.93)",gridBorder:"rgba(156, 207, 216, 0.12)",gridCellBg:"#1f1d2e",gridCellBgAlt:"#1c1a26",beatLine:"#c4a7e7"}},ji={name:"Yellow",colors:{bgColor:"#2b2620",cardBg:"#3a332a",bgSecondary:"#1f1b17",text:"#f2e6d4",textSecondary:"#d4c4b0",textDim:"#a89b8a",textTertiary:"#7a6f61",border:"rgba(242, 230, 212, 0.2)",primary:"#7fb3d5",primaryHover:"#5dade2",secondary:"#a5d6a7",active:"#a5d6a7",activeBg:"rgba(165, 214, 167, 0.2)",accentGlow:"rgba(127, 179, 213, 0.25)",danger:"#e67e22",dangerHover:"#f39c12",warning:"#f9d784",warningHover:"#ffe082",glassBg:"rgba(58, 51, 42, 0.75)",glassBgHover:"rgba(58, 51, 42, 0.88)",glassBorder:"rgba(242, 230, 212, 0.15)",overlayBg:"rgba(43, 38, 32, 0.93)",gridBorder:"rgba(242, 230, 212, 0.12)",gridCellBg:"#332b24",gridCellBgAlt:"#2e2720",beatLine:"#7fb3d5"}},Ye=[vi,yi,xi,wi,ki,_i,Si,Bi,Ci,ji];function Yn(t){const n=document.documentElement,e=t.colors;n.style.setProperty("--bg-color",e.bgColor),n.style.setProperty("--card-bg",e.cardBg),n.style.setProperty("--color-bg-secondary",e.bgSecondary),n.style.setProperty("--color-text",e.text),n.style.setProperty("--color-text-secondary",e.textSecondary),n.style.setProperty("--color-text-dim",e.textDim),n.style.setProperty("--color-text-tertiary",e.textTertiary),n.style.setProperty("--color-border",e.border),n.style.setProperty("--color-primary",e.primary),n.style.setProperty("--color-primary-hover",e.primaryHover),n.style.setProperty("--color-secondary",e.secondary),n.style.setProperty("--color-active",e.active),n.style.setProperty("--color-active-bg",e.activeBg),n.style.setProperty("--accent-glow",e.accentGlow),n.style.setProperty("--color-danger",e.danger),n.style.setProperty("--color-danger-hover",e.dangerHover),n.style.setProperty("--color-warning",e.warning),n.style.setProperty("--color-warning-hover",e.warningHover),n.style.setProperty("--glass-bg",e.glassBg),n.style.setProperty("--glass-bg-hover",e.glassBgHover),n.style.setProperty("--glass-border",e.glassBorder),n.style.setProperty("--overlay-bg",e.overlayBg),n.style.setProperty("--grid-border",e.gridBorder),n.style.setProperty("--grid-cell-bg",e.gridCellBg),n.style.setProperty("--grid-cell-bg-alt",e.gridCellBgAlt),n.style.setProperty("--color-beat-line",e.beatLine),n.style.setProperty("--theme-color",e.bgColor)}const Mr="drummer-theme",Ei="Dracula";function Ti(){return Ye.find(n=>n.name===Ei)||Ye[0]}function Ri(){try{const t=localStorage.getItem(Mr);if(t){const n=Ye.find(e=>e.name===t);if(n)return n}}catch(t){console.warn("Failed to load theme from localStorage:",t)}return Ti()}function Ai(t){try{localStorage.setItem(Mr,t)}catch(n){console.warn("Failed to save theme to localStorage:",n)}}function Ni(){const[t,n]=B.useState(()=>{const o=Ri();return Yn(o),o});return{currentTheme:t,cycleTheme:()=>{const s=(Ye.findIndex(i=>i.name===t.name)+1)%Ye.length,r=Ye[s];n(r),Yn(r),Ai(r.name)},themes:Ye}}const Ii="1.0.0";function Pi(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.version!="string"||typeof n.exportedAt!="number"||typeof n.localStorage!="object"||n.localStorage===null||!Array.isArray(n.bgmFiles))return!1;for(const e of n.bgmFiles)if(typeof e.id!="string"||typeof e.name!="string"||typeof e.size!="number"||typeof e.type!="string"||typeof e.data!="string"||typeof e.byteLength!="number"||e.data.length===0)return!1;return!0}function Li(){const t={};for(let n=0;n<localStorage.length;n++){const e=localStorage.key(n);if(e){const o=localStorage.getItem(e);o!==null&&(t[e]=o)}}return t}async function Mi(){const t=await qo();return await Promise.all(t.map(async e=>{const o=await e.blob.arrayBuffer(),r=new Uint8Array(o).reduce((c,h)=>c+String.fromCharCode(h),""),i=btoa(r);return{id:e.id,name:e.name,size:e.size,type:e.type,data:i,byteLength:o.byteLength}}))}async function Oi(){try{const t=Li(),n=await Mi(),e={version:Ii,exportedAt:Date.now(),localStorage:t,bgmFiles:n},o=new Ft;o.file("config.json",JSON.stringify(e,null,2));const s=await o.generateAsync({type:"blob"}),r=URL.createObjectURL(s),i=document.createElement("a");i.href=r;const h=new Date().toISOString().slice(0,10).replace(/-/g,"");i.download=`${h}.zip`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}catch(t){throw console.error("[Config Backup] Export failed:",t),t}}function Di(t){localStorage.clear();for(const[n,e]of Object.entries(t))localStorage.setItem(n,e)}async function zi(t){var e;await Yo();const n=new Map;for(const o of t){let s=o.type;if(!s||s===""){const i=(e=o.name.split(".").pop())==null?void 0:e.toLowerCase();i==="mp3"?s="audio/mpeg":i==="wav"?s="audio/wav":i==="ogg"?s="audio/ogg":i==="m4a"||i==="mp4"?s="audio/mp4":s="audio/mpeg"}const{id:r}=await Br(o.data,o.name,s);n.set(o.id,r)}return n}function Fi(t){const n="drummer-bgm-config",e=localStorage.getItem(n);if(e)try{const o=JSON.parse(e);let s=!1;for(const r of Object.values(o))r.fileId&&t.has(r.fileId)&&(r.fileId=t.get(r.fileId),s=!0);s&&localStorage.setItem(n,JSON.stringify(o))}catch{}}async function Ui(t){try{const e=(await Ft.loadAsync(t)).file("config.json");if(!e)throw new Error("Invalid configuration file: missing config.json");const o=await e.async("string"),s=JSON.parse(o);if(!Pi(s))throw new Error("Invalid backup file: data structure validation failed");const r=s;Di(r.localStorage);const i=await zi(r.bgmFiles);Fi(i),window.location.reload()}catch(n){throw console.error("[Config Backup] Import failed:",n),n}}function Hi(){const[t,n]=B.useState(!1),[e,o]=B.useState(!1),[s,r]=B.useState("idle"),[i,c]=B.useState(!1),[h,_]=B.useState(!1),[x,v]=B.useState({}),y=B.useRef(null),f=B.useRef(null),g=B.useRef(null),{currentTheme:l,cycleTheme:p}=Ni(),m=["Crash 1","Crash 2","Hi-Hat Open","Hi-Hat Closed","Ride","Tom 1","Tom 2","Snare","Tom 3","Kick"];B.useEffect(()=>{v(dn())},[]);const b=async(D,M)=>{Rs(D,M),v(w=>({...w,[D]:M})),await jo(),await sn(D)},S=B.useCallback(()=>{h||(f.current&&clearTimeout(f.current),f.current=setTimeout(()=>{n(!1),localStorage.getItem("drummer-first-shown")||(o(!0),localStorage.setItem("drummer-first-shown","true"),g.current=setTimeout(()=>{o(!1)},1e4))},1e4))},[h]);B.useEffect(()=>()=>{f.current&&clearTimeout(f.current),g.current&&clearTimeout(g.current)},[]),B.useEffect(()=>{localStorage.getItem("drummer-visited")||(n(!0),localStorage.setItem("drummer-visited","true"))},[]),B.useEffect(()=>{const D=()=>{n(!0),o(!1)};return window.addEventListener("show-version",D),()=>{window.removeEventListener("show-version",D)}},[]),B.useEffect(()=>{if(!t){f.current&&(clearTimeout(f.current),f.current=null);return}S();const D=["mousemove","mousedown","touchstart","touchmove","keydown","click"],M=()=>{S()};return D.forEach(w=>{window.addEventListener(w,M)}),()=>{D.forEach(w=>{window.removeEventListener(w,M)}),f.current&&clearTimeout(f.current)}},[t,S]);const k=async()=>{var D,M,w;console.log("[Refresh] === handleRefresh started ==="),console.log("[Refresh] Current version:",Kn,"Build time:",qn),console.log("[Refresh] Set status: checking"),r("checking");try{if(!("serviceWorker"in navigator)){console.log("[Refresh] ❌ Browser doesn't support ServiceWorker, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Browser supports ServiceWorker"),console.log("[Refresh] Getting ServiceWorker registration...");const A=await navigator.serviceWorker.getRegistration();if(!A){console.log("[Refresh] ❌ No registration found, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Got registration:",{scope:A.scope,active:(D=A.active)==null?void 0:D.state,waiting:(M=A.waiting)==null?void 0:M.state,installing:(w=A.installing)==null?void 0:w.state});const d=()=>{console.log("[Refresh] 🔄 controllerchange event triggered! Reloading page..."),window.location.reload()};if(navigator.serviceWorker.addEventListener("controllerchange",d,{once:!0}),console.log("[Refresh] ✓ Added controllerchange listener"),A.waiting){console.log("[Refresh] ⚡ Found waiting worker, activating directly"),console.log("[Refresh] waiting worker state:",A.waiting.state),r("activating"),console.log("[Refresh] Sending SKIP_WAITING message to waiting worker"),A.waiting.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] No waiting worker currently"),console.log("[Refresh] Set 10 second timeout");const U=setTimeout(()=>{console.log("[Refresh] ⏰ 10s timeout! Removing listener and reloading page"),navigator.serviceWorker.removeEventListener("controllerchange",d),window.location.reload()},1e4),Y=()=>{console.log("[Refresh] 🎉 updatefound event triggered! New SW started installing"),r("downloading");const H=A.installing;if(!H){console.log("[Refresh] ❌ updatefound triggered but installing is null");return}console.log("[Refresh] New worker initial state:",H.state),H.addEventListener("statechange",()=>{console.log("[Refresh] New worker state changed:",H.state),H.state==="installing"&&(console.log("[Refresh] Set status: installing"),r("installing")),H.state==="installed"&&(console.log("[Refresh] New worker installation complete, set status: activating"),r("activating"),clearTimeout(U),console.log("[Refresh] Cleared timeout timer"),console.log("[Refresh] Sending SKIP_WAITING message to new worker"),H.postMessage({type:"SKIP_WAITING"}))})};A.addEventListener("updatefound",Y,{once:!0}),console.log("[Refresh] ✓ Added updatefound listener"),console.log("[Refresh] Calling registration.update() to check for updates...");try{await A.update(),console.log("[Refresh] ✓ registration.update() completed")}catch(H){console.warn("[Refresh] ⚠️ Update check failed:",H)}const z=A.waiting;if(console.log("[Refresh] After update(), checking waiting:",(z==null?void 0:z.state)||"null"),z){console.log("[Refresh] ⚡ Found waiting worker after update(), activating directly"),r("activating"),clearTimeout(U),console.log("[Refresh] Sending SKIP_WAITING message"),z.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] Set 5 second no-update detection timer");const X=setTimeout(()=>{var H,Q;console.log("[Refresh] ⏰ 5s check: checking for updates..."),console.log("[Refresh] installing:",((H=A.installing)==null?void 0:H.state)||"null"),console.log("[Refresh] waiting:",((Q=A.waiting)==null?void 0:Q.state)||"null"),!A.installing&&!A.waiting?(console.log("[Refresh] 📌 Confirmed no update, set status: no-update"),r("no-update"),clearTimeout(U),navigator.serviceWorker.removeEventListener("controllerchange",d),console.log("[Refresh] Reloading page in 1 second..."),setTimeout(()=>{console.log("[Refresh] 🔄 Executing page reload"),window.location.reload()},1e3)):console.log("[Refresh] Found installing or waiting, continuing to wait")},5e3);A.addEventListener("updatefound",()=>{console.log("[Refresh] updatefound triggered, clearing no-update detection timer"),clearTimeout(X)},{once:!0}),console.log("[Refresh] === handleRefresh initialization complete, waiting for events ===")}catch(A){console.error("[Refresh] ❌ Exception:",A),console.log("[Refresh] Reloading page due to exception"),window.location.reload()}},E=()=>{switch(s){case"checking":return"Checking...";case"downloading":return"Downloading...";case"installing":return"Installing...";case"activating":return"Activating...";case"no-update":return"Latest version";default:return`v${Kn} - ${qn}`}},L=async()=>{if(!i)try{c(!0),await Oi()}catch(D){console.error("[Settings] Export failed:",D),alert("Failed to export configuration. Please check the console for details.")}finally{c(!1)}},P=()=>{var D;(D=y.current)==null||D.click()},T=async D=>{var w;const M=(w=D.target.files)==null?void 0:w[0];if(M){if(!M.name.endsWith(".zip")){alert("Please select a valid configuration file (.zip format)");return}try{await Ui(M)}catch(A){console.error("[Settings] Import failed:",A),alert("Failed to import configuration. Please check the console for details.")}finally{y.current&&(y.current.value="")}}},N=s!=="idle";return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:`settings-first-hint ${e?"visible":"hidden"}`,children:"Tap 5 times quickly to show settings"}),a.jsxs("div",{className:`settings ${t?"visible":"hidden"}`,children:[a.jsxs("div",{className:"settings-theme",onClick:p,children:[a.jsx("button",{type:"button",className:"settings-theme-button",title:`Current theme: ${l.name}. Click to cycle theme.`,children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),a.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),a.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),a.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),a.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),l.name]}),a.jsxs("div",{className:"settings-config",children:[a.jsx("input",{ref:y,type:"file",accept:".zip",style:{display:"none"},onChange:T}),a.jsx("button",{type:"button",className:"settings-config-button",onClick:P,title:"Load settings from a zip file",children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"17 8 12 3 7 8"}),a.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})}),a.jsx("button",{type:"button",className:`settings-config-button ${i?"exporting":""}`,onClick:L,title:"Export all settings to a zip file",disabled:i,children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"7 10 12 15 17 10"}),a.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),a.jsx("button",{type:"button",className:"settings-config-button",onClick:()=>_(!0),title:"About",children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),a.jsx("circle",{cx:"12",cy:"12",r:"3"})]})})]})]}),h&&a.jsx("div",{className:"settings-modal-mask",onClick:()=>_(!1),children:a.jsxs("div",{className:"settings-modal",onClick:D=>D.stopPropagation(),children:[a.jsxs("div",{className:"settings-modal-header",children:[a.jsx("h2",{children:"Drummer - Beat Maker"}),a.jsx("button",{type:"button",className:"settings-modal-close",onClick:()=>_(!1),children:a.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),a.jsxs("div",{className:"settings-modal-content",children:[a.jsx("h3",{className:"settings-modal-subtitle",children:"Features & Usage"}),a.jsx("p",{className:"settings-modal-description",children:"A step-by-step guide for first-time users. Read top to bottom to learn the full workflow and discover hidden gestures."}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Top Bar: Metronome and Tempo"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Beat dots"}),": click to cycle time signatures (4/4, 3/4, 2/4, 6/8, 5/4, 7/8)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Tempo"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click for 0.5 BPM steps, press and hold to keep changing."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"BPM number"}),": tap the left/right side of the digits to cycle speed rates (a rate label appears)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Play"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": start or stop playback. Long-press to reset the loop counter to 0."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Patterns, Bars, and Loop Range"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Tabs"}),": the circle is Draft; letter tabs are saved patterns. Click a tab to load it."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"New pattern"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": save the current draft as a new pattern tab."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Import pattern"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),": load a pattern zip file."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Bars"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": remove or add a bar (uses your cursor position when possible)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Loop range"}),": choose start/end pattern and bar; press and hold the +/- buttons to move faster."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Per-bar BPM"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"12",cy:"12",r:"9"}),a.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),a.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})}),": click to set or clear BPM for the current bar."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Copy/Paste"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),a.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})," ","then"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 5 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 19 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),": duplicate a whole pattern grid before or after."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Grid Editor and Notation"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Single click/tap"}),": toggle a cell on or off."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Double-click/tap"}),": cycle 32nd-note states (double, first, second, back to normal)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Long-press on an active cell"}),": cycle note type (normal to ghost to grace) when supported."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Notation view"}),": double-click/tap to jump the playhead (disabled when a rate label is active)."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Action Buttons (Right Side)"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Count-in"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),a.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),": toggle a one-bar count-in before playback."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Practice mode"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M9 18V5l12-2v13"}),a.jsx("circle",{cx:"6",cy:"18",r:"3"}),a.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),": show background music and volume controls."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Play (bottom)"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": tap to play/pause. Long-press to stop and jump to the loop start."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Save current"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),a.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),a.jsx("polyline",{points:"7 3 7 8 15 8"})]})}),": save edits to the current pattern. Long-press to export a pattern zip (includes BGM)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Delete"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),": remove the current pattern."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Clear"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[a.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),": short press clears the current bar, long-press clears all bars."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Background Music (Practice Mode)"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Upload"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),": add an MP3 file, or"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})})," ","to delete it."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Volume"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click or press-and-hold to adjust. Click the % number to mute/unmute."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Offset"}),": click the ms/s value to type an exact offset (disabled while playing)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Pattern volume"}),": the right-side controls adjust drum volume (same +/- and mute behavior)."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Settings and About"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Theme"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),a.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),a.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),a.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),a.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),": click to cycle themes."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Backup and Restore"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"17 8 12 3 7 8"}),a.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"7 10 12 15 17 10"}),a.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),": import or export all data as a zip file."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Settings"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),a.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}),": open this."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Drum Samples Selection"}),a.jsx("p",{className:"settings-modal-description",children:"Choose between different sample variants (A/B/C) for each drum. Click to preview."}),a.jsx("div",{className:"sample-selection-list",children:m.map(D=>{const M=x[D]||"A";return a.jsxs("div",{className:"sample-selection-item",children:[a.jsx("div",{className:"sample-selection-drum",children:D}),a.jsx("div",{className:"sample-selection-variants",children:["A","B","C"].map(w=>a.jsx("button",{type:"button",className:`sample-variant-button ${M===w?"active":""}`,onClick:()=>b(D,w),title:`Select ${w} variant for ${D}`,children:w},w))})]},D)})})]})]}),a.jsx("div",{className:`settings-modal-version ${N?"updating":""}`,onClick:k,children:E()},`version-${s}`)]})})]})}let Jn=0;const Wi=16;function ht(t,n,e){const o=Math.max(0,e);setTimeout(()=>{Date.now()-Jn>=Wi?requestAnimationFrame(()=>{Jn=Date.now(),n(t)}):n(t)},o)}function Vi({currentPattern:t,savedPatterns:n,crossPatternLoop:e,isPlaying:o,isDraftMode:s,playbackRate:r=1,onSubdivisionChange:i,onPatternChange:c,onPlayStart:h}){const _=B.useRef(0),x=B.useRef(.2),v=B.useRef(50),y=B.useRef(null),f=B.useRef(!1),g=B.useRef(0),l=B.useRef(0),p=B.useRef([]),m=B.useRef(i),b=B.useRef(c),S=B.useRef(h),k=B.useRef(t),E=B.useRef(s);m.current=i,b.current=c,S.current=h,k.current=t,E.current=s;const L=B.useRef(r);L.current=r;const P=B.useCallback((Y,z)=>{let X=Y.bpm;if(z!==void 0&&Y.barBpmOverrides){const[I]=Y.timeSignature,R=I*he,J=Math.floor(z/R);X=Y.barBpmOverrides[J]??Y.bpm}return 60/(X*L.current)*(4/Y.timeSignature[1])/he},[]),T=B.useCallback(Y=>{const[z]=Y.timeSignature;return z*he},[]),N=B.useCallback(Y=>{const z=p.current;if(z.length===0)return;let X=-1,H=Y;for(let R=0;R<z.length;R++){const J=z[R],Z=T(J.pattern),G=J.startBar*Z,te=(J.endBar+1)*Z;if(Y>=G&&Y<te){X=R,H=Y;break}}if(X===-1){X=0;const R=z[0],J=T(R.pattern);H=R.startBar*J}if(g.current=X,l.current=H,f.current){const R=Be();_.current=R.currentTime}const Q=m.current;Q&&ht(H,Q,0);const I=b.current;if(I){const R=z[X];I(R.patternName)}},[T]),D=B.useCallback(()=>{const Y=[];if(!e)return Y.push({patternName:s?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),Y;const{startPatternName:z,startBar:X,endPatternName:H,endBar:Q}=e,I=[...n].sort((G,te)=>G.name.localeCompare(te.name)),R=s?[{name:"",pattern:t},...I.map(G=>({name:G.name,pattern:G}))]:I.map(G=>G.id===t.id?{name:G.name,pattern:t}:{name:G.name,pattern:G}),J=R.findIndex(G=>G.name===z),Z=R.findIndex(G=>G.name===H);if(J===-1||Z===-1)return Y.push({patternName:s?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),Y;for(let G=J;G<=Z;G++){const{name:te,pattern:oe}=R[G],V=G===J?X:0,ce=G===Z?Q:oe.bars-1;Y.push({patternName:te,pattern:oe,startBar:V,endBar:ce})}return Y},[t,n,e,s]);B.useEffect(()=>{p.current=D()},[D]);const M=B.useCallback((Y,z,X)=>{const H=P(Y,z),Q=H/2,I=(R,J,Z)=>{switch(Oo(Z),R){case"Kick":gr(J);break;case"Snare":rn(J);break;case"Hi-Hat Closed":br(J);break;case"Hi-Hat Open":vr(J);break;case"Crash 1":Pt(J,1.2);break;case"Crash 2":Pt(J,1);break;case"Ride":yr(J);break;case"Tom 1":ot(J,250);break;case"Tom 2":ot(J,200);break;case"Tom 3":ot(J,150);break}Do()};Y.grid.forEach((R,J)=>{const Z=R[z];if(Z===je)return;const G=Y.drums[J],te=X;if(Z===Ge){const V=te-H*.125;I(G,V,.5),I(G,te,1);return}if(Z===Me||Z===Fe||Z===Ue){(Z===Me||Z===Fe)&&I(G,te,1),(Z===Me||Z===Ue)&&I(G,te+Q,1);return}I(G,te,Z===Pe?.3:1)})},[P]),w=B.useCallback(()=>{const Y=Be();if(!f.current)return;const z=Y.currentTime,X=p.current;if(X.length!==0)for(;_.current<z+x.current;){let H=g.current,Q=l.current;if(H<0||H>=X.length){H=0;const V=X[0],ce=T(V.pattern);Q=V.startBar*ce,g.current=0,l.current=Q;const ie=b.current;ie&&ie(V.patternName),_.current<z&&(_.current=z);continue}const I=X[H],R=T(I.pattern),J=I.startBar*R,Z=(I.endBar+1)*R;if(Q>=Z){if(g.current=H+1,H+1<X.length){const V=X[H+1],ce=T(V.pattern);l.current=V.startBar*ce;const ie=b.current;ie&&ie(V.patternName)}continue}Q<J&&(Q=J,l.current=J);const G=Math.max(_.current,z),te=(G-z)*1e3;if(M(I.pattern,Q,G),f.current){const V=m.current;V&&ht(Q,V,te)}l.current=Q+1;const oe=P(I.pattern,Q);_.current+=oe}},[M,P,T]),A=B.useCallback(async()=>{const Y=Be();if(f.current)return;Y.state==="suspended"&&await Y.resume(),await new Promise(J=>requestAnimationFrame(J)),jr(),f.current=!0;const z=Y.currentTime,X=p.current;if(X.length===0)return;const H=S.current;H&&H(z);let Q=!0;const I=g.current,R=l.current;if(I>=0&&I<X.length){const J=X[I],Z=T(J.pattern),G=J.startBar*Z,te=(J.endBar+1)*Z,oe=R>=G&&R<te,V=J.pattern.id===k.current.id;oe&&V&&(Q=!1)}if(Q){const J=k.current.id;let Z=X.findIndex(ie=>ie.pattern.id===J);if(Z===-1){const ie=E.current?"":k.current.name;Z=X.findIndex(ue=>ue.patternName===ie)}Z===-1&&(Z=0);const G=X[Z],te=T(G.pattern),oe=G.startBar*te;g.current=Z,l.current=oe;const V=b.current;V&&V(G.patternName);const ce=m.current;ce&&ht(oe,ce,0)}else{const J=m.current;J&&ht(R,J,0)}_.current=z,w(),y.current=window.setInterval(w,v.current)},[w,T]),d=B.useCallback(()=>{f.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),on()},[]);B.useEffect(()=>(o?A():d(),()=>{d()}),[o,A,d]);const U=B.useCallback(()=>{const Y=p.current;if(Y.length===0)return;f.current&&(f.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),on());const z=Y[0],X=T(z.pattern),H=z.startBar*X;g.current=0,l.current=H;const Q=m.current;Q&&ht(H,Q,0);const I=b.current;I&&I(z.patternName)},[T]);return{seekTo:N,resetToRangeStart:U}}function Gi(t,n,e){if(!n)return!1;const{startPatternName:o,endPatternName:s}=n;if(o===s)return!1;const i=["",...e.map(x=>x.name).sort((x,v)=>x.localeCompare(v))],c=i.indexOf(o),h=i.indexOf(s),_=i.indexOf(t);return _>=c&&_<=h}function Et(t,n,e,o,s){t&&n(!1),e&&o(!1),s()}function $i(){const{isLoading:t,loadingProgress:n,showProgress:e,isFadingOut:o}=Uo(),{isMetronomePlaying:s,isPatternPlaying:r,toggleMetronomePlay:i,togglePatternPlay:c,stopAll:h,setIsMetronomePlaying:_,setIsPatternPlaying:x}=Go(),v=Nr(),y=Lr(),[f,g]=B.useState(0),[l,p]=B.useState([]),[m,b]=B.useState(!0),S=B.useRef(null),k=B.useRef(null),[E,L]=B.useState(0),[P,T]=B.useState(()=>Tn()??mt),[N,D]=B.useState(Qt),[M,w]=B.useState(0),[A,d]=B.useState(!1),[U,Y]=B.useState(!1),[z,X]=B.useState(0),[H,Q]=B.useState(0),I=B.useRef(null),[R,J]=B.useState(null),[Z,G]=B.useState(!1),[te,oe]=B.useState(()=>Cs()??{startPatternName:"",startBar:0,endPatternName:"",endBar:It-1}),{pattern:V,updateBPM:ce,updateBarBpm:ie,toggleCell:ue,toggleGhost:pe,cycleThirtySecond:be,addBar:u,removeBar:$,clearGrid:W,clearBar:j,insertPatternGrid:C,loadPattern:O,resetPattern:K}=Ns(cr()),[q,F]=B.useState(()=>ut(V.id)),[ee,se]=B.useState({isLoading:!1,error:null}),[ne,le]=B.useState(()=>Jo()),me=lt(M),fe=()=>{I.current&&(clearTimeout(I.current),I.current=null),U&&Y(!1)};B.useEffect(()=>()=>{I.current&&clearTimeout(I.current)},[]);const _e=(re,ae=!0)=>{var de;if(f!==void 0){const[ve]=V.timeSignature,xe=ve*he,ke=Math.floor(f/xe),et=((de=V.barBpmOverrides)==null?void 0:de[ke])!==void 0;if(Z||et){ae&&ie(ke,re),T(re);return}}T(re),ae&&(ze(re),ce(re))},ye=re=>{D(re)},Ee=()=>{var xe;if(f===void 0)return;const[re]=V.timeSignature,ae=re*he,de=Math.floor(f/ae);((xe=V.barBpmOverrides)==null?void 0:xe[de])!==void 0?(ie(de,null),T(V.bpm),G(!1)):(ie(de,V.bpm),G(!0))},Oe=()=>{Et(r,x,s,_,fe),w(0),G(!1),b(!0),De(void 0),K(),T(mt),ze(mt),ce(mt),oe({startPatternName:"",startBar:0,endPatternName:"",endBar:It-1})};B.useEffect(()=>{const re=tt();p(re);const ae=Ss();if(ae){const de=re.find(ve=>ve.id===ae);if(de){b(!1),O(de);const ve=Tn();ve!==null?T(ve):(T(de.bpm),ze(de.bpm))}else De(void 0)}},[]),B.useEffect(()=>{F(ut(V.id))},[V.id]),B.useEffect(()=>{zo(v?ne:100)},[v,ne]),B.useEffect(()=>{Bs(te)},[te]);const ge=(()=>{if(f===void 0||!V.barBpmOverrides)return!1;const[re]=V.timeSignature,ae=re*he,de=Math.floor(f/ae);return V.barBpmOverrides[de]!==void 0})();B.useEffect(()=>{var ke,et;if(f===void 0)return;const[re]=V.timeSignature,ae=re*he,de=Math.floor(f/ae),ve=((ke=V.barBpmOverrides)==null?void 0:ke[de])!==void 0,xe=lt(M);if(Z||ve){const ts=(((et=V.barBpmOverrides)==null?void 0:et[de])??V.bpm)*xe;T(ts)}else{const xn=V.bpm*xe;T(xn)}},[Z,f,V.timeSignature,V.barBpmOverrides,V.bpm,M]),Fo({isMetronomePlaying:s,isPatternPlaying:r,setIsMetronomePlaying:_,setIsPatternPlaying:x}),Is(s,r),Vo(),B.useEffect(()=>{const re=ae=>(ae.preventDefault(),!1);return document.body.addEventListener("contextmenu",re),()=>{document.body.removeEventListener("contextmenu",re)}},[]),B.useEffect(()=>{const re=de=>{de.touches.length>1&&de.preventDefault()},ae=de=>{de.preventDefault()};return document.body.addEventListener("touchmove",re,{passive:!1}),document.body.addEventListener("gesturestart",ae,{passive:!1}),()=>{document.body.removeEventListener("touchmove",re),document.body.removeEventListener("gesturestart",ae)}},[]);const Ie=re=>{if(re===""){b(!0),De(void 0);const ae=lt(M),de=V.bpm*ae;T(de),ze(V.bpm)}else{const ae=l.find(de=>de.name===re);if(ae&&ae.id!==V.id){b(!1),O(ae),De(ae.id);const de=lt(M),ve=ae.bpm*de;T(ve),ze(ae.bpm)}}},{seekTo:We,resetToRangeStart:Ce}=Vi({currentPattern:V,savedPatterns:l,crossPatternLoop:te,isPlaying:r,isDraftMode:m,playbackRate:me,onSubdivisionChange:g,onPatternChange:Ie,onPlayStart:()=>{L(re=>re+1)}}),Ve=()=>{Ce(),Et(r,x,s,_,fe)},ct=B.useMemo(()=>{if(!te)return 0;const re=m?"":V.name;return te.startPatternName===re?te.startBar:0},[te,m,V.name]),Ze=Qo({isPlaying:r,isFullPracticeMode:v,playbackRate:me,bgmConfig:q,currentSubdivision:f,pattern:V,patternStartToken:E,rangeStartBar:ct});B.useEffect(()=>{if(!te)return;const re=m?"":V.name;if(te.startPatternName!==re||S.current===te.startBar&&k.current===te.startPatternName)return;const[ae]=V.timeSignature,de=ae*he;We(te.startBar*de),S.current=te.startBar,k.current=te.startPatternName},[te,m,V.name,V.timeSignature,We]);const Ut=ee.isLoading||Ze.isLoading,kt=Ze.isLoaded,Ke=ee.error??Ze.error,Qe=re=>{M===0&&We(re)},Or=()=>{m||J({grid:V.grid.map(re=>re.slice()),bars:V.bars,timeSignature:V.timeSignature,drums:V.drums,bpm:V.bpm,barBpmOverrides:V.barBpmOverrides?{...V.barBpmOverrides}:void 0})},gn=(()=>R?R.timeSignature[0]===V.timeSignature[0]&&R.timeSignature[1]===V.timeSignature[1]&&R.drums.length===V.drums.length:!1)(),bn=re=>{if(m||!R||!gn)return;Et(r,x,s,_,fe);const ae=re==="before"?0:V.bars;C(ae,R),J(null)},Dr=re=>re===""&&m||re===V.name?V:l.find(de=>de.name===re)??V,zr=te?te.startPatternName:m?"":V.name,vn=Dr(zr),yn=Math.max(1,vn.bpm*me),Ht=vn.timeSignature,Fr=Math.round(60/yn*(4/Ht[1])*Ht[0]*1e3),{currentBeat:Ur}=Er({bpm:yn,timeSignature:Ht,isPlaying:U,resetToken:z}),Hr=()=>{d(re=>{const ae=!re;return ae||fe(),ae})},Wt=()=>{if(U){fe();return}if(r){x(!1);return}if(!A){c();return}s&&_(!1),Ce(),X(re=>re+1),Y(!0),I.current=window.setTimeout(()=>{Y(!1),Q(re=>re+1),x(!0)},Fr-50)},Wr=()=>{fe(),h()},Vr=()=>{if(m)return;const re={...V,updatedAt:Date.now()};St(re),p(tt())},Gr=()=>{const re=Vt(l),ae=V.id,de=ut(ae),ve={...V,id:Tt(),name:re,updatedAt:Date.now()};St(ve),(de.fileId||de.offsetMs!==0||de.volumePct!==100)&&(nt(ve.id,de),Nn(ae)),b(!1),De(ve.id),O(ve),p(tt())},$r=re=>{Et(r,x,s,_,fe);const ae=Gi(re.name,te,l);if(ae||w(0),G(!1),b(!1),O(re),De(re.id),ae&&M>0){const de=lt(M),ve=re.bpm*de;T(ve),ze(re.bpm)}else T(re.bpm),ze(re.bpm);ae||oe({startPatternName:re.name,startBar:0,endPatternName:re.name,endBar:re.bars-1}),setTimeout(()=>{Ce()},300)},Zr=re=>{fe(),(async()=>{const de=ut(re);de.fileId&&await Yt(de.fileId),Nn(re)})(),_s(re),V.id===re&&(b(!0),K(),De(void 0)),p(tt())},Kr=async re=>{if(!(re.type==="audio/mpeg"||re.name.toLowerCase().endsWith(".mp3"))){se({isLoading:!1,error:"Please upload an MP3 file."});return}se({isLoading:!0,error:null});try{q.fileId&&await Yt(q.fileId);const{id:de,meta:ve}=await _r(re),xe={fileId:de,offsetMs:q.offsetMs??0,volumePct:q.volumePct??100,meta:ve};nt(V.id,xe),F(xe),se({isLoading:!1,error:null})}catch(de){se({isLoading:!1,error:de instanceof Error?de.message:"Failed to upload background music."})}},qr=B.useCallback(re=>{const ae={...q,offsetMs:re};nt(V.id,ae),F(ae)},[q,V.id]),Yr=B.useCallback(re=>{const ae={...q,volumePct:re};nt(V.id,ae),F(ae)},[q,V.id]),Jr=re=>{le(re),Xo(re)},Xr=()=>{(async()=>{q.fileId&&await Yt(q.fileId);const ae={offsetMs:0,volumePct:100};nt(V.id,ae),F(ae)})()},Qr=re=>{const ae=Rn(re);if(!ae){console.log("Invalid pattern data");return}const de=Vt(l),ve=Date.now(),xe={...ae,id:Tt(),name:de,createdAt:ve,updatedAt:ve};St(xe),b(!1),O(xe),De(xe.id),T(xe.bpm),ze(xe.bpm),ce(xe.bpm),p(tt()),oe({startPatternName:xe.name,startBar:0,endPatternName:xe.name,endBar:xe.bars-1})},es=(re,ae)=>{const de=Rn(re);if(!de){console.log("Invalid pattern data");return}const ve=Vt(l),xe=Date.now(),ke={...de,id:Tt(),name:ve,createdAt:xe,updatedAt:xe};if(St(ke),b(!1),O(ke),De(ke.id),T(ke.bpm),ze(ke.bpm),ce(ke.bpm),p(tt()),ae&&ae.fileId){nt(ke.id,{fileId:ae.fileId,offsetMs:ae.offsetMs,volumePct:ae.volumePct,meta:ae.meta});const et=ut(ke.id);F(et)}oe({startPatternName:ke.name,startBar:0,endPatternName:ke.name,endBar:ke.bars-1})};if(t){const re=Math.round(n.loaded/n.total*100);return a.jsx("div",{className:`app loading ${o?"fade-out":""}`,children:a.jsx("div",{className:"loading-container",children:e&&a.jsx("div",{className:"loading-progress",children:a.jsx("div",{className:"loading-progress-bar",children:a.jsx("div",{className:"loading-progress-fill",style:{width:`${re}%`}})})})})})}return a.jsxs("div",{className:"app",children:[a.jsx(sa,{bpm:P,timeSignature:N,isPlaying:r,resetToken:H,onBPMChange:_e,isPatternPlaying:s,isCountInPlaying:U,countInBeat:Ur,onPatternPlayToggle:i,onTimeSignatureChange:ye,rateIndex:M,onRateIndexChange:w,rates:rr,rateLabels:ys,patternPlayButton:y?a.jsx(Zn,{variant:"inline",isPlaying:r,onClick:Wt,onLongPress:Ve,fullPracticeMode:v,isCountInEnabled:A}):void 0}),a.jsx("main",{className:"app-main",children:a.jsx(bi,{pattern:V,onCellClick:ue,onToggleGhost:pe,onCycleThirtySecond:be,onAddBar:u,onRemoveBar:$,onClearGrid:W,onClearBar:j,crossPatternLoop:te,onCrossPatternLoopChange:oe,onSave:Gr,onSaveCurrentPattern:Vr,onImportPattern:Qr,onImportPatternWithBgm:es,onLoadFromSlot:$r,onDeletePattern:Zr,onStopAllPlaying:Wr,onSelectDraft:Oe,savedPatterns:l,currentBeat:f,isPlaying:r,onPlayToggle:Wt,isDraftMode:m,onNotationDoubleClick:Qe,canCopyPattern:!m,hasCopiedPattern:!!R,canPastePattern:gn,onCopyPattern:Or,onPastePatternBefore:()=>bn("before"),onPastePatternAfter:()=>bn("after"),bgmConfig:q,bgmIsLoading:Ut,bgmIsLoaded:kt,bgmError:Ke,onBgmUpload:Kr,onBgmOffsetChange:qr,onBgmVolumeChange:Yr,onBgmDelete:Xr,masterVolume:ne,onMasterVolumeChange:Jr,isCountInEnabled:A,onCountInToggle:Hr,onBarBpmModeToggle:Ee,currentBarHasOverride:ge})}),!y&&a.jsx(Zn,{isPlaying:r,onClick:Wt,onLongPress:Ve,fullPracticeMode:v,isCountInEnabled:A}),a.jsx(Hi,{})]})}Xt.createRoot(document.getElementById("root")).render(a.jsx(ss.StrictMode,{children:a.jsx($i,{})}));

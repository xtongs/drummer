import{r as C,a as Kr,c as kt,g as qr,R as Yr}from"./react-vendor-8a332d8f.js";import{s as Zn,G as ke,O as at,P as Jr,N as Lt,F as Mt,g as Xr,a as mn,b as Qr}from"./audio-libs-2901efa1.js";import{S as Kn,A as nt,D as es,R as pn,a as ts,B as ns,V as gn,F as rs,b as bn,c as vn}from"./graphics-libs-bbd9a815.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();var qn={exports:{}},Ot={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ss=C,as=Symbol.for("react.element"),os=Symbol.for("react.fragment"),is=Object.prototype.hasOwnProperty,cs=ss.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ls={key:!0,ref:!0,__self:!0,__source:!0};function Yn(t,s,e){var i,n={},r=null,c=null;e!==void 0&&(r=""+e),s.key!==void 0&&(r=""+s.key),s.ref!==void 0&&(c=s.ref);for(i in s)is.call(s,i)&&!ls.hasOwnProperty(i)&&(n[i]=s[i]);if(t&&t.defaultProps)for(i in s=t.defaultProps,s)n[i]===void 0&&(n[i]=s[i]);return{$$typeof:as,type:t,key:r,ref:c,props:n,_owner:cs.current}}Ot.Fragment=os;Ot.jsx=Yn;Ot.jsxs=Yn;qn.exports=Ot;var a=qn.exports,qt={},yn=Kr;qt.createRoot=yn.createRoot,qt.hydrateRoot=yn.hydrateRoot;const xn={"Crash 1":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Crash 2":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Hi-Hat Open":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Hi-Hat Closed":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Ride:{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Tom 1":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Tom 2":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Snare:{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Tom 3":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Kick:{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0}},Ce=0,Re=1,Pe=2,Ve=3,Me=4,Fe=5,Ue=6,wn=["Crash 1","Crash 2","Hi-Hat Open","Hi-Hat Closed","Ride","Tom 1","Tom 2","Snare","Tom 3","Kick"],dt=120,Yt=[4,4],Nt=1,me=4,Jn=700,us={"Crash 1":{position:"above",symbol:"x",line:-2.5},"Crash 2":{position:"above",symbol:"o",line:-2},"Hi-Hat Open":{position:"above",symbol:"o",line:-1.5},"Hi-Hat Closed":{position:"above",symbol:"x",line:-1.5},Ride:{position:"above",symbol:"x",line:-1},"Tom 1":{position:"center",symbol:"●",line:-.5},"Tom 2":{position:"center",symbol:"●",line:0},Snare:{position:"center",symbol:"●",line:.5},"Tom 3":{position:"below",symbol:"●",line:1.5},Kick:{position:"below",symbol:"●",line:2.5}},Xn=[9/10,8/9,7/8,6/7,5/6,2],ds=["","x0.9","x0.8","x0.7","x0.6","x0.5"];function it(t,s=Xn){let e=1;for(let i=0;i<t;i++)e*=s[i%s.length];return e}const Qn="drummer-app-data",er="drummer-metronome-bpm",Jt="drummer-cross-pattern-loop",fs="vexflow",tr=new Set([Ce,Re,Pe,Ve,Me,Fe,Ue]);function hs(t){return t.map(s=>s.map(e=>typeof e=="boolean"?e?Re:Ce:typeof e=="number"&&tr.has(e)?e:Ce))}function ms(t){return t.grid.length>0&&t.grid[0].length>0&&typeof t.grid[0][0]=="boolean"?{...t,grid:hs(t.grid)}:t}function gt(){try{const t=localStorage.getItem(Qn);if(t){const s=JSON.parse(t);return s.patterns=s.patterns.map(ms),s}}catch(t){console.error("Failed to load storage data:",t)}return{patterns:[]}}function sn(t){try{localStorage.setItem(Qn,JSON.stringify(t))}catch(s){console.error("Failed to save storage data:",s)}}function _t(t){const s=gt(),e=s.patterns.findIndex(i=>i.id===t.id);e>=0?s.patterns[e]=t:s.patterns.push(t),sn(s)}function Qe(){return gt().patterns}function ps(t){const s=gt();s.patterns=s.patterns.filter(e=>e.id!==t),s.currentPatternId===t&&(s.currentPatternId=void 0),sn(s)}function gs(){return gt().currentPatternId}function De(t){const s=gt();s.currentPatternId=t,sn(s)}function jt(){return`pattern-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ze(t){try{localStorage.setItem(er,String(t))}catch(s){console.error("Failed to save metronome BPM:",s)}}function kn(){try{localStorage.removeItem("metronome_bpm");const t=localStorage.getItem(er);if(t){const s=parseInt(t,10);if(!isNaN(s)&&s>=20&&s<=300)return s}}catch(t){console.error("Failed to load metronome BPM:",t)}return null}function bs(t){try{t===void 0?localStorage.removeItem(Jt):localStorage.setItem(Jt,JSON.stringify(t))}catch(s){console.error("Failed to save cross pattern loop:",s)}}function vs(){try{const t=localStorage.getItem(Jt);if(t){const s=JSON.parse(t);if(typeof s=="object"&&typeof s.startPatternName=="string"&&typeof s.startBar=="number"&&typeof s.endPatternName=="string"&&typeof s.endBar=="number"&&s.startBar>=0&&s.endBar>=0)return s}}catch(t){console.error("Failed to load cross pattern loop:",t)}}function ys(t){if(typeof t!="object"||t===null)return!1;const s=t;if(typeof s.id!="string"||s.id.length===0||typeof s.name!="string"||s.name.length===0||typeof s.bpm!="number"||s.bpm<20||s.bpm>300||!Array.isArray(s.timeSignature)||s.timeSignature.length!==2||typeof s.timeSignature[0]!="number"||typeof s.timeSignature[1]!="number"||typeof s.bars!="number"||s.bars<1||s.bars>100||!Array.isArray(s.grid))return!1;for(const e of s.grid){if(!Array.isArray(e))return!1;for(const i of e)if(typeof i!="number"||!tr.has(i))return!1}if(!Array.isArray(s.drums))return!1;for(const e of s.drums)if(typeof e!="string")return!1;if(typeof s.createdAt!="number"||typeof s.updatedAt!="number"||s.loopRange!==void 0&&(!Array.isArray(s.loopRange)||s.loopRange.length!==2||typeof s.loopRange[0]!="number"||typeof s.loopRange[1]!="number"))return!1;if(s.barBpmOverrides!==void 0){if(typeof s.barBpmOverrides!="object"||s.barBpmOverrides===null)return!1;for(const[e,i]of Object.entries(s.barBpmOverrides)){const n=parseInt(e,10);if(isNaN(n)||n<0||typeof i!="number"||i<20||i>300)return!1}}return!0}function _n(t){try{const s=JSON.parse(t);if(ys(s))return s}catch{}return null}function xs(t){return JSON.stringify(t)}function Ht(t){const s=t.map(i=>i.name).filter(i=>/^[A-Z]$/.test(i));let e="A";if(s.length>0){const i=s.map(r=>r.charCodeAt(0)),n=Math.max(...i);if(n<90)e=String.fromCharCode(n+1);else for(let r=65;r<=90;r++)if(!i.includes(r)){e=String.fromCharCode(r);break}}return e}function Sn(){return fs}function nr(t="New Pattern"){const s=Yt[0],e=Nt*s*me;return{id:jt(),name:t,bpm:dt,timeSignature:Yt,bars:Nt,grid:Array(wn.length).fill(null).map(()=>Array(e).fill(Ce)),drums:wn,createdAt:Date.now(),updatedAt:Date.now()}}const ws=t=>t===Me||t===Fe||t===Ue;function ks(t){const[s,e]=C.useState(t),i=C.useCallback(u=>{e(m=>({...m,bpm:u,updatedAt:Date.now()}))},[]),n=C.useCallback((u,m)=>{e(p=>{const v={...p.barBpmOverrides};m===null?delete v[u]:v[u]=m;const S=Object.keys(v).length>0;return{...p,barBpmOverrides:S?v:void 0,updatedAt:Date.now()}})},[]),r=C.useCallback((u,m)=>{e(p=>{const v=p.grid.map((S,w)=>{if(w===u){const T=[...S];return T[m]=T[m]===Ce?Re:Ce,T}return S});return{...p,grid:v,updatedAt:Date.now()}})},[]),c=C.useCallback((u,m)=>{e(p=>{var R;const v=(R=p.grid[u])==null?void 0:R[m];if(v===Ce||ws(v))return p;const S=p.drums[u],w=xn[S],T=p.grid.map((N,I)=>{if(I===u){const E=[...N];let D;return v===Re?D=w.allowGhost?Pe:Re:v===Pe?D=w.allowGrace?Ve:Re:D=Re,E[m]=D,E}return N});return{...p,grid:T,updatedAt:Date.now()}})},[]),o=C.useCallback((u,m)=>{e(p=>{var N;const v=(N=p.grid[u])==null?void 0:N[m],S=p.drums[u];if(!xn[S].allowThirtySecond){if(v===Ce){const I=p.grid.map((E,D)=>{if(D===u){const O=[...E];return O[m]=Re,O}return E});return{...p,grid:I,updatedAt:Date.now()}}return p}let T;v===Re||v===Pe||v===Ve?T=Me:v===Me?T=Fe:v===Fe?T=Ue:T=Re;const R=p.grid.map((I,E)=>{if(E===u){const D=[...I];return D[m]=T,D}return I});return{...p,grid:R,updatedAt:Date.now()}})},[]),f=C.useCallback(u=>{e(m=>{const[p]=m.timeSignature,v=p*me;let S,w;if(u!==void 0){const E=Math.floor(u/v),D=u%v,O=v/2;D<O?(S=E,w=E):(S=E+1,w=E)}else S=m.bars,w=m.bars-1;const T=w*v,R=T+v,N=m.grid.map(E=>{const D=E.slice(T,R),O=[...E];return O.splice(S*v,0,...D),O});let I;if(m.barBpmOverrides){I={};for(const[D,O]of Object.entries(m.barBpmOverrides)){const k=parseInt(D,10);k>=S?I[k+1]=O:I[k]=O}const E=m.barBpmOverrides[w];E!==void 0&&(I[S]=E),Object.keys(I).length===0&&(I=void 0)}return{...m,bars:m.bars+1,grid:N,barBpmOverrides:I,updatedAt:Date.now()}})},[]),_=C.useCallback(u=>{e(m=>{if(m.bars<=1)return m;const[p]=m.timeSignature,v=p*me;let S;if(u!==void 0){const N=Math.floor(u/v),I=u%v,E=v/2;I<E,S=N}else S=m.bars-1;const w=S*v,T=m.grid.map(N=>{const I=[...N];return I.splice(w,v),I});let R;if(m.barBpmOverrides){R={};for(const[N,I]of Object.entries(m.barBpmOverrides)){const E=parseInt(N,10);E!==S&&(E>S?R[E-1]=I:R[E]=I)}Object.keys(R).length===0&&(R=void 0)}return{...m,bars:m.bars-1,grid:T,barBpmOverrides:R,loopRange:m.loopRange&&m.loopRange[1]>=m.bars-1?[m.loopRange[0],m.bars-2]:m.loopRange,updatedAt:Date.now()}})},[]),x=C.useCallback(()=>{e(u=>{const m=u.grid.map(p=>p.map(()=>Ce));return{...u,grid:m,updatedAt:Date.now()}})},[]),g=C.useCallback(u=>{e(m=>{const[p]=m.timeSignature,v=p*me,w=Math.floor(u/v)*v,T=w+v,R=m.grid.map(N=>{const I=[...N];for(let E=w;E<T;E++)I[E]=Ce;return I});return{...m,grid:R,updatedAt:Date.now()}})},[]),y=C.useCallback((u,m)=>{e(p=>{var D;if(m.bars<=0||m.grid.length!==p.drums.length||m.timeSignature[0]!==p.timeSignature[0]||m.timeSignature[1]!==p.timeSignature[1])return p;const[v]=p.timeSignature,S=v*me,w=Math.max(0,Math.min(p.bars,u)),T=w*S,R=m.bars*S;if(m.grid.some(O=>O.length!==R))return p;const N=p.grid.map((O,k)=>{const L=m.grid[k],d=[...O];return d.splice(T,0,...L),d}),I=m.bpm!==p.bpm;let E;if(p.barBpmOverrides||m.barBpmOverrides||I){if(E={},p.barBpmOverrides)for(const[O,k]of Object.entries(p.barBpmOverrides)){const L=parseInt(O,10);L>=w?E[L+m.bars]=k:E[L]=k}for(let O=0;O<m.bars;O++){const k=(D=m.barBpmOverrides)==null?void 0:D[O];k!==void 0?E[w+O]=k:I&&(E[w+O]=m.bpm)}Object.keys(E).length===0&&(E=void 0)}return{...p,bars:p.bars+m.bars,grid:N,barBpmOverrides:E,updatedAt:Date.now()}})},[]),h=C.useCallback(u=>{e(u)},[]),b=C.useCallback(()=>{e(nr())},[]);return{pattern:s,updateBPM:i,updateBarBpm:n,toggleCell:r,toggleGhost:c,cycleThirtySecond:o,addBar:f,removeBar:_,clearGrid:x,clearBar:g,insertPatternGrid:y,loadPattern:h,resetPattern:b}}function _s(t,s){const e=C.useRef(t),i=C.useRef(s);C.useEffect(()=>{e.current=t},[t]),C.useEffect(()=>{i.current=s},[s]),C.useEffect(()=>{const n=r=>{if(e.current||i.current)return r.preventDefault(),r.returnValue="",""};return window.addEventListener("beforeunload",n),()=>{window.removeEventListener("beforeunload",n)}},[])}const Ss="drummer-audio-cache",Bs=1,Ie="audio-buffers",rr="cache-version",Vt="1.0.0";async function bt(){return new Promise((t,s)=>{const e=indexedDB.open(Ss,Bs);e.onerror=()=>s(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=i=>{const n=i.target.result;n.objectStoreNames.contains(Ie)||n.createObjectStore(Ie,{keyPath:"name"})}})}function Cs(t){const s=[];for(let e=0;e<t.numberOfChannels;e++)s.push(t.getChannelData(e));return{numberOfChannels:t.numberOfChannels,length:t.length,sampleRate:t.sampleRate,channelData:s}}function js(t,s){const e=t.createBuffer(s.numberOfChannels,s.length,s.sampleRate);for(let i=0;i<s.numberOfChannels;i++)e.getChannelData(i).set(s.channelData[i]);return e}async function Es(t,s){try{const e=await bt(),n=e.transaction(Ie,"readwrite").objectStore(Ie),r=Cs(s);await new Promise((c,o)=>{const f=n.put({name:t,data:r});f.onsuccess=()=>c(),f.onerror=()=>o(f.error)}),e.close()}catch(e){console.warn(`Failed to cache audio buffer "${t}":`,e)}}async function Ts(t,s){try{const e=await bt(),n=e.transaction(Ie,"readonly").objectStore(Ie),r=await new Promise((c,o)=>{const f=n.get(s);f.onsuccess=()=>c(f.result),f.onerror=()=>o(f.error)});return e.close(),r?js(t,r.data):null}catch(e){return console.warn(`Failed to get cached audio buffer "${s}":`,e),null}}async function Rs(){try{const t=await bt(),e=t.transaction(Ie,"readwrite").objectStore(Ie);await new Promise((i,n)=>{const r=e.clear();r.onsuccess=()=>i(),r.onerror=()=>n(r.error)}),t.close()}catch(t){console.warn("Failed to clear audio cache:",t)}}async function Ns(){try{const t=await bt(),e=t.transaction(Ie,"readonly").objectStore(Ie),i=await new Promise((n,r)=>{const c=e.get(rr);c.onsuccess=()=>n(c.result),c.onerror=()=>r(c.error)});return t.close(),i?i.version:null}catch(t){return console.warn("Failed to get cache version:",t),null}}async function Is(t){try{const s=await bt(),i=s.transaction(Ie,"readwrite").objectStore(Ie);await new Promise((n,r)=>{const c=i.put({name:rr,version:t});c.onsuccess=()=>n(),c.onerror=()=>r(c.error)}),s.close()}catch(s){console.warn("Failed to set cache version:",s)}}async function As(){try{const t=await Ns();t!==Vt&&(console.log(`Cache version mismatch. Expected: ${Vt}, Found: ${t}. Clearing cache...`),await Rs(),await Is(Vt))}catch(t){console.warn("Failed to check cache version:",t)}}const Ps="/drummer/assets/kick-f5f64180.mp3",Ls="/drummer/assets/snare-4eef7cb8.mp3",Ms="/drummer/assets/hi-hat-closed-20faf03a.mp3",Os="/drummer/assets/hi-hat-open-c13c6d66.mp3",Ds="/drummer/assets/crash-0688e97a.mp3",zs="/drummer/assets/crash2-2d466720.mp3",Fs="/drummer/assets/ride-3a112803.mp3",Us="/drummer/assets/tom1-e6733423.mp3",Ws="/drummer/assets/tom2-5814473e.mp3",Hs="/drummer/assets/tom3-3f3fe247.mp3",Vs="/drummer/assets/metronome-6b186e46.mp3";let Gt=null,$t=!1;const sr=new Map;let Xt=!1,ft=null,mt=1,ar=100,Qt=null;function Gs(){return Gt||(Gt=Xr()),Gt}function $s(){const t=Gs();return t.rawContext??t.context??t}function We(t,s){const i=Math.max(0,s-Be().currentTime)*1e3;setTimeout(()=>{t.forEach(n=>n.dispose())},i)}function Be(){return $s()}async function or(){if(Be().state==="suspended"&&!$t){$t=!0;try{await Zn()}finally{$t=!1}}}async function Zs(t,s,e=!1){const i=Be();try{let n;const r=await Ts(i,s);if(r&&!e)n=r;else{const o=await(await fetch(t)).arrayBuffer();n=await i.decodeAudioData(o),await Es(s,n)}sr.set(s,n)}catch{}}function an(t=!1){if(Xt&&!t)return Promise.resolve();if(ft)return ft;const s=[{url:Ps,name:"kick"},{url:Ls,name:"snare"},{url:Ms,name:"hiHatClosed"},{url:Os,name:"hiHatOpen"},{url:Ds,name:"crash1"},{url:zs,name:"crash2"},{url:Fs,name:"ride"},{url:Us,name:"tom1"},{url:Ws,name:"tom2"},{url:Hs,name:"tom3"},{url:Vs,name:"metronome"}];let e=0;return ft=(async()=>{for(const i of s)await Zs(i.url,i.name,t),e++,Qt&&Qt(e,s.length,i.name);Xt=!0})(),ft}function Ks(){Be().state==="suspended"&&Zn().catch(()=>{}),an()}async function ir(){await As(),await an()}async function qs(){try{Xt=!1,ft=null,await an(!0)}catch(t){console.warn("Failed to update sample cache:",t)}}function Zt(t){Qt=t}function cr(t,s=1,e=1){return Ge("metronome",t,s,!1,e,!1)}function lr(t,s=800,e=.01){const i=new ke(.3).toDestination(),n=new at({frequency:s,type:"sine"});n.connect(i),i.gain.setValueAtTime(.3,t),i.gain.exponentialRampToValueAtTime(.01,t+e),n.start(t),n.stop(t+e),We([n,i],t+e+.1)}function Ys(t){cr(t,.8,1.2)||lr(t,1e3,.02)}function Js(t){cr(t,.6,1)||lr(t,600,.01)}function ur(t){Ge("kick",t,.9)||Xs(t)}function Xs(t){const s=new ke(.85).toDestination(),e=new ke,i=new at({type:"sine"});i.connect(e),e.connect(s),i.frequency.setValueAtTime(150,t),i.frequency.exponentialRampToValueAtTime(40,t+.08),e.gain.setValueAtTime(1,t),e.gain.setValueAtTime(.8,t+.01),e.gain.exponentialRampToValueAtTime(.001,t+.25),i.start(t),i.stop(t+.25),We([i,e,s],t+.35)}function Ge(t,s,e=1,i=!0,n=1,r=!0){const c=sr.get(t);if(!c)return!1;const o=r?ar/100:1,f=i?Math.max(0,Math.min(1,e*mt*o)):Math.max(0,Math.min(1,e*o)),_=new ke(f).toDestination(),x=new Jr(c);x.connect(_),x.playbackRate=n;const g=Math.max(s,Be().currentTime);x.start(g);const y=Math.max(.01,n),h=c.duration/y;return We([x,_],g+h+.1),!0}function en(t){Ge("snare",t,.5)||Qs(t)}function Qs(t){const s=new ke(.5).toDestination(),e=new at({type:"triangle"}),i=new ke;e.connect(i),i.connect(s),e.frequency.setValueAtTime(200,t),e.frequency.exponentialRampToValueAtTime(120,t+.05),i.gain.setValueAtTime(.7,t),i.gain.exponentialRampToValueAtTime(.001,t+.12);const n=new at({type:"sine"}),r=new ke;n.connect(r),r.connect(s),n.frequency.setValueAtTime(400,t),n.frequency.exponentialRampToValueAtTime(200,t+.03),r.gain.setValueAtTime(.3,t),r.gain.exponentialRampToValueAtTime(.001,t+.08);const c=new Lt("white"),o=new Mt({type:"bandpass",frequency:5e3,Q:1}),f=new ke;c.connect(o),o.connect(f),f.connect(s),f.gain.setValueAtTime(.5,t),f.gain.exponentialRampToValueAtTime(.001,t+.18),e.start(t),e.stop(t+.12),n.start(t),n.stop(t+.08),c.start(t),c.stop(t+.18),We([e,i,n,r,c,o,f,s],t+.28)}function dr(t){Ge("hiHatClosed",t,.3)||ea(t)}function ea(t){const s=new ke(.25).toDestination(),e=new Lt("white"),i=new Mt({type:"highpass",frequency:7e3}),n=new ke;e.connect(i),i.connect(n),n.connect(s),n.gain.setValueAtTime(1,t),n.gain.exponentialRampToValueAtTime(.001,t+.05),e.start(t),e.stop(t+.05),We([e,i,n,s],t+.15)}function fr(t){Ge("hiHatOpen",t,.3)||ta(t)}function ta(t){const s=new ke(.4).toDestination(),e=new Lt("white"),i=new Mt({type:"highpass",frequency:6e3}),n=new ke;e.connect(i),i.connect(n),n.connect(s),n.gain.setValueAtTime(1,t),n.gain.exponentialRampToValueAtTime(.001,t+.35),e.start(t),e.stop(t+.35),We([e,i,n,s],t+.45)}function It(t,s=1){const e=s>1?"crash1":"crash2";Ge(e,t,.6)||na(t,s)}function na(t,s=1){const e=new ke(.5).toDestination(),i=new Lt("white"),n=new Mt({type:"highpass",frequency:3e3*s}),r=new ke;i.connect(n),n.connect(r),r.connect(e),r.gain.setValueAtTime(1,t),r.gain.exponentialRampToValueAtTime(.001,t+1.2),i.start(t),i.stop(t+1.2),We([i,n,r,e],t+1.3)}function hr(t){Ge("ride",t,.7)||ra(t)}function ra(t){const s=new ke(.4).toDestination(),e=new ke,i=new at({type:"sine",frequency:3e3});i.connect(e),e.connect(s),e.gain.setValueAtTime(.4,t),e.gain.exponentialRampToValueAtTime(.001,t+.5),i.start(t),i.stop(t+.5),We([i,e,s],t+.6)}function rt(t,s=200){let e;s>=230?e="tom1":s>=180?e="tom2":e="tom3",!Ge(e,t,1)&&sa(t,s)}function sa(t,s=200){const e=new ke(.65).toDestination(),i=new ke,n=new at({type:"sine"});n.connect(i),i.connect(e),n.frequency.setValueAtTime(s*1.5,t),n.frequency.exponentialRampToValueAtTime(s*.6,t+.2),i.gain.setValueAtTime(1,t),i.gain.exponentialRampToValueAtTime(.001,t+.3),n.start(t),n.stop(t+.3),We([n,i,e],t+.4)}async function Bn(t,s=1){await or(),await ir(),mt=s;const i=Be().currentTime;switch(t){case"Kick":ur(i);break;case"Snare":en(i);break;case"Hi-Hat Closed":dr(i);break;case"Hi-Hat Open":fr(i);break;case"Crash 1":It(i,1.2);break;case"Crash 2":It(i,1);break;case"Ride":hr(i);break;case"Tom 1":rt(i,280);break;case"Tom 2":rt(i,220);break;case"Tom 3":rt(i,160);break;default:en(i)}mt=1}function aa(t){mt=t}function oa(){mt=1}function ia(t){ar=Math.max(0,Math.min(100,t))}function ca({isMetronomePlaying:t,isPatternPlaying:s,setIsMetronomePlaying:e,setIsPatternPlaying:i}){const n=C.useRef(!1),r=C.useRef(!1),c=C.useRef(t),o=C.useRef(s);C.useEffect(()=>{c.current=t},[t]),C.useEffect(()=>{o.current=s},[s]),C.useEffect(()=>{const f=async()=>{if(document.hidden)n.current=c.current,r.current=o.current,e(!1),i(!1);else try{await or(),n.current&&e(!0),r.current&&i(!0)}catch(_){console.error("Failed to resume audio context:",_)}};return document.addEventListener("visibilitychange",f),()=>{document.removeEventListener("visibilitychange",f)}},[e,i])}function la(){const[t,s]=C.useState(!0),[e,i]=C.useState({loaded:0,total:11,currentName:""}),[n,r]=C.useState(!1);return C.useEffect(()=>{(async()=>{const o=setTimeout(()=>{r(!0)},200);try{Zt((x,g,y)=>{i({loaded:x,total:g,currentName:y})}),Ks();const _=new Promise((x,g)=>{setTimeout(()=>g(new Error("Sample loading timeout")),1e4)});await Promise.race([ir(),_]),Zt(null),qs().catch(()=>{})}catch{}finally{clearTimeout(o),Zt(null),s(!1)}})()},[]),{isLoading:t,loadingProgress:e,showProgress:n}}const ua=300,da=5;function fa(){C.useEffect(()=>{const t={count:0},s={time:0},e=n=>!!(n.closest("button")||n.closest("input")||n.closest("select")||n.closest("a")||n.closest(".bottom-play-button-container")),i=n=>{const r=n.target;if(e(r))return;const c=Date.now();c-s.time>ua&&(t.count=0),t.count++,s.time=c,t.count>=da&&(window.dispatchEvent(new CustomEvent("show-version")),t.count=0)};return document.body.addEventListener("pointerdown",i,{passive:!0}),()=>{document.body.removeEventListener("pointerdown",i)}},[])}function ha(){const[t,s]=C.useState(!1),[e,i]=C.useState(!1),n=C.useCallback(()=>{s(o=>{const f=!o;return f&&i(!1),f})},[]),r=C.useCallback(()=>{i(o=>{const f=!o;return f&&s(!1),f})},[]),c=C.useCallback(()=>{s(!1),i(!1)},[]);return{isMetronomePlaying:t,isPatternPlaying:e,toggleMetronomePlay:n,togglePatternPlay:r,stopAll:c,setIsMetronomePlaying:s,setIsPatternPlaying:i}}const ma="drummer-bgm-files",pa=1,Ae="bgm-files",mr="drummer-bgm-config",pr="drummer-master-volume",gr=100;function ga(){return`bgm-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function vt(){return new Promise((t,s)=>{const e=indexedDB.open(ma,pa);e.onerror=()=>s(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=i=>{const n=i.target.result;n.objectStoreNames.contains(Ae)||n.createObjectStore(Ae,{keyPath:"id"})}})}async function br(t){const s=await vt(),e=s.transaction(Ae,"readwrite"),i=e.objectStore(Ae),n=ga(),r={id:n,blob:t,name:t.name,size:t.size,type:t.type,createdAt:Date.now()};try{return await new Promise((c,o)=>{e.oncomplete=()=>c(),e.onerror=()=>o(e.error),e.onabort=()=>o(new Error("Transaction aborted"));const f=i.put(r);f.onerror=()=>o(f.error)}),await new Promise(c=>setTimeout(c,50)),s.close(),{id:n,meta:{name:r.name,size:r.size,type:r.type}}}catch(c){throw s.close(),c}}async function vr(t){const s=await vt(),i=s.transaction(Ae,"readonly").objectStore(Ae),n=await new Promise((r,c)=>{const o=i.get(t);o.onsuccess=()=>r(o.result??null),o.onerror=()=>c(o.error)});return s.close(),n}async function Kt(t){const s=await vt(),e=s.transaction(Ae,"readwrite"),i=e.objectStore(Ae);await new Promise((n,r)=>{e.oncomplete=()=>n(),e.onerror=()=>r(e.error);const c=i.delete(t);c.onerror=()=>r(c.error)}),s.close()}async function ba(){const t=await vt(),e=t.transaction(Ae,"readonly").objectStore(Ae),i=await new Promise((n,r)=>{const c=e.getAll();c.onsuccess=()=>n(c.result),c.onerror=()=>r(c.error)});return t.close(),i}async function va(){const t=await vt(),s=t.transaction(Ae,"readwrite"),e=s.objectStore(Ae);await new Promise((i,n)=>{s.oncomplete=()=>i(),s.onerror=()=>n(s.error);const r=e.clear();r.onerror=()=>n(r.error)}),t.close()}async function yr(t,s,e){const i=atob(t),n=new Uint8Array(i.length);for(let o=0;o<i.length;o++)n[o]=i.charCodeAt(o);const r=new Blob([n],{type:e}),c=new File([r],s,{type:e,lastModified:Date.now()});return br(c)}function on(){const t=localStorage.getItem(mr);if(!t)return{};try{const s=JSON.parse(t);if(s&&typeof s=="object")return s}catch{}return{}}function xr(t){localStorage.setItem(mr,JSON.stringify(t))}function ct(t){const e=on()[t];return{fileId:e==null?void 0:e.fileId,offsetMs:(e==null?void 0:e.offsetMs)??0,volumePct:(e==null?void 0:e.volumePct)??gr,meta:e==null?void 0:e.meta}}function et(t,s){const e=on();e[t]={fileId:s.fileId,offsetMs:s.offsetMs??0,volumePct:s.volumePct??gr,meta:s.meta},xr(e)}function Cn(t){const s=on();delete s[t],xr(s)}const jn=0;function ya(){const t=localStorage.getItem(pr);if(!t)return jn;try{const s=JSON.parse(t);if(typeof s=="number"&&s>=0&&s<=100)return s}catch{}return jn}function xa(t){const s=Math.max(0,Math.min(100,t));localStorage.setItem(pr,JSON.stringify(s))}function wa({isPlaying:t,isFullPracticeMode:s,playbackRate:e,bgmConfig:i,currentSubdivision:n,pattern:r,patternStartToken:c,rangeStartBar:o}){const f=r.timeSignature[0],_=r.timeSignature[1],x=C.useRef(null),g=C.useRef(void 0),[y,h]=C.useState({isLoading:!1,isLoaded:!1,error:null}),b=C.useRef(e);b.current=e;const u=C.useRef(0),m=C.useRef(null),p=C.useRef(0),v=C.useCallback(()=>{var X,P;const w=x.current;if(!w)return;const R=Be().currentTime,N=(i.offsetMs??0)/1e3,I=Math.max(.1,b.current),E=u.current;let D=0;for(let A=0;A<o;A++){const W=60/(((X=r.barBpmOverrides)==null?void 0:X[A])??r.bpm)*(4/_)*f;D+=W}const L=E/b.current+D-N,d=L/I,z=L<0?Math.abs(L):0,Z=R+z,F=Math.max(0,d);let Q=F;if(((P=w.buffer)==null?void 0:P.duration)!==void 0){const A=Math.max(0,w.buffer.duration-.001);Q=Math.min(A,F)}w.state==="started"&&w.stop();const V=Math.max(Z,p.current+.001);p.current=V,w.start(V,Q)},[i.offsetMs,r.barBpmOverrides,r.bpm,_,f,o]);C.useEffect(()=>{let w=!1;return(async()=>{if(!i.fileId){g.current=void 0,x.current&&(x.current.stop(),x.current.dispose(),x.current=null),h({isLoading:!1,isLoaded:!1,error:null});return}if(!(i.fileId===g.current&&x.current)){h({isLoading:!0,isLoaded:!1,error:null});try{const R=await vr(i.fileId);if(!R)throw new Error("Background music file not found");const N=Be(),I=await R.blob.arrayBuffer(),E=await N.decodeAudioData(I.slice(0));if(w)return;x.current&&(x.current.stop(),x.current.dispose());const D=new Qr(E).toDestination();D.loop=!1,D.playbackRate=Math.max(.1,b.current),D.grainSize=.2,D.overlap=.02;const O=Math.max(0,Math.min(100,i.volumePct??100)),k=Math.max(1e-4,O/100);D.volume.value=mn(k),x.current=D,g.current=i.fileId,h({isLoading:!1,isLoaded:!0,error:null})}catch(R){w||h({isLoading:!1,isLoaded:!1,error:R instanceof Error?R.message:"Failed to load background music"})}}})(),()=>{w=!0}},[i.fileId,i.volumePct]),C.useEffect(()=>{var L,d,z;const w=f*me,T=Math.floor(n/w);let R=0;for(let Z=0;Z<T;Z++){const X=60/((((L=r.barBpmOverrides)==null?void 0:L[Z])??r.bpm)*e)*(4/_)*f;R+=X}const D=60/((((d=r.barBpmOverrides)==null?void 0:d[T])??r.bpm)*e)*(4/_)/me,O=n%w;R+=O*D;let k=0;for(let Z=0;Z<o;Z++){const X=60/((((z=r.barBpmOverrides)==null?void 0:z[Z])??r.bpm)*e)*(4/_)*f;k+=X}u.current=R-k},[n,r.bpm,r.barBpmOverrides,_,e,o,f]),C.useEffect(()=>{const w=x.current;w&&(w.playbackRate=Math.max(.1,e))},[e]),C.useEffect(()=>{const w=x.current;if(!w)return;const T=Math.max(0,Math.min(100,i.volumePct??100)),R=Math.max(1e-4,T/100);w.volume.value=mn(R)},[i.volumePct]);const S=C.useRef(i.offsetMs??0);return C.useEffect(()=>{if(!x.current||!t||!s||!i.fileId||!y.isLoaded){S.current=i.offsetMs??0;return}const T=S.current;S.current=i.offsetMs??0,T!==(i.offsetMs??0)&&v()},[i.offsetMs,t,s,y.isLoaded,i.fileId,v]),C.useEffect(()=>{const w=x.current;if(!w)return;if(!s||!i.fileId){w.state==="started"&&w.stop();return}if(!t){w.state==="started"&&w.stop();return}const T=Be();T.state==="suspended"&&T.resume().catch(()=>{}),v()},[t,s,i.fileId,i.offsetMs,y.isLoaded,c,v]),C.useEffect(()=>{if(!t||!s||!i.fileId||!y.isLoaded){m.current=n;return}const w=m.current;m.current=n,w!==null&&n<w&&v()},[n,t,s,i.fileId,y.isLoaded,v]),C.useEffect(()=>{m.current=n},[n]),C.useEffect(()=>()=>{x.current&&(x.current.stop(),x.current.dispose(),x.current=null)},[]),y}let Et=null;async function ka(){if("wakeLock"in navigator)try{Et=await navigator.wakeLock.request("screen")}catch{}}async function _a(){if(Et!==null)try{await Et.release(),Et=null}catch{}}let En=0;const Sa=16;function wr({bpm:t,timeSignature:s,isPlaying:e,onBeatChange:i,resetToken:n}){const[r,c]=C.useState(0),[o,f]=C.useState(0),_=C.useRef(t),x=C.useRef(s),g=C.useRef(i);_.current=t,x.current=s,g.current=i;const y=C.useRef(0),h=C.useRef(0),b=C.useRef(null),u=C.useRef(!1),m=C.useRef(new Set),p=C.useCallback(()=>{const w=Be();if(!u.current)return;const T=_.current,R=x.current,N=R[0],I=R[1],D=60/T*(4/I)/me,O=N*me,k=w.currentTime,L=.1;for(;y.current<k+L;){const d=h.current,z=Math.floor(d/me),Z=Math.max(y.current,k),F=(Z-k)*1e3;if(d%me===0){z===0?Ys(Z):Js(Z);const P=g.current;if(P){const A=window.setTimeout(()=>P(z),F);m.current.add(A)}}const Q=d,V=z,X=window.setTimeout(()=>{m.current.delete(X),Date.now()-En>=Sa?requestAnimationFrame(()=>{En=Date.now(),u.current&&(f(Q),c(V))}):u.current&&(f(Q),c(V))},Math.max(0,F));m.current.add(X),h.current=(h.current+1)%O,y.current+=D}},[]),v=C.useCallback(async()=>{const w=Be();if(u.current)return;w.state==="suspended"&&await w.resume(),await new Promise(R=>requestAnimationFrame(R)),ka(),u.current=!0;const T=w.currentTime;y.current=T,p(),b.current=window.setInterval(p,25)},[p]),S=C.useCallback(()=>{u.current=!1,b.current!==null&&(clearInterval(b.current),b.current=null),m.current.forEach(w=>{clearTimeout(w)}),m.current.clear(),_a()},[]);return C.useEffect(()=>(e?v():S(),()=>{S()}),[e,v,S]),C.useEffect(()=>{if(e&&u.current){const w=Be();y.current=w.currentTime}},[t,s,e]),C.useEffect(()=>{if(h.current=0,f(0),c(0),m.current.forEach(w=>{clearTimeout(w)}),m.current.clear(),e&&u.current){const w=Be();y.current=w.currentTime}},[n,e]),{currentBeat:r,currentSubdivision:o}}function Ba({bpm:t,onChange:s,min:e=40,max:i=200,disabled:n=!1}){const r=C.useRef(null),[c,o]=C.useState(!1),[f,_]=C.useState(null),x=C.useCallback(w=>(w-e)/(i-e)*100,[e,i]),g=C.useCallback(w=>{const T=e+w/100*(i-e);return Math.round(T/5)*5},[e,i]),y=C.useCallback(w=>{if(!r.current)return;const T=r.current.getBoundingClientRect(),R=Math.max(0,Math.min(100,(w-T.left)/T.width*100)),N=g(R),I=Math.max(e,Math.min(i,N));s(I)},[g,e,i,s]),h=C.useCallback(w=>{n||(o(!0),y(w.clientX),w.target.setPointerCapture(w.pointerId))},[n,y]),b=C.useCallback(w=>{c&&y(w.clientX)},[c,y]),u=C.useCallback(()=>{o(!1)},[]);C.useEffect(()=>{if(c)return window.addEventListener("pointermove",b),window.addEventListener("pointerup",u),()=>{window.removeEventListener("pointermove",b),window.removeEventListener("pointerup",u)}},[c,b,u]),C.useEffect(()=>{const w=()=>{if(r.current){const T=r.current.getBoundingClientRect();_(T.width)}};return w(),window.addEventListener("resize",w),()=>window.removeEventListener("resize",w)},[]);const m=x(t),p=Math.max(0,m),v=20,S=f?p*(f-v)/f:p;return a.jsx("div",{className:"bpm-slider-container",children:a.jsxs("div",{ref:r,className:`bpm-slider-track ${n?"bpm-slider-disabled":""}`,onPointerDown:h,children:[a.jsx("div",{className:"bpm-slider-fill",style:{width:`calc(${S}% + ${v/2}px)`}}),a.jsx("div",{className:"bpm-slider-thumb",style:{left:`calc((100% - ${v}px) * ${p/100})`}})]})})}function Ca({currentBeat:t,beatsPerBar:s}){return a.jsx("div",{className:"beat-dots",children:Array.from({length:s},(e,i)=>a.jsx("div",{className:`beat-dot ${i===t?"active":""}`},i))})}function ja({isPlaying:t,onClick:s,loopCount:e=0,onResetCount:i}){const n=C.useRef(null),r=C.useRef(!1),c=C.useRef(0),o=500,f=()=>{i&&(r.current=!1,n.current=window.setTimeout(()=>{i(),r.current=!0,n.current=null},o))},_=()=>{n.current&&(clearTimeout(n.current),n.current=null)},x=()=>{n.current&&(clearTimeout(n.current),n.current=null)},g=()=>{i&&(c.current=Date.now(),r.current=!1,n.current=window.setTimeout(()=>{i(),r.current=!0,n.current=null},o))},y=u=>{n.current&&(clearTimeout(n.current),n.current=null),r.current&&(u.preventDefault(),setTimeout(()=>{r.current=!1},100))},h=u=>{if(r.current){u.preventDefault(),u.stopPropagation(),r.current=!1;return}s()},b=e>0;return a.jsx("button",{className:"play-button"+(t?" playing":" paused"),onClick:h,onMouseDown:f,onMouseUp:_,onMouseLeave:x,onTouchStart:g,onTouchEnd:y,"aria-label":t?"Pause":"Play",children:b?a.jsx("span",{className:"play-button-count",children:e}):t?a.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):a.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})})}function Ne(t,s={}){const{delay:e=500,interval:i=100,shouldStop:n,clickCallback:r}=s,c=C.useRef(null),o=C.useRef(null),f=C.useRef(!1),_=C.useRef(0),x=C.useRef(!1),g=C.useRef(t);g.current=t;const y=C.useCallback(()=>{f.current=!1,c.current&&(clearTimeout(c.current),c.current=null),o.current&&(clearInterval(o.current),o.current=null)},[]),h=C.useCallback(()=>{f.current||(f.current=!0,_.current=Date.now(),x.current=!1,c.current=setTimeout(()=>{if(f.current){if(n!=null&&n()){y();return}x.current=!0,g.current(),o.current=setInterval(()=>{if(f.current){if(n!=null&&n()){y();return}g.current()}},i)}},e))},[e,i,n,y]),b=C.useCallback(()=>{const R=Date.now()-_.current;!x.current&&R<e&&(r?r():g.current())},[e,r]),u=C.useCallback(()=>{h()},[h]),m=C.useCallback(()=>{y()},[y]),p=C.useCallback(()=>{y()},[y]),v=C.useCallback(R=>{h()},[h]),S=C.useCallback(R=>{y()},[y]),w=C.useCallback(R=>{y()},[y]),T=C.useCallback(R=>{R.preventDefault()},[]);return C.useEffect(()=>()=>{y()},[y]),{onClick:b,onMouseDown:u,onMouseUp:m,onMouseLeave:p,onTouchStart:v,onTouchEnd:S,onTouchCancel:w,onContextMenu:T}}function Ea({bpm:t,timeSignature:s,isPlaying:e,resetToken:i,onBPMChange:n,isPatternPlaying:r=!1,isCountInPlaying:c=!1,countInBeat:o,onPatternPlayToggle:f,onTimeSignatureChange:_,rateIndex:x,onRateIndexChange:g,rates:y,rateLabels:h,patternPlayButton:b}){const u=C.useMemo(()=>[[4,4],[3,4],[2,4],[6,8],[5,4],[7,8]],[]),m=C.useCallback(()=>{const P=u.findIndex(A=>A[0]===s[0]&&A[1]===s[1]);return P>=0?P:0},[s,u]),[p,v]=C.useState(()=>{const P=u.findIndex(A=>A[0]===s[0]&&A[1]===s[1]);return P>=0?P:0});C.useEffect(()=>{const P=m();v(P)},[m]);const S=()=>{if(_){const P=(p+1)%u.length,A=u[P];v(P),_(A)}},{currentBeat:w}=wr({bpm:t,timeSignature:s,isPlaying:r,resetToken:i}),[T,R]=C.useState(0),N=C.useRef(-1);C.useEffect(()=>{const P=s[0];N.current===P-1&&w===0&&R(A=>A+1),N.current=w},[w,s]),C.useEffect(()=>{r||(N.current=-1,R(0))},[r]);const I=()=>{R(0)},E=40,D=200,O=()=>{const P=Math.round(Math.max(E,t-1)*10)/10;n(P)},k=()=>{const P=Math.round(Math.min(D,t+1)*10)/10;n(P)},L=()=>{const P=Math.round(Math.max(E,t-.5)*10)/10;n(P)},d=()=>{const P=Math.round(Math.min(D,t+.5)*10)/10;n(P)},z=Ne(O,{shouldStop:()=>t<=E,clickCallback:L}),Z=Ne(k,{shouldStop:()=>t>=D,clickCallback:d}),F=P=>{y.length&&g(P)},Q=()=>{F(x+1)},V=()=>{y.length&&F(x+y.length-1)},X=c&&o!==void 0?o:w;return a.jsxs("div",{className:"metronome-bar",children:[a.jsxs("div",{className:"metronome-row metronome-row-top",children:[a.jsx("div",{className:"beat-indicator-group",onClick:S,children:a.jsx(Ca,{currentBeat:X,beatsPerBar:s[0]})}),a.jsxs("div",{className:"bpm-control-group",children:[a.jsx("button",{className:"bpm-control-button",...z,disabled:t<=E||!!h[x%h.length],"aria-label":"Decrease BPM",children:a.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsxs("div",{className:"bpm-display",children:[a.jsxs("span",{className:"bpm-value",children:[a.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-left",onClick:Q,"aria-label":"BPM rate next"}),a.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-right",onClick:V,"aria-label":"BPM rate prev"}),(()=>{const P=Math.round(t*10)/10,A=P!==Math.round(t),Y=Math.floor(P),K=A?String(P).split(".")[1]:null;return a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"bpm-value-integer",children:Y}),K&&a.jsxs("span",{className:"bpm-value-decimal",children:[".",K]})]})})()]}),h[x%h.length]&&a.jsx("span",{className:"bpm-rate-label",children:h[x%h.length]})]}),a.jsx("button",{className:"bpm-control-button",...Z,disabled:t>=D||!!h[x%h.length],"aria-label":"Increase BPM",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),a.jsx("div",{className:"loop-count-group",children:b||f&&a.jsx(ja,{isPlaying:r,onClick:f,loopCount:T,onResetCount:I})})]}),a.jsx("div",{className:"metronome-row metronome-row-bottom",children:a.jsx(Ba,{bpm:t,onChange:n,disabled:!!h[x%h.length]})})]})}function Ta(t,s,e,i){return e+2*i+t*i}function Ra(t){return us[t]}const Ye=7,Se=Ye*.707,Tn=.8,Le=10,At=18,tt=At,lt=5*At;function Na({pattern:t,cellSize:s,currentBeat:e,scrollContainerRef:i,onDoubleClick:n}){const r=C.useRef(null),c=C.useRef(null),o=s,f=I=>{if(!n)return;const E=r.current;if(!E)return;const D=E.getBoundingClientRect(),O=I.clientX-D.left,k=Math.floor(O/o);n(k)},_=C.useRef(null),x=300,g=30,y=I=>{if(!n)return;const E=r.current;if(!E)return;const D=I.touches[0],O=Date.now(),k=E.getBoundingClientRect(),L=D.clientX-k.left;if(_.current){const{time:d,x:z}=_.current,Z=O-d,F=Math.abs(L-z);if(Z<x&&F<g){const Q=Math.floor(L/o);n(Q),_.current=null;return}}_.current={time:O,x:L}},h=I=>getComputedStyle(document.documentElement).getPropertyValue(I).trim(),b=h("--color-text"),u=h("--color-text-tertiary"),m=h("--color-beat-line"),p=h("--color-warning"),[v]=t.timeSignature,w=t.bars*v*me*o,T=lt+tt,R=Array.from({length:t.bars+1},(I,E)=>({x:E*v*me*o,isFirst:E===0,isLast:E===t.bars})),N=Array.from({length:t.bars*v+1},(I,E)=>({x:E*me*o}));return a.jsx("div",{className:"drum-notation-container",ref:c,children:a.jsxs("svg",{ref:r,className:"drum-notation-svg",viewBox:`0 0 ${w} ${T}`,width:w,height:T,preserveAspectRatio:"none",onDoubleClick:f,onTouchStart:y,children:[a.jsx("line",{x1:0,y1:0,x2:w,y2:0,stroke:b,strokeWidth:2,opacity:.8}),Array.from({length:6},(I,E)=>{const D=tt+E*At,O=E===0;return a.jsx("line",{x1:0,y1:D,x2:w,y2:D,stroke:b,strokeWidth:E===5?2:1,opacity:.8,strokeDasharray:O?"4,4":"0"},`staff-line-${E}`)}),R.map((I,E)=>a.jsx("line",{x1:I.x,y1:0,x2:I.x,y2:tt+lt,stroke:I.isFirst||I.isLast?b:u,strokeWidth:I.isFirst||I.isLast?3:2,strokeDasharray:I.isFirst||I.isLast?"0":"4,4",opacity:I.isFirst||I.isLast?1:.6},`bar-line-${E}`)),N.map((I,E)=>E%v===0?null:a.jsx("line",{x1:I.x,y1:0,x2:I.x,y2:tt+lt,stroke:m,strokeWidth:1,opacity:.4},`beat-line-${E}`)),e!==void 0&&e>=0&&a.jsx("rect",{x:e*o,y:0,width:o,height:tt+lt,fill:p,opacity:.4}),t.grid.map((I,E)=>{const D=t.drums[E],O=Ra(D),k=Ta(O.line,lt,tt,At);return I.map((L,d)=>{if(!L)return null;const z=d*o+o/2,Z=O.symbol,F=`symbol-${E}-${d}`,Q=L===Pe,V=L===Ve,X=L===Me,P=L===Fe,A=L===Ue,Y=o*.22,K=X||P||A?[...X||P?[z-Y]:[],...X||A?[z+Y]:[]]:[z],W=q=>{const re=[],le=q-Ye-Tn,ce=q+Ye+Tn,de=k-Le/2,pe=k+Le/2,ve=k-Le/2,l=k+Le/2;return Q?(re.push(a.jsx("path",{d:`M ${le} ${de}
                        A ${Le} ${Le} 0 0 0 ${le} ${pe}`,fill:"none",stroke:b,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${q}`)),re.push(a.jsx("path",{d:`M ${ce} ${ve}
                        A ${Le} ${Le} 0 0 1 ${ce} ${l}`,fill:"none",stroke:b,strokeWidth:1.5,strokeLinecap:"round"},`right-bracket-${q}`))):V&&re.push(a.jsx("path",{d:`M ${le} ${de}
                        A ${Le} ${Le} 0 0 0 ${le} ${pe}`,fill:"none",stroke:b,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${q}`)),re},se=q=>{if(D==="Crash 1"||D==="Crash 2")return a.jsxs("g",{children:[a.jsx("circle",{cx:q,cy:k,r:Ye,fill:"none",stroke:b,strokeWidth:2}),a.jsx("line",{x1:q-Se,y1:k-Se,x2:q+Se,y2:k+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"}),a.jsx("line",{x1:q+Se,y1:k-Se,x2:q-Se,y2:k+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"}),W(q)]},`${F}-${q}`);let re=null;switch(Z){case"x":re=a.jsxs("g",{children:[a.jsx("line",{x1:q-Se,y1:k-Se,x2:q+Se,y2:k+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"}),a.jsx("line",{x1:q+Se,y1:k-Se,x2:q-Se,y2:k+Se,stroke:b,strokeWidth:2,strokeLinecap:"round"})]});break;case"o":re=a.jsx("circle",{cx:q,cy:k,r:Ye,fill:"none",stroke:b,strokeWidth:2});break;case"●":re=a.jsx("circle",{cx:q,cy:k,r:Ye,fill:b});break;case"○":re=a.jsx("circle",{cx:q,cy:k,r:Ye,fill:"none",stroke:b,strokeWidth:2});break;default:return null}return a.jsxs("g",{children:[re,W(q)]},`${F}-${q}`)};return K.map(q=>se(q))})})]})})}const Ia=[{base:1,dots:0,units32:32},{base:2,dots:1,units32:24},{base:2,dots:0,units32:16},{base:4,dots:1,units32:12},{base:4,dots:0,units32:8},{base:8,dots:1,units32:6},{base:8,dots:0,units32:4},{base:16,dots:1,units32:3},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}],Aa=[{base:4,dots:0,units32:8},{base:8,dots:0,units32:4},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}];function Pa(t){if(!Number.isFinite(t)||t<=0)throw new Error(`gapUnits32 must be > 0, got: ${t}`);const s=Ia.find(e=>e.units32<=t);return s||{base:32,dots:0,units32:1}}function St(t){if(!Number.isFinite(t)||t<0)throw new Error(`gapUnits32 must be >= 0, got: ${t}`);const s=[];let e=t;for(;e>0;){const i=Aa.find(n=>n.units32<=e);if(!i)break;s.push(i),e-=i.units32}return s}const ht={"Crash 1":{keys:["b/5/x"],isLowerVoice:!1},"Crash 2":{keys:["a/5/x"],isLowerVoice:!1},"Hi-Hat Open":{keys:["g/5/x"],isLowerVoice:!1},"Hi-Hat Closed":{keys:["g/5/x"],isLowerVoice:!1},Ride:{keys:["f/5/x"],isLowerVoice:!1},"Tom 1":{keys:["e/5"],isLowerVoice:!1},"Tom 2":{keys:["d/5"],isLowerVoice:!1},Snare:{keys:["c/5"],isLowerVoice:!1},"Tom 3":{keys:["a/4"],isLowerVoice:!1},Kick:{keys:["f/4"],isLowerVoice:!0}};function La(t){const s=[],e=[],[i]=t.timeSignature,n=t.bars*i*me;for(let r=0;r<n;r++){const c=()=>({0:{normal:[],ghost:[],grace:[]},1:{normal:[],ghost:[],grace:[]}}),o=c(),f=c();let _=!1,x=!1;t.drums.forEach((y,h)=>{var p;const b=((p=t.grid[h])==null?void 0:p[r])??Ce;if(b===Ce)return;const u=ht[y].isLowerVoice?f:o,m=(v,S)=>{u[S][v].push({drum:y,cellState:b})};b===Me?(m("normal",0),m("normal",1),ht[y].isLowerVoice?x=!0:_=!0):b===Fe?(m("normal",0),ht[y].isLowerVoice?x=!0:_=!0):b===Ue?(m("normal",1),ht[y].isLowerVoice?x=!0:_=!0):b===Ve?y==="Snare"?(m("normal",0),m("grace",0)):m("normal",0):m(b===Pe?"ghost":"normal",0)});const g=(y,h,b,u)=>{const m=h[b],p=[...m.normal.map(v=>({...v,kind:"normal"})),...m.ghost.map(v=>({...v,kind:"ghost"}))];if(p.length>0){const S=p.every(w=>w.kind==="ghost")?"ghost":"normal";y.push({subdivision:r,subPosition:b,drums:p,is32nd:u,kind:S,graceDrums:m.grace.length>0?[...m.grace]:void 0})}};g(s,o,0,_),g(s,o,1,!0),g(e,f,0,x),g(e,f,1,!0)}return{upperVoice:s,lowerVoice:e}}function Ma(t,s,e={}){const i=e.includeFullBarRestWhenEmpty??!1,n=e.omitTailRests??!0,r=e.maxSpanBarFraction??.25,c=s*2,o=r===.25?c/4:c,f=[...t].sort((h,b)=>h.subdivision!==b.subdivision?h.subdivision-b.subdivision:h.subPosition-b.subPosition),_=h=>h.subdivision*2+h.subPosition,x=[];let g=0;const y=h=>{if(o<=0)return 1;const b=h%o;return b===0?o:o-b};if(f.length===0){if(!i)return x;const h=St(c);for(const b of h)x.push({kind:"rest",startUnits32InBar:g,durationToken:b,durationUnits32:b.units32}),g+=b.units32;return x}for(let h=0;h<f.length;h++){const b=f[h],u=_(b),m=h+1<f.length?_(f[h+1]):c;if(u>g){const R=u-g,N=St(R);for(const I of N)x.push({kind:"rest",startUnits32InBar:g,durationToken:I,durationUnits32:I.units32}),g+=I.units32}g=Math.max(g,u);const p=Math.max(1,m-u),v=y(u),S=Math.max(1,Math.min(p,v)),w=Pa(S);x.push({kind:"note",event:b,startUnits32InBar:u,durationToken:w,durationUnits32:w.units32}),g=u+w.units32;const T=h+1>=f.length;if(!T&&g<m){const R=m-g,N=St(R);for(const I of N)x.push({kind:"rest",startUnits32InBar:g,durationToken:I,durationUnits32:I.units32}),g+=I.units32}if(T&&!n&&g<c){const R=c-g,N=St(R);for(const I of N)x.push({kind:"rest",startUnits32InBar:g,durationToken:I,durationUnits32:I.units32}),g+=I.units32}}return x}function Oa(t){var i;const s=t,e=(i=s.getXShift)==null?void 0:i.call(s);return typeof e=="number"?e:typeof s.x_shift=="number"?s.x_shift:0}function kr(t){const s=es;typeof s.buildAndAttach=="function"&&s.buildAndAttach([t],{all:!0})}function Da(t,s,e,i,n,r){const c=t-i;if(r){if(r===4)return(c+1.5)*e+e/2;if(r===8)return(c+.5)*e+e/2}const o=c*e+e/2;if(!n)return o;const f=e*.22;return s===0?o-f:o+f}function za(t,s){if(!s.includes("Hi-Hat Open"))return;const e=new nt("○");e.setVerticalJustification(nt.VerticalJustify.TOP),e.setJustification(nt.HorizontalJustify.CENTER_STEM),e.setFont("",5,900),e.setXShift(-11),e.setYShift(36),t.addModifier(e,0)}function Fa(t,s){if(!s||s.length===0)return;const e=new nt("♪");e.setVerticalJustification(nt.VerticalJustify.BOTTOM),e.setJustification(nt.HorizontalJustify.CENTER_STEM),e.setFont("",15,"normal"),e.setXShift(10),e.setYShift(-55),t.addModifier(e,0)}function Ua(t,s,e){const i=[];let n;for(const{drum:f}of t.drums){const _=ht[f];i.push(..._.keys),n=_.keys.some(x=>x.includes("x"))}const r={keys:i,duration:String(e.base),clef:"percussion",stemDirection:s?-1:1},c=new Kn(r);e.dots===1&&kr(c);const o=t.drums.filter(f=>f.kind==="ghost").map(f=>f.drum);if(o.length>0&&(c._ghostDrums=o),n&&!s){const f=c.getStem();f&&f.setOptions({stemUpYOffset:4})}return za(c,t.drums.map(f=>f.drum)),Fa(c,t.graceDrums),c}function Wa(t,s){const e=`${t.base}r`,i=s?["f/4"]:["c/5"],n=new Kn({keys:i,duration:e,clef:"percussion",stemDirection:s?-1:1});return t.dots===1&&kr(n),n}function Rn(t,s,e){const i=Ma(t,s,{includeFullBarRestWhenEmpty:!0,omitTailRests:!1,maxSpanBarFraction:.25});return i.some(r=>r.kind==="note")?i.map(r=>{if(r.kind==="note")return{note:Ua(r.event,e,r.durationToken),event:r.event,isRest:!1,startUnits32InBar:r.startUnits32InBar,durationUnits32:r.durationUnits32};const c=r.startUnits32InBar,o={subdivision:Math.floor(c/2),subPosition:c%2,drums:[],is32nd:c%2===1,kind:"normal"};return{note:Wa(r.durationToken,e),event:o,isRest:!0,startUnits32InBar:r.startUnits32InBar,durationUnits32:r.durationUnits32}}):[]}function Ha(t,s){const e=s*2,i=Math.floor(e/2);let n=!1,r=!1;for(const c of t){if(c.isRest)continue;const o=c.note.getDuration();Number.parseInt(o.replace(/[rd]/g,""),10)>=16&&((c.startUnits32InBar??c.event.subdivision*2+c.event.subPosition)<i?n=!0:r=!0)}return[n,r]}function Va(t,s){const e=s*2,i=Math.floor(e/2),n=[],r=[];for(const c of t)(c.startUnits32InBar??c.event.subdivision*2+c.event.subPosition)<i?n.push(c):r.push(c);return[n,r]}function Ga(t,s,e){return(t+s/2)/2*e-e/4*1.2}function $a(t,s,e){const i=s*2,n=Math.floor(i/e),r=Array.from({length:e},()=>[]);for(const c of t){const o=c.startUnits32InBar??c.event.subdivision*2+c.event.subPosition,f=Math.floor(o/n);f>=0&&f<e&&r[f].push(c)}return r.filter(c=>c.length>0)}const Tt=130,Za=40,Ka=35,qa=(Tt-Za)/2-Ka;function Ya({pattern:t,cellSize:s,currentBeat:e,scrollContainerRef:i,onDoubleClick:n}){const r=C.useRef(null),c=s,o=C.useRef(null),f=300,_=30,[x]=t.timeSignature,g=t.bars*x*me,y=g*c,h=x*me*c,[b,u]=C.useState([]),m=1,p=C.useCallback(()=>{if(!i||!i.current||!r.current)return;const R=i.current,N=r.current,I=R.getBoundingClientRect(),E=N.getBoundingClientRect(),D=I.left-E.left,O=D+I.width,k=Math.max(0,Math.floor(D/h)),L=Math.min(t.bars-1,Math.ceil(O/h)),d=[],z=Math.max(0,k-m),Z=Math.min(t.bars-1,L+m);for(let F=z;F<=Z;F++)d.push(F);u(d)},[i,h,t.bars]);C.useEffect(()=>{p();const R=i==null?void 0:i.current;if(!R)return;const N=()=>{requestAnimationFrame(p)};return R.addEventListener("scroll",N,{passive:!0}),window.addEventListener("resize",p),()=>{R.removeEventListener("scroll",N),window.removeEventListener("resize",p)}},[i,p]);const v=C.useMemo(()=>new Set(b),[b]),S=C.useCallback(R=>{const N=r.current;if(!N)return 0;const I=N.getBoundingClientRect(),E=R-I.left;return Math.floor(E/c)},[c]),w=C.useCallback(R=>{if(!n)return;const N=S(R.clientX);n(N)},[n,S]),T=C.useCallback(R=>{if(!n)return;const N=R.touches[0],I=Date.now(),E=N.clientX;if(o.current){const{time:D,x:O}=o.current,k=I-D,L=Math.abs(E-O);if(k<f&&L<_){const d=S(E);n(d),o.current=null;return}}o.current={time:I,x:E}},[n,S]);return C.useEffect(()=>{var D,O;const R=r.current;if(!R)return;R.innerHTML="";const N=new pn(R,pn.Backends.SVG);N.resize(y,Tt);const I=N.getContext();for(let k=0;k<t.bars;k++){if(!v.has(k))continue;const L=k*h,d=new ts(L,qa,h);d.setContext(I),k===t.bars-1&&d.setEndBarType(ns.type.END),d.draw();const{upperVoice:z,lowerVoice:Z}=La(t),F=k*x*me,Q=(k+1)*x*me,V=z.filter(se=>se.subdivision>=F&&se.subdivision<Q),X=Z.filter(se=>se.subdivision>=F&&se.subdivision<Q),P=x*me,A=Rn(V.map(se=>({...se,subdivision:se.subdivision-F})),P,!1).map(se=>({...se,event:{...se.event,subdivision:se.event.subdivision+F}})),Y=Rn(X.map(se=>({...se,subdivision:se.subdivision-F})),P,!0).map(se=>({...se,event:{...se.event,subdivision:se.event.subdivision+F}})),K=A,W=Y;if(K.length>0||W.length>0){const se=[],q=[...K,...W];if(K.length>0){const ce=new gn({numBeats:x,beatValue:4}).setStrict(!1);ce.addTickables(K.map(de=>de.note)),se.push(ce)}if(W.length>0){const ce=new gn({numBeats:x,beatValue:4}).setStrict(!1);ce.addTickables(W.map(de=>de.note)),se.push(ce)}se.length>0&&new rs().joinVoices(se).format(se,h-20);for(const ce of q){const{note:de,event:pe,isRest:ve,startUnits32InBar:l,durationUnits32:G}=ce;let H;ve&&l!==void 0&&G?H=Ga(l,G,c):H=Da(pe.subdivision,pe.subPosition,c,F,pe.is32nd)-c/4,de.setStave(d);const j=d.getX()+H,B=de.getAbsoluteX(),M=j-B;de.setXShift(Oa(de)+M)}const re=[],le=[{notes:K,stemDirection:1},{notes:W,stemDirection:-1}];for(const{notes:ce,stemDirection:de}of le){const pe=ce.filter(B=>{const M=B.note.getDuration(),$=Number.parseInt(M.replace(/[rd]/g,""),10);return Number.isFinite($)&&$>=8});if(pe.length===0)continue;const[ve,l]=Ha(pe,P),[G,H]=Va(pe,P),j=[{notes:G,hasSixteenth:ve},{notes:H,hasSixteenth:l}];for(const{notes:B,hasSixteenth:M}of j)if(B.length!==0)if(M){const $=$a(B,P,x);for(const J of $){if(J.length===0)continue;const U=bn.generateBeams(J.map(ee=>ee.note),{stemDirection:de,flatBeams:!0,groups:[new vn(1,4)]});re.push(...U)}}else{const $=bn.generateBeams(B.map(J=>J.note),{stemDirection:de,flatBeams:!0,groups:[new vn(1,2)]});re.push(...$)}}se.forEach(ce=>ce.draw(I,d)),re.forEach(ce=>ce.setContext(I).draw());for(const ce of q){const de=ce.note;if(de._ghostDrums&&de._ghostDrums.length>0&&de.noteHeads){const pe=new Set(de._ghostDrums),ve=ce.event.drums.map(l=>l.drum);for(let l=0;l<de.noteHeads.length;l++){const G=de.noteHeads[l];if(!G)continue;const H=ve[l];if(!H||!pe.has(H))continue;const j=((D=G.getSVGElement)==null?void 0:D.call(G))??G.el;if(j){const B=(O=j.getBBox)==null?void 0:O.call(j);if(B){const M=B.x+B.width/2,$=B.y+B.height/2;j.setAttribute("transform",`translate(${M}, ${$}) scale(0.75) translate(${-M+(H==="Kick"?-2:2)}, ${-$})`)}}}}}}}const E=R.querySelector("svg");if(E&&(E.querySelectorAll(".vf-stave").forEach(d=>{d.setAttribute("stroke","#aaa")}),E.querySelectorAll(".vf-stavebarline").forEach(d=>{d.querySelectorAll("rect").forEach(Z=>{Z.setAttribute("stroke","transparent"),Z.setAttribute("fill","#333")})})),e!==void 0&&e>=0){const k=R.querySelector("svg");if(k){const L=document.createElementNS("http://www.w3.org/2000/svg","rect");L.setAttribute("x",String(e*c)),L.setAttribute("y","0"),L.setAttribute("width",String(c)),L.setAttribute("height",String(Tt)),L.setAttribute("fill","#fbbf24"),L.setAttribute("opacity","0.3"),L.setAttribute("stroke","transparent"),k.insertBefore(L,k.firstChild)}}},[t,e,c,y,x,g,h,v]),a.jsx(a.Fragment,{children:a.jsx("div",{className:"drum-notation-container vexflow-renderer",ref:r,onDoubleClick:w,onTouchStart:T,style:{width:y,height:Tt,backgroundColor:"#ffffff"}})})}const Nn="drummer-renderer-change";function Ja(t){const[s,e]=C.useState(()=>Sn()),[i,n]=C.useState(!1);C.useEffect(()=>{const o=()=>{e(Sn()),n(!1)};return window.addEventListener(Nn,o),()=>{window.removeEventListener(Nn,o)}},[]);const r=C.useCallback(()=>{console.error("VexFlow rendering failed, falling back to Legacy renderer"),n(!0)},[]);return C.useMemo(()=>s==="vexflow"&&!i,[s,i])?a.jsx(Xa,{onError:r,children:a.jsx(Ya,{...t})}):a.jsx(Na,{...t})}class Xa extends C.Component{constructor(s){super(s),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(s,e){console.error("VexFlow rendering error:",s,e),this.props.onError()}render(){return this.state.hasError?null:this.props.children}}const In=300,An=200,Qa=30;function eo({cellState:t,onClick:s,onToggleGhost:e,onDoubleClick:i,isCurrentBeat:n,drumType:r,subdivisionIndex:c=0,style:o}){const f=C.useRef(0),_=100,x=C.useRef(0),g=C.useRef(null),y=C.useRef(null),h=C.useRef(!1),b=C.useRef(0),u=C.useRef(!1),m=C.useRef(null),[p,v]=C.useState(!1),S=t!==Ce,w=t===Pe,T=t===Ve,R=t===Me,N=t===Fe,I=t===Ue,E=R||N||I,D=Math.floor(c/4)%2===1,O=C.useCallback(()=>{const z=Date.now();z-f.current<_||(f.current=z,r&&!S&&Bn(r),s())},[r,S,s]),k=C.useCallback(z=>{z.button!==0&&z.pointerType==="mouse"||(b.current=Date.now(),u.current=!1,h.current=!0,v(!0),m.current=window.setTimeout(()=>{if(u.current=!0,h.current=!1,S&&!E&&(e(),r)){let Z;t===Re?Z=Pe:t===Pe?Z=Ve:Z=Re,Bn(r,Z===Pe?.3:1)}v(!1)},In))},[S,e,r,t,E]),L=C.useCallback(()=>{const z=u.current,Z=h.current;if(m.current&&(clearTimeout(m.current),m.current=null),y.current=window.setTimeout(()=>{v(!1)},Qa),z){u.current=!1;return}if(Date.now()-b.current<In&&Z){const Q=Date.now();if(Q-x.current<An){x.current=0,g.current&&(clearTimeout(g.current),g.current=null),i&&i();return}x.current=Q,g.current&&clearTimeout(g.current),g.current=window.setTimeout(()=>{O(),g.current=null},An)}},[O,i]),d=C.useCallback(()=>{m.current&&(clearTimeout(m.current),m.current=null),y.current&&(clearTimeout(y.current),y.current=null),v(!1),u.current&&(u.current=!1),h.current=!1},[]);return a.jsx("button",{className:`grid-cell ${S?"active":""} ${w?"ghost":""} ${T?"grace":""} ${E?"thirty-second":""} ${R?"double-32":""} ${N?"first-32":""} ${I?"second-32":""} ${n?"current-beat":""} ${D?"alt-beat":""} ${p?"pressing":""}`,style:o,onPointerDown:k,onPointerUp:L,onPointerLeave:d,onPointerCancel:d,type:"button","aria-label":T?"Grace note":w?"Ghost note":S?"Active":"Inactive",children:E&&a.jsxs("div",{className:`cell-32-dots ${R?"double":N?"first":"second"}`,"aria-hidden":"true",children:[(R||N)&&a.jsx("span",{className:"dot left"}),(R||I)&&a.jsx("span",{className:"dot right"})]})})}function to(t,s,e,i,n){const r=t,c=r+s,o=Math.max(0,Math.floor(r/e)-i),f=Math.min(n,Math.ceil(c/e)+i);return{start:o,end:f}}function no(t,s,e){const{itemSize:i,totalItems:n,bufferItems:r=0}=e,c=C.useRef(!1),[o,f]=C.useState(()=>({start:0,end:Math.min(n,Math.ceil(window.innerWidth/i)+r*2)})),_=C.useCallback(()=>{const y=t==null?void 0:t.current,h=s.current;if(!y||!h)return;c.current||(c.current=!0);const b=y.clientWidth;if(n*i<=b){f({start:0,end:n});return}const u=to(y.scrollLeft,b,i,r,n);f(m=>m.start===u.start&&m.end===u.end?m:u)},[t,s,i,r,n]),x=t==null?void 0:t.current;C.useLayoutEffect(()=>{if(!x)return;_();let y;const h=()=>{y&&cancelAnimationFrame(y),y=requestAnimationFrame(_)};return x.addEventListener("scroll",h,{passive:!0}),window.addEventListener("resize",_),()=>{y&&cancelAnimationFrame(y),x.removeEventListener("scroll",h),window.removeEventListener("resize",_)}},[x,_]);const g=C.useMemo(()=>new Set(Array.from({length:o.end-o.start},(y,h)=>o.start+h)),[o]);return{...o,visibleSet:g}}function ro({pattern:t,cellSize:s,onCellClick:e,onToggleGhost:i,onCellDoubleClick:n,currentBeat:r,scrollContainerRef:c}){var y;const o=C.useRef(null),f=((y=t.grid[0])==null?void 0:y.length)||0,_=f*s,x=me*2,{visibleSet:g}=no(c,o,{itemSize:s,totalItems:f,bufferItems:x});return a.jsx("div",{className:"grid-container",children:a.jsx("div",{className:"grid-wrapper",children:a.jsx("div",{className:"grid-content",ref:o,style:{width:`${_}px`},children:a.jsx("div",{className:"grid-rows",children:t.grid.map((h,b)=>{const u=t.drums[b];return a.jsx("div",{className:"grid-row",style:{width:`${_}px`},children:h.map((m,p)=>{if(!g.has(p))return null;const v=r!==void 0&&p===r;return a.jsx(eo,{cellState:m,onClick:()=>e(b,p),onDoubleClick:()=>n(b,p),onToggleGhost:()=>i(b,p),isCurrentBeat:v,drumType:u,subdivisionIndex:p,style:{left:`${p*s}px`}},p)})},b)})})})})})}function so({pattern:t,cellSize:s}){var r;const[e]=t.timeSignature,n=(((r=t.grid[0])==null?void 0:r.length)||0)*s;return a.jsx("div",{className:"grid-container",children:a.jsx("div",{className:"grid-wrapper",children:a.jsx("div",{className:"grid-content",style:{width:`${n}px`},children:a.jsx("div",{className:"grid-beat-labels",children:Array.from({length:t.bars},(c,o)=>{const f=e*me;return a.jsx("div",{className:"grid-beat-label-group",style:{width:`${f*s}px`},children:Array.from({length:e},(_,x)=>{const g=x*me;return a.jsxs("div",{className:"grid-beat-label",style:{width:`${me*s}px`,left:`${g*s}px`},children:[o+1,".",x+1]},x)})},o)})})})})})}function ao({bars:t,onAddBar:s,onRemoveBar:e,canRemove:i,currentBeat:n}){return a.jsx("div",{className:"bar-controls",children:a.jsxs("span",{className:"bar-count",children:[a.jsx("button",{className:"bar-control-button",onClick:()=>e(n),disabled:!i,"aria-label":"Remove bar",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),t,a.jsx("button",{className:"bar-control-button",onClick:()=>s(n),"aria-label":"Add bar",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})}function oo({currentPattern:t,savedPatterns:s,crossPatternLoop:e,onCrossPatternLoopChange:i,isDraftMode:n}){const r=C.useRef(t.bars),c=[...s].sort((O,k)=>O.name.localeCompare(k.name)),o=O=>{if(n&&O===""||!n&&O===t.name)return t.bars;const k=s.find(L=>L.name===O);return(k==null?void 0:k.bars)??t.bars},f=O=>O===""||O===t.name?!0:s.some(k=>k.name===O),_={startPatternName:n?"":t.name,startBar:0,endPatternName:n?"":t.name,endBar:t.bars-1};C.useEffect(()=>{if(!e)return;const O=n?"":t.name,k=(d,z)=>d===z?0:d===""?-1:z===""?1:d.localeCompare(z);(()=>{const{startPatternName:d,endPatternName:z}=e;return d===z?d===O:O===d||O===z?!0:k(d,O)<0&&k(O,z)<0})()||i({startPatternName:O,startBar:0,endPatternName:O,endBar:t.bars-1})},[n,t.name,e,i,t.bars]);const x=(O,k,L,d)=>O===L?k-d:O===""?-1:L===""?1:O.localeCompare(L),g=e??_;C.useEffect(()=>{if(!e||!f(e.startPatternName)||!f(e.endPatternName))return;const O=o(e.startPatternName),k=o(e.endPatternName);let L=!1;const d={...e};e.startBar>=O&&(d.startBar=Math.max(0,O-1),L=!0),e.endBar>=k&&(d.endBar=Math.max(0,k-1),L=!0);const z=n?e.endPatternName==="":e.endPatternName===t.name,Z=e.startPatternName!==e.endPatternName;if(z&&!Z){const F=t.bars-1,Q=r.current,V=t.bars>Q,X=d.endBar===Q-1;V&&X&&(d.endBar=F,L=!0)}L&&x(d.startPatternName,d.startBar,d.endPatternName,d.endBar)>0&&(d.endBar=d.startBar),L&&i(d),r.current=t.bars},[t.bars,n,t.name,s]);const y=n?[{name:"",label:"○"},...c.map(O=>({name:O.name,label:O.name}))]:c.map(O=>({name:O.name,label:O.name})),h=O=>{const k=o(O),L=Math.min(g.startBar,k-1);x(O,L,g.endPatternName,g.endBar)>0?i({startPatternName:O,startBar:L,endPatternName:O,endBar:L}):i({...g,startPatternName:O,startBar:L})},b=O=>{const k=o(O),L=Math.min(g.endBar,k-1);x(g.startPatternName,g.startBar,O,L)>0?i({startPatternName:O,startBar:L,endPatternName:O,endBar:L}):i({...g,endPatternName:O,endBar:L})},u=()=>{g.startBar>0&&i({...g,startBar:g.startBar-1})},m=()=>{const O=o(g.startPatternName)-1,k=Math.min(O,g.startBar+1);x(g.startPatternName,k,g.endPatternName,g.endBar)<=0&&i({...g,startBar:k})},p=()=>{const O=g.endBar-1;O>=0&&x(g.startPatternName,g.startBar,g.endPatternName,O)<=0&&i({...g,endBar:O})},v=()=>{const O=o(g.endPatternName)-1;g.endBar<O&&i({...g,endBar:g.endBar+1})},S=g.startBar>0,w=g.startBar<o(g.startPatternName)-1&&x(g.startPatternName,g.startBar+1,g.endPatternName,g.endBar)<=0,T=g.endBar>0&&x(g.startPatternName,g.startBar,g.endPatternName,g.endBar-1)<=0,R=g.endBar<o(g.endPatternName)-1,N=Ne(u,{shouldStop:()=>!S}),I=Ne(m,{shouldStop:()=>!w}),E=Ne(p,{shouldStop:()=>!T}),D=Ne(v,{shouldStop:()=>!R});return a.jsx("div",{className:"loop-range-selector",children:a.jsxs("div",{className:"loop-range-controls",children:[a.jsxs("div",{className:"loop-range-item",children:[a.jsx("select",{className:"loop-pattern-select",value:g.startPatternName,onChange:O=>h(O.target.value),children:y.map(O=>a.jsx("option",{value:O.name,children:O.label},O.name))}),a.jsx("button",{className:"loop-range-button",...N,disabled:!S,"aria-label":"Decrease start bar",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("span",{className:"loop-range-value",children:g.startBar+1}),a.jsx("button",{className:"loop-range-button",...I,disabled:!w,"aria-label":"Increase start bar",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),a.jsx("span",{className:"loop-range-separator",children:"-"}),a.jsxs("div",{className:"loop-range-item",children:[a.jsx("select",{className:"loop-pattern-select",value:g.endPatternName,onChange:O=>b(O.target.value),children:y.map(O=>a.jsx("option",{value:O.name,children:O.label},O.name))}),a.jsx("button",{className:"loop-range-button",...E,disabled:!T,"aria-label":"Decrease end bar",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("span",{className:"loop-range-value",children:g.endBar+1}),a.jsx("button",{className:"loop-range-button",...D,disabled:!R,"aria-label":"Increase end bar",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})})}function Bt(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var _r={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,s){(function(e){t.exports=e()})(function(){return function e(i,n,r){function c(_,x){if(!n[_]){if(!i[_]){var g=typeof Bt=="function"&&Bt;if(!x&&g)return g(_,!0);if(o)return o(_,!0);var y=new Error("Cannot find module '"+_+"'");throw y.code="MODULE_NOT_FOUND",y}var h=n[_]={exports:{}};i[_][0].call(h.exports,function(b){var u=i[_][1][b];return c(u||b)},h,h.exports,e,i,n,r)}return n[_].exports}for(var o=typeof Bt=="function"&&Bt,f=0;f<r.length;f++)c(r[f]);return c}({1:[function(e,i,n){var r=e("./utils"),c=e("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";n.encode=function(f){for(var _,x,g,y,h,b,u,m=[],p=0,v=f.length,S=v,w=r.getTypeOf(f)!=="string";p<f.length;)S=v-p,g=w?(_=f[p++],x=p<v?f[p++]:0,p<v?f[p++]:0):(_=f.charCodeAt(p++),x=p<v?f.charCodeAt(p++):0,p<v?f.charCodeAt(p++):0),y=_>>2,h=(3&_)<<4|x>>4,b=1<S?(15&x)<<2|g>>6:64,u=2<S?63&g:64,m.push(o.charAt(y)+o.charAt(h)+o.charAt(b)+o.charAt(u));return m.join("")},n.decode=function(f){var _,x,g,y,h,b,u=0,m=0,p="data:";if(f.substr(0,p.length)===p)throw new Error("Invalid base64 input, it looks like a data url.");var v,S=3*(f=f.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(f.charAt(f.length-1)===o.charAt(64)&&S--,f.charAt(f.length-2)===o.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(v=c.uint8array?new Uint8Array(0|S):new Array(0|S);u<f.length;)_=o.indexOf(f.charAt(u++))<<2|(y=o.indexOf(f.charAt(u++)))>>4,x=(15&y)<<4|(h=o.indexOf(f.charAt(u++)))>>2,g=(3&h)<<6|(b=o.indexOf(f.charAt(u++))),v[m++]=_,h!==64&&(v[m++]=x),b!==64&&(v[m++]=g);return v}},{"./support":30,"./utils":32}],2:[function(e,i,n){var r=e("./external"),c=e("./stream/DataWorker"),o=e("./stream/Crc32Probe"),f=e("./stream/DataLengthProbe");function _(x,g,y,h,b){this.compressedSize=x,this.uncompressedSize=g,this.crc32=y,this.compression=h,this.compressedContent=b}_.prototype={getContentWorker:function(){var x=new c(r.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new f("data_length")),g=this;return x.on("end",function(){if(this.streamInfo.data_length!==g.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),x},getCompressedWorker:function(){return new c(r.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},_.createWorkerFrom=function(x,g,y){return x.pipe(new o).pipe(new f("uncompressedSize")).pipe(g.compressWorker(y)).pipe(new f("compressedSize")).withStreamInfo("compression",g)},i.exports=_},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,i,n){var r=e("./stream/GenericWorker");n.STORE={magic:"\0\0",compressWorker:function(){return new r("STORE compression")},uncompressWorker:function(){return new r("STORE decompression")}},n.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,i,n){var r=e("./utils"),c=function(){for(var o,f=[],_=0;_<256;_++){o=_;for(var x=0;x<8;x++)o=1&o?3988292384^o>>>1:o>>>1;f[_]=o}return f}();i.exports=function(o,f){return o!==void 0&&o.length?r.getTypeOf(o)!=="string"?function(_,x,g,y){var h=c,b=y+g;_^=-1;for(var u=y;u<b;u++)_=_>>>8^h[255&(_^x[u])];return-1^_}(0|f,o,o.length,0):function(_,x,g,y){var h=c,b=y+g;_^=-1;for(var u=y;u<b;u++)_=_>>>8^h[255&(_^x.charCodeAt(u))];return-1^_}(0|f,o,o.length,0):0}},{"./utils":32}],5:[function(e,i,n){n.base64=!1,n.binary=!1,n.dir=!1,n.createFolders=!0,n.date=null,n.compression=null,n.compressionOptions=null,n.comment=null,n.unixPermissions=null,n.dosPermissions=null},{}],6:[function(e,i,n){var r=null;r=typeof Promise<"u"?Promise:e("lie"),i.exports={Promise:r}},{lie:37}],7:[function(e,i,n){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",c=e("pako"),o=e("./utils"),f=e("./stream/GenericWorker"),_=r?"uint8array":"array";function x(g,y){f.call(this,"FlateWorker/"+g),this._pako=null,this._pakoAction=g,this._pakoOptions=y,this.meta={}}n.magic="\b\0",o.inherits(x,f),x.prototype.processChunk=function(g){this.meta=g.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(_,g.data),!1)},x.prototype.flush=function(){f.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},x.prototype.cleanUp=function(){f.prototype.cleanUp.call(this),this._pako=null},x.prototype._createPako=function(){this._pako=new c[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var g=this;this._pako.onData=function(y){g.push({data:y,meta:g.meta})}},n.compressWorker=function(g){return new x("Deflate",g)},n.uncompressWorker=function(){return new x("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,i,n){function r(h,b){var u,m="";for(u=0;u<b;u++)m+=String.fromCharCode(255&h),h>>>=8;return m}function c(h,b,u,m,p,v){var S,w,T=h.file,R=h.compression,N=v!==_.utf8encode,I=o.transformTo("string",v(T.name)),E=o.transformTo("string",_.utf8encode(T.name)),D=T.comment,O=o.transformTo("string",v(D)),k=o.transformTo("string",_.utf8encode(D)),L=E.length!==T.name.length,d=k.length!==D.length,z="",Z="",F="",Q=T.dir,V=T.date,X={crc32:0,compressedSize:0,uncompressedSize:0};b&&!u||(X.crc32=h.crc32,X.compressedSize=h.compressedSize,X.uncompressedSize=h.uncompressedSize);var P=0;b&&(P|=8),N||!L&&!d||(P|=2048);var A=0,Y=0;Q&&(A|=16),p==="UNIX"?(Y=798,A|=function(W,se){var q=W;return W||(q=se?16893:33204),(65535&q)<<16}(T.unixPermissions,Q)):(Y=20,A|=function(W){return 63&(W||0)}(T.dosPermissions)),S=V.getUTCHours(),S<<=6,S|=V.getUTCMinutes(),S<<=5,S|=V.getUTCSeconds()/2,w=V.getUTCFullYear()-1980,w<<=4,w|=V.getUTCMonth()+1,w<<=5,w|=V.getUTCDate(),L&&(Z=r(1,1)+r(x(I),4)+E,z+="up"+r(Z.length,2)+Z),d&&(F=r(1,1)+r(x(O),4)+k,z+="uc"+r(F.length,2)+F);var K="";return K+=`
\0`,K+=r(P,2),K+=R.magic,K+=r(S,2),K+=r(w,2),K+=r(X.crc32,4),K+=r(X.compressedSize,4),K+=r(X.uncompressedSize,4),K+=r(I.length,2),K+=r(z.length,2),{fileRecord:g.LOCAL_FILE_HEADER+K+I+z,dirRecord:g.CENTRAL_FILE_HEADER+r(Y,2)+K+r(O.length,2)+"\0\0\0\0"+r(A,4)+r(m,4)+I+z+O}}var o=e("../utils"),f=e("../stream/GenericWorker"),_=e("../utf8"),x=e("../crc32"),g=e("../signature");function y(h,b,u,m){f.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=b,this.zipPlatform=u,this.encodeFileName=m,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(y,f),y.prototype.push=function(h){var b=h.meta.percent||0,u=this.entriesCount,m=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,f.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:u?(b+100*(u-m-1))/u:100}}))},y.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var b=this.streamFiles&&!h.file.dir;if(b){var u=c(h,b,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:u.fileRecord,meta:{percent:0}})}else this.accumulate=!0},y.prototype.closedSource=function(h){this.accumulate=!1;var b=this.streamFiles&&!h.file.dir,u=c(h,b,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(u.dirRecord),b)this.push({data:function(m){return g.DATA_DESCRIPTOR+r(m.crc32,4)+r(m.compressedSize,4)+r(m.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:u.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},y.prototype.flush=function(){for(var h=this.bytesWritten,b=0;b<this.dirRecords.length;b++)this.push({data:this.dirRecords[b],meta:{percent:100}});var u=this.bytesWritten-h,m=function(p,v,S,w,T){var R=o.transformTo("string",T(w));return g.CENTRAL_DIRECTORY_END+"\0\0\0\0"+r(p,2)+r(p,2)+r(v,4)+r(S,4)+r(R.length,2)+R}(this.dirRecords.length,u,h,this.zipComment,this.encodeFileName);this.push({data:m,meta:{percent:100}})},y.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},y.prototype.registerPrevious=function(h){this._sources.push(h);var b=this;return h.on("data",function(u){b.processChunk(u)}),h.on("end",function(){b.closedSource(b.previous.streamInfo),b._sources.length?b.prepareNextSource():b.end()}),h.on("error",function(u){b.error(u)}),this},y.prototype.resume=function(){return!!f.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},y.prototype.error=function(h){var b=this._sources;if(!f.prototype.error.call(this,h))return!1;for(var u=0;u<b.length;u++)try{b[u].error(h)}catch{}return!0},y.prototype.lock=function(){f.prototype.lock.call(this);for(var h=this._sources,b=0;b<h.length;b++)h[b].lock()},i.exports=y},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,i,n){var r=e("../compressions"),c=e("./ZipFileWorker");n.generateWorker=function(o,f,_){var x=new c(f.streamFiles,_,f.platform,f.encodeFileName),g=0;try{o.forEach(function(y,h){g++;var b=function(v,S){var w=v||S,T=r[w];if(!T)throw new Error(w+" is not a valid compression method !");return T}(h.options.compression,f.compression),u=h.options.compressionOptions||f.compressionOptions||{},m=h.dir,p=h.date;h._compressWorker(b,u).withStreamInfo("file",{name:y,dir:m,date:p,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(x)}),x.entriesCount=g}catch(y){x.error(y)}return x}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,i,n){function r(){if(!(this instanceof r))return new r;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var c=new r;for(var o in this)typeof this[o]!="function"&&(c[o]=this[o]);return c}}(r.prototype=e("./object")).loadAsync=e("./load"),r.support=e("./support"),r.defaults=e("./defaults"),r.version="3.10.1",r.loadAsync=function(c,o){return new r().loadAsync(c,o)},r.external=e("./external"),i.exports=r},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,i,n){var r=e("./utils"),c=e("./external"),o=e("./utf8"),f=e("./zipEntries"),_=e("./stream/Crc32Probe"),x=e("./nodejsUtils");function g(y){return new c.Promise(function(h,b){var u=y.decompressed.getContentWorker().pipe(new _);u.on("error",function(m){b(m)}).on("end",function(){u.streamInfo.crc32!==y.decompressed.crc32?b(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}i.exports=function(y,h){var b=this;return h=r.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),x.isNode&&x.isStream(y)?c.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):r.prepareContent("the loaded zip file",y,!0,h.optimizedBinaryString,h.base64).then(function(u){var m=new f(h);return m.load(u),m}).then(function(u){var m=[c.Promise.resolve(u)],p=u.files;if(h.checkCRC32)for(var v=0;v<p.length;v++)m.push(g(p[v]));return c.Promise.all(m)}).then(function(u){for(var m=u.shift(),p=m.files,v=0;v<p.length;v++){var S=p[v],w=S.fileNameStr,T=r.resolve(S.fileNameStr);b.file(T,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:h.createFolders}),S.dir||(b.file(T).unsafeOriginalName=w)}return m.zipComment.length&&(b.comment=m.zipComment),b})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,i,n){var r=e("../utils"),c=e("../stream/GenericWorker");function o(f,_){c.call(this,"Nodejs stream input adapter for "+f),this._upstreamEnded=!1,this._bindStream(_)}r.inherits(o,c),o.prototype._bindStream=function(f){var _=this;(this._stream=f).pause(),f.on("data",function(x){_.push({data:x,meta:{percent:0}})}).on("error",function(x){_.isPaused?this.generatedError=x:_.error(x)}).on("end",function(){_.isPaused?_._upstreamEnded=!0:_.end()})},o.prototype.pause=function(){return!!c.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!c.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},i.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,i,n){var r=e("readable-stream").Readable;function c(o,f,_){r.call(this,f),this._helper=o;var x=this;o.on("data",function(g,y){x.push(g)||x._helper.pause(),_&&_(y)}).on("error",function(g){x.emit("error",g)}).on("end",function(){x.push(null)})}e("../utils").inherits(c,r),c.prototype._read=function(){this._helper.resume()},i.exports=c},{"../utils":32,"readable-stream":16}],14:[function(e,i,n){i.exports={isNode:typeof Buffer<"u",newBufferFrom:function(r,c){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(r,c);if(typeof r=="number")throw new Error('The "data" argument must not be a number');return new Buffer(r,c)},allocBuffer:function(r){if(Buffer.alloc)return Buffer.alloc(r);var c=new Buffer(r);return c.fill(0),c},isBuffer:function(r){return Buffer.isBuffer(r)},isStream:function(r){return r&&typeof r.on=="function"&&typeof r.pause=="function"&&typeof r.resume=="function"}}},{}],15:[function(e,i,n){function r(T,R,N){var I,E=o.getTypeOf(R),D=o.extend(N||{},x);D.date=D.date||new Date,D.compression!==null&&(D.compression=D.compression.toUpperCase()),typeof D.unixPermissions=="string"&&(D.unixPermissions=parseInt(D.unixPermissions,8)),D.unixPermissions&&16384&D.unixPermissions&&(D.dir=!0),D.dosPermissions&&16&D.dosPermissions&&(D.dir=!0),D.dir&&(T=p(T)),D.createFolders&&(I=m(T))&&v.call(this,I,!0);var O=E==="string"&&D.binary===!1&&D.base64===!1;N&&N.binary!==void 0||(D.binary=!O),(R instanceof g&&R.uncompressedSize===0||D.dir||!R||R.length===0)&&(D.base64=!1,D.binary=!0,R="",D.compression="STORE",E="string");var k=null;k=R instanceof g||R instanceof f?R:b.isNode&&b.isStream(R)?new u(T,R):o.prepareContent(T,R,D.binary,D.optimizedBinaryString,D.base64);var L=new y(T,k,D);this.files[T]=L}var c=e("./utf8"),o=e("./utils"),f=e("./stream/GenericWorker"),_=e("./stream/StreamHelper"),x=e("./defaults"),g=e("./compressedObject"),y=e("./zipObject"),h=e("./generate"),b=e("./nodejsUtils"),u=e("./nodejs/NodejsStreamInputAdapter"),m=function(T){T.slice(-1)==="/"&&(T=T.substring(0,T.length-1));var R=T.lastIndexOf("/");return 0<R?T.substring(0,R):""},p=function(T){return T.slice(-1)!=="/"&&(T+="/"),T},v=function(T,R){return R=R!==void 0?R:x.createFolders,T=p(T),this.files[T]||r.call(this,T,null,{dir:!0,createFolders:R}),this.files[T]};function S(T){return Object.prototype.toString.call(T)==="[object RegExp]"}var w={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(T){var R,N,I;for(R in this.files)I=this.files[R],(N=R.slice(this.root.length,R.length))&&R.slice(0,this.root.length)===this.root&&T(N,I)},filter:function(T){var R=[];return this.forEach(function(N,I){T(N,I)&&R.push(I)}),R},file:function(T,R,N){if(arguments.length!==1)return T=this.root+T,r.call(this,T,R,N),this;if(S(T)){var I=T;return this.filter(function(D,O){return!O.dir&&I.test(D)})}var E=this.files[this.root+T];return E&&!E.dir?E:null},folder:function(T){if(!T)return this;if(S(T))return this.filter(function(E,D){return D.dir&&T.test(E)});var R=this.root+T,N=v.call(this,R),I=this.clone();return I.root=N.name,I},remove:function(T){T=this.root+T;var R=this.files[T];if(R||(T.slice(-1)!=="/"&&(T+="/"),R=this.files[T]),R&&!R.dir)delete this.files[T];else for(var N=this.filter(function(E,D){return D.name.slice(0,T.length)===T}),I=0;I<N.length;I++)delete this.files[N[I].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(T){var R,N={};try{if((N=o.extend(T||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:c.utf8encode})).type=N.type.toLowerCase(),N.compression=N.compression.toUpperCase(),N.type==="binarystring"&&(N.type="string"),!N.type)throw new Error("No output type specified.");o.checkSupport(N.type),N.platform!=="darwin"&&N.platform!=="freebsd"&&N.platform!=="linux"&&N.platform!=="sunos"||(N.platform="UNIX"),N.platform==="win32"&&(N.platform="DOS");var I=N.comment||this.comment||"";R=h.generateWorker(this,N,I)}catch(E){(R=new f("error")).error(E)}return new _(R,N.type||"string",N.mimeType)},generateAsync:function(T,R){return this.generateInternalStream(T).accumulate(R)},generateNodeStream:function(T,R){return(T=T||{}).type||(T.type="nodebuffer"),this.generateInternalStream(T).toNodejsStream(R)}};i.exports=w},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,i,n){i.exports=e("stream")},{stream:void 0}],17:[function(e,i,n){var r=e("./DataReader");function c(o){r.call(this,o);for(var f=0;f<this.data.length;f++)o[f]=255&o[f]}e("../utils").inherits(c,r),c.prototype.byteAt=function(o){return this.data[this.zero+o]},c.prototype.lastIndexOfSignature=function(o){for(var f=o.charCodeAt(0),_=o.charCodeAt(1),x=o.charCodeAt(2),g=o.charCodeAt(3),y=this.length-4;0<=y;--y)if(this.data[y]===f&&this.data[y+1]===_&&this.data[y+2]===x&&this.data[y+3]===g)return y-this.zero;return-1},c.prototype.readAndCheckSignature=function(o){var f=o.charCodeAt(0),_=o.charCodeAt(1),x=o.charCodeAt(2),g=o.charCodeAt(3),y=this.readData(4);return f===y[0]&&_===y[1]&&x===y[2]&&g===y[3]},c.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var f=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,f},i.exports=c},{"../utils":32,"./DataReader":18}],18:[function(e,i,n){var r=e("../utils");function c(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}c.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var f,_=0;for(this.checkOffset(o),f=this.index+o-1;f>=this.index;f--)_=(_<<8)+this.byteAt(f);return this.index+=o,_},readString:function(o){return r.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},i.exports=c},{"../utils":32}],19:[function(e,i,n){var r=e("./Uint8ArrayReader");function c(o){r.call(this,o)}e("../utils").inherits(c,r),c.prototype.readData=function(o){this.checkOffset(o);var f=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,f},i.exports=c},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,i,n){var r=e("./DataReader");function c(o){r.call(this,o)}e("../utils").inherits(c,r),c.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},c.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},c.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},c.prototype.readData=function(o){this.checkOffset(o);var f=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,f},i.exports=c},{"../utils":32,"./DataReader":18}],21:[function(e,i,n){var r=e("./ArrayReader");function c(o){r.call(this,o)}e("../utils").inherits(c,r),c.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var f=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,f},i.exports=c},{"../utils":32,"./ArrayReader":17}],22:[function(e,i,n){var r=e("../utils"),c=e("../support"),o=e("./ArrayReader"),f=e("./StringReader"),_=e("./NodeBufferReader"),x=e("./Uint8ArrayReader");i.exports=function(g){var y=r.getTypeOf(g);return r.checkSupport(y),y!=="string"||c.uint8array?y==="nodebuffer"?new _(g):c.uint8array?new x(r.transformTo("uint8array",g)):new o(r.transformTo("array",g)):new f(g)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,i,n){n.LOCAL_FILE_HEADER="PK",n.CENTRAL_FILE_HEADER="PK",n.CENTRAL_DIRECTORY_END="PK",n.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",n.ZIP64_CENTRAL_DIRECTORY_END="PK",n.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,i,n){var r=e("./GenericWorker"),c=e("../utils");function o(f){r.call(this,"ConvertWorker to "+f),this.destType=f}c.inherits(o,r),o.prototype.processChunk=function(f){this.push({data:c.transformTo(this.destType,f.data),meta:f.meta})},i.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(e,i,n){var r=e("./GenericWorker"),c=e("../crc32");function o(){r.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(o,r),o.prototype.processChunk=function(f){this.streamInfo.crc32=c(f.data,this.streamInfo.crc32||0),this.push(f)},i.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,i,n){var r=e("../utils"),c=e("./GenericWorker");function o(f){c.call(this,"DataLengthProbe for "+f),this.propName=f,this.withStreamInfo(f,0)}r.inherits(o,c),o.prototype.processChunk=function(f){if(f){var _=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=_+f.data.length}c.prototype.processChunk.call(this,f)},i.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(e,i,n){var r=e("../utils"),c=e("./GenericWorker");function o(f){c.call(this,"DataWorker");var _=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,f.then(function(x){_.dataIsReady=!0,_.data=x,_.max=x&&x.length||0,_.type=r.getTypeOf(x),_.isPaused||_._tickAndRepeat()},function(x){_.error(x)})}r.inherits(o,c),o.prototype.cleanUp=function(){c.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!c.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,r.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(r.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var f=null,_=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":f=this.data.substring(this.index,_);break;case"uint8array":f=this.data.subarray(this.index,_);break;case"array":case"nodebuffer":f=this.data.slice(this.index,_)}return this.index=_,this.push({data:f,meta:{percent:this.max?this.index/this.max*100:0}})},i.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(e,i,n){function r(c){this.name=c||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}r.prototype={push:function(c){this.emit("data",c)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(c){this.emit("error",c)}return!0},error:function(c){return!this.isFinished&&(this.isPaused?this.generatedError=c:(this.isFinished=!0,this.emit("error",c),this.previous&&this.previous.error(c),this.cleanUp()),!0)},on:function(c,o){return this._listeners[c].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(c,o){if(this._listeners[c])for(var f=0;f<this._listeners[c].length;f++)this._listeners[c][f].call(this,o)},pipe:function(c){return c.registerPrevious(this)},registerPrevious:function(c){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=c.streamInfo,this.mergeStreamInfo(),this.previous=c;var o=this;return c.on("data",function(f){o.processChunk(f)}),c.on("end",function(){o.end()}),c.on("error",function(f){o.error(f)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var c=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),c=!0),this.previous&&this.previous.resume(),!c},flush:function(){},processChunk:function(c){this.push(c)},withStreamInfo:function(c,o){return this.extraStreamInfo[c]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var c in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,c)&&(this.streamInfo[c]=this.extraStreamInfo[c])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var c="Worker "+this.name;return this.previous?this.previous+" -> "+c:c}},i.exports=r},{}],29:[function(e,i,n){var r=e("../utils"),c=e("./ConvertWorker"),o=e("./GenericWorker"),f=e("../base64"),_=e("../support"),x=e("../external"),g=null;if(_.nodestream)try{g=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function y(b,u){return new x.Promise(function(m,p){var v=[],S=b._internalType,w=b._outputType,T=b._mimeType;b.on("data",function(R,N){v.push(R),u&&u(N)}).on("error",function(R){v=[],p(R)}).on("end",function(){try{var R=function(N,I,E){switch(N){case"blob":return r.newBlob(r.transformTo("arraybuffer",I),E);case"base64":return f.encode(I);default:return r.transformTo(N,I)}}(w,function(N,I){var E,D=0,O=null,k=0;for(E=0;E<I.length;E++)k+=I[E].length;switch(N){case"string":return I.join("");case"array":return Array.prototype.concat.apply([],I);case"uint8array":for(O=new Uint8Array(k),E=0;E<I.length;E++)O.set(I[E],D),D+=I[E].length;return O;case"nodebuffer":return Buffer.concat(I);default:throw new Error("concat : unsupported type '"+N+"'")}}(S,v),T);m(R)}catch(N){p(N)}v=[]}).resume()})}function h(b,u,m){var p=u;switch(u){case"blob":case"arraybuffer":p="uint8array";break;case"base64":p="string"}try{this._internalType=p,this._outputType=u,this._mimeType=m,r.checkSupport(p),this._worker=b.pipe(new c(p)),b.lock()}catch(v){this._worker=new o("error"),this._worker.error(v)}}h.prototype={accumulate:function(b){return y(this,b)},on:function(b,u){var m=this;return b==="data"?this._worker.on(b,function(p){u.call(m,p.data,p.meta)}):this._worker.on(b,function(){r.delay(u,arguments,m)}),this},resume:function(){return r.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(b){if(r.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new g(this,{objectMode:this._outputType!=="nodebuffer"},b)}},i.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,i,n){if(n.base64=!0,n.array=!0,n.string=!0,n.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",n.nodebuffer=typeof Buffer<"u",n.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")n.blob=!1;else{var r=new ArrayBuffer(0);try{n.blob=new Blob([r],{type:"application/zip"}).size===0}catch{try{var c=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);c.append(r),n.blob=c.getBlob("application/zip").size===0}catch{n.blob=!1}}}try{n.nodestream=!!e("readable-stream").Readable}catch{n.nodestream=!1}},{"readable-stream":16}],31:[function(e,i,n){for(var r=e("./utils"),c=e("./support"),o=e("./nodejsUtils"),f=e("./stream/GenericWorker"),_=new Array(256),x=0;x<256;x++)_[x]=252<=x?6:248<=x?5:240<=x?4:224<=x?3:192<=x?2:1;_[254]=_[254]=1;function g(){f.call(this,"utf-8 decode"),this.leftOver=null}function y(){f.call(this,"utf-8 encode")}n.utf8encode=function(h){return c.nodebuffer?o.newBufferFrom(h,"utf-8"):function(b){var u,m,p,v,S,w=b.length,T=0;for(v=0;v<w;v++)(64512&(m=b.charCodeAt(v)))==55296&&v+1<w&&(64512&(p=b.charCodeAt(v+1)))==56320&&(m=65536+(m-55296<<10)+(p-56320),v++),T+=m<128?1:m<2048?2:m<65536?3:4;for(u=c.uint8array?new Uint8Array(T):new Array(T),v=S=0;S<T;v++)(64512&(m=b.charCodeAt(v)))==55296&&v+1<w&&(64512&(p=b.charCodeAt(v+1)))==56320&&(m=65536+(m-55296<<10)+(p-56320),v++),m<128?u[S++]=m:(m<2048?u[S++]=192|m>>>6:(m<65536?u[S++]=224|m>>>12:(u[S++]=240|m>>>18,u[S++]=128|m>>>12&63),u[S++]=128|m>>>6&63),u[S++]=128|63&m);return u}(h)},n.utf8decode=function(h){return c.nodebuffer?r.transformTo("nodebuffer",h).toString("utf-8"):function(b){var u,m,p,v,S=b.length,w=new Array(2*S);for(u=m=0;u<S;)if((p=b[u++])<128)w[m++]=p;else if(4<(v=_[p]))w[m++]=65533,u+=v-1;else{for(p&=v===2?31:v===3?15:7;1<v&&u<S;)p=p<<6|63&b[u++],v--;1<v?w[m++]=65533:p<65536?w[m++]=p:(p-=65536,w[m++]=55296|p>>10&1023,w[m++]=56320|1023&p)}return w.length!==m&&(w.subarray?w=w.subarray(0,m):w.length=m),r.applyFromCharCode(w)}(h=r.transformTo(c.uint8array?"uint8array":"array",h))},r.inherits(g,f),g.prototype.processChunk=function(h){var b=r.transformTo(c.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(c.uint8array){var u=b;(b=new Uint8Array(u.length+this.leftOver.length)).set(this.leftOver,0),b.set(u,this.leftOver.length)}else b=this.leftOver.concat(b);this.leftOver=null}var m=function(v,S){var w;for((S=S||v.length)>v.length&&(S=v.length),w=S-1;0<=w&&(192&v[w])==128;)w--;return w<0||w===0?S:w+_[v[w]]>S?w:S}(b),p=b;m!==b.length&&(c.uint8array?(p=b.subarray(0,m),this.leftOver=b.subarray(m,b.length)):(p=b.slice(0,m),this.leftOver=b.slice(m,b.length))),this.push({data:n.utf8decode(p),meta:h.meta})},g.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:n.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},n.Utf8DecodeWorker=g,r.inherits(y,f),y.prototype.processChunk=function(h){this.push({data:n.utf8encode(h.data),meta:h.meta})},n.Utf8EncodeWorker=y},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,i,n){var r=e("./support"),c=e("./base64"),o=e("./nodejsUtils"),f=e("./external");function _(u){return u}function x(u,m){for(var p=0;p<u.length;++p)m[p]=255&u.charCodeAt(p);return m}e("setimmediate"),n.newBlob=function(u,m){n.checkSupport("blob");try{return new Blob([u],{type:m})}catch{try{var p=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return p.append(u),p.getBlob(m)}catch{throw new Error("Bug : can't construct the Blob.")}}};var g={stringifyByChunk:function(u,m,p){var v=[],S=0,w=u.length;if(w<=p)return String.fromCharCode.apply(null,u);for(;S<w;)m==="array"||m==="nodebuffer"?v.push(String.fromCharCode.apply(null,u.slice(S,Math.min(S+p,w)))):v.push(String.fromCharCode.apply(null,u.subarray(S,Math.min(S+p,w)))),S+=p;return v.join("")},stringifyByChar:function(u){for(var m="",p=0;p<u.length;p++)m+=String.fromCharCode(u[p]);return m},applyCanBeUsed:{uint8array:function(){try{return r.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return r.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function y(u){var m=65536,p=n.getTypeOf(u),v=!0;if(p==="uint8array"?v=g.applyCanBeUsed.uint8array:p==="nodebuffer"&&(v=g.applyCanBeUsed.nodebuffer),v)for(;1<m;)try{return g.stringifyByChunk(u,p,m)}catch{m=Math.floor(m/2)}return g.stringifyByChar(u)}function h(u,m){for(var p=0;p<u.length;p++)m[p]=u[p];return m}n.applyFromCharCode=y;var b={};b.string={string:_,array:function(u){return x(u,new Array(u.length))},arraybuffer:function(u){return b.string.uint8array(u).buffer},uint8array:function(u){return x(u,new Uint8Array(u.length))},nodebuffer:function(u){return x(u,o.allocBuffer(u.length))}},b.array={string:y,array:_,arraybuffer:function(u){return new Uint8Array(u).buffer},uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return o.newBufferFrom(u)}},b.arraybuffer={string:function(u){return y(new Uint8Array(u))},array:function(u){return h(new Uint8Array(u),new Array(u.byteLength))},arraybuffer:_,uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return o.newBufferFrom(new Uint8Array(u))}},b.uint8array={string:y,array:function(u){return h(u,new Array(u.length))},arraybuffer:function(u){return u.buffer},uint8array:_,nodebuffer:function(u){return o.newBufferFrom(u)}},b.nodebuffer={string:y,array:function(u){return h(u,new Array(u.length))},arraybuffer:function(u){return b.nodebuffer.uint8array(u).buffer},uint8array:function(u){return h(u,new Uint8Array(u.length))},nodebuffer:_},n.transformTo=function(u,m){if(m=m||"",!u)return m;n.checkSupport(u);var p=n.getTypeOf(m);return b[p][u](m)},n.resolve=function(u){for(var m=u.split("/"),p=[],v=0;v<m.length;v++){var S=m[v];S==="."||S===""&&v!==0&&v!==m.length-1||(S===".."?p.pop():p.push(S))}return p.join("/")},n.getTypeOf=function(u){return typeof u=="string"?"string":Object.prototype.toString.call(u)==="[object Array]"?"array":r.nodebuffer&&o.isBuffer(u)?"nodebuffer":r.uint8array&&u instanceof Uint8Array?"uint8array":r.arraybuffer&&u instanceof ArrayBuffer?"arraybuffer":void 0},n.checkSupport=function(u){if(!r[u.toLowerCase()])throw new Error(u+" is not supported by this platform")},n.MAX_VALUE_16BITS=65535,n.MAX_VALUE_32BITS=-1,n.pretty=function(u){var m,p,v="";for(p=0;p<(u||"").length;p++)v+="\\x"+((m=u.charCodeAt(p))<16?"0":"")+m.toString(16).toUpperCase();return v},n.delay=function(u,m,p){setImmediate(function(){u.apply(p||null,m||[])})},n.inherits=function(u,m){function p(){}p.prototype=m.prototype,u.prototype=new p},n.extend=function(){var u,m,p={};for(u=0;u<arguments.length;u++)for(m in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],m)&&p[m]===void 0&&(p[m]=arguments[u][m]);return p},n.prepareContent=function(u,m,p,v,S){return f.Promise.resolve(m).then(function(w){return r.blob&&(w instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(w))!==-1)&&typeof FileReader<"u"?new f.Promise(function(T,R){var N=new FileReader;N.onload=function(I){T(I.target.result)},N.onerror=function(I){R(I.target.error)},N.readAsArrayBuffer(w)}):w}).then(function(w){var T=n.getTypeOf(w);return T?(T==="arraybuffer"?w=n.transformTo("uint8array",w):T==="string"&&(S?w=c.decode(w):p&&v!==!0&&(w=function(R){return x(R,r.uint8array?new Uint8Array(R.length):new Array(R.length))}(w))),w):f.Promise.reject(new Error("Can't read the data of '"+u+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,i,n){var r=e("./reader/readerFor"),c=e("./utils"),o=e("./signature"),f=e("./zipEntry"),_=e("./support");function x(g){this.files=[],this.loadOptions=g}x.prototype={checkSignature:function(g){if(!this.reader.readAndCheckSignature(g)){this.reader.index-=4;var y=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+c.pretty(y)+", expected "+c.pretty(g)+")")}},isSignature:function(g,y){var h=this.reader.index;this.reader.setIndex(g);var b=this.reader.readString(4)===y;return this.reader.setIndex(h),b},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var g=this.reader.readData(this.zipCommentLength),y=_.uint8array?"uint8array":"array",h=c.transformTo(y,g);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var g,y,h,b=this.zip64EndOfCentralSize-44;0<b;)g=this.reader.readInt(2),y=this.reader.readInt(4),h=this.reader.readData(y),this.zip64ExtensibleData[g]={id:g,length:y,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var g,y;for(g=0;g<this.files.length;g++)y=this.files[g],this.reader.setIndex(y.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),y.readLocalPart(this.reader),y.handleUTF8(),y.processAttributes()},readCentralDir:function(){var g;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(g=new f({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(g);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var g=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(g<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(g);var y=g;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===c.MAX_VALUE_16BITS||this.diskWithCentralDirStart===c.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===c.MAX_VALUE_16BITS||this.centralDirRecords===c.MAX_VALUE_16BITS||this.centralDirSize===c.MAX_VALUE_32BITS||this.centralDirOffset===c.MAX_VALUE_32BITS){if(this.zip64=!0,(g=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(g),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var b=y-h;if(0<b)this.isSignature(y,o.CENTRAL_FILE_HEADER)||(this.reader.zero=b);else if(b<0)throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")},prepareReader:function(g){this.reader=r(g)},load:function(g){this.prepareReader(g),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},i.exports=x},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,i,n){var r=e("./reader/readerFor"),c=e("./utils"),o=e("./compressedObject"),f=e("./crc32"),_=e("./utf8"),x=e("./compressions"),g=e("./support");function y(h,b){this.options=h,this.loadOptions=b}y.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var b,u;if(h.skip(22),this.fileNameLength=h.readInt(2),u=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(u),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((b=function(m){for(var p in x)if(Object.prototype.hasOwnProperty.call(x,p)&&x[p].magic===m)return x[p];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+c.pretty(this.compressionMethod)+" unknown (inner file : "+c.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,b,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var b=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(b),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=r(this.extraFields[1].value);this.uncompressedSize===c.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===c.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===c.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===c.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var b,u,m,p=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<p;)b=h.readInt(2),u=h.readInt(2),m=h.readData(u),this.extraFields[b]={id:b,length:u,value:m};h.setIndex(p)},handleUTF8:function(){var h=g.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=_.utf8decode(this.fileName),this.fileCommentStr=_.utf8decode(this.fileComment);else{var b=this.findExtraFieldUnicodePath();if(b!==null)this.fileNameStr=b;else{var u=c.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(u)}var m=this.findExtraFieldUnicodeComment();if(m!==null)this.fileCommentStr=m;else{var p=c.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(p)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var b=r(h.value);return b.readInt(1)!==1||f(this.fileName)!==b.readInt(4)?null:_.utf8decode(b.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var b=r(h.value);return b.readInt(1)!==1||f(this.fileComment)!==b.readInt(4)?null:_.utf8decode(b.readData(h.length-5))}return null}},i.exports=y},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,i,n){function r(b,u,m){this.name=b,this.dir=m.dir,this.date=m.date,this.comment=m.comment,this.unixPermissions=m.unixPermissions,this.dosPermissions=m.dosPermissions,this._data=u,this._dataBinary=m.binary,this.options={compression:m.compression,compressionOptions:m.compressionOptions}}var c=e("./stream/StreamHelper"),o=e("./stream/DataWorker"),f=e("./utf8"),_=e("./compressedObject"),x=e("./stream/GenericWorker");r.prototype={internalStream:function(b){var u=null,m="string";try{if(!b)throw new Error("No output type specified.");var p=(m=b.toLowerCase())==="string"||m==="text";m!=="binarystring"&&m!=="text"||(m="string"),u=this._decompressWorker();var v=!this._dataBinary;v&&!p&&(u=u.pipe(new f.Utf8EncodeWorker)),!v&&p&&(u=u.pipe(new f.Utf8DecodeWorker))}catch(S){(u=new x("error")).error(S)}return new c(u,m,"")},async:function(b,u){return this.internalStream(b).accumulate(u)},nodeStream:function(b,u){return this.internalStream(b||"nodebuffer").toNodejsStream(u)},_compressWorker:function(b,u){if(this._data instanceof _&&this._data.compression.magic===b.magic)return this._data.getCompressedWorker();var m=this._decompressWorker();return this._dataBinary||(m=m.pipe(new f.Utf8EncodeWorker)),_.createWorkerFrom(m,b,u)},_decompressWorker:function(){return this._data instanceof _?this._data.getContentWorker():this._data instanceof x?this._data:new o(this._data)}};for(var g=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],y=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<g.length;h++)r.prototype[g[h]]=y;i.exports=r},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,i,n){(function(r){var c,o,f=r.MutationObserver||r.WebKitMutationObserver;if(f){var _=0,x=new f(b),g=r.document.createTextNode("");x.observe(g,{characterData:!0}),c=function(){g.data=_=++_%2}}else if(r.setImmediate||r.MessageChannel===void 0)c="document"in r&&"onreadystatechange"in r.document.createElement("script")?function(){var u=r.document.createElement("script");u.onreadystatechange=function(){b(),u.onreadystatechange=null,u.parentNode.removeChild(u),u=null},r.document.documentElement.appendChild(u)}:function(){setTimeout(b,0)};else{var y=new r.MessageChannel;y.port1.onmessage=b,c=function(){y.port2.postMessage(0)}}var h=[];function b(){var u,m;o=!0;for(var p=h.length;p;){for(m=h,h=[],u=-1;++u<p;)m[u]();p=h.length}o=!1}i.exports=function(u){h.push(u)!==1||o||c()}}).call(this,typeof kt<"u"?kt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,i,n){var r=e("immediate");function c(){}var o={},f=["REJECTED"],_=["FULFILLED"],x=["PENDING"];function g(p){if(typeof p!="function")throw new TypeError("resolver must be a function");this.state=x,this.queue=[],this.outcome=void 0,p!==c&&u(this,p)}function y(p,v,S){this.promise=p,typeof v=="function"&&(this.onFulfilled=v,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function h(p,v,S){r(function(){var w;try{w=v(S)}catch(T){return o.reject(p,T)}w===p?o.reject(p,new TypeError("Cannot resolve promise with itself")):o.resolve(p,w)})}function b(p){var v=p&&p.then;if(p&&(typeof p=="object"||typeof p=="function")&&typeof v=="function")return function(){v.apply(p,arguments)}}function u(p,v){var S=!1;function w(N){S||(S=!0,o.reject(p,N))}function T(N){S||(S=!0,o.resolve(p,N))}var R=m(function(){v(T,w)});R.status==="error"&&w(R.value)}function m(p,v){var S={};try{S.value=p(v),S.status="success"}catch(w){S.status="error",S.value=w}return S}(i.exports=g).prototype.finally=function(p){if(typeof p!="function")return this;var v=this.constructor;return this.then(function(S){return v.resolve(p()).then(function(){return S})},function(S){return v.resolve(p()).then(function(){throw S})})},g.prototype.catch=function(p){return this.then(null,p)},g.prototype.then=function(p,v){if(typeof p!="function"&&this.state===_||typeof v!="function"&&this.state===f)return this;var S=new this.constructor(c);return this.state!==x?h(S,this.state===_?p:v,this.outcome):this.queue.push(new y(S,p,v)),S},y.prototype.callFulfilled=function(p){o.resolve(this.promise,p)},y.prototype.otherCallFulfilled=function(p){h(this.promise,this.onFulfilled,p)},y.prototype.callRejected=function(p){o.reject(this.promise,p)},y.prototype.otherCallRejected=function(p){h(this.promise,this.onRejected,p)},o.resolve=function(p,v){var S=m(b,v);if(S.status==="error")return o.reject(p,S.value);var w=S.value;if(w)u(p,w);else{p.state=_,p.outcome=v;for(var T=-1,R=p.queue.length;++T<R;)p.queue[T].callFulfilled(v)}return p},o.reject=function(p,v){p.state=f,p.outcome=v;for(var S=-1,w=p.queue.length;++S<w;)p.queue[S].callRejected(v);return p},g.resolve=function(p){return p instanceof this?p:o.resolve(new this(c),p)},g.reject=function(p){var v=new this(c);return o.reject(v,p)},g.all=function(p){var v=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=p.length,w=!1;if(!S)return this.resolve([]);for(var T=new Array(S),R=0,N=-1,I=new this(c);++N<S;)E(p[N],N);return I;function E(D,O){v.resolve(D).then(function(k){T[O]=k,++R!==S||w||(w=!0,o.resolve(I,T))},function(k){w||(w=!0,o.reject(I,k))})}},g.race=function(p){var v=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=p.length,w=!1;if(!S)return this.resolve([]);for(var T=-1,R=new this(c);++T<S;)N=p[T],v.resolve(N).then(function(I){w||(w=!0,o.resolve(R,I))},function(I){w||(w=!0,o.reject(R,I))});var N;return R}},{immediate:36}],38:[function(e,i,n){var r={};(0,e("./lib/utils/common").assign)(r,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),i.exports=r},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,i,n){var r=e("./zlib/deflate"),c=e("./utils/common"),o=e("./utils/strings"),f=e("./zlib/messages"),_=e("./zlib/zstream"),x=Object.prototype.toString,g=0,y=-1,h=0,b=8;function u(p){if(!(this instanceof u))return new u(p);this.options=c.assign({level:y,method:b,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},p||{});var v=this.options;v.raw&&0<v.windowBits?v.windowBits=-v.windowBits:v.gzip&&0<v.windowBits&&v.windowBits<16&&(v.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _,this.strm.avail_out=0;var S=r.deflateInit2(this.strm,v.level,v.method,v.windowBits,v.memLevel,v.strategy);if(S!==g)throw new Error(f[S]);if(v.header&&r.deflateSetHeader(this.strm,v.header),v.dictionary){var w;if(w=typeof v.dictionary=="string"?o.string2buf(v.dictionary):x.call(v.dictionary)==="[object ArrayBuffer]"?new Uint8Array(v.dictionary):v.dictionary,(S=r.deflateSetDictionary(this.strm,w))!==g)throw new Error(f[S]);this._dict_set=!0}}function m(p,v){var S=new u(v);if(S.push(p,!0),S.err)throw S.msg||f[S.err];return S.result}u.prototype.push=function(p,v){var S,w,T=this.strm,R=this.options.chunkSize;if(this.ended)return!1;w=v===~~v?v:v===!0?4:0,typeof p=="string"?T.input=o.string2buf(p):x.call(p)==="[object ArrayBuffer]"?T.input=new Uint8Array(p):T.input=p,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new c.Buf8(R),T.next_out=0,T.avail_out=R),(S=r.deflate(T,w))!==1&&S!==g)return this.onEnd(S),!(this.ended=!0);T.avail_out!==0&&(T.avail_in!==0||w!==4&&w!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(c.shrinkBuf(T.output,T.next_out))):this.onData(c.shrinkBuf(T.output,T.next_out)))}while((0<T.avail_in||T.avail_out===0)&&S!==1);return w===4?(S=r.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===g):w!==2||(this.onEnd(g),!(T.avail_out=0))},u.prototype.onData=function(p){this.chunks.push(p)},u.prototype.onEnd=function(p){p===g&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=c.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg},n.Deflate=u,n.deflate=m,n.deflateRaw=function(p,v){return(v=v||{}).raw=!0,m(p,v)},n.gzip=function(p,v){return(v=v||{}).gzip=!0,m(p,v)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,i,n){var r=e("./zlib/inflate"),c=e("./utils/common"),o=e("./utils/strings"),f=e("./zlib/constants"),_=e("./zlib/messages"),x=e("./zlib/zstream"),g=e("./zlib/gzheader"),y=Object.prototype.toString;function h(u){if(!(this instanceof h))return new h(u);this.options=c.assign({chunkSize:16384,windowBits:0,to:""},u||{});var m=this.options;m.raw&&0<=m.windowBits&&m.windowBits<16&&(m.windowBits=-m.windowBits,m.windowBits===0&&(m.windowBits=-15)),!(0<=m.windowBits&&m.windowBits<16)||u&&u.windowBits||(m.windowBits+=32),15<m.windowBits&&m.windowBits<48&&!(15&m.windowBits)&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new x,this.strm.avail_out=0;var p=r.inflateInit2(this.strm,m.windowBits);if(p!==f.Z_OK)throw new Error(_[p]);this.header=new g,r.inflateGetHeader(this.strm,this.header)}function b(u,m){var p=new h(m);if(p.push(u,!0),p.err)throw p.msg||_[p.err];return p.result}h.prototype.push=function(u,m){var p,v,S,w,T,R,N=this.strm,I=this.options.chunkSize,E=this.options.dictionary,D=!1;if(this.ended)return!1;v=m===~~m?m:m===!0?f.Z_FINISH:f.Z_NO_FLUSH,typeof u=="string"?N.input=o.binstring2buf(u):y.call(u)==="[object ArrayBuffer]"?N.input=new Uint8Array(u):N.input=u,N.next_in=0,N.avail_in=N.input.length;do{if(N.avail_out===0&&(N.output=new c.Buf8(I),N.next_out=0,N.avail_out=I),(p=r.inflate(N,f.Z_NO_FLUSH))===f.Z_NEED_DICT&&E&&(R=typeof E=="string"?o.string2buf(E):y.call(E)==="[object ArrayBuffer]"?new Uint8Array(E):E,p=r.inflateSetDictionary(this.strm,R)),p===f.Z_BUF_ERROR&&D===!0&&(p=f.Z_OK,D=!1),p!==f.Z_STREAM_END&&p!==f.Z_OK)return this.onEnd(p),!(this.ended=!0);N.next_out&&(N.avail_out!==0&&p!==f.Z_STREAM_END&&(N.avail_in!==0||v!==f.Z_FINISH&&v!==f.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=o.utf8border(N.output,N.next_out),w=N.next_out-S,T=o.buf2string(N.output,S),N.next_out=w,N.avail_out=I-w,w&&c.arraySet(N.output,N.output,S,w,0),this.onData(T)):this.onData(c.shrinkBuf(N.output,N.next_out)))),N.avail_in===0&&N.avail_out===0&&(D=!0)}while((0<N.avail_in||N.avail_out===0)&&p!==f.Z_STREAM_END);return p===f.Z_STREAM_END&&(v=f.Z_FINISH),v===f.Z_FINISH?(p=r.inflateEnd(this.strm),this.onEnd(p),this.ended=!0,p===f.Z_OK):v!==f.Z_SYNC_FLUSH||(this.onEnd(f.Z_OK),!(N.avail_out=0))},h.prototype.onData=function(u){this.chunks.push(u)},h.prototype.onEnd=function(u){u===f.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=c.flattenChunks(this.chunks)),this.chunks=[],this.err=u,this.msg=this.strm.msg},n.Inflate=h,n.inflate=b,n.inflateRaw=function(u,m){return(m=m||{}).raw=!0,b(u,m)},n.ungzip=b},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,i,n){var r=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";n.assign=function(f){for(var _=Array.prototype.slice.call(arguments,1);_.length;){var x=_.shift();if(x){if(typeof x!="object")throw new TypeError(x+"must be non-object");for(var g in x)x.hasOwnProperty(g)&&(f[g]=x[g])}}return f},n.shrinkBuf=function(f,_){return f.length===_?f:f.subarray?f.subarray(0,_):(f.length=_,f)};var c={arraySet:function(f,_,x,g,y){if(_.subarray&&f.subarray)f.set(_.subarray(x,x+g),y);else for(var h=0;h<g;h++)f[y+h]=_[x+h]},flattenChunks:function(f){var _,x,g,y,h,b;for(_=g=0,x=f.length;_<x;_++)g+=f[_].length;for(b=new Uint8Array(g),_=y=0,x=f.length;_<x;_++)h=f[_],b.set(h,y),y+=h.length;return b}},o={arraySet:function(f,_,x,g,y){for(var h=0;h<g;h++)f[y+h]=_[x+h]},flattenChunks:function(f){return[].concat.apply([],f)}};n.setTyped=function(f){f?(n.Buf8=Uint8Array,n.Buf16=Uint16Array,n.Buf32=Int32Array,n.assign(n,c)):(n.Buf8=Array,n.Buf16=Array,n.Buf32=Array,n.assign(n,o))},n.setTyped(r)},{}],42:[function(e,i,n){var r=e("./common"),c=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{c=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var f=new r.Buf8(256),_=0;_<256;_++)f[_]=252<=_?6:248<=_?5:240<=_?4:224<=_?3:192<=_?2:1;function x(g,y){if(y<65537&&(g.subarray&&o||!g.subarray&&c))return String.fromCharCode.apply(null,r.shrinkBuf(g,y));for(var h="",b=0;b<y;b++)h+=String.fromCharCode(g[b]);return h}f[254]=f[254]=1,n.string2buf=function(g){var y,h,b,u,m,p=g.length,v=0;for(u=0;u<p;u++)(64512&(h=g.charCodeAt(u)))==55296&&u+1<p&&(64512&(b=g.charCodeAt(u+1)))==56320&&(h=65536+(h-55296<<10)+(b-56320),u++),v+=h<128?1:h<2048?2:h<65536?3:4;for(y=new r.Buf8(v),u=m=0;m<v;u++)(64512&(h=g.charCodeAt(u)))==55296&&u+1<p&&(64512&(b=g.charCodeAt(u+1)))==56320&&(h=65536+(h-55296<<10)+(b-56320),u++),h<128?y[m++]=h:(h<2048?y[m++]=192|h>>>6:(h<65536?y[m++]=224|h>>>12:(y[m++]=240|h>>>18,y[m++]=128|h>>>12&63),y[m++]=128|h>>>6&63),y[m++]=128|63&h);return y},n.buf2binstring=function(g){return x(g,g.length)},n.binstring2buf=function(g){for(var y=new r.Buf8(g.length),h=0,b=y.length;h<b;h++)y[h]=g.charCodeAt(h);return y},n.buf2string=function(g,y){var h,b,u,m,p=y||g.length,v=new Array(2*p);for(h=b=0;h<p;)if((u=g[h++])<128)v[b++]=u;else if(4<(m=f[u]))v[b++]=65533,h+=m-1;else{for(u&=m===2?31:m===3?15:7;1<m&&h<p;)u=u<<6|63&g[h++],m--;1<m?v[b++]=65533:u<65536?v[b++]=u:(u-=65536,v[b++]=55296|u>>10&1023,v[b++]=56320|1023&u)}return x(v,b)},n.utf8border=function(g,y){var h;for((y=y||g.length)>g.length&&(y=g.length),h=y-1;0<=h&&(192&g[h])==128;)h--;return h<0||h===0?y:h+f[g[h]]>y?h:y}},{"./common":41}],43:[function(e,i,n){i.exports=function(r,c,o,f){for(var _=65535&r|0,x=r>>>16&65535|0,g=0;o!==0;){for(o-=g=2e3<o?2e3:o;x=x+(_=_+c[f++]|0)|0,--g;);_%=65521,x%=65521}return _|x<<16|0}},{}],44:[function(e,i,n){i.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,i,n){var r=function(){for(var c,o=[],f=0;f<256;f++){c=f;for(var _=0;_<8;_++)c=1&c?3988292384^c>>>1:c>>>1;o[f]=c}return o}();i.exports=function(c,o,f,_){var x=r,g=_+f;c^=-1;for(var y=_;y<g;y++)c=c>>>8^x[255&(c^o[y])];return-1^c}},{}],46:[function(e,i,n){var r,c=e("../utils/common"),o=e("./trees"),f=e("./adler32"),_=e("./crc32"),x=e("./messages"),g=0,y=4,h=0,b=-2,u=-1,m=4,p=2,v=8,S=9,w=286,T=30,R=19,N=2*w+1,I=15,E=3,D=258,O=D+E+1,k=42,L=113,d=1,z=2,Z=3,F=4;function Q(l,G){return l.msg=x[G],G}function V(l){return(l<<1)-(4<l?9:0)}function X(l){for(var G=l.length;0<=--G;)l[G]=0}function P(l){var G=l.state,H=G.pending;H>l.avail_out&&(H=l.avail_out),H!==0&&(c.arraySet(l.output,G.pending_buf,G.pending_out,H,l.next_out),l.next_out+=H,G.pending_out+=H,l.total_out+=H,l.avail_out-=H,G.pending-=H,G.pending===0&&(G.pending_out=0))}function A(l,G){o._tr_flush_block(l,0<=l.block_start?l.block_start:-1,l.strstart-l.block_start,G),l.block_start=l.strstart,P(l.strm)}function Y(l,G){l.pending_buf[l.pending++]=G}function K(l,G){l.pending_buf[l.pending++]=G>>>8&255,l.pending_buf[l.pending++]=255&G}function W(l,G){var H,j,B=l.max_chain_length,M=l.strstart,$=l.prev_length,J=l.nice_match,U=l.strstart>l.w_size-O?l.strstart-(l.w_size-O):0,ee=l.window,ae=l.w_mask,te=l.prev,ie=l.strstart+D,he=ee[M+$-1],fe=ee[M+$];l.prev_length>=l.good_match&&(B>>=2),J>l.lookahead&&(J=l.lookahead);do if(ee[(H=G)+$]===fe&&ee[H+$-1]===he&&ee[H]===ee[M]&&ee[++H]===ee[M+1]){M+=2,H++;do;while(ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&ee[++M]===ee[++H]&&M<ie);if(j=D-(ie-M),M=ie-D,$<j){if(l.match_start=G,J<=($=j))break;he=ee[M+$-1],fe=ee[M+$]}}while((G=te[G&ae])>U&&--B!=0);return $<=l.lookahead?$:l.lookahead}function se(l){var G,H,j,B,M,$,J,U,ee,ae,te=l.w_size;do{if(B=l.window_size-l.lookahead-l.strstart,l.strstart>=te+(te-O)){for(c.arraySet(l.window,l.window,te,te,0),l.match_start-=te,l.strstart-=te,l.block_start-=te,G=H=l.hash_size;j=l.head[--G],l.head[G]=te<=j?j-te:0,--H;);for(G=H=te;j=l.prev[--G],l.prev[G]=te<=j?j-te:0,--H;);B+=te}if(l.strm.avail_in===0)break;if($=l.strm,J=l.window,U=l.strstart+l.lookahead,ee=B,ae=void 0,ae=$.avail_in,ee<ae&&(ae=ee),H=ae===0?0:($.avail_in-=ae,c.arraySet(J,$.input,$.next_in,ae,U),$.state.wrap===1?$.adler=f($.adler,J,ae,U):$.state.wrap===2&&($.adler=_($.adler,J,ae,U)),$.next_in+=ae,$.total_in+=ae,ae),l.lookahead+=H,l.lookahead+l.insert>=E)for(M=l.strstart-l.insert,l.ins_h=l.window[M],l.ins_h=(l.ins_h<<l.hash_shift^l.window[M+1])&l.hash_mask;l.insert&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[M+E-1])&l.hash_mask,l.prev[M&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=M,M++,l.insert--,!(l.lookahead+l.insert<E)););}while(l.lookahead<O&&l.strm.avail_in!==0)}function q(l,G){for(var H,j;;){if(l.lookahead<O){if(se(l),l.lookahead<O&&G===g)return d;if(l.lookahead===0)break}if(H=0,l.lookahead>=E&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+E-1])&l.hash_mask,H=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),H!==0&&l.strstart-H<=l.w_size-O&&(l.match_length=W(l,H)),l.match_length>=E)if(j=o._tr_tally(l,l.strstart-l.match_start,l.match_length-E),l.lookahead-=l.match_length,l.match_length<=l.max_lazy_match&&l.lookahead>=E){for(l.match_length--;l.strstart++,l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+E-1])&l.hash_mask,H=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart,--l.match_length!=0;);l.strstart++}else l.strstart+=l.match_length,l.match_length=0,l.ins_h=l.window[l.strstart],l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+1])&l.hash_mask;else j=o._tr_tally(l,0,l.window[l.strstart]),l.lookahead--,l.strstart++;if(j&&(A(l,!1),l.strm.avail_out===0))return d}return l.insert=l.strstart<E-1?l.strstart:E-1,G===y?(A(l,!0),l.strm.avail_out===0?Z:F):l.last_lit&&(A(l,!1),l.strm.avail_out===0)?d:z}function re(l,G){for(var H,j,B;;){if(l.lookahead<O){if(se(l),l.lookahead<O&&G===g)return d;if(l.lookahead===0)break}if(H=0,l.lookahead>=E&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+E-1])&l.hash_mask,H=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),l.prev_length=l.match_length,l.prev_match=l.match_start,l.match_length=E-1,H!==0&&l.prev_length<l.max_lazy_match&&l.strstart-H<=l.w_size-O&&(l.match_length=W(l,H),l.match_length<=5&&(l.strategy===1||l.match_length===E&&4096<l.strstart-l.match_start)&&(l.match_length=E-1)),l.prev_length>=E&&l.match_length<=l.prev_length){for(B=l.strstart+l.lookahead-E,j=o._tr_tally(l,l.strstart-1-l.prev_match,l.prev_length-E),l.lookahead-=l.prev_length-1,l.prev_length-=2;++l.strstart<=B&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+E-1])&l.hash_mask,H=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),--l.prev_length!=0;);if(l.match_available=0,l.match_length=E-1,l.strstart++,j&&(A(l,!1),l.strm.avail_out===0))return d}else if(l.match_available){if((j=o._tr_tally(l,0,l.window[l.strstart-1]))&&A(l,!1),l.strstart++,l.lookahead--,l.strm.avail_out===0)return d}else l.match_available=1,l.strstart++,l.lookahead--}return l.match_available&&(j=o._tr_tally(l,0,l.window[l.strstart-1]),l.match_available=0),l.insert=l.strstart<E-1?l.strstart:E-1,G===y?(A(l,!0),l.strm.avail_out===0?Z:F):l.last_lit&&(A(l,!1),l.strm.avail_out===0)?d:z}function le(l,G,H,j,B){this.good_length=l,this.max_lazy=G,this.nice_length=H,this.max_chain=j,this.func=B}function ce(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=v,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new c.Buf16(2*N),this.dyn_dtree=new c.Buf16(2*(2*T+1)),this.bl_tree=new c.Buf16(2*(2*R+1)),X(this.dyn_ltree),X(this.dyn_dtree),X(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new c.Buf16(I+1),this.heap=new c.Buf16(2*w+1),X(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new c.Buf16(2*w+1),X(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function de(l){var G;return l&&l.state?(l.total_in=l.total_out=0,l.data_type=p,(G=l.state).pending=0,G.pending_out=0,G.wrap<0&&(G.wrap=-G.wrap),G.status=G.wrap?k:L,l.adler=G.wrap===2?0:1,G.last_flush=g,o._tr_init(G),h):Q(l,b)}function pe(l){var G=de(l);return G===h&&function(H){H.window_size=2*H.w_size,X(H.head),H.max_lazy_match=r[H.level].max_lazy,H.good_match=r[H.level].good_length,H.nice_match=r[H.level].nice_length,H.max_chain_length=r[H.level].max_chain,H.strstart=0,H.block_start=0,H.lookahead=0,H.insert=0,H.match_length=H.prev_length=E-1,H.match_available=0,H.ins_h=0}(l.state),G}function ve(l,G,H,j,B,M){if(!l)return b;var $=1;if(G===u&&(G=6),j<0?($=0,j=-j):15<j&&($=2,j-=16),B<1||S<B||H!==v||j<8||15<j||G<0||9<G||M<0||m<M)return Q(l,b);j===8&&(j=9);var J=new ce;return(l.state=J).strm=l,J.wrap=$,J.gzhead=null,J.w_bits=j,J.w_size=1<<J.w_bits,J.w_mask=J.w_size-1,J.hash_bits=B+7,J.hash_size=1<<J.hash_bits,J.hash_mask=J.hash_size-1,J.hash_shift=~~((J.hash_bits+E-1)/E),J.window=new c.Buf8(2*J.w_size),J.head=new c.Buf16(J.hash_size),J.prev=new c.Buf16(J.w_size),J.lit_bufsize=1<<B+6,J.pending_buf_size=4*J.lit_bufsize,J.pending_buf=new c.Buf8(J.pending_buf_size),J.d_buf=1*J.lit_bufsize,J.l_buf=3*J.lit_bufsize,J.level=G,J.strategy=M,J.method=H,pe(l)}r=[new le(0,0,0,0,function(l,G){var H=65535;for(H>l.pending_buf_size-5&&(H=l.pending_buf_size-5);;){if(l.lookahead<=1){if(se(l),l.lookahead===0&&G===g)return d;if(l.lookahead===0)break}l.strstart+=l.lookahead,l.lookahead=0;var j=l.block_start+H;if((l.strstart===0||l.strstart>=j)&&(l.lookahead=l.strstart-j,l.strstart=j,A(l,!1),l.strm.avail_out===0)||l.strstart-l.block_start>=l.w_size-O&&(A(l,!1),l.strm.avail_out===0))return d}return l.insert=0,G===y?(A(l,!0),l.strm.avail_out===0?Z:F):(l.strstart>l.block_start&&(A(l,!1),l.strm.avail_out),d)}),new le(4,4,8,4,q),new le(4,5,16,8,q),new le(4,6,32,32,q),new le(4,4,16,16,re),new le(8,16,32,32,re),new le(8,16,128,128,re),new le(8,32,128,256,re),new le(32,128,258,1024,re),new le(32,258,258,4096,re)],n.deflateInit=function(l,G){return ve(l,G,v,15,8,0)},n.deflateInit2=ve,n.deflateReset=pe,n.deflateResetKeep=de,n.deflateSetHeader=function(l,G){return l&&l.state?l.state.wrap!==2?b:(l.state.gzhead=G,h):b},n.deflate=function(l,G){var H,j,B,M;if(!l||!l.state||5<G||G<0)return l?Q(l,b):b;if(j=l.state,!l.output||!l.input&&l.avail_in!==0||j.status===666&&G!==y)return Q(l,l.avail_out===0?-5:b);if(j.strm=l,H=j.last_flush,j.last_flush=G,j.status===k)if(j.wrap===2)l.adler=0,Y(j,31),Y(j,139),Y(j,8),j.gzhead?(Y(j,(j.gzhead.text?1:0)+(j.gzhead.hcrc?2:0)+(j.gzhead.extra?4:0)+(j.gzhead.name?8:0)+(j.gzhead.comment?16:0)),Y(j,255&j.gzhead.time),Y(j,j.gzhead.time>>8&255),Y(j,j.gzhead.time>>16&255),Y(j,j.gzhead.time>>24&255),Y(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),Y(j,255&j.gzhead.os),j.gzhead.extra&&j.gzhead.extra.length&&(Y(j,255&j.gzhead.extra.length),Y(j,j.gzhead.extra.length>>8&255)),j.gzhead.hcrc&&(l.adler=_(l.adler,j.pending_buf,j.pending,0)),j.gzindex=0,j.status=69):(Y(j,0),Y(j,0),Y(j,0),Y(j,0),Y(j,0),Y(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),Y(j,3),j.status=L);else{var $=v+(j.w_bits-8<<4)<<8;$|=(2<=j.strategy||j.level<2?0:j.level<6?1:j.level===6?2:3)<<6,j.strstart!==0&&($|=32),$+=31-$%31,j.status=L,K(j,$),j.strstart!==0&&(K(j,l.adler>>>16),K(j,65535&l.adler)),l.adler=1}if(j.status===69)if(j.gzhead.extra){for(B=j.pending;j.gzindex<(65535&j.gzhead.extra.length)&&(j.pending!==j.pending_buf_size||(j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),P(l),B=j.pending,j.pending!==j.pending_buf_size));)Y(j,255&j.gzhead.extra[j.gzindex]),j.gzindex++;j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),j.gzindex===j.gzhead.extra.length&&(j.gzindex=0,j.status=73)}else j.status=73;if(j.status===73)if(j.gzhead.name){B=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),P(l),B=j.pending,j.pending===j.pending_buf_size)){M=1;break}M=j.gzindex<j.gzhead.name.length?255&j.gzhead.name.charCodeAt(j.gzindex++):0,Y(j,M)}while(M!==0);j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),M===0&&(j.gzindex=0,j.status=91)}else j.status=91;if(j.status===91)if(j.gzhead.comment){B=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),P(l),B=j.pending,j.pending===j.pending_buf_size)){M=1;break}M=j.gzindex<j.gzhead.comment.length?255&j.gzhead.comment.charCodeAt(j.gzindex++):0,Y(j,M)}while(M!==0);j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),M===0&&(j.status=103)}else j.status=103;if(j.status===103&&(j.gzhead.hcrc?(j.pending+2>j.pending_buf_size&&P(l),j.pending+2<=j.pending_buf_size&&(Y(j,255&l.adler),Y(j,l.adler>>8&255),l.adler=0,j.status=L)):j.status=L),j.pending!==0){if(P(l),l.avail_out===0)return j.last_flush=-1,h}else if(l.avail_in===0&&V(G)<=V(H)&&G!==y)return Q(l,-5);if(j.status===666&&l.avail_in!==0)return Q(l,-5);if(l.avail_in!==0||j.lookahead!==0||G!==g&&j.status!==666){var J=j.strategy===2?function(U,ee){for(var ae;;){if(U.lookahead===0&&(se(U),U.lookahead===0)){if(ee===g)return d;break}if(U.match_length=0,ae=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++,ae&&(A(U,!1),U.strm.avail_out===0))return d}return U.insert=0,ee===y?(A(U,!0),U.strm.avail_out===0?Z:F):U.last_lit&&(A(U,!1),U.strm.avail_out===0)?d:z}(j,G):j.strategy===3?function(U,ee){for(var ae,te,ie,he,fe=U.window;;){if(U.lookahead<=D){if(se(U),U.lookahead<=D&&ee===g)return d;if(U.lookahead===0)break}if(U.match_length=0,U.lookahead>=E&&0<U.strstart&&(te=fe[ie=U.strstart-1])===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]){he=U.strstart+D;do;while(te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&ie<he);U.match_length=D-(he-ie),U.match_length>U.lookahead&&(U.match_length=U.lookahead)}if(U.match_length>=E?(ae=o._tr_tally(U,1,U.match_length-E),U.lookahead-=U.match_length,U.strstart+=U.match_length,U.match_length=0):(ae=o._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++),ae&&(A(U,!1),U.strm.avail_out===0))return d}return U.insert=0,ee===y?(A(U,!0),U.strm.avail_out===0?Z:F):U.last_lit&&(A(U,!1),U.strm.avail_out===0)?d:z}(j,G):r[j.level].func(j,G);if(J!==Z&&J!==F||(j.status=666),J===d||J===Z)return l.avail_out===0&&(j.last_flush=-1),h;if(J===z&&(G===1?o._tr_align(j):G!==5&&(o._tr_stored_block(j,0,0,!1),G===3&&(X(j.head),j.lookahead===0&&(j.strstart=0,j.block_start=0,j.insert=0))),P(l),l.avail_out===0))return j.last_flush=-1,h}return G!==y?h:j.wrap<=0?1:(j.wrap===2?(Y(j,255&l.adler),Y(j,l.adler>>8&255),Y(j,l.adler>>16&255),Y(j,l.adler>>24&255),Y(j,255&l.total_in),Y(j,l.total_in>>8&255),Y(j,l.total_in>>16&255),Y(j,l.total_in>>24&255)):(K(j,l.adler>>>16),K(j,65535&l.adler)),P(l),0<j.wrap&&(j.wrap=-j.wrap),j.pending!==0?h:1)},n.deflateEnd=function(l){var G;return l&&l.state?(G=l.state.status)!==k&&G!==69&&G!==73&&G!==91&&G!==103&&G!==L&&G!==666?Q(l,b):(l.state=null,G===L?Q(l,-3):h):b},n.deflateSetDictionary=function(l,G){var H,j,B,M,$,J,U,ee,ae=G.length;if(!l||!l.state||(M=(H=l.state).wrap)===2||M===1&&H.status!==k||H.lookahead)return b;for(M===1&&(l.adler=f(l.adler,G,ae,0)),H.wrap=0,ae>=H.w_size&&(M===0&&(X(H.head),H.strstart=0,H.block_start=0,H.insert=0),ee=new c.Buf8(H.w_size),c.arraySet(ee,G,ae-H.w_size,H.w_size,0),G=ee,ae=H.w_size),$=l.avail_in,J=l.next_in,U=l.input,l.avail_in=ae,l.next_in=0,l.input=G,se(H);H.lookahead>=E;){for(j=H.strstart,B=H.lookahead-(E-1);H.ins_h=(H.ins_h<<H.hash_shift^H.window[j+E-1])&H.hash_mask,H.prev[j&H.w_mask]=H.head[H.ins_h],H.head[H.ins_h]=j,j++,--B;);H.strstart=j,H.lookahead=E-1,se(H)}return H.strstart+=H.lookahead,H.block_start=H.strstart,H.insert=H.lookahead,H.lookahead=0,H.match_length=H.prev_length=E-1,H.match_available=0,l.next_in=J,l.input=U,l.avail_in=$,H.wrap=M,h},n.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,i,n){i.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,i,n){i.exports=function(r,c){var o,f,_,x,g,y,h,b,u,m,p,v,S,w,T,R,N,I,E,D,O,k,L,d,z;o=r.state,f=r.next_in,d=r.input,_=f+(r.avail_in-5),x=r.next_out,z=r.output,g=x-(c-r.avail_out),y=x+(r.avail_out-257),h=o.dmax,b=o.wsize,u=o.whave,m=o.wnext,p=o.window,v=o.hold,S=o.bits,w=o.lencode,T=o.distcode,R=(1<<o.lenbits)-1,N=(1<<o.distbits)-1;e:do{S<15&&(v+=d[f++]<<S,S+=8,v+=d[f++]<<S,S+=8),I=w[v&R];t:for(;;){if(v>>>=E=I>>>24,S-=E,(E=I>>>16&255)===0)z[x++]=65535&I;else{if(!(16&E)){if(!(64&E)){I=w[(65535&I)+(v&(1<<E)-1)];continue t}if(32&E){o.mode=12;break e}r.msg="invalid literal/length code",o.mode=30;break e}D=65535&I,(E&=15)&&(S<E&&(v+=d[f++]<<S,S+=8),D+=v&(1<<E)-1,v>>>=E,S-=E),S<15&&(v+=d[f++]<<S,S+=8,v+=d[f++]<<S,S+=8),I=T[v&N];n:for(;;){if(v>>>=E=I>>>24,S-=E,!(16&(E=I>>>16&255))){if(!(64&E)){I=T[(65535&I)+(v&(1<<E)-1)];continue n}r.msg="invalid distance code",o.mode=30;break e}if(O=65535&I,S<(E&=15)&&(v+=d[f++]<<S,(S+=8)<E&&(v+=d[f++]<<S,S+=8)),h<(O+=v&(1<<E)-1)){r.msg="invalid distance too far back",o.mode=30;break e}if(v>>>=E,S-=E,(E=x-g)<O){if(u<(E=O-E)&&o.sane){r.msg="invalid distance too far back",o.mode=30;break e}if(L=p,(k=0)===m){if(k+=b-E,E<D){for(D-=E;z[x++]=p[k++],--E;);k=x-O,L=z}}else if(m<E){if(k+=b+m-E,(E-=m)<D){for(D-=E;z[x++]=p[k++],--E;);if(k=0,m<D){for(D-=E=m;z[x++]=p[k++],--E;);k=x-O,L=z}}}else if(k+=m-E,E<D){for(D-=E;z[x++]=p[k++],--E;);k=x-O,L=z}for(;2<D;)z[x++]=L[k++],z[x++]=L[k++],z[x++]=L[k++],D-=3;D&&(z[x++]=L[k++],1<D&&(z[x++]=L[k++]))}else{for(k=x-O;z[x++]=z[k++],z[x++]=z[k++],z[x++]=z[k++],2<(D-=3););D&&(z[x++]=z[k++],1<D&&(z[x++]=z[k++]))}break}}break}}while(f<_&&x<y);f-=D=S>>3,v&=(1<<(S-=D<<3))-1,r.next_in=f,r.next_out=x,r.avail_in=f<_?_-f+5:5-(f-_),r.avail_out=x<y?y-x+257:257-(x-y),o.hold=v,o.bits=S}},{}],49:[function(e,i,n){var r=e("../utils/common"),c=e("./adler32"),o=e("./crc32"),f=e("./inffast"),_=e("./inftrees"),x=1,g=2,y=0,h=-2,b=1,u=852,m=592;function p(k){return(k>>>24&255)+(k>>>8&65280)+((65280&k)<<8)+((255&k)<<24)}function v(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(k){var L;return k&&k.state?(L=k.state,k.total_in=k.total_out=L.total=0,k.msg="",L.wrap&&(k.adler=1&L.wrap),L.mode=b,L.last=0,L.havedict=0,L.dmax=32768,L.head=null,L.hold=0,L.bits=0,L.lencode=L.lendyn=new r.Buf32(u),L.distcode=L.distdyn=new r.Buf32(m),L.sane=1,L.back=-1,y):h}function w(k){var L;return k&&k.state?((L=k.state).wsize=0,L.whave=0,L.wnext=0,S(k)):h}function T(k,L){var d,z;return k&&k.state?(z=k.state,L<0?(d=0,L=-L):(d=1+(L>>4),L<48&&(L&=15)),L&&(L<8||15<L)?h:(z.window!==null&&z.wbits!==L&&(z.window=null),z.wrap=d,z.wbits=L,w(k))):h}function R(k,L){var d,z;return k?(z=new v,(k.state=z).window=null,(d=T(k,L))!==y&&(k.state=null),d):h}var N,I,E=!0;function D(k){if(E){var L;for(N=new r.Buf32(512),I=new r.Buf32(32),L=0;L<144;)k.lens[L++]=8;for(;L<256;)k.lens[L++]=9;for(;L<280;)k.lens[L++]=7;for(;L<288;)k.lens[L++]=8;for(_(x,k.lens,0,288,N,0,k.work,{bits:9}),L=0;L<32;)k.lens[L++]=5;_(g,k.lens,0,32,I,0,k.work,{bits:5}),E=!1}k.lencode=N,k.lenbits=9,k.distcode=I,k.distbits=5}function O(k,L,d,z){var Z,F=k.state;return F.window===null&&(F.wsize=1<<F.wbits,F.wnext=0,F.whave=0,F.window=new r.Buf8(F.wsize)),z>=F.wsize?(r.arraySet(F.window,L,d-F.wsize,F.wsize,0),F.wnext=0,F.whave=F.wsize):(z<(Z=F.wsize-F.wnext)&&(Z=z),r.arraySet(F.window,L,d-z,Z,F.wnext),(z-=Z)?(r.arraySet(F.window,L,d-z,z,0),F.wnext=z,F.whave=F.wsize):(F.wnext+=Z,F.wnext===F.wsize&&(F.wnext=0),F.whave<F.wsize&&(F.whave+=Z))),0}n.inflateReset=w,n.inflateReset2=T,n.inflateResetKeep=S,n.inflateInit=function(k){return R(k,15)},n.inflateInit2=R,n.inflate=function(k,L){var d,z,Z,F,Q,V,X,P,A,Y,K,W,se,q,re,le,ce,de,pe,ve,l,G,H,j,B=0,M=new r.Buf8(4),$=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!k||!k.state||!k.output||!k.input&&k.avail_in!==0)return h;(d=k.state).mode===12&&(d.mode=13),Q=k.next_out,Z=k.output,X=k.avail_out,F=k.next_in,z=k.input,V=k.avail_in,P=d.hold,A=d.bits,Y=V,K=X,G=y;e:for(;;)switch(d.mode){case b:if(d.wrap===0){d.mode=13;break}for(;A<16;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(2&d.wrap&&P===35615){M[d.check=0]=255&P,M[1]=P>>>8&255,d.check=o(d.check,M,2,0),A=P=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&P)<<8)+(P>>8))%31){k.msg="incorrect header check",d.mode=30;break}if((15&P)!=8){k.msg="unknown compression method",d.mode=30;break}if(A-=4,l=8+(15&(P>>>=4)),d.wbits===0)d.wbits=l;else if(l>d.wbits){k.msg="invalid window size",d.mode=30;break}d.dmax=1<<l,k.adler=d.check=1,d.mode=512&P?10:12,A=P=0;break;case 2:for(;A<16;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(d.flags=P,(255&d.flags)!=8){k.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){k.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=P>>8&1),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,d.check=o(d.check,M,2,0)),A=P=0,d.mode=3;case 3:for(;A<32;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}d.head&&(d.head.time=P),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,M[2]=P>>>16&255,M[3]=P>>>24&255,d.check=o(d.check,M,4,0)),A=P=0,d.mode=4;case 4:for(;A<16;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}d.head&&(d.head.xflags=255&P,d.head.os=P>>8),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,d.check=o(d.check,M,2,0)),A=P=0,d.mode=5;case 5:if(1024&d.flags){for(;A<16;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}d.length=P,d.head&&(d.head.extra_len=P),512&d.flags&&(M[0]=255&P,M[1]=P>>>8&255,d.check=o(d.check,M,2,0)),A=P=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&(V<(W=d.length)&&(W=V),W&&(d.head&&(l=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),r.arraySet(d.head.extra,z,F,W,l)),512&d.flags&&(d.check=o(d.check,z,W,F)),V-=W,F+=W,d.length-=W),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if(V===0)break e;for(W=0;l=z[F+W++],d.head&&l&&d.length<65536&&(d.head.name+=String.fromCharCode(l)),l&&W<V;);if(512&d.flags&&(d.check=o(d.check,z,W,F)),V-=W,F+=W,l)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if(V===0)break e;for(W=0;l=z[F+W++],d.head&&l&&d.length<65536&&(d.head.comment+=String.fromCharCode(l)),l&&W<V;);if(512&d.flags&&(d.check=o(d.check,z,W,F)),V-=W,F+=W,l)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;A<16;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(P!==(65535&d.check)){k.msg="header crc mismatch",d.mode=30;break}A=P=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),k.adler=d.check=0,d.mode=12;break;case 10:for(;A<32;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}k.adler=d.check=p(P),A=P=0,d.mode=11;case 11:if(d.havedict===0)return k.next_out=Q,k.avail_out=X,k.next_in=F,k.avail_in=V,d.hold=P,d.bits=A,2;k.adler=d.check=1,d.mode=12;case 12:if(L===5||L===6)break e;case 13:if(d.last){P>>>=7&A,A-=7&A,d.mode=27;break}for(;A<3;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}switch(d.last=1&P,A-=1,3&(P>>>=1)){case 0:d.mode=14;break;case 1:if(D(d),d.mode=20,L!==6)break;P>>>=2,A-=2;break e;case 2:d.mode=17;break;case 3:k.msg="invalid block type",d.mode=30}P>>>=2,A-=2;break;case 14:for(P>>>=7&A,A-=7&A;A<32;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if((65535&P)!=(P>>>16^65535)){k.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&P,A=P=0,d.mode=15,L===6)break e;case 15:d.mode=16;case 16:if(W=d.length){if(V<W&&(W=V),X<W&&(W=X),W===0)break e;r.arraySet(Z,z,F,W,Q),V-=W,F+=W,X-=W,Q+=W,d.length-=W;break}d.mode=12;break;case 17:for(;A<14;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(d.nlen=257+(31&P),P>>>=5,A-=5,d.ndist=1+(31&P),P>>>=5,A-=5,d.ncode=4+(15&P),P>>>=4,A-=4,286<d.nlen||30<d.ndist){k.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;A<3;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}d.lens[$[d.have++]]=7&P,P>>>=3,A-=3}for(;d.have<19;)d.lens[$[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,H={bits:d.lenbits},G=_(0,d.lens,0,19,d.lencode,0,d.work,H),d.lenbits=H.bits,G){k.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;le=(B=d.lencode[P&(1<<d.lenbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=A);){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(ce<16)P>>>=re,A-=re,d.lens[d.have++]=ce;else{if(ce===16){for(j=re+2;A<j;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(P>>>=re,A-=re,d.have===0){k.msg="invalid bit length repeat",d.mode=30;break}l=d.lens[d.have-1],W=3+(3&P),P>>>=2,A-=2}else if(ce===17){for(j=re+3;A<j;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}A-=re,l=0,W=3+(7&(P>>>=re)),P>>>=3,A-=3}else{for(j=re+7;A<j;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}A-=re,l=0,W=11+(127&(P>>>=re)),P>>>=7,A-=7}if(d.have+W>d.nlen+d.ndist){k.msg="invalid bit length repeat",d.mode=30;break}for(;W--;)d.lens[d.have++]=l}}if(d.mode===30)break;if(d.lens[256]===0){k.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,H={bits:d.lenbits},G=_(x,d.lens,0,d.nlen,d.lencode,0,d.work,H),d.lenbits=H.bits,G){k.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,H={bits:d.distbits},G=_(g,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,H),d.distbits=H.bits,G){k.msg="invalid distances set",d.mode=30;break}if(d.mode=20,L===6)break e;case 20:d.mode=21;case 21:if(6<=V&&258<=X){k.next_out=Q,k.avail_out=X,k.next_in=F,k.avail_in=V,d.hold=P,d.bits=A,f(k,K),Q=k.next_out,Z=k.output,X=k.avail_out,F=k.next_in,z=k.input,V=k.avail_in,P=d.hold,A=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;le=(B=d.lencode[P&(1<<d.lenbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=A);){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(le&&!(240&le)){for(de=re,pe=le,ve=ce;le=(B=d.lencode[ve+((P&(1<<de+pe)-1)>>de)])>>>16&255,ce=65535&B,!(de+(re=B>>>24)<=A);){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}P>>>=de,A-=de,d.back+=de}if(P>>>=re,A-=re,d.back+=re,d.length=ce,le===0){d.mode=26;break}if(32&le){d.back=-1,d.mode=12;break}if(64&le){k.msg="invalid literal/length code",d.mode=30;break}d.extra=15&le,d.mode=22;case 22:if(d.extra){for(j=d.extra;A<j;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}d.length+=P&(1<<d.extra)-1,P>>>=d.extra,A-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;le=(B=d.distcode[P&(1<<d.distbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=A);){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(!(240&le)){for(de=re,pe=le,ve=ce;le=(B=d.distcode[ve+((P&(1<<de+pe)-1)>>de)])>>>16&255,ce=65535&B,!(de+(re=B>>>24)<=A);){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}P>>>=de,A-=de,d.back+=de}if(P>>>=re,A-=re,d.back+=re,64&le){k.msg="invalid distance code",d.mode=30;break}d.offset=ce,d.extra=15&le,d.mode=24;case 24:if(d.extra){for(j=d.extra;A<j;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}d.offset+=P&(1<<d.extra)-1,P>>>=d.extra,A-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){k.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(X===0)break e;if(W=K-X,d.offset>W){if((W=d.offset-W)>d.whave&&d.sane){k.msg="invalid distance too far back",d.mode=30;break}se=W>d.wnext?(W-=d.wnext,d.wsize-W):d.wnext-W,W>d.length&&(W=d.length),q=d.window}else q=Z,se=Q-d.offset,W=d.length;for(X<W&&(W=X),X-=W,d.length-=W;Z[Q++]=q[se++],--W;);d.length===0&&(d.mode=21);break;case 26:if(X===0)break e;Z[Q++]=d.length,X--,d.mode=21;break;case 27:if(d.wrap){for(;A<32;){if(V===0)break e;V--,P|=z[F++]<<A,A+=8}if(K-=X,k.total_out+=K,d.total+=K,K&&(k.adler=d.check=d.flags?o(d.check,Z,K,Q-K):c(d.check,Z,K,Q-K)),K=X,(d.flags?P:p(P))!==d.check){k.msg="incorrect data check",d.mode=30;break}A=P=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;A<32;){if(V===0)break e;V--,P+=z[F++]<<A,A+=8}if(P!==(4294967295&d.total)){k.msg="incorrect length check",d.mode=30;break}A=P=0}d.mode=29;case 29:G=1;break e;case 30:G=-3;break e;case 31:return-4;case 32:default:return h}return k.next_out=Q,k.avail_out=X,k.next_in=F,k.avail_in=V,d.hold=P,d.bits=A,(d.wsize||K!==k.avail_out&&d.mode<30&&(d.mode<27||L!==4))&&O(k,k.output,k.next_out,K-k.avail_out)?(d.mode=31,-4):(Y-=k.avail_in,K-=k.avail_out,k.total_in+=Y,k.total_out+=K,d.total+=K,d.wrap&&K&&(k.adler=d.check=d.flags?o(d.check,Z,K,k.next_out-K):c(d.check,Z,K,k.next_out-K)),k.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(Y==0&&K===0||L===4)&&G===y&&(G=-5),G)},n.inflateEnd=function(k){if(!k||!k.state)return h;var L=k.state;return L.window&&(L.window=null),k.state=null,y},n.inflateGetHeader=function(k,L){var d;return k&&k.state&&2&(d=k.state).wrap?((d.head=L).done=!1,y):h},n.inflateSetDictionary=function(k,L){var d,z=L.length;return k&&k.state?(d=k.state).wrap!==0&&d.mode!==11?h:d.mode===11&&c(1,L,z,0)!==d.check?-3:O(k,L,z,z)?(d.mode=31,-4):(d.havedict=1,y):h},n.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,i,n){var r=e("../utils/common"),c=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],f=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],_=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];i.exports=function(x,g,y,h,b,u,m,p){var v,S,w,T,R,N,I,E,D,O=p.bits,k=0,L=0,d=0,z=0,Z=0,F=0,Q=0,V=0,X=0,P=0,A=null,Y=0,K=new r.Buf16(16),W=new r.Buf16(16),se=null,q=0;for(k=0;k<=15;k++)K[k]=0;for(L=0;L<h;L++)K[g[y+L]]++;for(Z=O,z=15;1<=z&&K[z]===0;z--);if(z<Z&&(Z=z),z===0)return b[u++]=20971520,b[u++]=20971520,p.bits=1,0;for(d=1;d<z&&K[d]===0;d++);for(Z<d&&(Z=d),k=V=1;k<=15;k++)if(V<<=1,(V-=K[k])<0)return-1;if(0<V&&(x===0||z!==1))return-1;for(W[1]=0,k=1;k<15;k++)W[k+1]=W[k]+K[k];for(L=0;L<h;L++)g[y+L]!==0&&(m[W[g[y+L]]++]=L);if(N=x===0?(A=se=m,19):x===1?(A=c,Y-=257,se=o,q-=257,256):(A=f,se=_,-1),k=d,R=u,Q=L=P=0,w=-1,T=(X=1<<(F=Z))-1,x===1&&852<X||x===2&&592<X)return 1;for(;;){for(I=k-Q,D=m[L]<N?(E=0,m[L]):m[L]>N?(E=se[q+m[L]],A[Y+m[L]]):(E=96,0),v=1<<k-Q,d=S=1<<F;b[R+(P>>Q)+(S-=v)]=I<<24|E<<16|D|0,S!==0;);for(v=1<<k-1;P&v;)v>>=1;if(v!==0?(P&=v-1,P+=v):P=0,L++,--K[k]==0){if(k===z)break;k=g[y+m[L]]}if(Z<k&&(P&T)!==w){for(Q===0&&(Q=Z),R+=d,V=1<<(F=k-Q);F+Q<z&&!((V-=K[F+Q])<=0);)F++,V<<=1;if(X+=1<<F,x===1&&852<X||x===2&&592<X)return 1;b[w=P&T]=Z<<24|F<<16|R-u|0}}return P!==0&&(b[R+P]=k-Q<<24|64<<16|0),p.bits=Z,0}},{"../utils/common":41}],51:[function(e,i,n){i.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,i,n){var r=e("../utils/common"),c=0,o=1;function f(B){for(var M=B.length;0<=--M;)B[M]=0}var _=0,x=29,g=256,y=g+1+x,h=30,b=19,u=2*y+1,m=15,p=16,v=7,S=256,w=16,T=17,R=18,N=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],I=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],E=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],D=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],O=new Array(2*(y+2));f(O);var k=new Array(2*h);f(k);var L=new Array(512);f(L);var d=new Array(256);f(d);var z=new Array(x);f(z);var Z,F,Q,V=new Array(h);function X(B,M,$,J,U){this.static_tree=B,this.extra_bits=M,this.extra_base=$,this.elems=J,this.max_length=U,this.has_stree=B&&B.length}function P(B,M){this.dyn_tree=B,this.max_code=0,this.stat_desc=M}function A(B){return B<256?L[B]:L[256+(B>>>7)]}function Y(B,M){B.pending_buf[B.pending++]=255&M,B.pending_buf[B.pending++]=M>>>8&255}function K(B,M,$){B.bi_valid>p-$?(B.bi_buf|=M<<B.bi_valid&65535,Y(B,B.bi_buf),B.bi_buf=M>>p-B.bi_valid,B.bi_valid+=$-p):(B.bi_buf|=M<<B.bi_valid&65535,B.bi_valid+=$)}function W(B,M,$){K(B,$[2*M],$[2*M+1])}function se(B,M){for(var $=0;$|=1&B,B>>>=1,$<<=1,0<--M;);return $>>>1}function q(B,M,$){var J,U,ee=new Array(m+1),ae=0;for(J=1;J<=m;J++)ee[J]=ae=ae+$[J-1]<<1;for(U=0;U<=M;U++){var te=B[2*U+1];te!==0&&(B[2*U]=se(ee[te]++,te))}}function re(B){var M;for(M=0;M<y;M++)B.dyn_ltree[2*M]=0;for(M=0;M<h;M++)B.dyn_dtree[2*M]=0;for(M=0;M<b;M++)B.bl_tree[2*M]=0;B.dyn_ltree[2*S]=1,B.opt_len=B.static_len=0,B.last_lit=B.matches=0}function le(B){8<B.bi_valid?Y(B,B.bi_buf):0<B.bi_valid&&(B.pending_buf[B.pending++]=B.bi_buf),B.bi_buf=0,B.bi_valid=0}function ce(B,M,$,J){var U=2*M,ee=2*$;return B[U]<B[ee]||B[U]===B[ee]&&J[M]<=J[$]}function de(B,M,$){for(var J=B.heap[$],U=$<<1;U<=B.heap_len&&(U<B.heap_len&&ce(M,B.heap[U+1],B.heap[U],B.depth)&&U++,!ce(M,J,B.heap[U],B.depth));)B.heap[$]=B.heap[U],$=U,U<<=1;B.heap[$]=J}function pe(B,M,$){var J,U,ee,ae,te=0;if(B.last_lit!==0)for(;J=B.pending_buf[B.d_buf+2*te]<<8|B.pending_buf[B.d_buf+2*te+1],U=B.pending_buf[B.l_buf+te],te++,J===0?W(B,U,M):(W(B,(ee=d[U])+g+1,M),(ae=N[ee])!==0&&K(B,U-=z[ee],ae),W(B,ee=A(--J),$),(ae=I[ee])!==0&&K(B,J-=V[ee],ae)),te<B.last_lit;);W(B,S,M)}function ve(B,M){var $,J,U,ee=M.dyn_tree,ae=M.stat_desc.static_tree,te=M.stat_desc.has_stree,ie=M.stat_desc.elems,he=-1;for(B.heap_len=0,B.heap_max=u,$=0;$<ie;$++)ee[2*$]!==0?(B.heap[++B.heap_len]=he=$,B.depth[$]=0):ee[2*$+1]=0;for(;B.heap_len<2;)ee[2*(U=B.heap[++B.heap_len]=he<2?++he:0)]=1,B.depth[U]=0,B.opt_len--,te&&(B.static_len-=ae[2*U+1]);for(M.max_code=he,$=B.heap_len>>1;1<=$;$--)de(B,ee,$);for(U=ie;$=B.heap[1],B.heap[1]=B.heap[B.heap_len--],de(B,ee,1),J=B.heap[1],B.heap[--B.heap_max]=$,B.heap[--B.heap_max]=J,ee[2*U]=ee[2*$]+ee[2*J],B.depth[U]=(B.depth[$]>=B.depth[J]?B.depth[$]:B.depth[J])+1,ee[2*$+1]=ee[2*J+1]=U,B.heap[1]=U++,de(B,ee,1),2<=B.heap_len;);B.heap[--B.heap_max]=B.heap[1],function(fe,_e){var ye,je,Oe,ge,Te,$e,Ee=_e.dyn_tree,Ze=_e.max_code,Ke=_e.stat_desc.static_tree,ot=_e.stat_desc.has_stree,zt=_e.stat_desc.extra_bits,yt=_e.stat_desc.extra_base,qe=_e.stat_desc.max_length,Xe=0;for(ge=0;ge<=m;ge++)fe.bl_count[ge]=0;for(Ee[2*fe.heap[fe.heap_max]+1]=0,ye=fe.heap_max+1;ye<u;ye++)qe<(ge=Ee[2*Ee[2*(je=fe.heap[ye])+1]+1]+1)&&(ge=qe,Xe++),Ee[2*je+1]=ge,Ze<je||(fe.bl_count[ge]++,Te=0,yt<=je&&(Te=zt[je-yt]),$e=Ee[2*je],fe.opt_len+=$e*(ge+Te),ot&&(fe.static_len+=$e*(Ke[2*je+1]+Te)));if(Xe!==0){do{for(ge=qe-1;fe.bl_count[ge]===0;)ge--;fe.bl_count[ge]--,fe.bl_count[ge+1]+=2,fe.bl_count[qe]--,Xe-=2}while(0<Xe);for(ge=qe;ge!==0;ge--)for(je=fe.bl_count[ge];je!==0;)Ze<(Oe=fe.heap[--ye])||(Ee[2*Oe+1]!==ge&&(fe.opt_len+=(ge-Ee[2*Oe+1])*Ee[2*Oe],Ee[2*Oe+1]=ge),je--)}}(B,M),q(ee,he,B.bl_count)}function l(B,M,$){var J,U,ee=-1,ae=M[1],te=0,ie=7,he=4;for(ae===0&&(ie=138,he=3),M[2*($+1)+1]=65535,J=0;J<=$;J++)U=ae,ae=M[2*(J+1)+1],++te<ie&&U===ae||(te<he?B.bl_tree[2*U]+=te:U!==0?(U!==ee&&B.bl_tree[2*U]++,B.bl_tree[2*w]++):te<=10?B.bl_tree[2*T]++:B.bl_tree[2*R]++,ee=U,he=(te=0)===ae?(ie=138,3):U===ae?(ie=6,3):(ie=7,4))}function G(B,M,$){var J,U,ee=-1,ae=M[1],te=0,ie=7,he=4;for(ae===0&&(ie=138,he=3),J=0;J<=$;J++)if(U=ae,ae=M[2*(J+1)+1],!(++te<ie&&U===ae)){if(te<he)for(;W(B,U,B.bl_tree),--te!=0;);else U!==0?(U!==ee&&(W(B,U,B.bl_tree),te--),W(B,w,B.bl_tree),K(B,te-3,2)):te<=10?(W(B,T,B.bl_tree),K(B,te-3,3)):(W(B,R,B.bl_tree),K(B,te-11,7));ee=U,he=(te=0)===ae?(ie=138,3):U===ae?(ie=6,3):(ie=7,4)}}f(V);var H=!1;function j(B,M,$,J){K(B,(_<<1)+(J?1:0),3),function(U,ee,ae,te){le(U),te&&(Y(U,ae),Y(U,~ae)),r.arraySet(U.pending_buf,U.window,ee,ae,U.pending),U.pending+=ae}(B,M,$,!0)}n._tr_init=function(B){H||(function(){var M,$,J,U,ee,ae=new Array(m+1);for(U=J=0;U<x-1;U++)for(z[U]=J,M=0;M<1<<N[U];M++)d[J++]=U;for(d[J-1]=U,U=ee=0;U<16;U++)for(V[U]=ee,M=0;M<1<<I[U];M++)L[ee++]=U;for(ee>>=7;U<h;U++)for(V[U]=ee<<7,M=0;M<1<<I[U]-7;M++)L[256+ee++]=U;for($=0;$<=m;$++)ae[$]=0;for(M=0;M<=143;)O[2*M+1]=8,M++,ae[8]++;for(;M<=255;)O[2*M+1]=9,M++,ae[9]++;for(;M<=279;)O[2*M+1]=7,M++,ae[7]++;for(;M<=287;)O[2*M+1]=8,M++,ae[8]++;for(q(O,y+1,ae),M=0;M<h;M++)k[2*M+1]=5,k[2*M]=se(M,5);Z=new X(O,N,g+1,y,m),F=new X(k,I,0,h,m),Q=new X(new Array(0),E,0,b,v)}(),H=!0),B.l_desc=new P(B.dyn_ltree,Z),B.d_desc=new P(B.dyn_dtree,F),B.bl_desc=new P(B.bl_tree,Q),B.bi_buf=0,B.bi_valid=0,re(B)},n._tr_stored_block=j,n._tr_flush_block=function(B,M,$,J){var U,ee,ae=0;0<B.level?(B.strm.data_type===2&&(B.strm.data_type=function(te){var ie,he=4093624447;for(ie=0;ie<=31;ie++,he>>>=1)if(1&he&&te.dyn_ltree[2*ie]!==0)return c;if(te.dyn_ltree[18]!==0||te.dyn_ltree[20]!==0||te.dyn_ltree[26]!==0)return o;for(ie=32;ie<g;ie++)if(te.dyn_ltree[2*ie]!==0)return o;return c}(B)),ve(B,B.l_desc),ve(B,B.d_desc),ae=function(te){var ie;for(l(te,te.dyn_ltree,te.l_desc.max_code),l(te,te.dyn_dtree,te.d_desc.max_code),ve(te,te.bl_desc),ie=b-1;3<=ie&&te.bl_tree[2*D[ie]+1]===0;ie--);return te.opt_len+=3*(ie+1)+5+5+4,ie}(B),U=B.opt_len+3+7>>>3,(ee=B.static_len+3+7>>>3)<=U&&(U=ee)):U=ee=$+5,$+4<=U&&M!==-1?j(B,M,$,J):B.strategy===4||ee===U?(K(B,2+(J?1:0),3),pe(B,O,k)):(K(B,4+(J?1:0),3),function(te,ie,he,fe){var _e;for(K(te,ie-257,5),K(te,he-1,5),K(te,fe-4,4),_e=0;_e<fe;_e++)K(te,te.bl_tree[2*D[_e]+1],3);G(te,te.dyn_ltree,ie-1),G(te,te.dyn_dtree,he-1)}(B,B.l_desc.max_code+1,B.d_desc.max_code+1,ae+1),pe(B,B.dyn_ltree,B.dyn_dtree)),re(B),J&&le(B)},n._tr_tally=function(B,M,$){return B.pending_buf[B.d_buf+2*B.last_lit]=M>>>8&255,B.pending_buf[B.d_buf+2*B.last_lit+1]=255&M,B.pending_buf[B.l_buf+B.last_lit]=255&$,B.last_lit++,M===0?B.dyn_ltree[2*$]++:(B.matches++,M--,B.dyn_ltree[2*(d[$]+g+1)]++,B.dyn_dtree[2*A(M)]++),B.last_lit===B.lit_bufsize-1},n._tr_align=function(B){K(B,2,3),W(B,S,O),function(M){M.bi_valid===16?(Y(M,M.bi_buf),M.bi_buf=0,M.bi_valid=0):8<=M.bi_valid&&(M.pending_buf[M.pending++]=255&M.bi_buf,M.bi_buf>>=8,M.bi_valid-=8)}(B)}},{"../utils/common":41}],53:[function(e,i,n){i.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,i,n){(function(r){(function(c,o){if(!c.setImmediate){var f,_,x,g,y=1,h={},b=!1,u=c.document,m=Object.getPrototypeOf&&Object.getPrototypeOf(c);m=m&&m.setTimeout?m:c,f={}.toString.call(c.process)==="[object process]"?function(w){process.nextTick(function(){v(w)})}:function(){if(c.postMessage&&!c.importScripts){var w=!0,T=c.onmessage;return c.onmessage=function(){w=!1},c.postMessage("","*"),c.onmessage=T,w}}()?(g="setImmediate$"+Math.random()+"$",c.addEventListener?c.addEventListener("message",S,!1):c.attachEvent("onmessage",S),function(w){c.postMessage(g+w,"*")}):c.MessageChannel?((x=new MessageChannel).port1.onmessage=function(w){v(w.data)},function(w){x.port2.postMessage(w)}):u&&"onreadystatechange"in u.createElement("script")?(_=u.documentElement,function(w){var T=u.createElement("script");T.onreadystatechange=function(){v(w),T.onreadystatechange=null,_.removeChild(T),T=null},_.appendChild(T)}):function(w){setTimeout(v,0,w)},m.setImmediate=function(w){typeof w!="function"&&(w=new Function(""+w));for(var T=new Array(arguments.length-1),R=0;R<T.length;R++)T[R]=arguments[R+1];var N={callback:w,args:T};return h[y]=N,f(y),y++},m.clearImmediate=p}function p(w){delete h[w]}function v(w){if(b)setTimeout(v,0,w);else{var T=h[w];if(T){b=!0;try{(function(R){var N=R.callback,I=R.args;switch(I.length){case 0:N();break;case 1:N(I[0]);break;case 2:N(I[0],I[1]);break;case 3:N(I[0],I[1],I[2]);break;default:N.apply(o,I)}})(T)}finally{p(w),b=!1}}}}function S(w){w.source===c&&typeof w.data=="string"&&w.data.indexOf(g)===0&&v(+w.data.slice(g.length))}})(typeof self>"u"?r===void 0?this:r:self)}).call(this,typeof kt<"u"?kt:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(_r);var io=_r.exports;const Dt=qr(io),co="1.0.0";function lo(t){if(typeof t!="object"||t===null)return!1;const s=t;if(typeof s.version!="string"||typeof s.exportedAt!="number"||typeof s.pattern!="object"||s.pattern===null)return!1;const e=s.pattern;if(typeof e.id!="string"||typeof e.name!="string"||typeof e.bpm!="number"||typeof e.bars!="number"||!Array.isArray(e.grid)||!Array.isArray(e.drums))return!1;if(s.bgmConfig!==void 0){const i=s.bgmConfig;if(typeof i!="object"||typeof i.offsetMs!="number"||typeof i.volumePct!="number")return!1}if(s.bgmFile!==void 0){const i=s.bgmFile;if(!i||typeof i.id!="string"||typeof i.name!="string"||typeof i.size!="number"||typeof i.type!="string"||typeof i.data!="string"||typeof i.byteLength!="number"||i.data.length===0)return!1}return!0}async function uo(t,s){try{let e,i=s;if(s!=null&&s.fileId){const _=await vr(s.fileId);if(_){const x=await _.blob.arrayBuffer(),y=new Uint8Array(x).reduce((b,u)=>b+String.fromCharCode(u),""),h=btoa(y);e={id:_.id,name:_.name,size:_.size,type:_.type,data:h,byteLength:x.byteLength}}else i={offsetMs:s.offsetMs,volumePct:s.volumePct}}const n={version:co,exportedAt:Date.now(),pattern:t,bgmConfig:i,bgmFile:e},r=new Dt;r.file("pattern.json",JSON.stringify(n,null,2));const c=await r.generateAsync({type:"blob"}),o=URL.createObjectURL(c),f=document.createElement("a");f.href=o,f.download=`${t.name}.zip`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(o)}catch(e){throw console.error("[Pattern Backup] Export failed:",e),e}}async function fo(t){var s,e,i;try{const r=(await Dt.loadAsync(t)).file("pattern.json");if(!r)throw new Error("Invalid pattern file: missing pattern.json");const c=await r.async("string"),o=JSON.parse(c);if(!lo(o))throw new Error("Invalid backup file: data structure validation failed");const f=o;let _;if(f.bgmConfig&&!f.bgmFile)_=void 0;else if(f.bgmFile){const x=atob(f.bgmFile.data),g=new Uint8Array(x.length);for(let u=0;u<x.length;u++)g[u]=x.charCodeAt(u);let y=f.bgmFile.type;if(!y||y===""){const u=(s=f.bgmFile.name.split(".").pop())==null?void 0:s.toLowerCase();u==="mp3"?y="audio/mpeg":u==="wav"?y="audio/wav":u==="ogg"?y="audio/ogg":u==="m4a"||u==="mp4"?y="audio/mp4":y="audio/mpeg"}const{id:h,meta:b}=await yr(f.bgmFile.data,f.bgmFile.name,y);_={fileId:h,offsetMs:((e=f.bgmConfig)==null?void 0:e.offsetMs)??0,volumePct:((i=f.bgmConfig)==null?void 0:i.volumePct)??100,meta:b}}return{pattern:f.pattern,bgmConfig:_}}catch(n){throw console.error("[Pattern Backup] Import failed:",n),n}}function ho({patterns:t,currentPatternId:s,onSelectPattern:e,onSelectDraft:i,onAddPattern:n,onImportPattern:r,onImportPatternWithBgm:c,isDraftMode:o}){const[f,_]=C.useState(!1),[x,g]=C.useState(""),y=C.useRef(null),h=C.useRef(null),b=w=>{e(w)},u=async()=>{var w;(w=h.current)==null||w.click()},m=async w=>{var R;const T=(R=w.target.files)==null?void 0:R[0];if(T){if(!T.name.endsWith(".zip")){alert("Please select a valid pattern file (.zip format)");return}try{const{pattern:N,bgmConfig:I}=await fo(T),E=JSON.stringify(N);c?c(E,I):r&&r(E),console.log("Pattern imported from zip file",{bgmConfig:I})}catch(N){console.error("Failed to import pattern:",N),alert("Failed to import pattern file. Please check the console for details.")}finally{h.current&&(h.current.value="")}}},p=()=>{x.trim()&&r&&r(x.trim()),_(!1),g("")},v=()=>{_(!1),g("")};C.useEffect(()=>{f&&y.current&&y.current.focus()},[f]);const S=[...t].sort((w,T)=>w.name.localeCompare(T.name));return a.jsxs("div",{className:"pattern-tabs",children:[a.jsx("input",{ref:h,type:"file",accept:".zip",style:{display:"none"},onChange:m}),a.jsx("button",{className:`pattern-tab draft-tab ${o?"active":""}`,onClick:i,"aria-label":"Draft Pattern",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 12 12",children:a.jsx("circle",{cx:"6",cy:"6",r:"4.5",fill:"none",stroke:"currentColor",strokeWidth:"1.5"})})}),S.length>0&&a.jsx("div",{className:"pattern-tabs-content",children:S.map(w=>{const T=!o&&w.id===s;return a.jsx("button",{className:`pattern-tab ${T?"active":""}`,onClick:()=>b(w),"aria-label":`Pattern ${w.name}`,children:w.name},w.id)})}),f?a.jsxs("div",{className:"import-input-container",children:[a.jsx("input",{ref:y,type:"text",className:"import-input",value:x,onChange:w=>g(w.target.value),onKeyDown:w=>{w.key==="Enter"?p():w.key==="Escape"&&v()},onBlur:()=>{setTimeout(()=>{x.trim()||v()},150)},placeholder:"Paste..."}),a.jsx("button",{className:"action-button confirm-button",onClick:p,"aria-label":"Confirm Import",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("polyline",{points:"20 6 9 17 4 12"})})})]}):a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"action-button load-button",onClick:u,"aria-label":"Load New Pattern",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),a.jsx("button",{className:"action-button save-button",onClick:n,"aria-label":"Create New Pattern",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})}function mo({config:t,isLoading:s,isLoaded:e,error:i,onUpload:n,onOffsetChange:r,onVolumeChange:c,onDelete:o,masterVolume:f,onMasterVolumeChange:_,isPlaying:x}){var P;const g=C.useRef(null),[y,h]=C.useState(!1),[b,u]=C.useState("0"),m=A=>{const Y=Pn((t.volumePct??100)+A,0,100);c(Y)},p=A=>{const Y=Pn(f+A,0,100);_(Y)},v=A=>{const Y=(t.offsetMs??0)+A;r(Y)},S=Ne(()=>m(-10),{clickCallback:()=>m(-10)}),w=Ne(()=>m(10),{clickCallback:()=>m(10)}),T=Ne(()=>p(-10),{clickCallback:()=>p(-10)}),R=Ne(()=>p(10),{clickCallback:()=>p(10)}),N=Ne(()=>v(-100),{clickCallback:()=>v(-10)}),I=Ne(()=>v(100),{clickCallback:()=>v(10)}),E=A=>{var K;const Y=(K=A.target.files)==null?void 0:K[0];Y&&n(Y),A.target.value=""},D=(((P=t.meta)==null?void 0:P.name)??"").replace(/\.[^/.]+$/,""),O=Math.round(t.volumePct??100),k=Math.round(f),d=-(t.offsetMs??0),z=Math.abs(d)>=1e3?`${(d/1e3).toFixed(3)}s`:`${d}ms`,Z=Math.round(d).toString(),F=()=>{x||(u(Z),h(!0))},Q=()=>{const A=Number(b);if(!Number.isFinite(A)){h(!1);return}r(-A),h(!1)},V=()=>{const A=t.volumePct??100;c(A===0?100:0)},X=()=>{_(f===0?100:0)};return a.jsxs("div",{className:"bgm-controls-container",children:[a.jsxs("div",{className:"bgm-controls",children:[a.jsxs("div",{className:"bgm-controls-left",children:[t.fileId&&e&&!s?a.jsx("button",{type:"button",className:"bgm-delete-button",onClick:o,"aria-label":"Delete background music",title:"Delete background music",disabled:!t.fileId||s,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}):a.jsxs(a.Fragment,{children:[a.jsx("button",{type:"button",className:"bgm-control-button",onClick:()=>{var A;return(A=g.current)==null?void 0:A.click()},"aria-label":"Upload background music",title:"Upload background music",disabled:s,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),a.jsx("input",{ref:g,className:"bgm-file-input",type:"file",accept:"audio/mpeg",onChange:E})]}),D&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"bgm-file-name",children:D||""}),a.jsxs("div",{className:"bgm-control-group",children:[a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music volume",title:"Decrease background music volume",...S,children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("div",{className:"bgm-control-center",children:a.jsx("button",{type:"button",className:"bgm-volume-display",onClick:V,"aria-label":"Toggle BGM volume",title:"Click to toggle 0%/100%",children:a.jsxs("span",{className:"bgm-control-value",children:[O,"%"]})})}),a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music volume",title:"Increase background music volume",...w,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),a.jsxs("div",{className:"bgm-control-group",children:[a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music offset",title:"Decrease background music offset",disabled:x,...I,children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("div",{className:"bgm-control-center",children:y?a.jsx("input",{type:"number",className:"bgm-offset-input",value:b,onChange:A=>u(A.target.value),onBlur:Q,onKeyDown:A=>{A.key==="Enter"?Q():A.key==="Escape"&&h(!1)},disabled:x,autoFocus:!0}):a.jsx("button",{type:"button",className:"bgm-offset-display",onClick:F,disabled:x,children:a.jsx("span",{className:"bgm-control-value",children:z})})}),a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music offset",title:"Increase background music offset",disabled:x,...N,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})]}),a.jsx("div",{className:"bgm-controls-right",children:a.jsxs("div",{className:"bgm-control-group",children:[a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease pattern volume",title:"Decrease pattern volume",...T,children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),a.jsx("div",{className:"bgm-control-center",children:a.jsx("button",{type:"button",className:"bgm-volume-display",onClick:X,"aria-label":"Toggle pattern volume",title:"Click to toggle 0%/100%",children:a.jsxs("span",{className:"bgm-control-value",children:[k,"%"]})})}),a.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase pattern volume",title:"Increase pattern volume",...R,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})]}),i&&a.jsx("div",{className:"bgm-error",children:i})]})}function Pn(t,s,e){return Math.min(e,Math.max(s,t))}const po=393,Ln=23.0625,go=Jn,Mn=24,bo=375;function vo(){const t=C.useCallback(()=>{const i=window.innerWidth;return i<bo?Ln:(Math.min(i,go)-Mn)*Ln/(po-Mn)},[]),[s,e]=C.useState(t);return C.useEffect(()=>{const i=()=>{e(t())};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[t]),s}const yo=24,On=23.0625;function xo(t,s=2){const e=C.useCallback(()=>{if(typeof window>"u")return On;const r=window.innerWidth,c=Math.min(r,Jn)-yo,o=t*me;return o<=0||s<=0?On:c/(o*s)},[t,s]),[i,n]=C.useState(e);return C.useEffect(()=>{const r=()=>{n(e())};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[e]),i}const Sr="drummer-full-practice-mode";let pt=!1;const tn=new Set;let Dn=!1;function wo(){if(typeof window>"u")return!1;const t=localStorage.getItem(Sr);if(!t)return!1;try{const s=JSON.parse(t);return typeof s=="boolean"?s:!1}catch{return!1}}function ko(){tn.forEach(t=>t())}function _o(t){cn(),pt!==t&&(pt=t,typeof window<"u"&&localStorage.setItem(Sr,JSON.stringify(t)),ko())}function cn(){Dn||typeof window>"u"||(pt=wo(),Dn=!0)}function So(){return cn(),pt}function Bo(){_o(!pt)}function Co(t){return cn(),tn.add(t),()=>tn.delete(t)}function Br(){return C.useSyncExternalStore(Co,So,()=>!1)}const nn=960;let Pt=!1;const rn=new Set;let zn=!1;function jo(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(orientation: landscape)").matches:window.innerWidth>window.innerHeight}function Eo(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia(`(max-width: ${nn}px)`).matches:window.innerWidth<=nn}function To(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(pointer: coarse)").matches:typeof navigator<"u"?navigator.maxTouchPoints>0:!1}function ln(){return jo()&&Eo()&&To()}function Ro(){rn.forEach(t=>t())}function Cr(t){Pt!==t&&(Pt=t,Ro())}function Ct(){Cr(ln())}function jr(){var t;if(!(zn||typeof window>"u")){if(Pt=ln(),window.addEventListener("resize",Ct),window.addEventListener("orientationchange",Ct),typeof window.matchMedia=="function"){const s=window.matchMedia(`(max-width: ${nn}px) and (orientation: landscape)`);if(typeof s.addEventListener=="function")s.addEventListener("change",Ct);else{const e=s;(t=e.addListener)==null||t.call(e,Ct)}}zn=!0}}function No(){return jr(),Pt}function Io(t){return jr(),rn.add(t),Cr(ln()),()=>rn.delete(t)}function Er(){return C.useSyncExternalStore(Io,No,()=>!1)}function Fn(t){const{delay:s=500,onLongPress:e,onClick:i}=t,[n,r]=C.useState(null),c=C.useRef(null),o=C.useRef(!1),f=C.useRef(!1),_=C.useRef(0),x=C.useRef(e),g=C.useRef(i);x.current=e,g.current=i;const y=C.useCallback(()=>{o.current=!1,n&&n.classList.remove("active"),c.current&&(clearTimeout(c.current),c.current=null)},[n]),h=C.useCallback(()=>{o.current||(o.current=!0,_.current=Date.now(),f.current=!1,n&&n.classList.add("active"),c.current=setTimeout(()=>{o.current&&(f.current=!0,x.current())},s))},[s,n]),b=C.useCallback(()=>{const S=o.current,w=Date.now()-_.current,T=f.current;y(),S&&!T&&w<s&&g.current&&g.current()},[s,y]);C.useEffect(()=>{if(!n)return;const S=N=>{N.cancelable&&N.preventDefault(),h()},w=N=>{N.cancelable&&N.preventDefault(),b()},T=()=>{y()},R=N=>{N.preventDefault()};return n.addEventListener("touchstart",S,{passive:!1}),n.addEventListener("touchend",w,{passive:!1}),n.addEventListener("touchcancel",T),n.addEventListener("contextmenu",R),()=>{n.removeEventListener("touchstart",S),n.removeEventListener("touchend",w),n.removeEventListener("touchcancel",T),n.removeEventListener("contextmenu",R)}},[n,h,b,y]),C.useEffect(()=>()=>{y()},[y]);const u=C.useCallback(S=>{r(S)},[]),m=C.useCallback(S=>{S.preventDefault(),h()},[h]),p=C.useCallback(()=>{b()},[b]),v=C.useCallback(()=>{y()},[y]);return{ref:u,onMouseDown:m,onMouseUp:p,onMouseLeave:v}}async function Ao(t){if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")try{return await navigator.clipboard.writeText(t),!0}catch{console.log("navigator.clipboard.writeText failed, trying fallback")}try{return Po(t)}catch(s){return console.error("Failed to copy to clipboard:",s),!1}}function Po(t){const s=document.createElement("textarea");if(s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="2em",s.style.height="2em",s.style.padding="0",s.style.border="none",s.style.outline="none",s.style.boxShadow="none",s.style.background="transparent",s.style.opacity="0",s.style.zIndex="-1",s.style.fontSize="16px",s.value=t,document.body.appendChild(s),/iPad|iPhone|iPod/.test(navigator.userAgent)){const n=document.createRange();n.selectNodeContents(s);const r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n)),s.setSelectionRange(0,t.length)}else s.focus(),s.select();let i=!1;try{i=document.execCommand("copy")}catch(n){console.error("execCommand copy failed:",n)}return document.body.removeChild(s),i}function Lo(){var e;const t=window.isSecureContext!==void 0?window.isSecureContext:location.protocol==="https:"||location.hostname==="localhost",s=!!(navigator.clipboard&&typeof navigator.clipboard.writeText=="function");return t&&s||((e=document.queryCommandSupported)==null?void 0:e.call(document,"copy"))}function Mo(t){const[s,e]=C.useState(!1),[i,n]=C.useState(""),r=C.useRef(null);C.useEffect(()=>{s&&r.current&&(r.current.focus(),r.current.select())},[s]);const c=C.useCallback(()=>{n(t),e(!0)},[t]),o=C.useCallback(()=>{e(!1),n("")},[]),f=C.useCallback(async()=>{if(Lo())try{if(await Ao(t))return!0}catch{}return n(t),e(!0),!1},[t]);return{isExportMode:s,exportValue:i,exportInputRef:r,enterExportMode:c,cancelExport:o,tryExportToClipboard:f}}let st=null;function Oo(){st!==null&&(cancelAnimationFrame(st),st=null)}function Do(t,s,e=150,i){Oo();const n=t.scrollLeft,r=s-n,c=performance.now();function o(f){const _=f-c,x=Math.min(_/e,1),g=1-Math.pow(1-x,3);t.scrollLeft=n+r*g,x<1?st=requestAnimationFrame(o):(st=null,i==null||i())}st=requestAnimationFrame(o)}function zo({scrollContainerRef:t,currentBeat:s,cellSize:e,pattern:i,crossPatternLoop:n,isDraftMode:r,isPlaying:c}){const o=C.useRef(!1),f=C.useRef(null),_=C.useRef(null),x=C.useRef(!1),g=C.useRef(null),y=C.useRef(null),h=i.timeSignature[0],b=C.useMemo(()=>h*me,[h]),u=C.useMemo(()=>i.bars*b,[i.bars,b]),m=i.bars,p=C.useMemo(()=>e*me/8,[e]),v=C.useCallback((S,w)=>{f.current!==w&&(o.current||(o.current=!0,f.current=w,Do(S,w,150,()=>{o.current=!1})))},[]);return C.useLayoutEffect(()=>{const S=t.current;if(!S)return;const w=_.current,T=i.id;if(w!==null&&w!==T){let R=0;n&&(r?n.startPatternName==="":n.startPatternName===i.name)&&(R=n.startBar);const N=R*b*e;y.current=(R+1)*b,v(S,Math.max(0,N))}w!==T&&(g.current=null),_.current=T},[i.id,i.name,e,b,t,n,r,v]),C.useEffect(()=>{if(s===void 0||!t.current)return;if(y.current!==null){if(s>=y.current)return;y.current=null}if(s>=u)return;if(n){let I=0,E=u;const D=r?n.startPatternName==="":n.startPatternName===i.name,O=r?n.endPatternName==="":n.endPatternName===i.name;if(D&&(I=n.startBar*b),O&&(E=(n.endBar+1)*b),s<I||s>=E)return}const S=t.current,w=s*e,T=S.scrollLeft,R=T+S.clientWidth,N=Math.floor(s/b);if(c&&g.current!==null&&N!==g.current){const I=N*b*e;v(S,Math.max(0,I)),g.current=N;return}if(g.current===null&&(g.current=N),w<T){const I=N*b*e;v(S,Math.max(0,I))}else if(w+e>R-p){if(!c){const k=N*b*e;v(S,Math.max(0,k));return}let I=0,E=m-1;if(n){const k=r?n.startPatternName==="":n.startPatternName===i.name,L=r?n.endPatternName==="":n.endPatternName===i.name;k&&(I=n.startBar),L&&(E=n.endBar)}let D;N>=E?D=I:D=N+1;const O=D*b*e;v(S,Math.max(0,O))}},[s,e,c,p,v,b,u,i.name,n,r,t,m]),C.useEffect(()=>{c||(f.current=null,x.current=!1,g.current=null)},[c,i.id]),C.useEffect(()=>{const S=t.current;if(!S)return;const w=!x.current&&c;if(x.current=c,!w||s===void 0||s>=u)return;if(n){let O=0,k=u;const L=r?n.startPatternName==="":n.startPatternName===i.name,d=r?n.endPatternName==="":n.endPatternName===i.name;if(L&&(O=n.startBar*b),d&&(k=(n.endBar+1)*b),s<O||s>=k)return}const T=Math.floor(s/b),R=T*b*e,N=S.scrollLeft,I=e;if(Math.abs(N-R)<=I)return;const E=s*e,D=N+S.clientWidth;if(E+e>D-p){let O=0,k=m-1;if(n){const z=r?n.startPatternName==="":n.startPatternName===i.name,Z=r?n.endPatternName==="":n.endPatternName===i.name;z&&(O=n.startBar),Z&&(k=n.endBar)}let L;T>=k?L=O:L=T+1;const d=L*b*e;v(S,d)}else v(S,R)},[c,s,e,p,b,u,m,i.name,n,r,t,v]),{scrollContainerRef:t,doScroll:v}}const Fo=500;function Uo({pattern:t,onCellClick:s,onToggleGhost:e,onCycleThirtySecond:i,onAddBar:n,onRemoveBar:r,onClearGrid:c,onClearBar:o,crossPatternLoop:f,onCrossPatternLoopChange:_,onSave:x,onSaveCurrentPattern:g,onImportPattern:y,onImportPatternWithBgm:h,onLoadFromSlot:b,onDeletePattern:u,onStopAllPlaying:m,onSelectDraft:p,savedPatterns:v,currentBeat:S,isPlaying:w=!1,onPlayToggle:T,isDraftMode:R,onNotationDoubleClick:N,canCopyPattern:I,hasCopiedPattern:E,canPastePattern:D,onCopyPattern:O,onPastePatternBefore:k,onPastePatternAfter:L,bgmConfig:d,bgmIsLoading:z,bgmIsLoaded:Z,bgmError:F,onBgmUpload:Q,onBgmOffsetChange:V,onBgmVolumeChange:X,onBgmDelete:P,masterVolume:A,onMasterVolumeChange:Y,isCountInEnabled:K,onCountInToggle:W,onBarBpmModeToggle:se,currentBarHasOverride:q=!1}){const re=C.useRef(null),le=C.useRef(t.bars),ce=C.useRef(!1),de=C.useRef(void 0),pe=Br(),ve=Er(),l=vo(),[G]=t.timeSignature,H=xo(G,2),j=ve?H:l,{doScroll:B}=zo({scrollContainerRef:re,currentBeat:S,cellSize:j,pattern:t,crossPatternLoop:f,isDraftMode:R,isPlaying:w}),M=v.find(ye=>ye.id===t.id),$=M?xs(M):"",{isExportMode:J,exportValue:U,exportInputRef:ee,cancelExport:ae}=Mo($),te=async()=>{if(M)try{await uo(M,d),console.log("Pattern exported to zip file")}catch(ye){console.error("Failed to export pattern:",ye),alert("Failed to export pattern. Please check the console for details.")}},ie=C.useCallback(()=>{ce.current=!0,de.current=S,n(S)},[n,S]),he=C.useCallback(()=>{Bo()},[]),fe=Fn({delay:500,onLongPress:te,onClick:g}),_e=Fn({delay:Fo,onLongPress:c,onClick:()=>{S!==void 0&&o(S)}});return C.useEffect(()=>{if(!ce.current||t.bars<=le.current){ce.current=!1,le.current=t.bars;return}if(!re.current||!f){ce.current=!1,le.current=t.bars;return}if(w){ce.current=!1,le.current=t.bars;return}if(R?f.endPatternName==="":f.endPatternName===t.name){const je=re.current,[Oe]=t.timeSignature,ge=Oe*me;let Te;if(de.current!==void 0){const Ze=Math.floor(de.current/ge),Ke=de.current%ge,ot=ge/2;Ke<ot?Te=Ze:Te=Ze+1}else Te=t.bars-1;const Ee=Te*ge*j;B(je,Ee)}ce.current=!1,le.current=t.bars},[t.bars,w,R,t.name,t.timeSignature,j,B,f]),a.jsxs("div",{className:`pattern-editor${ve?" landscape-mode":""}`,children:[a.jsxs("div",{className:"pattern-editor-controls",children:[a.jsxs("div",{className:"pattern-bar-tools",children:[a.jsx(ao,{bars:t.bars,onAddBar:ie,onRemoveBar:r,canRemove:t.bars>1,currentBeat:S}),I&&a.jsx("div",{className:"pattern-copy-controls",children:E?a.jsxs(a.Fragment,{children:[a.jsx("button",{type:"button",className:"pattern-tab",onClick:k,disabled:!D,"aria-label":"Paste pattern before",title:"Paste pattern before",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 5 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),a.jsx("button",{type:"button",className:"pattern-tab",onClick:L,disabled:!D,"aria-label":"Paste pattern after",title:"Paste pattern after",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 19 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})]}):a.jsx("button",{type:"button",className:"pattern-tab",onClick:O,"aria-label":"Copy pattern grid",title:"Copy pattern grid",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),a.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})}),se&&a.jsx("button",{type:"button",className:`bar-control-button bar-bpm-button${q?" active":""}`,onClick:se,"aria-label":"Toggle bar BPM mode","aria-pressed":q,title:q?"Clear current bar BPM":"Enter bar BPM mode",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"12",cy:"12",r:"9"}),a.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),a.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})})]}),a.jsx(oo,{currentPattern:t,savedPatterns:v,crossPatternLoop:f,onCrossPatternLoopChange:_,isDraftMode:R})]}),a.jsxs("div",{className:"pattern-editor-actions",children:[a.jsx("div",{className:"pattern-editor-actions-left",children:a.jsx(ho,{patterns:v,currentPatternId:t.id,onSelectPattern:b,onSelectDraft:p,onAddPattern:x,onImportPattern:y,onImportPatternWithBgm:h,isDraftMode:R})}),a.jsxs("div",{className:"pattern-editor-actions-right",children:[a.jsx("button",{type:"button",className:`action-button count-in-toggle-button${K?" active":""}`,onClick:W,"aria-label":"Toggle count-in",title:"Toggle count-in","aria-pressed":K,children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),a.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),a.jsx("button",{type:"button",className:`action-button practice-toggle-button${pe?" active":""}`,onClick:he,"aria-label":"Toggle practice mode",title:"Toggle practice mode","aria-pressed":pe,children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M9 18V5l12-2v13"}),a.jsx("circle",{cx:"6",cy:"18",r:"3"}),a.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),!R&&v.some(ye=>ye.id===t.id)&&(J?a.jsx("input",{ref:ee,type:"text",className:"export-input",value:U,onChange:()=>{},onKeyDown:ye=>{ye.key==="Escape"&&ae()},onBlur:()=>{setTimeout(ae,150)},onFocus:ye=>{ye.target.select()},onClick:ye=>{ye.target.select()},onTouchEnd:ye=>{ye.target.select()}}):a.jsx("button",{className:"action-button save-current-button",...fe,"aria-label":"Save Pattern",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),a.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),a.jsx("polyline",{points:"7 3 7 8 15 8"})]})})),v.some(ye=>ye.id===t.id)&&a.jsx("button",{className:"action-button delete-button",onClick:()=>{m&&m(),setTimeout(()=>{window.confirm("Delete this pattern?")&&u(t.id)},0)},"aria-label":"Delete",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),a.jsx("button",{className:"action-button clear-button",..._e,"aria-label":"Clear (short press: clear current bar, long press: clear all)",children:a.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[a.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),pe&&a.jsx(mo,{config:d,isLoading:z,isLoaded:Z,error:F,onUpload:Q,onOffsetChange:V,onVolumeChange:X,masterVolume:A,onMasterVolumeChange:Y,onDelete:P,isPlaying:w}),a.jsxs("div",{className:"pattern-editor-scrollable",ref:re,children:[a.jsx(Ja,{pattern:t,cellSize:j,currentBeat:S,scrollContainerRef:re,onDoubleClick:N}),a.jsx(so,{pattern:t,cellSize:j}),!ve&&a.jsx(ro,{pattern:t,cellSize:j,onCellClick:s,onToggleGhost:e,onCellDoubleClick:i,currentBeat:S,scrollContainerRef:re})]})]})}function Un({isPlaying:t,onClick:s,onLongPress:e,variant:i="floating",fullPracticeMode:n=!1,isCountInEnabled:r=!1}){const c=C.useRef(null),o=C.useRef(!1),f=500,_=()=>{t||e&&(o.current=!1,c.current=window.setTimeout(()=>{e(),o.current=!0,c.current=null},f))},x=()=>{c.current&&(clearTimeout(c.current),c.current=null)},g=()=>{c.current&&(clearTimeout(c.current),c.current=null)},y=()=>{t||e&&(o.current=!1,c.current=window.setTimeout(()=>{e(),o.current=!0,c.current=null},f))},h=u=>{c.current&&(clearTimeout(c.current),c.current=null),o.current&&(u.preventDefault(),setTimeout(()=>{o.current=!1},100))},b=u=>{if(o.current){u.preventDefault(),u.stopPropagation(),o.current=!1;return}if((n||r)&&t&&e){s(),setTimeout(()=>{o.current=!1,e()},300);return}else s()};return a.jsx("div",{className:`bottom-play-button-container${i==="inline"?" inline":""}`,children:a.jsx("button",{className:`bottom-play-button${i==="inline"?" inline":""}${t?" playing":" paused"}`,onClick:b,onMouseDown:_,onMouseUp:x,onMouseLeave:g,onTouchStart:y,onTouchEnd:h,"aria-label":t?"Pause Pattern":"Play Pattern",children:t?a.jsx(a.Fragment,{children:n||r?a.jsx("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):a.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[a.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),a.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]})}):a.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})})})}const Wn="1.11.9",Hn="2601281531",Wo={name:"Dracula",colors:{bgColor:"#282a36",cardBg:"#44475a",bgSecondary:"#21222c",text:"#f8f8f2",textSecondary:"#acb8dd",textDim:"#596483",textTertiary:"#4e5771",border:"#434b62",primary:"#bd93f9",primaryHover:"#ff79c6",secondary:"#50fa7b",active:"#50fa7b",activeBg:"rgba(80, 250, 123, 0.2)",accentGlow:"rgba(189, 147, 249, 0.3)",danger:"#ff5555",dangerHover:"#ff6e6e",warning:"#f2f28c",warningHover:"#ffb86c",glassBg:"rgba(68, 71, 90, 0.5)",glassBgHover:"rgba(68, 71, 90, 0.7)",glassBorder:"rgba(139, 233, 253, 0.3)",overlayBg:"rgba(40, 42, 54, 0.9)",gridBorder:"rgba(139, 233, 253, 0.2)",gridCellBg:"#1a3a2a",gridCellBgAlt:"#1a3a2a94",beatLine:"#8be9fd"}},Ho={name:"One",colors:{bgColor:"#282c34",cardBg:"#21252b",bgSecondary:"#1e2227",text:"#c6cedd",textSecondary:"#8c96a8",textDim:"#6c768e",textTertiary:"#586178",border:"rgba(171, 178, 191, 0.2)",primary:"#61afef",primaryHover:"#7aa6f2",secondary:"#98c379",active:"#98c379",activeBg:"rgba(152, 195, 121, 0.2)",accentGlow:"rgba(97, 175, 239, 0.3)",danger:"#e06c75",dangerHover:"#ff6b7a",warning:"#d19a66",warningHover:"#e5c07b",glassBg:"rgba(33, 37, 43, 0.6)",glassBgHover:"rgba(33, 37, 43, 0.8)",glassBorder:"rgba(171, 178, 191, 0.2)",overlayBg:"rgba(40, 44, 52, 0.9)",gridBorder:"rgba(171, 178, 191, 0.15)",gridCellBg:"#1f252d",gridCellBgAlt:"#1b2027",beatLine:"#61afef"}},Vo={name:"Gruvbox",colors:{bgColor:"#282828",cardBg:"#3c3836",bgSecondary:"#1d2021",text:"#ebdbb2",textSecondary:"#928374",textDim:"#7c6f64",textTertiary:"#5a5047",border:"rgba(235, 219, 178, 0.2)",primary:"#fe8019",primaryHover:"#d65e0e",secondary:"#b8bb26",active:"#b8bb26",activeBg:"rgba(184, 187, 38, 0.2)",accentGlow:"rgba(254, 128, 25, 0.3)",danger:"#fb4934",dangerHover:"#cc241d",warning:"#fabd2f",warningHover:"#d79921",glassBg:"rgba(60, 56, 54, 0.6)",glassBgHover:"rgba(60, 56, 54, 0.8)",glassBorder:"rgba(235, 219, 178, 0.2)",overlayBg:"rgba(40, 40, 40, 0.9)",gridBorder:"rgba(235, 219, 178, 0.15)",gridCellBg:"#1d2021",gridCellBgAlt:"#191b1b",beatLine:"#fe8019"}},Go={name:"Monokai",colors:{bgColor:"#272822",cardBg:"#3e3d32",bgSecondary:"#1e1f1a",text:"#f8f8f2",textSecondary:"#a6a69c",textDim:"#75715e",textTertiary:"#5a594f",border:"rgba(248, 248, 242, 0.2)",primary:"#a6e22e",primaryHover:"#66d9ef",secondary:"#f92672",active:"#a6e22e",activeBg:"rgba(166, 226, 46, 0.2)",accentGlow:"rgba(249, 38, 114, 0.3)",danger:"#f92672",dangerHover:"#fe4e8e",warning:"#e6db74",warningHover:"#f1e8a0",glassBg:"rgba(62, 61, 50, 0.7)",glassBgHover:"rgba(62, 61, 50, 0.85)",glassBorder:"rgba(248, 248, 242, 0.15)",overlayBg:"rgba(39, 40, 34, 0.92)",gridBorder:"rgba(248, 248, 242, 0.12)",gridCellBg:"#2a2b26",gridCellBgAlt:"#21221e",beatLine:"#66d9ef"}},$o={name:"Campbell",colors:{bgColor:"#000",cardBg:"#1f1f1f",bgSecondary:"#080808",text:"#cccccc",textSecondary:"#a0a0a0",textDim:"#767676",textTertiary:"#5c5c5c",border:"rgba(204, 204, 204, 0.25)",primary:"#3a96dd",primaryHover:"#5cb3ff",secondary:"#13a10e",active:"#13a10e",activeBg:"rgba(19, 161, 14, 0.2)",accentGlow:"rgba(58, 150, 221, 0.3)",danger:"#c50f1f",dangerHover:"#e81123",warning:"#c19c00",warningHover:"#d9b812",glassBg:"rgba(31, 31, 31, 0.8)",glassBgHover:"rgba(31, 31, 31, 0.92)",glassBorder:"rgba(204, 204, 204, 0.15)",overlayBg:"rgba(12, 12, 12, 0.95)",gridBorder:"rgba(204, 204, 204, 0.1)",gridCellBg:"#121212",gridCellBgAlt:"#0a0a0a",beatLine:"#3a96dd"}},Zo={name:"Solarized",colors:{bgColor:"#002b36",cardBg:"#073642",bgSecondary:"#001e26",text:"#a8bdc1",textSecondary:"#657b83",textDim:"#586e75",textTertiary:"#3d4d51",border:"rgba(131, 148, 150, 0.3)",primary:"#268bd2",primaryHover:"#2aa198",secondary:"#859900",active:"#859900",activeBg:"rgba(133, 153, 0, 0.2)",accentGlow:"rgba(38, 139, 210, 0.25)",danger:"#dc322f",dangerHover:"#cb4b16",warning:"#b58900",warningHover:"#d33682",glassBg:"rgba(7, 54, 66, 0.75)",glassBgHover:"rgba(7, 54, 66, 0.88)",glassBorder:"rgba(147, 161, 161, 0.2)",overlayBg:"rgba(0, 43, 54, 0.93)",gridBorder:"rgba(147, 161, 161, 0.15)",gridCellBg:"#093e48",gridCellBgAlt:"#08343d",beatLine:"#268bd2"}},Ko={name:"Nord",colors:{bgColor:"#2e3440",cardBg:"#3b4252",bgSecondary:"#242933",text:"#d8dee9",textSecondary:"#a3be8c",textDim:"#7b88a1",textTertiary:"#4c566a",border:"rgba(216, 222, 233, 0.2)",primary:"#88c0d0",primaryHover:"#8fbcbb",secondary:"#a3be8c",active:"#a3be8c",activeBg:"rgba(163, 190, 140, 0.2)",accentGlow:"rgba(136, 192, 208, 0.25)",danger:"#bf616a",dangerHover:"#d08770",warning:"#ebcb8b",warningHover:"#eacb8b",glassBg:"rgba(59, 66, 82, 0.7)",glassBgHover:"rgba(59, 66, 82, 0.85)",glassBorder:"rgba(129, 161, 193, 0.2)",overlayBg:"rgba(46, 52, 64, 0.92)",gridBorder:"rgba(129, 161, 193, 0.15)",gridCellBg:"#353b49",gridCellBgAlt:"#313643",beatLine:"#88c0d0"}},qo={name:"Night",colors:{bgColor:"#1a1b26",cardBg:"#24283b",bgSecondary:"#16161e",text:"#c0caf5",textSecondary:"#a9b1d6",textDim:"#737aa2",textTertiary:"#565f89",border:"rgba(192, 202, 245, 0.2)",primary:"#7aa2f7",primaryHover:"#7dcfff",secondary:"#9ece6a",active:"#9ece6a",activeBg:"rgba(158, 206, 106, 0.2)",accentGlow:"rgba(122, 162, 247, 0.25)",danger:"#f7768e",dangerHover:"#db4b4b",warning:"#e0af68",warningHover:"#ff9e64",glassBg:"rgba(36, 40, 59, 0.75)",glassBgHover:"rgba(36, 40, 59, 0.88)",glassBorder:"rgba(187, 154, 247, 0.2)",overlayBg:"rgba(26, 27, 38, 0.93)",gridBorder:"rgba(169, 177, 214, 0.12)",gridCellBg:"#1f2335",gridCellBgAlt:"#1a1e2e",beatLine:"#7aa2f7"}},Yo={name:"Rose",colors:{bgColor:"#191724",cardBg:"#26233a",bgSecondary:"#131118",text:"#e0def4",textSecondary:"#c4a7e7",textDim:"#908caa",textTertiary:"#6e6a7e",border:"rgba(224, 222, 244, 0.2)",primary:"#c4a7e7",primaryHover:"#9ccfd8",secondary:"#3e8fb0",active:"#3e8fb0",activeBg:"rgba(62, 143, 176, 0.2)",accentGlow:"rgba(196, 167, 231, 0.2)",danger:"#eb6f92",dangerHover:"#f08ba3",warning:"#f6c177",warningHover:"#fad5a0",glassBg:"rgba(38, 35, 58, 0.75)",glassBgHover:"rgba(38, 35, 58, 0.88)",glassBorder:"rgba(196, 167, 231, 0.15)",overlayBg:"rgba(25, 23, 36, 0.93)",gridBorder:"rgba(156, 207, 216, 0.12)",gridCellBg:"#1f1d2e",gridCellBgAlt:"#1c1a26",beatLine:"#c4a7e7"}},Jo={name:"Yellow",colors:{bgColor:"#2b2620",cardBg:"#3a332a",bgSecondary:"#1f1b17",text:"#f2e6d4",textSecondary:"#d4c4b0",textDim:"#a89b8a",textTertiary:"#7a6f61",border:"rgba(242, 230, 212, 0.2)",primary:"#7fb3d5",primaryHover:"#5dade2",secondary:"#a5d6a7",active:"#a5d6a7",activeBg:"rgba(165, 214, 167, 0.2)",accentGlow:"rgba(127, 179, 213, 0.25)",danger:"#e67e22",dangerHover:"#f39c12",warning:"#f9d784",warningHover:"#ffe082",glassBg:"rgba(58, 51, 42, 0.75)",glassBgHover:"rgba(58, 51, 42, 0.88)",glassBorder:"rgba(242, 230, 212, 0.15)",overlayBg:"rgba(43, 38, 32, 0.93)",gridBorder:"rgba(242, 230, 212, 0.12)",gridCellBg:"#332b24",gridCellBgAlt:"#2e2720",beatLine:"#7fb3d5"}},Je=[Wo,Ho,Vo,Go,$o,Zo,Ko,qo,Yo,Jo];function Vn(t){const s=document.documentElement,e=t.colors;s.style.setProperty("--bg-color",e.bgColor),s.style.setProperty("--card-bg",e.cardBg),s.style.setProperty("--color-bg-secondary",e.bgSecondary),s.style.setProperty("--color-text",e.text),s.style.setProperty("--color-text-secondary",e.textSecondary),s.style.setProperty("--color-text-dim",e.textDim),s.style.setProperty("--color-text-tertiary",e.textTertiary),s.style.setProperty("--color-border",e.border),s.style.setProperty("--color-primary",e.primary),s.style.setProperty("--color-primary-hover",e.primaryHover),s.style.setProperty("--color-secondary",e.secondary),s.style.setProperty("--color-active",e.active),s.style.setProperty("--color-active-bg",e.activeBg),s.style.setProperty("--accent-glow",e.accentGlow),s.style.setProperty("--color-danger",e.danger),s.style.setProperty("--color-danger-hover",e.dangerHover),s.style.setProperty("--color-warning",e.warning),s.style.setProperty("--color-warning-hover",e.warningHover),s.style.setProperty("--glass-bg",e.glassBg),s.style.setProperty("--glass-bg-hover",e.glassBgHover),s.style.setProperty("--glass-border",e.glassBorder),s.style.setProperty("--overlay-bg",e.overlayBg),s.style.setProperty("--grid-border",e.gridBorder),s.style.setProperty("--grid-cell-bg",e.gridCellBg),s.style.setProperty("--grid-cell-bg-alt",e.gridCellBgAlt),s.style.setProperty("--color-beat-line",e.beatLine),s.style.setProperty("--theme-color",e.bgColor)}const Tr="drummer-theme",Xo="Dracula";function Qo(){return Je.find(s=>s.name===Xo)||Je[0]}function ei(){try{const t=localStorage.getItem(Tr);if(t){const s=Je.find(e=>e.name===t);if(s)return s}}catch(t){console.warn("Failed to load theme from localStorage:",t)}return Qo()}function ti(t){try{localStorage.setItem(Tr,t)}catch(s){console.warn("Failed to save theme to localStorage:",s)}}function ni(){const[t,s]=C.useState(()=>{const i=ei();return Vn(i),i});return{currentTheme:t,cycleTheme:()=>{const n=(Je.findIndex(c=>c.name===t.name)+1)%Je.length,r=Je[n];s(r),Vn(r),ti(r.name)},themes:Je}}const ri="1.0.0";function si(t){if(typeof t!="object"||t===null)return!1;const s=t;if(typeof s.version!="string"||typeof s.exportedAt!="number"||typeof s.localStorage!="object"||s.localStorage===null||!Array.isArray(s.bgmFiles))return!1;for(const e of s.bgmFiles)if(typeof e.id!="string"||typeof e.name!="string"||typeof e.size!="number"||typeof e.type!="string"||typeof e.data!="string"||typeof e.byteLength!="number"||e.data.length===0)return!1;return!0}function ai(){const t={};for(let s=0;s<localStorage.length;s++){const e=localStorage.key(s);if(e){const i=localStorage.getItem(e);i!==null&&(t[e]=i)}}return t}async function oi(){const t=await ba();return await Promise.all(t.map(async e=>{const i=await e.blob.arrayBuffer(),r=new Uint8Array(i).reduce((o,f)=>o+String.fromCharCode(f),""),c=btoa(r);return{id:e.id,name:e.name,size:e.size,type:e.type,data:c,byteLength:i.byteLength}}))}async function ii(){try{const t=ai(),s=await oi(),e={version:ri,exportedAt:Date.now(),localStorage:t,bgmFiles:s},i=new Dt;i.file("config.json",JSON.stringify(e,null,2));const n=await i.generateAsync({type:"blob"}),r=URL.createObjectURL(n),c=document.createElement("a");c.href=r;const o=new Date,f=o.toISOString().slice(0,10).replace(/-/g,""),_=o.toTimeString().slice(0,8).replace(/:/g,"");c.download=`drummer-config-${f}-${_}.zip`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}catch(t){throw console.error("[Config Backup] Export failed:",t),t}}function ci(t){localStorage.clear();for(const[s,e]of Object.entries(t))localStorage.setItem(s,e)}async function li(t){var e;await va();const s=new Map;for(const i of t){let n=i.type;if(!n||n===""){const c=(e=i.name.split(".").pop())==null?void 0:e.toLowerCase();c==="mp3"?n="audio/mpeg":c==="wav"?n="audio/wav":c==="ogg"?n="audio/ogg":c==="m4a"||c==="mp4"?n="audio/mp4":n="audio/mpeg"}const{id:r}=await yr(i.data,i.name,n);s.set(i.id,r)}return s}function ui(t){const s="drummer-bgm-config",e=localStorage.getItem(s);if(e)try{const i=JSON.parse(e);let n=!1;for(const r of Object.values(i))r.fileId&&t.has(r.fileId)&&(r.fileId=t.get(r.fileId),n=!0);n&&localStorage.setItem(s,JSON.stringify(i))}catch{}}async function di(t){try{const e=(await Dt.loadAsync(t)).file("config.json");if(!e)throw new Error("Invalid configuration file: missing config.json");const i=await e.async("string"),n=JSON.parse(i);if(!si(n))throw new Error("Invalid backup file: data structure validation failed");const r=n;ci(r.localStorage);const c=await li(r.bgmFiles);ui(c),window.location.reload()}catch(s){throw console.error("[Config Backup] Import failed:",s),s}}function fi(){const[t,s]=C.useState(!1),[e,i]=C.useState(!1),[n,r]=C.useState("idle"),[c,o]=C.useState(!1),[f,_]=C.useState(!1),x=C.useRef(null),g=C.useRef(null),y=C.useRef(null),{currentTheme:h,cycleTheme:b}=ni(),u=C.useCallback(()=>{f||(g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{s(!1),localStorage.getItem("drummer-first-shown")||(i(!0),localStorage.setItem("drummer-first-shown","true"),y.current=setTimeout(()=>{i(!1)},1e4))},1e4))},[f]);C.useEffect(()=>()=>{g.current&&clearTimeout(g.current),y.current&&clearTimeout(y.current)},[]),C.useEffect(()=>{localStorage.getItem("drummer-visited")||(s(!0),localStorage.setItem("drummer-visited","true"))},[]),C.useEffect(()=>{const R=()=>{s(!0),i(!1)};return window.addEventListener("show-version",R),()=>{window.removeEventListener("show-version",R)}},[]),C.useEffect(()=>{if(!t){g.current&&(clearTimeout(g.current),g.current=null);return}u();const R=["mousemove","mousedown","touchstart","touchmove","keydown","click"],N=()=>{u()};return R.forEach(I=>{window.addEventListener(I,N)}),()=>{R.forEach(I=>{window.removeEventListener(I,N)}),g.current&&clearTimeout(g.current)}},[t,u]);const m=async()=>{var R,N,I;console.log("[Refresh] === handleRefresh started ==="),console.log("[Refresh] Current version:",Wn,"Build time:",Hn),console.log("[Refresh] Set status: checking"),r("checking");try{if(!("serviceWorker"in navigator)){console.log("[Refresh] ❌ Browser doesn't support ServiceWorker, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Browser supports ServiceWorker"),console.log("[Refresh] Getting ServiceWorker registration...");const E=await navigator.serviceWorker.getRegistration();if(!E){console.log("[Refresh] ❌ No registration found, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Got registration:",{scope:E.scope,active:(R=E.active)==null?void 0:R.state,waiting:(N=E.waiting)==null?void 0:N.state,installing:(I=E.installing)==null?void 0:I.state});const D=()=>{console.log("[Refresh] 🔄 controllerchange event triggered! Reloading page..."),window.location.reload()};if(navigator.serviceWorker.addEventListener("controllerchange",D,{once:!0}),console.log("[Refresh] ✓ Added controllerchange listener"),E.waiting){console.log("[Refresh] ⚡ Found waiting worker, activating directly"),console.log("[Refresh] waiting worker state:",E.waiting.state),r("activating"),console.log("[Refresh] Sending SKIP_WAITING message to waiting worker"),E.waiting.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] No waiting worker currently"),console.log("[Refresh] Set 10 second timeout");const O=setTimeout(()=>{console.log("[Refresh] ⏰ 10s timeout! Removing listener and reloading page"),navigator.serviceWorker.removeEventListener("controllerchange",D),window.location.reload()},1e4),k=()=>{console.log("[Refresh] 🎉 updatefound event triggered! New SW started installing"),r("downloading");const z=E.installing;if(!z){console.log("[Refresh] ❌ updatefound triggered but installing is null");return}console.log("[Refresh] New worker initial state:",z.state),z.addEventListener("statechange",()=>{console.log("[Refresh] New worker state changed:",z.state),z.state==="installing"&&(console.log("[Refresh] Set status: installing"),r("installing")),z.state==="installed"&&(console.log("[Refresh] New worker installation complete, set status: activating"),r("activating"),clearTimeout(O),console.log("[Refresh] Cleared timeout timer"),console.log("[Refresh] Sending SKIP_WAITING message to new worker"),z.postMessage({type:"SKIP_WAITING"}))})};E.addEventListener("updatefound",k,{once:!0}),console.log("[Refresh] ✓ Added updatefound listener"),console.log("[Refresh] Calling registration.update() to check for updates...");try{await E.update(),console.log("[Refresh] ✓ registration.update() completed")}catch(z){console.warn("[Refresh] ⚠️ Update check failed:",z)}const L=E.waiting;if(console.log("[Refresh] After update(), checking waiting:",(L==null?void 0:L.state)||"null"),L){console.log("[Refresh] ⚡ Found waiting worker after update(), activating directly"),r("activating"),clearTimeout(O),console.log("[Refresh] Sending SKIP_WAITING message"),L.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] Set 5 second no-update detection timer");const d=setTimeout(()=>{var z,Z;console.log("[Refresh] ⏰ 5s check: checking for updates..."),console.log("[Refresh] installing:",((z=E.installing)==null?void 0:z.state)||"null"),console.log("[Refresh] waiting:",((Z=E.waiting)==null?void 0:Z.state)||"null"),!E.installing&&!E.waiting?(console.log("[Refresh] 📌 Confirmed no update, set status: no-update"),r("no-update"),clearTimeout(O),navigator.serviceWorker.removeEventListener("controllerchange",D),console.log("[Refresh] Reloading page in 1 second..."),setTimeout(()=>{console.log("[Refresh] 🔄 Executing page reload"),window.location.reload()},1e3)):console.log("[Refresh] Found installing or waiting, continuing to wait")},5e3);E.addEventListener("updatefound",()=>{console.log("[Refresh] updatefound triggered, clearing no-update detection timer"),clearTimeout(d)},{once:!0}),console.log("[Refresh] === handleRefresh initialization complete, waiting for events ===")}catch(E){console.error("[Refresh] ❌ Exception:",E),console.log("[Refresh] Reloading page due to exception"),window.location.reload()}},p=()=>{switch(n){case"checking":return"Checking...";case"downloading":return"Downloading...";case"installing":return"Installing...";case"activating":return"Activating...";case"no-update":return"Latest version";default:return`v${Wn} - ${Hn}`}},v=async()=>{if(!c)try{o(!0),await ii()}catch(R){console.error("[Settings] Export failed:",R),alert("Failed to export configuration. Please check the console for details.")}finally{o(!1)}},S=()=>{var R;(R=x.current)==null||R.click()},w=async R=>{var I;const N=(I=R.target.files)==null?void 0:I[0];if(N){if(!N.name.endsWith(".zip")){alert("Please select a valid configuration file (.zip format)");return}try{await di(N)}catch(E){console.error("[Settings] Import failed:",E),alert("Failed to import configuration. Please check the console for details.")}finally{x.current&&(x.current.value="")}}},T=n!=="idle";return a.jsxs(a.Fragment,{children:[e&&a.jsx("div",{className:"settings-first-hint visible",children:"Tap 5 times quickly to show settings"}),a.jsxs("div",{className:`settings ${t?"visible":"hidden"}`,children:[a.jsxs("div",{className:"settings-theme",onClick:b,children:[a.jsx("button",{type:"button",className:"settings-theme-button",title:`Current theme: ${h.name}. Click to cycle theme.`,children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),a.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),a.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),a.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),a.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),h.name]}),a.jsxs("div",{className:"settings-config",children:[a.jsx("input",{ref:x,type:"file",accept:".zip",style:{display:"none"},onChange:w}),a.jsx("button",{type:"button",className:"settings-config-button",onClick:S,title:"Load settings from a zip file",children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"17 8 12 3 7 8"}),a.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})}),a.jsx("button",{type:"button",className:`settings-config-button ${c?"exporting":""}`,onClick:v,title:"Export all settings to a zip file",disabled:c,children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"7 10 12 15 17 10"}),a.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),a.jsx("button",{type:"button",className:"settings-config-button",onClick:()=>_(!0),title:"About",children:a.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),a.jsx("circle",{cx:"12",cy:"12",r:"3"})]})})]})]}),f&&a.jsx("div",{className:"settings-modal-mask",onClick:()=>_(!1),children:a.jsxs("div",{className:"settings-modal",onClick:R=>R.stopPropagation(),children:[a.jsxs("div",{className:"settings-modal-header",children:[a.jsx("h2",{children:"Drummer - Beat Maker"}),a.jsx("button",{type:"button",className:"settings-modal-close",onClick:()=>_(!1),children:a.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),a.jsxs("div",{className:"settings-modal-content",children:[a.jsx("h3",{className:"settings-modal-subtitle",children:"Features & Usage"}),a.jsx("p",{className:"settings-modal-description",children:"A step-by-step guide for first-time users. Read top to bottom to learn the full workflow and discover hidden gestures."}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Top Bar: Metronome and Tempo"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Beat dots"}),": click to cycle time signatures (4/4, 3/4, 2/4, 6/8, 5/4, 7/8)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Tempo"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click for 0.5 BPM steps, press and hold to keep changing."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"BPM number"}),": tap the left/right side of the digits to cycle speed rates (a rate label appears)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Play"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": start or stop playback. Long-press to reset the loop counter to 0."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Patterns, Bars, and Loop Range"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Tabs"}),": the circle is Draft; letter tabs are saved patterns. Click a tab to load it."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"New pattern"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": save the current draft as a new pattern tab."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Import pattern"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),": load a pattern zip file."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Bars"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": remove or add a bar (uses your cursor position when possible)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Loop range"}),": choose start/end pattern and bar; press and hold the +/- buttons to move faster."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Per-bar BPM"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"12",cy:"12",r:"9"}),a.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),a.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})}),": click to set or clear BPM for the current bar."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Copy/Paste"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),a.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})," ","then"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 5 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("polyline",{points:"12 5 19 12 12 19"}),a.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),": duplicate a whole pattern grid before or after."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Grid Editor and Notation"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Single click/tap"}),": toggle a cell on or off."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Double-click/tap"}),": cycle 32nd-note states (double, first, second, back to normal)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Long-press on an active cell"}),": cycle note type (normal to ghost to grace) when supported."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Notation view"}),": double-click/tap to jump the playhead (disabled when a rate label is active)."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Action Buttons (Right Side)"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Count-in"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),a.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),": toggle a one-bar count-in before playback."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Practice mode"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M9 18V5l12-2v13"}),a.jsx("circle",{cx:"6",cy:"18",r:"3"}),a.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),": show background music and volume controls."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Play (bottom)"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:a.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": tap to play/pause. Long-press to stop and jump to the loop start."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Save current"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),a.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),a.jsx("polyline",{points:"7 3 7 8 15 8"})]})}),": save edits to the current pattern. Long-press to export a pattern zip (includes BGM)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Delete"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),": remove the current pattern."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Clear"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[a.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),a.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),": short press clears the current bar, long-press clears all bars."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Background Music (Practice Mode)"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Upload"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12 3v12"}),a.jsx("polyline",{points:"8 7 12 3 16 7"}),a.jsx("path",{d:"M4 21h16v0"})]})}),": add an MP3 file, or"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[a.jsx("polyline",{points:"3 6 5 6 21 6"}),a.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})})," ","to delete it."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Volume"})," ",a.jsx("span",{className:"settings-icon",children:a.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),a.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click or press-and-hold to adjust. Click the % number to mute/unmute."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Offset"}),": click the ms/s value to type an exact offset (disabled while playing)."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Pattern volume"}),": the right-side controls adjust drum volume (same +/- and mute behavior)."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Settings and About"}),a.jsxs("ul",{children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Theme"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),a.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),a.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),a.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),a.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),": click to cycle themes."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Backup and Restore"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"17 8 12 3 7 8"}),a.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})})," ","/"," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),a.jsx("polyline",{points:"7 10 12 15 17 10"}),a.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),": import or export all settings as a zip file."]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Settings"})," ",a.jsx("span",{className:"settings-icon",children:a.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[a.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),a.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}),": open this."]})]})]}),a.jsxs("div",{className:"settings-modal-section",children:[a.jsx("h3",{children:"Other Settings"}),a.jsx("p",{className:"settings-modal-placeholder",children:"More feature toggles will appear here."})]})]}),a.jsx("div",{className:`settings-modal-version ${T?"updating":""}`,onClick:m,children:p()},`version-${n}`)]})})]})}let Rt=null;async function hi(){if("wakeLock"in navigator)try{Rt=await navigator.wakeLock.request("screen")}catch{}}async function Gn(){if(Rt!==null)try{await Rt.release(),Rt=null}catch{}}let $n=0;const mi=16;function ut(t,s,e){const i=Math.max(0,e);setTimeout(()=>{Date.now()-$n>=mi?requestAnimationFrame(()=>{$n=Date.now(),s(t)}):s(t)},i)}function pi({currentPattern:t,savedPatterns:s,crossPatternLoop:e,isPlaying:i,isDraftMode:n,playbackRate:r=1,onSubdivisionChange:c,onPatternChange:o,onPlayStart:f}){const _=C.useRef(0),x=C.useRef(.2),g=C.useRef(50),y=C.useRef(null),h=C.useRef(!1),b=C.useRef(0),u=C.useRef(0),m=C.useRef([]),p=C.useRef(c),v=C.useRef(o),S=C.useRef(f),w=C.useRef(t),T=C.useRef(n);p.current=c,v.current=o,S.current=f,w.current=t,T.current=n;const R=C.useRef(r);R.current=r;const N=C.useCallback((Z,F)=>{let Q=Z.bpm;if(F!==void 0&&Z.barBpmOverrides){const[P]=Z.timeSignature,A=P*me,Y=Math.floor(F/A);Q=Z.barBpmOverrides[Y]??Z.bpm}return 60/(Q*R.current)*(4/Z.timeSignature[1])/me},[]),I=C.useCallback(Z=>{const[F]=Z.timeSignature;return F*me},[]),E=C.useCallback(Z=>{const F=m.current;if(F.length===0)return;let Q=-1,V=Z;for(let A=0;A<F.length;A++){const Y=F[A],K=I(Y.pattern),W=Y.startBar*K,se=(Y.endBar+1)*K;if(Z>=W&&Z<se){Q=A,V=Z;break}}if(Q===-1){Q=0;const A=F[0],Y=I(A.pattern);V=A.startBar*Y}if(b.current=Q,u.current=V,h.current){const A=Be();_.current=A.currentTime}const X=p.current;X&&ut(V,X,0);const P=v.current;if(P){const A=F[Q];P(A.patternName)}},[I]),D=C.useCallback(()=>{const Z=[];if(!e)return Z.push({patternName:n?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),Z;const{startPatternName:F,startBar:Q,endPatternName:V,endBar:X}=e,P=[...s].sort((W,se)=>W.name.localeCompare(se.name)),A=n?[{name:"",pattern:t},...P.map(W=>({name:W.name,pattern:W}))]:P.map(W=>W.id===t.id?{name:W.name,pattern:t}:{name:W.name,pattern:W}),Y=A.findIndex(W=>W.name===F),K=A.findIndex(W=>W.name===V);if(Y===-1||K===-1)return Z.push({patternName:n?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),Z;for(let W=Y;W<=K;W++){const{name:se,pattern:q}=A[W],re=W===Y?Q:0,le=W===K?X:q.bars-1;Z.push({patternName:se,pattern:q,startBar:re,endBar:le})}return Z},[t,s,e,n]);C.useEffect(()=>{m.current=D()},[D]);const O=C.useCallback((Z,F,Q)=>{const V=N(Z,F),X=V/2,P=(A,Y,K)=>{switch(aa(K),A){case"Kick":ur(Y);break;case"Snare":en(Y);break;case"Hi-Hat Closed":dr(Y);break;case"Hi-Hat Open":fr(Y);break;case"Crash 1":It(Y,1.2);break;case"Crash 2":It(Y,1);break;case"Ride":hr(Y);break;case"Tom 1":rt(Y,250);break;case"Tom 2":rt(Y,200);break;case"Tom 3":rt(Y,150);break}oa()};Z.grid.forEach((A,Y)=>{const K=A[F];if(K===Ce)return;const W=Z.drums[Y],se=Q;if(K===Ve){const re=se-V*.125;P(W,re,.5),P(W,se,1);return}if(K===Me||K===Fe||K===Ue){(K===Me||K===Fe)&&P(W,se,1),(K===Me||K===Ue)&&P(W,se+X,1);return}P(W,se,K===Pe?.3:1)})},[N]),k=C.useCallback(()=>{const Z=Be();if(!h.current)return;const F=Z.currentTime,Q=m.current;if(Q.length!==0)for(;_.current<F+x.current;){let V=b.current,X=u.current;if(V<0||V>=Q.length){V=0;const re=Q[0],le=I(re.pattern);X=re.startBar*le,b.current=0,u.current=X;const ce=v.current;ce&&ce(re.patternName),_.current<F&&(_.current=F);continue}const P=Q[V],A=I(P.pattern),Y=P.startBar*A,K=(P.endBar+1)*A;if(X>=K){if(b.current=V+1,V+1<Q.length){const re=Q[V+1],le=I(re.pattern);u.current=re.startBar*le;const ce=v.current;ce&&ce(re.patternName)}continue}X<Y&&(X=Y,u.current=Y);const W=Math.max(_.current,F),se=(W-F)*1e3;if(O(P.pattern,X,W),h.current){const re=p.current;re&&ut(X,re,se)}u.current=X+1;const q=N(P.pattern,X);_.current+=q}},[O,N,I]),L=C.useCallback(async()=>{const Z=Be();if(h.current)return;Z.state==="suspended"&&await Z.resume(),await new Promise(Y=>requestAnimationFrame(Y)),hi(),h.current=!0;const F=Z.currentTime,Q=m.current;if(Q.length===0)return;const V=S.current;V&&V(F);let X=!0;const P=b.current,A=u.current;if(P>=0&&P<Q.length){const Y=Q[P],K=I(Y.pattern),W=Y.startBar*K,se=(Y.endBar+1)*K,q=A>=W&&A<se,re=Y.pattern.id===w.current.id;q&&re&&(X=!1)}if(X){const Y=w.current.id;let K=Q.findIndex(ce=>ce.pattern.id===Y);if(K===-1){const ce=T.current?"":w.current.name;K=Q.findIndex(de=>de.patternName===ce)}K===-1&&(K=0);const W=Q[K],se=I(W.pattern),q=W.startBar*se;b.current=K,u.current=q;const re=v.current;re&&re(W.patternName);const le=p.current;le&&ut(q,le,0)}else{const Y=p.current;Y&&ut(A,Y,0)}_.current=F,k(),y.current=window.setInterval(k,g.current)},[k,I]),d=C.useCallback(()=>{h.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),Gn()},[]);C.useEffect(()=>(i?L():d(),()=>{d()}),[i,L,d]);const z=C.useCallback(()=>{const Z=m.current;if(Z.length===0)return;h.current&&(h.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),Gn());const F=Z[0],Q=I(F.pattern),V=F.startBar*Q;b.current=0,u.current=V;const X=p.current;X&&ut(V,X,0);const P=v.current;P&&P(F.patternName)},[I]);return{seekTo:E,resetToRangeStart:z}}function gi(){const{isLoading:t,loadingProgress:s,showProgress:e}=la(),{isMetronomePlaying:i,isPatternPlaying:n,toggleMetronomePlay:r,togglePatternPlay:c,stopAll:o,setIsMetronomePlaying:f,setIsPatternPlaying:_}=ha(),x=Br(),g=Er(),[y,h]=C.useState(0),[b,u]=C.useState([]),[m,p]=C.useState(!0),v=C.useRef(null),S=C.useRef(null),[w,T]=C.useState(0),[R,N]=C.useState(()=>kn()??dt),[I,E]=C.useState(Yt),[D,O]=C.useState(0),[k,L]=C.useState(!1),[d,z]=C.useState(!1),[Z,F]=C.useState(0),[Q,V]=C.useState(0),X=C.useRef(null),[P,A]=C.useState(null),[Y,K]=C.useState(!1),[W,se]=C.useState(()=>vs()??{startPatternName:"",startBar:0,endPatternName:"",endBar:Nt-1}),{pattern:q,updateBPM:re,updateBarBpm:le,toggleCell:ce,toggleGhost:de,cycleThirtySecond:pe,addBar:ve,removeBar:l,clearGrid:G,clearBar:H,insertPatternGrid:j,loadPattern:B,resetPattern:M}=ks(nr()),[$,J]=C.useState(()=>ct(q.id)),[U,ee]=C.useState({isLoading:!1,error:null}),[ae,te]=C.useState(()=>ya()),ie=it(D),he=()=>{X.current&&(clearTimeout(X.current),X.current=null),d&&z(!1)};C.useEffect(()=>()=>{X.current&&clearTimeout(X.current)},[]);const fe=(ne,oe=!0)=>{var ue;if(y!==void 0){const[be]=q.timeSignature,xe=be*me,we=Math.floor(y/xe),He=((ue=q.barBpmOverrides)==null?void 0:ue[we])!==void 0;if(Y||He){oe&&le(we,ne),N(ne);return}}N(ne),oe&&(ze(ne),re(ne))},_e=ne=>{E(ne)},ye=()=>{var xe;if(y===void 0)return;const[ne]=q.timeSignature,oe=ne*me,ue=Math.floor(y/oe);((xe=q.barBpmOverrides)==null?void 0:xe[ue])!==void 0?(le(ue,null),N(q.bpm),K(!1)):(le(ue,q.bpm),K(!0))},je=()=>{he(),n&&_(!1),i&&f(!1),O(0),K(!1),p(!0),De(void 0),M(),N(dt),ze(dt),re(dt),se({startPatternName:"",startBar:0,endPatternName:"",endBar:Nt-1})};C.useEffect(()=>{const ne=Qe();u(ne);const oe=gs();if(oe){const ue=ne.find(be=>be.id===oe);if(ue){p(!1),B(ue);const be=kn();be!==null?N(be):(N(ue.bpm),ze(ue.bpm))}else De(void 0)}},[]),C.useEffect(()=>{J(ct(q.id))},[q.id]),C.useEffect(()=>{ia(x?ae:100)},[x,ae]),C.useEffect(()=>{bs(W)},[W]);const Oe=(()=>{if(y===void 0||!q.barBpmOverrides)return!1;const[ne]=q.timeSignature,oe=ne*me,ue=Math.floor(y/oe);return q.barBpmOverrides[ue]!==void 0})();C.useEffect(()=>{var we,He;if(y===void 0)return;const[ne]=q.timeSignature,oe=ne*me,ue=Math.floor(y/oe),be=((we=q.barBpmOverrides)==null?void 0:we[ue])!==void 0,xe=it(D);if(Y||be){const wt=(((He=q.barBpmOverrides)==null?void 0:He[ue])??q.bpm)*xe;N(wt)}else{const xt=q.bpm*xe;N(xt)}},[Y,y,q.timeSignature,q.barBpmOverrides,q.bpm,D]),ca({isMetronomePlaying:i,isPatternPlaying:n,setIsMetronomePlaying:f,setIsPatternPlaying:_}),_s(i,n),fa(),C.useEffect(()=>{const ne=oe=>(oe.preventDefault(),!1);return document.body.addEventListener("contextmenu",ne),()=>{document.body.removeEventListener("contextmenu",ne)}},[]),C.useEffect(()=>{const ne=ue=>{ue.touches.length>1&&ue.preventDefault()},oe=ue=>{ue.preventDefault()};return document.body.addEventListener("touchmove",ne,{passive:!1}),document.body.addEventListener("gesturestart",oe,{passive:!1}),()=>{document.body.removeEventListener("touchmove",ne),document.body.removeEventListener("gesturestart",oe)}},[]);const ge=ne=>{if(ne===""){p(!0),De(void 0);const oe=it(D),ue=q.bpm*oe;N(ue),ze(q.bpm)}else{const oe=b.find(ue=>ue.name===ne);if(oe&&oe.id!==q.id){p(!1),B(oe),De(oe.id);const ue=it(D),be=oe.bpm*ue;N(be),ze(oe.bpm)}}},{seekTo:Te,resetToRangeStart:$e}=pi({currentPattern:q,savedPatterns:b,crossPatternLoop:W,isPlaying:n,isDraftMode:m,playbackRate:ie,onSubdivisionChange:h,onPatternChange:ge,onPlayStart:()=>{T(ne=>ne+1)}}),Ee=()=>{$e(),he(),n&&_(!1),i&&f(!1)},Ze=C.useMemo(()=>{if(!W)return 0;const ne=m?"":q.name;return W.startPatternName===ne?W.startBar:0},[W,m,q.name]),Ke=wa({isPlaying:n,isFullPracticeMode:x,playbackRate:ie,bgmConfig:$,currentSubdivision:y,pattern:q,patternStartToken:w,rangeStartBar:Ze});C.useEffect(()=>{if(!W)return;const ne=m?"":q.name;if(W.startPatternName!==ne||v.current===W.startBar&&S.current===W.startPatternName)return;const[oe]=q.timeSignature,ue=oe*me;Te(W.startBar*ue),v.current=W.startBar,S.current=W.startPatternName},[W,m,q.name,q.timeSignature,Te]);const ot=U.isLoading||Ke.isLoading,zt=Ke.isLoaded,yt=U.error??Ke.error,qe=ne=>{D===0&&Te(ne)},Xe=()=>{m||A({grid:q.grid.map(ne=>ne.slice()),bars:q.bars,timeSignature:q.timeSignature,drums:q.drums,bpm:q.bpm,barBpmOverrides:q.barBpmOverrides?{...q.barBpmOverrides}:void 0})},un=(()=>P?P.timeSignature[0]===q.timeSignature[0]&&P.timeSignature[1]===q.timeSignature[1]&&P.drums.length===q.drums.length:!1)(),dn=ne=>{if(m||!P||!un)return;n&&_(!1),i&&f(!1),he();const oe=ne==="before"?0:q.bars;j(oe,P),A(null)},Rr=ne=>ne===""&&m||ne===q.name?q:b.find(ue=>ue.name===ne)??q,Nr=W?W.startPatternName:m?"":q.name,fn=Rr(Nr),hn=Math.max(1,fn.bpm*ie),Ft=fn.timeSignature,Ir=Math.round(60/hn*(4/Ft[1])*Ft[0]*1e3),{currentBeat:Ar}=wr({bpm:hn,timeSignature:Ft,isPlaying:d,resetToken:Z}),Pr=()=>{L(ne=>{const oe=!ne;return oe||he(),oe})},Ut=()=>{if(d){he();return}if(n){_(!1);return}if(!k){c();return}i&&f(!1),$e(),F(ne=>ne+1),z(!0),X.current=window.setTimeout(()=>{z(!1),V(ne=>ne+1),_(!0)},Ir-50)},Lr=()=>{he(),o()},Mr=()=>{if(m)return;const ne={...q,updatedAt:Date.now()};_t(ne),u(Qe())},Or=()=>{const ne=Ht(b),oe=q.id,ue=ct(oe),be={...q,id:jt(),name:ne,updatedAt:Date.now()};_t(be),(ue.fileId||ue.offsetMs!==0||ue.volumePct!==100)&&(et(be.id,ue),Cn(oe)),p(!1),De(be.id),B(be),u(Qe())},Dr=ne=>{n&&_(!1),he(),i&&f(!1);const oe=(()=>{if(!W)return!1;const{startPatternName:ue,endPatternName:be}=W;if(ue===be)return!1;const we=["",...[...b].map(Wt=>Wt.name).sort((Wt,Zr)=>Wt.localeCompare(Zr))],He=we.indexOf(ue),xt=we.indexOf(be),wt=we.indexOf(ne.name);return wt>=He&&wt<=xt})();if(oe||O(0),K(!1),p(!1),B(ne),De(ne.id),oe&&D>0){const ue=it(D),be=ne.bpm*ue;N(be),ze(ne.bpm)}else N(ne.bpm),ze(ne.bpm);oe||se({startPatternName:ne.name,startBar:0,endPatternName:ne.name,endBar:ne.bars-1})},zr=ne=>{he(),(async()=>{const ue=ct(ne);ue.fileId&&await Kt(ue.fileId),Cn(ne)})(),ps(ne),q.id===ne&&(p(!0),M(),De(void 0)),u(Qe())},Fr=async ne=>{if(!(ne.type==="audio/mpeg"||ne.name.toLowerCase().endsWith(".mp3"))){ee({isLoading:!1,error:"Please upload an MP3 file."});return}ee({isLoading:!0,error:null});try{$.fileId&&await Kt($.fileId);const{id:ue,meta:be}=await br(ne),xe={fileId:ue,offsetMs:$.offsetMs??0,volumePct:$.volumePct??100,meta:be};et(q.id,xe),J(xe),ee({isLoading:!1,error:null})}catch(ue){ee({isLoading:!1,error:ue instanceof Error?ue.message:"Failed to upload background music."})}},Ur=ne=>{const oe={...$,offsetMs:ne};et(q.id,oe),J(oe)},Wr=ne=>{const oe={...$,volumePct:ne};et(q.id,oe),J(oe)},Hr=ne=>{te(ne),xa(ne)},Vr=()=>{(async()=>{$.fileId&&await Kt($.fileId);const oe={offsetMs:0,volumePct:100};et(q.id,oe),J(oe)})()},Gr=ne=>{const oe=_n(ne);if(!oe){console.log("Invalid pattern data");return}const ue=Ht(b),be=Date.now(),xe={...oe,id:jt(),name:ue,createdAt:be,updatedAt:be};_t(xe),p(!1),B(xe),De(xe.id),N(xe.bpm),ze(xe.bpm),re(xe.bpm),u(Qe()),se({startPatternName:xe.name,startBar:0,endPatternName:xe.name,endBar:xe.bars-1})},$r=(ne,oe)=>{const ue=_n(ne);if(!ue){console.log("Invalid pattern data");return}const be=Ht(b),xe=Date.now(),we={...ue,id:jt(),name:be,createdAt:xe,updatedAt:xe};if(_t(we),p(!1),B(we),De(we.id),N(we.bpm),ze(we.bpm),re(we.bpm),u(Qe()),oe&&oe.fileId){et(we.id,{fileId:oe.fileId,offsetMs:oe.offsetMs,volumePct:oe.volumePct,meta:oe.meta});const He=ct(we.id);J(He)}se({startPatternName:we.name,startBar:0,endPatternName:we.name,endBar:we.bars-1})};if(t){const ne=Math.round(s.loaded/s.total*100);return a.jsx("div",{className:"app loading",children:a.jsx("div",{className:"loading-container",children:e&&a.jsx("div",{className:"loading-progress",children:a.jsx("div",{className:"loading-progress-bar",children:a.jsx("div",{className:"loading-progress-fill",style:{width:`${ne}%`}})})})})})}return a.jsxs("div",{className:"app",children:[a.jsx(Ea,{bpm:R,timeSignature:I,isPlaying:n,resetToken:Q,onBPMChange:fe,isPatternPlaying:i,isCountInPlaying:d,countInBeat:Ar,onPatternPlayToggle:r,onTimeSignatureChange:_e,rateIndex:D,onRateIndexChange:O,rates:Xn,rateLabels:ds,patternPlayButton:g?a.jsx(Un,{variant:"inline",isPlaying:n,onClick:Ut,onLongPress:Ee,fullPracticeMode:x,isCountInEnabled:k}):void 0}),a.jsx("main",{className:"app-main",children:a.jsx(Uo,{pattern:q,onCellClick:ce,onToggleGhost:de,onCycleThirtySecond:pe,onAddBar:ve,onRemoveBar:l,onClearGrid:G,onClearBar:H,crossPatternLoop:W,onCrossPatternLoopChange:se,onSave:Or,onSaveCurrentPattern:Mr,onImportPattern:Gr,onImportPatternWithBgm:$r,onLoadFromSlot:Dr,onDeletePattern:zr,onStopAllPlaying:Lr,onSelectDraft:je,savedPatterns:b,currentBeat:y,isPlaying:n,onPlayToggle:Ut,isDraftMode:m,onNotationDoubleClick:qe,canCopyPattern:!m,hasCopiedPattern:!!P,canPastePattern:un,onCopyPattern:Xe,onPastePatternBefore:()=>dn("before"),onPastePatternAfter:()=>dn("after"),bgmConfig:$,bgmIsLoading:ot,bgmIsLoaded:zt,bgmError:yt,onBgmUpload:Fr,onBgmOffsetChange:Ur,onBgmVolumeChange:Wr,onBgmDelete:Vr,masterVolume:ae,onMasterVolumeChange:Hr,isCountInEnabled:k,onCountInToggle:Pr,onBarBpmModeToggle:ye,currentBarHasOverride:Oe})}),!g&&a.jsx(Un,{isPlaying:n,onClick:Ut,onLongPress:Ee,fullPracticeMode:x,isCountInEnabled:k}),a.jsx(fi,{})]})}qt.createRoot(document.getElementById("root")).render(a.jsx(Yr.StrictMode,{children:a.jsx(gi,{})}));

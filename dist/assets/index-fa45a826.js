import{r as C,a as ts,c as wt,g as ns,R as rs}from"./react-vendor-8a332d8f.js";import{s as Qn,G as we,O as at,P as ss,N as Mt,F as Ot,g as os,a as wn,b as as}from"./audio-libs-2901efa1.js";import{S as er,A as rt,D as is,R as kn,a as cs,B as ls,V as _n,F as us,b as Sn,c as Bn}from"./graphics-libs-bbd9a815.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();var tr={exports:{}},Dt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ds=C,fs=Symbol.for("react.element"),hs=Symbol.for("react.fragment"),ms=Object.prototype.hasOwnProperty,ps=ds.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,gs={key:!0,ref:!0,__self:!0,__source:!0};function nr(t,n,e){var a,r={},s=null,i=null;e!==void 0&&(s=""+e),n.key!==void 0&&(s=""+n.key),n.ref!==void 0&&(i=n.ref);for(a in n)ms.call(n,a)&&!gs.hasOwnProperty(a)&&(r[a]=n[a]);if(t&&t.defaultProps)for(a in n=t.defaultProps,n)r[a]===void 0&&(r[a]=n[a]);return{$$typeof:fs,type:t,key:s,ref:i,props:r,_owner:ps.current}}Dt.Fragment=hs;Dt.jsx=nr;Dt.jsxs=nr;tr.exports=Dt;var o=tr.exports,Qt={},Cn=ts;Qt.createRoot=Cn.createRoot,Qt.hydrateRoot=Cn.hydrateRoot;const jn={"Crash 1":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Crash 2":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Hi-Hat Open":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Hi-Hat Closed":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Ride:{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Tom 1":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},"Tom 2":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Snare:{allowGhost:!0,allowGrace:!0,allowThirtySecond:!0},"Tom 3":{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0},Kick:{allowGhost:!0,allowGrace:!1,allowThirtySecond:!0}},Ce=0,Re=1,Pe=2,We=3,Me=4,Fe=5,Ue=6,En=["Crash 1","Crash 2","Hi-Hat Open","Hi-Hat Closed","Ride","Tom 1","Tom 2","Snare","Tom 3","Kick"],ht=120,en=[4,4],At=1,me=4,rr=700,bs={"Crash 1":{position:"above",symbol:"x",line:-2.5},"Crash 2":{position:"above",symbol:"o",line:-2},"Hi-Hat Open":{position:"above",symbol:"o",line:-1.5},"Hi-Hat Closed":{position:"above",symbol:"x",line:-1.5},Ride:{position:"above",symbol:"x",line:-1},"Tom 1":{position:"center",symbol:"●",line:-.5},"Tom 2":{position:"center",symbol:"●",line:0},Snare:{position:"center",symbol:"●",line:.5},"Tom 3":{position:"below",symbol:"●",line:1.5},Kick:{position:"below",symbol:"●",line:2.5}},sr=[9/10,8/9,7/8,6/7,5/6,2],vs=["","x0.9","x0.8","x0.7","x0.6","x0.5"];function ct(t,n=sr){let e=1;for(let a=0;a<t;a++)e*=n[a%n.length];return e}const or="drummer-app-data",ar="drummer-metronome-bpm",tn="drummer-cross-pattern-loop",ir="drummer-sample-selection",ys="vexflow",cr=new Set([Ce,Re,Pe,We,Me,Fe,Ue]);function xs(t){return t.map(n=>n.map(e=>typeof e=="boolean"?e?Re:Ce:typeof e=="number"&&cr.has(e)?e:Ce))}function ws(t){return t.grid.length>0&&t.grid[0].length>0&&typeof t.grid[0][0]=="boolean"?{...t,grid:xs(t.grid)}:t}function bt(){try{const t=localStorage.getItem(or);if(t){const n=JSON.parse(t);return n.patterns=n.patterns.map(ws),n}}catch(t){console.error("Failed to load storage data:",t)}return{patterns:[]}}function un(t){try{localStorage.setItem(or,JSON.stringify(t))}catch(n){console.error("Failed to save storage data:",n)}}function kt(t){const n=bt(),e=n.patterns.findIndex(a=>a.id===t.id);e>=0?n.patterns[e]=t:n.patterns.push(t),un(n)}function Qe(){return bt().patterns}function ks(t){const n=bt();n.patterns=n.patterns.filter(e=>e.id!==t),n.currentPatternId===t&&(n.currentPatternId=void 0),un(n)}function _s(){return bt().currentPatternId}function De(t){const n=bt();n.currentPatternId=t,un(n)}function Et(){return`pattern-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ze(t){try{localStorage.setItem(ar,String(t))}catch(n){console.error("Failed to save metronome BPM:",n)}}function Tn(){try{localStorage.removeItem("metronome_bpm");const t=localStorage.getItem(ar);if(t){const n=parseInt(t,10);if(!isNaN(n)&&n>=20&&n<=300)return n}}catch(t){console.error("Failed to load metronome BPM:",t)}return null}function Ss(t){try{t===void 0?localStorage.removeItem(tn):localStorage.setItem(tn,JSON.stringify(t))}catch(n){console.error("Failed to save cross pattern loop:",n)}}function Bs(){try{const t=localStorage.getItem(tn);if(t){const n=JSON.parse(t);if(typeof n=="object"&&typeof n.startPatternName=="string"&&typeof n.startBar=="number"&&typeof n.endPatternName=="string"&&typeof n.endBar=="number"&&n.startBar>=0&&n.endBar>=0)return n}}catch(t){console.error("Failed to load cross pattern loop:",t)}}function Cs(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.id!="string"||n.id.length===0||typeof n.name!="string"||n.name.length===0||typeof n.bpm!="number"||n.bpm<20||n.bpm>300||!Array.isArray(n.timeSignature)||n.timeSignature.length!==2||typeof n.timeSignature[0]!="number"||typeof n.timeSignature[1]!="number"||typeof n.bars!="number"||n.bars<1||n.bars>100||!Array.isArray(n.grid))return!1;for(const e of n.grid){if(!Array.isArray(e))return!1;for(const a of e)if(typeof a!="number"||!cr.has(a))return!1}if(!Array.isArray(n.drums))return!1;for(const e of n.drums)if(typeof e!="string")return!1;if(typeof n.createdAt!="number"||typeof n.updatedAt!="number"||n.loopRange!==void 0&&(!Array.isArray(n.loopRange)||n.loopRange.length!==2||typeof n.loopRange[0]!="number"||typeof n.loopRange[1]!="number"))return!1;if(n.barBpmOverrides!==void 0){if(typeof n.barBpmOverrides!="object"||n.barBpmOverrides===null)return!1;for(const[e,a]of Object.entries(n.barBpmOverrides)){const r=parseInt(e,10);if(isNaN(r)||r<0||typeof a!="number"||a<20||a>300)return!1}}return!0}function Rn(t){try{const n=JSON.parse(t);if(Cs(n))return n}catch{}return null}function js(t){return JSON.stringify(t)}function Vt(t){const n=t.map(a=>a.name).filter(a=>/^[A-Z]$/.test(a));let e="A";if(n.length>0){const a=n.map(s=>s.charCodeAt(0)),r=Math.max(...a);if(r<90)e=String.fromCharCode(r+1);else for(let s=65;s<=90;s++)if(!a.includes(s)){e=String.fromCharCode(s);break}}return e}function An(){return ys}function Es(t){try{localStorage.setItem(ir,JSON.stringify(t))}catch(n){console.error("Failed to save sample selection:",n)}}function dn(){try{const t=localStorage.getItem(ir);if(t){const n=JSON.parse(t),e=new Set(["A","B","C"]),a={};for(const[r,s]of Object.entries(n))e.has(s)&&(a[r]=s);return a}}catch(t){console.error("Failed to load sample selection:",t)}return{}}function Ts(t){return dn()[t]||"A"}function Rs(t,n){const e=dn();e[t]=n,Es(e)}function lr(t="New Pattern"){const n=en[0],e=At*n*me;return{id:Et(),name:t,bpm:ht,timeSignature:en,bars:At,grid:Array(En.length).fill(null).map(()=>Array(e).fill(Ce)),drums:En,createdAt:Date.now(),updatedAt:Date.now()}}const As=t=>t===Me||t===Fe||t===Ue;function Gt(t,n,e,a){if(!t)return;const r={};for(const[s,i]of Object.entries(t)){const c=parseInt(s,10);c!==a&&(c>=n?r[c+e]=i:r[c]=i)}return Object.keys(r).length>0?r:void 0}function Is(t){const[n,e]=C.useState(t),a=C.useCallback(u=>{e(m=>({...m,bpm:u,updatedAt:Date.now()}))},[]),r=C.useCallback((u,m)=>{e(p=>{const v={...p.barBpmOverrides};m===null?delete v[u]:v[u]=m;const S=Object.keys(v).length>0;return{...p,barBpmOverrides:S?v:void 0,updatedAt:Date.now()}})},[]),s=C.useCallback((u,m)=>{e(p=>{const v=p.grid.map((S,k)=>{if(k===u){const E=[...S];return E[m]=E[m]===Ce?Re:Ce,E}return S});return{...p,grid:v,updatedAt:Date.now()}})},[]),i=C.useCallback((u,m)=>{e(p=>{var P;const v=(P=p.grid[u])==null?void 0:P[m];if(v===Ce||As(v))return p;const S=p.drums[u],k=jn[S],E=p.grid.map((T,L)=>{if(L===u){const R=[...T];let O;return v===Re?O=k.allowGhost?Pe:Re:v===Pe?O=k.allowGrace?We:Re:O=Re,R[m]=O,R}return T});return{...p,grid:E,updatedAt:Date.now()}})},[]),c=C.useCallback((u,m)=>{e(p=>{var T;const v=(T=p.grid[u])==null?void 0:T[m],S=p.drums[u];if(!jn[S].allowThirtySecond){if(v===Ce){const L=p.grid.map((R,O)=>{if(O===u){const M=[...R];return M[m]=Re,M}return R});return{...p,grid:L,updatedAt:Date.now()}}return p}let E;v===Re||v===Pe||v===We?E=Me:v===Me?E=Fe:v===Fe?E=Ue:E=Re;const P=p.grid.map((L,R)=>{if(R===u){const O=[...L];return O[m]=E,O}return L});return{...p,grid:P,updatedAt:Date.now()}})},[]),f=C.useCallback(u=>{e(m=>{var O;const[p]=m.timeSignature,v=p*me;let S,k;if(u!==void 0){const M=Math.floor(u/v),w=u%v,A=v/2;w<A?(S=M,k=M):(S=M+1,k=M)}else S=m.bars,k=m.bars-1;const E=k*v,P=E+v,T=m.grid.map(M=>{const w=M.slice(E,P),A=[...M];return A.splice(S*v,0,...w),A});let L=Gt(m.barBpmOverrides,S,1);const R=(O=m.barBpmOverrides)==null?void 0:O[k];return R!==void 0&&(L=L??{},L[S]=R),{...m,bars:m.bars+1,grid:T,barBpmOverrides:L,updatedAt:Date.now()}})},[]),_=C.useCallback(u=>{e(m=>{if(m.bars<=1)return m;const[p]=m.timeSignature,v=p*me;let S;if(u!==void 0){const T=Math.floor(u/v),L=u%v,R=v/2;L<R,S=T}else S=m.bars-1;const k=S*v,E=m.grid.map(T=>{const L=[...T];return L.splice(k,v),L}),P=Gt(m.barBpmOverrides,S+1,-1,S);return{...m,bars:m.bars-1,grid:E,barBpmOverrides:P,loopRange:m.loopRange&&m.loopRange[1]>=m.bars-1?[m.loopRange[0],m.bars-2]:m.loopRange,updatedAt:Date.now()}})},[]),x=C.useCallback(()=>{e(u=>{const m=u.grid.map(p=>p.map(()=>Ce));return{...u,grid:m,updatedAt:Date.now()}})},[]),b=C.useCallback(u=>{e(m=>{const[p]=m.timeSignature,v=p*me,k=Math.floor(u/v)*v,E=k+v,P=m.grid.map(T=>{const L=[...T];for(let R=k;R<E;R++)L[R]=Ce;return L});return{...m,grid:P,updatedAt:Date.now()}})},[]),y=C.useCallback((u,m)=>{e(p=>{var O;if(m.bars<=0||m.grid.length!==p.drums.length||m.timeSignature[0]!==p.timeSignature[0]||m.timeSignature[1]!==p.timeSignature[1])return p;const[v]=p.timeSignature,S=v*me,k=Math.max(0,Math.min(p.bars,u)),E=k*S,P=m.bars*S;if(m.grid.some(M=>M.length!==P))return p;const T=p.grid.map((M,w)=>{const A=m.grid[w],d=[...M];return d.splice(E,0,...A),d}),L=m.bpm!==p.bpm;let R=Gt(p.barBpmOverrides,k,m.bars);for(let M=0;M<m.bars;M++){const w=(O=m.barBpmOverrides)==null?void 0:O[M];w!==void 0?(R=R??{},R[k+M]=w):L&&(R=R??{},R[k+M]=m.bpm)}return{...p,bars:p.bars+m.bars,grid:T,barBpmOverrides:R,updatedAt:Date.now()}})},[]),h=C.useCallback(u=>{e(u)},[]),g=C.useCallback(()=>{e(lr())},[]);return{pattern:n,updateBPM:a,updateBarBpm:r,toggleCell:s,toggleGhost:i,cycleThirtySecond:c,addBar:f,removeBar:_,clearGrid:x,clearBar:b,insertPatternGrid:y,loadPattern:h,resetPattern:g}}function Ns(t,n){const e=C.useRef(t),a=C.useRef(n);C.useEffect(()=>{e.current=t},[t]),C.useEffect(()=>{a.current=n},[n]),C.useEffect(()=>{const r=s=>{if(e.current||a.current)return s.preventDefault(),s.returnValue="",""};return window.addEventListener("beforeunload",r),()=>{window.removeEventListener("beforeunload",r)}},[])}const Ps="drummer-audio-cache",Ls=1,Ie="audio-buffers",ur="cache-version",$t="1.0.0";async function vt(){return new Promise((t,n)=>{const e=indexedDB.open(Ps,Ls);e.onerror=()=>n(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(Ie)||r.createObjectStore(Ie,{keyPath:"name"})}})}function Ms(t){const n=[];for(let e=0;e<t.numberOfChannels;e++)n.push(t.getChannelData(e));return{numberOfChannels:t.numberOfChannels,length:t.length,sampleRate:t.sampleRate,channelData:n}}function Os(t,n){const e=t.createBuffer(n.numberOfChannels,n.length,n.sampleRate);for(let a=0;a<n.numberOfChannels;a++)e.getChannelData(a).set(n.channelData[a]);return e}async function Ds(t,n){try{const e=await vt(),r=e.transaction(Ie,"readwrite").objectStore(Ie),s=Ms(n);await new Promise((i,c)=>{const f=r.put({name:t,data:s});f.onsuccess=()=>i(),f.onerror=()=>c(f.error)}),e.close()}catch(e){console.warn(`Failed to cache audio buffer "${t}":`,e)}}async function zs(t,n){try{const e=await vt(),r=e.transaction(Ie,"readonly").objectStore(Ie),s=await new Promise((i,c)=>{const f=r.get(n);f.onsuccess=()=>i(f.result),f.onerror=()=>c(f.error)});return e.close(),s?Os(t,s.data):null}catch(e){return console.warn(`Failed to get cached audio buffer "${n}":`,e),null}}async function Fs(){try{const t=await vt(),e=t.transaction(Ie,"readwrite").objectStore(Ie);await new Promise((a,r)=>{const s=e.clear();s.onsuccess=()=>a(),s.onerror=()=>r(s.error)}),t.close()}catch(t){console.warn("Failed to clear audio cache:",t)}}async function Us(){try{const t=await vt(),e=t.transaction(Ie,"readonly").objectStore(Ie),a=await new Promise((r,s)=>{const i=e.get(ur);i.onsuccess=()=>r(i.result),i.onerror=()=>s(i.error)});return t.close(),a?a.version:null}catch(t){return console.warn("Failed to get cache version:",t),null}}async function Hs(t){try{const n=await vt(),a=n.transaction(Ie,"readwrite").objectStore(Ie);await new Promise((r,s)=>{const i=a.put({name:ur,version:t});i.onsuccess=()=>r(),i.onerror=()=>s(i.error)}),n.close()}catch(n){console.warn("Failed to set cache version:",n)}}async function Ws(){try{const t=await Us();t!==$t&&(console.log(`Cache version mismatch. Expected: ${$t}, Found: ${t}. Clearing cache...`),await Fs(),await Hs($t))}catch(t){console.warn("Failed to check cache version:",t)}}const Vs="/drummer/assets/kick-f5f64180.mp3",Gs="/drummer/assets/snare-8dad42f7.mp3",$s="/drummer/assets/hi-hat-closed-20faf03a.mp3",Zs="/drummer/assets/hi-hat-open-c13c6d66.mp3",Ks="/drummer/assets/crash-0688e97a.mp3",qs="/drummer/assets/crash2-2d466720.mp3",Ys="/drummer/assets/ride-3a112803.mp3",Js="/drummer/assets/tom1-e6733423.mp3",Xs="/drummer/assets/tom2-5814473e.mp3",Qs="/drummer/assets/tom3-3f3fe247.mp3",Zt="/drummer/assets/metronome-6b186e46.mp3",eo="/drummer/assets/kick-alt-b2958473.mp3",to="/drummer/assets/snare-alt-0de57387.mp3",no="/drummer/assets/hi-hat-closed-alt-579c1ecc.mp3",ro="/drummer/assets/hi-hat-open-alt-2a309767.mp3",so="/drummer/assets/crash-alt-94e611ad.mp3",oo="/drummer/assets/crash2-alt-eb28fd80.mp3",ao="/drummer/assets/ride-alt-cd8ec646.mp3",io="/drummer/assets/tom1-alt-05e11fd7.mp3",co="/drummer/assets/tom2-alt-70f42d0f.mp3",lo="/drummer/assets/tom3-alt-18be2bb3.mp3",uo="/drummer/assets/kick-another-d2d88941.mp3",fo="/drummer/assets/snare-another-0f53eb38.mp3",ho="/drummer/assets/hi-hat-closed-another-23056c2a.mp3",mo="/drummer/assets/hi-hat-open-another-531f2b31.mp3",po="/drummer/assets/crash-another-89c6e467.mp3",go="/drummer/assets/crash2-another-79bd375c.mp3",bo="/drummer/assets/ride-another-1da28a50.mp3",vo="/drummer/assets/tom1-another-ca934ab0.mp3",yo="/drummer/assets/tom2-another-e79d7d82.mp3",xo="/drummer/assets/tom3-another-73bd83e0.mp3",_t={kick:{A:Vs,B:eo,C:uo},snare:{A:Gs,B:to,C:fo},hiHatClosed:{A:$s,B:no,C:ho},hiHatOpen:{A:Zs,B:ro,C:mo},crash1:{A:Ks,B:so,C:po},crash2:{A:qs,B:oo,C:go},ride:{A:Ys,B:ao,C:bo},tom1:{A:Js,B:io,C:vo},tom2:{A:Xs,B:co,C:yo},tom3:{A:Qs,B:lo,C:xo},metronome:{A:Zt,B:Zt,C:Zt}},In={Kick:"kick",Snare:"snare","Hi-Hat Closed":"hiHatClosed","Hi-Hat Open":"hiHatOpen","Crash 1":"crash1","Crash 2":"crash2",Ride:"ride","Tom 1":"tom1","Tom 2":"tom2","Tom 3":"tom3"};function wo(t){var a,r;const n=Object.keys(In).find(s=>In[s]===t);if(!n)return((a=_t[t])==null?void 0:a.A)||_t[t].A;const e=Ts(n);return((r=_t[t])==null?void 0:r[e])||_t[t].A}let Kt=null,qt=!1;const fn=new Map;let It=!1,nt=null,pt=1,dr=100,nn=null;function ko(){return Kt||(Kt=os()),Kt}function _o(){const t=ko();return t.rawContext??t.context??t}function He(t,n){const a=Math.max(0,n-Be().currentTime)*1e3;setTimeout(()=>{t.forEach(r=>r.dispose())},a)}function Be(){return _o()}async function fr(){if(Be().state==="suspended"&&!qt){qt=!0;try{await Qn()}finally{qt=!1}}}async function So(t,n,e=!1){const a=Be();try{let r;const s=await zs(a,n);if(s&&!e)r=s;else{const c=await(await fetch(t)).arrayBuffer();r=await a.decodeAudioData(c),await Ds(n,r)}fn.set(n,r)}catch{}}function zt(t=!1){if(It&&!t)return Promise.resolve();if(nt)return nt;const n=[{name:"kick"},{name:"snare"},{name:"hiHatClosed"},{name:"hiHatOpen"},{name:"crash1"},{name:"crash2"},{name:"ride"},{name:"tom1"},{name:"tom2"},{name:"tom3"},{name:"metronome"}];let e=0;return nt=(async()=>{for(const a of n){const r=wo(a.name);await So(r,a.name,t),e++,nn&&nn(e,n.length,a.name)}It=!0})(),nt}function Bo(){Be().state==="suspended"&&Qn().catch(()=>{}),zt()}async function hr(){await Ws(),await zt()}async function Co(){try{It=!1,nt=null,await zt(!0)}catch(t){console.warn("Failed to update sample cache:",t)}}function Yt(t){nn=t}async function jo(){It=!1,nt=null,fn.clear(),await zt(!0)}function mr(t,n=1,e=1){return Ve("metronome",t,n,!1,e,!1)}function pr(t,n=800,e=.01){const a=new we(.3).toDestination(),r=new at({frequency:n,type:"sine"});r.connect(a),a.gain.setValueAtTime(.3,t),a.gain.exponentialRampToValueAtTime(.01,t+e),r.start(t),r.stop(t+e),He([r,a],t+e+.1)}function Eo(t){mr(t,.8,1.2)||pr(t,1e3,.02)}function To(t){mr(t,.6,1)||pr(t,600,.01)}function gr(t){Ve("kick",t,.9)||Ro(t)}function Ro(t){const n=new we(.85).toDestination(),e=new we,a=new at({type:"sine"});a.connect(e),e.connect(n),a.frequency.setValueAtTime(150,t),a.frequency.exponentialRampToValueAtTime(40,t+.08),e.gain.setValueAtTime(1,t),e.gain.setValueAtTime(.8,t+.01),e.gain.exponentialRampToValueAtTime(.001,t+.25),a.start(t),a.stop(t+.25),He([a,e,n],t+.35)}function Ve(t,n,e=1,a=!0,r=1,s=!0){const i=fn.get(t);if(!i)return!1;const c=s?dr/100:1,f=a?Math.max(0,Math.min(1,e*pt*c)):Math.max(0,Math.min(1,e*c)),_=new we(f).toDestination(),x=new ss(i);x.connect(_),x.playbackRate=r;const b=Math.max(n,Be().currentTime);x.start(b);const y=Math.max(.01,r),h=i.duration/y;return He([x,_],b+h+.1),!0}function rn(t){Ve("snare",t,.9)||Ao(t)}function Ao(t){const n=new we(.5).toDestination(),e=new at({type:"triangle"}),a=new we;e.connect(a),a.connect(n),e.frequency.setValueAtTime(200,t),e.frequency.exponentialRampToValueAtTime(120,t+.05),a.gain.setValueAtTime(.7,t),a.gain.exponentialRampToValueAtTime(.001,t+.12);const r=new at({type:"sine"}),s=new we;r.connect(s),s.connect(n),r.frequency.setValueAtTime(400,t),r.frequency.exponentialRampToValueAtTime(200,t+.03),s.gain.setValueAtTime(.3,t),s.gain.exponentialRampToValueAtTime(.001,t+.08);const i=new Mt("white"),c=new Ot({type:"bandpass",frequency:5e3,Q:1}),f=new we;i.connect(c),c.connect(f),f.connect(n),f.gain.setValueAtTime(.5,t),f.gain.exponentialRampToValueAtTime(.001,t+.18),e.start(t),e.stop(t+.12),r.start(t),r.stop(t+.08),i.start(t),i.stop(t+.18),He([e,a,r,s,i,c,f,n],t+.28)}function br(t){Ve("hiHatClosed",t,.7)||Io(t)}function Io(t){const n=new we(.25).toDestination(),e=new Mt("white"),a=new Ot({type:"highpass",frequency:7e3}),r=new we;e.connect(a),a.connect(r),r.connect(n),r.gain.setValueAtTime(1,t),r.gain.exponentialRampToValueAtTime(.001,t+.05),e.start(t),e.stop(t+.05),He([e,a,r,n],t+.15)}function vr(t){Ve("hiHatOpen",t,.7)||No(t)}function No(t){const n=new we(.4).toDestination(),e=new Mt("white"),a=new Ot({type:"highpass",frequency:6e3}),r=new we;e.connect(a),a.connect(r),r.connect(n),r.gain.setValueAtTime(1,t),r.gain.exponentialRampToValueAtTime(.001,t+.35),e.start(t),e.stop(t+.35),He([e,a,r,n],t+.45)}function Nt(t,n=1){const e=n>1?"crash1":"crash2";Ve(e,t,.6)||Po(t,n)}function Po(t,n=1){const e=new we(.5).toDestination(),a=new Mt("white"),r=new Ot({type:"highpass",frequency:3e3*n}),s=new we;a.connect(r),r.connect(s),s.connect(e),s.gain.setValueAtTime(1,t),s.gain.exponentialRampToValueAtTime(.001,t+1.2),a.start(t),a.stop(t+1.2),He([a,r,s,e],t+1.3)}function yr(t){Ve("ride",t,.7)||Lo(t)}function Lo(t){const n=new we(.4).toDestination(),e=new we,a=new at({type:"sine",frequency:3e3});a.connect(e),e.connect(n),e.gain.setValueAtTime(.4,t),e.gain.exponentialRampToValueAtTime(.001,t+.5),a.start(t),a.stop(t+.5),He([a,e,n],t+.6)}function st(t,n=200){let e;n>=230?e="tom1":n>=180?e="tom2":e="tom3",!Ve(e,t,1)&&Mo(t,n)}function Mo(t,n=200){const e=new we(.65).toDestination(),a=new we,r=new at({type:"sine"});r.connect(a),a.connect(e),r.frequency.setValueAtTime(n*1.5,t),r.frequency.exponentialRampToValueAtTime(n*.6,t+.2),a.gain.setValueAtTime(1,t),a.gain.exponentialRampToValueAtTime(.001,t+.3),r.start(t),r.stop(t+.3),He([r,a,e],t+.4)}async function sn(t,n=1){await fr(),await hr(),pt=n;const a=Be().currentTime;switch(t){case"Kick":gr(a);break;case"Snare":rn(a);break;case"Hi-Hat Closed":br(a);break;case"Hi-Hat Open":vr(a);break;case"Crash 1":Nt(a,1.2);break;case"Crash 2":Nt(a,1);break;case"Ride":yr(a);break;case"Tom 1":st(a,280);break;case"Tom 2":st(a,220);break;case"Tom 3":st(a,160);break;default:rn(a)}pt=1}function Oo(t){pt=t}function Do(){pt=1}function zo(t){dr=Math.max(0,Math.min(100,t))}function Fo({isMetronomePlaying:t,isPatternPlaying:n,setIsMetronomePlaying:e,setIsPatternPlaying:a}){const r=C.useRef(!1),s=C.useRef(!1),i=C.useRef(t),c=C.useRef(n);C.useEffect(()=>{i.current=t},[t]),C.useEffect(()=>{c.current=n},[n]),C.useEffect(()=>{const f=async()=>{if(document.hidden)r.current=i.current,s.current=c.current,e(!1),a(!1);else try{await fr(),r.current&&e(!0),s.current&&a(!0)}catch(_){console.error("Failed to resume audio context:",_)}};return document.addEventListener("visibilitychange",f),()=>{document.removeEventListener("visibilitychange",f)}},[e,a])}function Uo(){const[t,n]=C.useState(!0),[e,a]=C.useState({loaded:0,total:11,currentName:""}),[r,s]=C.useState(!1);return C.useEffect(()=>{(async()=>{const c=setTimeout(()=>{s(!0)},200);try{Yt((x,b,y)=>{a({loaded:x,total:b,currentName:y})}),Bo();const _=new Promise((x,b)=>{setTimeout(()=>b(new Error("Sample loading timeout")),1e4)});await Promise.race([hr(),_]),Yt(null),Co().catch(()=>{})}catch{}finally{clearTimeout(c),Yt(null),n(!1)}})()},[]),{isLoading:t,loadingProgress:e,showProgress:r}}const Ho=300,Wo=5;function Vo(){C.useEffect(()=>{const t={count:0},n={time:0},e=r=>!!(r.closest("button")||r.closest("input")||r.closest("select")||r.closest("a")||r.closest(".bottom-play-button-container")),a=r=>{const s=r.target;if(e(s))return;const i=Date.now();i-n.time>Ho&&(t.count=0),t.count++,n.time=i,t.count>=Wo&&(window.dispatchEvent(new CustomEvent("show-version")),t.count=0)};return document.body.addEventListener("pointerdown",a,{passive:!0}),()=>{document.body.removeEventListener("pointerdown",a)}},[])}function Go(){const[t,n]=C.useState(!1),[e,a]=C.useState(!1),r=C.useCallback(()=>{n(c=>{const f=!c;return f&&a(!1),f})},[]),s=C.useCallback(()=>{a(c=>{const f=!c;return f&&n(!1),f})},[]),i=C.useCallback(()=>{n(!1),a(!1)},[]);return{isMetronomePlaying:t,isPatternPlaying:e,toggleMetronomePlay:r,togglePatternPlay:s,stopAll:i,setIsMetronomePlaying:n,setIsPatternPlaying:a}}const $o="drummer-bgm-files",Zo=1,Ne="bgm-files",xr="drummer-bgm-config",wr="drummer-master-volume",kr=100;function Ko(){return`bgm-${Date.now()}-${Math.random().toString(36).slice(2,10)}`}async function yt(){return new Promise((t,n)=>{const e=indexedDB.open($o,Zo);e.onerror=()=>n(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(Ne)||r.createObjectStore(Ne,{keyPath:"id"})}})}async function _r(t){const n=await yt(),e=n.transaction(Ne,"readwrite"),a=e.objectStore(Ne),r=Ko(),s={id:r,blob:t,name:t.name,size:t.size,type:t.type,createdAt:Date.now()};try{return await new Promise((i,c)=>{e.oncomplete=()=>i(),e.onerror=()=>c(e.error),e.onabort=()=>c(new Error("Transaction aborted"));const f=a.put(s);f.onerror=()=>c(f.error)}),await new Promise(i=>setTimeout(i,50)),n.close(),{id:r,meta:{name:s.name,size:s.size,type:s.type}}}catch(i){throw n.close(),i}}async function Sr(t){const n=await yt(),a=n.transaction(Ne,"readonly").objectStore(Ne),r=await new Promise((s,i)=>{const c=a.get(t);c.onsuccess=()=>s(c.result??null),c.onerror=()=>i(c.error)});return n.close(),r}async function Jt(t){const n=await yt(),e=n.transaction(Ne,"readwrite"),a=e.objectStore(Ne);await new Promise((r,s)=>{e.oncomplete=()=>r(),e.onerror=()=>s(e.error);const i=a.delete(t);i.onerror=()=>s(i.error)}),n.close()}async function qo(){const t=await yt(),e=t.transaction(Ne,"readonly").objectStore(Ne),a=await new Promise((r,s)=>{const i=e.getAll();i.onsuccess=()=>r(i.result),i.onerror=()=>s(i.error)});return t.close(),a}async function Yo(){const t=await yt(),n=t.transaction(Ne,"readwrite"),e=n.objectStore(Ne);await new Promise((a,r)=>{n.oncomplete=()=>a(),n.onerror=()=>r(n.error);const s=e.clear();s.onerror=()=>r(s.error)}),t.close()}async function Br(t,n,e){const a=atob(t),r=new Uint8Array(a.length);for(let c=0;c<a.length;c++)r[c]=a.charCodeAt(c);const s=new Blob([r],{type:e}),i=new File([s],n,{type:e,lastModified:Date.now()});return _r(i)}function hn(){const t=localStorage.getItem(xr);if(!t)return{};try{const n=JSON.parse(t);if(n&&typeof n=="object")return n}catch{}return{}}function Cr(t){localStorage.setItem(xr,JSON.stringify(t))}function lt(t){const e=hn()[t];return{fileId:e==null?void 0:e.fileId,offsetMs:(e==null?void 0:e.offsetMs)??0,volumePct:(e==null?void 0:e.volumePct)??kr,meta:e==null?void 0:e.meta}}function et(t,n){const e=hn();e[t]={fileId:n.fileId,offsetMs:n.offsetMs??0,volumePct:n.volumePct??kr,meta:n.meta},Cr(e)}function Nn(t){const n=hn();delete n[t],Cr(n)}const Pn=0;function Jo(){const t=localStorage.getItem(wr);if(!t)return Pn;try{const n=JSON.parse(t);if(typeof n=="number"&&n>=0&&n<=100)return n}catch{}return Pn}function Xo(t){const n=Math.max(0,Math.min(100,t));localStorage.setItem(wr,JSON.stringify(n))}function Xt(t,n){var s;const e=n.timeSignature[0],a=n.timeSignature[1];let r=0;for(let i=0;i<t;i++){const _=60/(((s=n.barBpmOverrides)==null?void 0:s[i])??n.bpm)*(4/a)*e;r+=_}return r}function Qo({isPlaying:t,isFullPracticeMode:n,playbackRate:e,bgmConfig:a,currentSubdivision:r,pattern:s,patternStartToken:i,rangeStartBar:c}){const f=s.timeSignature[0],_=s.timeSignature[1],x=C.useRef(null),b=C.useRef(void 0),[y,h]=C.useState({isLoading:!1,isLoaded:!1,error:null}),g=C.useRef(e);g.current=e;const u=C.useRef(0),m=C.useRef(null),p=C.useRef(0),v=C.useCallback(()=>{var X;const k=x.current;if(!k)return;const P=Be().currentTime,T=(a.offsetMs??0)/1e3,L=Math.max(.1,g.current),R=u.current,O=Xt(c,s),A=R/g.current+O-T,d=A/L,F=A<0?Math.abs(A):0,q=P+F,z=Math.max(0,d);let Q=z;if(((X=k.buffer)==null?void 0:X.duration)!==void 0){const N=Math.max(0,k.buffer.duration-.001);Q=Math.min(N,z)}k.state==="started"&&k.stop();const H=Math.max(q,p.current+.001);p.current=H,k.start(H,Q)},[a.offsetMs,s,c]);C.useEffect(()=>{let k=!1;return(async()=>{if(!a.fileId){b.current=void 0,x.current&&(x.current.stop(),x.current.dispose(),x.current=null),h({isLoading:!1,isLoaded:!1,error:null});return}if(!(a.fileId===b.current&&x.current)){h({isLoading:!0,isLoaded:!1,error:null});try{const P=await Sr(a.fileId);if(!P)throw new Error("Background music file not found");const T=Be(),L=await P.blob.arrayBuffer(),R=await T.decodeAudioData(L.slice(0));if(k)return;x.current&&(x.current.stop(),x.current.dispose());const O=new as(R).toDestination();O.loop=!1,O.playbackRate=Math.max(.1,g.current),O.grainSize=.2,O.overlap=.02;const M=Math.max(0,Math.min(100,a.volumePct??100)),w=Math.max(1e-4,M/100);O.volume.value=wn(w),x.current=O,b.current=a.fileId,h({isLoading:!1,isLoaded:!0,error:null})}catch(P){k||h({isLoading:!1,isLoaded:!1,error:P instanceof Error?P.message:"Failed to load background music"})}}})(),()=>{k=!0}},[a.fileId,a.volumePct]),C.useEffect(()=>{var A;const k=f*me,E=Math.floor(r/k),P=r%k,T=Xt(E,s),M=60/((((A=s.barBpmOverrides)==null?void 0:A[E])??s.bpm)*e)*(4/_)/me,w=Xt(c,s);u.current=T+P*M-w},[r,s,_,e,c,f]),C.useEffect(()=>{const k=x.current;k&&(k.playbackRate=Math.max(.1,e))},[e]),C.useEffect(()=>{const k=x.current;if(!k)return;const E=Math.max(0,Math.min(100,a.volumePct??100)),P=Math.max(1e-4,E/100);k.volume.value=wn(P)},[a.volumePct]);const S=C.useRef(a.offsetMs??0);return C.useEffect(()=>{if(!x.current||!t||!n||!a.fileId||!y.isLoaded){S.current=a.offsetMs??0;return}const E=S.current;S.current=a.offsetMs??0,E!==(a.offsetMs??0)&&v()},[a.offsetMs,t,n,y.isLoaded,a.fileId,v]),C.useEffect(()=>{const k=x.current;if(!k)return;if(!n||!a.fileId){k.state==="started"&&k.stop();return}if(!t){k.state==="started"&&k.stop();return}const E=Be();E.state==="suspended"&&E.resume().catch(()=>{}),v()},[t,n,a.fileId,a.offsetMs,y.isLoaded,i,v]),C.useEffect(()=>{if(!t||!n||!a.fileId||!y.isLoaded){m.current=r;return}const k=m.current;m.current=r,k!==null&&r<k&&v()},[r,t,n,a.fileId,y.isLoaded,v]),C.useEffect(()=>{m.current=r},[r]),C.useEffect(()=>()=>{x.current&&(x.current.stop(),x.current.dispose(),x.current=null)},[]),y}let Tt=null;async function jr(){if("wakeLock"in navigator)try{Tt=await navigator.wakeLock.request("screen")}catch{}}async function on(){if(Tt!==null)try{await Tt.release(),Tt=null}catch{}}let Ln=0;const ea=16;function Er({bpm:t,timeSignature:n,isPlaying:e,onBeatChange:a,resetToken:r}){const[s,i]=C.useState(0),[c,f]=C.useState(0),_=C.useRef(t),x=C.useRef(n),b=C.useRef(a);_.current=t,x.current=n,b.current=a;const y=C.useRef(0),h=C.useRef(0),g=C.useRef(null),u=C.useRef(!1),m=C.useRef(new Set),p=C.useCallback(()=>{const k=Be();if(!u.current)return;const E=_.current,P=x.current,T=P[0],L=P[1],O=60/E*(4/L)/me,M=T*me,w=k.currentTime,A=.1;for(;y.current<w+A;){const d=h.current,F=Math.floor(d/me),q=Math.max(y.current,w),z=(q-w)*1e3;if(d%me===0){F===0?Eo(q):To(q);const N=b.current;if(N){const I=window.setTimeout(()=>N(F),z);m.current.add(I)}}const Q=d,H=F,X=window.setTimeout(()=>{m.current.delete(X),Date.now()-Ln>=ea?requestAnimationFrame(()=>{Ln=Date.now(),u.current&&(f(Q),i(H))}):u.current&&(f(Q),i(H))},Math.max(0,z));m.current.add(X),h.current=(h.current+1)%M,y.current+=O}},[]),v=C.useCallback(async()=>{const k=Be();if(u.current)return;k.state==="suspended"&&await k.resume(),await new Promise(P=>requestAnimationFrame(P)),jr(),u.current=!0;const E=k.currentTime;y.current=E,p(),g.current=window.setInterval(p,25)},[p]),S=C.useCallback(()=>{u.current=!1,g.current!==null&&(clearInterval(g.current),g.current=null),m.current.forEach(k=>{clearTimeout(k)}),m.current.clear(),on()},[]);return C.useEffect(()=>(e?v():S(),()=>{S()}),[e,v,S]),C.useEffect(()=>{if(e&&u.current){const k=Be();y.current=k.currentTime}},[t,n,e]),C.useEffect(()=>{if(h.current=0,f(0),i(0),m.current.forEach(k=>{clearTimeout(k)}),m.current.clear(),e&&u.current){const k=Be();y.current=k.currentTime}},[r,e]),{currentBeat:s,currentSubdivision:c}}function ta({bpm:t,onChange:n,min:e=40,max:a=200,disabled:r=!1}){const s=C.useRef(null),[i,c]=C.useState(!1),[f,_]=C.useState(null),x=C.useCallback(k=>(k-e)/(a-e)*100,[e,a]),b=C.useCallback(k=>{const E=e+k/100*(a-e);return Math.round(E/5)*5},[e,a]),y=C.useCallback(k=>{if(!s.current)return;const E=s.current.getBoundingClientRect(),P=Math.max(0,Math.min(100,(k-E.left)/E.width*100)),T=b(P),L=Math.max(e,Math.min(a,T));n(L)},[b,e,a,n]),h=C.useCallback(k=>{r||(c(!0),y(k.clientX),k.target.setPointerCapture(k.pointerId))},[r,y]),g=C.useCallback(k=>{i&&y(k.clientX)},[i,y]),u=C.useCallback(()=>{c(!1)},[]);C.useEffect(()=>{if(i)return window.addEventListener("pointermove",g),window.addEventListener("pointerup",u),()=>{window.removeEventListener("pointermove",g),window.removeEventListener("pointerup",u)}},[i,g,u]),C.useEffect(()=>{const k=()=>{if(s.current){const E=s.current.getBoundingClientRect();_(E.width)}};return k(),window.addEventListener("resize",k),()=>window.removeEventListener("resize",k)},[]);const m=x(t),p=Math.max(0,m),v=20,S=f?p*(f-v)/f:p;return o.jsx("div",{className:"bpm-slider-container",children:o.jsxs("div",{ref:s,className:`bpm-slider-track ${r?"bpm-slider-disabled":""}`,onPointerDown:h,children:[o.jsx("div",{className:"bpm-slider-fill",style:{width:`calc(${S}% + ${v/2}px)`}}),o.jsx("div",{className:"bpm-slider-thumb",style:{left:`calc((100% - ${v}px) * ${p/100})`}})]})})}function na({currentBeat:t,beatsPerBar:n}){return o.jsx("div",{className:"beat-dots",children:Array.from({length:n},(e,a)=>o.jsx("div",{className:`beat-dot ${a===t?"active":""}`},a))})}function ra({isPlaying:t,onClick:n,loopCount:e=0,onResetCount:a}){const r=C.useRef(null),s=C.useRef(!1),i=C.useRef(0),c=500,f=()=>{a&&(s.current=!1,r.current=window.setTimeout(()=>{a(),s.current=!0,r.current=null},c))},_=()=>{r.current&&(clearTimeout(r.current),r.current=null)},x=()=>{r.current&&(clearTimeout(r.current),r.current=null)},b=()=>{a&&(i.current=Date.now(),s.current=!1,r.current=window.setTimeout(()=>{a(),s.current=!0,r.current=null},c))},y=u=>{r.current&&(clearTimeout(r.current),r.current=null),s.current&&(u.preventDefault(),setTimeout(()=>{s.current=!1},100))},h=u=>{if(s.current){u.preventDefault(),u.stopPropagation(),s.current=!1;return}n()},g=e>0;return o.jsx("button",{className:"play-button"+(t?" playing":" paused"),onClick:h,onMouseDown:f,onMouseUp:_,onMouseLeave:x,onTouchStart:b,onTouchEnd:y,"aria-label":t?"Pause":"Play",children:g?o.jsx("span",{className:"play-button-count",children:e}):t?o.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):o.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})})}function Ae(t,n={}){const{delay:e=500,interval:a=100,shouldStop:r,clickCallback:s}=n,i=C.useRef(null),c=C.useRef(null),f=C.useRef(!1),_=C.useRef(0),x=C.useRef(!1),b=C.useRef(t);b.current=t;const y=C.useCallback(()=>{f.current=!1,i.current&&(clearTimeout(i.current),i.current=null),c.current&&(clearInterval(c.current),c.current=null)},[]),h=C.useCallback(()=>{f.current||(f.current=!0,_.current=Date.now(),x.current=!1,i.current=setTimeout(()=>{if(f.current){if(r!=null&&r()){y();return}x.current=!0,b.current(),c.current=setInterval(()=>{if(f.current){if(r!=null&&r()){y();return}b.current()}},a)}},e))},[e,a,r,y]),g=C.useCallback(()=>{const P=Date.now()-_.current;!x.current&&P<e&&(s?s():b.current())},[e,s]),u=C.useCallback(()=>{h()},[h]),m=C.useCallback(()=>{y()},[y]),p=C.useCallback(()=>{y()},[y]),v=C.useCallback(P=>{h()},[h]),S=C.useCallback(P=>{y()},[y]),k=C.useCallback(P=>{y()},[y]),E=C.useCallback(P=>{P.preventDefault()},[]);return C.useEffect(()=>()=>{y()},[y]),{onClick:g,onMouseDown:u,onMouseUp:m,onMouseLeave:p,onTouchStart:v,onTouchEnd:S,onTouchCancel:k,onContextMenu:E}}function sa({bpm:t,timeSignature:n,isPlaying:e,resetToken:a,onBPMChange:r,isPatternPlaying:s=!1,isCountInPlaying:i=!1,countInBeat:c,onPatternPlayToggle:f,onTimeSignatureChange:_,rateIndex:x,onRateIndexChange:b,rates:y,rateLabels:h,patternPlayButton:g}){const u=C.useMemo(()=>[[4,4],[3,4],[2,4],[6,8],[5,4],[7,8]],[]),m=C.useCallback(()=>{const N=u.findIndex(I=>I[0]===n[0]&&I[1]===n[1]);return N>=0?N:0},[n,u]),[p,v]=C.useState(()=>{const N=u.findIndex(I=>I[0]===n[0]&&I[1]===n[1]);return N>=0?N:0});C.useEffect(()=>{const N=m();v(N)},[m]);const S=()=>{if(_){const N=(p+1)%u.length,I=u[N];v(N),_(I)}},{currentBeat:k}=Er({bpm:t,timeSignature:n,isPlaying:s,resetToken:a}),[E,P]=C.useState(0),T=C.useRef(-1);C.useEffect(()=>{const N=n[0];T.current===N-1&&k===0&&P(I=>I+1),T.current=k},[k,n]),C.useEffect(()=>{s||(T.current=-1,P(0))},[s]);const L=()=>{P(0)},R=40,O=200,M=()=>{const N=Math.round(Math.max(R,t-1)*10)/10;r(N)},w=()=>{const N=Math.round(Math.min(O,t+1)*10)/10;r(N)},A=()=>{const N=Math.round(Math.max(R,t-.5)*10)/10;r(N)},d=()=>{const N=Math.round(Math.min(O,t+.5)*10)/10;r(N)},F=Ae(M,{shouldStop:()=>t<=R,clickCallback:A}),q=Ae(w,{shouldStop:()=>t>=O,clickCallback:d}),z=N=>{y.length&&b(N)},Q=()=>{z(x+1)},H=()=>{y.length&&z(x+y.length-1)},X=i&&c!==void 0?c:k;return o.jsxs("div",{className:"metronome-bar",children:[o.jsxs("div",{className:"metronome-row metronome-row-top",children:[o.jsx("div",{className:"beat-indicator-group",onClick:S,children:o.jsx(na,{currentBeat:X,beatsPerBar:n[0]})}),o.jsxs("div",{className:"bpm-control-group",children:[o.jsx("button",{className:"bpm-control-button",...F,disabled:t<=R||!!h[x%h.length],"aria-label":"Decrease BPM",children:o.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsxs("div",{className:"bpm-display",children:[o.jsxs("span",{className:"bpm-value",children:[o.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-left",onClick:Q,"aria-label":"BPM rate next"}),o.jsx("span",{className:"bpm-value-clickable bpm-value-clickable-right",onClick:H,"aria-label":"BPM rate prev"}),(()=>{const N=Math.round(t*10)/10,I=N!==Math.round(t),Y=Math.floor(N),Z=I?String(N).split(".")[1]:null;return o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"bpm-value-integer",children:Y}),Z&&o.jsxs("span",{className:"bpm-value-decimal",children:[".",Z]})]})})()]}),h[x%h.length]&&o.jsx("span",{className:"bpm-rate-label",children:h[x%h.length]})]}),o.jsx("button",{className:"bpm-control-button",...q,disabled:t>=O||!!h[x%h.length],"aria-label":"Increase BPM",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),o.jsx("div",{className:"loop-count-group",children:g||f&&o.jsx(ra,{isPlaying:s,onClick:f,loopCount:E,onResetCount:L})})]}),o.jsx("div",{className:"metronome-row metronome-row-bottom",children:o.jsx(ta,{bpm:t,onChange:r,disabled:!!h[x%h.length]})})]})}function oa(t,n,e,a){return e+2*a+t*a}function aa(t){return bs[t]}const qe=7,Se=qe*.707,Mn=.8,Le=10,Pt=18,tt=Pt,ut=5*Pt;function ia({pattern:t,cellSize:n,currentBeat:e,scrollContainerRef:a,onDoubleClick:r}){const s=C.useRef(null),i=C.useRef(null),c=n,f=L=>{if(!r)return;const R=s.current;if(!R)return;const O=R.getBoundingClientRect(),M=L.clientX-O.left,w=Math.floor(M/c);r(w)},_=C.useRef(null),x=300,b=30,y=L=>{if(!r)return;const R=s.current;if(!R)return;const O=L.touches[0],M=Date.now(),w=R.getBoundingClientRect(),A=O.clientX-w.left;if(_.current){const{time:d,x:F}=_.current,q=M-d,z=Math.abs(A-F);if(q<x&&z<b){const Q=Math.floor(A/c);r(Q),_.current=null;return}}_.current={time:M,x:A}},h=L=>getComputedStyle(document.documentElement).getPropertyValue(L).trim(),g=h("--color-text"),u=h("--color-text-tertiary"),m=h("--color-beat-line"),p=h("--color-warning"),[v]=t.timeSignature,k=t.bars*v*me*c,E=ut+tt,P=Array.from({length:t.bars+1},(L,R)=>({x:R*v*me*c,isFirst:R===0,isLast:R===t.bars})),T=Array.from({length:t.bars*v+1},(L,R)=>({x:R*me*c}));return o.jsx("div",{className:"drum-notation-container",ref:i,children:o.jsxs("svg",{ref:s,className:"drum-notation-svg",viewBox:`0 0 ${k} ${E}`,width:k,height:E,preserveAspectRatio:"none",onDoubleClick:f,onTouchStart:y,children:[o.jsx("line",{x1:0,y1:0,x2:k,y2:0,stroke:g,strokeWidth:2,opacity:.8}),Array.from({length:6},(L,R)=>{const O=tt+R*Pt,M=R===0;return o.jsx("line",{x1:0,y1:O,x2:k,y2:O,stroke:g,strokeWidth:R===5?2:1,opacity:.8,strokeDasharray:M?"4,4":"0"},`staff-line-${R}`)}),P.map((L,R)=>o.jsx("line",{x1:L.x,y1:0,x2:L.x,y2:tt+ut,stroke:L.isFirst||L.isLast?g:u,strokeWidth:L.isFirst||L.isLast?3:2,strokeDasharray:L.isFirst||L.isLast?"0":"4,4",opacity:L.isFirst||L.isLast?1:.6},`bar-line-${R}`)),T.map((L,R)=>R%v===0?null:o.jsx("line",{x1:L.x,y1:0,x2:L.x,y2:tt+ut,stroke:m,strokeWidth:1,opacity:.4},`beat-line-${R}`)),e!==void 0&&e>=0&&o.jsx("rect",{x:e*c,y:0,width:c,height:tt+ut,fill:p,opacity:.4}),t.grid.map((L,R)=>{const O=t.drums[R],M=aa(O),w=oa(M.line,ut,tt,Pt);return L.map((A,d)=>{if(!A)return null;const F=d*c+c/2,q=M.symbol,z=`symbol-${R}-${d}`,Q=A===Pe,H=A===We,X=A===Me,N=A===Fe,I=A===Ue,Y=c*.22,Z=X||N||I?[...X||N?[F-Y]:[],...X||I?[F+Y]:[]]:[F],V=K=>{const re=[],le=K-qe-Mn,ce=K+qe+Mn,ue=w-Le/2,pe=w+Le/2,be=w-Le/2,l=w+Le/2;return Q?(re.push(o.jsx("path",{d:`M ${le} ${ue}
                        A ${Le} ${Le} 0 0 0 ${le} ${pe}`,fill:"none",stroke:g,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${K}`)),re.push(o.jsx("path",{d:`M ${ce} ${be}
                        A ${Le} ${Le} 0 0 1 ${ce} ${l}`,fill:"none",stroke:g,strokeWidth:1.5,strokeLinecap:"round"},`right-bracket-${K}`))):H&&re.push(o.jsx("path",{d:`M ${le} ${ue}
                        A ${Le} ${Le} 0 0 0 ${le} ${pe}`,fill:"none",stroke:g,strokeWidth:1.5,strokeLinecap:"round"},`left-bracket-${K}`)),re},se=K=>{if(O==="Crash 1"||O==="Crash 2")return o.jsxs("g",{children:[o.jsx("circle",{cx:K,cy:w,r:qe,fill:"none",stroke:g,strokeWidth:2}),o.jsx("line",{x1:K-Se,y1:w-Se,x2:K+Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"}),o.jsx("line",{x1:K+Se,y1:w-Se,x2:K-Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"}),V(K)]},`${z}-${K}`);let re=null;switch(q){case"x":re=o.jsxs("g",{children:[o.jsx("line",{x1:K-Se,y1:w-Se,x2:K+Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"}),o.jsx("line",{x1:K+Se,y1:w-Se,x2:K-Se,y2:w+Se,stroke:g,strokeWidth:2,strokeLinecap:"round"})]});break;case"o":re=o.jsx("circle",{cx:K,cy:w,r:qe,fill:"none",stroke:g,strokeWidth:2});break;case"●":re=o.jsx("circle",{cx:K,cy:w,r:qe,fill:g});break;case"○":re=o.jsx("circle",{cx:K,cy:w,r:qe,fill:"none",stroke:g,strokeWidth:2});break;default:return null}return o.jsxs("g",{children:[re,V(K)]},`${z}-${K}`)};return Z.map(K=>se(K))})})]})})}const ca=[{base:1,dots:0,units32:32},{base:2,dots:1,units32:24},{base:2,dots:0,units32:16},{base:4,dots:1,units32:12},{base:4,dots:0,units32:8},{base:8,dots:1,units32:6},{base:8,dots:0,units32:4},{base:16,dots:1,units32:3},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}],la=[{base:4,dots:0,units32:8},{base:8,dots:0,units32:4},{base:16,dots:0,units32:2},{base:32,dots:0,units32:1}];function ua(t){if(!Number.isFinite(t)||t<=0)throw new Error(`gapUnits32 must be > 0, got: ${t}`);const n=ca.find(e=>e.units32<=t);return n||{base:32,dots:0,units32:1}}function St(t){if(!Number.isFinite(t)||t<0)throw new Error(`gapUnits32 must be >= 0, got: ${t}`);const n=[];let e=t;for(;e>0;){const a=la.find(r=>r.units32<=e);if(!a)break;n.push(a),e-=a.units32}return n}const mt={"Crash 1":{keys:["b/5/x"],isLowerVoice:!1},"Crash 2":{keys:["a/5/x"],isLowerVoice:!1},"Hi-Hat Open":{keys:["g/5/x"],isLowerVoice:!1},"Hi-Hat Closed":{keys:["g/5/x"],isLowerVoice:!1},Ride:{keys:["f/5/x"],isLowerVoice:!1},"Tom 1":{keys:["e/5"],isLowerVoice:!1},"Tom 2":{keys:["d/5"],isLowerVoice:!1},Snare:{keys:["c/5"],isLowerVoice:!1},"Tom 3":{keys:["a/4"],isLowerVoice:!1},Kick:{keys:["f/4"],isLowerVoice:!0}};function da(t){const n=[],e=[],[a]=t.timeSignature,r=t.bars*a*me;for(let s=0;s<r;s++){const i=()=>({0:{normal:[],ghost:[],grace:[]},1:{normal:[],ghost:[],grace:[]}}),c=i(),f=i();let _=!1,x=!1;t.drums.forEach((y,h)=>{var p;const g=((p=t.grid[h])==null?void 0:p[s])??Ce;if(g===Ce)return;const u=mt[y].isLowerVoice?f:c,m=(v,S)=>{u[S][v].push({drum:y,cellState:g})};g===Me?(m("normal",0),m("normal",1),mt[y].isLowerVoice?x=!0:_=!0):g===Fe?(m("normal",0),mt[y].isLowerVoice?x=!0:_=!0):g===Ue?(m("normal",1),mt[y].isLowerVoice?x=!0:_=!0):g===We?y==="Snare"?(m("normal",0),m("grace",0)):m("normal",0):m(g===Pe?"ghost":"normal",0)});const b=(y,h,g,u)=>{const m=h[g],p=[...m.normal.map(v=>({...v,kind:"normal"})),...m.ghost.map(v=>({...v,kind:"ghost"}))];if(p.length>0){const S=p.every(k=>k.kind==="ghost")?"ghost":"normal";y.push({subdivision:s,subPosition:g,drums:p,is32nd:u,kind:S,graceDrums:m.grace.length>0?[...m.grace]:void 0})}};b(n,c,0,_),b(n,c,1,!0),b(e,f,0,x),b(e,f,1,!0)}return{upperVoice:n,lowerVoice:e}}function fa(t,n,e={}){const a=e.includeFullBarRestWhenEmpty??!1,r=e.omitTailRests??!0,s=e.maxSpanBarFraction??.25,i=n*2,c=s===.25?i/4:i,f=[...t].sort((h,g)=>h.subdivision!==g.subdivision?h.subdivision-g.subdivision:h.subPosition-g.subPosition),_=h=>h.subdivision*2+h.subPosition,x=[];let b=0;const y=h=>{if(c<=0)return 1;const g=h%c;return g===0?c:c-g};if(f.length===0){if(!a)return x;const h=St(i);for(const g of h)x.push({kind:"rest",startUnits32InBar:b,durationToken:g,durationUnits32:g.units32}),b+=g.units32;return x}for(let h=0;h<f.length;h++){const g=f[h],u=_(g),m=h+1<f.length?_(f[h+1]):i;if(u>b){const P=u-b,T=St(P);for(const L of T)x.push({kind:"rest",startUnits32InBar:b,durationToken:L,durationUnits32:L.units32}),b+=L.units32}b=Math.max(b,u);const p=Math.max(1,m-u),v=y(u),S=Math.max(1,Math.min(p,v)),k=ua(S);x.push({kind:"note",event:g,startUnits32InBar:u,durationToken:k,durationUnits32:k.units32}),b=u+k.units32;const E=h+1>=f.length;if(!E&&b<m){const P=m-b,T=St(P);for(const L of T)x.push({kind:"rest",startUnits32InBar:b,durationToken:L,durationUnits32:L.units32}),b+=L.units32}if(E&&!r&&b<i){const P=i-b,T=St(P);for(const L of T)x.push({kind:"rest",startUnits32InBar:b,durationToken:L,durationUnits32:L.units32}),b+=L.units32}}return x}function ha(t){var a;const n=t,e=(a=n.getXShift)==null?void 0:a.call(n);return typeof e=="number"?e:typeof n.x_shift=="number"?n.x_shift:0}function Tr(t){const n=is;typeof n.buildAndAttach=="function"&&n.buildAndAttach([t],{all:!0})}function ma(t,n,e,a,r,s){const i=t-a;if(s){if(s===4)return(i+1.5)*e+e/2;if(s===8)return(i+.5)*e+e/2}const c=i*e+e/2;if(!r)return c;const f=e*.22;return n===0?c-f:c+f}function pa(t,n){if(!n.includes("Hi-Hat Open"))return;const e=new rt("○");e.setVerticalJustification(rt.VerticalJustify.TOP),e.setJustification(rt.HorizontalJustify.CENTER_STEM),e.setFont("",5,900),e.setXShift(-11),e.setYShift(36),t.addModifier(e,0)}function ga(t,n){if(!n||n.length===0)return;const e=new rt("♪");e.setVerticalJustification(rt.VerticalJustify.BOTTOM),e.setJustification(rt.HorizontalJustify.CENTER_STEM),e.setFont("",15,"normal"),e.setXShift(10),e.setYShift(-55),t.addModifier(e,0)}function ba(t,n,e){const a=[];let r;for(const{drum:f}of t.drums){const _=mt[f];a.push(..._.keys),r=_.keys.some(x=>x.includes("x"))}const s={keys:a,duration:String(e.base),clef:"percussion",stemDirection:n?-1:1},i=new er(s);e.dots===1&&Tr(i);const c=t.drums.filter(f=>f.kind==="ghost").map(f=>f.drum);if(c.length>0&&(i._ghostDrums=c),r&&!n){const f=i.getStem();f&&f.setOptions({stemUpYOffset:4})}return pa(i,t.drums.map(f=>f.drum)),ga(i,t.graceDrums),i}function va(t,n){const e=`${t.base}r`,a=n?["f/4"]:["c/5"],r=new er({keys:a,duration:e,clef:"percussion",stemDirection:n?-1:1});return t.dots===1&&Tr(r),r}function On(t,n,e){const a=fa(t,n,{includeFullBarRestWhenEmpty:!0,omitTailRests:!1,maxSpanBarFraction:.25});return a.some(s=>s.kind==="note")?a.map(s=>{if(s.kind==="note")return{note:ba(s.event,e,s.durationToken),event:s.event,isRest:!1,startUnits32InBar:s.startUnits32InBar,durationUnits32:s.durationUnits32};const i=s.startUnits32InBar,c={subdivision:Math.floor(i/2),subPosition:i%2,drums:[],is32nd:i%2===1,kind:"normal"};return{note:va(s.durationToken,e),event:c,isRest:!0,startUnits32InBar:s.startUnits32InBar,durationUnits32:s.durationUnits32}}):[]}function ya(t,n){const e=n*2,a=Math.floor(e/2);let r=!1,s=!1;for(const i of t){if(i.isRest)continue;const c=i.note.getDuration();Number.parseInt(c.replace(/[rd]/g,""),10)>=16&&((i.startUnits32InBar??i.event.subdivision*2+i.event.subPosition)<a?r=!0:s=!0)}return[r,s]}function xa(t,n){const e=n*2,a=Math.floor(e/2),r=[],s=[];for(const i of t)(i.startUnits32InBar??i.event.subdivision*2+i.event.subPosition)<a?r.push(i):s.push(i);return[r,s]}function wa(t,n,e){return(t+n/2)/2*e-e/4*1.2}function ka(t,n,e){const a=n*2,r=Math.floor(a/e),s=Array.from({length:e},()=>[]);for(const i of t){const c=i.startUnits32InBar??i.event.subdivision*2+i.event.subPosition,f=Math.floor(c/r);f>=0&&f<e&&s[f].push(i)}return s.filter(i=>i.length>0)}const Rt=130,_a=40,Sa=35,Ba=(Rt-_a)/2-Sa;function Ca({pattern:t,cellSize:n,currentBeat:e,scrollContainerRef:a,onDoubleClick:r}){const s=C.useRef(null),i=n,c=C.useRef(null),f=300,_=30,[x]=t.timeSignature,b=t.bars*x*me,y=b*i,h=x*me*i,[g,u]=C.useState([]),m=1,p=C.useCallback(()=>{if(!a||!a.current||!s.current)return;const P=a.current,T=s.current,L=P.getBoundingClientRect(),R=T.getBoundingClientRect(),O=L.left-R.left,M=O+L.width,w=Math.max(0,Math.floor(O/h)),A=Math.min(t.bars-1,Math.ceil(M/h)),d=[],F=Math.max(0,w-m),q=Math.min(t.bars-1,A+m);for(let z=F;z<=q;z++)d.push(z);u(d)},[a,h,t.bars]);C.useEffect(()=>{p();const P=a==null?void 0:a.current;if(!P)return;const T=()=>{requestAnimationFrame(p)};return P.addEventListener("scroll",T,{passive:!0}),window.addEventListener("resize",p),()=>{P.removeEventListener("scroll",T),window.removeEventListener("resize",p)}},[a,p]);const v=C.useMemo(()=>new Set(g),[g]),S=C.useCallback(P=>{const T=s.current;if(!T)return 0;const L=T.getBoundingClientRect(),R=P-L.left;return Math.floor(R/i)},[i]),k=C.useCallback(P=>{if(!r)return;const T=S(P.clientX);r(T)},[r,S]),E=C.useCallback(P=>{if(!r)return;const T=P.touches[0],L=Date.now(),R=T.clientX;if(c.current){const{time:O,x:M}=c.current,w=L-O,A=Math.abs(R-M);if(w<f&&A<_){const d=S(R);r(d),c.current=null;return}}c.current={time:L,x:R}},[r,S]);return C.useEffect(()=>{var O,M;const P=s.current;if(!P)return;P.innerHTML="";const T=new kn(P,kn.Backends.SVG);T.resize(y,Rt);const L=T.getContext();for(let w=0;w<t.bars;w++){if(!v.has(w))continue;const A=w*h,d=new cs(A,Ba,h);d.setContext(L),w===t.bars-1&&d.setEndBarType(ls.type.END),d.draw();const{upperVoice:F,lowerVoice:q}=da(t),z=w*x*me,Q=(w+1)*x*me,H=F.filter(se=>se.subdivision>=z&&se.subdivision<Q),X=q.filter(se=>se.subdivision>=z&&se.subdivision<Q),N=x*me,I=On(H.map(se=>({...se,subdivision:se.subdivision-z})),N,!1).map(se=>({...se,event:{...se.event,subdivision:se.event.subdivision+z}})),Y=On(X.map(se=>({...se,subdivision:se.subdivision-z})),N,!0).map(se=>({...se,event:{...se.event,subdivision:se.event.subdivision+z}})),Z=I,V=Y;if(Z.length>0||V.length>0){const se=[],K=[...Z,...V];if(Z.length>0){const ce=new _n({numBeats:x,beatValue:4}).setStrict(!1);ce.addTickables(Z.map(ue=>ue.note)),se.push(ce)}if(V.length>0){const ce=new _n({numBeats:x,beatValue:4}).setStrict(!1);ce.addTickables(V.map(ue=>ue.note)),se.push(ce)}se.length>0&&new us().joinVoices(se).format(se,h-20);for(const ce of K){const{note:ue,event:pe,isRest:be,startUnits32InBar:l,durationUnits32:$}=ce;let W;be&&l!==void 0&&$?W=wa(l,$,i):W=ma(pe.subdivision,pe.subPosition,i,z,pe.is32nd)-i/4,ue.setStave(d);const j=d.getX()+W,B=ue.getAbsoluteX(),D=j-B;ue.setXShift(ha(ue)+D)}const re=[],le=[{notes:Z,stemDirection:1},{notes:V,stemDirection:-1}];for(const{notes:ce,stemDirection:ue}of le){const pe=ce.filter(B=>{const D=B.note.getDuration(),G=Number.parseInt(D.replace(/[rd]/g,""),10);return Number.isFinite(G)&&G>=8});if(pe.length===0)continue;const[be,l]=ya(pe,N),[$,W]=xa(pe,N),j=[{notes:$,hasSixteenth:be},{notes:W,hasSixteenth:l}];for(const{notes:B,hasSixteenth:D}of j)if(B.length!==0)if(D){const G=ka(B,N,x);for(const J of G){if(J.length===0)continue;const U=Sn.generateBeams(J.map(ee=>ee.note),{stemDirection:ue,flatBeams:!0,groups:[new Bn(1,4)]});re.push(...U)}}else{const G=Sn.generateBeams(B.map(J=>J.note),{stemDirection:ue,flatBeams:!0,groups:[new Bn(1,2)]});re.push(...G)}}se.forEach(ce=>ce.draw(L,d)),re.forEach(ce=>ce.setContext(L).draw());for(const ce of K){const ue=ce.note;if(ue._ghostDrums&&ue._ghostDrums.length>0&&ue.noteHeads){const pe=new Set(ue._ghostDrums),be=ce.event.drums.map(l=>l.drum);for(let l=0;l<ue.noteHeads.length;l++){const $=ue.noteHeads[l];if(!$)continue;const W=be[l];if(!W||!pe.has(W))continue;const j=((O=$.getSVGElement)==null?void 0:O.call($))??$.el;if(j){const B=(M=j.getBBox)==null?void 0:M.call(j);if(B){const D=B.x+B.width/2,G=B.y+B.height/2;j.setAttribute("transform",`translate(${D}, ${G}) scale(0.75) translate(${-D+(W==="Kick"?-2:2)}, ${-G})`)}}}}}}}const R=P.querySelector("svg");if(R&&(R.querySelectorAll(".vf-stave").forEach(d=>{d.setAttribute("stroke","#aaa")}),R.querySelectorAll(".vf-stavebarline").forEach(d=>{d.querySelectorAll("rect").forEach(q=>{q.setAttribute("stroke","transparent"),q.setAttribute("fill","#333")})})),e!==void 0&&e>=0){const w=P.querySelector("svg");if(w){const A=document.createElementNS("http://www.w3.org/2000/svg","rect");A.setAttribute("x",String(e*i)),A.setAttribute("y","0"),A.setAttribute("width",String(i)),A.setAttribute("height",String(Rt)),A.setAttribute("fill","#fbbf24"),A.setAttribute("opacity","0.3"),A.setAttribute("stroke","transparent"),w.insertBefore(A,w.firstChild)}}},[t,e,i,y,x,b,h,v]),o.jsx(o.Fragment,{children:o.jsx("div",{className:"drum-notation-container vexflow-renderer",ref:s,onDoubleClick:k,onTouchStart:E,style:{width:y,height:Rt,backgroundColor:"#ffffff"}})})}const Dn="drummer-renderer-change";function ja(t){const[n,e]=C.useState(()=>An()),[a,r]=C.useState(!1);C.useEffect(()=>{const c=()=>{e(An()),r(!1)};return window.addEventListener(Dn,c),()=>{window.removeEventListener(Dn,c)}},[]);const s=C.useCallback(()=>{console.error("VexFlow rendering failed, falling back to Legacy renderer"),r(!0)},[]);return C.useMemo(()=>n==="vexflow"&&!a,[n,a])?o.jsx(Ea,{onError:s,children:o.jsx(Ca,{...t})}):o.jsx(ia,{...t})}class Ea extends C.Component{constructor(n){super(n),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(n,e){console.error("VexFlow rendering error:",n,e),this.props.onError()}render(){return this.state.hasError?null:this.props.children}}const zn=300,Fn=200,Ta=30;function Ra({cellState:t,onClick:n,onToggleGhost:e,onDoubleClick:a,isCurrentBeat:r,drumType:s,subdivisionIndex:i=0,style:c}){const f=C.useRef(0),_=100,x=C.useRef(0),b=C.useRef(null),y=C.useRef(null),h=C.useRef(!1),g=C.useRef(0),u=C.useRef(!1),m=C.useRef(null),[p,v]=C.useState(!1),S=t!==Ce,k=t===Pe,E=t===We,P=t===Me,T=t===Fe,L=t===Ue,R=P||T||L,O=Math.floor(i/4)%2===1,M=C.useCallback(()=>{const F=Date.now();F-f.current<_||(f.current=F,s&&!S&&sn(s),n())},[s,S,n]),w=C.useCallback(F=>{F.button!==0&&F.pointerType==="mouse"||(g.current=Date.now(),u.current=!1,h.current=!0,v(!0),m.current=window.setTimeout(()=>{if(u.current=!0,h.current=!1,S&&!R&&(e(),s)){let q;t===Re?q=Pe:t===Pe?q=We:q=Re,sn(s,q===Pe?.3:1)}v(!1)},zn))},[S,e,s,t,R]),A=C.useCallback(()=>{const F=u.current,q=h.current;if(m.current&&(clearTimeout(m.current),m.current=null),y.current=window.setTimeout(()=>{v(!1)},Ta),F){u.current=!1;return}if(Date.now()-g.current<zn&&q){const Q=Date.now();if(Q-x.current<Fn){x.current=0,b.current&&(clearTimeout(b.current),b.current=null),a&&a();return}x.current=Q,b.current&&clearTimeout(b.current),b.current=window.setTimeout(()=>{M(),b.current=null},Fn)}},[M,a]),d=C.useCallback(()=>{m.current&&(clearTimeout(m.current),m.current=null),y.current&&(clearTimeout(y.current),y.current=null),v(!1),u.current&&(u.current=!1),h.current=!1},[]);return o.jsx("button",{className:`grid-cell ${S?"active":""} ${k?"ghost":""} ${E?"grace":""} ${R?"thirty-second":""} ${P?"double-32":""} ${T?"first-32":""} ${L?"second-32":""} ${r?"current-beat":""} ${O?"alt-beat":""} ${p?"pressing":""}`,style:c,onPointerDown:w,onPointerUp:A,onPointerLeave:d,onPointerCancel:d,type:"button","aria-label":E?"Grace note":k?"Ghost note":S?"Active":"Inactive",children:R&&o.jsxs("div",{className:`cell-32-dots ${P?"double":T?"first":"second"}`,"aria-hidden":"true",children:[(P||T)&&o.jsx("span",{className:"dot left"}),(P||L)&&o.jsx("span",{className:"dot right"})]})})}function Aa(t,n,e,a,r){const s=t,i=s+n,c=Math.max(0,Math.floor(s/e)-a),f=Math.min(r,Math.ceil(i/e)+a);return{start:c,end:f}}function Ia(t,n,e){const{itemSize:a,totalItems:r,bufferItems:s=0}=e,i=C.useRef(!1),[c,f]=C.useState(()=>({start:0,end:Math.min(r,Math.ceil(window.innerWidth/a)+s*2)})),_=C.useCallback(()=>{const y=t==null?void 0:t.current,h=n.current;if(!y||!h)return;i.current||(i.current=!0);const g=y.clientWidth;if(r*a<=g){f({start:0,end:r});return}const u=Aa(y.scrollLeft,g,a,s,r);f(m=>m.start===u.start&&m.end===u.end?m:u)},[t,n,a,s,r]),x=t==null?void 0:t.current;C.useLayoutEffect(()=>{if(!x)return;_();let y;const h=()=>{y&&cancelAnimationFrame(y),y=requestAnimationFrame(_)};return x.addEventListener("scroll",h,{passive:!0}),window.addEventListener("resize",_),()=>{y&&cancelAnimationFrame(y),x.removeEventListener("scroll",h),window.removeEventListener("resize",_)}},[x,_]);const b=C.useMemo(()=>new Set(Array.from({length:c.end-c.start},(y,h)=>c.start+h)),[c]);return{...c,visibleSet:b}}function Na({pattern:t,cellSize:n,onCellClick:e,onToggleGhost:a,onCellDoubleClick:r,currentBeat:s,scrollContainerRef:i}){var y;const c=C.useRef(null),f=((y=t.grid[0])==null?void 0:y.length)||0,_=f*n,x=me*2,{visibleSet:b}=Ia(i,c,{itemSize:n,totalItems:f,bufferItems:x});return o.jsx("div",{className:"grid-container",children:o.jsx("div",{className:"grid-wrapper",children:o.jsx("div",{className:"grid-content",ref:c,style:{width:`${_}px`},children:o.jsx("div",{className:"grid-rows",children:t.grid.map((h,g)=>{const u=t.drums[g];return o.jsx("div",{className:"grid-row",style:{width:`${_}px`},children:h.map((m,p)=>{if(!b.has(p))return null;const v=s!==void 0&&p===s;return o.jsx(Ra,{cellState:m,onClick:()=>e(g,p),onDoubleClick:()=>r(g,p),onToggleGhost:()=>a(g,p),isCurrentBeat:v,drumType:u,subdivisionIndex:p,style:{left:`${p*n}px`}},p)})},g)})})})})})}function Pa({pattern:t,cellSize:n}){var s;const[e]=t.timeSignature,r=(((s=t.grid[0])==null?void 0:s.length)||0)*n;return o.jsx("div",{className:"grid-container",children:o.jsx("div",{className:"grid-wrapper",children:o.jsx("div",{className:"grid-content",style:{width:`${r}px`},children:o.jsx("div",{className:"grid-beat-labels",children:Array.from({length:t.bars},(i,c)=>{const f=e*me;return o.jsx("div",{className:"grid-beat-label-group",style:{width:`${f*n}px`},children:Array.from({length:e},(_,x)=>{const b=x*me;return o.jsxs("div",{className:"grid-beat-label",style:{width:`${me*n}px`,left:`${b*n}px`},children:[c+1,".",x+1]},x)})},c)})})})})})}function La({bars:t,onAddBar:n,onRemoveBar:e,canRemove:a,currentBeat:r}){return o.jsx("div",{className:"bar-controls",children:o.jsxs("span",{className:"bar-count",children:[o.jsx("button",{className:"bar-control-button",onClick:()=>e(r),disabled:!a,"aria-label":"Remove bar",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),t,o.jsx("button",{className:"bar-control-button",onClick:()=>n(r),"aria-label":"Add bar",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})}function Ma({currentPattern:t,savedPatterns:n,crossPatternLoop:e,onCrossPatternLoopChange:a,isDraftMode:r}){const s=C.useRef(t.bars),i=[...n].sort((M,w)=>M.name.localeCompare(w.name)),c=M=>{if(r&&M===""||!r&&M===t.name)return t.bars;const w=n.find(A=>A.name===M);return(w==null?void 0:w.bars)??t.bars},f=M=>M===""||M===t.name?!0:n.some(w=>w.name===M),_={startPatternName:r?"":t.name,startBar:0,endPatternName:r?"":t.name,endBar:t.bars-1};C.useEffect(()=>{if(!e)return;const M=r?"":t.name,w=(d,F)=>d===F?0:d===""?-1:F===""?1:d.localeCompare(F);(()=>{const{startPatternName:d,endPatternName:F}=e;return d===F?d===M:M===d||M===F?!0:w(d,M)<0&&w(M,F)<0})()||a({startPatternName:M,startBar:0,endPatternName:M,endBar:t.bars-1})},[r,t.name,e,a,t.bars]);const x=(M,w,A,d)=>M===A?w-d:M===""?-1:A===""?1:M.localeCompare(A),b=e??_;C.useEffect(()=>{if(!e||!f(e.startPatternName)||!f(e.endPatternName))return;const M=c(e.startPatternName),w=c(e.endPatternName);let A=!1;const d={...e};e.startBar>=M&&(d.startBar=Math.max(0,M-1),A=!0),e.endBar>=w&&(d.endBar=Math.max(0,w-1),A=!0);const F=r?e.endPatternName==="":e.endPatternName===t.name,q=e.startPatternName!==e.endPatternName;if(F&&!q){const z=t.bars-1,Q=s.current,H=t.bars>Q,X=d.endBar===Q-1;H&&X&&(d.endBar=z,A=!0)}A&&x(d.startPatternName,d.startBar,d.endPatternName,d.endBar)>0&&(d.endBar=d.startBar),A&&a(d),s.current=t.bars},[t.bars,r,t.name,n]);const y=r?[{name:"",label:"○"},...i.map(M=>({name:M.name,label:M.name}))]:i.map(M=>({name:M.name,label:M.name})),h=M=>{const w=c(M),A=Math.min(b.startBar,w-1);x(M,A,b.endPatternName,b.endBar)>0?a({startPatternName:M,startBar:A,endPatternName:M,endBar:A}):a({...b,startPatternName:M,startBar:A})},g=M=>{const w=c(M),A=Math.min(b.endBar,w-1);x(b.startPatternName,b.startBar,M,A)>0?a({startPatternName:M,startBar:A,endPatternName:M,endBar:A}):a({...b,endPatternName:M,endBar:A})},u=()=>{b.startBar>0&&a({...b,startBar:b.startBar-1})},m=()=>{const M=c(b.startPatternName)-1,w=Math.min(M,b.startBar+1);x(b.startPatternName,w,b.endPatternName,b.endBar)<=0&&a({...b,startBar:w})},p=()=>{const M=b.endBar-1;M>=0&&x(b.startPatternName,b.startBar,b.endPatternName,M)<=0&&a({...b,endBar:M})},v=()=>{const M=c(b.endPatternName)-1;b.endBar<M&&a({...b,endBar:b.endBar+1})},S=b.startBar>0,k=b.startBar<c(b.startPatternName)-1&&x(b.startPatternName,b.startBar+1,b.endPatternName,b.endBar)<=0,E=b.endBar>0&&x(b.startPatternName,b.startBar,b.endPatternName,b.endBar-1)<=0,P=b.endBar<c(b.endPatternName)-1,T=Ae(u,{shouldStop:()=>!S}),L=Ae(m,{shouldStop:()=>!k}),R=Ae(p,{shouldStop:()=>!E}),O=Ae(v,{shouldStop:()=>!P});return o.jsx("div",{className:"loop-range-selector",children:o.jsxs("div",{className:"loop-range-controls",children:[o.jsxs("div",{className:"loop-range-item",children:[o.jsx("select",{className:"loop-pattern-select",value:b.startPatternName,onChange:M=>h(M.target.value),children:y.map(M=>o.jsx("option",{value:M.name,children:M.label},M.name))}),o.jsx("button",{className:"loop-range-button",...T,disabled:!S,"aria-label":"Decrease start bar",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("span",{className:"loop-range-value",children:b.startBar+1}),o.jsx("button",{className:"loop-range-button",...L,disabled:!k,"aria-label":"Increase start bar",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),o.jsx("span",{className:"loop-range-separator",children:"-"}),o.jsxs("div",{className:"loop-range-item",children:[o.jsx("select",{className:"loop-pattern-select",value:b.endPatternName,onChange:M=>g(M.target.value),children:y.map(M=>o.jsx("option",{value:M.name,children:M.label},M.name))}),o.jsx("button",{className:"loop-range-button",...R,disabled:!E,"aria-label":"Decrease end bar",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("span",{className:"loop-range-value",children:b.endBar+1}),o.jsx("button",{className:"loop-range-button",...O,disabled:!P,"aria-label":"Increase end bar",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})})}function Bt(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Rr={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(t,n){(function(e){t.exports=e()})(function(){return function e(a,r,s){function i(_,x){if(!r[_]){if(!a[_]){var b=typeof Bt=="function"&&Bt;if(!x&&b)return b(_,!0);if(c)return c(_,!0);var y=new Error("Cannot find module '"+_+"'");throw y.code="MODULE_NOT_FOUND",y}var h=r[_]={exports:{}};a[_][0].call(h.exports,function(g){var u=a[_][1][g];return i(u||g)},h,h.exports,e,a,r,s)}return r[_].exports}for(var c=typeof Bt=="function"&&Bt,f=0;f<s.length;f++)i(s[f]);return i}({1:[function(e,a,r){var s=e("./utils"),i=e("./support"),c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(f){for(var _,x,b,y,h,g,u,m=[],p=0,v=f.length,S=v,k=s.getTypeOf(f)!=="string";p<f.length;)S=v-p,b=k?(_=f[p++],x=p<v?f[p++]:0,p<v?f[p++]:0):(_=f.charCodeAt(p++),x=p<v?f.charCodeAt(p++):0,p<v?f.charCodeAt(p++):0),y=_>>2,h=(3&_)<<4|x>>4,g=1<S?(15&x)<<2|b>>6:64,u=2<S?63&b:64,m.push(c.charAt(y)+c.charAt(h)+c.charAt(g)+c.charAt(u));return m.join("")},r.decode=function(f){var _,x,b,y,h,g,u=0,m=0,p="data:";if(f.substr(0,p.length)===p)throw new Error("Invalid base64 input, it looks like a data url.");var v,S=3*(f=f.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(f.charAt(f.length-1)===c.charAt(64)&&S--,f.charAt(f.length-2)===c.charAt(64)&&S--,S%1!=0)throw new Error("Invalid base64 input, bad content length.");for(v=i.uint8array?new Uint8Array(0|S):new Array(0|S);u<f.length;)_=c.indexOf(f.charAt(u++))<<2|(y=c.indexOf(f.charAt(u++)))>>4,x=(15&y)<<4|(h=c.indexOf(f.charAt(u++)))>>2,b=(3&h)<<6|(g=c.indexOf(f.charAt(u++))),v[m++]=_,h!==64&&(v[m++]=x),g!==64&&(v[m++]=b);return v}},{"./support":30,"./utils":32}],2:[function(e,a,r){var s=e("./external"),i=e("./stream/DataWorker"),c=e("./stream/Crc32Probe"),f=e("./stream/DataLengthProbe");function _(x,b,y,h,g){this.compressedSize=x,this.uncompressedSize=b,this.crc32=y,this.compression=h,this.compressedContent=g}_.prototype={getContentWorker:function(){var x=new i(s.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new f("data_length")),b=this;return x.on("end",function(){if(this.streamInfo.data_length!==b.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),x},getCompressedWorker:function(){return new i(s.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},_.createWorkerFrom=function(x,b,y){return x.pipe(new c).pipe(new f("uncompressedSize")).pipe(b.compressWorker(y)).pipe(new f("compressedSize")).withStreamInfo("compression",b)},a.exports=_},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,a,r){var s=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(){return new s("STORE compression")},uncompressWorker:function(){return new s("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,a,r){var s=e("./utils"),i=function(){for(var c,f=[],_=0;_<256;_++){c=_;for(var x=0;x<8;x++)c=1&c?3988292384^c>>>1:c>>>1;f[_]=c}return f}();a.exports=function(c,f){return c!==void 0&&c.length?s.getTypeOf(c)!=="string"?function(_,x,b,y){var h=i,g=y+b;_^=-1;for(var u=y;u<g;u++)_=_>>>8^h[255&(_^x[u])];return-1^_}(0|f,c,c.length,0):function(_,x,b,y){var h=i,g=y+b;_^=-1;for(var u=y;u<g;u++)_=_>>>8^h[255&(_^x.charCodeAt(u))];return-1^_}(0|f,c,c.length,0):0}},{"./utils":32}],5:[function(e,a,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,a,r){var s=null;s=typeof Promise<"u"?Promise:e("lie"),a.exports={Promise:s}},{lie:37}],7:[function(e,a,r){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",i=e("pako"),c=e("./utils"),f=e("./stream/GenericWorker"),_=s?"uint8array":"array";function x(b,y){f.call(this,"FlateWorker/"+b),this._pako=null,this._pakoAction=b,this._pakoOptions=y,this.meta={}}r.magic="\b\0",c.inherits(x,f),x.prototype.processChunk=function(b){this.meta=b.meta,this._pako===null&&this._createPako(),this._pako.push(c.transformTo(_,b.data),!1)},x.prototype.flush=function(){f.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},x.prototype.cleanUp=function(){f.prototype.cleanUp.call(this),this._pako=null},x.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var b=this;this._pako.onData=function(y){b.push({data:y,meta:b.meta})}},r.compressWorker=function(b){return new x("Deflate",b)},r.uncompressWorker=function(){return new x("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,a,r){function s(h,g){var u,m="";for(u=0;u<g;u++)m+=String.fromCharCode(255&h),h>>>=8;return m}function i(h,g,u,m,p,v){var S,k,E=h.file,P=h.compression,T=v!==_.utf8encode,L=c.transformTo("string",v(E.name)),R=c.transformTo("string",_.utf8encode(E.name)),O=E.comment,M=c.transformTo("string",v(O)),w=c.transformTo("string",_.utf8encode(O)),A=R.length!==E.name.length,d=w.length!==O.length,F="",q="",z="",Q=E.dir,H=E.date,X={crc32:0,compressedSize:0,uncompressedSize:0};g&&!u||(X.crc32=h.crc32,X.compressedSize=h.compressedSize,X.uncompressedSize=h.uncompressedSize);var N=0;g&&(N|=8),T||!A&&!d||(N|=2048);var I=0,Y=0;Q&&(I|=16),p==="UNIX"?(Y=798,I|=function(V,se){var K=V;return V||(K=se?16893:33204),(65535&K)<<16}(E.unixPermissions,Q)):(Y=20,I|=function(V){return 63&(V||0)}(E.dosPermissions)),S=H.getUTCHours(),S<<=6,S|=H.getUTCMinutes(),S<<=5,S|=H.getUTCSeconds()/2,k=H.getUTCFullYear()-1980,k<<=4,k|=H.getUTCMonth()+1,k<<=5,k|=H.getUTCDate(),A&&(q=s(1,1)+s(x(L),4)+R,F+="up"+s(q.length,2)+q),d&&(z=s(1,1)+s(x(M),4)+w,F+="uc"+s(z.length,2)+z);var Z="";return Z+=`
\0`,Z+=s(N,2),Z+=P.magic,Z+=s(S,2),Z+=s(k,2),Z+=s(X.crc32,4),Z+=s(X.compressedSize,4),Z+=s(X.uncompressedSize,4),Z+=s(L.length,2),Z+=s(F.length,2),{fileRecord:b.LOCAL_FILE_HEADER+Z+L+F,dirRecord:b.CENTRAL_FILE_HEADER+s(Y,2)+Z+s(M.length,2)+"\0\0\0\0"+s(I,4)+s(m,4)+L+F+M}}var c=e("../utils"),f=e("../stream/GenericWorker"),_=e("../utf8"),x=e("../crc32"),b=e("../signature");function y(h,g,u,m){f.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=u,this.encodeFileName=m,this.streamFiles=h,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}c.inherits(y,f),y.prototype.push=function(h){var g=h.meta.percent||0,u=this.entriesCount,m=this._sources.length;this.accumulate?this.contentBuffer.push(h):(this.bytesWritten+=h.data.length,f.prototype.push.call(this,{data:h.data,meta:{currentFile:this.currentFile,percent:u?(g+100*(u-m-1))/u:100}}))},y.prototype.openedSource=function(h){this.currentSourceOffset=this.bytesWritten,this.currentFile=h.file.name;var g=this.streamFiles&&!h.file.dir;if(g){var u=i(h,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:u.fileRecord,meta:{percent:0}})}else this.accumulate=!0},y.prototype.closedSource=function(h){this.accumulate=!1;var g=this.streamFiles&&!h.file.dir,u=i(h,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(u.dirRecord),g)this.push({data:function(m){return b.DATA_DESCRIPTOR+s(m.crc32,4)+s(m.compressedSize,4)+s(m.uncompressedSize,4)}(h),meta:{percent:100}});else for(this.push({data:u.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},y.prototype.flush=function(){for(var h=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var u=this.bytesWritten-h,m=function(p,v,S,k,E){var P=c.transformTo("string",E(k));return b.CENTRAL_DIRECTORY_END+"\0\0\0\0"+s(p,2)+s(p,2)+s(v,4)+s(S,4)+s(P.length,2)+P}(this.dirRecords.length,u,h,this.zipComment,this.encodeFileName);this.push({data:m,meta:{percent:100}})},y.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},y.prototype.registerPrevious=function(h){this._sources.push(h);var g=this;return h.on("data",function(u){g.processChunk(u)}),h.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),h.on("error",function(u){g.error(u)}),this},y.prototype.resume=function(){return!!f.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},y.prototype.error=function(h){var g=this._sources;if(!f.prototype.error.call(this,h))return!1;for(var u=0;u<g.length;u++)try{g[u].error(h)}catch{}return!0},y.prototype.lock=function(){f.prototype.lock.call(this);for(var h=this._sources,g=0;g<h.length;g++)h[g].lock()},a.exports=y},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,a,r){var s=e("../compressions"),i=e("./ZipFileWorker");r.generateWorker=function(c,f,_){var x=new i(f.streamFiles,_,f.platform,f.encodeFileName),b=0;try{c.forEach(function(y,h){b++;var g=function(v,S){var k=v||S,E=s[k];if(!E)throw new Error(k+" is not a valid compression method !");return E}(h.options.compression,f.compression),u=h.options.compressionOptions||f.compressionOptions||{},m=h.dir,p=h.date;h._compressWorker(g,u).withStreamInfo("file",{name:y,dir:m,date:p,comment:h.comment||"",unixPermissions:h.unixPermissions,dosPermissions:h.dosPermissions}).pipe(x)}),x.entriesCount=b}catch(y){x.error(y)}return x}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,a,r){function s(){if(!(this instanceof s))return new s;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var i=new s;for(var c in this)typeof this[c]!="function"&&(i[c]=this[c]);return i}}(s.prototype=e("./object")).loadAsync=e("./load"),s.support=e("./support"),s.defaults=e("./defaults"),s.version="3.10.1",s.loadAsync=function(i,c){return new s().loadAsync(i,c)},s.external=e("./external"),a.exports=s},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,a,r){var s=e("./utils"),i=e("./external"),c=e("./utf8"),f=e("./zipEntries"),_=e("./stream/Crc32Probe"),x=e("./nodejsUtils");function b(y){return new i.Promise(function(h,g){var u=y.decompressed.getContentWorker().pipe(new _);u.on("error",function(m){g(m)}).on("end",function(){u.streamInfo.crc32!==y.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):h()}).resume()})}a.exports=function(y,h){var g=this;return h=s.extend(h||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:c.utf8decode}),x.isNode&&x.isStream(y)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):s.prepareContent("the loaded zip file",y,!0,h.optimizedBinaryString,h.base64).then(function(u){var m=new f(h);return m.load(u),m}).then(function(u){var m=[i.Promise.resolve(u)],p=u.files;if(h.checkCRC32)for(var v=0;v<p.length;v++)m.push(b(p[v]));return i.Promise.all(m)}).then(function(u){for(var m=u.shift(),p=m.files,v=0;v<p.length;v++){var S=p[v],k=S.fileNameStr,E=s.resolve(S.fileNameStr);g.file(E,S.decompressed,{binary:!0,optimizedBinaryString:!0,date:S.date,dir:S.dir,comment:S.fileCommentStr.length?S.fileCommentStr:null,unixPermissions:S.unixPermissions,dosPermissions:S.dosPermissions,createFolders:h.createFolders}),S.dir||(g.file(E).unsafeOriginalName=k)}return m.zipComment.length&&(g.comment=m.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,a,r){var s=e("../utils"),i=e("../stream/GenericWorker");function c(f,_){i.call(this,"Nodejs stream input adapter for "+f),this._upstreamEnded=!1,this._bindStream(_)}s.inherits(c,i),c.prototype._bindStream=function(f){var _=this;(this._stream=f).pause(),f.on("data",function(x){_.push({data:x,meta:{percent:0}})}).on("error",function(x){_.isPaused?this.generatedError=x:_.error(x)}).on("end",function(){_.isPaused?_._upstreamEnded=!0:_.end()})},c.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},c.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},a.exports=c},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,a,r){var s=e("readable-stream").Readable;function i(c,f,_){s.call(this,f),this._helper=c;var x=this;c.on("data",function(b,y){x.push(b)||x._helper.pause(),_&&_(y)}).on("error",function(b){x.emit("error",b)}).on("end",function(){x.push(null)})}e("../utils").inherits(i,s),i.prototype._read=function(){this._helper.resume()},a.exports=i},{"../utils":32,"readable-stream":16}],14:[function(e,a,r){a.exports={isNode:typeof Buffer<"u",newBufferFrom:function(s,i){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(s,i);if(typeof s=="number")throw new Error('The "data" argument must not be a number');return new Buffer(s,i)},allocBuffer:function(s){if(Buffer.alloc)return Buffer.alloc(s);var i=new Buffer(s);return i.fill(0),i},isBuffer:function(s){return Buffer.isBuffer(s)},isStream:function(s){return s&&typeof s.on=="function"&&typeof s.pause=="function"&&typeof s.resume=="function"}}},{}],15:[function(e,a,r){function s(E,P,T){var L,R=c.getTypeOf(P),O=c.extend(T||{},x);O.date=O.date||new Date,O.compression!==null&&(O.compression=O.compression.toUpperCase()),typeof O.unixPermissions=="string"&&(O.unixPermissions=parseInt(O.unixPermissions,8)),O.unixPermissions&&16384&O.unixPermissions&&(O.dir=!0),O.dosPermissions&&16&O.dosPermissions&&(O.dir=!0),O.dir&&(E=p(E)),O.createFolders&&(L=m(E))&&v.call(this,L,!0);var M=R==="string"&&O.binary===!1&&O.base64===!1;T&&T.binary!==void 0||(O.binary=!M),(P instanceof b&&P.uncompressedSize===0||O.dir||!P||P.length===0)&&(O.base64=!1,O.binary=!0,P="",O.compression="STORE",R="string");var w=null;w=P instanceof b||P instanceof f?P:g.isNode&&g.isStream(P)?new u(E,P):c.prepareContent(E,P,O.binary,O.optimizedBinaryString,O.base64);var A=new y(E,w,O);this.files[E]=A}var i=e("./utf8"),c=e("./utils"),f=e("./stream/GenericWorker"),_=e("./stream/StreamHelper"),x=e("./defaults"),b=e("./compressedObject"),y=e("./zipObject"),h=e("./generate"),g=e("./nodejsUtils"),u=e("./nodejs/NodejsStreamInputAdapter"),m=function(E){E.slice(-1)==="/"&&(E=E.substring(0,E.length-1));var P=E.lastIndexOf("/");return 0<P?E.substring(0,P):""},p=function(E){return E.slice(-1)!=="/"&&(E+="/"),E},v=function(E,P){return P=P!==void 0?P:x.createFolders,E=p(E),this.files[E]||s.call(this,E,null,{dir:!0,createFolders:P}),this.files[E]};function S(E){return Object.prototype.toString.call(E)==="[object RegExp]"}var k={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(E){var P,T,L;for(P in this.files)L=this.files[P],(T=P.slice(this.root.length,P.length))&&P.slice(0,this.root.length)===this.root&&E(T,L)},filter:function(E){var P=[];return this.forEach(function(T,L){E(T,L)&&P.push(L)}),P},file:function(E,P,T){if(arguments.length!==1)return E=this.root+E,s.call(this,E,P,T),this;if(S(E)){var L=E;return this.filter(function(O,M){return!M.dir&&L.test(O)})}var R=this.files[this.root+E];return R&&!R.dir?R:null},folder:function(E){if(!E)return this;if(S(E))return this.filter(function(R,O){return O.dir&&E.test(R)});var P=this.root+E,T=v.call(this,P),L=this.clone();return L.root=T.name,L},remove:function(E){E=this.root+E;var P=this.files[E];if(P||(E.slice(-1)!=="/"&&(E+="/"),P=this.files[E]),P&&!P.dir)delete this.files[E];else for(var T=this.filter(function(R,O){return O.name.slice(0,E.length)===E}),L=0;L<T.length;L++)delete this.files[T[L].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(E){var P,T={};try{if((T=c.extend(E||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:i.utf8encode})).type=T.type.toLowerCase(),T.compression=T.compression.toUpperCase(),T.type==="binarystring"&&(T.type="string"),!T.type)throw new Error("No output type specified.");c.checkSupport(T.type),T.platform!=="darwin"&&T.platform!=="freebsd"&&T.platform!=="linux"&&T.platform!=="sunos"||(T.platform="UNIX"),T.platform==="win32"&&(T.platform="DOS");var L=T.comment||this.comment||"";P=h.generateWorker(this,T,L)}catch(R){(P=new f("error")).error(R)}return new _(P,T.type||"string",T.mimeType)},generateAsync:function(E,P){return this.generateInternalStream(E).accumulate(P)},generateNodeStream:function(E,P){return(E=E||{}).type||(E.type="nodebuffer"),this.generateInternalStream(E).toNodejsStream(P)}};a.exports=k},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,a,r){a.exports=e("stream")},{stream:void 0}],17:[function(e,a,r){var s=e("./DataReader");function i(c){s.call(this,c);for(var f=0;f<this.data.length;f++)c[f]=255&c[f]}e("../utils").inherits(i,s),i.prototype.byteAt=function(c){return this.data[this.zero+c]},i.prototype.lastIndexOfSignature=function(c){for(var f=c.charCodeAt(0),_=c.charCodeAt(1),x=c.charCodeAt(2),b=c.charCodeAt(3),y=this.length-4;0<=y;--y)if(this.data[y]===f&&this.data[y+1]===_&&this.data[y+2]===x&&this.data[y+3]===b)return y-this.zero;return-1},i.prototype.readAndCheckSignature=function(c){var f=c.charCodeAt(0),_=c.charCodeAt(1),x=c.charCodeAt(2),b=c.charCodeAt(3),y=this.readData(4);return f===y[0]&&_===y[1]&&x===y[2]&&b===y[3]},i.prototype.readData=function(c){if(this.checkOffset(c),c===0)return[];var f=this.data.slice(this.zero+this.index,this.zero+this.index+c);return this.index+=c,f},a.exports=i},{"../utils":32,"./DataReader":18}],18:[function(e,a,r){var s=e("../utils");function i(c){this.data=c,this.length=c.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(c){this.checkIndex(this.index+c)},checkIndex:function(c){if(this.length<this.zero+c||c<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+c+"). Corrupted zip ?")},setIndex:function(c){this.checkIndex(c),this.index=c},skip:function(c){this.setIndex(this.index+c)},byteAt:function(){},readInt:function(c){var f,_=0;for(this.checkOffset(c),f=this.index+c-1;f>=this.index;f--)_=(_<<8)+this.byteAt(f);return this.index+=c,_},readString:function(c){return s.transformTo("string",this.readData(c))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var c=this.readInt(4);return new Date(Date.UTC(1980+(c>>25&127),(c>>21&15)-1,c>>16&31,c>>11&31,c>>5&63,(31&c)<<1))}},a.exports=i},{"../utils":32}],19:[function(e,a,r){var s=e("./Uint8ArrayReader");function i(c){s.call(this,c)}e("../utils").inherits(i,s),i.prototype.readData=function(c){this.checkOffset(c);var f=this.data.slice(this.zero+this.index,this.zero+this.index+c);return this.index+=c,f},a.exports=i},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,a,r){var s=e("./DataReader");function i(c){s.call(this,c)}e("../utils").inherits(i,s),i.prototype.byteAt=function(c){return this.data.charCodeAt(this.zero+c)},i.prototype.lastIndexOfSignature=function(c){return this.data.lastIndexOf(c)-this.zero},i.prototype.readAndCheckSignature=function(c){return c===this.readData(4)},i.prototype.readData=function(c){this.checkOffset(c);var f=this.data.slice(this.zero+this.index,this.zero+this.index+c);return this.index+=c,f},a.exports=i},{"../utils":32,"./DataReader":18}],21:[function(e,a,r){var s=e("./ArrayReader");function i(c){s.call(this,c)}e("../utils").inherits(i,s),i.prototype.readData=function(c){if(this.checkOffset(c),c===0)return new Uint8Array(0);var f=this.data.subarray(this.zero+this.index,this.zero+this.index+c);return this.index+=c,f},a.exports=i},{"../utils":32,"./ArrayReader":17}],22:[function(e,a,r){var s=e("../utils"),i=e("../support"),c=e("./ArrayReader"),f=e("./StringReader"),_=e("./NodeBufferReader"),x=e("./Uint8ArrayReader");a.exports=function(b){var y=s.getTypeOf(b);return s.checkSupport(y),y!=="string"||i.uint8array?y==="nodebuffer"?new _(b):i.uint8array?new x(s.transformTo("uint8array",b)):new c(s.transformTo("array",b)):new f(b)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,a,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,a,r){var s=e("./GenericWorker"),i=e("../utils");function c(f){s.call(this,"ConvertWorker to "+f),this.destType=f}i.inherits(c,s),c.prototype.processChunk=function(f){this.push({data:i.transformTo(this.destType,f.data),meta:f.meta})},a.exports=c},{"../utils":32,"./GenericWorker":28}],25:[function(e,a,r){var s=e("./GenericWorker"),i=e("../crc32");function c(){s.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(c,s),c.prototype.processChunk=function(f){this.streamInfo.crc32=i(f.data,this.streamInfo.crc32||0),this.push(f)},a.exports=c},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,a,r){var s=e("../utils"),i=e("./GenericWorker");function c(f){i.call(this,"DataLengthProbe for "+f),this.propName=f,this.withStreamInfo(f,0)}s.inherits(c,i),c.prototype.processChunk=function(f){if(f){var _=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=_+f.data.length}i.prototype.processChunk.call(this,f)},a.exports=c},{"../utils":32,"./GenericWorker":28}],27:[function(e,a,r){var s=e("../utils"),i=e("./GenericWorker");function c(f){i.call(this,"DataWorker");var _=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,f.then(function(x){_.dataIsReady=!0,_.data=x,_.max=x&&x.length||0,_.type=s.getTypeOf(x),_.isPaused||_._tickAndRepeat()},function(x){_.error(x)})}s.inherits(c,i),c.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},c.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,s.delay(this._tickAndRepeat,[],this)),!0)},c.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(s.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},c.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var f=null,_=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":f=this.data.substring(this.index,_);break;case"uint8array":f=this.data.subarray(this.index,_);break;case"array":case"nodebuffer":f=this.data.slice(this.index,_)}return this.index=_,this.push({data:f,meta:{percent:this.max?this.index/this.max*100:0}})},a.exports=c},{"../utils":32,"./GenericWorker":28}],28:[function(e,a,r){function s(i){this.name=i||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}s.prototype={push:function(i){this.emit("data",i)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(i){this.emit("error",i)}return!0},error:function(i){return!this.isFinished&&(this.isPaused?this.generatedError=i:(this.isFinished=!0,this.emit("error",i),this.previous&&this.previous.error(i),this.cleanUp()),!0)},on:function(i,c){return this._listeners[i].push(c),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(i,c){if(this._listeners[i])for(var f=0;f<this._listeners[i].length;f++)this._listeners[i][f].call(this,c)},pipe:function(i){return i.registerPrevious(this)},registerPrevious:function(i){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=i.streamInfo,this.mergeStreamInfo(),this.previous=i;var c=this;return i.on("data",function(f){c.processChunk(f)}),i.on("end",function(){c.end()}),i.on("error",function(f){c.error(f)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var i=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),i=!0),this.previous&&this.previous.resume(),!i},flush:function(){},processChunk:function(i){this.push(i)},withStreamInfo:function(i,c){return this.extraStreamInfo[i]=c,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var i in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,i)&&(this.streamInfo[i]=this.extraStreamInfo[i])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var i="Worker "+this.name;return this.previous?this.previous+" -> "+i:i}},a.exports=s},{}],29:[function(e,a,r){var s=e("../utils"),i=e("./ConvertWorker"),c=e("./GenericWorker"),f=e("../base64"),_=e("../support"),x=e("../external"),b=null;if(_.nodestream)try{b=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function y(g,u){return new x.Promise(function(m,p){var v=[],S=g._internalType,k=g._outputType,E=g._mimeType;g.on("data",function(P,T){v.push(P),u&&u(T)}).on("error",function(P){v=[],p(P)}).on("end",function(){try{var P=function(T,L,R){switch(T){case"blob":return s.newBlob(s.transformTo("arraybuffer",L),R);case"base64":return f.encode(L);default:return s.transformTo(T,L)}}(k,function(T,L){var R,O=0,M=null,w=0;for(R=0;R<L.length;R++)w+=L[R].length;switch(T){case"string":return L.join("");case"array":return Array.prototype.concat.apply([],L);case"uint8array":for(M=new Uint8Array(w),R=0;R<L.length;R++)M.set(L[R],O),O+=L[R].length;return M;case"nodebuffer":return Buffer.concat(L);default:throw new Error("concat : unsupported type '"+T+"'")}}(S,v),E);m(P)}catch(T){p(T)}v=[]}).resume()})}function h(g,u,m){var p=u;switch(u){case"blob":case"arraybuffer":p="uint8array";break;case"base64":p="string"}try{this._internalType=p,this._outputType=u,this._mimeType=m,s.checkSupport(p),this._worker=g.pipe(new i(p)),g.lock()}catch(v){this._worker=new c("error"),this._worker.error(v)}}h.prototype={accumulate:function(g){return y(this,g)},on:function(g,u){var m=this;return g==="data"?this._worker.on(g,function(p){u.call(m,p.data,p.meta)}):this._worker.on(g,function(){s.delay(u,arguments,m)}),this},resume:function(){return s.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(s.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new b(this,{objectMode:this._outputType!=="nodebuffer"},g)}},a.exports=h},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,a,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",r.nodebuffer=typeof Buffer<"u",r.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")r.blob=!1;else{var s=new ArrayBuffer(0);try{r.blob=new Blob([s],{type:"application/zip"}).size===0}catch{try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(s),r.blob=i.getBlob("application/zip").size===0}catch{r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch{r.nodestream=!1}},{"readable-stream":16}],31:[function(e,a,r){for(var s=e("./utils"),i=e("./support"),c=e("./nodejsUtils"),f=e("./stream/GenericWorker"),_=new Array(256),x=0;x<256;x++)_[x]=252<=x?6:248<=x?5:240<=x?4:224<=x?3:192<=x?2:1;_[254]=_[254]=1;function b(){f.call(this,"utf-8 decode"),this.leftOver=null}function y(){f.call(this,"utf-8 encode")}r.utf8encode=function(h){return i.nodebuffer?c.newBufferFrom(h,"utf-8"):function(g){var u,m,p,v,S,k=g.length,E=0;for(v=0;v<k;v++)(64512&(m=g.charCodeAt(v)))==55296&&v+1<k&&(64512&(p=g.charCodeAt(v+1)))==56320&&(m=65536+(m-55296<<10)+(p-56320),v++),E+=m<128?1:m<2048?2:m<65536?3:4;for(u=i.uint8array?new Uint8Array(E):new Array(E),v=S=0;S<E;v++)(64512&(m=g.charCodeAt(v)))==55296&&v+1<k&&(64512&(p=g.charCodeAt(v+1)))==56320&&(m=65536+(m-55296<<10)+(p-56320),v++),m<128?u[S++]=m:(m<2048?u[S++]=192|m>>>6:(m<65536?u[S++]=224|m>>>12:(u[S++]=240|m>>>18,u[S++]=128|m>>>12&63),u[S++]=128|m>>>6&63),u[S++]=128|63&m);return u}(h)},r.utf8decode=function(h){return i.nodebuffer?s.transformTo("nodebuffer",h).toString("utf-8"):function(g){var u,m,p,v,S=g.length,k=new Array(2*S);for(u=m=0;u<S;)if((p=g[u++])<128)k[m++]=p;else if(4<(v=_[p]))k[m++]=65533,u+=v-1;else{for(p&=v===2?31:v===3?15:7;1<v&&u<S;)p=p<<6|63&g[u++],v--;1<v?k[m++]=65533:p<65536?k[m++]=p:(p-=65536,k[m++]=55296|p>>10&1023,k[m++]=56320|1023&p)}return k.length!==m&&(k.subarray?k=k.subarray(0,m):k.length=m),s.applyFromCharCode(k)}(h=s.transformTo(i.uint8array?"uint8array":"array",h))},s.inherits(b,f),b.prototype.processChunk=function(h){var g=s.transformTo(i.uint8array?"uint8array":"array",h.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var u=g;(g=new Uint8Array(u.length+this.leftOver.length)).set(this.leftOver,0),g.set(u,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var m=function(v,S){var k;for((S=S||v.length)>v.length&&(S=v.length),k=S-1;0<=k&&(192&v[k])==128;)k--;return k<0||k===0?S:k+_[v[k]]>S?k:S}(g),p=g;m!==g.length&&(i.uint8array?(p=g.subarray(0,m),this.leftOver=g.subarray(m,g.length)):(p=g.slice(0,m),this.leftOver=g.slice(m,g.length))),this.push({data:r.utf8decode(p),meta:h.meta})},b.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=b,s.inherits(y,f),y.prototype.processChunk=function(h){this.push({data:r.utf8encode(h.data),meta:h.meta})},r.Utf8EncodeWorker=y},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,a,r){var s=e("./support"),i=e("./base64"),c=e("./nodejsUtils"),f=e("./external");function _(u){return u}function x(u,m){for(var p=0;p<u.length;++p)m[p]=255&u.charCodeAt(p);return m}e("setimmediate"),r.newBlob=function(u,m){r.checkSupport("blob");try{return new Blob([u],{type:m})}catch{try{var p=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return p.append(u),p.getBlob(m)}catch{throw new Error("Bug : can't construct the Blob.")}}};var b={stringifyByChunk:function(u,m,p){var v=[],S=0,k=u.length;if(k<=p)return String.fromCharCode.apply(null,u);for(;S<k;)m==="array"||m==="nodebuffer"?v.push(String.fromCharCode.apply(null,u.slice(S,Math.min(S+p,k)))):v.push(String.fromCharCode.apply(null,u.subarray(S,Math.min(S+p,k)))),S+=p;return v.join("")},stringifyByChar:function(u){for(var m="",p=0;p<u.length;p++)m+=String.fromCharCode(u[p]);return m},applyCanBeUsed:{uint8array:function(){try{return s.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return s.nodebuffer&&String.fromCharCode.apply(null,c.allocBuffer(1)).length===1}catch{return!1}}()}};function y(u){var m=65536,p=r.getTypeOf(u),v=!0;if(p==="uint8array"?v=b.applyCanBeUsed.uint8array:p==="nodebuffer"&&(v=b.applyCanBeUsed.nodebuffer),v)for(;1<m;)try{return b.stringifyByChunk(u,p,m)}catch{m=Math.floor(m/2)}return b.stringifyByChar(u)}function h(u,m){for(var p=0;p<u.length;p++)m[p]=u[p];return m}r.applyFromCharCode=y;var g={};g.string={string:_,array:function(u){return x(u,new Array(u.length))},arraybuffer:function(u){return g.string.uint8array(u).buffer},uint8array:function(u){return x(u,new Uint8Array(u.length))},nodebuffer:function(u){return x(u,c.allocBuffer(u.length))}},g.array={string:y,array:_,arraybuffer:function(u){return new Uint8Array(u).buffer},uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return c.newBufferFrom(u)}},g.arraybuffer={string:function(u){return y(new Uint8Array(u))},array:function(u){return h(new Uint8Array(u),new Array(u.byteLength))},arraybuffer:_,uint8array:function(u){return new Uint8Array(u)},nodebuffer:function(u){return c.newBufferFrom(new Uint8Array(u))}},g.uint8array={string:y,array:function(u){return h(u,new Array(u.length))},arraybuffer:function(u){return u.buffer},uint8array:_,nodebuffer:function(u){return c.newBufferFrom(u)}},g.nodebuffer={string:y,array:function(u){return h(u,new Array(u.length))},arraybuffer:function(u){return g.nodebuffer.uint8array(u).buffer},uint8array:function(u){return h(u,new Uint8Array(u.length))},nodebuffer:_},r.transformTo=function(u,m){if(m=m||"",!u)return m;r.checkSupport(u);var p=r.getTypeOf(m);return g[p][u](m)},r.resolve=function(u){for(var m=u.split("/"),p=[],v=0;v<m.length;v++){var S=m[v];S==="."||S===""&&v!==0&&v!==m.length-1||(S===".."?p.pop():p.push(S))}return p.join("/")},r.getTypeOf=function(u){return typeof u=="string"?"string":Object.prototype.toString.call(u)==="[object Array]"?"array":s.nodebuffer&&c.isBuffer(u)?"nodebuffer":s.uint8array&&u instanceof Uint8Array?"uint8array":s.arraybuffer&&u instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(u){if(!s[u.toLowerCase()])throw new Error(u+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(u){var m,p,v="";for(p=0;p<(u||"").length;p++)v+="\\x"+((m=u.charCodeAt(p))<16?"0":"")+m.toString(16).toUpperCase();return v},r.delay=function(u,m,p){setImmediate(function(){u.apply(p||null,m||[])})},r.inherits=function(u,m){function p(){}p.prototype=m.prototype,u.prototype=new p},r.extend=function(){var u,m,p={};for(u=0;u<arguments.length;u++)for(m in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],m)&&p[m]===void 0&&(p[m]=arguments[u][m]);return p},r.prepareContent=function(u,m,p,v,S){return f.Promise.resolve(m).then(function(k){return s.blob&&(k instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(k))!==-1)&&typeof FileReader<"u"?new f.Promise(function(E,P){var T=new FileReader;T.onload=function(L){E(L.target.result)},T.onerror=function(L){P(L.target.error)},T.readAsArrayBuffer(k)}):k}).then(function(k){var E=r.getTypeOf(k);return E?(E==="arraybuffer"?k=r.transformTo("uint8array",k):E==="string"&&(S?k=i.decode(k):p&&v!==!0&&(k=function(P){return x(P,s.uint8array?new Uint8Array(P.length):new Array(P.length))}(k))),k):f.Promise.reject(new Error("Can't read the data of '"+u+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,a,r){var s=e("./reader/readerFor"),i=e("./utils"),c=e("./signature"),f=e("./zipEntry"),_=e("./support");function x(b){this.files=[],this.loadOptions=b}x.prototype={checkSignature:function(b){if(!this.reader.readAndCheckSignature(b)){this.reader.index-=4;var y=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(y)+", expected "+i.pretty(b)+")")}},isSignature:function(b,y){var h=this.reader.index;this.reader.setIndex(b);var g=this.reader.readString(4)===y;return this.reader.setIndex(h),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var b=this.reader.readData(this.zipCommentLength),y=_.uint8array?"uint8array":"array",h=i.transformTo(y,b);this.zipComment=this.loadOptions.decodeFileName(h)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var b,y,h,g=this.zip64EndOfCentralSize-44;0<g;)b=this.reader.readInt(2),y=this.reader.readInt(4),h=this.reader.readData(y),this.zip64ExtensibleData[b]={id:b,length:y,value:h}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var b,y;for(b=0;b<this.files.length;b++)y=this.files[b],this.reader.setIndex(y.localHeaderOffset),this.checkSignature(c.LOCAL_FILE_HEADER),y.readLocalPart(this.reader),y.handleUTF8(),y.processAttributes()},readCentralDir:function(){var b;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(c.CENTRAL_FILE_HEADER);)(b=new f({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(b);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var b=this.reader.lastIndexOfSignature(c.CENTRAL_DIRECTORY_END);if(b<0)throw this.isSignature(0,c.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(b);var y=b;if(this.checkSignature(c.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(b=this.reader.lastIndexOfSignature(c.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(b),this.checkSignature(c.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,c.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(c.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(c.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var h=this.centralDirOffset+this.centralDirSize;this.zip64&&(h+=20,h+=12+this.zip64EndOfCentralSize);var g=y-h;if(0<g)this.isSignature(y,c.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(b){this.reader=s(b)},load:function(b){this.prepareReader(b),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},a.exports=x},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,a,r){var s=e("./reader/readerFor"),i=e("./utils"),c=e("./compressedObject"),f=e("./crc32"),_=e("./utf8"),x=e("./compressions"),b=e("./support");function y(h,g){this.options=h,this.loadOptions=g}y.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(h){var g,u;if(h.skip(22),this.fileNameLength=h.readInt(2),u=h.readInt(2),this.fileName=h.readData(this.fileNameLength),h.skip(u),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=function(m){for(var p in x)if(Object.prototype.hasOwnProperty.call(x,p)&&x[p].magic===m)return x[p];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new c(this.compressedSize,this.uncompressedSize,this.crc32,g,h.readData(this.compressedSize))},readCentralPart:function(h){this.versionMadeBy=h.readInt(2),h.skip(2),this.bitFlag=h.readInt(2),this.compressionMethod=h.readString(2),this.date=h.readDate(),this.crc32=h.readInt(4),this.compressedSize=h.readInt(4),this.uncompressedSize=h.readInt(4);var g=h.readInt(2);if(this.extraFieldsLength=h.readInt(2),this.fileCommentLength=h.readInt(2),this.diskNumberStart=h.readInt(2),this.internalFileAttributes=h.readInt(2),this.externalFileAttributes=h.readInt(4),this.localHeaderOffset=h.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");h.skip(g),this.readExtraFields(h),this.parseZIP64ExtraField(h),this.fileComment=h.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var h=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),h==0&&(this.dosPermissions=63&this.externalFileAttributes),h==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var h=s(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=h.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=h.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=h.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=h.readInt(4))}},readExtraFields:function(h){var g,u,m,p=h.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});h.index+4<p;)g=h.readInt(2),u=h.readInt(2),m=h.readData(u),this.extraFields[g]={id:g,length:u,value:m};h.setIndex(p)},handleUTF8:function(){var h=b.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=_.utf8decode(this.fileName),this.fileCommentStr=_.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var u=i.transformTo(h,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(u)}var m=this.findExtraFieldUnicodeComment();if(m!==null)this.fileCommentStr=m;else{var p=i.transformTo(h,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(p)}}},findExtraFieldUnicodePath:function(){var h=this.extraFields[28789];if(h){var g=s(h.value);return g.readInt(1)!==1||f(this.fileName)!==g.readInt(4)?null:_.utf8decode(g.readData(h.length-5))}return null},findExtraFieldUnicodeComment:function(){var h=this.extraFields[25461];if(h){var g=s(h.value);return g.readInt(1)!==1||f(this.fileComment)!==g.readInt(4)?null:_.utf8decode(g.readData(h.length-5))}return null}},a.exports=y},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,a,r){function s(g,u,m){this.name=g,this.dir=m.dir,this.date=m.date,this.comment=m.comment,this.unixPermissions=m.unixPermissions,this.dosPermissions=m.dosPermissions,this._data=u,this._dataBinary=m.binary,this.options={compression:m.compression,compressionOptions:m.compressionOptions}}var i=e("./stream/StreamHelper"),c=e("./stream/DataWorker"),f=e("./utf8"),_=e("./compressedObject"),x=e("./stream/GenericWorker");s.prototype={internalStream:function(g){var u=null,m="string";try{if(!g)throw new Error("No output type specified.");var p=(m=g.toLowerCase())==="string"||m==="text";m!=="binarystring"&&m!=="text"||(m="string"),u=this._decompressWorker();var v=!this._dataBinary;v&&!p&&(u=u.pipe(new f.Utf8EncodeWorker)),!v&&p&&(u=u.pipe(new f.Utf8DecodeWorker))}catch(S){(u=new x("error")).error(S)}return new i(u,m,"")},async:function(g,u){return this.internalStream(g).accumulate(u)},nodeStream:function(g,u){return this.internalStream(g||"nodebuffer").toNodejsStream(u)},_compressWorker:function(g,u){if(this._data instanceof _&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var m=this._decompressWorker();return this._dataBinary||(m=m.pipe(new f.Utf8EncodeWorker)),_.createWorkerFrom(m,g,u)},_decompressWorker:function(){return this._data instanceof _?this._data.getContentWorker():this._data instanceof x?this._data:new c(this._data)}};for(var b=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],y=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},h=0;h<b.length;h++)s.prototype[b[h]]=y;a.exports=s},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,a,r){(function(s){var i,c,f=s.MutationObserver||s.WebKitMutationObserver;if(f){var _=0,x=new f(g),b=s.document.createTextNode("");x.observe(b,{characterData:!0}),i=function(){b.data=_=++_%2}}else if(s.setImmediate||s.MessageChannel===void 0)i="document"in s&&"onreadystatechange"in s.document.createElement("script")?function(){var u=s.document.createElement("script");u.onreadystatechange=function(){g(),u.onreadystatechange=null,u.parentNode.removeChild(u),u=null},s.document.documentElement.appendChild(u)}:function(){setTimeout(g,0)};else{var y=new s.MessageChannel;y.port1.onmessage=g,i=function(){y.port2.postMessage(0)}}var h=[];function g(){var u,m;c=!0;for(var p=h.length;p;){for(m=h,h=[],u=-1;++u<p;)m[u]();p=h.length}c=!1}a.exports=function(u){h.push(u)!==1||c||i()}}).call(this,typeof wt<"u"?wt:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,a,r){var s=e("immediate");function i(){}var c={},f=["REJECTED"],_=["FULFILLED"],x=["PENDING"];function b(p){if(typeof p!="function")throw new TypeError("resolver must be a function");this.state=x,this.queue=[],this.outcome=void 0,p!==i&&u(this,p)}function y(p,v,S){this.promise=p,typeof v=="function"&&(this.onFulfilled=v,this.callFulfilled=this.otherCallFulfilled),typeof S=="function"&&(this.onRejected=S,this.callRejected=this.otherCallRejected)}function h(p,v,S){s(function(){var k;try{k=v(S)}catch(E){return c.reject(p,E)}k===p?c.reject(p,new TypeError("Cannot resolve promise with itself")):c.resolve(p,k)})}function g(p){var v=p&&p.then;if(p&&(typeof p=="object"||typeof p=="function")&&typeof v=="function")return function(){v.apply(p,arguments)}}function u(p,v){var S=!1;function k(T){S||(S=!0,c.reject(p,T))}function E(T){S||(S=!0,c.resolve(p,T))}var P=m(function(){v(E,k)});P.status==="error"&&k(P.value)}function m(p,v){var S={};try{S.value=p(v),S.status="success"}catch(k){S.status="error",S.value=k}return S}(a.exports=b).prototype.finally=function(p){if(typeof p!="function")return this;var v=this.constructor;return this.then(function(S){return v.resolve(p()).then(function(){return S})},function(S){return v.resolve(p()).then(function(){throw S})})},b.prototype.catch=function(p){return this.then(null,p)},b.prototype.then=function(p,v){if(typeof p!="function"&&this.state===_||typeof v!="function"&&this.state===f)return this;var S=new this.constructor(i);return this.state!==x?h(S,this.state===_?p:v,this.outcome):this.queue.push(new y(S,p,v)),S},y.prototype.callFulfilled=function(p){c.resolve(this.promise,p)},y.prototype.otherCallFulfilled=function(p){h(this.promise,this.onFulfilled,p)},y.prototype.callRejected=function(p){c.reject(this.promise,p)},y.prototype.otherCallRejected=function(p){h(this.promise,this.onRejected,p)},c.resolve=function(p,v){var S=m(g,v);if(S.status==="error")return c.reject(p,S.value);var k=S.value;if(k)u(p,k);else{p.state=_,p.outcome=v;for(var E=-1,P=p.queue.length;++E<P;)p.queue[E].callFulfilled(v)}return p},c.reject=function(p,v){p.state=f,p.outcome=v;for(var S=-1,k=p.queue.length;++S<k;)p.queue[S].callRejected(v);return p},b.resolve=function(p){return p instanceof this?p:c.resolve(new this(i),p)},b.reject=function(p){var v=new this(i);return c.reject(v,p)},b.all=function(p){var v=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=p.length,k=!1;if(!S)return this.resolve([]);for(var E=new Array(S),P=0,T=-1,L=new this(i);++T<S;)R(p[T],T);return L;function R(O,M){v.resolve(O).then(function(w){E[M]=w,++P!==S||k||(k=!0,c.resolve(L,E))},function(w){k||(k=!0,c.reject(L,w))})}},b.race=function(p){var v=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var S=p.length,k=!1;if(!S)return this.resolve([]);for(var E=-1,P=new this(i);++E<S;)T=p[E],v.resolve(T).then(function(L){k||(k=!0,c.resolve(P,L))},function(L){k||(k=!0,c.reject(P,L))});var T;return P}},{immediate:36}],38:[function(e,a,r){var s={};(0,e("./lib/utils/common").assign)(s,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),a.exports=s},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,a,r){var s=e("./zlib/deflate"),i=e("./utils/common"),c=e("./utils/strings"),f=e("./zlib/messages"),_=e("./zlib/zstream"),x=Object.prototype.toString,b=0,y=-1,h=0,g=8;function u(p){if(!(this instanceof u))return new u(p);this.options=i.assign({level:y,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:h,to:""},p||{});var v=this.options;v.raw&&0<v.windowBits?v.windowBits=-v.windowBits:v.gzip&&0<v.windowBits&&v.windowBits<16&&(v.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _,this.strm.avail_out=0;var S=s.deflateInit2(this.strm,v.level,v.method,v.windowBits,v.memLevel,v.strategy);if(S!==b)throw new Error(f[S]);if(v.header&&s.deflateSetHeader(this.strm,v.header),v.dictionary){var k;if(k=typeof v.dictionary=="string"?c.string2buf(v.dictionary):x.call(v.dictionary)==="[object ArrayBuffer]"?new Uint8Array(v.dictionary):v.dictionary,(S=s.deflateSetDictionary(this.strm,k))!==b)throw new Error(f[S]);this._dict_set=!0}}function m(p,v){var S=new u(v);if(S.push(p,!0),S.err)throw S.msg||f[S.err];return S.result}u.prototype.push=function(p,v){var S,k,E=this.strm,P=this.options.chunkSize;if(this.ended)return!1;k=v===~~v?v:v===!0?4:0,typeof p=="string"?E.input=c.string2buf(p):x.call(p)==="[object ArrayBuffer]"?E.input=new Uint8Array(p):E.input=p,E.next_in=0,E.avail_in=E.input.length;do{if(E.avail_out===0&&(E.output=new i.Buf8(P),E.next_out=0,E.avail_out=P),(S=s.deflate(E,k))!==1&&S!==b)return this.onEnd(S),!(this.ended=!0);E.avail_out!==0&&(E.avail_in!==0||k!==4&&k!==2)||(this.options.to==="string"?this.onData(c.buf2binstring(i.shrinkBuf(E.output,E.next_out))):this.onData(i.shrinkBuf(E.output,E.next_out)))}while((0<E.avail_in||E.avail_out===0)&&S!==1);return k===4?(S=s.deflateEnd(this.strm),this.onEnd(S),this.ended=!0,S===b):k!==2||(this.onEnd(b),!(E.avail_out=0))},u.prototype.onData=function(p){this.chunks.push(p)},u.prototype.onEnd=function(p){p===b&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg},r.Deflate=u,r.deflate=m,r.deflateRaw=function(p,v){return(v=v||{}).raw=!0,m(p,v)},r.gzip=function(p,v){return(v=v||{}).gzip=!0,m(p,v)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,a,r){var s=e("./zlib/inflate"),i=e("./utils/common"),c=e("./utils/strings"),f=e("./zlib/constants"),_=e("./zlib/messages"),x=e("./zlib/zstream"),b=e("./zlib/gzheader"),y=Object.prototype.toString;function h(u){if(!(this instanceof h))return new h(u);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},u||{});var m=this.options;m.raw&&0<=m.windowBits&&m.windowBits<16&&(m.windowBits=-m.windowBits,m.windowBits===0&&(m.windowBits=-15)),!(0<=m.windowBits&&m.windowBits<16)||u&&u.windowBits||(m.windowBits+=32),15<m.windowBits&&m.windowBits<48&&!(15&m.windowBits)&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new x,this.strm.avail_out=0;var p=s.inflateInit2(this.strm,m.windowBits);if(p!==f.Z_OK)throw new Error(_[p]);this.header=new b,s.inflateGetHeader(this.strm,this.header)}function g(u,m){var p=new h(m);if(p.push(u,!0),p.err)throw p.msg||_[p.err];return p.result}h.prototype.push=function(u,m){var p,v,S,k,E,P,T=this.strm,L=this.options.chunkSize,R=this.options.dictionary,O=!1;if(this.ended)return!1;v=m===~~m?m:m===!0?f.Z_FINISH:f.Z_NO_FLUSH,typeof u=="string"?T.input=c.binstring2buf(u):y.call(u)==="[object ArrayBuffer]"?T.input=new Uint8Array(u):T.input=u,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new i.Buf8(L),T.next_out=0,T.avail_out=L),(p=s.inflate(T,f.Z_NO_FLUSH))===f.Z_NEED_DICT&&R&&(P=typeof R=="string"?c.string2buf(R):y.call(R)==="[object ArrayBuffer]"?new Uint8Array(R):R,p=s.inflateSetDictionary(this.strm,P)),p===f.Z_BUF_ERROR&&O===!0&&(p=f.Z_OK,O=!1),p!==f.Z_STREAM_END&&p!==f.Z_OK)return this.onEnd(p),!(this.ended=!0);T.next_out&&(T.avail_out!==0&&p!==f.Z_STREAM_END&&(T.avail_in!==0||v!==f.Z_FINISH&&v!==f.Z_SYNC_FLUSH)||(this.options.to==="string"?(S=c.utf8border(T.output,T.next_out),k=T.next_out-S,E=c.buf2string(T.output,S),T.next_out=k,T.avail_out=L-k,k&&i.arraySet(T.output,T.output,S,k,0),this.onData(E)):this.onData(i.shrinkBuf(T.output,T.next_out)))),T.avail_in===0&&T.avail_out===0&&(O=!0)}while((0<T.avail_in||T.avail_out===0)&&p!==f.Z_STREAM_END);return p===f.Z_STREAM_END&&(v=f.Z_FINISH),v===f.Z_FINISH?(p=s.inflateEnd(this.strm),this.onEnd(p),this.ended=!0,p===f.Z_OK):v!==f.Z_SYNC_FLUSH||(this.onEnd(f.Z_OK),!(T.avail_out=0))},h.prototype.onData=function(u){this.chunks.push(u)},h.prototype.onEnd=function(u){u===f.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=u,this.msg=this.strm.msg},r.Inflate=h,r.inflate=g,r.inflateRaw=function(u,m){return(m=m||{}).raw=!0,g(u,m)},r.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,a,r){var s=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";r.assign=function(f){for(var _=Array.prototype.slice.call(arguments,1);_.length;){var x=_.shift();if(x){if(typeof x!="object")throw new TypeError(x+"must be non-object");for(var b in x)x.hasOwnProperty(b)&&(f[b]=x[b])}}return f},r.shrinkBuf=function(f,_){return f.length===_?f:f.subarray?f.subarray(0,_):(f.length=_,f)};var i={arraySet:function(f,_,x,b,y){if(_.subarray&&f.subarray)f.set(_.subarray(x,x+b),y);else for(var h=0;h<b;h++)f[y+h]=_[x+h]},flattenChunks:function(f){var _,x,b,y,h,g;for(_=b=0,x=f.length;_<x;_++)b+=f[_].length;for(g=new Uint8Array(b),_=y=0,x=f.length;_<x;_++)h=f[_],g.set(h,y),y+=h.length;return g}},c={arraySet:function(f,_,x,b,y){for(var h=0;h<b;h++)f[y+h]=_[x+h]},flattenChunks:function(f){return[].concat.apply([],f)}};r.setTyped=function(f){f?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,i)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,c))},r.setTyped(s)},{}],42:[function(e,a,r){var s=e("./common"),i=!0,c=!0;try{String.fromCharCode.apply(null,[0])}catch{i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{c=!1}for(var f=new s.Buf8(256),_=0;_<256;_++)f[_]=252<=_?6:248<=_?5:240<=_?4:224<=_?3:192<=_?2:1;function x(b,y){if(y<65537&&(b.subarray&&c||!b.subarray&&i))return String.fromCharCode.apply(null,s.shrinkBuf(b,y));for(var h="",g=0;g<y;g++)h+=String.fromCharCode(b[g]);return h}f[254]=f[254]=1,r.string2buf=function(b){var y,h,g,u,m,p=b.length,v=0;for(u=0;u<p;u++)(64512&(h=b.charCodeAt(u)))==55296&&u+1<p&&(64512&(g=b.charCodeAt(u+1)))==56320&&(h=65536+(h-55296<<10)+(g-56320),u++),v+=h<128?1:h<2048?2:h<65536?3:4;for(y=new s.Buf8(v),u=m=0;m<v;u++)(64512&(h=b.charCodeAt(u)))==55296&&u+1<p&&(64512&(g=b.charCodeAt(u+1)))==56320&&(h=65536+(h-55296<<10)+(g-56320),u++),h<128?y[m++]=h:(h<2048?y[m++]=192|h>>>6:(h<65536?y[m++]=224|h>>>12:(y[m++]=240|h>>>18,y[m++]=128|h>>>12&63),y[m++]=128|h>>>6&63),y[m++]=128|63&h);return y},r.buf2binstring=function(b){return x(b,b.length)},r.binstring2buf=function(b){for(var y=new s.Buf8(b.length),h=0,g=y.length;h<g;h++)y[h]=b.charCodeAt(h);return y},r.buf2string=function(b,y){var h,g,u,m,p=y||b.length,v=new Array(2*p);for(h=g=0;h<p;)if((u=b[h++])<128)v[g++]=u;else if(4<(m=f[u]))v[g++]=65533,h+=m-1;else{for(u&=m===2?31:m===3?15:7;1<m&&h<p;)u=u<<6|63&b[h++],m--;1<m?v[g++]=65533:u<65536?v[g++]=u:(u-=65536,v[g++]=55296|u>>10&1023,v[g++]=56320|1023&u)}return x(v,g)},r.utf8border=function(b,y){var h;for((y=y||b.length)>b.length&&(y=b.length),h=y-1;0<=h&&(192&b[h])==128;)h--;return h<0||h===0?y:h+f[b[h]]>y?h:y}},{"./common":41}],43:[function(e,a,r){a.exports=function(s,i,c,f){for(var _=65535&s|0,x=s>>>16&65535|0,b=0;c!==0;){for(c-=b=2e3<c?2e3:c;x=x+(_=_+i[f++]|0)|0,--b;);_%=65521,x%=65521}return _|x<<16|0}},{}],44:[function(e,a,r){a.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,a,r){var s=function(){for(var i,c=[],f=0;f<256;f++){i=f;for(var _=0;_<8;_++)i=1&i?3988292384^i>>>1:i>>>1;c[f]=i}return c}();a.exports=function(i,c,f,_){var x=s,b=_+f;i^=-1;for(var y=_;y<b;y++)i=i>>>8^x[255&(i^c[y])];return-1^i}},{}],46:[function(e,a,r){var s,i=e("../utils/common"),c=e("./trees"),f=e("./adler32"),_=e("./crc32"),x=e("./messages"),b=0,y=4,h=0,g=-2,u=-1,m=4,p=2,v=8,S=9,k=286,E=30,P=19,T=2*k+1,L=15,R=3,O=258,M=O+R+1,w=42,A=113,d=1,F=2,q=3,z=4;function Q(l,$){return l.msg=x[$],$}function H(l){return(l<<1)-(4<l?9:0)}function X(l){for(var $=l.length;0<=--$;)l[$]=0}function N(l){var $=l.state,W=$.pending;W>l.avail_out&&(W=l.avail_out),W!==0&&(i.arraySet(l.output,$.pending_buf,$.pending_out,W,l.next_out),l.next_out+=W,$.pending_out+=W,l.total_out+=W,l.avail_out-=W,$.pending-=W,$.pending===0&&($.pending_out=0))}function I(l,$){c._tr_flush_block(l,0<=l.block_start?l.block_start:-1,l.strstart-l.block_start,$),l.block_start=l.strstart,N(l.strm)}function Y(l,$){l.pending_buf[l.pending++]=$}function Z(l,$){l.pending_buf[l.pending++]=$>>>8&255,l.pending_buf[l.pending++]=255&$}function V(l,$){var W,j,B=l.max_chain_length,D=l.strstart,G=l.prev_length,J=l.nice_match,U=l.strstart>l.w_size-M?l.strstart-(l.w_size-M):0,ee=l.window,oe=l.w_mask,te=l.prev,ie=l.strstart+O,he=ee[D+G-1],fe=ee[D+G];l.prev_length>=l.good_match&&(B>>=2),J>l.lookahead&&(J=l.lookahead);do if(ee[(W=$)+G]===fe&&ee[W+G-1]===he&&ee[W]===ee[D]&&ee[++W]===ee[D+1]){D+=2,W++;do;while(ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&ee[++D]===ee[++W]&&D<ie);if(j=O-(ie-D),D=ie-O,G<j){if(l.match_start=$,J<=(G=j))break;he=ee[D+G-1],fe=ee[D+G]}}while(($=te[$&oe])>U&&--B!=0);return G<=l.lookahead?G:l.lookahead}function se(l){var $,W,j,B,D,G,J,U,ee,oe,te=l.w_size;do{if(B=l.window_size-l.lookahead-l.strstart,l.strstart>=te+(te-M)){for(i.arraySet(l.window,l.window,te,te,0),l.match_start-=te,l.strstart-=te,l.block_start-=te,$=W=l.hash_size;j=l.head[--$],l.head[$]=te<=j?j-te:0,--W;);for($=W=te;j=l.prev[--$],l.prev[$]=te<=j?j-te:0,--W;);B+=te}if(l.strm.avail_in===0)break;if(G=l.strm,J=l.window,U=l.strstart+l.lookahead,ee=B,oe=void 0,oe=G.avail_in,ee<oe&&(oe=ee),W=oe===0?0:(G.avail_in-=oe,i.arraySet(J,G.input,G.next_in,oe,U),G.state.wrap===1?G.adler=f(G.adler,J,oe,U):G.state.wrap===2&&(G.adler=_(G.adler,J,oe,U)),G.next_in+=oe,G.total_in+=oe,oe),l.lookahead+=W,l.lookahead+l.insert>=R)for(D=l.strstart-l.insert,l.ins_h=l.window[D],l.ins_h=(l.ins_h<<l.hash_shift^l.window[D+1])&l.hash_mask;l.insert&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[D+R-1])&l.hash_mask,l.prev[D&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=D,D++,l.insert--,!(l.lookahead+l.insert<R)););}while(l.lookahead<M&&l.strm.avail_in!==0)}function K(l,$){for(var W,j;;){if(l.lookahead<M){if(se(l),l.lookahead<M&&$===b)return d;if(l.lookahead===0)break}if(W=0,l.lookahead>=R&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),W!==0&&l.strstart-W<=l.w_size-M&&(l.match_length=V(l,W)),l.match_length>=R)if(j=c._tr_tally(l,l.strstart-l.match_start,l.match_length-R),l.lookahead-=l.match_length,l.match_length<=l.max_lazy_match&&l.lookahead>=R){for(l.match_length--;l.strstart++,l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart,--l.match_length!=0;);l.strstart++}else l.strstart+=l.match_length,l.match_length=0,l.ins_h=l.window[l.strstart],l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+1])&l.hash_mask;else j=c._tr_tally(l,0,l.window[l.strstart]),l.lookahead--,l.strstart++;if(j&&(I(l,!1),l.strm.avail_out===0))return d}return l.insert=l.strstart<R-1?l.strstart:R-1,$===y?(I(l,!0),l.strm.avail_out===0?q:z):l.last_lit&&(I(l,!1),l.strm.avail_out===0)?d:F}function re(l,$){for(var W,j,B;;){if(l.lookahead<M){if(se(l),l.lookahead<M&&$===b)return d;if(l.lookahead===0)break}if(W=0,l.lookahead>=R&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),l.prev_length=l.match_length,l.prev_match=l.match_start,l.match_length=R-1,W!==0&&l.prev_length<l.max_lazy_match&&l.strstart-W<=l.w_size-M&&(l.match_length=V(l,W),l.match_length<=5&&(l.strategy===1||l.match_length===R&&4096<l.strstart-l.match_start)&&(l.match_length=R-1)),l.prev_length>=R&&l.match_length<=l.prev_length){for(B=l.strstart+l.lookahead-R,j=c._tr_tally(l,l.strstart-1-l.prev_match,l.prev_length-R),l.lookahead-=l.prev_length-1,l.prev_length-=2;++l.strstart<=B&&(l.ins_h=(l.ins_h<<l.hash_shift^l.window[l.strstart+R-1])&l.hash_mask,W=l.prev[l.strstart&l.w_mask]=l.head[l.ins_h],l.head[l.ins_h]=l.strstart),--l.prev_length!=0;);if(l.match_available=0,l.match_length=R-1,l.strstart++,j&&(I(l,!1),l.strm.avail_out===0))return d}else if(l.match_available){if((j=c._tr_tally(l,0,l.window[l.strstart-1]))&&I(l,!1),l.strstart++,l.lookahead--,l.strm.avail_out===0)return d}else l.match_available=1,l.strstart++,l.lookahead--}return l.match_available&&(j=c._tr_tally(l,0,l.window[l.strstart-1]),l.match_available=0),l.insert=l.strstart<R-1?l.strstart:R-1,$===y?(I(l,!0),l.strm.avail_out===0?q:z):l.last_lit&&(I(l,!1),l.strm.avail_out===0)?d:F}function le(l,$,W,j,B){this.good_length=l,this.max_lazy=$,this.nice_length=W,this.max_chain=j,this.func=B}function ce(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=v,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*T),this.dyn_dtree=new i.Buf16(2*(2*E+1)),this.bl_tree=new i.Buf16(2*(2*P+1)),X(this.dyn_ltree),X(this.dyn_dtree),X(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(L+1),this.heap=new i.Buf16(2*k+1),X(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*k+1),X(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function ue(l){var $;return l&&l.state?(l.total_in=l.total_out=0,l.data_type=p,($=l.state).pending=0,$.pending_out=0,$.wrap<0&&($.wrap=-$.wrap),$.status=$.wrap?w:A,l.adler=$.wrap===2?0:1,$.last_flush=b,c._tr_init($),h):Q(l,g)}function pe(l){var $=ue(l);return $===h&&function(W){W.window_size=2*W.w_size,X(W.head),W.max_lazy_match=s[W.level].max_lazy,W.good_match=s[W.level].good_length,W.nice_match=s[W.level].nice_length,W.max_chain_length=s[W.level].max_chain,W.strstart=0,W.block_start=0,W.lookahead=0,W.insert=0,W.match_length=W.prev_length=R-1,W.match_available=0,W.ins_h=0}(l.state),$}function be(l,$,W,j,B,D){if(!l)return g;var G=1;if($===u&&($=6),j<0?(G=0,j=-j):15<j&&(G=2,j-=16),B<1||S<B||W!==v||j<8||15<j||$<0||9<$||D<0||m<D)return Q(l,g);j===8&&(j=9);var J=new ce;return(l.state=J).strm=l,J.wrap=G,J.gzhead=null,J.w_bits=j,J.w_size=1<<J.w_bits,J.w_mask=J.w_size-1,J.hash_bits=B+7,J.hash_size=1<<J.hash_bits,J.hash_mask=J.hash_size-1,J.hash_shift=~~((J.hash_bits+R-1)/R),J.window=new i.Buf8(2*J.w_size),J.head=new i.Buf16(J.hash_size),J.prev=new i.Buf16(J.w_size),J.lit_bufsize=1<<B+6,J.pending_buf_size=4*J.lit_bufsize,J.pending_buf=new i.Buf8(J.pending_buf_size),J.d_buf=1*J.lit_bufsize,J.l_buf=3*J.lit_bufsize,J.level=$,J.strategy=D,J.method=W,pe(l)}s=[new le(0,0,0,0,function(l,$){var W=65535;for(W>l.pending_buf_size-5&&(W=l.pending_buf_size-5);;){if(l.lookahead<=1){if(se(l),l.lookahead===0&&$===b)return d;if(l.lookahead===0)break}l.strstart+=l.lookahead,l.lookahead=0;var j=l.block_start+W;if((l.strstart===0||l.strstart>=j)&&(l.lookahead=l.strstart-j,l.strstart=j,I(l,!1),l.strm.avail_out===0)||l.strstart-l.block_start>=l.w_size-M&&(I(l,!1),l.strm.avail_out===0))return d}return l.insert=0,$===y?(I(l,!0),l.strm.avail_out===0?q:z):(l.strstart>l.block_start&&(I(l,!1),l.strm.avail_out),d)}),new le(4,4,8,4,K),new le(4,5,16,8,K),new le(4,6,32,32,K),new le(4,4,16,16,re),new le(8,16,32,32,re),new le(8,16,128,128,re),new le(8,32,128,256,re),new le(32,128,258,1024,re),new le(32,258,258,4096,re)],r.deflateInit=function(l,$){return be(l,$,v,15,8,0)},r.deflateInit2=be,r.deflateReset=pe,r.deflateResetKeep=ue,r.deflateSetHeader=function(l,$){return l&&l.state?l.state.wrap!==2?g:(l.state.gzhead=$,h):g},r.deflate=function(l,$){var W,j,B,D;if(!l||!l.state||5<$||$<0)return l?Q(l,g):g;if(j=l.state,!l.output||!l.input&&l.avail_in!==0||j.status===666&&$!==y)return Q(l,l.avail_out===0?-5:g);if(j.strm=l,W=j.last_flush,j.last_flush=$,j.status===w)if(j.wrap===2)l.adler=0,Y(j,31),Y(j,139),Y(j,8),j.gzhead?(Y(j,(j.gzhead.text?1:0)+(j.gzhead.hcrc?2:0)+(j.gzhead.extra?4:0)+(j.gzhead.name?8:0)+(j.gzhead.comment?16:0)),Y(j,255&j.gzhead.time),Y(j,j.gzhead.time>>8&255),Y(j,j.gzhead.time>>16&255),Y(j,j.gzhead.time>>24&255),Y(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),Y(j,255&j.gzhead.os),j.gzhead.extra&&j.gzhead.extra.length&&(Y(j,255&j.gzhead.extra.length),Y(j,j.gzhead.extra.length>>8&255)),j.gzhead.hcrc&&(l.adler=_(l.adler,j.pending_buf,j.pending,0)),j.gzindex=0,j.status=69):(Y(j,0),Y(j,0),Y(j,0),Y(j,0),Y(j,0),Y(j,j.level===9?2:2<=j.strategy||j.level<2?4:0),Y(j,3),j.status=A);else{var G=v+(j.w_bits-8<<4)<<8;G|=(2<=j.strategy||j.level<2?0:j.level<6?1:j.level===6?2:3)<<6,j.strstart!==0&&(G|=32),G+=31-G%31,j.status=A,Z(j,G),j.strstart!==0&&(Z(j,l.adler>>>16),Z(j,65535&l.adler)),l.adler=1}if(j.status===69)if(j.gzhead.extra){for(B=j.pending;j.gzindex<(65535&j.gzhead.extra.length)&&(j.pending!==j.pending_buf_size||(j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),N(l),B=j.pending,j.pending!==j.pending_buf_size));)Y(j,255&j.gzhead.extra[j.gzindex]),j.gzindex++;j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),j.gzindex===j.gzhead.extra.length&&(j.gzindex=0,j.status=73)}else j.status=73;if(j.status===73)if(j.gzhead.name){B=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),N(l),B=j.pending,j.pending===j.pending_buf_size)){D=1;break}D=j.gzindex<j.gzhead.name.length?255&j.gzhead.name.charCodeAt(j.gzindex++):0,Y(j,D)}while(D!==0);j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),D===0&&(j.gzindex=0,j.status=91)}else j.status=91;if(j.status===91)if(j.gzhead.comment){B=j.pending;do{if(j.pending===j.pending_buf_size&&(j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),N(l),B=j.pending,j.pending===j.pending_buf_size)){D=1;break}D=j.gzindex<j.gzhead.comment.length?255&j.gzhead.comment.charCodeAt(j.gzindex++):0,Y(j,D)}while(D!==0);j.gzhead.hcrc&&j.pending>B&&(l.adler=_(l.adler,j.pending_buf,j.pending-B,B)),D===0&&(j.status=103)}else j.status=103;if(j.status===103&&(j.gzhead.hcrc?(j.pending+2>j.pending_buf_size&&N(l),j.pending+2<=j.pending_buf_size&&(Y(j,255&l.adler),Y(j,l.adler>>8&255),l.adler=0,j.status=A)):j.status=A),j.pending!==0){if(N(l),l.avail_out===0)return j.last_flush=-1,h}else if(l.avail_in===0&&H($)<=H(W)&&$!==y)return Q(l,-5);if(j.status===666&&l.avail_in!==0)return Q(l,-5);if(l.avail_in!==0||j.lookahead!==0||$!==b&&j.status!==666){var J=j.strategy===2?function(U,ee){for(var oe;;){if(U.lookahead===0&&(se(U),U.lookahead===0)){if(ee===b)return d;break}if(U.match_length=0,oe=c._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++,oe&&(I(U,!1),U.strm.avail_out===0))return d}return U.insert=0,ee===y?(I(U,!0),U.strm.avail_out===0?q:z):U.last_lit&&(I(U,!1),U.strm.avail_out===0)?d:F}(j,$):j.strategy===3?function(U,ee){for(var oe,te,ie,he,fe=U.window;;){if(U.lookahead<=O){if(se(U),U.lookahead<=O&&ee===b)return d;if(U.lookahead===0)break}if(U.match_length=0,U.lookahead>=R&&0<U.strstart&&(te=fe[ie=U.strstart-1])===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]){he=U.strstart+O;do;while(te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&te===fe[++ie]&&ie<he);U.match_length=O-(he-ie),U.match_length>U.lookahead&&(U.match_length=U.lookahead)}if(U.match_length>=R?(oe=c._tr_tally(U,1,U.match_length-R),U.lookahead-=U.match_length,U.strstart+=U.match_length,U.match_length=0):(oe=c._tr_tally(U,0,U.window[U.strstart]),U.lookahead--,U.strstart++),oe&&(I(U,!1),U.strm.avail_out===0))return d}return U.insert=0,ee===y?(I(U,!0),U.strm.avail_out===0?q:z):U.last_lit&&(I(U,!1),U.strm.avail_out===0)?d:F}(j,$):s[j.level].func(j,$);if(J!==q&&J!==z||(j.status=666),J===d||J===q)return l.avail_out===0&&(j.last_flush=-1),h;if(J===F&&($===1?c._tr_align(j):$!==5&&(c._tr_stored_block(j,0,0,!1),$===3&&(X(j.head),j.lookahead===0&&(j.strstart=0,j.block_start=0,j.insert=0))),N(l),l.avail_out===0))return j.last_flush=-1,h}return $!==y?h:j.wrap<=0?1:(j.wrap===2?(Y(j,255&l.adler),Y(j,l.adler>>8&255),Y(j,l.adler>>16&255),Y(j,l.adler>>24&255),Y(j,255&l.total_in),Y(j,l.total_in>>8&255),Y(j,l.total_in>>16&255),Y(j,l.total_in>>24&255)):(Z(j,l.adler>>>16),Z(j,65535&l.adler)),N(l),0<j.wrap&&(j.wrap=-j.wrap),j.pending!==0?h:1)},r.deflateEnd=function(l){var $;return l&&l.state?($=l.state.status)!==w&&$!==69&&$!==73&&$!==91&&$!==103&&$!==A&&$!==666?Q(l,g):(l.state=null,$===A?Q(l,-3):h):g},r.deflateSetDictionary=function(l,$){var W,j,B,D,G,J,U,ee,oe=$.length;if(!l||!l.state||(D=(W=l.state).wrap)===2||D===1&&W.status!==w||W.lookahead)return g;for(D===1&&(l.adler=f(l.adler,$,oe,0)),W.wrap=0,oe>=W.w_size&&(D===0&&(X(W.head),W.strstart=0,W.block_start=0,W.insert=0),ee=new i.Buf8(W.w_size),i.arraySet(ee,$,oe-W.w_size,W.w_size,0),$=ee,oe=W.w_size),G=l.avail_in,J=l.next_in,U=l.input,l.avail_in=oe,l.next_in=0,l.input=$,se(W);W.lookahead>=R;){for(j=W.strstart,B=W.lookahead-(R-1);W.ins_h=(W.ins_h<<W.hash_shift^W.window[j+R-1])&W.hash_mask,W.prev[j&W.w_mask]=W.head[W.ins_h],W.head[W.ins_h]=j,j++,--B;);W.strstart=j,W.lookahead=R-1,se(W)}return W.strstart+=W.lookahead,W.block_start=W.strstart,W.insert=W.lookahead,W.lookahead=0,W.match_length=W.prev_length=R-1,W.match_available=0,l.next_in=J,l.input=U,l.avail_in=G,W.wrap=D,h},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,a,r){a.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,a,r){a.exports=function(s,i){var c,f,_,x,b,y,h,g,u,m,p,v,S,k,E,P,T,L,R,O,M,w,A,d,F;c=s.state,f=s.next_in,d=s.input,_=f+(s.avail_in-5),x=s.next_out,F=s.output,b=x-(i-s.avail_out),y=x+(s.avail_out-257),h=c.dmax,g=c.wsize,u=c.whave,m=c.wnext,p=c.window,v=c.hold,S=c.bits,k=c.lencode,E=c.distcode,P=(1<<c.lenbits)-1,T=(1<<c.distbits)-1;e:do{S<15&&(v+=d[f++]<<S,S+=8,v+=d[f++]<<S,S+=8),L=k[v&P];t:for(;;){if(v>>>=R=L>>>24,S-=R,(R=L>>>16&255)===0)F[x++]=65535&L;else{if(!(16&R)){if(!(64&R)){L=k[(65535&L)+(v&(1<<R)-1)];continue t}if(32&R){c.mode=12;break e}s.msg="invalid literal/length code",c.mode=30;break e}O=65535&L,(R&=15)&&(S<R&&(v+=d[f++]<<S,S+=8),O+=v&(1<<R)-1,v>>>=R,S-=R),S<15&&(v+=d[f++]<<S,S+=8,v+=d[f++]<<S,S+=8),L=E[v&T];n:for(;;){if(v>>>=R=L>>>24,S-=R,!(16&(R=L>>>16&255))){if(!(64&R)){L=E[(65535&L)+(v&(1<<R)-1)];continue n}s.msg="invalid distance code",c.mode=30;break e}if(M=65535&L,S<(R&=15)&&(v+=d[f++]<<S,(S+=8)<R&&(v+=d[f++]<<S,S+=8)),h<(M+=v&(1<<R)-1)){s.msg="invalid distance too far back",c.mode=30;break e}if(v>>>=R,S-=R,(R=x-b)<M){if(u<(R=M-R)&&c.sane){s.msg="invalid distance too far back",c.mode=30;break e}if(A=p,(w=0)===m){if(w+=g-R,R<O){for(O-=R;F[x++]=p[w++],--R;);w=x-M,A=F}}else if(m<R){if(w+=g+m-R,(R-=m)<O){for(O-=R;F[x++]=p[w++],--R;);if(w=0,m<O){for(O-=R=m;F[x++]=p[w++],--R;);w=x-M,A=F}}}else if(w+=m-R,R<O){for(O-=R;F[x++]=p[w++],--R;);w=x-M,A=F}for(;2<O;)F[x++]=A[w++],F[x++]=A[w++],F[x++]=A[w++],O-=3;O&&(F[x++]=A[w++],1<O&&(F[x++]=A[w++]))}else{for(w=x-M;F[x++]=F[w++],F[x++]=F[w++],F[x++]=F[w++],2<(O-=3););O&&(F[x++]=F[w++],1<O&&(F[x++]=F[w++]))}break}}break}}while(f<_&&x<y);f-=O=S>>3,v&=(1<<(S-=O<<3))-1,s.next_in=f,s.next_out=x,s.avail_in=f<_?_-f+5:5-(f-_),s.avail_out=x<y?y-x+257:257-(x-y),c.hold=v,c.bits=S}},{}],49:[function(e,a,r){var s=e("../utils/common"),i=e("./adler32"),c=e("./crc32"),f=e("./inffast"),_=e("./inftrees"),x=1,b=2,y=0,h=-2,g=1,u=852,m=592;function p(w){return(w>>>24&255)+(w>>>8&65280)+((65280&w)<<8)+((255&w)<<24)}function v(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function S(w){var A;return w&&w.state?(A=w.state,w.total_in=w.total_out=A.total=0,w.msg="",A.wrap&&(w.adler=1&A.wrap),A.mode=g,A.last=0,A.havedict=0,A.dmax=32768,A.head=null,A.hold=0,A.bits=0,A.lencode=A.lendyn=new s.Buf32(u),A.distcode=A.distdyn=new s.Buf32(m),A.sane=1,A.back=-1,y):h}function k(w){var A;return w&&w.state?((A=w.state).wsize=0,A.whave=0,A.wnext=0,S(w)):h}function E(w,A){var d,F;return w&&w.state?(F=w.state,A<0?(d=0,A=-A):(d=1+(A>>4),A<48&&(A&=15)),A&&(A<8||15<A)?h:(F.window!==null&&F.wbits!==A&&(F.window=null),F.wrap=d,F.wbits=A,k(w))):h}function P(w,A){var d,F;return w?(F=new v,(w.state=F).window=null,(d=E(w,A))!==y&&(w.state=null),d):h}var T,L,R=!0;function O(w){if(R){var A;for(T=new s.Buf32(512),L=new s.Buf32(32),A=0;A<144;)w.lens[A++]=8;for(;A<256;)w.lens[A++]=9;for(;A<280;)w.lens[A++]=7;for(;A<288;)w.lens[A++]=8;for(_(x,w.lens,0,288,T,0,w.work,{bits:9}),A=0;A<32;)w.lens[A++]=5;_(b,w.lens,0,32,L,0,w.work,{bits:5}),R=!1}w.lencode=T,w.lenbits=9,w.distcode=L,w.distbits=5}function M(w,A,d,F){var q,z=w.state;return z.window===null&&(z.wsize=1<<z.wbits,z.wnext=0,z.whave=0,z.window=new s.Buf8(z.wsize)),F>=z.wsize?(s.arraySet(z.window,A,d-z.wsize,z.wsize,0),z.wnext=0,z.whave=z.wsize):(F<(q=z.wsize-z.wnext)&&(q=F),s.arraySet(z.window,A,d-F,q,z.wnext),(F-=q)?(s.arraySet(z.window,A,d-F,F,0),z.wnext=F,z.whave=z.wsize):(z.wnext+=q,z.wnext===z.wsize&&(z.wnext=0),z.whave<z.wsize&&(z.whave+=q))),0}r.inflateReset=k,r.inflateReset2=E,r.inflateResetKeep=S,r.inflateInit=function(w){return P(w,15)},r.inflateInit2=P,r.inflate=function(w,A){var d,F,q,z,Q,H,X,N,I,Y,Z,V,se,K,re,le,ce,ue,pe,be,l,$,W,j,B=0,D=new s.Buf8(4),G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!w||!w.state||!w.output||!w.input&&w.avail_in!==0)return h;(d=w.state).mode===12&&(d.mode=13),Q=w.next_out,q=w.output,X=w.avail_out,z=w.next_in,F=w.input,H=w.avail_in,N=d.hold,I=d.bits,Y=H,Z=X,$=y;e:for(;;)switch(d.mode){case g:if(d.wrap===0){d.mode=13;break}for(;I<16;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(2&d.wrap&&N===35615){D[d.check=0]=255&N,D[1]=N>>>8&255,d.check=c(d.check,D,2,0),I=N=0,d.mode=2;break}if(d.flags=0,d.head&&(d.head.done=!1),!(1&d.wrap)||(((255&N)<<8)+(N>>8))%31){w.msg="incorrect header check",d.mode=30;break}if((15&N)!=8){w.msg="unknown compression method",d.mode=30;break}if(I-=4,l=8+(15&(N>>>=4)),d.wbits===0)d.wbits=l;else if(l>d.wbits){w.msg="invalid window size",d.mode=30;break}d.dmax=1<<l,w.adler=d.check=1,d.mode=512&N?10:12,I=N=0;break;case 2:for(;I<16;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(d.flags=N,(255&d.flags)!=8){w.msg="unknown compression method",d.mode=30;break}if(57344&d.flags){w.msg="unknown header flags set",d.mode=30;break}d.head&&(d.head.text=N>>8&1),512&d.flags&&(D[0]=255&N,D[1]=N>>>8&255,d.check=c(d.check,D,2,0)),I=N=0,d.mode=3;case 3:for(;I<32;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}d.head&&(d.head.time=N),512&d.flags&&(D[0]=255&N,D[1]=N>>>8&255,D[2]=N>>>16&255,D[3]=N>>>24&255,d.check=c(d.check,D,4,0)),I=N=0,d.mode=4;case 4:for(;I<16;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}d.head&&(d.head.xflags=255&N,d.head.os=N>>8),512&d.flags&&(D[0]=255&N,D[1]=N>>>8&255,d.check=c(d.check,D,2,0)),I=N=0,d.mode=5;case 5:if(1024&d.flags){for(;I<16;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}d.length=N,d.head&&(d.head.extra_len=N),512&d.flags&&(D[0]=255&N,D[1]=N>>>8&255,d.check=c(d.check,D,2,0)),I=N=0}else d.head&&(d.head.extra=null);d.mode=6;case 6:if(1024&d.flags&&(H<(V=d.length)&&(V=H),V&&(d.head&&(l=d.head.extra_len-d.length,d.head.extra||(d.head.extra=new Array(d.head.extra_len)),s.arraySet(d.head.extra,F,z,V,l)),512&d.flags&&(d.check=c(d.check,F,V,z)),H-=V,z+=V,d.length-=V),d.length))break e;d.length=0,d.mode=7;case 7:if(2048&d.flags){if(H===0)break e;for(V=0;l=F[z+V++],d.head&&l&&d.length<65536&&(d.head.name+=String.fromCharCode(l)),l&&V<H;);if(512&d.flags&&(d.check=c(d.check,F,V,z)),H-=V,z+=V,l)break e}else d.head&&(d.head.name=null);d.length=0,d.mode=8;case 8:if(4096&d.flags){if(H===0)break e;for(V=0;l=F[z+V++],d.head&&l&&d.length<65536&&(d.head.comment+=String.fromCharCode(l)),l&&V<H;);if(512&d.flags&&(d.check=c(d.check,F,V,z)),H-=V,z+=V,l)break e}else d.head&&(d.head.comment=null);d.mode=9;case 9:if(512&d.flags){for(;I<16;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(N!==(65535&d.check)){w.msg="header crc mismatch",d.mode=30;break}I=N=0}d.head&&(d.head.hcrc=d.flags>>9&1,d.head.done=!0),w.adler=d.check=0,d.mode=12;break;case 10:for(;I<32;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}w.adler=d.check=p(N),I=N=0,d.mode=11;case 11:if(d.havedict===0)return w.next_out=Q,w.avail_out=X,w.next_in=z,w.avail_in=H,d.hold=N,d.bits=I,2;w.adler=d.check=1,d.mode=12;case 12:if(A===5||A===6)break e;case 13:if(d.last){N>>>=7&I,I-=7&I,d.mode=27;break}for(;I<3;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}switch(d.last=1&N,I-=1,3&(N>>>=1)){case 0:d.mode=14;break;case 1:if(O(d),d.mode=20,A!==6)break;N>>>=2,I-=2;break e;case 2:d.mode=17;break;case 3:w.msg="invalid block type",d.mode=30}N>>>=2,I-=2;break;case 14:for(N>>>=7&I,I-=7&I;I<32;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if((65535&N)!=(N>>>16^65535)){w.msg="invalid stored block lengths",d.mode=30;break}if(d.length=65535&N,I=N=0,d.mode=15,A===6)break e;case 15:d.mode=16;case 16:if(V=d.length){if(H<V&&(V=H),X<V&&(V=X),V===0)break e;s.arraySet(q,F,z,V,Q),H-=V,z+=V,X-=V,Q+=V,d.length-=V;break}d.mode=12;break;case 17:for(;I<14;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(d.nlen=257+(31&N),N>>>=5,I-=5,d.ndist=1+(31&N),N>>>=5,I-=5,d.ncode=4+(15&N),N>>>=4,I-=4,286<d.nlen||30<d.ndist){w.msg="too many length or distance symbols",d.mode=30;break}d.have=0,d.mode=18;case 18:for(;d.have<d.ncode;){for(;I<3;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}d.lens[G[d.have++]]=7&N,N>>>=3,I-=3}for(;d.have<19;)d.lens[G[d.have++]]=0;if(d.lencode=d.lendyn,d.lenbits=7,W={bits:d.lenbits},$=_(0,d.lens,0,19,d.lencode,0,d.work,W),d.lenbits=W.bits,$){w.msg="invalid code lengths set",d.mode=30;break}d.have=0,d.mode=19;case 19:for(;d.have<d.nlen+d.ndist;){for(;le=(B=d.lencode[N&(1<<d.lenbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=I);){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(ce<16)N>>>=re,I-=re,d.lens[d.have++]=ce;else{if(ce===16){for(j=re+2;I<j;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(N>>>=re,I-=re,d.have===0){w.msg="invalid bit length repeat",d.mode=30;break}l=d.lens[d.have-1],V=3+(3&N),N>>>=2,I-=2}else if(ce===17){for(j=re+3;I<j;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}I-=re,l=0,V=3+(7&(N>>>=re)),N>>>=3,I-=3}else{for(j=re+7;I<j;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}I-=re,l=0,V=11+(127&(N>>>=re)),N>>>=7,I-=7}if(d.have+V>d.nlen+d.ndist){w.msg="invalid bit length repeat",d.mode=30;break}for(;V--;)d.lens[d.have++]=l}}if(d.mode===30)break;if(d.lens[256]===0){w.msg="invalid code -- missing end-of-block",d.mode=30;break}if(d.lenbits=9,W={bits:d.lenbits},$=_(x,d.lens,0,d.nlen,d.lencode,0,d.work,W),d.lenbits=W.bits,$){w.msg="invalid literal/lengths set",d.mode=30;break}if(d.distbits=6,d.distcode=d.distdyn,W={bits:d.distbits},$=_(b,d.lens,d.nlen,d.ndist,d.distcode,0,d.work,W),d.distbits=W.bits,$){w.msg="invalid distances set",d.mode=30;break}if(d.mode=20,A===6)break e;case 20:d.mode=21;case 21:if(6<=H&&258<=X){w.next_out=Q,w.avail_out=X,w.next_in=z,w.avail_in=H,d.hold=N,d.bits=I,f(w,Z),Q=w.next_out,q=w.output,X=w.avail_out,z=w.next_in,F=w.input,H=w.avail_in,N=d.hold,I=d.bits,d.mode===12&&(d.back=-1);break}for(d.back=0;le=(B=d.lencode[N&(1<<d.lenbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=I);){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(le&&!(240&le)){for(ue=re,pe=le,be=ce;le=(B=d.lencode[be+((N&(1<<ue+pe)-1)>>ue)])>>>16&255,ce=65535&B,!(ue+(re=B>>>24)<=I);){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}N>>>=ue,I-=ue,d.back+=ue}if(N>>>=re,I-=re,d.back+=re,d.length=ce,le===0){d.mode=26;break}if(32&le){d.back=-1,d.mode=12;break}if(64&le){w.msg="invalid literal/length code",d.mode=30;break}d.extra=15&le,d.mode=22;case 22:if(d.extra){for(j=d.extra;I<j;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}d.length+=N&(1<<d.extra)-1,N>>>=d.extra,I-=d.extra,d.back+=d.extra}d.was=d.length,d.mode=23;case 23:for(;le=(B=d.distcode[N&(1<<d.distbits)-1])>>>16&255,ce=65535&B,!((re=B>>>24)<=I);){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(!(240&le)){for(ue=re,pe=le,be=ce;le=(B=d.distcode[be+((N&(1<<ue+pe)-1)>>ue)])>>>16&255,ce=65535&B,!(ue+(re=B>>>24)<=I);){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}N>>>=ue,I-=ue,d.back+=ue}if(N>>>=re,I-=re,d.back+=re,64&le){w.msg="invalid distance code",d.mode=30;break}d.offset=ce,d.extra=15&le,d.mode=24;case 24:if(d.extra){for(j=d.extra;I<j;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}d.offset+=N&(1<<d.extra)-1,N>>>=d.extra,I-=d.extra,d.back+=d.extra}if(d.offset>d.dmax){w.msg="invalid distance too far back",d.mode=30;break}d.mode=25;case 25:if(X===0)break e;if(V=Z-X,d.offset>V){if((V=d.offset-V)>d.whave&&d.sane){w.msg="invalid distance too far back",d.mode=30;break}se=V>d.wnext?(V-=d.wnext,d.wsize-V):d.wnext-V,V>d.length&&(V=d.length),K=d.window}else K=q,se=Q-d.offset,V=d.length;for(X<V&&(V=X),X-=V,d.length-=V;q[Q++]=K[se++],--V;);d.length===0&&(d.mode=21);break;case 26:if(X===0)break e;q[Q++]=d.length,X--,d.mode=21;break;case 27:if(d.wrap){for(;I<32;){if(H===0)break e;H--,N|=F[z++]<<I,I+=8}if(Z-=X,w.total_out+=Z,d.total+=Z,Z&&(w.adler=d.check=d.flags?c(d.check,q,Z,Q-Z):i(d.check,q,Z,Q-Z)),Z=X,(d.flags?N:p(N))!==d.check){w.msg="incorrect data check",d.mode=30;break}I=N=0}d.mode=28;case 28:if(d.wrap&&d.flags){for(;I<32;){if(H===0)break e;H--,N+=F[z++]<<I,I+=8}if(N!==(4294967295&d.total)){w.msg="incorrect length check",d.mode=30;break}I=N=0}d.mode=29;case 29:$=1;break e;case 30:$=-3;break e;case 31:return-4;case 32:default:return h}return w.next_out=Q,w.avail_out=X,w.next_in=z,w.avail_in=H,d.hold=N,d.bits=I,(d.wsize||Z!==w.avail_out&&d.mode<30&&(d.mode<27||A!==4))&&M(w,w.output,w.next_out,Z-w.avail_out)?(d.mode=31,-4):(Y-=w.avail_in,Z-=w.avail_out,w.total_in+=Y,w.total_out+=Z,d.total+=Z,d.wrap&&Z&&(w.adler=d.check=d.flags?c(d.check,q,Z,w.next_out-Z):i(d.check,q,Z,w.next_out-Z)),w.data_type=d.bits+(d.last?64:0)+(d.mode===12?128:0)+(d.mode===20||d.mode===15?256:0),(Y==0&&Z===0||A===4)&&$===y&&($=-5),$)},r.inflateEnd=function(w){if(!w||!w.state)return h;var A=w.state;return A.window&&(A.window=null),w.state=null,y},r.inflateGetHeader=function(w,A){var d;return w&&w.state&&2&(d=w.state).wrap?((d.head=A).done=!1,y):h},r.inflateSetDictionary=function(w,A){var d,F=A.length;return w&&w.state?(d=w.state).wrap!==0&&d.mode!==11?h:d.mode===11&&i(1,A,F,0)!==d.check?-3:M(w,A,F,F)?(d.mode=31,-4):(d.havedict=1,y):h},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,a,r){var s=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],c=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],f=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],_=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];a.exports=function(x,b,y,h,g,u,m,p){var v,S,k,E,P,T,L,R,O,M=p.bits,w=0,A=0,d=0,F=0,q=0,z=0,Q=0,H=0,X=0,N=0,I=null,Y=0,Z=new s.Buf16(16),V=new s.Buf16(16),se=null,K=0;for(w=0;w<=15;w++)Z[w]=0;for(A=0;A<h;A++)Z[b[y+A]]++;for(q=M,F=15;1<=F&&Z[F]===0;F--);if(F<q&&(q=F),F===0)return g[u++]=20971520,g[u++]=20971520,p.bits=1,0;for(d=1;d<F&&Z[d]===0;d++);for(q<d&&(q=d),w=H=1;w<=15;w++)if(H<<=1,(H-=Z[w])<0)return-1;if(0<H&&(x===0||F!==1))return-1;for(V[1]=0,w=1;w<15;w++)V[w+1]=V[w]+Z[w];for(A=0;A<h;A++)b[y+A]!==0&&(m[V[b[y+A]]++]=A);if(T=x===0?(I=se=m,19):x===1?(I=i,Y-=257,se=c,K-=257,256):(I=f,se=_,-1),w=d,P=u,Q=A=N=0,k=-1,E=(X=1<<(z=q))-1,x===1&&852<X||x===2&&592<X)return 1;for(;;){for(L=w-Q,O=m[A]<T?(R=0,m[A]):m[A]>T?(R=se[K+m[A]],I[Y+m[A]]):(R=96,0),v=1<<w-Q,d=S=1<<z;g[P+(N>>Q)+(S-=v)]=L<<24|R<<16|O|0,S!==0;);for(v=1<<w-1;N&v;)v>>=1;if(v!==0?(N&=v-1,N+=v):N=0,A++,--Z[w]==0){if(w===F)break;w=b[y+m[A]]}if(q<w&&(N&E)!==k){for(Q===0&&(Q=q),P+=d,H=1<<(z=w-Q);z+Q<F&&!((H-=Z[z+Q])<=0);)z++,H<<=1;if(X+=1<<z,x===1&&852<X||x===2&&592<X)return 1;g[k=N&E]=q<<24|z<<16|P-u|0}}return N!==0&&(g[P+N]=w-Q<<24|64<<16|0),p.bits=q,0}},{"../utils/common":41}],51:[function(e,a,r){a.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,a,r){var s=e("../utils/common"),i=0,c=1;function f(B){for(var D=B.length;0<=--D;)B[D]=0}var _=0,x=29,b=256,y=b+1+x,h=30,g=19,u=2*y+1,m=15,p=16,v=7,S=256,k=16,E=17,P=18,T=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],L=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],O=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],M=new Array(2*(y+2));f(M);var w=new Array(2*h);f(w);var A=new Array(512);f(A);var d=new Array(256);f(d);var F=new Array(x);f(F);var q,z,Q,H=new Array(h);function X(B,D,G,J,U){this.static_tree=B,this.extra_bits=D,this.extra_base=G,this.elems=J,this.max_length=U,this.has_stree=B&&B.length}function N(B,D){this.dyn_tree=B,this.max_code=0,this.stat_desc=D}function I(B){return B<256?A[B]:A[256+(B>>>7)]}function Y(B,D){B.pending_buf[B.pending++]=255&D,B.pending_buf[B.pending++]=D>>>8&255}function Z(B,D,G){B.bi_valid>p-G?(B.bi_buf|=D<<B.bi_valid&65535,Y(B,B.bi_buf),B.bi_buf=D>>p-B.bi_valid,B.bi_valid+=G-p):(B.bi_buf|=D<<B.bi_valid&65535,B.bi_valid+=G)}function V(B,D,G){Z(B,G[2*D],G[2*D+1])}function se(B,D){for(var G=0;G|=1&B,B>>>=1,G<<=1,0<--D;);return G>>>1}function K(B,D,G){var J,U,ee=new Array(m+1),oe=0;for(J=1;J<=m;J++)ee[J]=oe=oe+G[J-1]<<1;for(U=0;U<=D;U++){var te=B[2*U+1];te!==0&&(B[2*U]=se(ee[te]++,te))}}function re(B){var D;for(D=0;D<y;D++)B.dyn_ltree[2*D]=0;for(D=0;D<h;D++)B.dyn_dtree[2*D]=0;for(D=0;D<g;D++)B.bl_tree[2*D]=0;B.dyn_ltree[2*S]=1,B.opt_len=B.static_len=0,B.last_lit=B.matches=0}function le(B){8<B.bi_valid?Y(B,B.bi_buf):0<B.bi_valid&&(B.pending_buf[B.pending++]=B.bi_buf),B.bi_buf=0,B.bi_valid=0}function ce(B,D,G,J){var U=2*D,ee=2*G;return B[U]<B[ee]||B[U]===B[ee]&&J[D]<=J[G]}function ue(B,D,G){for(var J=B.heap[G],U=G<<1;U<=B.heap_len&&(U<B.heap_len&&ce(D,B.heap[U+1],B.heap[U],B.depth)&&U++,!ce(D,J,B.heap[U],B.depth));)B.heap[G]=B.heap[U],G=U,U<<=1;B.heap[G]=J}function pe(B,D,G){var J,U,ee,oe,te=0;if(B.last_lit!==0)for(;J=B.pending_buf[B.d_buf+2*te]<<8|B.pending_buf[B.d_buf+2*te+1],U=B.pending_buf[B.l_buf+te],te++,J===0?V(B,U,D):(V(B,(ee=d[U])+b+1,D),(oe=T[ee])!==0&&Z(B,U-=F[ee],oe),V(B,ee=I(--J),G),(oe=L[ee])!==0&&Z(B,J-=H[ee],oe)),te<B.last_lit;);V(B,S,D)}function be(B,D){var G,J,U,ee=D.dyn_tree,oe=D.stat_desc.static_tree,te=D.stat_desc.has_stree,ie=D.stat_desc.elems,he=-1;for(B.heap_len=0,B.heap_max=u,G=0;G<ie;G++)ee[2*G]!==0?(B.heap[++B.heap_len]=he=G,B.depth[G]=0):ee[2*G+1]=0;for(;B.heap_len<2;)ee[2*(U=B.heap[++B.heap_len]=he<2?++he:0)]=1,B.depth[U]=0,B.opt_len--,te&&(B.static_len-=oe[2*U+1]);for(D.max_code=he,G=B.heap_len>>1;1<=G;G--)ue(B,ee,G);for(U=ie;G=B.heap[1],B.heap[1]=B.heap[B.heap_len--],ue(B,ee,1),J=B.heap[1],B.heap[--B.heap_max]=G,B.heap[--B.heap_max]=J,ee[2*U]=ee[2*G]+ee[2*J],B.depth[U]=(B.depth[G]>=B.depth[J]?B.depth[G]:B.depth[J])+1,ee[2*G+1]=ee[2*J+1]=U,B.heap[1]=U++,ue(B,ee,1),2<=B.heap_len;);B.heap[--B.heap_max]=B.heap[1],function(fe,_e){var ye,je,Oe,ge,Te,Ge,Ee=_e.dyn_tree,$e=_e.max_code,Ze=_e.stat_desc.static_tree,it=_e.stat_desc.has_stree,Ut=_e.stat_desc.extra_bits,xt=_e.stat_desc.extra_base,Ke=_e.stat_desc.max_length,Je=0;for(ge=0;ge<=m;ge++)fe.bl_count[ge]=0;for(Ee[2*fe.heap[fe.heap_max]+1]=0,ye=fe.heap_max+1;ye<u;ye++)Ke<(ge=Ee[2*Ee[2*(je=fe.heap[ye])+1]+1]+1)&&(ge=Ke,Je++),Ee[2*je+1]=ge,$e<je||(fe.bl_count[ge]++,Te=0,xt<=je&&(Te=Ut[je-xt]),Ge=Ee[2*je],fe.opt_len+=Ge*(ge+Te),it&&(fe.static_len+=Ge*(Ze[2*je+1]+Te)));if(Je!==0){do{for(ge=Ke-1;fe.bl_count[ge]===0;)ge--;fe.bl_count[ge]--,fe.bl_count[ge+1]+=2,fe.bl_count[Ke]--,Je-=2}while(0<Je);for(ge=Ke;ge!==0;ge--)for(je=fe.bl_count[ge];je!==0;)$e<(Oe=fe.heap[--ye])||(Ee[2*Oe+1]!==ge&&(fe.opt_len+=(ge-Ee[2*Oe+1])*Ee[2*Oe],Ee[2*Oe+1]=ge),je--)}}(B,D),K(ee,he,B.bl_count)}function l(B,D,G){var J,U,ee=-1,oe=D[1],te=0,ie=7,he=4;for(oe===0&&(ie=138,he=3),D[2*(G+1)+1]=65535,J=0;J<=G;J++)U=oe,oe=D[2*(J+1)+1],++te<ie&&U===oe||(te<he?B.bl_tree[2*U]+=te:U!==0?(U!==ee&&B.bl_tree[2*U]++,B.bl_tree[2*k]++):te<=10?B.bl_tree[2*E]++:B.bl_tree[2*P]++,ee=U,he=(te=0)===oe?(ie=138,3):U===oe?(ie=6,3):(ie=7,4))}function $(B,D,G){var J,U,ee=-1,oe=D[1],te=0,ie=7,he=4;for(oe===0&&(ie=138,he=3),J=0;J<=G;J++)if(U=oe,oe=D[2*(J+1)+1],!(++te<ie&&U===oe)){if(te<he)for(;V(B,U,B.bl_tree),--te!=0;);else U!==0?(U!==ee&&(V(B,U,B.bl_tree),te--),V(B,k,B.bl_tree),Z(B,te-3,2)):te<=10?(V(B,E,B.bl_tree),Z(B,te-3,3)):(V(B,P,B.bl_tree),Z(B,te-11,7));ee=U,he=(te=0)===oe?(ie=138,3):U===oe?(ie=6,3):(ie=7,4)}}f(H);var W=!1;function j(B,D,G,J){Z(B,(_<<1)+(J?1:0),3),function(U,ee,oe,te){le(U),te&&(Y(U,oe),Y(U,~oe)),s.arraySet(U.pending_buf,U.window,ee,oe,U.pending),U.pending+=oe}(B,D,G,!0)}r._tr_init=function(B){W||(function(){var D,G,J,U,ee,oe=new Array(m+1);for(U=J=0;U<x-1;U++)for(F[U]=J,D=0;D<1<<T[U];D++)d[J++]=U;for(d[J-1]=U,U=ee=0;U<16;U++)for(H[U]=ee,D=0;D<1<<L[U];D++)A[ee++]=U;for(ee>>=7;U<h;U++)for(H[U]=ee<<7,D=0;D<1<<L[U]-7;D++)A[256+ee++]=U;for(G=0;G<=m;G++)oe[G]=0;for(D=0;D<=143;)M[2*D+1]=8,D++,oe[8]++;for(;D<=255;)M[2*D+1]=9,D++,oe[9]++;for(;D<=279;)M[2*D+1]=7,D++,oe[7]++;for(;D<=287;)M[2*D+1]=8,D++,oe[8]++;for(K(M,y+1,oe),D=0;D<h;D++)w[2*D+1]=5,w[2*D]=se(D,5);q=new X(M,T,b+1,y,m),z=new X(w,L,0,h,m),Q=new X(new Array(0),R,0,g,v)}(),W=!0),B.l_desc=new N(B.dyn_ltree,q),B.d_desc=new N(B.dyn_dtree,z),B.bl_desc=new N(B.bl_tree,Q),B.bi_buf=0,B.bi_valid=0,re(B)},r._tr_stored_block=j,r._tr_flush_block=function(B,D,G,J){var U,ee,oe=0;0<B.level?(B.strm.data_type===2&&(B.strm.data_type=function(te){var ie,he=4093624447;for(ie=0;ie<=31;ie++,he>>>=1)if(1&he&&te.dyn_ltree[2*ie]!==0)return i;if(te.dyn_ltree[18]!==0||te.dyn_ltree[20]!==0||te.dyn_ltree[26]!==0)return c;for(ie=32;ie<b;ie++)if(te.dyn_ltree[2*ie]!==0)return c;return i}(B)),be(B,B.l_desc),be(B,B.d_desc),oe=function(te){var ie;for(l(te,te.dyn_ltree,te.l_desc.max_code),l(te,te.dyn_dtree,te.d_desc.max_code),be(te,te.bl_desc),ie=g-1;3<=ie&&te.bl_tree[2*O[ie]+1]===0;ie--);return te.opt_len+=3*(ie+1)+5+5+4,ie}(B),U=B.opt_len+3+7>>>3,(ee=B.static_len+3+7>>>3)<=U&&(U=ee)):U=ee=G+5,G+4<=U&&D!==-1?j(B,D,G,J):B.strategy===4||ee===U?(Z(B,2+(J?1:0),3),pe(B,M,w)):(Z(B,4+(J?1:0),3),function(te,ie,he,fe){var _e;for(Z(te,ie-257,5),Z(te,he-1,5),Z(te,fe-4,4),_e=0;_e<fe;_e++)Z(te,te.bl_tree[2*O[_e]+1],3);$(te,te.dyn_ltree,ie-1),$(te,te.dyn_dtree,he-1)}(B,B.l_desc.max_code+1,B.d_desc.max_code+1,oe+1),pe(B,B.dyn_ltree,B.dyn_dtree)),re(B),J&&le(B)},r._tr_tally=function(B,D,G){return B.pending_buf[B.d_buf+2*B.last_lit]=D>>>8&255,B.pending_buf[B.d_buf+2*B.last_lit+1]=255&D,B.pending_buf[B.l_buf+B.last_lit]=255&G,B.last_lit++,D===0?B.dyn_ltree[2*G]++:(B.matches++,D--,B.dyn_ltree[2*(d[G]+b+1)]++,B.dyn_dtree[2*I(D)]++),B.last_lit===B.lit_bufsize-1},r._tr_align=function(B){Z(B,2,3),V(B,S,M),function(D){D.bi_valid===16?(Y(D,D.bi_buf),D.bi_buf=0,D.bi_valid=0):8<=D.bi_valid&&(D.pending_buf[D.pending++]=255&D.bi_buf,D.bi_buf>>=8,D.bi_valid-=8)}(B)}},{"../utils/common":41}],53:[function(e,a,r){a.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,a,r){(function(s){(function(i,c){if(!i.setImmediate){var f,_,x,b,y=1,h={},g=!1,u=i.document,m=Object.getPrototypeOf&&Object.getPrototypeOf(i);m=m&&m.setTimeout?m:i,f={}.toString.call(i.process)==="[object process]"?function(k){process.nextTick(function(){v(k)})}:function(){if(i.postMessage&&!i.importScripts){var k=!0,E=i.onmessage;return i.onmessage=function(){k=!1},i.postMessage("","*"),i.onmessage=E,k}}()?(b="setImmediate$"+Math.random()+"$",i.addEventListener?i.addEventListener("message",S,!1):i.attachEvent("onmessage",S),function(k){i.postMessage(b+k,"*")}):i.MessageChannel?((x=new MessageChannel).port1.onmessage=function(k){v(k.data)},function(k){x.port2.postMessage(k)}):u&&"onreadystatechange"in u.createElement("script")?(_=u.documentElement,function(k){var E=u.createElement("script");E.onreadystatechange=function(){v(k),E.onreadystatechange=null,_.removeChild(E),E=null},_.appendChild(E)}):function(k){setTimeout(v,0,k)},m.setImmediate=function(k){typeof k!="function"&&(k=new Function(""+k));for(var E=new Array(arguments.length-1),P=0;P<E.length;P++)E[P]=arguments[P+1];var T={callback:k,args:E};return h[y]=T,f(y),y++},m.clearImmediate=p}function p(k){delete h[k]}function v(k){if(g)setTimeout(v,0,k);else{var E=h[k];if(E){g=!0;try{(function(P){var T=P.callback,L=P.args;switch(L.length){case 0:T();break;case 1:T(L[0]);break;case 2:T(L[0],L[1]);break;case 3:T(L[0],L[1],L[2]);break;default:T.apply(c,L)}})(E)}finally{p(k),g=!1}}}}function S(k){k.source===i&&typeof k.data=="string"&&k.data.indexOf(b)===0&&v(+k.data.slice(b.length))}})(typeof self>"u"?s===void 0?this:s:self)}).call(this,typeof wt<"u"?wt:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Rr);var Oa=Rr.exports;const Ft=ns(Oa),Da="1.0.0";function za(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.version!="string"||typeof n.exportedAt!="number"||typeof n.pattern!="object"||n.pattern===null)return!1;const e=n.pattern;if(typeof e.id!="string"||typeof e.name!="string"||typeof e.bpm!="number"||typeof e.bars!="number"||!Array.isArray(e.grid)||!Array.isArray(e.drums))return!1;if(n.bgmConfig!==void 0){const a=n.bgmConfig;if(typeof a!="object"||typeof a.offsetMs!="number"||typeof a.volumePct!="number")return!1}if(n.bgmFile!==void 0){const a=n.bgmFile;if(!a||typeof a.id!="string"||typeof a.name!="string"||typeof a.size!="number"||typeof a.type!="string"||typeof a.data!="string"||typeof a.byteLength!="number"||a.data.length===0)return!1}return!0}async function Fa(t,n){try{let e,a=n;if(n!=null&&n.fileId){const _=await Sr(n.fileId);if(_){const x=await _.blob.arrayBuffer(),y=new Uint8Array(x).reduce((g,u)=>g+String.fromCharCode(u),""),h=btoa(y);e={id:_.id,name:_.name,size:_.size,type:_.type,data:h,byteLength:x.byteLength}}else a={offsetMs:n.offsetMs,volumePct:n.volumePct}}const r={version:Da,exportedAt:Date.now(),pattern:t,bgmConfig:a,bgmFile:e},s=new Ft;s.file("pattern.json",JSON.stringify(r,null,2));const i=await s.generateAsync({type:"blob"}),c=URL.createObjectURL(i),f=document.createElement("a");f.href=c,f.download=`${t.name}.zip`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(c)}catch(e){throw console.error("[Pattern Backup] Export failed:",e),e}}async function Ua(t){var n,e,a;try{const s=(await Ft.loadAsync(t)).file("pattern.json");if(!s)throw new Error("Invalid pattern file: missing pattern.json");const i=await s.async("string"),c=JSON.parse(i);if(!za(c))throw new Error("Invalid backup file: data structure validation failed");const f=c;let _;if(f.bgmConfig&&!f.bgmFile)_=void 0;else if(f.bgmFile){const x=atob(f.bgmFile.data),b=new Uint8Array(x.length);for(let u=0;u<x.length;u++)b[u]=x.charCodeAt(u);let y=f.bgmFile.type;if(!y||y===""){const u=(n=f.bgmFile.name.split(".").pop())==null?void 0:n.toLowerCase();u==="mp3"?y="audio/mpeg":u==="wav"?y="audio/wav":u==="ogg"?y="audio/ogg":u==="m4a"||u==="mp4"?y="audio/mp4":y="audio/mpeg"}const{id:h,meta:g}=await Br(f.bgmFile.data,f.bgmFile.name,y);_={fileId:h,offsetMs:((e=f.bgmConfig)==null?void 0:e.offsetMs)??0,volumePct:((a=f.bgmConfig)==null?void 0:a.volumePct)??100,meta:g}}return{pattern:f.pattern,bgmConfig:_}}catch(r){throw console.error("[Pattern Backup] Import failed:",r),r}}function Ha({patterns:t,currentPatternId:n,onSelectPattern:e,onSelectDraft:a,onAddPattern:r,onImportPattern:s,onImportPatternWithBgm:i,isDraftMode:c}){const[f,_]=C.useState(!1),[x,b]=C.useState(""),y=C.useRef(null),h=C.useRef(null),g=k=>{e(k)},u=async()=>{var k;(k=h.current)==null||k.click()},m=async k=>{var P;const E=(P=k.target.files)==null?void 0:P[0];if(E){if(!E.name.endsWith(".zip")){alert("Please select a valid pattern file (.zip format)");return}try{const{pattern:T,bgmConfig:L}=await Ua(E),R=JSON.stringify(T);i?i(R,L):s&&s(R),console.log("Pattern imported from zip file",{bgmConfig:L})}catch(T){console.error("Failed to import pattern:",T),alert("Failed to import pattern file. Please check the console for details.")}finally{h.current&&(h.current.value="")}}},p=()=>{x.trim()&&s&&s(x.trim()),_(!1),b("")},v=()=>{_(!1),b("")};C.useEffect(()=>{f&&y.current&&y.current.focus()},[f]);const S=[...t].sort((k,E)=>k.name.localeCompare(E.name));return o.jsxs("div",{className:"pattern-tabs",children:[o.jsx("input",{ref:h,type:"file",accept:".zip",style:{display:"none"},onChange:m}),o.jsx("button",{className:`pattern-tab draft-tab ${c?"active":""}`,onClick:a,"aria-label":"Draft Pattern",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 12 12",children:o.jsx("circle",{cx:"6",cy:"6",r:"4.5",fill:"none",stroke:"currentColor",strokeWidth:"1.5"})})}),S.length>0&&o.jsx("div",{className:"pattern-tabs-content",children:S.map(k=>{const E=!c&&k.id===n;return o.jsx("button",{className:`pattern-tab ${E?"active":""}`,onClick:()=>g(k),"aria-label":`Pattern ${k.name}`,children:k.name},k.id)})}),f?o.jsxs("div",{className:"import-input-container",children:[o.jsx("input",{ref:y,type:"text",className:"import-input",value:x,onChange:k=>b(k.target.value),onKeyDown:k=>{k.key==="Enter"?p():k.key==="Escape"&&v()},onBlur:()=>{setTimeout(()=>{x.trim()||v()},150)},placeholder:"Paste..."}),o.jsx("button",{className:"action-button confirm-button",onClick:p,"aria-label":"Confirm Import",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("polyline",{points:"20 6 9 17 4 12"})})})]}):o.jsxs(o.Fragment,{children:[o.jsx("button",{className:"action-button load-button",onClick:u,"aria-label":"Load New Pattern",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),o.jsx("button",{className:"action-button save-button",onClick:r,"aria-label":"Create New Pattern",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})}function Wa({config:t,isLoading:n,isLoaded:e,error:a,onUpload:r,onOffsetChange:s,onVolumeChange:i,onDelete:c,masterVolume:f,onMasterVolumeChange:_,isPlaying:x}){var N;const b=C.useRef(null),[y,h]=C.useState(!1),[g,u]=C.useState("0"),m=I=>{const Y=Un((t.volumePct??100)+I,0,100);i(Y)},p=I=>{const Y=Un(f+I,0,100);_(Y)},v=I=>{const Y=(t.offsetMs??0)+I;s(Y)},S=Ae(()=>m(-10),{clickCallback:()=>m(-10)}),k=Ae(()=>m(10),{clickCallback:()=>m(10)}),E=Ae(()=>p(-10),{clickCallback:()=>p(-10)}),P=Ae(()=>p(10),{clickCallback:()=>p(10)}),T=Ae(()=>v(-100),{clickCallback:()=>v(-10)}),L=Ae(()=>v(100),{clickCallback:()=>v(10)}),R=I=>{var Z;const Y=(Z=I.target.files)==null?void 0:Z[0];Y&&r(Y),I.target.value=""},O=(((N=t.meta)==null?void 0:N.name)??"").replace(/\.[^/.]+$/,""),M=Math.round(t.volumePct??100),w=Math.round(f),d=-(t.offsetMs??0),F=Math.abs(d)>=1e3?`${(d/1e3).toFixed(3)}s`:`${d}ms`,q=Math.round(d).toString(),z=()=>{x||(u(q),h(!0))},Q=()=>{const I=Number(g);if(!Number.isFinite(I)){h(!1);return}s(-I),h(!1)},H=()=>{const I=t.volumePct??100;i(I===0?100:0)},X=()=>{_(f===0?100:0)};return o.jsxs("div",{className:"bgm-controls-container",children:[o.jsxs("div",{className:"bgm-controls",children:[o.jsxs("div",{className:"bgm-controls-left",children:[t.fileId&&e&&!n?o.jsx("button",{type:"button",className:"bgm-delete-button",onClick:c,"aria-label":"Delete background music",title:"Delete background music",disabled:!t.fileId||n,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}):o.jsxs(o.Fragment,{children:[o.jsx("button",{type:"button",className:"bgm-control-button",onClick:()=>{var I;return(I=b.current)==null?void 0:I.click()},"aria-label":"Upload background music",title:"Upload background music",disabled:n,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),o.jsx("input",{ref:b,className:"bgm-file-input",type:"file",accept:"audio/mpeg",onChange:R})]}),O&&o.jsxs(o.Fragment,{children:[o.jsx("span",{className:"bgm-file-name",children:O||""}),o.jsxs("div",{className:"bgm-control-group",children:[o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music volume",title:"Decrease background music volume",...S,children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("div",{className:"bgm-control-center",children:o.jsx("button",{type:"button",className:"bgm-volume-display",onClick:H,"aria-label":"Toggle BGM volume",title:"Click to toggle 0%/100%",children:o.jsxs("span",{className:"bgm-control-value",children:[M,"%"]})})}),o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music volume",title:"Increase background music volume",...k,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),o.jsxs("div",{className:"bgm-control-group",children:[o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease background music offset",title:"Decrease background music offset",disabled:x,...L,children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("div",{className:"bgm-control-center",children:y?o.jsx("input",{type:"number",className:"bgm-offset-input",value:g,onChange:I=>u(I.target.value),onBlur:Q,onKeyDown:I=>{I.key==="Enter"?Q():I.key==="Escape"&&h(!1)},disabled:x,autoFocus:!0}):o.jsx("button",{type:"button",className:"bgm-offset-display",onClick:z,disabled:x,children:o.jsx("span",{className:"bgm-control-value",children:F})})}),o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase background music offset",title:"Increase background music offset",disabled:x,...T,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]})]}),o.jsx("div",{className:"bgm-controls-right",children:o.jsxs("div",{className:"bgm-control-group",children:[o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Decrease pattern volume",title:"Decrease pattern volume",...E,children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),o.jsx("div",{className:"bgm-control-center",children:o.jsx("button",{type:"button",className:"bgm-volume-display",onClick:X,"aria-label":"Toggle pattern volume",title:"Click to toggle 0%/100%",children:o.jsxs("span",{className:"bgm-control-value",children:[w,"%"]})})}),o.jsx("button",{type:"button",className:"bgm-control-button","aria-label":"Increase pattern volume",title:"Increase pattern volume",...P,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})})]}),a&&o.jsx("div",{className:"bgm-error",children:a})]})}function Un(t,n,e){return Math.min(e,Math.max(n,t))}const Va=393,Hn=23.0625,Ga=rr,Wn=24,$a=375;function Za(){const t=C.useCallback(()=>{const a=window.innerWidth;return a<$a?Hn:(Math.min(a,Ga)-Wn)*Hn/(Va-Wn)},[]),[n,e]=C.useState(t);return C.useEffect(()=>{const a=()=>{e(t())};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[t]),n}const Ka=24,Vn=23.0625;function qa(t,n=2){const e=C.useCallback(()=>{if(typeof window>"u")return Vn;const s=window.innerWidth,i=Math.min(s,rr)-Ka,c=t*me;return c<=0||n<=0?Vn:i/(c*n)},[t,n]),[a,r]=C.useState(e);return C.useEffect(()=>{const s=()=>{r(e())};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[e]),a}const Ar="drummer-full-practice-mode";let gt=!1;const an=new Set;let Gn=!1;function Ya(){if(typeof window>"u")return!1;const t=localStorage.getItem(Ar);if(!t)return!1;try{const n=JSON.parse(t);return typeof n=="boolean"?n:!1}catch{return!1}}function Ja(){an.forEach(t=>t())}function Xa(t){mn(),gt!==t&&(gt=t,typeof window<"u"&&localStorage.setItem(Ar,JSON.stringify(t)),Ja())}function mn(){Gn||typeof window>"u"||(gt=Ya(),Gn=!0)}function Qa(){return mn(),gt}function ei(){Xa(!gt)}function ti(t){return mn(),an.add(t),()=>an.delete(t)}function Ir(){return C.useSyncExternalStore(ti,Qa,()=>!1)}const cn=960;let Lt=!1;const ln=new Set;let $n=!1;function ni(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(orientation: landscape)").matches:window.innerWidth>window.innerHeight}function ri(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia(`(max-width: ${cn}px)`).matches:window.innerWidth<=cn}function si(){return typeof window>"u"?!1:typeof window.matchMedia=="function"?window.matchMedia("(pointer: coarse)").matches:typeof navigator<"u"?navigator.maxTouchPoints>0:!1}function pn(){return ni()&&ri()&&si()}function oi(){ln.forEach(t=>t())}function Nr(t){Lt!==t&&(Lt=t,oi())}function Ct(){Nr(pn())}function Pr(){var t;if(!($n||typeof window>"u")){if(Lt=pn(),window.addEventListener("resize",Ct),window.addEventListener("orientationchange",Ct),typeof window.matchMedia=="function"){const n=window.matchMedia(`(max-width: ${cn}px) and (orientation: landscape)`);if(typeof n.addEventListener=="function")n.addEventListener("change",Ct);else{const e=n;(t=e.addListener)==null||t.call(e,Ct)}}$n=!0}}function ai(){return Pr(),Lt}function ii(t){return Pr(),ln.add(t),Nr(pn()),()=>ln.delete(t)}function Lr(){return C.useSyncExternalStore(ii,ai,()=>!1)}function Zn(t){const{delay:n=500,onLongPress:e,onClick:a}=t,[r,s]=C.useState(null),i=C.useRef(null),c=C.useRef(!1),f=C.useRef(!1),_=C.useRef(0),x=C.useRef(e),b=C.useRef(a);x.current=e,b.current=a;const y=C.useCallback(()=>{c.current=!1,r&&r.classList.remove("active"),i.current&&(clearTimeout(i.current),i.current=null)},[r]),h=C.useCallback(()=>{c.current||(c.current=!0,_.current=Date.now(),f.current=!1,r&&r.classList.add("active"),i.current=setTimeout(()=>{c.current&&(f.current=!0,x.current())},n))},[n,r]),g=C.useCallback(()=>{const S=c.current,k=Date.now()-_.current,E=f.current;y(),S&&!E&&k<n&&b.current&&b.current()},[n,y]);C.useEffect(()=>{if(!r)return;const S=T=>{T.cancelable&&T.preventDefault(),h()},k=T=>{T.cancelable&&T.preventDefault(),g()},E=()=>{y()},P=T=>{T.preventDefault()};return r.addEventListener("touchstart",S,{passive:!1}),r.addEventListener("touchend",k,{passive:!1}),r.addEventListener("touchcancel",E),r.addEventListener("contextmenu",P),()=>{r.removeEventListener("touchstart",S),r.removeEventListener("touchend",k),r.removeEventListener("touchcancel",E),r.removeEventListener("contextmenu",P)}},[r,h,g,y]),C.useEffect(()=>()=>{y()},[y]);const u=C.useCallback(S=>{s(S)},[]),m=C.useCallback(S=>{S.preventDefault(),h()},[h]),p=C.useCallback(()=>{g()},[g]),v=C.useCallback(()=>{y()},[y]);return{ref:u,onMouseDown:m,onMouseUp:p,onMouseLeave:v}}async function ci(t){if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")try{return await navigator.clipboard.writeText(t),!0}catch{console.log("navigator.clipboard.writeText failed, trying fallback")}try{return li(t)}catch(n){return console.error("Failed to copy to clipboard:",n),!1}}function li(t){const n=document.createElement("textarea");if(n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="2em",n.style.height="2em",n.style.padding="0",n.style.border="none",n.style.outline="none",n.style.boxShadow="none",n.style.background="transparent",n.style.opacity="0",n.style.zIndex="-1",n.style.fontSize="16px",n.value=t,document.body.appendChild(n),/iPad|iPhone|iPod/.test(navigator.userAgent)){const r=document.createRange();r.selectNodeContents(n);const s=window.getSelection();s&&(s.removeAllRanges(),s.addRange(r)),n.setSelectionRange(0,t.length)}else n.focus(),n.select();let a=!1;try{a=document.execCommand("copy")}catch(r){console.error("execCommand copy failed:",r)}return document.body.removeChild(n),a}function ui(){var e;const t=window.isSecureContext!==void 0?window.isSecureContext:location.protocol==="https:"||location.hostname==="localhost",n=!!(navigator.clipboard&&typeof navigator.clipboard.writeText=="function");return t&&n||((e=document.queryCommandSupported)==null?void 0:e.call(document,"copy"))}function di(t){const[n,e]=C.useState(!1),[a,r]=C.useState(""),s=C.useRef(null);C.useEffect(()=>{n&&s.current&&(s.current.focus(),s.current.select())},[n]);const i=C.useCallback(()=>{r(t),e(!0)},[t]),c=C.useCallback(()=>{e(!1),r("")},[]),f=C.useCallback(async()=>{if(ui())try{if(await ci(t))return!0}catch{}return r(t),e(!0),!1},[t]);return{isExportMode:n,exportValue:a,exportInputRef:s,enterExportMode:i,cancelExport:c,tryExportToClipboard:f}}let ot=null;function fi(){ot!==null&&(cancelAnimationFrame(ot),ot=null)}function hi(t,n,e=150,a){fi();const r=t.scrollLeft,s=n-r,i=performance.now();function c(f){const _=f-i,x=Math.min(_/e,1),b=1-Math.pow(1-x,3);t.scrollLeft=r+s*b,x<1?ot=requestAnimationFrame(c):(ot=null,a==null||a())}ot=requestAnimationFrame(c)}function dt(t,n,e,a,r){const s={rangeStartBar:0,rangeEndBar:t.bars-1,rangeStartSub:0,rangeEndSub:r};if(!n)return s;const i=e?n.startPatternName==="":n.startPatternName===t.name,c=e?n.endPatternName==="":n.endPatternName===t.name;return{rangeStartBar:i?n.startBar:0,rangeEndBar:c?n.endBar:t.bars-1,rangeStartSub:i?n.startBar*a:0,rangeEndSub:c?(n.endBar+1)*a:r}}function mi({scrollContainerRef:t,currentBeat:n,cellSize:e,pattern:a,crossPatternLoop:r,isDraftMode:s,isPlaying:i}){const c=C.useRef(!1),f=C.useRef(null),_=C.useRef(null),x=C.useRef(!1),b=C.useRef(null),y=C.useRef(null),h=a.timeSignature[0],g=C.useMemo(()=>h*me,[h]),u=C.useMemo(()=>a.bars*g,[a.bars,g]),m=C.useMemo(()=>e*me/8,[e]),p=C.useCallback((v,S)=>{f.current!==S&&(c.current||(c.current=!0,f.current=S,hi(v,S,150,()=>{c.current=!1})))},[]);return C.useLayoutEffect(()=>{const v=t.current;if(!v)return;const S=_.current,k=a.id;if(S!==null&&S!==k){const E=dt(a,r,s,g,u),P=E.rangeStartBar*g*e;y.current=(E.rangeStartBar+1)*g,p(v,Math.max(0,P))}S!==k&&(b.current=null),_.current=k},[a.id,a,a.bars,e,g,u,t,r,s,p]),C.useEffect(()=>{if(n===void 0||!t.current)return;if(y.current!==null){if(n>=y.current)return;y.current=null}if(n>=u)return;const v=dt(a,r,s,g,u);if(n<v.rangeStartSub||n>=v.rangeEndSub)return;const S=t.current,k=n*e,E=S.scrollLeft,P=E+S.clientWidth,T=Math.floor(n/g);if(i&&b.current!==null&&T!==b.current){const L=T*g*e;p(S,Math.max(0,L)),b.current=T;return}if(b.current===null&&(b.current=T),k<E){const L=T*g*e;p(S,Math.max(0,L))}else if(k+e>P-m){if(!i){const M=T*g*e;p(S,Math.max(0,M));return}const L=dt(a,r,s,g,u);let R;T>=L.rangeEndBar?R=L.rangeStartBar:R=T+1;const O=R*g*e;p(S,Math.max(0,O))}},[n,e,i,m,p,g,u,a,a.bars,r,s,t]),C.useEffect(()=>{i||(f.current=null,x.current=!1,b.current=null)},[i,a.id]),C.useEffect(()=>{const v=t.current;if(!v)return;const S=!x.current&&i;if(x.current=i,!S||n===void 0||n>=u)return;const k=dt(a,r,s,g,u);if(n<k.rangeStartSub||n>=k.rangeEndSub)return;const E=Math.floor(n/g),P=E*g*e,T=v.scrollLeft,L=e;if(Math.abs(T-P)<=L)return;const R=n*e,O=T+v.clientWidth;if(R+e>O-m){const M=dt(a,r,s,g,u);let w;E>=M.rangeEndBar?w=M.rangeStartBar:w=E+1;const A=w*g*e;p(v,A)}else p(v,P)},[i,n,e,m,g,u,a,a.bars,r,s,t,p]),{scrollContainerRef:t,doScroll:p}}const pi=500;function gi({pattern:t,onCellClick:n,onToggleGhost:e,onCycleThirtySecond:a,onAddBar:r,onRemoveBar:s,onClearGrid:i,onClearBar:c,crossPatternLoop:f,onCrossPatternLoopChange:_,onSave:x,onSaveCurrentPattern:b,onImportPattern:y,onImportPatternWithBgm:h,onLoadFromSlot:g,onDeletePattern:u,onStopAllPlaying:m,onSelectDraft:p,savedPatterns:v,currentBeat:S,isPlaying:k=!1,onPlayToggle:E,isDraftMode:P,onNotationDoubleClick:T,canCopyPattern:L,hasCopiedPattern:R,canPastePattern:O,onCopyPattern:M,onPastePatternBefore:w,onPastePatternAfter:A,bgmConfig:d,bgmIsLoading:F,bgmIsLoaded:q,bgmError:z,onBgmUpload:Q,onBgmOffsetChange:H,onBgmVolumeChange:X,onBgmDelete:N,masterVolume:I,onMasterVolumeChange:Y,isCountInEnabled:Z,onCountInToggle:V,onBarBpmModeToggle:se,currentBarHasOverride:K=!1}){const re=C.useRef(null),le=C.useRef(t.bars),ce=C.useRef(!1),ue=C.useRef(void 0),pe=Ir(),be=Lr(),l=Za(),[$]=t.timeSignature,W=qa($,2),j=be?W:l,{doScroll:B}=mi({scrollContainerRef:re,currentBeat:S,cellSize:j,pattern:t,crossPatternLoop:f,isDraftMode:P,isPlaying:k}),D=v.find(ye=>ye.id===t.id),G=D?js(D):"",{isExportMode:J,exportValue:U,exportInputRef:ee,cancelExport:oe}=di(G),te=async()=>{if(D)try{await Fa(D,d),console.log("Pattern exported to zip file")}catch(ye){console.error("Failed to export pattern:",ye),alert("Failed to export pattern. Please check the console for details.")}},ie=C.useCallback(()=>{ce.current=!0,ue.current=S,r(S)},[r,S]),he=C.useCallback(()=>{ei()},[]),fe=Zn({delay:500,onLongPress:te,onClick:b}),_e=Zn({delay:pi,onLongPress:i,onClick:()=>{S!==void 0&&c(S)}});return C.useEffect(()=>{if(!ce.current||t.bars<=le.current){ce.current=!1,le.current=t.bars;return}if(!re.current||!f){ce.current=!1,le.current=t.bars;return}if(k){ce.current=!1,le.current=t.bars;return}if(P?f.endPatternName==="":f.endPatternName===t.name){const je=re.current,[Oe]=t.timeSignature,ge=Oe*me;let Te;if(ue.current!==void 0){const $e=Math.floor(ue.current/ge),Ze=ue.current%ge,it=ge/2;Ze<it?Te=$e:Te=$e+1}else Te=t.bars-1;const Ee=Te*ge*j;B(je,Ee)}ce.current=!1,le.current=t.bars},[t.bars,k,P,t.name,t.timeSignature,j,B,f]),o.jsxs("div",{className:`pattern-editor${be?" landscape-mode":""}`,children:[o.jsxs("div",{className:"pattern-editor-controls",children:[o.jsxs("div",{className:"pattern-bar-tools",children:[o.jsx(La,{bars:t.bars,onAddBar:ie,onRemoveBar:s,canRemove:t.bars>1,currentBeat:S}),L&&o.jsx("div",{className:"pattern-copy-controls",children:R?o.jsxs(o.Fragment,{children:[o.jsx("button",{type:"button",className:"pattern-tab",onClick:w,disabled:!O,"aria-label":"Paste pattern before",title:"Paste pattern before",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 5 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),o.jsx("button",{type:"button",className:"pattern-tab",onClick:A,disabled:!O,"aria-label":"Paste pattern after",title:"Paste pattern after",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 19 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})]}):o.jsx("button",{type:"button",className:"pattern-tab",onClick:M,"aria-label":"Copy pattern grid",title:"Copy pattern grid",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),o.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})}),se&&o.jsx("button",{type:"button",className:`bar-control-button bar-bpm-button${K?" active":""}`,onClick:se,"aria-label":"Toggle bar BPM mode","aria-pressed":K,title:K?"Clear current bar BPM":"Enter bar BPM mode",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),o.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})})]}),o.jsx(Ma,{currentPattern:t,savedPatterns:v,crossPatternLoop:f,onCrossPatternLoopChange:_,isDraftMode:P})]}),o.jsxs("div",{className:"pattern-editor-actions",children:[o.jsx("div",{className:"pattern-editor-actions-left",children:o.jsx(Ha,{patterns:v,currentPatternId:t.id,onSelectPattern:g,onSelectDraft:p,onAddPattern:x,onImportPattern:y,onImportPatternWithBgm:h,isDraftMode:P})}),o.jsxs("div",{className:"pattern-editor-actions-right",children:[o.jsx("button",{type:"button",className:`action-button count-in-toggle-button${Z?" active":""}`,onClick:V,"aria-label":"Toggle count-in",title:"Toggle count-in","aria-pressed":Z,children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),o.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),o.jsx("button",{type:"button",className:`action-button practice-toggle-button${pe?" active":""}`,onClick:he,"aria-label":"Toggle practice mode",title:"Toggle practice mode","aria-pressed":pe,children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M9 18V5l12-2v13"}),o.jsx("circle",{cx:"6",cy:"18",r:"3"}),o.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),!P&&v.some(ye=>ye.id===t.id)&&(J?o.jsx("input",{ref:ee,type:"text",className:"export-input",value:U,onChange:()=>{},onKeyDown:ye=>{ye.key==="Escape"&&oe()},onBlur:()=>{setTimeout(oe,150)},onFocus:ye=>{ye.target.select()},onClick:ye=>{ye.target.select()},onTouchEnd:ye=>{ye.target.select()}}):o.jsx("button",{className:"action-button save-current-button",...fe,"aria-label":"Save Pattern",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),o.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),o.jsx("polyline",{points:"7 3 7 8 15 8"})]})})),v.some(ye=>ye.id===t.id)&&o.jsx("button",{className:"action-button delete-button",onClick:()=>{m&&m(),setTimeout(()=>{window.confirm("Delete this pattern?")&&u(t.id)},0)},"aria-label":"Delete",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),o.jsx("button",{className:"action-button clear-button",..._e,"aria-label":"Clear (short press: clear current bar, long press: clear all)",children:o.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[o.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),o.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),pe&&o.jsx(Wa,{config:d,isLoading:F,isLoaded:q,error:z,onUpload:Q,onOffsetChange:H,onVolumeChange:X,masterVolume:I,onMasterVolumeChange:Y,onDelete:N,isPlaying:k}),o.jsxs("div",{className:"pattern-editor-scrollable",ref:re,children:[o.jsx(ja,{pattern:t,cellSize:j,currentBeat:S,scrollContainerRef:re,onDoubleClick:T}),o.jsx(Pa,{pattern:t,cellSize:j}),!be&&o.jsx(Na,{pattern:t,cellSize:j,onCellClick:n,onToggleGhost:e,onCellDoubleClick:a,currentBeat:S,scrollContainerRef:re})]})]})}function Kn({isPlaying:t,onClick:n,onLongPress:e,variant:a="floating",fullPracticeMode:r=!1,isCountInEnabled:s=!1}){const i=C.useRef(null),c=C.useRef(!1),f=500,_=()=>{t||e&&(c.current=!1,i.current=window.setTimeout(()=>{e(),c.current=!0,i.current=null},f))},x=()=>{i.current&&(clearTimeout(i.current),i.current=null)},b=()=>{i.current&&(clearTimeout(i.current),i.current=null)},y=()=>{t||e&&(c.current=!1,i.current=window.setTimeout(()=>{e(),c.current=!0,i.current=null},f))},h=u=>{i.current&&(clearTimeout(i.current),i.current=null),c.current&&(u.preventDefault(),setTimeout(()=>{c.current=!1},100))},g=u=>{if(c.current){u.preventDefault(),u.stopPropagation(),c.current=!1;return}if((r||s)&&t&&e){n(),setTimeout(()=>{c.current=!1,e()},300);return}else n()};return o.jsx("div",{className:`bottom-play-button-container${a==="inline"?" inline":""}`,children:o.jsx("button",{className:`bottom-play-button${a==="inline"?" inline":""}${t?" playing":" paused"}`,onClick:g,onMouseDown:_,onMouseUp:x,onMouseLeave:b,onTouchStart:y,onTouchEnd:h,"aria-label":t?"Pause Pattern":"Play Pattern",children:t?o.jsx(o.Fragment,{children:r||s?o.jsx("svg",{width:"30",height:"30",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):o.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:[o.jsx("rect",{x:"6",y:"4",width:"4",height:"16"}),o.jsx("rect",{x:"14",y:"4",width:"4",height:"16"})]})}):o.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",className:"play-icon",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})})})}const qn="1.12.1",Yn="2601282338",bi={name:"Dracula",colors:{bgColor:"#282a36",cardBg:"#44475a",bgSecondary:"#21222c",text:"#f8f8f2",textSecondary:"#acb8dd",textDim:"#596483",textTertiary:"#4e5771",border:"#434b62",primary:"#bd93f9",primaryHover:"#ff79c6",secondary:"#50fa7b",active:"#50fa7b",activeBg:"rgba(80, 250, 123, 0.2)",accentGlow:"rgba(189, 147, 249, 0.3)",danger:"#ff5555",dangerHover:"#ff6e6e",warning:"#f2f28c",warningHover:"#ffb86c",glassBg:"rgba(68, 71, 90, 0.5)",glassBgHover:"rgba(68, 71, 90, 0.7)",glassBorder:"rgba(139, 233, 253, 0.3)",overlayBg:"rgba(40, 42, 54, 0.9)",gridBorder:"rgba(139, 233, 253, 0.2)",gridCellBg:"#1a3a2a",gridCellBgAlt:"#1a3a2a94",beatLine:"#8be9fd"}},vi={name:"One",colors:{bgColor:"#282c34",cardBg:"#21252b",bgSecondary:"#1e2227",text:"#c6cedd",textSecondary:"#8c96a8",textDim:"#6c768e",textTertiary:"#586178",border:"rgba(171, 178, 191, 0.2)",primary:"#61afef",primaryHover:"#7aa6f2",secondary:"#98c379",active:"#98c379",activeBg:"rgba(152, 195, 121, 0.2)",accentGlow:"rgba(97, 175, 239, 0.3)",danger:"#e06c75",dangerHover:"#ff6b7a",warning:"#d19a66",warningHover:"#e5c07b",glassBg:"rgba(33, 37, 43, 0.6)",glassBgHover:"rgba(33, 37, 43, 0.8)",glassBorder:"rgba(171, 178, 191, 0.2)",overlayBg:"rgba(40, 44, 52, 0.9)",gridBorder:"rgba(171, 178, 191, 0.15)",gridCellBg:"#1f252d",gridCellBgAlt:"#1b2027",beatLine:"#61afef"}},yi={name:"Gruvbox",colors:{bgColor:"#282828",cardBg:"#3c3836",bgSecondary:"#1d2021",text:"#ebdbb2",textSecondary:"#928374",textDim:"#7c6f64",textTertiary:"#5a5047",border:"rgba(235, 219, 178, 0.2)",primary:"#fe8019",primaryHover:"#d65e0e",secondary:"#b8bb26",active:"#b8bb26",activeBg:"rgba(184, 187, 38, 0.2)",accentGlow:"rgba(254, 128, 25, 0.3)",danger:"#fb4934",dangerHover:"#cc241d",warning:"#fabd2f",warningHover:"#d79921",glassBg:"rgba(60, 56, 54, 0.6)",glassBgHover:"rgba(60, 56, 54, 0.8)",glassBorder:"rgba(235, 219, 178, 0.2)",overlayBg:"rgba(40, 40, 40, 0.9)",gridBorder:"rgba(235, 219, 178, 0.15)",gridCellBg:"#1d2021",gridCellBgAlt:"#191b1b",beatLine:"#fe8019"}},xi={name:"Monokai",colors:{bgColor:"#272822",cardBg:"#3e3d32",bgSecondary:"#1e1f1a",text:"#f8f8f2",textSecondary:"#a6a69c",textDim:"#75715e",textTertiary:"#5a594f",border:"rgba(248, 248, 242, 0.2)",primary:"#a6e22e",primaryHover:"#66d9ef",secondary:"#f92672",active:"#a6e22e",activeBg:"rgba(166, 226, 46, 0.2)",accentGlow:"rgba(249, 38, 114, 0.3)",danger:"#f92672",dangerHover:"#fe4e8e",warning:"#e6db74",warningHover:"#f1e8a0",glassBg:"rgba(62, 61, 50, 0.7)",glassBgHover:"rgba(62, 61, 50, 0.85)",glassBorder:"rgba(248, 248, 242, 0.15)",overlayBg:"rgba(39, 40, 34, 0.92)",gridBorder:"rgba(248, 248, 242, 0.12)",gridCellBg:"#2a2b26",gridCellBgAlt:"#21221e",beatLine:"#66d9ef"}},wi={name:"Campbell",colors:{bgColor:"#000",cardBg:"#1f1f1f",bgSecondary:"#080808",text:"#cccccc",textSecondary:"#a0a0a0",textDim:"#767676",textTertiary:"#5c5c5c",border:"rgba(204, 204, 204, 0.25)",primary:"#3a96dd",primaryHover:"#5cb3ff",secondary:"#13a10e",active:"#13a10e",activeBg:"rgba(19, 161, 14, 0.2)",accentGlow:"rgba(58, 150, 221, 0.3)",danger:"#c50f1f",dangerHover:"#e81123",warning:"#c19c00",warningHover:"#d9b812",glassBg:"rgba(31, 31, 31, 0.8)",glassBgHover:"rgba(31, 31, 31, 0.92)",glassBorder:"rgba(204, 204, 204, 0.15)",overlayBg:"rgba(12, 12, 12, 0.95)",gridBorder:"rgba(204, 204, 204, 0.1)",gridCellBg:"#121212",gridCellBgAlt:"#0a0a0a",beatLine:"#3a96dd"}},ki={name:"Solarized",colors:{bgColor:"#002b36",cardBg:"#073642",bgSecondary:"#001e26",text:"#a8bdc1",textSecondary:"#657b83",textDim:"#586e75",textTertiary:"#3d4d51",border:"rgba(131, 148, 150, 0.3)",primary:"#268bd2",primaryHover:"#2aa198",secondary:"#859900",active:"#859900",activeBg:"rgba(133, 153, 0, 0.2)",accentGlow:"rgba(38, 139, 210, 0.25)",danger:"#dc322f",dangerHover:"#cb4b16",warning:"#b58900",warningHover:"#d33682",glassBg:"rgba(7, 54, 66, 0.75)",glassBgHover:"rgba(7, 54, 66, 0.88)",glassBorder:"rgba(147, 161, 161, 0.2)",overlayBg:"rgba(0, 43, 54, 0.93)",gridBorder:"rgba(147, 161, 161, 0.15)",gridCellBg:"#093e48",gridCellBgAlt:"#08343d",beatLine:"#268bd2"}},_i={name:"Nord",colors:{bgColor:"#2e3440",cardBg:"#3b4252",bgSecondary:"#242933",text:"#d8dee9",textSecondary:"#a3be8c",textDim:"#7b88a1",textTertiary:"#4c566a",border:"rgba(216, 222, 233, 0.2)",primary:"#88c0d0",primaryHover:"#8fbcbb",secondary:"#a3be8c",active:"#a3be8c",activeBg:"rgba(163, 190, 140, 0.2)",accentGlow:"rgba(136, 192, 208, 0.25)",danger:"#bf616a",dangerHover:"#d08770",warning:"#ebcb8b",warningHover:"#eacb8b",glassBg:"rgba(59, 66, 82, 0.7)",glassBgHover:"rgba(59, 66, 82, 0.85)",glassBorder:"rgba(129, 161, 193, 0.2)",overlayBg:"rgba(46, 52, 64, 0.92)",gridBorder:"rgba(129, 161, 193, 0.15)",gridCellBg:"#353b49",gridCellBgAlt:"#313643",beatLine:"#88c0d0"}},Si={name:"Night",colors:{bgColor:"#1a1b26",cardBg:"#24283b",bgSecondary:"#16161e",text:"#c0caf5",textSecondary:"#a9b1d6",textDim:"#737aa2",textTertiary:"#565f89",border:"rgba(192, 202, 245, 0.2)",primary:"#7aa2f7",primaryHover:"#7dcfff",secondary:"#9ece6a",active:"#9ece6a",activeBg:"rgba(158, 206, 106, 0.2)",accentGlow:"rgba(122, 162, 247, 0.25)",danger:"#f7768e",dangerHover:"#db4b4b",warning:"#e0af68",warningHover:"#ff9e64",glassBg:"rgba(36, 40, 59, 0.75)",glassBgHover:"rgba(36, 40, 59, 0.88)",glassBorder:"rgba(187, 154, 247, 0.2)",overlayBg:"rgba(26, 27, 38, 0.93)",gridBorder:"rgba(169, 177, 214, 0.12)",gridCellBg:"#1f2335",gridCellBgAlt:"#1a1e2e",beatLine:"#7aa2f7"}},Bi={name:"Rose",colors:{bgColor:"#191724",cardBg:"#26233a",bgSecondary:"#131118",text:"#e0def4",textSecondary:"#c4a7e7",textDim:"#908caa",textTertiary:"#6e6a7e",border:"rgba(224, 222, 244, 0.2)",primary:"#c4a7e7",primaryHover:"#9ccfd8",secondary:"#3e8fb0",active:"#3e8fb0",activeBg:"rgba(62, 143, 176, 0.2)",accentGlow:"rgba(196, 167, 231, 0.2)",danger:"#eb6f92",dangerHover:"#f08ba3",warning:"#f6c177",warningHover:"#fad5a0",glassBg:"rgba(38, 35, 58, 0.75)",glassBgHover:"rgba(38, 35, 58, 0.88)",glassBorder:"rgba(196, 167, 231, 0.15)",overlayBg:"rgba(25, 23, 36, 0.93)",gridBorder:"rgba(156, 207, 216, 0.12)",gridCellBg:"#1f1d2e",gridCellBgAlt:"#1c1a26",beatLine:"#c4a7e7"}},Ci={name:"Yellow",colors:{bgColor:"#2b2620",cardBg:"#3a332a",bgSecondary:"#1f1b17",text:"#f2e6d4",textSecondary:"#d4c4b0",textDim:"#a89b8a",textTertiary:"#7a6f61",border:"rgba(242, 230, 212, 0.2)",primary:"#7fb3d5",primaryHover:"#5dade2",secondary:"#a5d6a7",active:"#a5d6a7",activeBg:"rgba(165, 214, 167, 0.2)",accentGlow:"rgba(127, 179, 213, 0.25)",danger:"#e67e22",dangerHover:"#f39c12",warning:"#f9d784",warningHover:"#ffe082",glassBg:"rgba(58, 51, 42, 0.75)",glassBgHover:"rgba(58, 51, 42, 0.88)",glassBorder:"rgba(242, 230, 212, 0.15)",overlayBg:"rgba(43, 38, 32, 0.93)",gridBorder:"rgba(242, 230, 212, 0.12)",gridCellBg:"#332b24",gridCellBgAlt:"#2e2720",beatLine:"#7fb3d5"}},Ye=[bi,vi,yi,xi,wi,ki,_i,Si,Bi,Ci];function Jn(t){const n=document.documentElement,e=t.colors;n.style.setProperty("--bg-color",e.bgColor),n.style.setProperty("--card-bg",e.cardBg),n.style.setProperty("--color-bg-secondary",e.bgSecondary),n.style.setProperty("--color-text",e.text),n.style.setProperty("--color-text-secondary",e.textSecondary),n.style.setProperty("--color-text-dim",e.textDim),n.style.setProperty("--color-text-tertiary",e.textTertiary),n.style.setProperty("--color-border",e.border),n.style.setProperty("--color-primary",e.primary),n.style.setProperty("--color-primary-hover",e.primaryHover),n.style.setProperty("--color-secondary",e.secondary),n.style.setProperty("--color-active",e.active),n.style.setProperty("--color-active-bg",e.activeBg),n.style.setProperty("--accent-glow",e.accentGlow),n.style.setProperty("--color-danger",e.danger),n.style.setProperty("--color-danger-hover",e.dangerHover),n.style.setProperty("--color-warning",e.warning),n.style.setProperty("--color-warning-hover",e.warningHover),n.style.setProperty("--glass-bg",e.glassBg),n.style.setProperty("--glass-bg-hover",e.glassBgHover),n.style.setProperty("--glass-border",e.glassBorder),n.style.setProperty("--overlay-bg",e.overlayBg),n.style.setProperty("--grid-border",e.gridBorder),n.style.setProperty("--grid-cell-bg",e.gridCellBg),n.style.setProperty("--grid-cell-bg-alt",e.gridCellBgAlt),n.style.setProperty("--color-beat-line",e.beatLine),n.style.setProperty("--theme-color",e.bgColor)}const Mr="drummer-theme",ji="Dracula";function Ei(){return Ye.find(n=>n.name===ji)||Ye[0]}function Ti(){try{const t=localStorage.getItem(Mr);if(t){const n=Ye.find(e=>e.name===t);if(n)return n}}catch(t){console.warn("Failed to load theme from localStorage:",t)}return Ei()}function Ri(t){try{localStorage.setItem(Mr,t)}catch(n){console.warn("Failed to save theme to localStorage:",n)}}function Ai(){const[t,n]=C.useState(()=>{const a=Ti();return Jn(a),a});return{currentTheme:t,cycleTheme:()=>{const r=(Ye.findIndex(i=>i.name===t.name)+1)%Ye.length,s=Ye[r];n(s),Jn(s),Ri(s.name)},themes:Ye}}const Ii="1.0.0";function Ni(t){if(typeof t!="object"||t===null)return!1;const n=t;if(typeof n.version!="string"||typeof n.exportedAt!="number"||typeof n.localStorage!="object"||n.localStorage===null||!Array.isArray(n.bgmFiles))return!1;for(const e of n.bgmFiles)if(typeof e.id!="string"||typeof e.name!="string"||typeof e.size!="number"||typeof e.type!="string"||typeof e.data!="string"||typeof e.byteLength!="number"||e.data.length===0)return!1;return!0}function Pi(){const t={};for(let n=0;n<localStorage.length;n++){const e=localStorage.key(n);if(e){const a=localStorage.getItem(e);a!==null&&(t[e]=a)}}return t}async function Li(){const t=await qo();return await Promise.all(t.map(async e=>{const a=await e.blob.arrayBuffer(),s=new Uint8Array(a).reduce((c,f)=>c+String.fromCharCode(f),""),i=btoa(s);return{id:e.id,name:e.name,size:e.size,type:e.type,data:i,byteLength:a.byteLength}}))}async function Mi(){try{const t=Pi(),n=await Li(),e={version:Ii,exportedAt:Date.now(),localStorage:t,bgmFiles:n},a=new Ft;a.file("config.json",JSON.stringify(e,null,2));const r=await a.generateAsync({type:"blob"}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s;const c=new Date,f=c.toISOString().slice(0,10).replace(/-/g,""),_=c.toTimeString().slice(0,8).replace(/:/g,"");i.download=`drummer-config-${f}-${_}.zip`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}catch(t){throw console.error("[Config Backup] Export failed:",t),t}}function Oi(t){localStorage.clear();for(const[n,e]of Object.entries(t))localStorage.setItem(n,e)}async function Di(t){var e;await Yo();const n=new Map;for(const a of t){let r=a.type;if(!r||r===""){const i=(e=a.name.split(".").pop())==null?void 0:e.toLowerCase();i==="mp3"?r="audio/mpeg":i==="wav"?r="audio/wav":i==="ogg"?r="audio/ogg":i==="m4a"||i==="mp4"?r="audio/mp4":r="audio/mpeg"}const{id:s}=await Br(a.data,a.name,r);n.set(a.id,s)}return n}function zi(t){const n="drummer-bgm-config",e=localStorage.getItem(n);if(e)try{const a=JSON.parse(e);let r=!1;for(const s of Object.values(a))s.fileId&&t.has(s.fileId)&&(s.fileId=t.get(s.fileId),r=!0);r&&localStorage.setItem(n,JSON.stringify(a))}catch{}}async function Fi(t){try{const e=(await Ft.loadAsync(t)).file("config.json");if(!e)throw new Error("Invalid configuration file: missing config.json");const a=await e.async("string"),r=JSON.parse(a);if(!Ni(r))throw new Error("Invalid backup file: data structure validation failed");const s=r;Oi(s.localStorage);const i=await Di(s.bgmFiles);zi(i),window.location.reload()}catch(n){throw console.error("[Config Backup] Import failed:",n),n}}function Ui(){const[t,n]=C.useState(!1),[e,a]=C.useState(!1),[r,s]=C.useState("idle"),[i,c]=C.useState(!1),[f,_]=C.useState(!1),[x,b]=C.useState({}),y=C.useRef(null),h=C.useRef(null),g=C.useRef(null),{currentTheme:u,cycleTheme:m}=Ai(),p=["Crash 1","Crash 2","Hi-Hat Open","Hi-Hat Closed","Ride","Tom 1","Tom 2","Snare","Tom 3","Kick"];C.useEffect(()=>{b(dn())},[]);const v=async(O,M)=>{Rs(O,M),b(w=>({...w,[O]:M})),await jo(),await sn(O)},S=C.useCallback(()=>{f||(h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{n(!1),localStorage.getItem("drummer-first-shown")||(a(!0),localStorage.setItem("drummer-first-shown","true"),g.current=setTimeout(()=>{a(!1)},1e4))},1e4))},[f]);C.useEffect(()=>()=>{h.current&&clearTimeout(h.current),g.current&&clearTimeout(g.current)},[]),C.useEffect(()=>{localStorage.getItem("drummer-visited")||(n(!0),localStorage.setItem("drummer-visited","true"))},[]),C.useEffect(()=>{const O=()=>{n(!0),a(!1)};return window.addEventListener("show-version",O),()=>{window.removeEventListener("show-version",O)}},[]),C.useEffect(()=>{if(!t){h.current&&(clearTimeout(h.current),h.current=null);return}S();const O=["mousemove","mousedown","touchstart","touchmove","keydown","click"],M=()=>{S()};return O.forEach(w=>{window.addEventListener(w,M)}),()=>{O.forEach(w=>{window.removeEventListener(w,M)}),h.current&&clearTimeout(h.current)}},[t,S]);const k=async()=>{var O,M,w;console.log("[Refresh] === handleRefresh started ==="),console.log("[Refresh] Current version:",qn,"Build time:",Yn),console.log("[Refresh] Set status: checking"),s("checking");try{if(!("serviceWorker"in navigator)){console.log("[Refresh] ❌ Browser doesn't support ServiceWorker, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Browser supports ServiceWorker"),console.log("[Refresh] Getting ServiceWorker registration...");const A=await navigator.serviceWorker.getRegistration();if(!A){console.log("[Refresh] ❌ No registration found, reloading page directly"),window.location.reload();return}console.log("[Refresh] ✓ Got registration:",{scope:A.scope,active:(O=A.active)==null?void 0:O.state,waiting:(M=A.waiting)==null?void 0:M.state,installing:(w=A.installing)==null?void 0:w.state});const d=()=>{console.log("[Refresh] 🔄 controllerchange event triggered! Reloading page..."),window.location.reload()};if(navigator.serviceWorker.addEventListener("controllerchange",d,{once:!0}),console.log("[Refresh] ✓ Added controllerchange listener"),A.waiting){console.log("[Refresh] ⚡ Found waiting worker, activating directly"),console.log("[Refresh] waiting worker state:",A.waiting.state),s("activating"),console.log("[Refresh] Sending SKIP_WAITING message to waiting worker"),A.waiting.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] No waiting worker currently"),console.log("[Refresh] Set 10 second timeout");const F=setTimeout(()=>{console.log("[Refresh] ⏰ 10s timeout! Removing listener and reloading page"),navigator.serviceWorker.removeEventListener("controllerchange",d),window.location.reload()},1e4),q=()=>{console.log("[Refresh] 🎉 updatefound event triggered! New SW started installing"),s("downloading");const H=A.installing;if(!H){console.log("[Refresh] ❌ updatefound triggered but installing is null");return}console.log("[Refresh] New worker initial state:",H.state),H.addEventListener("statechange",()=>{console.log("[Refresh] New worker state changed:",H.state),H.state==="installing"&&(console.log("[Refresh] Set status: installing"),s("installing")),H.state==="installed"&&(console.log("[Refresh] New worker installation complete, set status: activating"),s("activating"),clearTimeout(F),console.log("[Refresh] Cleared timeout timer"),console.log("[Refresh] Sending SKIP_WAITING message to new worker"),H.postMessage({type:"SKIP_WAITING"}))})};A.addEventListener("updatefound",q,{once:!0}),console.log("[Refresh] ✓ Added updatefound listener"),console.log("[Refresh] Calling registration.update() to check for updates...");try{await A.update(),console.log("[Refresh] ✓ registration.update() completed")}catch(H){console.warn("[Refresh] ⚠️ Update check failed:",H)}const z=A.waiting;if(console.log("[Refresh] After update(), checking waiting:",(z==null?void 0:z.state)||"null"),z){console.log("[Refresh] ⚡ Found waiting worker after update(), activating directly"),s("activating"),clearTimeout(F),console.log("[Refresh] Sending SKIP_WAITING message"),z.postMessage({type:"SKIP_WAITING"});return}console.log("[Refresh] Set 5 second no-update detection timer");const Q=setTimeout(()=>{var H,X;console.log("[Refresh] ⏰ 5s check: checking for updates..."),console.log("[Refresh] installing:",((H=A.installing)==null?void 0:H.state)||"null"),console.log("[Refresh] waiting:",((X=A.waiting)==null?void 0:X.state)||"null"),!A.installing&&!A.waiting?(console.log("[Refresh] 📌 Confirmed no update, set status: no-update"),s("no-update"),clearTimeout(F),navigator.serviceWorker.removeEventListener("controllerchange",d),console.log("[Refresh] Reloading page in 1 second..."),setTimeout(()=>{console.log("[Refresh] 🔄 Executing page reload"),window.location.reload()},1e3)):console.log("[Refresh] Found installing or waiting, continuing to wait")},5e3);A.addEventListener("updatefound",()=>{console.log("[Refresh] updatefound triggered, clearing no-update detection timer"),clearTimeout(Q)},{once:!0}),console.log("[Refresh] === handleRefresh initialization complete, waiting for events ===")}catch(A){console.error("[Refresh] ❌ Exception:",A),console.log("[Refresh] Reloading page due to exception"),window.location.reload()}},E=()=>{switch(r){case"checking":return"Checking...";case"downloading":return"Downloading...";case"installing":return"Installing...";case"activating":return"Activating...";case"no-update":return"Latest version";default:return`v${qn} - ${Yn}`}},P=async()=>{if(!i)try{c(!0),await Mi()}catch(O){console.error("[Settings] Export failed:",O),alert("Failed to export configuration. Please check the console for details.")}finally{c(!1)}},T=()=>{var O;(O=y.current)==null||O.click()},L=async O=>{var w;const M=(w=O.target.files)==null?void 0:w[0];if(M){if(!M.name.endsWith(".zip")){alert("Please select a valid configuration file (.zip format)");return}try{await Fi(M)}catch(A){console.error("[Settings] Import failed:",A),alert("Failed to import configuration. Please check the console for details.")}finally{y.current&&(y.current.value="")}}},R=r!=="idle";return o.jsxs(o.Fragment,{children:[e&&o.jsx("div",{className:"settings-first-hint visible",children:"Tap 5 times quickly to show settings"}),o.jsxs("div",{className:`settings ${t?"visible":"hidden"}`,children:[o.jsxs("div",{className:"settings-theme",onClick:m,children:[o.jsx("button",{type:"button",className:"settings-theme-button",title:`Current theme: ${u.name}. Click to cycle theme.`,children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),o.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),o.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),o.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),o.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),u.name]}),o.jsxs("div",{className:"settings-config",children:[o.jsx("input",{ref:y,type:"file",accept:".zip",style:{display:"none"},onChange:L}),o.jsx("button",{type:"button",className:"settings-config-button",onClick:T,title:"Load settings from a zip file",children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"17 8 12 3 7 8"}),o.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})}),o.jsx("button",{type:"button",className:`settings-config-button ${i?"exporting":""}`,onClick:P,title:"Export all settings to a zip file",disabled:i,children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"7 10 12 15 17 10"}),o.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),o.jsx("button",{type:"button",className:"settings-config-button",onClick:()=>_(!0),title:"About",children:o.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),o.jsx("circle",{cx:"12",cy:"12",r:"3"})]})})]})]}),f&&o.jsx("div",{className:"settings-modal-mask",onClick:()=>_(!1),children:o.jsxs("div",{className:"settings-modal",onClick:O=>O.stopPropagation(),children:[o.jsxs("div",{className:"settings-modal-header",children:[o.jsx("h2",{children:"Drummer - Beat Maker"}),o.jsx("button",{type:"button",className:"settings-modal-close",onClick:()=>_(!1),children:o.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),o.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),o.jsxs("div",{className:"settings-modal-content",children:[o.jsx("h3",{className:"settings-modal-subtitle",children:"Features & Usage"}),o.jsx("p",{className:"settings-modal-description",children:"A step-by-step guide for first-time users. Read top to bottom to learn the full workflow and discover hidden gestures."}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Top Bar: Metronome and Tempo"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Beat dots"}),": click to cycle time signatures (4/4, 3/4, 2/4, 6/8, 5/4, 7/8)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Tempo"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click for 0.5 BPM steps, press and hold to keep changing."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"BPM number"}),": tap the left/right side of the digits to cycle speed rates (a rate label appears)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Play"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": start or stop playback. Long-press to reset the loop counter to 0."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Patterns, Bars, and Loop Range"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Tabs"}),": the circle is Draft; letter tabs are saved patterns. Click a tab to load it."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"New pattern"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": save the current draft as a new pattern tab."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Import pattern"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),": load a pattern zip file."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Bars"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": remove or add a bar (uses your cursor position when possible)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Loop range"}),": choose start/end pattern and bar; press and hold the +/- buttons to move faster."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Per-bar BPM"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("line",{x1:"12",y1:"12",x2:"16",y2:"7"}),o.jsx("circle",{cx:"12",cy:"12",r:"1.5"})]})}),": click to set or clear BPM for the current bar."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Copy/Paste"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("rect",{x:"9",y:"9",width:"10",height:"10",rx:"2"}),o.jsx("rect",{x:"5",y:"5",width:"10",height:"10",rx:"2"})]})})," ","then"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 5 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("polyline",{points:"12 5 19 12 12 19"}),o.jsx("line",{x1:"19",y1:"12",x2:"5",y2:"12"})]})}),": duplicate a whole pattern grid before or after."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Grid Editor and Notation"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Single click/tap"}),": toggle a cell on or off."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Double-click/tap"}),": cycle 32nd-note states (double, first, second, back to normal)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Long-press on an active cell"}),": cycle note type (normal to ghost to grace) when supported."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Notation view"}),": double-click/tap to jump the playhead (disabled when a rate label is active)."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Action Buttons (Right Side)"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Count-in"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M6 20 L12 4 L18 20 Z"}),o.jsx("line",{x1:"12",y1:"16",x2:"16",y2:"6"})]})}),": toggle a one-bar count-in before playback."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Practice mode"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M9 18V5l12-2v13"}),o.jsx("circle",{cx:"6",cy:"18",r:"3"}),o.jsx("circle",{cx:"18",cy:"16",r:"3"})]})}),": show background music and volume controls."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Play (bottom)"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("polygon",{points:"6 3 18 12 6 21"})})}),": tap to play/pause. Long-press to stop and jump to the loop start."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Save current"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"}),o.jsx("polyline",{points:"17 21 17 13 7 13 7 21"}),o.jsx("polyline",{points:"7 3 7 8 15 8"})]})}),": save edits to the current pattern. Long-press to export a pattern zip (includes BGM)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Delete"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),": remove the current pattern."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Clear"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",children:[o.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),o.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),": short press clears the current bar, long-press clears all bars."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Background Music (Practice Mode)"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Upload"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12 3v12"}),o.jsx("polyline",{points:"8 7 12 3 16 7"}),o.jsx("path",{d:"M4 21h16v0"})]})}),": add an MP3 file, or"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("polyline",{points:"3 6 5 6 21 6"}),o.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})})," ","to delete it."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Volume"})," ",o.jsx("span",{className:"settings-icon",children:o.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),o.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),": click or press-and-hold to adjust. Click the % number to mute/unmute."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Offset"}),": click the ms/s value to type an exact offset (disabled while playing)."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Pattern volume"}),": the right-side controls adjust drum volume (same +/- and mute behavior)."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Settings and About"}),o.jsxs("ul",{children:[o.jsxs("li",{children:[o.jsx("strong",{children:"Theme"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("circle",{cx:"13.5",cy:"6.5",r:".5"}),o.jsx("circle",{cx:"17.5",cy:"10.5",r:".5"}),o.jsx("circle",{cx:"8.5",cy:"7.5",r:".5"}),o.jsx("circle",{cx:"6.5",cy:"12.5",r:".5"}),o.jsx("path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"})]})}),": click to cycle themes."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Backup and Restore"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"17 8 12 3 7 8"}),o.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]})})," ","/"," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),o.jsx("polyline",{points:"7 10 12 15 17 10"}),o.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}),": import or export all data as a zip file."]}),o.jsxs("li",{children:[o.jsx("strong",{children:"Settings"})," ",o.jsx("span",{className:"settings-icon",children:o.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),o.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}),": open this."]})]})]}),o.jsxs("div",{className:"settings-modal-section",children:[o.jsx("h3",{children:"Drum Samples Selection"}),o.jsx("p",{className:"settings-modal-description",children:"Choose between different sample variants (A/B/C) for each drum. Click to preview."}),o.jsx("div",{className:"sample-selection-list",children:p.map(O=>{const M=x[O]||"A";return o.jsxs("div",{className:"sample-selection-item",children:[o.jsx("div",{className:"sample-selection-drum",children:O}),o.jsx("div",{className:"sample-selection-variants",children:["A","B","C"].map(w=>o.jsx("button",{type:"button",className:`sample-variant-button ${M===w?"active":""}`,onClick:()=>v(O,w),title:`Select ${w} variant for ${O}`,children:w},w))})]},O)})})]})]}),o.jsx("div",{className:`settings-modal-version ${R?"updating":""}`,onClick:k,children:E()},`version-${r}`)]})})]})}let Xn=0;const Hi=16;function ft(t,n,e){const a=Math.max(0,e);setTimeout(()=>{Date.now()-Xn>=Hi?requestAnimationFrame(()=>{Xn=Date.now(),n(t)}):n(t)},a)}function Wi({currentPattern:t,savedPatterns:n,crossPatternLoop:e,isPlaying:a,isDraftMode:r,playbackRate:s=1,onSubdivisionChange:i,onPatternChange:c,onPlayStart:f}){const _=C.useRef(0),x=C.useRef(.2),b=C.useRef(50),y=C.useRef(null),h=C.useRef(!1),g=C.useRef(0),u=C.useRef(0),m=C.useRef([]),p=C.useRef(i),v=C.useRef(c),S=C.useRef(f),k=C.useRef(t),E=C.useRef(r);p.current=i,v.current=c,S.current=f,k.current=t,E.current=r;const P=C.useRef(s);P.current=s;const T=C.useCallback((q,z)=>{let Q=q.bpm;if(z!==void 0&&q.barBpmOverrides){const[N]=q.timeSignature,I=N*me,Y=Math.floor(z/I);Q=q.barBpmOverrides[Y]??q.bpm}return 60/(Q*P.current)*(4/q.timeSignature[1])/me},[]),L=C.useCallback(q=>{const[z]=q.timeSignature;return z*me},[]),R=C.useCallback(q=>{const z=m.current;if(z.length===0)return;let Q=-1,H=q;for(let I=0;I<z.length;I++){const Y=z[I],Z=L(Y.pattern),V=Y.startBar*Z,se=(Y.endBar+1)*Z;if(q>=V&&q<se){Q=I,H=q;break}}if(Q===-1){Q=0;const I=z[0],Y=L(I.pattern);H=I.startBar*Y}if(g.current=Q,u.current=H,h.current){const I=Be();_.current=I.currentTime}const X=p.current;X&&ft(H,X,0);const N=v.current;if(N){const I=z[Q];N(I.patternName)}},[L]),O=C.useCallback(()=>{const q=[];if(!e)return q.push({patternName:r?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),q;const{startPatternName:z,startBar:Q,endPatternName:H,endBar:X}=e,N=[...n].sort((V,se)=>V.name.localeCompare(se.name)),I=r?[{name:"",pattern:t},...N.map(V=>({name:V.name,pattern:V}))]:N.map(V=>V.id===t.id?{name:V.name,pattern:t}:{name:V.name,pattern:V}),Y=I.findIndex(V=>V.name===z),Z=I.findIndex(V=>V.name===H);if(Y===-1||Z===-1)return q.push({patternName:r?"":t.name,pattern:t,startBar:0,endBar:t.bars-1}),q;for(let V=Y;V<=Z;V++){const{name:se,pattern:K}=I[V],re=V===Y?Q:0,le=V===Z?X:K.bars-1;q.push({patternName:se,pattern:K,startBar:re,endBar:le})}return q},[t,n,e,r]);C.useEffect(()=>{m.current=O()},[O]);const M=C.useCallback((q,z,Q)=>{const H=T(q,z),X=H/2,N=(I,Y,Z)=>{switch(Oo(Z),I){case"Kick":gr(Y);break;case"Snare":rn(Y);break;case"Hi-Hat Closed":br(Y);break;case"Hi-Hat Open":vr(Y);break;case"Crash 1":Nt(Y,1.2);break;case"Crash 2":Nt(Y,1);break;case"Ride":yr(Y);break;case"Tom 1":st(Y,250);break;case"Tom 2":st(Y,200);break;case"Tom 3":st(Y,150);break}Do()};q.grid.forEach((I,Y)=>{const Z=I[z];if(Z===Ce)return;const V=q.drums[Y],se=Q;if(Z===We){const re=se-H*.125;N(V,re,.5),N(V,se,1);return}if(Z===Me||Z===Fe||Z===Ue){(Z===Me||Z===Fe)&&N(V,se,1),(Z===Me||Z===Ue)&&N(V,se+X,1);return}N(V,se,Z===Pe?.3:1)})},[T]),w=C.useCallback(()=>{const q=Be();if(!h.current)return;const z=q.currentTime,Q=m.current;if(Q.length!==0)for(;_.current<z+x.current;){let H=g.current,X=u.current;if(H<0||H>=Q.length){H=0;const re=Q[0],le=L(re.pattern);X=re.startBar*le,g.current=0,u.current=X;const ce=v.current;ce&&ce(re.patternName),_.current<z&&(_.current=z);continue}const N=Q[H],I=L(N.pattern),Y=N.startBar*I,Z=(N.endBar+1)*I;if(X>=Z){if(g.current=H+1,H+1<Q.length){const re=Q[H+1],le=L(re.pattern);u.current=re.startBar*le;const ce=v.current;ce&&ce(re.patternName)}continue}X<Y&&(X=Y,u.current=Y);const V=Math.max(_.current,z),se=(V-z)*1e3;if(M(N.pattern,X,V),h.current){const re=p.current;re&&ft(X,re,se)}u.current=X+1;const K=T(N.pattern,X);_.current+=K}},[M,T,L]),A=C.useCallback(async()=>{const q=Be();if(h.current)return;q.state==="suspended"&&await q.resume(),await new Promise(Y=>requestAnimationFrame(Y)),jr(),h.current=!0;const z=q.currentTime,Q=m.current;if(Q.length===0)return;const H=S.current;H&&H(z);let X=!0;const N=g.current,I=u.current;if(N>=0&&N<Q.length){const Y=Q[N],Z=L(Y.pattern),V=Y.startBar*Z,se=(Y.endBar+1)*Z,K=I>=V&&I<se,re=Y.pattern.id===k.current.id;K&&re&&(X=!1)}if(X){const Y=k.current.id;let Z=Q.findIndex(ce=>ce.pattern.id===Y);if(Z===-1){const ce=E.current?"":k.current.name;Z=Q.findIndex(ue=>ue.patternName===ce)}Z===-1&&(Z=0);const V=Q[Z],se=L(V.pattern),K=V.startBar*se;g.current=Z,u.current=K;const re=v.current;re&&re(V.patternName);const le=p.current;le&&ft(K,le,0)}else{const Y=p.current;Y&&ft(I,Y,0)}_.current=z,w(),y.current=window.setInterval(w,b.current)},[w,L]),d=C.useCallback(()=>{h.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),on()},[]);C.useEffect(()=>(a?A():d(),()=>{d()}),[a,A,d]);const F=C.useCallback(()=>{const q=m.current;if(q.length===0)return;h.current&&(h.current=!1,y.current!==null&&(clearInterval(y.current),y.current=null),on());const z=q[0],Q=L(z.pattern),H=z.startBar*Q;g.current=0,u.current=H;const X=p.current;X&&ft(H,X,0);const N=v.current;N&&N(z.patternName)},[L]);return{seekTo:R,resetToRangeStart:F}}function Vi(t,n,e){if(!n)return!1;const{startPatternName:a,endPatternName:r}=n;if(a===r)return!1;const i=["",...e.map(x=>x.name).sort((x,b)=>x.localeCompare(b))],c=i.indexOf(a),f=i.indexOf(r),_=i.indexOf(t);return _>=c&&_<=f}function jt(t,n,e,a,r){t&&n(!1),e&&a(!1),r()}function Gi(){const{isLoading:t,loadingProgress:n,showProgress:e}=Uo(),{isMetronomePlaying:a,isPatternPlaying:r,toggleMetronomePlay:s,togglePatternPlay:i,stopAll:c,setIsMetronomePlaying:f,setIsPatternPlaying:_}=Go(),x=Ir(),b=Lr(),[y,h]=C.useState(0),[g,u]=C.useState([]),[m,p]=C.useState(!0),v=C.useRef(null),S=C.useRef(null),[k,E]=C.useState(0),[P,T]=C.useState(()=>Tn()??ht),[L,R]=C.useState(en),[O,M]=C.useState(0),[w,A]=C.useState(!1),[d,F]=C.useState(!1),[q,z]=C.useState(0),[Q,H]=C.useState(0),X=C.useRef(null),[N,I]=C.useState(null),[Y,Z]=C.useState(!1),[V,se]=C.useState(()=>Bs()??{startPatternName:"",startBar:0,endPatternName:"",endBar:At-1}),{pattern:K,updateBPM:re,updateBarBpm:le,toggleCell:ce,toggleGhost:ue,cycleThirtySecond:pe,addBar:be,removeBar:l,clearGrid:$,clearBar:W,insertPatternGrid:j,loadPattern:B,resetPattern:D}=Is(lr()),[G,J]=C.useState(()=>lt(K.id)),[U,ee]=C.useState({isLoading:!1,error:null}),[oe,te]=C.useState(()=>Jo()),ie=ct(O),he=()=>{X.current&&(clearTimeout(X.current),X.current=null),d&&F(!1)};C.useEffect(()=>()=>{X.current&&clearTimeout(X.current)},[]);const fe=(ne,ae=!0)=>{var de;if(y!==void 0){const[ve]=K.timeSignature,xe=ve*me,ke=Math.floor(y/xe),Xe=((de=K.barBpmOverrides)==null?void 0:de[ke])!==void 0;if(Y||Xe){ae&&le(ke,ne),T(ne);return}}T(ne),ae&&(ze(ne),re(ne))},_e=ne=>{R(ne)},ye=()=>{var xe;if(y===void 0)return;const[ne]=K.timeSignature,ae=ne*me,de=Math.floor(y/ae);((xe=K.barBpmOverrides)==null?void 0:xe[de])!==void 0?(le(de,null),T(K.bpm),Z(!1)):(le(de,K.bpm),Z(!0))},je=()=>{jt(r,_,a,f,he),M(0),Z(!1),p(!0),De(void 0),D(),T(ht),ze(ht),re(ht),se({startPatternName:"",startBar:0,endPatternName:"",endBar:At-1})};C.useEffect(()=>{const ne=Qe();u(ne);const ae=_s();if(ae){const de=ne.find(ve=>ve.id===ae);if(de){p(!1),B(de);const ve=Tn();ve!==null?T(ve):(T(de.bpm),ze(de.bpm))}else De(void 0)}},[]),C.useEffect(()=>{J(lt(K.id))},[K.id]),C.useEffect(()=>{zo(x?oe:100)},[x,oe]),C.useEffect(()=>{Ss(V)},[V]);const Oe=(()=>{if(y===void 0||!K.barBpmOverrides)return!1;const[ne]=K.timeSignature,ae=ne*me,de=Math.floor(y/ae);return K.barBpmOverrides[de]!==void 0})();C.useEffect(()=>{var ke,Xe;if(y===void 0)return;const[ne]=K.timeSignature,ae=ne*me,de=Math.floor(y/ae),ve=((ke=K.barBpmOverrides)==null?void 0:ke[de])!==void 0,xe=ct(O);if(Y||ve){const es=(((Xe=K.barBpmOverrides)==null?void 0:Xe[de])??K.bpm)*xe;T(es)}else{const xn=K.bpm*xe;T(xn)}},[Y,y,K.timeSignature,K.barBpmOverrides,K.bpm,O]),Fo({isMetronomePlaying:a,isPatternPlaying:r,setIsMetronomePlaying:f,setIsPatternPlaying:_}),Ns(a,r),Vo(),C.useEffect(()=>{const ne=ae=>(ae.preventDefault(),!1);return document.body.addEventListener("contextmenu",ne),()=>{document.body.removeEventListener("contextmenu",ne)}},[]),C.useEffect(()=>{const ne=de=>{de.touches.length>1&&de.preventDefault()},ae=de=>{de.preventDefault()};return document.body.addEventListener("touchmove",ne,{passive:!1}),document.body.addEventListener("gesturestart",ae,{passive:!1}),()=>{document.body.removeEventListener("touchmove",ne),document.body.removeEventListener("gesturestart",ae)}},[]);const ge=ne=>{if(ne===""){p(!0),De(void 0);const ae=ct(O),de=K.bpm*ae;T(de),ze(K.bpm)}else{const ae=g.find(de=>de.name===ne);if(ae&&ae.id!==K.id){p(!1),B(ae),De(ae.id);const de=ct(O),ve=ae.bpm*de;T(ve),ze(ae.bpm)}}},{seekTo:Te,resetToRangeStart:Ge}=Wi({currentPattern:K,savedPatterns:g,crossPatternLoop:V,isPlaying:r,isDraftMode:m,playbackRate:ie,onSubdivisionChange:h,onPatternChange:ge,onPlayStart:()=>{E(ne=>ne+1)}}),Ee=()=>{Ge(),jt(r,_,a,f,he)},$e=C.useMemo(()=>{if(!V)return 0;const ne=m?"":K.name;return V.startPatternName===ne?V.startBar:0},[V,m,K.name]),Ze=Qo({isPlaying:r,isFullPracticeMode:x,playbackRate:ie,bgmConfig:G,currentSubdivision:y,pattern:K,patternStartToken:k,rangeStartBar:$e});C.useEffect(()=>{if(!V)return;const ne=m?"":K.name;if(V.startPatternName!==ne||v.current===V.startBar&&S.current===V.startPatternName)return;const[ae]=K.timeSignature,de=ae*me;Te(V.startBar*de),v.current=V.startBar,S.current=V.startPatternName},[V,m,K.name,K.timeSignature,Te]);const it=U.isLoading||Ze.isLoading,Ut=Ze.isLoaded,xt=U.error??Ze.error,Ke=ne=>{O===0&&Te(ne)},Je=()=>{m||I({grid:K.grid.map(ne=>ne.slice()),bars:K.bars,timeSignature:K.timeSignature,drums:K.drums,bpm:K.bpm,barBpmOverrides:K.barBpmOverrides?{...K.barBpmOverrides}:void 0})},gn=(()=>N?N.timeSignature[0]===K.timeSignature[0]&&N.timeSignature[1]===K.timeSignature[1]&&N.drums.length===K.drums.length:!1)(),bn=ne=>{if(m||!N||!gn)return;jt(r,_,a,f,he);const ae=ne==="before"?0:K.bars;j(ae,N),I(null)},Or=ne=>ne===""&&m||ne===K.name?K:g.find(de=>de.name===ne)??K,Dr=V?V.startPatternName:m?"":K.name,vn=Or(Dr),yn=Math.max(1,vn.bpm*ie),Ht=vn.timeSignature,zr=Math.round(60/yn*(4/Ht[1])*Ht[0]*1e3),{currentBeat:Fr}=Er({bpm:yn,timeSignature:Ht,isPlaying:d,resetToken:q}),Ur=()=>{A(ne=>{const ae=!ne;return ae||he(),ae})},Wt=()=>{if(d){he();return}if(r){_(!1);return}if(!w){i();return}a&&f(!1),Ge(),z(ne=>ne+1),F(!0),X.current=window.setTimeout(()=>{F(!1),H(ne=>ne+1),_(!0)},zr-50)},Hr=()=>{he(),c()},Wr=()=>{if(m)return;const ne={...K,updatedAt:Date.now()};kt(ne),u(Qe())},Vr=()=>{const ne=Vt(g),ae=K.id,de=lt(ae),ve={...K,id:Et(),name:ne,updatedAt:Date.now()};kt(ve),(de.fileId||de.offsetMs!==0||de.volumePct!==100)&&(et(ve.id,de),Nn(ae)),p(!1),De(ve.id),B(ve),u(Qe())},Gr=ne=>{jt(r,_,a,f,he);const ae=Vi(ne.name,V,g);if(ae||M(0),Z(!1),p(!1),B(ne),De(ne.id),ae&&O>0){const de=ct(O),ve=ne.bpm*de;T(ve),ze(ne.bpm)}else T(ne.bpm),ze(ne.bpm);ae||se({startPatternName:ne.name,startBar:0,endPatternName:ne.name,endBar:ne.bars-1})},$r=ne=>{he(),(async()=>{const de=lt(ne);de.fileId&&await Jt(de.fileId),Nn(ne)})(),ks(ne),K.id===ne&&(p(!0),D(),De(void 0)),u(Qe())},Zr=async ne=>{if(!(ne.type==="audio/mpeg"||ne.name.toLowerCase().endsWith(".mp3"))){ee({isLoading:!1,error:"Please upload an MP3 file."});return}ee({isLoading:!0,error:null});try{G.fileId&&await Jt(G.fileId);const{id:de,meta:ve}=await _r(ne),xe={fileId:de,offsetMs:G.offsetMs??0,volumePct:G.volumePct??100,meta:ve};et(K.id,xe),J(xe),ee({isLoading:!1,error:null})}catch(de){ee({isLoading:!1,error:de instanceof Error?de.message:"Failed to upload background music."})}},Kr=C.useCallback(ne=>{const ae={...G,offsetMs:ne};et(K.id,ae),J(ae)},[G,K.id]),qr=C.useCallback(ne=>{const ae={...G,volumePct:ne};et(K.id,ae),J(ae)},[G,K.id]),Yr=ne=>{te(ne),Xo(ne)},Jr=()=>{(async()=>{G.fileId&&await Jt(G.fileId);const ae={offsetMs:0,volumePct:100};et(K.id,ae),J(ae)})()},Xr=ne=>{const ae=Rn(ne);if(!ae){console.log("Invalid pattern data");return}const de=Vt(g),ve=Date.now(),xe={...ae,id:Et(),name:de,createdAt:ve,updatedAt:ve};kt(xe),p(!1),B(xe),De(xe.id),T(xe.bpm),ze(xe.bpm),re(xe.bpm),u(Qe()),se({startPatternName:xe.name,startBar:0,endPatternName:xe.name,endBar:xe.bars-1})},Qr=(ne,ae)=>{const de=Rn(ne);if(!de){console.log("Invalid pattern data");return}const ve=Vt(g),xe=Date.now(),ke={...de,id:Et(),name:ve,createdAt:xe,updatedAt:xe};if(kt(ke),p(!1),B(ke),De(ke.id),T(ke.bpm),ze(ke.bpm),re(ke.bpm),u(Qe()),ae&&ae.fileId){et(ke.id,{fileId:ae.fileId,offsetMs:ae.offsetMs,volumePct:ae.volumePct,meta:ae.meta});const Xe=lt(ke.id);J(Xe)}se({startPatternName:ke.name,startBar:0,endPatternName:ke.name,endBar:ke.bars-1})};if(t){const ne=Math.round(n.loaded/n.total*100);return o.jsx("div",{className:"app loading",children:o.jsx("div",{className:"loading-container",children:e&&o.jsx("div",{className:"loading-progress",children:o.jsx("div",{className:"loading-progress-bar",children:o.jsx("div",{className:"loading-progress-fill",style:{width:`${ne}%`}})})})})})}return o.jsxs("div",{className:"app",children:[o.jsx(sa,{bpm:P,timeSignature:L,isPlaying:r,resetToken:Q,onBPMChange:fe,isPatternPlaying:a,isCountInPlaying:d,countInBeat:Fr,onPatternPlayToggle:s,onTimeSignatureChange:_e,rateIndex:O,onRateIndexChange:M,rates:sr,rateLabels:vs,patternPlayButton:b?o.jsx(Kn,{variant:"inline",isPlaying:r,onClick:Wt,onLongPress:Ee,fullPracticeMode:x,isCountInEnabled:w}):void 0}),o.jsx("main",{className:"app-main",children:o.jsx(gi,{pattern:K,onCellClick:ce,onToggleGhost:ue,onCycleThirtySecond:pe,onAddBar:be,onRemoveBar:l,onClearGrid:$,onClearBar:W,crossPatternLoop:V,onCrossPatternLoopChange:se,onSave:Vr,onSaveCurrentPattern:Wr,onImportPattern:Xr,onImportPatternWithBgm:Qr,onLoadFromSlot:Gr,onDeletePattern:$r,onStopAllPlaying:Hr,onSelectDraft:je,savedPatterns:g,currentBeat:y,isPlaying:r,onPlayToggle:Wt,isDraftMode:m,onNotationDoubleClick:Ke,canCopyPattern:!m,hasCopiedPattern:!!N,canPastePattern:gn,onCopyPattern:Je,onPastePatternBefore:()=>bn("before"),onPastePatternAfter:()=>bn("after"),bgmConfig:G,bgmIsLoading:it,bgmIsLoaded:Ut,bgmError:xt,onBgmUpload:Zr,onBgmOffsetChange:Kr,onBgmVolumeChange:qr,onBgmDelete:Jr,masterVolume:oe,onMasterVolumeChange:Yr,isCountInEnabled:w,onCountInToggle:Ur,onBarBpmModeToggle:ye,currentBarHasOverride:Oe})}),!b&&o.jsx(Kn,{isPlaying:r,onClick:Wt,onLongPress:Ee,fullPracticeMode:x,isCountInEnabled:w}),o.jsx(Ui,{})]})}Qt.createRoot(document.getElementById("root")).render(o.jsx(rs.StrictMode,{children:o.jsx(Gi,{})}));

#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# å…è®¸åˆå¹¶æäº¤
if echo "$COMMIT_MSG" | head -n1 | grep -qE "^Merge "; then
  exit 0
fi

# Conventional Commits æ ¼å¼éªŒè¯
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?!?: .{1,50}"

if ! echo "$COMMIT_MSG" | head -n1 | grep -qE "$PATTERN"; then
  echo "âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸ç¬¦åˆ Conventional Commits è§„èŒƒ"
  echo ""
  echo "æ­£ç¡®æ ¼å¼: <type>(<scope>): <subject>"
  echo ""
  echo "ç±»å‹ (type):"
  echo "  feat     ğŸŸ¡ æ–°å¢åŠŸèƒ½ (MINOR ç‰ˆæœ¬)"
  echo "  fix      ğŸŸ¢ Bug ä¿®å¤ (PATCH ç‰ˆæœ¬)"
  echo "  docs     ğŸŸ¢ æ–‡æ¡£ä¿®æ”¹ (PATCH ç‰ˆæœ¬)"
  echo "  refactor ğŸŸ¢ ä»£ç é‡æ„ (PATCH ç‰ˆæœ¬)"
  echo "  test     ğŸŸ¢ æµ‹è¯•ç›¸å…³ (PATCH ç‰ˆæœ¬)"
  echo "  chore    ğŸŸ¢ æ„å»º/å·¥å…· (PATCH ç‰ˆæœ¬)"
  echo ""
  echo "ç¤ºä¾‹:"
  echo "  feat(metronome): æ·»åŠ  BPM ç‚¹å‡»åŒºåŸŸ"
  echo "  fix(vexflow): ä¿®å¤é¬¼éŸ³æ¸²æŸ“é€»è¾‘"
  echo "  docs(readme): æ›´æ–°å®‰è£…è¯´æ˜"
  echo ""
  echo "ç ´åæ€§å˜æ›´ (MAJOR ç‰ˆæœ¬):"
  echo "  feat!: ç§»é™¤æ—§çš„ API"
  echo "  feat(storage)!: é‡æ„æ•°æ®ç»“æ„"
  echo ""
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ src/ æ–‡ä»¶çš„ä¿®æ”¹
CHANGED_SRC_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '^src/' || true)

if [ -n "$CHANGED_SRC_FILES" ]; then
  echo "ğŸ·ï¸  Checking version bump..."
  bun run version:check || { echo "âŒ Version check failed! Commit aborted."; exit 1; }
fi

exit 0

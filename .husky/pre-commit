#!/bin/sh

# ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º
set -e

echo "ğŸ” Running type check..."
npm run typecheck || { echo "âŒ Type check failed! Commit aborted."; exit 1; }

CHANGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR)"

# ä»…å½“ staged æ”¹åŠ¨å‘½ä¸­â€œæ„å»ºè¾“å…¥æ–‡ä»¶â€æ—¶æ‰æ‰§è¡Œ build + æ›´æ–° dist
# - è¿™æ ·å¯ä»¥é¿å…ä»…ä¿®æ”¹æ–‡æ¡£/è§„èŒƒæ—¶ï¼Œç”±äº __BUILD_TIME__ æ³¨å…¥å¯¼è‡´ dist äº§ç‰©æ— æ„ä¹‰å˜æ›´
if printf "%s\n" "$CHANGED_FILES" | grep -Eq '^(src/|public/|index\.html$|vite\.config\.ts$|tsconfig\.json$|package\.json$|bun\.lock$|package-lock\.json$)'; then
  echo "ğŸ”¨ Running build (build inputs changed)..."
  npm run build || { echo "âŒ Build failed! Commit aborted."; exit 1; }

  # å°† build äº§ç”Ÿçš„ dist æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
  echo "ğŸ“¦ Adding dist files..."
  git add dist/
else
  echo "ğŸŸ¡ No build inputs changed in staged files. Skipping build/dist update."
fi

echo "âœ… All checks passed!"

# Design: 完整练习模式节奏型播放增加背景音乐同步

## Overview

本变更在完整练习模式下引入用户导入的 MP3 背景音乐，并在播放启动时与节奏型进行对齐。提供可配置的时间偏移量，以支持用户手动校准同步误差。

## Goals

- 完整练习模式下，节奏型播放与背景音乐启动时对齐
- 支持用户导入 MP3 作为背景音乐
- 提供可调节的时间偏移量（正/负）用于校准
- 提供背景音乐音量调节

## Non-Goals

- 持续锁相/周期性自动校准
- 自动节拍识别或 BPM 解析
- 多轨或混音功能

## User Flow

1. 用户在完整练习模式中上传 MP3 作为背景音乐
2. 用户可设置偏移量（毫秒），例如 -150ms 或 +200ms，步进 10ms
3. 点击播放：节奏型与背景音乐在启动时对齐，并应用偏移量
4. 暂停/停止：两者同步暂停或停止
5. 用户可手动删除已关联的背景音乐

## UI Placement

- 背景音乐上传与控制 UI 仅在完整练习模式下显示
- 控件位于 scrollable 区域下方
- 控件两端对齐排列
- 按钮样式遵循现有按钮规范，使用 SVG 图标
- 偏移量与音量使用图标 + 数字 + +/- 按钮布局

## Sync Strategy

- 仅启动对齐：以节奏型播放开始作为基准，启动背景音乐播放
- 偏移量处理：
  - 正值：背景音乐延后播放
  - 负值：背景音乐提前播放（通过延后节奏型或将背景音乐起播时间前移，具体方案见实现）
- 当鼓谱游标位置发生改变并再次播放时，背景音乐从对应时间位置开始
- 背景音乐位置基于当前 subdivision 的绝对时间进行对齐

## Technical Approach

- 使用现有音频引擎（Tone.js）或当前播放系统作为主时钟
- 将背景音乐加载为可控的音频源（Buffer/Player）
- 在点击播放时同时触发：
  - 节奏型播放（基准时间 T0）
  - 背景音乐播放（T0 + offset）
- 偏移量在 UI 与存储层保持毫秒单位
- 背景音乐播放使用 Tone.js 变速播放，需保持音调不变（time-stretch / pitch-preserving）
- UI 控件仅在完整练习模式渲染，并按既有布局规范插入到 grid labels 下方

## Data & State

- 新增背景音乐配置：
  - `bgmFileId`（IndexedDB 中的 MP3 资源引用）
  - `bgmOffsetMs`（整数，默认 0）
  - `bgmVolumePct`（0-100，默认 50）
  - `bgmFileMeta`（文件名、大小、时长等元信息）
- 与节奏型保持关联（按 Pattern ID 关联）
- 完整练习模式播放状态需包含 BGM 是否可用、加载状态与错误状态

## Risks & Mitigations

- **浏览器解码差异导致起播延迟**：提供偏移量允许用户手动修正
- **大文件加载慢**：在 UI 中显示加载状态，播放前完成解码
- **时延漂移**：本阶段仅启动对齐，后续可扩展周期校准

## Open Questions

- 偏移量输入是否需要安全上限（当前为无限制且无 UI 提示）

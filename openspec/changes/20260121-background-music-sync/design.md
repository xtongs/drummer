# 技术设计文档:背景音乐同步播放功能

## 元数据

- **提案ID**: `20260121-background-music-sync`
- **文档版本**: 1.0
- **创建日期**: 2026-01-21
- **状态**: 设计阶段
- **作者**: AI Assistant

---

## 1. 架构设计

### 1.1 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                         用户界面层                           │
├─────────────────────────────────────────────────────────────┤
│  [BackgroundMusicControls] - 新增组件                        │
│    ├── FileIconButton        - 文件选择按钮                 │
│    ├── OffsetDisplay         - 偏移量显示和调整              │
│    ├── VolumeModeButton      - 音量模式切换                 │
│    └── DeleteIconButton      - 删除按钮                     │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                         状态管理层                           │
├─────────────────────────────────────────────────────────────┤
│  [useBackgroundMusic] - 新增 Hook                            │
│    ├── 管理背景音乐播放状态                                   │
│    ├── 处理偏移量和音量                                       │
│    ├── 集成到 useMultiPatternPlayer                          │
│    └── 同步播放/暂停/变速/循环                                │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                         数据持久层                           │
├─────────────────────────────────────────────────────────────┤
│  [IndexedDB] - backgroundMusic 对象存储                       │
│    ├── 存储音频 Blob 数据                                     │
│    ├── 索引: patternId                                       │
│    └── CRUD 操作                                             │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                         音频播放层                           │
├─────────────────────────────────────────────────────────────┤
│  [现有实现 - 保持不变]                                        │
│    ├── audioEngine.ts (鼓声采样 - Web Audio API)            │
│    └── useMetronome.ts (节拍器 - Web Audio API)             │
│                                                              │
│  [新增实现]                                                   │
│    └── HTML5 Audio Element (背景音乐)                       │
│         ├── preservesPitch=true                            │
│         ├── playbackRate=0.5-1.0                            │
│         └── 精确时序控制                                     │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计原则

1. **不破坏现有功能**
   - 鼓声播放逻辑完全保持不变
   - 节拍器播放逻辑完全保持不变
   - 所有现有组件不受影响

2. **增量式开发**
   - 新增功能独立模块化
   - 可选的降级方案(Tone.js)
   - 渐进式集成到现有系统

3. **性能优先**
   - 音频数据存储在 IndexedDB,不占用内存
   - 使用懒加载,仅在需要时创建音频元素
   - 优化渲染,单行 UI 减少重绘

---

## 2. 数据模型设计

### 2.1 类型定义扩展

需要扩展的类型定义:

1. **Pattern 接口扩展**
   - 新增 `backgroundMusic?: BackgroundMusicInfo` - 背景音乐元数据
   - 新增 `musicVolume?: MusicVolumeMode` - 音量模式
   - 新增 `musicOffset?: number` - 偏移量(秒),精度 10ms

2. **新增类型定义**
   - `BackgroundMusicInfo` - 背景音乐元信息(id, filename, duration, uploadedAt)
   - `MusicVolumeMode` - 音量模式类型 (0 | 0.2 | 0.5 | 0.8)
   - `BackgroundMusicState` - 播放状态(audioElement, isPlaying, isLoading, isLoaded, volumeMode, offset, error, patternId)
   - `BackgroundMusicActions` - 操作接口(load, play, pause, stop, setVolumeMode, setOffset, setPlaybackRate, remove)
   - `BackgroundMusicRecord` - IndexedDB 存储记录(id, patternId, filename, blob, duration, uploadedAt, size)

### 2.2 数据存储设计

**IndexedDB 数据库结构**:

```
数据库名: DrummerDB
对象存储: backgroundMusic

索引:
  - patternId (unique, 用于快速查询)

记录结构:
  {
    id: string (primary key)
    patternId: string (indexed)
    filename: string
    blob: Blob
    duration: number
    uploadedAt: number
    size: number
  }
```

---

## 3. 核心模块设计

### 3.1 IndexedDB 存储模块

**模块**: 背景音乐存储工具

**核心功能**:
- 初始化数据库 (DrummerDB, 版本号升级到 2)
- 创建 backgroundMusic 对象存储
- 创建 patternId 唯一索引
- 实现 CRUD 操作:
  - `save()` - 保存记录
  - `getByPatternId()` - 根据 patternId 查询
  - `deleteByPatternId()` - 根据 patternId 删除
  - `getBlobURL()` - 获取 Blob URL 用于播放

### 3.2 useBackgroundMusic Hook

**模块**: 背景音乐播放控制 Hook

**核心功能**:
- 管理背景音乐播放状态 (BackgroundMusicState)
- 提供操作接口 (BackgroundMusicActions):
  - `load()` - 加载背景音乐
  - `play()` - 播放(支持偏移量)
  - `pause()` - 暂停
  - `stop()` - 停止
  - `setVolumeMode()` - 设置音量模式
  - `setOffset()` - 设置偏移量
  - `setPlaybackRate()` - 设置播放速率
  - `remove()` - 删除背景音乐
- 懒加载音频元素
- 自动资源清理

### 3.3 集成到多模式播放器

**模块**: 多模式播放器 Hook (修改现有模块)

**集成点**:
1. 获取当前 Pattern 的背景音乐控制
2. 在播放函数中调用背景音乐播放
3. 在暂停函数中调用背景音乐暂停
4. 在停止函数中调用背景音乐停止
5. 在变速函数中同步背景音乐速率
6. 在循环时重置背景音乐播放位置
7. 返回 bgMusicState 和 bgMusicActions

---

## 4. UI 组件设计

### 4.1 背景音乐控制组件

**模块**: 背景音乐控制主组件

**容器位置**: 放置在 `bottom-play-button-container` 内部

**布局结构**:
```
┌────────────────────────────────────────────────────────────┐
│ [文件按钮] [偏移量]    [播放按钮]    [音量] [删除]        │
│     左侧控件      中央播放按钮      右侧控件             │
└────────────────────────────────────────────────────────────┘
```

**空间关系**:
- 左侧: 文件选择按钮 + 偏移量显示
- 中间: 现有播放按钮 (保持不变,居中对齐)
- 右侧: 音量模式按钮 + 删除按钮
- 使用 `flex` 布局确保播放按钮始终居中

**子组件**:
- 文件选择按钮 - 文件选择/加载状态显示
- 偏移量显示 - 偏移量显示和调整
- 音量模式按钮 - 音量模式切换
- 删除按钮 - 删除确认

### 4.2 文件选择按钮

**模块**: 文件选择按钮组件

**核心功能**:
- 点击打开文件选择器
- 支持拖拽音频文件到按钮区域
- 验证文件格式 (MP3/WAV/OGG/M4A)
- 验证文件大小 (≤20MB)
- 保存到 IndexedDB
- 错误时显示 toast 提示
- 显示加载状态

**视觉设计**:
- 未上传状态: 显示文件夹图标
- 已上传状态: 显示音符图标
- 使用内联 SVG 实现,避免外部依赖

### 4.3 偏移量显示和调整

**模块**: 偏移量显示组件

**核心功能**:
- 显示当前偏移量(±10s, 精度 10ms)
- 点击展开调整面板
- 三档调整按钮: ±1s/±0.1s/±10ms
- 长按显示输入框手动输入精确值

**视觉设计**:
- 使用时钟图标表示偏移量
- 使用内联 SVG 实现

### 4.4 音量模式按钮

**模块**: 音量模式按钮组件

**核心功能**:
- 四档音量切换: 静音(0%) / 低音量(20%) / 中音量(50%) / 高音量(80%)
- 单击循环切换下一档

**视觉设计**:
- 根据当前音量模式显示对应图标:
  - 静音: 喇叭带 X
  - 低音量: 单个喇叭
  - 中音量: 喇叭加一条声波线
  - 高音量: 喇叭加多条声波线
- 使用内联 SVG 实现,图标动态切换

### 4.5 删除按钮

**模块**: 删除按钮组件

**核心功能**:
- 首次点击:进入确认模式(3秒)
- 二次点击:执行删除
- 超时自动退出确认模式
- 视觉反馈(红色高亮)

**视觉设计**:
- 使用垃圾桶图标
- 确认模式时红色高亮显示
- 使用内联 SVG 实现

---

## 5. 交互设计 (移动端)

### 5.1 触摸交互

**偏移量调整**:
- 点击展开调整面板
- 点击调整按钮: ±1s/±0.1s/±10ms
- 长按显示输入框手动输入精确值

**音量模式切换**:
- 单击循环切换 4 种模式

**文件上传**:
- 点击按钮打开文件选择器
- 支持拖拽音频文件到按钮区域
- 自动识别并上传
- 错误时显示 toast 提示

### 5.2 视觉反馈

**按钮状态**:
- 按下时显示按下效果
- 禁用状态半透明显示
- 加载状态显示加载指示器

**删除确认**:
- 首次点击: 进入确认模式(红色高亮)
- 二次点击: 执行删除
- 3秒超时后自动退出确认模式

---

## 6. 测试策略

### 6.1 单元测试

**测试模块**: useBackgroundMusic Hook

**测试用例**:
- 加载背景音乐功能
- 播放功能(带偏移量)
- 偏移量调整(10ms 精度)
- 暂停/停止功能
- 音量模式切换
- 变速功能
- 删除功能

### 6.2 集成测试

**测试同步播放**:
- 鼓声和背景音乐同时播放
- 同步暂停功能
- 循环同步功能
- 变速同步功能

### 6.3 手动测试清单

- [ ] 上传 MP3 文件成功
- [ ] 上传 WAV 文件成功
- [ ] 上传错误格式被拒绝
- [ ] 上传超大文件(>20MB)被拒绝
- [ ] 播放时背景音乐与鼓点同步
- [ ] 暂停时背景音乐同步暂停
- [ ] 停止时背景音乐重置
- [ ] 变速时背景音乐同步变速
- [ ] 变速时音高保持不变
- [ ] 偏移量调整精度 10ms
- [ ] 循环时背景音乐同步重置
- [ ] 音量模式切换流畅
- [ ] 删除背景音乐成功
- [ ] 移动端(375px)布局正常

---

## 7. 性能优化

### 7.1 懒加载

**策略**:
- 仅在 Pattern 有背景音乐时才加载音频元素
- 使用 useEffect 监听 pattern.backgroundMusic 变化
- 未使用时不创建音频元素

### 7.2 内存管理

**策略**:
- 组件卸载时释放音频元素资源
- 清理 audioElement.src 和引用
- 撤销 Blob URL

### 7.3 IndexedDB 优化

**策略**:
- 使用 patternId 唯一索引加速查询
- 避免全表扫描
- 按需获取 Blob URL

---

## 8. 可选降级方案 (Tone.js)

### 8.1 何时切换

如果 Phase 0 验证发现 HTML5 Audio 同步精度 ≥ 50ms,则切换到 Tone.js 方案。

### 8.2 实现差异

**使用 Tone.js**:
- 使用 `Player` 类创建播放器
- 连接到 Web Audio Context
- 精确调度播放时间
- 更好的变速保调效果

**优点**:
- 精确的时序控制(Web Audio API)
- 变速保调效果好

**缺点**:
- 引入 150KB 依赖
- 需要异步加载 Tone.js

### 8.3 动态导入

**策略**:
- 仅在需要时动态导入 Tone.js
- 保持主包体积小型化

---

## 9. 部署清单

### 9.1 新增模块

- 背景音乐控制组件 (主组件 + 4 个子组件)
- 背景音乐 Hook
- 背景音乐存储工具
- 类型定义扩展

### 9.2 修改的现有模块

- 多模式播放器 Hook (集成背景音乐控制)
- 播放控制组件 (添加背景音乐控制 UI)

### 9.3 依赖

**HTML5 Audio 方案** (优先):
- 无需新增依赖

**Tone.js 方案** (可选):
```bash
bun add tone
```

---

## 10. 附录

### 10.1 相关文档

- [HTML5 Audio 规范](https://html.spec.whatwg.org/multipage/media.html)
- [IndexedDB 规范](https://w3c.github.io/IndexedDB/)
- [Tone.js 文档](https://tonejs.github.io/)

### 10.2 现有代码参考

- 音频引擎模块
- 多模式播放器 Hook

---

**变更历史**:
- 2026-01-21: 初始版本创建

# Drummer é¡¹ç›®å¼€å‘è§„èŒƒ

> æœ¬æ–‡æ¡£ä¸º AI åŠ©æ‰‹å’Œå¼€å‘è€…æä¾›é¡¹ç›®å¼€å‘æŒ‡å—

<!-- OPENSPEC:START -->
## âš¡ OpenSpec è§„èŒƒé©±åŠ¨å¼€å‘

æœ¬é¡¹ç›®ä½¿ç”¨ **OpenSpec** è¿›è¡Œè§„èŒƒé©±åŠ¨å¼€å‘ï¼ˆSDDï¼‰ã€‚

- ğŸ“‹ **å®Œæ•´æŒ‡ä»¤**: å‚è§ `openspec/AGENTS.md`
- ğŸ“– **é¡¹ç›®ä¸Šä¸‹æ–‡**: å‚è§ `openspec/project.md`
- ğŸ“š **åŠŸèƒ½è§„èŒƒ**: å‚è§ `openspec/specs/`
- ğŸ“ **å˜æ›´ææ¡ˆ**: å‚è§ `openspec/changes/`

### æ ¸å¿ƒåŸåˆ™

**è§„èŒƒä¼˜å…ˆï¼ˆSpec Firstï¼‰**ï¼šåœ¨å†™ä»»ä½•ä»£ç ä¹‹å‰ï¼Œå¿…é¡»å…ˆæœ‰æ˜ç¡®çš„è§„èŒƒã€‚

### å¼€å‘æµç¨‹

```
ææ¡ˆ(proposal) â†’ è®¾è®¡(design) â†’ ä»»åŠ¡(tasks) â†’ å®ç°(implement) â†’ éªŒè¯(verify) â†’ å½’æ¡£(archive)
```

### å¿…é¡»éµå®ˆ

1. **æ–°åŠŸèƒ½/åŠŸèƒ½ä¿®æ”¹**ï¼šå¿…é¡»å…ˆåœ¨ `openspec/changes/` åˆ›å»º proposal
2. **å¤æ‚å˜æ›´**ï¼šå¿…é¡»æœ‰ design æ–‡æ¡£
3. **ç ´åæ€§å˜æ›´**ï¼šå¿…é¡»æ ‡æ³¨ **BREAKING** å¹¶æä¾›è¿ç§»æ–¹æ¡ˆ
4. **æµ‹è¯•**ï¼šéµå¾ª TDDï¼Œæ ¸å¿ƒé€»è¾‘è¦†ç›–ç‡ >= 80%

<!-- OPENSPEC:END -->

## é¡¹ç›®æ¦‚è¿°

Drummer æ˜¯ä¸€ä¸ªåŸºäº React + TypeScript + Vite æ„å»ºçš„é¼“æœº/èŠ‚æ‹å™¨ PWA åº”ç”¨ã€‚é¡¹ç›®é‡‡ç”¨ TDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰+ SDDï¼ˆè§„èŒƒé©±åŠ¨å¼€å‘ï¼‰æ–¹æ³•è®ºï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚

## æŠ€æœ¯æ ˆ

- **å‰ç«¯æ¡†æ¶**: React 18
- **è¯­è¨€**: TypeScript
- **æ„å»ºå·¥å…·**: Vite
- **æµ‹è¯•æ¡†æ¶**: Vitest + React Testing Library
- **åŒ…ç®¡ç†å™¨**: bun (ä¼˜å…ˆä½¿ç”¨)
- **PWA**: vite-plugin-pwa

## TDD å¼€å‘æµç¨‹

### æ ¸å¿ƒåŸåˆ™ï¼šçº¢-ç»¿-é‡æ„

åœ¨è¿›è¡Œä»»ä½•æ–°åŠŸèƒ½å¼€å‘æˆ– bug ä¿®å¤æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹æµç¨‹ï¼š

#### 1. çº¢ï¼ˆRedï¼‰- å…ˆå†™æµ‹è¯•

```bash
# åœ¨å¼€å§‹ç¼–ç å‰ï¼Œå…ˆç¼–å†™å¤±è´¥çš„æµ‹è¯•
bun run test:watch
```

- æ ¹æ®éœ€æ±‚ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- æµ‹è¯•åº”è¯¥æ˜ç¡®æè¿°é¢„æœŸè¡Œä¸º
- è¿è¡Œæµ‹è¯•ï¼Œç¡®è®¤æµ‹è¯•å¤±è´¥ï¼ˆçº¢è‰²ï¼‰

#### 2. ç»¿ï¼ˆGreenï¼‰- å®ç°åŠŸèƒ½

- ç¼–å†™æœ€å°‘é‡çš„ä»£ç ä½¿æµ‹è¯•é€šè¿‡
- ä¸è¦è¿‡åº¦è®¾è®¡ï¼Œåªå®ç°æµ‹è¯•è¦æ±‚çš„åŠŸèƒ½
- è¿è¡Œæµ‹è¯•ï¼Œç¡®è®¤æµ‹è¯•é€šè¿‡ï¼ˆç»¿è‰²ï¼‰

#### 3. é‡æ„ï¼ˆRefactorï¼‰

- åœ¨æµ‹è¯•ä¿æŠ¤ä¸‹é‡æ„ä»£ç 
- æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- ç¡®ä¿æ‰€æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡

### æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
bun run test

# è¿è¡Œæµ‹è¯•ï¼ˆå•æ¬¡ï¼‰
bun run test:run

# ç›‘è§†æ¨¡å¼è¿è¡Œæµ‹è¯•ï¼ˆæ¨èå¼€å‘æ—¶ä½¿ç”¨ï¼‰
bun run test:watch

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
bun run test:coverage
```

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ components/       # UI ç»„ä»¶
â”‚   â”œâ”€â”€ BottomPlayButton/
â”‚   â”œâ”€â”€ MetronomeBar/
â”‚   â”œâ”€â”€ PatternEditor/
â”‚   â”œâ”€â”€ PatternManager/
â”‚   â””â”€â”€ VersionDisplay/
â”œâ”€â”€ hooks/           # è‡ªå®šä¹‰ React Hooks
â”‚   â”œâ”€â”€ usePattern.ts          # èŠ‚å¥å‹ç®¡ç†
â”‚   â”œâ”€â”€ useMetronome.ts        # èŠ‚æ‹å™¨é€»è¾‘
â”‚   â”œâ”€â”€ useMultiPatternPlayer.ts  # å¤šæ¨¡å¼æ’­æ”¾å™¨
â”‚   â””â”€â”€ *.test.ts              # å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ types/           # TypeScript ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ index.test.ts
â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ storage.ts   # æœ¬åœ°å­˜å‚¨
â”‚   â”œâ”€â”€ audioEngine.ts  # éŸ³é¢‘å¼•æ“
â”‚   â”œâ”€â”€ constants.ts # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ *.test.ts    # å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ styles/          # å…¨å±€æ ·å¼
â”œâ”€â”€ test/            # æµ‹è¯•é…ç½®å’Œå·¥å…·
â”‚   â””â”€â”€ setup.ts     # æµ‹è¯•ç¯å¢ƒè®¾ç½®
â””â”€â”€ App.tsx          # ä¸»åº”ç”¨ç»„ä»¶
```

## æµ‹è¯•è§„èŒƒ

### æµ‹è¯•æ–‡ä»¶å‘½å

- æµ‹è¯•æ–‡ä»¶åº”ä¸è¢«æµ‹è¯•æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
- å‘½åæ ¼å¼: `<filename>.test.ts` æˆ– `<filename>.test.tsx`
- ä¾‹å¦‚: `usePattern.ts` â†’ `usePattern.test.ts`

### æµ‹è¯•ç»“æ„

```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";

describe("æ¨¡å—/åŠŸèƒ½åç§°", () => {
  describe("å‡½æ•°/æ–¹æ³•åç§°", () => {
    it("åº”è¯¥<é¢„æœŸè¡Œä¸ºæè¿°>", () => {
      // Arrange - å‡†å¤‡
      // Act - æ‰§è¡Œ
      // Assert - æ–­è¨€
    });
  });
});
```

### æµ‹è¯•æœ€ä½³å®è·µ

1. **æµ‹è¯•æè¿°ä½¿ç”¨ä¸­æ–‡**ï¼šä¾¿äºç†è§£æµ‹è¯•æ„å›¾
2. **æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º**ï¼šä¿æŒæµ‹è¯•ç®€æ´
3. **ä½¿ç”¨ Arrange-Act-Assert æ¨¡å¼**ï¼šç»“æ„æ¸…æ™°
4. **Mock å¤–éƒ¨ä¾èµ–**ï¼šéš”ç¦»æµ‹è¯•å•å…ƒ
5. **æµ‹è¯•è¾¹ç•Œæ¡ä»¶**ï¼šåŒ…æ‹¬ç©ºå€¼ã€æç«¯å€¼ç­‰

### è¦†ç›–ç‡è¦æ±‚

- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆhooks, utilsï¼‰ï¼š>= 80%
- çº¯ UI ç»„ä»¶å¯é€‚å½“é™ä½è¦æ±‚

## ä»£ç è§„èŒƒ

### TypeScript

- ä¸¥æ ¼æ¨¡å¼å·²å¯ç”¨ (`strict: true`)
- ç¦æ­¢æœªä½¿ç”¨çš„å˜é‡å’Œå‚æ•°
- æ‰€æœ‰å‡½æ•°å‚æ•°å’Œè¿”å›å€¼éƒ½åº”æœ‰ç±»å‹æ³¨è§£

### å‘½åçº¦å®š

- **ç»„ä»¶**: PascalCase (ä¾‹: `PatternEditor`)
- **hooks**: camelCaseï¼Œä»¥ `use` å¼€å¤´ (ä¾‹: `usePattern`)
- **å·¥å…·å‡½æ•°**: camelCase (ä¾‹: `savePattern`)
- **å¸¸é‡**: UPPER_SNAKE_CASE (ä¾‹: `DEFAULT_BPM`)
- **ç±»å‹/æ¥å£**: PascalCase (ä¾‹: `Pattern`, `DrumType`)

### æ–‡ä»¶ç»„ç»‡

- æ¯ä¸ªç»„ä»¶å•ç‹¬æ–‡ä»¶å¤¹ï¼ŒåŒ…å« `.tsx` å’Œ `.css`
- ç›¸å…³çš„æµ‹è¯•æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
- å…¬å…±ç±»å‹å®šä¹‰æ”¾åœ¨ `types/` ç›®å½•

## Git å·¥ä½œæµ

### åˆ†æ”¯å‘½å

- `feat/<åŠŸèƒ½å>` - æ–°åŠŸèƒ½
- `fix/<é—®é¢˜æè¿°>` - Bug ä¿®å¤
- `refactor/<é‡æ„å†…å®¹>` - ä»£ç é‡æ„
- `test/<æµ‹è¯•å†…å®¹>` - æ·»åŠ æˆ–ä¿®æ”¹æµ‹è¯•
- `docs/<æ–‡æ¡£å†…å®¹>` - æ–‡æ¡£æ›´æ–°

### æäº¤å‰æ£€æŸ¥æ¸…å•

1. âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ (`bun run test:run`)
2. âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡ (`bun run typecheck`)
3. âœ… ESLint æ£€æŸ¥é€šè¿‡ (`bun run lint`)
4. âœ… æ–°åŠŸèƒ½æœ‰å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
5. âœ… æ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚æœéœ€è¦ï¼‰

### Commit ä¿¡æ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

ç±»å‹:

- `feat`: æ–°åŠŸèƒ½
- `fix`: Bug ä¿®å¤
- `docs`: æ–‡æ¡£
- `style`: æ ¼å¼
- `refactor`: é‡æ„
- `test`: æµ‹è¯•
- `chore`: æ„å»º/å·¥å…·

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### Pattern æ•°æ®ç»“æ„

```typescript
interface Pattern {
  id: string;
  name: string;
  bpm: number;
  timeSignature: [number, number];
  bars: number;
  grid: CellState[][]; // [drumIndex][beatIndex]
  drums: DrumType[];
  loopRange?: LoopRange;
  createdAt: number;
  updatedAt: number;
}
```

### CellState çŠ¶æ€

- `0` (CELL_OFF): æœªæ¿€æ´»
- `1` (CELL_NORMAL): æ­£å¸¸éŸ³ç¬¦
- `2` (CELL_GHOST): é¬¼éŸ³ï¼ˆå¼±éŸ³ï¼‰
- `3` (CELL_GRACE): å€šéŸ³
- `4` (CELL_DOUBLE_32): åŒ 32 åˆ†éŸ³ç¬¦
- `5` (CELL_FIRST_32): å‰åŠ 32 åˆ†éŸ³ç¬¦
- `6` (CELL_SECOND_32): ååŠ 32 åˆ†éŸ³ç¬¦

### éŸ³é¢‘å¼•æ“

éŸ³é¢‘å¼•æ“ä½¿ç”¨ Web Audio APIï¼Œæ”¯æŒï¼š

- çœŸå®é‡‡æ ·æ’­æ”¾
- åˆæˆéŸ³è‰²ï¼ˆåå¤‡æ–¹æ¡ˆï¼‰
- ç²¾ç¡®çš„æ—¶åºè°ƒåº¦
- IndexedDB ç¼“å­˜

## å¸¸ç”¨å¼€å‘å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
bun run dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
bun run build

# ç±»å‹æ£€æŸ¥
bun run typecheck

# ä»£ç æ£€æŸ¥
bun run lint

# è¿è¡Œæµ‹è¯•
bun run test

# é¢„è§ˆç”Ÿäº§æ„å»º
bun run preview
```

## æ³¨æ„äº‹é¡¹

1. **éŸ³é¢‘æµ‹è¯•**: éŸ³é¢‘ç›¸å…³çš„æµ‹è¯•éœ€è¦ mock Web Audio API
2. **å­˜å‚¨æµ‹è¯•**: localStorage åœ¨æµ‹è¯•ç¯å¢ƒä¸­ä¼šè¢«è‡ªåŠ¨ mock
3. **å¼‚æ­¥æµ‹è¯•**: ä½¿ç”¨ `async/await` å’Œ `waitFor` å¤„ç†å¼‚æ­¥æ“ä½œ
4. **ç»„ä»¶æµ‹è¯•**: ä½¿ç”¨ React Testing Libraryï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¡Œä¸ºé©±åŠ¨çš„æµ‹è¯•

---

_æœ€åæ›´æ–°: 2026-01-16_
